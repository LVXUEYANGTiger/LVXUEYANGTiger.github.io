<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>传智健康day07 | 小肥龙吃大冰淇淋</title><meta name="keywords" content="javase基础,传智健康"><meta name="author" content="小肥龙吃大冰淇淋"><meta name="copyright" content="小肥龙吃大冰淇淋"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="第7章 系统管理-权限设置学习目标  了解认证和授权的概念  掌握Spring Security入门案例开发过程  掌握Spring Security实现认证的过程  掌握Spring Security实现授权的过程   1. 权限控制、SpringSecurity入门及进阶【目标】了解认证和授权的概念 【路径】1：认证和授权的概念  认证：登录（用户名和密码） 授权：访问系统功能的权限  2：权">
<meta property="og:type" content="article">
<meta property="og:title" content="传智健康day07">
<meta property="og:url" content="http://lvxueyang.vip/post/8f17f32d.html">
<meta property="og:site_name" content="小肥龙吃大冰淇淋">
<meta property="og:description" content="第7章 系统管理-权限设置学习目标  了解认证和授权的概念  掌握Spring Security入门案例开发过程  掌握Spring Security实现认证的过程  掌握Spring Security实现授权的过程   1. 权限控制、SpringSecurity入门及进阶【目标】了解认证和授权的概念 【路径】1：认证和授权的概念  认证：登录（用户名和密码） 授权：访问系统功能的权限  2：权">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg">
<meta property="article:published_time" content="2021-12-08T07:27:00.000Z">
<meta property="article:modified_time" content="2022-11-27T09:16:44.254Z">
<meta property="article:author" content="小肥龙吃大冰淇淋">
<meta property="article:tag" content="javase基础">
<meta property="article:tag" content="传智健康">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg"><link rel="shortcut icon" href="https://lvxueyangboke.oss-cn-beijing.aliyuncs.com/images/20210805191028.png"><link rel="canonical" href="http://lvxueyang.vip/post/8f17f32d"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '传智健康day07',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-27 17:16:44'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/ali_icon.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mogai.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="小肥龙吃大冰淇淋" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">303</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">108</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">73</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">小肥龙吃大冰淇淋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">传智健康day07</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-12-08T07:27:00.000Z" title="发表于 2021-12-08 15:27:00">2021-12-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-27T09:16:44.254Z" title="更新于 2022-11-27 17:16:44">2022-11-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java%E5%AD%A6%E4%B9%A0/">java学习</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java%E5%AD%A6%E4%B9%A0/%E4%BC%A0%E6%99%BA%E5%81%A5%E5%BA%B7/">传智健康</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">14.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>64分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="传智健康day07"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="第7章-系统管理-权限设置"><a href="#第7章-系统管理-权限设置" class="headerlink" title="第7章 系统管理-权限设置"></a>第7章 系统管理-权限设置</h1><p>学习目标</p>
<ul>
<li><p>了解认证和授权的概念</p>
</li>
<li><p>掌握Spring Security入门案例开发过程</p>
</li>
<li><p>掌握Spring Security实现认证的过程</p>
</li>
<li><p>掌握Spring Security实现授权的过程</p>
</li>
</ul>
<h1 id="1-权限控制、SpringSecurity入门及进阶"><a href="#1-权限控制、SpringSecurity入门及进阶" class="headerlink" title="1. 权限控制、SpringSecurity入门及进阶"></a>1. 权限控制、SpringSecurity入门及进阶</h1><h3 id="【目标】"><a href="#【目标】" class="headerlink" title="【目标】"></a>【目标】</h3><p>了解认证和授权的概念</p>
<h3 id="【路径】"><a href="#【路径】" class="headerlink" title="【路径】"></a>【路径】</h3><p>1：认证和授权的概念</p>
<ul>
<li>认证：登录（用户名和密码）</li>
<li>授权：访问系统功能的权限</li>
</ul>
<p>2：权限模块的数据模型</p>
<ul>
<li>用户表</li>
<li>角色表</li>
<li>权限表</li>
<li>菜单表</li>
</ul>
<p>用户,角色是多对多</p>
<p>权限,角色是多对多</p>
<p>菜单,角色是多对多</p>
<h3 id="【讲解】"><a href="#【讲解】" class="headerlink" title="【讲解】"></a>【讲解】</h3><h2 id="1-1-认证和授权概念【理解】"><a href="#1-1-认证和授权概念【理解】" class="headerlink" title="1.1. 认证和授权概念【理解】"></a>1.1. <strong>认证和授权概念</strong>【理解】</h2><p>前面我们已经完成了传智健康后台管理系统（health_web）的部分功能，例如检查项管理、检查组管理、套餐管理、预约设置等。接下来我们需要思考2个问题：</p>
<p>问题1：在生产环境下我们如果不登录后台系统就可以完成这些功能操作吗？</p>
<p>答案显然是否定的，要操作这些功能必须首先登录到系统才可以。（用户登录系统–&gt;认证）</p>
<p>问题2：是不是所有用户，只要登录成功就都可以操作所有功能呢？</p>
<p>答案是否定的，并不是所有的用户都可以操作这些功能。不同的用户可能拥有不同的权限，这就需要进行授权了。（用户登录之后，对每个用户进行授权，通过授权去访问系统中不同的功能–&gt;授权）</p>
<p>认证：系统提供的用于识别用户身份的功能，通常提供用户名和密码进行登录其实就是在进行认证，认证的目的是让系统知道你是谁。</p>
<pre><code> 说白了：登陆系统了，就可以访问，没登陆就不能访问。验证用户名与密码是否存在数据库中（t_user）
</code></pre>
<p>授权：用户认证成功后，需要为用户授权，其实就是指定当前用户可以操作哪些功能。</p>
<p>​    用户登陆后，查询获取用户所拥有的权限绑定到用户, 当进行权限验证时就可以取用与登陆用户绑定的权限与访问的资源标定的权限进行匹配</p>
<p>商店里的 矿泉水 3块钱  资源权限标定。标定好了需要访问这个资源时的权限</p>
<p>登陆用户 有多少钱？老婆给予的，老婆授权。 </p>
<p>授权是为了做权限验证的。登陆用户身上所拥有的权限集合</p>
<p>/checkitem/findPage.do   查询检查项  只有健康管理师才可以访问</p>
<p>员工A 来登陆 (查看套餐的权限) 来访 查询检查项(/checkitem/findPage.do 健康管理师)  报没有权限</p>
<p>认证与授权的目的，更好的保护资源(使用后台管理功能)</p>
<p>​        </p>
<p>本章节就是要对后台系统进行权限控制，其本质就是对用户进行认证和授权。</p>
<h2 id="1-2-权限模块数据模型"><a href="#1-2-权限模块数据模型" class="headerlink" title="1.2. 权限模块数据模型"></a>1.2. <strong>权限模块数据模型</strong></h2><p>前面已经分析了认证和授权的概念，要实现最终的权限控制，需要有一套表结构支撑：</p>
<p>用户表t_user、权限表t_permission、角色表t_role、菜单表t_menu、用户角色关系表t_user_role、角色权限关系表t_role_permission、角色菜单关系表t_role_menu。</p>
<p>表之间关系如下图：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163852.png" alt="img"> </p>
<p>通过上图可以看到，权限模块共涉及到7张表。在这7张表中，角色表起到了至关重要的作用，其处于核心位置，我们把基于角色的权限控制叫做RBAC，因为用户、权限、菜单都和角色是多对多关系。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163853.png" alt="img"> </p>
<p>接下来我们可以分析一下在认证和授权过程中分别会使用到哪些表：</p>
<p>认证过程：只需要用户表就可以了，在用户登录时可以查询用户表t_user进行校验，判断用户输入的用户名和密码是否正确。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163854.png" alt="img"> </p>
<p>授权过程：用户必须完成认证之后才可以进行授权，首先可以根据用户查询其角色，再根据角色查询对应的菜单，这样就确定了用户能够看到哪些菜单。然后再根据用户的角色查询对应的权限，这样就确定了用户拥有哪些权限。所以授权过程会用到上面7张表。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163855.png" alt="img"> </p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163856.png" alt="img"> </p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163857.png" alt="img"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163858.png" alt="img"> </p>
<h3 id="【小结】"><a href="#【小结】" class="headerlink" title="【小结】"></a>【小结】</h3><ol>
<li><p>认证和授权</p>
<ul>
<li>认证: 提供账号和密码进行登录认证, 系统知道你的身份</li>
<li>授权: 根据不同的身份, 赋予不同的权限，不同的权限，可访问系统不同的功能( 系统的功能也要标定访问权限)</li>
</ul>
</li>
<li><p>RBAC权限模块数据模型（基于角色的权限控制）</p>
<ul>
<li>用户表</li>
<li>角色表</li>
<li>权限表</li>
<li>菜单表</li>
</ul>
<p>用户,角色是多对多  用户角色表</p>
<p>权限,角色是多对多  角色权限表</p>
<p>菜单,角色是多对多  角色菜单表</p>
<p>一共7张表</p>
</li>
</ol>
<h2 id="1-3-Spring-Security简介"><a href="#1-3-Spring-Security简介" class="headerlink" title="1.3. Spring Security简介"></a>1.3. <strong>Spring Security简介</strong></h2><h3 id="【目标】-1"><a href="#【目标】-1" class="headerlink" title="【目标】"></a>【目标】</h3><p>知道什么是Spring Security</p>
<h3 id="【路径】-1"><a href="#【路径】-1" class="headerlink" title="【路径】"></a>【路径】</h3><ol>
<li>Spring Security简介</li>
<li>Spring Security使用需要的坐标</li>
</ol>
<h3 id="【讲解】-1"><a href="#【讲解】-1" class="headerlink" title="【讲解】"></a>【讲解】</h3><p>Spring Security是 Spring提供的安全认证服务的框架。 使用Spring Security可以帮助我们来简化认证和授权的过程。官网：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-security">https://spring.io/projects/spring-security</a></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163859.png" alt="img"> </p>
<p>对应的maven坐标：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>常用的权限框架除了Spring Security，还有Apache的shiro框架。</p>
<h3 id="【小结】-1"><a href="#【小结】-1" class="headerlink" title="【小结】"></a>【小结】</h3><ol>
<li>SpringSecurity是Spring家族的一个安全框架, 简化我们开发里面的认证和授权过程, （登陆, 访问url时的权限控制 secuirty帮我们做了)</li>
<li>SpringSecurity内部封装了Filter（只需要在web.xml容器中配置一个过滤器–代理过滤器，真实的过滤器(12个)在spring的容器中配置） </li>
<li>常见的安全框架   <ul>
<li>Spring的 SpringSecurity  配置复杂  有个好老爸(spring) 无缝整合  链式模式</li>
<li>Apache的Shiro  <code>http://shiro.apache.org/</code>  比较简单 apache 写整合  外观者模式</li>
</ul>
</li>
</ol>
<h2 id="1-4-Spring-Security入门案例-【重点】"><a href="#1-4-Spring-Security入门案例-【重点】" class="headerlink" title="1.4. Spring Security入门案例-【重点】"></a>1.4. Spring Security入门案例-【重点】</h2><h3 id="【目标】-2"><a href="#【目标】-2" class="headerlink" title="【目标】"></a>【目标】</h3><p>【需求】</p>
<p>​    使用Spring Security进行控制: 网站(一些页面)需要登录才能访问（认证）</p>
<h3 id="【路径】-2"><a href="#【路径】-2" class="headerlink" title="【路径】"></a>【路径】</h3><ol>
<li>创建Maven health_parent的子工程 springsecurity_demo,导入坐标(依赖health_interface)</li>
<li>配置web.xml(前端控制器加载spring, SpringSecurity代理过滤器)</li>
<li>创建spring-security.xml（核心配置文件, spring要加载这个配置）</li>
</ol>
<h3 id="【讲解】-2"><a href="#【讲解】-2" class="headerlink" title="【讲解】"></a>【讲解】</h3><h3 id="1-4-1-工程搭建"><a href="#1-4-1-工程搭建" class="headerlink" title="1.4.1. 工程搭建"></a>1.4.1. <strong>工程搭建</strong></h3><p>创建maven工程，打包方式为war，为了方便起见我们可以让入门案例工程依赖health_interface，这样相关的依赖都继承过来了。</p>
<p> <img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163900.png" alt="image-20200804101015750"> </p>
<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springsecurity_demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>health_interface<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>内置提供index.html页面，内容为“登录成功”!!</p>
<h3 id="1-4-2-配置web-xml"><a href="#1-4-2-配置web-xml" class="headerlink" title="1.4.2. 配置web.xml"></a>1.4.2. <strong>配置web.xml</strong></h3><p>【路径】</p>
<p>1：DelegatingFilterProxy用于整合第三方框架（代理过滤器，非真正的过滤器，真正的过滤器需要在spring的配置文件）</p>
<p>2：springmvc的核心控制器</p>
<p>在web.xml中主要配置SpringMVC的DispatcherServlet和用于整合第三方框架的DelegatingFilterProxy（代理过滤器，真正的过滤器在spring的配置文件），用于整合Spring Security。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee</span></span></span><br><span class="line"><span class="string"><span class="tag">		  http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">version</span>=<span class="string">&quot;3.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  filter-name：固定为springSecurityFilterChain,不能修改。容器启动时，</span></span><br><span class="line"><span class="comment">会从spring容器中获取这个filtername的bean对象（security启动时创建的bean name)</span></span><br><span class="line"><span class="comment">可以修改：必须在spring容器中配置一个bean对象为你修改后的名称</span></span><br><span class="line"><span class="comment">      --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSecurityFilterChain<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--   代理过滤：</span></span><br><span class="line"><span class="comment">         自己不干活，拦截的请求转给security的过滤器(springSecurityFilterChain)去处理</span></span><br><span class="line"><span class="comment"> --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSecurityFilterChain<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 使用DispatcherServlet或者使用contextLoaderListener 都一样，只要启动容器即可   --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatchServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring-security.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatchServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.do<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-4-3-配置spring-security-xml"><a href="#1-4-3-配置spring-security-xml" class="headerlink" title="1.4.3. 配置spring-security.xml"></a>1.4.3. <strong>配置spring-security.xml</strong></h3><p>【路径 】</p>
<p>1：定义哪些链接可以放行</p>
<p>2：定义哪些链接不可以放行，即需要有角色、权限才可以放行</p>
<p>3：认证管理，定义登录账号名和密码，并授予访问的角色、权限</p>
<p>在spring-security.xml中主要配置Spring Security的拦截规则和认证管理器。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:security</span>=<span class="string">&quot;http://www.springframework.org/schema/security&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">【重要】【重要】【重要】</span></span><br><span class="line"><span class="comment">这里面的所有路径必须以/开头，否则启动报错</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--  auto-config: 自动配置，自动生成login页面，login处理，退出处理</span></span><br><span class="line"><span class="comment">        use-expressions: 是否使用spel表达式 true: access的值可以填表达式(hasRole, hasAuthority, hasAny....)</span></span><br><span class="line"><span class="comment">                         false: ROEL_角色名(必须是ROLE_打，否则启动报错), 或 security写死的几个常量</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  拦截规则配置  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security:http</span> <span class="attr">auto-config</span>=<span class="string">&quot;true&quot;</span> <span class="attr">use-expressions</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  pattern=&quot;/**&quot; 拦截所有的路径  access=&quot;ROLE_ADMIN&quot;</span></span><br><span class="line"><span class="comment">      要访问符合pattern的url时，登陆用户必须有ROLE_ADMIN的角色，如果没有则不能访问</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      security:intercept-url： 可以配置多个</span></span><br><span class="line"><span class="comment"> --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">&quot;/**&quot;</span> <span class="attr">access</span>=<span class="string">&quot;ROLE_ADMIN&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--  认证管理器  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security:authentication-manager</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  认证信息提供者，认证信息的来源</span></span><br><span class="line"><span class="comment">      提供登陆用户信息  用户名、密码、权限集合</span></span><br><span class="line"><span class="comment">      user-service-ref 指向spring容器中一个bean对象, 实现这个UserDetailsService的对象, 提供用户的名称、密码、权限集合</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      一旦配置了user-service-ref，就不要配置security:user-service</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">security:authentication-provider</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--   登陆用户信息由我们自己来提供         --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">security:user-service</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--   security:user 硬编码一个用户对象在内存中，就不需要去查询数据库了</span></span><br><span class="line"><span class="comment">       将来应该使用从数据库查询</span></span><br><span class="line"><span class="comment">       name: 登陆的用户名  password:登陆的密码</span></span><br><span class="line"><span class="comment">       authorities: 指定的权限(既可以是角色名也可以权限名) authorities与上面access一致才能访问</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       &#123;noop&#125;使用的是明文，no operation 不要对密码做处理</span></span><br><span class="line"><span class="comment"> --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">security:user</span> <span class="attr">name</span>=<span class="string">&quot;admin&quot;</span> <span class="attr">password</span>=<span class="string">&quot;&#123;noop&#125;admin&quot;</span> <span class="attr">authorities</span>=<span class="string">&quot;ROLE_ADMIN&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">security:user-service</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">security:authentication-provider</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">security:authentication-manager</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>{noop}：表示当前使用的密码为明文。表示当前密码不需要加密</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163901.png" alt="img"></p>
<p>自动跳转到登录页面（springSecurity自动提供的）</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163902.png" alt="img"> </p>
<p>输入错误用户名和密码</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163903.png" alt="img"> </p>
<p>输入正确用户名和密码（admin/admin）</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163904.png" alt="img"> </p>
<p>此时说明没有登录成功的页面。</p>
<p>如果新建index.html，可以正常访问index.html</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163905.png" alt="img"> </p>
<h3 id="【小结】-2"><a href="#【小结】-2" class="headerlink" title="【小结】"></a>【小结】</h3><p>使用步骤</p>
<ol>
<li>创建Maven工程, 添加坐标</li>
<li>配置web.xml(前端控制器,springSecurity权限相关的过滤器 DelegatingFilterProxy, 过滤器的名称不能修改，一定是springSecurityFilterChain)</li>
<li>创建spring-security.xml(security:http 自动配置,使用表达式的方式完成授权，只要具有ROLE_ADMIN的角色权限才能访问系统中的所有功能； 授权管理器，指定用户名admin，密码{noop}admin，具有ROLE_ADMIN的角色权限)</li>
</ol>
<p>注意实现</p>
<p>​    1.在web.xml里面配置的权限相关的过滤器名字不能改（springSecurityFilterChain）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span>   </span><br><span class="line">   <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSecurityFilterChain<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSecurityFilterChain<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>​    2.入门案例里面没有指定密码加密方式的. 配置密码的时候的加{noop}</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:user-service</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">security:user</span> <span class="attr">name</span>=<span class="string">&quot;admin&quot;</span> <span class="attr">password</span>=<span class="string">&quot;&#123;noop&#125;admin&quot;</span> <span class="attr">authorities</span>=<span class="string">&quot;ROLE_ADMIN&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">security:user-service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="1-5-Spring-Security进阶"><a href="#1-5-Spring-Security进阶" class="headerlink" title="1.5. Spring Security进阶"></a>1.5. <strong>Spring Security进阶</strong></h2><h3 id="【目标】-3"><a href="#【目标】-3" class="headerlink" title="【目标】"></a>【目标】</h3><p>前面我们已经完成了Spring Security的入门案例，通过入门案例我们可以看到，Spring Security将我们项目中的所有资源都保护了起来，要访问这些资源必须要完成认证而且需要具有ROLE_ADMIN角色。</p>
<p>但是入门案例中的使用方法离我们真实生产环境还差很远，还存在如下一些问题：</p>
<p>1、项目中我们将所有的资源（所有请求URL pattern=/**）都保护起来，实际环境下往往有一些资源不需要认证也可以访问，也就是可以匿名访问(静态资源)。</p>
<p>2、登录页面是由框架生成的，而我们的项目往往会使用自己的登录页面。</p>
<p>3、直接将用户名和密码配置在了配置文件中，而真实生产环境下的用户名和密码往往保存在数据库中。</p>
<p>4、在配置文件中配置的密码使用明文，这非常不安全，而真实生产环境下密码需要进行加密。</p>
<p>本章节需要对这些问题进行改进。</p>
<h3 id="【路径】-3"><a href="#【路径】-3" class="headerlink" title="【路径】"></a>【路径】</h3><p>1：配置可匿名访问的资源(不需要登录,权限 角色 就可以访问的资源)</p>
<p>2：使用指定的登录页面（login.html)</p>
<p>3：从数据库查询用户信息</p>
<p>4：对密码进行加密</p>
<p>5：配置多种校验规则（对访问的页面做权限控制）</p>
<p>6：注解方式权限控制（对访问的Controller类做权限控制）</p>
<p>7：退出登录</p>
<h3 id="【讲解】-3"><a href="#【讲解】-3" class="headerlink" title="【讲解】"></a>【讲解】</h3><h3 id="1-5-1-配置可匿名访问的资源"><a href="#1-5-1-配置可匿名访问的资源" class="headerlink" title="1.5.1. 配置可匿名访问的资源"></a>1.5.1. <strong>配置可匿名访问的资源</strong></h3><p>【路径】</p>
<p>1：在项目中创建js、css目录并在两个目录下提供任意一些测试文件</p>
<p>2：在spring-security.xml文件中配置，指定哪些资源可以匿名访问</p>
<p>第一步：在项目中创建js、css目录并在两个目录下提供任意一些测试文件</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163906.png" alt="img"> </p>
<p>访问<a target="_blank" rel="noopener" href="http://localhost:85/js/vue.js">http://localhost:85/js/vue.js</a></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163907.png" alt="img"> </p>
<p>第二步：在spring-security.xml文件中配置，指定哪些资源可以匿名访问</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  http：用于定义相关权限控制</span></span><br><span class="line"><span class="comment">  指定哪些资源不需要进行权限校验，可以使用通配符</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">security</span>=<span class="string">&quot;none&quot;</span> <span class="attr">pattern</span>=<span class="string">&quot;/js/**&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">security</span>=<span class="string">&quot;none&quot;</span> <span class="attr">pattern</span>=<span class="string">&quot;/css/**&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过上面的配置可以发现，js和css目录下的文件可以在没有认证的情况下任意访问。</p>
<h3 id="1-5-2-使用指定的登录页面"><a href="#1-5-2-使用指定的登录页面" class="headerlink" title="1.5.2. 使用指定的登录页面"></a>1.5.2. <strong>使用指定的登录页面</strong></h3><p>【路径】</p>
<p>1：提供login.html作为项目的登录页面</p>
<p>2：修改spring-security.xml文件，指定login.html页面可以匿名访问</p>
<p>3：修改spring-security.xml文件，加入表单登录信息的配置</p>
<p>4：修改spring-security.xml文件，关闭csrfFilter过滤器</p>
<p>【讲解】</p>
<p>第一步：提供login.html作为项目的登录页面</p>
<p>1：用户名是abc</p>
<p>2：密码是bbb</p>
<p>3：登录的url是/login</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">&#x27;f&#x27;</span> <span class="attr">action</span>=<span class="string">&#x27;/login&#x27;</span> <span class="attr">method</span>=<span class="string">&#x27;POST&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>用户名:<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;text&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;abc&#x27;</span> <span class="attr">value</span>=<span class="string">&#x27;&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>密码:<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;password&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;bbb&#x27;</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&#x27;2&#x27;</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登陆&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二步：修改spring-security.xml文件，指定login.html页面可以匿名访问，否则无法访问。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">security</span>=<span class="string">&quot;none&quot;</span> <span class="attr">pattern</span>=<span class="string">&quot;/login.html&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>第三步：修改spring-security.xml文件，加入表单登录信息的配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--   登陆配置 form-login</span></span><br><span class="line"><span class="comment">login-page: 登陆页面</span></span><br><span class="line"><span class="comment">username-parameter: 前端传过来的用户名的参数名</span></span><br><span class="line"><span class="comment">password-parameter: 前端传过来的密码的参数名</span></span><br><span class="line"><span class="comment">login-processing-url: 处理登陆请求的url</span></span><br><span class="line"><span class="comment">default-target-url: 登陆成功后默认跳转的页面, success.html -&gt; login.html-&gt;success.html</span></span><br><span class="line"><span class="comment">always-use-default-target: true不管是从哪个页面转到login.html，登陆后都跑到default-target-url</span></span><br><span class="line"><span class="comment">    success.html -&gt; login.html-&gt; index.html</span></span><br><span class="line"><span class="comment">authentication-failure-url: 登陆失败后跳转的页面</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">security:form-login</span></span></span><br><span class="line"><span class="tag">            <span class="attr">login-page</span>=<span class="string">&quot;/login.html&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">username-parameter</span>=<span class="string">&quot;abc&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">password-parameter</span>=<span class="string">&quot;bbb&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">login-processing-url</span>=<span class="string">&quot;/login&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">default-target-url</span>=<span class="string">&quot;/index.html&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">always-use-default-target</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">authentication-failure-url</span>=<span class="string">&quot;/fail.html&quot;</span></span></span><br><span class="line"><span class="tag">        &gt;</span><span class="tag">&lt;/<span class="name">security:form-login</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第四步：修改spring-security.xml文件，关闭CsrfFilter过滤器</p>
<p> <img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163908.png" alt="image-20200630170633682"></p>
<h4 id="1-5-2-1-注意1："><a href="#1-5-2-1-注意1：" class="headerlink" title="1.5.2.1. 注意1："></a>1.5.2.1. <strong>注意1：</strong></h4><p>如果用户名和密码输入不正确/正确。抛出异常：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163909.png" alt="img"> </p>
<p>分析原因：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163910.png" alt="img"> </p>
<p>Spring-security采用盗链机制，其中_csrf使用token标识和随机字符，每次访问页面都会随机生成，然后和服务器进行比较，成功可以访问，不成功不能访问（403：权限不足）。</p>
<p>解决方案：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--关闭盗链安全请求--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:csrf</span> <span class="attr">disabled</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163911.png" alt="img"> </p>
<h4 id="1-5-2-2-注意2："><a href="#1-5-2-2-注意2：" class="headerlink" title="1.5.2.2. 注意2："></a>1.5.2.2. <strong>注意2：</strong></h4><p>1:创建test.html</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    我是test页面</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2：先访问test.html页面，跳转到login.html</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163912.png" alt="img"> </p>
<p>3：再使用admin、admin登录，会跳转到test.html，怎么办？</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163913.png" alt="img"> </p>
<p>分析原因：</p>
<p>登录成功后，没有始终跳转到成功页面，而是跳转到了之前访问的页面。</p>
<p>解决方案：</p>
<p>always-use-default-target=”true”</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    登录页面配置</span></span><br><span class="line"><span class="comment">    login-page:登录页面</span></span><br><span class="line"><span class="comment">    login-processing-url:处理登录的地址</span></span><br><span class="line"><span class="comment">    default-target-url:登录成功后默认跳转地址</span></span><br><span class="line"><span class="comment">    authentication-failure-url:登录失败跳转地址</span></span><br><span class="line"><span class="comment">    always-use-default-target=&quot;true&quot;：登录成功后，始终跳转到default-target-url指定的地址，即登录成功的默认地址</span></span><br><span class="line"><span class="comment"> --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:form-login</span> <span class="attr">login-page</span>=<span class="string">&quot;/login.html&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">username-parameter</span>=<span class="string">&quot;username&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">password-parameter</span>=<span class="string">&quot;password&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">login-processing-url</span>=<span class="string">&quot;/login.do&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">default-target-url</span>=<span class="string">&quot;/index.html&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">authentication-failure-url</span>=<span class="string">&quot;/login.html&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">always-use-default-target</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-5-3-从数据库查询用户信息"><a href="#1-5-3-从数据库查询用户信息" class="headerlink" title="1.5.3. 从数据库查询用户信息"></a>1.5.3. <strong>从数据库查询用户信息</strong></h3><p>【路径】</p>
<p>1：定义UserService类，实现UserDetailsService接口。</p>
<p>2：修改spring-security.xml配置（注册且注入UserService）</p>
<p>如果我们要从数据库动态查询用户信息，就必须按照spring security框架的要求提供一个实现UserDetailsService接口的实现类，并按照框架的要求进行配置即可。框架会自动调用实现类中的方法并自动进行密码校验。</p>
<p>第一步：定义UserService类，实现UserDetailsService接口。</p>
<p>实现类代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.gson.internal.$Gson$Preconditions;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.pojo.Permission;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description: 将来要进入spring容器, 服务也可以注入进来</span></span><br><span class="line"><span class="comment"> * User: Eric</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过用户名加载用户信息 User登陆用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> UsernameNotFoundException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">//提供用户的名称、密码、权限集合</span></span><br><span class="line">        <span class="comment">// 通过用户名来查询数据库, 查询角色及权限</span></span><br><span class="line">        com.itheima.health.pojo.User userInDB = findByUsername(username);</span><br><span class="line">        <span class="comment">// String username,</span></span><br><span class="line">        <span class="comment">// String password, 数据库中的密码, 密码校验(security帮我们做了)</span></span><br><span class="line">        <span class="comment">// Collection&lt;? extends GrantedAuthority&gt; authorities 权限集合</span></span><br><span class="line">        List&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> ArrayList&lt;GrantedAuthority&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历用户身上的角色</span></span><br><span class="line">        Set&lt;Role&gt; roles = userInDB.getRoles();</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> != roles)&#123;</span><br><span class="line">            <span class="keyword">for</span> (Role role : roles) &#123;</span><br><span class="line">                <span class="comment">// 授予的权限</span></span><br><span class="line">                <span class="comment">// 构造方法要的是一个角色名</span></span><br><span class="line">                GrantedAuthority ga = <span class="keyword">new</span> SimpleGrantedAuthority(role.getName());</span><br><span class="line">                authorities.add(ga);</span><br><span class="line">                <span class="keyword">for</span> (Permission permission : role.getPermissions()) &#123;</span><br><span class="line">                    <span class="comment">// 权限</span></span><br><span class="line">                    ga = <span class="keyword">new</span> SimpleGrantedAuthority(permission.getName());</span><br><span class="line">                    authorities.add(ga);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 登陆用户的认证信息,名称、密码、权限集合</span></span><br><span class="line">        User user = <span class="keyword">new</span> User(username,<span class="string">&quot;&#123;noop&#125;&quot;</span> + userInDB.getPassword(),authorities);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 假设从数据库查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> com.itheima.health.pojo.<span class="function">User <span class="title">findByUsername</span> <span class="params">(String username)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;admin&quot;</span>.equals(username)) &#123;</span><br><span class="line">            com.itheima.health.pojo.User user = <span class="keyword">new</span> com.itheima.health.pojo.User();</span><br><span class="line">            user.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">            user.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Role role = <span class="keyword">new</span> Role();</span><br><span class="line">            role.setName(<span class="string">&quot;ROLE_ADMIN&quot;</span>);</span><br><span class="line">            Permission permission = <span class="keyword">new</span> Permission();</span><br><span class="line">            permission.setName(<span class="string">&quot;ADD_CHECKITEM&quot;</span>);</span><br><span class="line">            role.getPermissions().add(permission);</span><br><span class="line"></span><br><span class="line">            Set&lt;Role&gt; roleList = <span class="keyword">new</span> HashSet&lt;Role&gt;();</span><br><span class="line">            roleList.add(role);</span><br><span class="line"></span><br><span class="line">            user.setRoles(roleList);</span><br><span class="line">            <span class="keyword">return</span> user;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BCryptPasswordEncoder encoder = <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">        <span class="comment">// 加密密码</span></span><br><span class="line">        <span class="comment">//System.out.println(encoder.encode(&quot;1234&quot;));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证密码</span></span><br><span class="line">        <span class="comment">// 原密码</span></span><br><span class="line">        <span class="comment">// 加密后的密码</span></span><br><span class="line">        System.out.println(encoder.matches(<span class="string">&quot;1234&quot;</span>, <span class="string">&quot;$2a$10$P7Qx8eKUPX5lngz9UEstUOaDRldEWrj9Rbyox/ShyeoxvPbEHTvni&quot;</span>));</span><br><span class="line">        System.out.println(encoder.matches(<span class="string">&quot;1234&quot;</span>, <span class="string">&quot;$2a$10$5q.0a0F0hRix8TBJxQ4DB.ekwGzPs3e47hoQVNR7cihi/Rob.G3T6&quot;</span>));</span><br><span class="line">        System.out.println(encoder.matches(<span class="string">&quot;1234&quot;</span>, <span class="string">&quot;$2a$10$voh.1PJRXQazoijK72sIoOslpmLYPyB.6LtT7aUrXqUO5G8Aw43we&quot;</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(encoder.matches(<span class="string">&quot;1234&quot;</span>, <span class="string">&quot;$2a$10$u/BcsUUqZNWUxdmDhbnoeeobJy6IBsL1Gn/S0dMxI2RbSgnMKJ.4a&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第二步：spring-security.xml：</p>
<p> <img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163914.png" alt="image-20200630170940539"></p>
<p>本章节我们提供了UserService实现类，并且按照框架的要求实现了UserDetailsService接口。在spring配置文件中注册UserService，指定其作为认证过程中根据用户名查询用户信息的处理类。当我们进行登录操作时，spring security框架会调用UserService的loadUserByUsername方法查询用户信息，并根据此方法中提供的密码和用户页面输入的密码进行比对来实现认证操作。</p>
<h3 id="1-5-4-对密码进行加密"><a href="#1-5-4-对密码进行加密" class="headerlink" title="1.5.4. 对密码进行加密"></a>1.5.4. <strong>对密码进行加密</strong></h3><p>前面我们使用的密码都是明文的，这是非常不安全的。一般情况下用户的密码需要进行加密后再保存到数据库中。</p>
<p>常见的密码加密方式有：</p>
<p>3DES、AES、DES：使用对称加密算法，可以通过解密来还原出原始密码  可逆加密</p>
<p>MD5、SHA1：使用单向HASH算法，无法通过计算还原出原始密码，但是可以建立彩虹表进行查表破解</p>
<p>MD5可进行加盐加密，保证安全</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMD5</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMD5</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 密码同样是1234却变成了密码不相同</span></span><br><span class="line">        System.out.println(MD5Utils.md5(<span class="string">&quot;1234xiaowang&quot;</span>)); <span class="comment">//a8231077b3d5b40ffadee7f4c8f66cb7</span></span><br><span class="line">        System.out.println(MD5Utils.md5(<span class="string">&quot;1234xiaoli&quot;</span>)); <span class="comment">//7d5250d8620fcdb53b25f96a1c7be591</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样的密码值，盐值不同，加密的结果不同。</p>
<p>bcrypt：将salt随机并混入最终加密后的密码，验证时也无需单独提供之前的salt，从而无需单独处理salt问题</p>
<p>spring security中的BCryptPasswordEncoder方法采用SHA-256 +随机盐+密钥对密码进行加密。SHA系列是Hash算法，不是加密算法，使用加密算法意味着可以解密（这个与编码/解码一样），但是采用Hash处理，其过程是不可逆的。</p>
<p>（1）加密(encode)：注册用户时，使用SHA-256+随机盐+密钥把用户输入的密码进行hash处理，得到密码的hash值，然后将其存入数据库中。</p>
<p>（2）密码匹配(matches)：用户登录时，密码匹配阶段并没有进行密码解密（因为密码经过Hash处理，是不可逆的），而是使用相同的算法把用户输入的密码进行hash处理，得到密码的hash值，然后将其与从数据库中查询到的密码hash值进行比较。如果两者相同，说明用户输入的密码正确。</p>
<p>这正是为什么处理密码时要用hash算法，而不用加密算法。因为这样处理即使数据库泄漏，黑客也很难破解密码。</p>
<p>建立测试代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.security.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSpringSecurity</span> </span>&#123;</span><br><span class="line">    <span class="comment">// SpringSecurity加盐加密</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSpringSecurity</span><span class="params">()</span></span>&#123;</span><br><span class="line">        BCryptPasswordEncoder encoder = <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">        <span class="comment">// 加密密码</span></span><br><span class="line">        <span class="comment">//System.out.println(encoder.encode(&quot;1234&quot;));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证密码</span></span><br><span class="line">        <span class="comment">// 原密码</span></span><br><span class="line">        <span class="comment">// 加密后的密码</span></span><br><span class="line">        System.out.println(encoder.matches(<span class="string">&quot;1234&quot;</span>, <span class="string">&quot;$2a$10$P7Qx8eKUPX5lngz9UEstUOaDRldEWrj9Rbyox/ShyeoxvPbEHTvni&quot;</span>));</span><br><span class="line">        System.out.println(encoder.matches(<span class="string">&quot;1234&quot;</span>, <span class="string">&quot;$2a$10$5q.0a0F0hRix8TBJxQ4DB.ekwGzPs3e47hoQVNR7cihi/Rob.G3T6&quot;</span>));</span><br><span class="line">        System.out.println(encoder.matches(<span class="string">&quot;1234&quot;</span>, <span class="string">&quot;$2a$10$voh.1PJRXQazoijK72sIoOslpmLYPyB.6LtT7aUrXqUO5G8Aw43we&quot;</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(encoder.matches(<span class="string">&quot;1234&quot;</span>, <span class="string">&quot;$2a$10$u/BcsUUqZNWUxdmDhbnoeeobJy6IBsL1Gn/S0dMxI2RbSgnMKJ.4a&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加密后的格式一般为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$2a$10$/bTVvqqlH9UiE0ZJZ7N2Me3RIgUCdgMheyTgV0B4cMCSokPa.6oCa</span><br></pre></td></tr></table></figure>

<p>加密后字符串的长度为固定的60位。其中：</p>
<p>$是分割符，无意义；</p>
<p>2a是bcrypt加密版本号；</p>
<p>10是cost的值；</p>
<p>而后的前22位是salt值；</p>
<p>再然后的字符串就是密码的密文了。</p>
<p>实现步骤：</p>
<p>【路径】</p>
<p>1：在spring-security.xml文件中指定密码加密对象</p>
<p>2：修改UserService实现类</p>
<p>【讲解】</p>
<p>第一步：在spring-security.xml文件中指定密码加密对象</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    三：认证管理，定义登录账号名和密码，并授予访问的角色、权限</span></span><br><span class="line"><span class="comment">    authentication-manager：认证管理器，用于处理认证操作</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:authentication-manager</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        authentication-provider：认证提供者，执行具体的认证逻辑</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security:authentication-provider</span> <span class="attr">user-service-ref</span>=<span class="string">&quot;userService&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--指定密码加密策略--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">security:password-encoder</span> <span class="attr">ref</span>=<span class="string">&quot;encoder&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">security:password-encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">security:authentication-provider</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">security:authentication-manager</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--配置密码加密对象--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;encoder&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">&quot;org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二步：修改UserService实现类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.gson.internal.$Gson$Preconditions;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.pojo.Permission;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description: 将来要进入spring容器, 服务也可以注入进来</span></span><br><span class="line"><span class="comment"> * User: Eric</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过用户名加载用户信息 User登陆用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> UsernameNotFoundException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">//提供用户的名称、密码、权限集合</span></span><br><span class="line">        <span class="comment">// 通过用户名来查询数据库, 查询角色及权限</span></span><br><span class="line">        com.itheima.health.pojo.User userInDB = findByUsername(username);</span><br><span class="line">        <span class="comment">// String username,</span></span><br><span class="line">        <span class="comment">// String password, 数据库中的密码, 密码校验(security帮我们做了)</span></span><br><span class="line">        <span class="comment">// Collection&lt;? extends GrantedAuthority&gt; authorities 权限集合</span></span><br><span class="line">        List&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> ArrayList&lt;GrantedAuthority&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历用户身上的角色</span></span><br><span class="line">        <span class="comment">/*Set&lt;Role&gt; roles = userInDB.getRoles();</span></span><br><span class="line"><span class="comment">        if(null != roles)&#123;</span></span><br><span class="line"><span class="comment">            for (Role role : roles) &#123;</span></span><br><span class="line"><span class="comment">                // 授予的权限</span></span><br><span class="line"><span class="comment">                // 构造方法要的是一个角色名</span></span><br><span class="line"><span class="comment">                GrantedAuthority ga = new SimpleGrantedAuthority(role.getName());</span></span><br><span class="line"><span class="comment">                authorities.add(ga);</span></span><br><span class="line"><span class="comment">                for (Permission permission : role.getPermissions()) &#123;</span></span><br><span class="line"><span class="comment">                    // 权限</span></span><br><span class="line"><span class="comment">                    ga = new SimpleGrantedAuthority(permission.getName());</span></span><br><span class="line"><span class="comment">                    authorities.add(ga);</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//测试其它方式的认证</span></span><br><span class="line">        GrantedAuthority ga = <span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">&quot;ROLE_ADMIN&quot;</span>);</span><br><span class="line">        authorities.add(ga);</span><br><span class="line">        ga = <span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">&quot;add&quot;</span>);</span><br><span class="line">        authorities.add(ga);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 登陆用户的认证信息,名称、密码、权限集合</span></span><br><span class="line">        <span class="comment">//User user = new User(username,&quot;&#123;noop&#125;&quot; + userInDB.getPassword(),authorities);</span></span><br><span class="line">        <span class="comment">// 使用加密的密码后，去除&#123;noop&#125;</span></span><br><span class="line">        User user = <span class="keyword">new</span> User(username,userInDB.getPassword(),authorities);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 假设从数据库查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> com.itheima.health.pojo.<span class="function">User <span class="title">findByUsername</span> <span class="params">(String username)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;admin&quot;</span>.equals(username)) &#123;</span><br><span class="line">            com.itheima.health.pojo.User user = <span class="keyword">new</span> com.itheima.health.pojo.User();</span><br><span class="line">            user.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">            <span class="comment">//user.setPassword(&quot;admin&quot;);</span></span><br><span class="line">            <span class="comment">// 使用密码加密器encoder, 加密后的密码</span></span><br><span class="line">            user.setPassword(<span class="string">&quot;$2a$10$P7Qx8eKUPX5lngz9UEstUOaDRldEWrj9Rbyox/ShyeoxvPbEHTvni&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Role role = <span class="keyword">new</span> Role();</span><br><span class="line">            role.setName(<span class="string">&quot;ROLE_ADMIN&quot;</span>);</span><br><span class="line">            Permission permission = <span class="keyword">new</span> Permission();</span><br><span class="line">            permission.setName(<span class="string">&quot;ADD_CHECKITEM&quot;</span>);</span><br><span class="line">            role.getPermissions().add(permission);</span><br><span class="line"></span><br><span class="line">            Set&lt;Role&gt; roleList = <span class="keyword">new</span> HashSet&lt;Role&gt;();</span><br><span class="line">            roleList.add(role);</span><br><span class="line"></span><br><span class="line">            user.setRoles(roleList);</span><br><span class="line">            <span class="keyword">return</span> user;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BCryptPasswordEncoder encoder = <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">        <span class="comment">// 加密密码</span></span><br><span class="line">        <span class="comment">//System.out.println(encoder.encode(&quot;1234&quot;));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证密码</span></span><br><span class="line">        <span class="comment">// 原密码</span></span><br><span class="line">        <span class="comment">// 加密后的密码</span></span><br><span class="line">        System.out.println(encoder.matches(<span class="string">&quot;1234&quot;</span>, <span class="string">&quot;$2a$10$P7Qx8eKUPX5lngz9UEstUOaDRldEWrj9Rbyox/ShyeoxvPbEHTvni&quot;</span>));</span><br><span class="line">        System.out.println(encoder.matches(<span class="string">&quot;1234&quot;</span>, <span class="string">&quot;$2a$10$5q.0a0F0hRix8TBJxQ4DB.ekwGzPs3e47hoQVNR7cihi/Rob.G3T6&quot;</span>));</span><br><span class="line">        System.out.println(encoder.matches(<span class="string">&quot;1234&quot;</span>, <span class="string">&quot;$2a$10$voh.1PJRXQazoijK72sIoOslpmLYPyB.6LtT7aUrXqUO5G8Aw43we&quot;</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(encoder.matches(<span class="string">&quot;1234&quot;</span>, <span class="string">&quot;$2a$10$u/BcsUUqZNWUxdmDhbnoeeobJy6IBsL1Gn/S0dMxI2RbSgnMKJ.4a&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用密码加密器小结:</p>
<ol>
<li><p>security.xml添加bean 加密器 </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 加密器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;encoder&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<ol start="2">
<li><p>security.xml使用加密器</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:authentication-provider</span> <span class="attr">user-service-ref</span>=<span class="string">&quot;userService&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  provider调用 service 来获取认证用户信息  --&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--   &lt;security:user-service&gt;</span></span><br><span class="line"><span class="comment">             写死内存中一个用户信息</span></span><br><span class="line"><span class="comment">               authorities: 这个用户所拥有的权限/角色</span></span><br><span class="line"><span class="comment">               明文密码:  noop no operation</span></span><br><span class="line"><span class="comment">               密码加密器：默认使用BcyptPasswordEncoder</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                 &lt;security:user name=&quot;admin&quot; authorities=&quot;ROLE_ADMIN&quot; password=&quot;&#123;noop&#125;admin&quot;/&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            &lt;/security:user-service&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security:password-encoder</span> <span class="attr">ref</span>=<span class="string">&quot;encoder&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">security:authentication-provider</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>修改UserService中admin用户的密码为密文, 去{noop}</p>
</li>
</ol>
<h3 id="1-5-5-配置多种验证规则（对页面）"><a href="#1-5-5-配置多种验证规则（对页面）" class="headerlink" title="1.5.5.  配置多种验证规则（对页面）"></a>1.5.5.  配置多种验证规则（对页面）</h3><p>为了测试方便，首先在项目中创建a.html、b.html、c.html、d.html几个页面</p>
<p>修改spring-security.xml文件：</p>
<p>前提：&lt;security:http auto-config=”true” use-expressions=”true”&gt;，开启对表达式的支持</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--只要认证通过就可以访问--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">&quot;/index.html&quot;</span>  <span class="attr">access</span>=<span class="string">&quot;isAuthenticated()&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">&quot;/a.html&quot;</span>  <span class="attr">access</span>=<span class="string">&quot;isAuthenticated()&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--拥有add权限就可以访问b.html页面--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">&quot;/b.html&quot;</span>  <span class="attr">access</span>=<span class="string">&quot;hasAuthority(&#x27;add&#x27;)&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--拥有ROLE_ADMIN角色就可以访问c.html页面，</span></span><br><span class="line"><span class="comment">    注意：此处虽然写的是ADMIN角色，框架会自动加上前缀ROLE_--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">&quot;/c.html&quot;</span>  <span class="attr">access</span>=<span class="string">&quot;hasRole(&#x27;ADMIN&#x27;)&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--拥有ROLE_ADMIN角色就可以访问d.html页面--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">&quot;/d.html&quot;</span>  <span class="attr">access</span>=<span class="string">&quot;hasRole(&#x27;ABC&#x27;)&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p>登录后可以访问a.html,b.html,c.html，不能访问d.html（抛出403的异常）</p>
<h3 id="1-5-6-注解方式权限控制（对类）"><a href="#1-5-6-注解方式权限控制（对类）" class="headerlink" title="1.5.6. 注解方式权限控制（对类）"></a>1.5.6. 注解方式权限控制（对类）</h3><p>Spring Security除了可以在配置文件中配置权限校验规则，还可以使用注解方式控制类中方法的调用。例如Controller中的某个方法要求必须具有某个权限才可以访问，此时就可以使用Spring Security框架提供的注解方式进行控制。</p>
<p>【路径】</p>
<p>1：在spring-security.xml文件中配置组件扫描和mvc的注解驱动，用于扫描Controller</p>
<p>2：在spring-security.xml文件中开启权限注解支持</p>
<p>3：创建Controller类并在Controller的方法上加入注解（@PreAuthorize）进行权限控制</p>
<p>实现步骤：</p>
<p>第一步：在spring-security.xml文件中配置组件扫描，用于扫描Controller</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.itheima&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span><span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二步：在spring-security.xml文件中开启权限注解支持</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--开启注解方式权限控制--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:global-method-security</span> <span class="attr">pre-post-annotations</span>=<span class="string">&quot;enabled&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>第三步：创建Controller类并在Controller的方法上加入注解（@PreAuthorize）进行权限控制</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.prepost.PreAuthorize;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;add&#x27;)&quot;)</span><span class="comment">//表示用户必须拥有add权限才能调用当前方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;add...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ROLE_ADMIN&#x27;)&quot;)</span><span class="comment">//表示用户必须拥有ROLE_ADMIN角色才能调用当前方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;update...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/delete&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ABC&#x27;)&quot;)</span><span class="comment">//表示用户必须拥有ABC角色才能调用当前方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">delete</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;delete...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试delete方法不能访问</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163915.png" alt="img"> </p>
<p>小结:</p>
<ol>
<li><p>开启注解支持</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:global-method-security</span> <span class="attr">pre-post-annotations</span>=<span class="string">&quot;enabled&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>使用mvc:annotation-driven</p>
</li>
<li><p>创建controller，且加入扫包context:component-scan</p>
</li>
<li><p>controller方法@PreAuthorize(hasAuthority/hasRole)</p>
</li>
<li><p>注解掉</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--&lt;security:intercept-url pattern=&quot;/**&quot; access=&quot;hasRole(&#x27;ROLE_ADMIN&#x27;)&quot;/&gt;--&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>URL拦截权限配置，粗颗粒</p>
<p>@PreAuthrize  细颗粒（具体的方法） @PreAuthrize用controller类上</p>
<p>如果类有PreAuthrize, 方法上也有PreAuthrize, 两个条件都满足后才可以访问</p>
<p>推荐：使用角色来做权限控制</p>
<h3 id="1-5-7-退出登录"><a href="#1-5-7-退出登录" class="headerlink" title="1.5.7. 退出登录"></a>1.5.7. 退出登录</h3><p>用户完成登录后Spring Security框架会记录当前用户认证状态为已认证状态，即表示用户登录成功了。那用户如何退出登录呢？我们可以在spring-security.xml文件中进行如下配置：</p>
<p>【路径】</p>
<p>1：index.html定义退出登录链接</p>
<p>2：在spring-security.xml定义</p>
<p>【讲解】</p>
<p>第一步：index.html定义退出登录链接</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    登录成功！<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/logout&quot;</span>&gt;</span>退出登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二步：在spring-security.xml定义：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  logout：退出登录</span></span><br><span class="line"><span class="comment">  logout-url：退出登录操作对应的请求路径</span></span><br><span class="line"><span class="comment">  logout-success-url：退出登录后的跳转页面</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:logout</span> <span class="attr">logout-url</span>=<span class="string">&quot;/logout&quot;</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">logout-success-url</span>=<span class="string">&quot;/login.html&quot;</span> <span class="attr">invalidate-session</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    通过上面的配置可以发现，如果用户要退出登录，只需要请求/logout.do这个URL地址就可以，同时会将当前session失效，最后页面会跳转到login.html页面。</p>
<h3 id="【小结】-3"><a href="#【小结】-3" class="headerlink" title="【小结】"></a>【小结】</h3><p>1：配置可匿名访问的资源(不需要登录,权限 角色 就可以访问)</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">security</span>=<span class="string">&quot;none&quot;</span> <span class="attr">pattern</span>=<span class="string">&quot;/js/**&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">security</span>=<span class="string">&quot;none&quot;</span> <span class="attr">pattern</span>=<span class="string">&quot;/css/**&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">security</span>=<span class="string">&quot;none&quot;</span> <span class="attr">pattern</span>=<span class="string">&quot;/login.html&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2：使用指定的登录页面（login.html)</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:form-login</span> <span class="attr">login-page</span>=<span class="string">&quot;/login.html&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">username-parameter</span>=<span class="string">&quot;username&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">password-parameter</span>=<span class="string">&quot;password&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">login-processing-url</span>=<span class="string">&quot;/login&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">default-target-url</span>=<span class="string">&quot;/index.html&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">authentication-failure-url</span>=<span class="string">&quot;/login.html&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">always-use-default-target</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    关闭跨域访问限制    --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:csrf</span> <span class="attr">disabled</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>3：从数据库查询用户信息</p>
<p>添加类实现UserDetailService接口，实现loadByUsername方法，且要返回UserDetails对象（用户名，数据库中的密码，用户所拥有的权限集合）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:authentication-manager</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security:authentication-provider</span> <span class="attr">user-service-ref</span>=<span class="string">&quot;userService&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">security:password-encoder</span> <span class="attr">ref</span>=<span class="string">&quot;encoder&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">security:password-encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">security:authentication-provider</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">security:authentication-manager</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>4：对密码进行加密</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;encoder&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">userDetail中密码不再用&#123;noop&#125;,把&#123;noop&#125;删除</span><br></pre></td></tr></table></figure>

<p>5：配置多种校验规则（对访问的页面做权限控制, 多个时，从上往按顺序，只要有一个满足，就会处理）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">use-expressions=&quot;true&quot;</span><br><span class="line"><span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">&quot;/index.html&quot;</span> <span class="attr">access</span>=<span class="string">&quot;isAuthenticated()&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">security:intercept-url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">&quot;/a.html&quot;</span> <span class="attr">access</span>=<span class="string">&quot;isAuthenticated()&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">security:intercept-url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">&quot;/b.html&quot;</span> <span class="attr">access</span>=<span class="string">&quot;hasAuthority(&#x27;add&#x27;)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">security:intercept-url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">&quot;/c.html&quot;</span> <span class="attr">access</span>=<span class="string">&quot;hasRole(&#x27;ROLE_ADMIN&#x27;)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">security:intercept-url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">&quot;/d.html&quot;</span> <span class="attr">access</span>=<span class="string">&quot;hasRole(&#x27;ABC&#x27;)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">security:intercept-url</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>6：注解方式权限控制（对访问的Controller类做权限控制）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:global-method-security</span> <span class="attr">pre-post-annotations</span>=<span class="string">&quot;enabled&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">security:global-method-security</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>同时使用注解：</p>
<p>在Controller类中的方法上添加：@PreAuthorize(value = “hasRole(‘ROLE_ADMIN’)”)</p>
<p>7：退出登录</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:logout</span> <span class="attr">logout-url</span>=<span class="string">&quot;/logout&quot;</span> <span class="attr">logout-success-url</span>=<span class="string">&quot;/login.html&quot;</span> <span class="attr">invalidate-session</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">security:logout</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="2-项目中使用Spring-Security【重点】"><a href="#2-项目中使用Spring-Security【重点】" class="headerlink" title="2. 项目中使用Spring Security【重点】"></a>2. 项目中使用Spring Security【重点】</h1><p>前面我们已经学习了Spring Security框架的使用方法，本章节我们就需要将Spring Security框架应用到后台系统中进行权限控制，其本质就是认证和授权。</p>
<p>要进行认证和授权需要前面课程中提到的权限模型涉及的7张表支撑，因为用户信息、权限信息、菜单信息、角色信息、关联信息等都保存在这7张表中，也就是这些表中的数据是我们进行认证和授权的依据。所以在真正进行认证和授权之前需要对这些数据进行管理，即我们需要开发如下一些功能：</p>
<p>1、用户数据管理（增删改查、用户关联角色）</p>
<p>2、角色数据管理（增删改查、角色关联权限、角色关联菜单）</p>
<p>3、权限数据管理（增删改查）</p>
<p>4、菜单数据管理（增删改查）</p>
<p>鉴于时间关系，我们不再实现这些数据管理的代码开发。我们可以直接将数据导入到数据库中即可。</p>
<h2 id="导入用户、角色、权限、菜单的初始数据"><a href="#导入用户、角色、权限、菜单的初始数据" class="headerlink" title="导入用户、角色、权限、菜单的初始数据"></a>导入用户、角色、权限、菜单的初始数据</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163916.png" alt="img"> </p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163917.png" alt="img"> </p>
<h3 id="【目标】-4"><a href="#【目标】-4" class="headerlink" title="【目标】"></a>【目标】</h3><p>在传智健康的项目中使用SpringSecurity完成认证和授权</p>
<h3 id="【路径】-4"><a href="#【路径】-4" class="headerlink" title="【路径】"></a>【路径】</h3><p>1：导入SpringSecurity环境</p>
<p>（1）pom.xml中添加依赖</p>
<p>（2）health_web web.xml添加代理过滤器</p>
<p>2：实现认证和授权</p>
<p>（1）导入login.html,放入health_web工程的webapp目录下</p>
<p>（2）认证：SpringSecurityUserService.java</p>
<p>（3）创建UserService类、UserDao接口类、UserDao映射文件</p>
<p>（4）springmvc.xml（dubbo注解扫描范围扩大）</p>
<p>（5）spring-security.xml</p>
<ul>
<li>静态资源</li>
<li>拦截规则，所有都必须登陆后才可访问</li>
<li>登陆页面配置</li>
<li>关闭csrf</li>
<li>frame访问策略</li>
<li>退出登陆</li>
<li>开启注解权限控制</li>
<li>认证管理器<ul>
<li>认证信息提供者</li>
<li>加密器</li>
</ul>
</li>
</ul>
<p>（6）springmvc.xml（导入spring-security.xml）</p>
<p>（7）CheckItemController类（@PreAuthorize(“hasAuthority(‘CHECKITEM_ADD’)”)：完成权限）</p>
<p>（8）捕获异常</p>
<p>3：显示用户名</p>
<p>4：用户退出</p>
<h3 id="【讲解】-4"><a href="#【讲解】-4" class="headerlink" title="【讲解】"></a>【讲解】</h3><h2 id="2-1-导入Spring-Security环境"><a href="#2-1-导入Spring-Security环境" class="headerlink" title="2.1. 导入Spring Security环境"></a>2.1. <strong>导入Spring Security环境</strong></h2><p>【路径】</p>
<p>1：pom.xml导入坐标</p>
<p>2：web.xml添加代理过滤器</p>
<h3 id="2-1-1-第一步：pom-xml导入坐标"><a href="#2-1-1-第一步：pom-xml导入坐标" class="headerlink" title="2.1.1. 第一步：pom.xml导入坐标"></a>2.1.1. 第一步：pom.xml导入坐标</h3><p>在health_parent父工程的pom.xml中导入Spring Security的maven坐标（已经引入）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.security.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.security.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="2-1-2-第二步：web-xml添加代理过滤器"><a href="#2-1-2-第二步：web-xml添加代理过滤器" class="headerlink" title="2.1.2. 第二步：web.xml添加代理过滤器"></a>2.1.2. 第二步：web.xml添加代理过滤器</h3><p>在health_web工程的web.xml文件中配置用于整合Spring Security框架的过滤器DelegatingFilterProxy</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">      DelegatingFilterProxy用于整合第三方框架（代理过滤器，非真正的过滤器，真正的过滤器需要在spring的配置文件）</span></span><br><span class="line"><span class="comment">      整合Spring Security时过滤器的名称必须为springSecurityFilterChain，</span></span><br><span class="line"><span class="comment">      否则会抛出NoSuchBeanDefinitionException异常</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSecurityFilterChain<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSecurityFilterChain<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-2-实现认证和授权"><a href="#2-2-实现认证和授权" class="headerlink" title="2.2. 实现认证和授权"></a>2.2. <strong>实现认证和授权</strong></h2><h3 id="2-2-1-第一步：导入login-html页面"><a href="#2-2-1-第一步：导入login-html页面" class="headerlink" title="2.2.1. 第一步：导入login.html页面"></a>2.2.1. <strong>第一步：导入login.html页面</strong></h3><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163918.png" alt="img"> </p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163919.png" alt="img"> </p>
<p>此时login.html是可放行的页面，而pages下的页面必须认证之后才能访问的页面</p>
<h3 id="2-2-2-第二步：SpringSecurityUserService-java"><a href="#2-2-2-第二步：SpringSecurityUserService-java" class="headerlink" title="2.2.2. 第二步：SpringSecurityUserService.java"></a>2.2.2. 第二步：SpringSecurityUserService.java</h3><p>在health_web工程中按照Spring Security框架要求提供SpringSecurityUserService，并且实现UserDetailsService接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.health.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Reference;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.pojo.Permission;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description: 登陆用户认证与授权</span></span><br><span class="line"><span class="comment"> * 记得要把这个类注册到spring容器</span></span><br><span class="line"><span class="comment"> * User: Eric</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringSecurityUserService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Reference</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提供登陆用户信息  username password 权限集合 authorities</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> UsernameNotFoundException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">       <span class="comment">//根据登陆用户名称查询用户权限信息</span></span><br><span class="line">       <span class="comment">//t_user -&gt; t_user_role -&gt; t_role -&gt; t_role_permission -&gt; t_permission</span></span><br><span class="line">       <span class="comment">//找出用户所拥有的角色，及角色下所拥有的权限集合</span></span><br><span class="line">       <span class="comment">//User.roles(角色集合).permissions(权限集合)</span></span><br><span class="line">        User user = userService.findByUsername(username);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> != user)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 用户名</span></span><br><span class="line">            <span class="comment">// 密码</span></span><br><span class="line">            String password = user.getPassword();</span><br><span class="line">            <span class="comment">// 权限集合</span></span><br><span class="line">            List&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> ArrayList&lt;GrantedAuthority&gt;();</span><br><span class="line">            <span class="comment">// 授权</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 用户所拥有的角色</span></span><br><span class="line">            SimpleGrantedAuthority sai = <span class="keyword">null</span>;</span><br><span class="line">            Set&lt;Role&gt; roles = user.getRoles();</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> != roles)&#123;</span><br><span class="line">                <span class="keyword">for</span> (Role role : roles) &#123;</span><br><span class="line">                    <span class="comment">// 角色用关键字, 授予角色</span></span><br><span class="line">                    sai = <span class="keyword">new</span> SimpleGrantedAuthority(role.getKeyword());</span><br><span class="line">                    authorities.add(sai);</span><br><span class="line">                    <span class="comment">// 权限, 角色下的所有权限</span></span><br><span class="line">                    Set&lt;Permission&gt; permissions = role.getPermissions();</span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">null</span> != permissions)&#123;</span><br><span class="line">                        <span class="keyword">for</span> (Permission permission : permissions) &#123;</span><br><span class="line">                            <span class="comment">// 授予权限</span></span><br><span class="line">                            sai = <span class="keyword">new</span> SimpleGrantedAuthority(permission.getKeyword());</span><br><span class="line">                            authorities.add(sai);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> org.springframework.security.core.userdetails.User(username,password,authorities);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 返回null, 限制访问</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用debug跟踪调试，查看user。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163920.png" alt="img"> </p>
<h3 id="2-2-3-第三步：Service、Dao接口、Mapper映射文件"><a href="#2-2-3-第三步：Service、Dao接口、Mapper映射文件" class="headerlink" title="2.2.3. 第三步：Service、Dao接口、Mapper映射文件"></a>2.2.3. 第三步：Service、Dao接口、Mapper映射文件</h3><p>创建UserService服务接口、服务实现类、Dao接口、Mapper映射文件等</p>
<p>【路径】</p>
<p>1：UserService.java接口</p>
<p>2：UserServiceImpl.java类</p>
<p>3：UserDao.java（使用用户名称查询用户）</p>
<p>4：RoleDao.java（使用用户id查询角色集合）</p>
<p>5：PermissionDao.java（使用角色id查询权限集合）</p>
<p>6：UserDao.xml（使用用户名称查询用户）</p>
<p>7：RoleDao.xml（使用用户id查询角色集合）</p>
<p>8：PermissionDao.xml（使用角色id查询权限集合）</p>
<p>【讲解】</p>
<p>1：服务接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.health.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.health.pojo.User;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description: 用户服务(企业员工)</span></span><br><span class="line"><span class="comment"> * User: Eric</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据登陆用户名称查询用户权限信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">User <span class="title">findByUsername</span><span class="params">(String username)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2：服务实现类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.health.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Service;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.dao.UserDao;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description: No Description</span></span><br><span class="line"><span class="comment"> * User: Eric</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service(interfaceClass = UserService.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据登陆用户名称查询用户权限信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findByUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.findByUsername(username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3：Dao接口</p>
<p>（1）UserDao</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.health.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.health.pojo.User;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description: No Description</span></span><br><span class="line"><span class="comment"> * User: Eric</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据登陆用户名称查询用户权限信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">User <span class="title">findByUsername</span><span class="params">(String username)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>4：Mapper映射文件</p>
<p>（1）UserDao.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.itheima.health.dao.UserDao&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findByUsername&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;String&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;userRolePermissionMap&quot;</span>&gt;</span></span><br><span class="line">        select u.id,u.username,u.password,</span><br><span class="line">               ur.role_id, r.keyword role_keyword, r.name role_name,</span><br><span class="line">               rp.permission_id, p.keyword permission_keyword, p.name permission_name</span><br><span class="line">        From</span><br><span class="line">            t_user u, t_user_role ur, t_role r,</span><br><span class="line">            t_role_permission rp, t_permission p</span><br><span class="line">        where u.id=ur.user_id and ur.role_id=r.id</span><br><span class="line">        and r.id=rp.role_id and rp.permission_id=p.id</span><br><span class="line">        and u.username=#&#123;username&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;userRolePermissionMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;username&quot;</span> <span class="attr">column</span>=<span class="string">&quot;username&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;password&quot;</span> <span class="attr">column</span>=<span class="string">&quot;password&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;roles&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;Role&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;role_id&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;keyword&quot;</span> <span class="attr">column</span>=<span class="string">&quot;role_keyword&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;role_name&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;permissions&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;Permission&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;permission_id&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;keyword&quot;</span> <span class="attr">column</span>=<span class="string">&quot;permission_keyword&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">column</span>=<span class="string">&quot;permission_name&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="2-2-4-第四步：springmvc-xml"><a href="#2-2-4-第四步：springmvc-xml" class="headerlink" title="2.2.4. 第四步：springmvc.xml"></a>2.2.4. 第四步：springmvc.xml</h3><p>修改health_web工程中的springmvc.xml文件，修改dubbo批量扫描的包路径</p>
<p>之前的包扫描</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--批量扫描--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:annotation</span> <span class="attr">package</span>=<span class="string">&quot;com.itheima.health.controller&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>现在的包扫描</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--批量扫描--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dubbo:annotation</span> <span class="attr">package</span>=<span class="string">&quot;com.itheima.health&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>此处原来扫描的包为com.itheima.controller，现在改为com.itheima包的目的是需要将我们上面定义的SpringSecurityUserService也扫描到，因为在SpringSecurityUserService的loadUserByUsername方法中需要通过dubbo远程调用名称为UserService的服务。</p>
<h3 id="2-2-5-第五步：spring-security-xml"><a href="#2-2-5-第五步：spring-security-xml" class="headerlink" title="2.2.5. 第五步：spring-security.xml"></a>2.2.5. 第五步：spring-security.xml</h3><p>【路径】</p>
<p>1：定义哪些链接可以放行</p>
<p>2：定义哪些链接不可以放行，即需要有角色、权限才可以放行</p>
<p>3：认证管理，定义登录账号名和密码，并授予访问的角色、权限</p>
<p>4：设置在页面可以通过iframe访问受保护的页面，默认为不允许访问，需要添加security:frame-options policy=”SAMEORIGIN”</p>
<p>【讲解】</p>
<p>在health_web工程中提供spring-security.xml配置文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:security</span>=<span class="string">&quot;http://www.springframework.org/schema/security&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--   静态资源(css, img, js..., login.html)--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security:http</span> <span class="attr">pattern</span>=<span class="string">&quot;/css/**&quot;</span> <span class="attr">security</span>=<span class="string">&quot;none&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security:http</span> <span class="attr">pattern</span>=<span class="string">&quot;/img/**&quot;</span> <span class="attr">security</span>=<span class="string">&quot;none&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security:http</span> <span class="attr">pattern</span>=<span class="string">&quot;/js/**&quot;</span> <span class="attr">security</span>=<span class="string">&quot;none&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security:http</span> <span class="attr">pattern</span>=<span class="string">&quot;/plugins/**&quot;</span> <span class="attr">security</span>=<span class="string">&quot;none&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security:http</span> <span class="attr">pattern</span>=<span class="string">&quot;/login.html&quot;</span> <span class="attr">security</span>=<span class="string">&quot;none&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">   拦截规则</span></span><br><span class="line"><span class="comment">       autoconfig userexpress</span></span><br><span class="line"><span class="comment">       intercepter-url  pattern access</span></span><br><span class="line"><span class="comment">       登陆页面</span></span><br><span class="line"><span class="comment">       退出登陆</span></span><br><span class="line"><span class="comment">       关闭csrf</span></span><br><span class="line"><span class="comment">       --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security:http</span> <span class="attr">auto-config</span>=<span class="string">&quot;true&quot;</span> <span class="attr">use-expressions</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">&quot;/**&quot;</span> <span class="attr">access</span>=<span class="string">&quot;isAuthenticated()&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">security:form-login</span> <span class="attr">login-page</span>=<span class="string">&quot;/login.html&quot;</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">login-processing-url</span>=<span class="string">&quot;/login.do&quot;</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">username-parameter</span>=<span class="string">&quot;username&quot;</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">password-parameter</span>=<span class="string">&quot;password&quot;</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">default-target-url</span>=<span class="string">&quot;/pages/main.html&quot;</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">always-use-default-target</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">security:headers</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--   frame-options 控制页面中嵌套frame（访问其它页面，把其它页面的内容展示在这个页面上)</span></span><br><span class="line"><span class="comment">         policy 使用的策略:</span></span><br><span class="line"><span class="comment">             DENY: 不允许访问</span></span><br><span class="line"><span class="comment">             SAMEORIGIN: 同域可以访问</span></span><br><span class="line"><span class="comment">             ALLOW-FROM: 指定url可以访问</span></span><br><span class="line"><span class="comment"> --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">security:frame-options</span> <span class="attr">policy</span>=<span class="string">&quot;SAMEORIGIN&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">security:headers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">security:csrf</span> <span class="attr">disabled</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">security:logout</span> <span class="attr">logout-url</span>=<span class="string">&quot;/logout.do&quot;</span> <span class="attr">logout-success-url</span>=<span class="string">&quot;/login.html&quot;</span> <span class="attr">invalidate-session</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">   认证信息</span></span><br><span class="line"><span class="comment">       认证管理器</span></span><br><span class="line"><span class="comment">          提供者 user-service-ref  springSecurityUserService implements UserDetailsService</span></span><br><span class="line"><span class="comment">          配置加密器</span></span><br><span class="line"><span class="comment">     --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security:authentication-manager</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">security:authentication-provider</span> <span class="attr">user-service-ref</span>=<span class="string">&quot;springSecurityUserService&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">security:password-encoder</span> <span class="attr">ref</span>=<span class="string">&quot;encoder&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">security:authentication-provider</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">security:authentication-manager</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--注册springSecurityUserService</span></span><br><span class="line"><span class="comment">   注册密码加密器--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;bean id=&quot;springSecurityUserService&quot; class=&quot;com.itheima.health.security.SpringSecurityUserService&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;encoder&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--  权限控制注解支持  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security:global-method-security</span> <span class="attr">pre-post-annotations</span>=<span class="string">&quot;enabled&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里注意：如果出现以下问题</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163921.png" alt="img"> </p>
<p>使用下面的配置，在spring-security.xml中添加。</p>
<p>放置到&lt;security:http auto-config=”true” use-expressions=”true”&gt;里面</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:headers</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--设置在页面可以通过iframe访问受保护的页面，默认为不允许访问--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">security:frame-options</span> <span class="attr">policy</span>=<span class="string">&quot;SAMEORIGIN&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">security:frame-options</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">security:headers</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>是因为我们在main.html中定义：如果不配置springSecurity会认为iframe访问的html页面是收保护的页面，不允许访问。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-container</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">&quot;right&quot;</span> <span class="attr">class</span>=<span class="string">&quot;el-main&quot;</span> <span class="attr">src</span>=<span class="string">&quot;checkitem.html&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">height</span>=<span class="string">&quot;580px&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">el-container</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>备注：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163922.png" alt="img"> </p>
<h3 id="2-2-6-第六步：springmvc-xml"><a href="#2-2-6-第六步：springmvc-xml" class="headerlink" title="2.2.6. 第六步：springmvc.xml"></a>2.2.6. 第六步：springmvc.xml</h3><p>在springmvc.xml文件中引入spring-security.xml文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;classpath:spring-security.xml&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">import</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="2-2-7-第七步：CheckItemController类"><a href="#2-2-7-第七步：CheckItemController类" class="headerlink" title="2.2.7. 第七步：CheckItemController类"></a>2.2.7. 第七步：CheckItemController类</h3><p>在Controller的方法上加入权限控制注解，此处以CheckItemController为例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.health.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Reference;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.entity.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.entity.QueryPageBean;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.entity.Result;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.pojo.CheckItem;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.service.CheckItemService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.prepost.PreAuthorize;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description: No Description</span></span><br><span class="line"><span class="comment"> * User: Eric</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/checkitem&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckItemController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Reference</span></span><br><span class="line">    <span class="keyword">private</span> CheckItemService checkItemService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/findAll&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">findAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 调用服务查询所有的检查项</span></span><br><span class="line">        List&lt;CheckItem&gt; list = checkItemService.findAll();</span><br><span class="line">        <span class="comment">// 封装返回的结果</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, MessageConstant.QUERY_CHECKITEM_SUCCESS,list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增检查项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> checkitem</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;CHECKITEM_ADD&#x27;)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">add</span><span class="params">(<span class="meta">@RequestBody</span> CheckItem checkitem)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 调用业务服务</span></span><br><span class="line">        checkItemService.add(checkitem);</span><br><span class="line">        <span class="comment">// 响应结果给前端</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, MessageConstant.ADD_CHECKITEM_SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/findPage&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;CHECKITEM_QUERY&#x27;)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">findPage</span><span class="params">(<span class="meta">@RequestBody</span> QueryPageBean queryPageBean)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 调用业务来分页</span></span><br><span class="line">        PageResult&lt;CheckItem&gt; pageResult = checkItemService.findPage(queryPageBean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//return pageResult;</span></span><br><span class="line">        <span class="comment">// 返回给页面, 包装到Result, 统一风格</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, MessageConstant.QUERY_CHECKITEM_SUCCESS,pageResult);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/deleteById&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">deleteById</span><span class="params">(<span class="keyword">int</span> id)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 调用业务服务</span></span><br><span class="line">        <span class="comment">//try &#123;</span></span><br><span class="line">            checkItemService.deleteById(id);</span><br><span class="line">        <span class="comment">//&#125; catch (Exception e) &#123;</span></span><br><span class="line">         <span class="comment">//   e.printStackTrace();</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">        <span class="comment">// 响应结果</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, MessageConstant.DELETE_CHECKITEM_SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过id查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/findById&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">findById</span><span class="params">(<span class="keyword">int</span> id)</span></span>&#123;</span><br><span class="line">        CheckItem checkItem = checkItemService.findById(id);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, MessageConstant.QUERY_CHECKITEM_SUCCESS,checkItem);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改检查项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> checkitem</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">update</span><span class="params">(<span class="meta">@RequestBody</span> CheckItem checkitem)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 调用业务服务</span></span><br><span class="line">        checkItemService.update(checkitem);</span><br><span class="line">        <span class="comment">// 响应结果给前端</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, MessageConstant.EDIT_CHECKITEM_SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="2-2-8-第八步：异常捕获"><a href="#2-2-8-第八步：异常捕获" class="headerlink" title="2.2.8. 第八步：异常捕获"></a>2.2.8. 第八步：异常捕获</h3><p>修改health_web项目中的HealthExceptionAdvice</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.health.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.health.entity.Result;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.exception.HealthException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.AccessDeniedException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.BadCredentialsException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.InternalAuthenticationServiceException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description: No Description</span></span><br><span class="line"><span class="comment"> * User: Eric</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 与前端约定好的，返回的都是json数据</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HealExceptionAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义招出的异常处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> he</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(HealthException.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">handleHealthException</span><span class="params">(HealthException he)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, he.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有未知的异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> he</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">handleException</span><span class="params">(Exception he)</span></span>&#123;</span><br><span class="line">        he.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, <span class="string">&quot;发生未知错误，操作失败，请联系管理员&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码错误</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> he</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(BadCredentialsException.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">handBadCredentialsException</span><span class="params">(BadCredentialsException he)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> handleUserPassword();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名不存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> he</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(InternalAuthenticationServiceException.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">handInternalAuthenticationServiceException</span><span class="params">(InternalAuthenticationServiceException he)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> handleUserPassword();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Result <span class="title">handleUserPassword</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, <span class="string">&quot;用户名或密码错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名不存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> he</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(AccessDeniedException.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">handAccessDeniedException</span><span class="params">(AccessDeniedException he)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">false</span>, <span class="string">&quot;没有权限&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="2-3-显示用户名"><a href="#2-3-显示用户名" class="headerlink" title="2.3. 显示用户名"></a>2.3. <strong>显示用户名</strong></h2><p>【路径】</p>
<p>1：引入js</p>
<p>2：定义loginUsername属性</p>
<p>3：使用钩子函数，调用ajax，查询登录用户（从SpringSecurity中获取），赋值username属性</p>
<p>4：修改页面，使用显示用户信息</p>
<p>【讲解】</p>
<p>前面我们已经完成了认证和授权操作，如果用户认证成功后需要在页面展示当前用户的用户名。Spring Security在认证成功后会将用户信息保存到框架提供的上下文对象中，所以此处我们就可以调用Spring Security框架提供的API获取当前用户的username并展示到页面上。</p>
<p>实现步骤：</p>
<p>第一步：在main.html页面中修改，定义username模型数据基于VUE的数据绑定展示用户名，发送ajax请求获取username</p>
<p>（1）：引入js</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../js/axios-0.18.0.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>（2）：定义loginUsername属性</p>
<p> <img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163923.png" alt="image-20200702170856239"></p>
<p>（3）：使用钩子函数mounted，调用ajax</p>
<p> <img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163924.png" alt="image-20200702170943151"></p>
<p>（4）显示用户名</p>
<p> <img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163925.png" alt="image-20200702171038838"></p>
<p>页面最终如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 页面meta --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>传智健康<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;description&quot;</span> <span class="attr">content</span>=<span class="string">&quot;传智健康&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;keywords&quot;</span> <span class="attr">content</span>=<span class="string">&quot;传智健康&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no&quot;</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入样式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;../plugins/elementui/index.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;../plugins/font-awesome/css/font-awesome.min.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;../css/style.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.el-main</span>&#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="css">        <span class="attribute">top</span>: <span class="number">70px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">bottom</span>: <span class="number">0px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">left</span>: <span class="number">200px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">right</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">class</span>=<span class="string">&quot;hold-transition skin-purple sidebar-mini&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-container</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">el-header</span>  <span class="attr">class</span>=<span class="string">&quot;main-header&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height:70px;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">&quot;navbar navbar-static-top&quot;</span> <span class="attr">:class</span>=<span class="string">&#x27;&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- Logo --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;logo&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-align:center&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;logo-lg&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;../img/logo.png&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;right-menu&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;help&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-exclamation-circle&quot;</span> <span class="attr">aria-hidden</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>帮助<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">el-dropdown</span> <span class="attr">class</span>=<span class="string">&quot;avatar-container right-menu-item&quot;</span> <span class="attr">trigger</span>=<span class="string">&quot;click&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;avatar-wrapper&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;../img/user2-160x160.jpg&quot;</span> <span class="attr">class</span>=<span class="string">&quot;user-avatar&quot;</span>&gt;</span></span><br><span class="line">                                &#123;&#123;loginUsername&#125;&#125;</span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">el-dropdown-menu</span> <span class="attr">slot</span>=<span class="string">&quot;dropdown&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">el-dropdown-item</span> <span class="attr">divided</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;display:block;&quot;</span>&gt;</span>修改密码<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">el-dropdown-item</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">el-dropdown-item</span> <span class="attr">divided</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;display:block;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/logout.do&quot;</span>&gt;</span>退出<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">el-dropdown-item</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">el-dropdown-menu</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">el-dropdown</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">el-header</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">el-container</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">el-aside</span> <span class="attr">width</span>=<span class="string">&quot;200px&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">el-menu</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">el-submenu</span> <span class="attr">v-for</span>=<span class="string">&quot;menu in menuList&quot;</span> <span class="attr">:index</span>=<span class="string">&quot;menu.path&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">template</span> <span class="attr">slot</span>=<span class="string">&quot;title&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa&quot;</span> <span class="attr">:class</span>=<span class="string">&quot;menu.icon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                                &#123;&#123;menu.title&#125;&#125;</span><br><span class="line">                            <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-for</span>=<span class="string">&quot;child in menu.children&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">el-menu-item</span> <span class="attr">:index</span>=<span class="string">&quot;child.path&quot;</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">:href</span>=<span class="string">&quot;child.linkUrl&quot;</span> <span class="attr">target</span>=<span class="string">&quot;right&quot;</span>&gt;</span>&#123;&#123;child.title&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">el-menu-item</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">el-submenu</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">el-menu</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">el-aside</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">el-container</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">&quot;right&quot;</span> <span class="attr">class</span>=<span class="string">&quot;el-main&quot;</span> <span class="attr">src</span>=<span class="string">&quot;ordersetting.html&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">height</span>=<span class="string">&quot;580px&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">el-container</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">el-container</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">el-container</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 引入组件库 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../js/vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../plugins/elementui/index.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;../js/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../js/axios-0.18.0.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">        <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span></span><br><span class="line"><span class="javascript">        <span class="attr">data</span>:&#123;</span></span><br><span class="line"><span class="javascript">            <span class="attr">loginUsername</span>:<span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line"><span class="javascript">            <span class="attr">menuList</span>:[</span></span><br><span class="line"><span class="javascript">                &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;1&quot;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;工作台&quot;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;icon&quot;</span>:<span class="string">&quot;fa-dashboard&quot;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;children&quot;</span>: []</span></span><br><span class="line"><span class="javascript">                &#125;,</span></span><br><span class="line"><span class="javascript">                &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;2&quot;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;会员管理&quot;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;icon&quot;</span>:<span class="string">&quot;fa-user-md&quot;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;children&quot;</span>: [</span></span><br><span class="line"><span class="javascript">                        &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/2-1&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;会员档案&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;linkUrl&quot;</span>:<span class="string">&quot;member.html&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;children&quot;</span>:[]</span></span><br><span class="line"><span class="javascript">                        &#125;,</span></span><br><span class="line"><span class="javascript">                        &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/2-2&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;体检上传&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;children&quot;</span>:[]</span></span><br><span class="line"><span class="javascript">                        &#125;,</span></span><br><span class="line"><span class="javascript">                        &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/2-3&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;会员统计&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;linkUrl&quot;</span>:<span class="string">&quot;all-item-list.html&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;children&quot;</span>:[]</span></span><br><span class="line"><span class="javascript">                        &#125;,</span></span><br><span class="line"><span class="javascript">                    ]</span></span><br><span class="line"><span class="javascript">                &#125;,</span></span><br><span class="line"><span class="javascript">                &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;3&quot;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;预约管理&quot;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;icon&quot;</span>:<span class="string">&quot;fa-tty&quot;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;children&quot;</span>: [</span></span><br><span class="line"><span class="javascript">                        &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/3-1&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;预约列表&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;linkUrl&quot;</span>:<span class="string">&quot;ordersettinglist.html&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;children&quot;</span>:[]</span></span><br><span class="line"><span class="javascript">                        &#125;,</span></span><br><span class="line"><span class="javascript">                        &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/3-2&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;预约设置&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;linkUrl&quot;</span>:<span class="string">&quot;ordersetting.html&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;children&quot;</span>:[]</span></span><br><span class="line"><span class="javascript">                        &#125;,</span></span><br><span class="line"><span class="javascript">                        &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/3-3&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;套餐管理&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;linkUrl&quot;</span>:<span class="string">&quot;setmeal.html&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;children&quot;</span>:[]</span></span><br><span class="line"><span class="javascript">                        &#125;,</span></span><br><span class="line"><span class="javascript">                        &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/3-4&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;检查组管理&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;linkUrl&quot;</span>:<span class="string">&quot;checkgroup.html&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;children&quot;</span>:[]</span></span><br><span class="line"><span class="javascript">                        &#125;,</span></span><br><span class="line"><span class="javascript">                        &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/3-5&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;检查项管理&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;linkUrl&quot;</span>:<span class="string">&quot;/pages/checkitem.html&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;children&quot;</span>:[]</span></span><br><span class="line"><span class="javascript">                        &#125;,</span></span><br><span class="line"><span class="javascript">                    ]</span></span><br><span class="line"><span class="javascript">                &#125;,</span></span><br><span class="line"><span class="javascript">                &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;4&quot;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;健康评估&quot;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;icon&quot;</span>:<span class="string">&quot;fa-stethoscope&quot;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;children&quot;</span>:[</span></span><br><span class="line"><span class="javascript">                        &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/4-1&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;中医体质辨识&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;linkUrl&quot;</span>:<span class="string">&quot;all-medical-list.html&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;children&quot;</span>:[]</span></span><br><span class="line"><span class="javascript">                        &#125;,</span></span><br><span class="line"><span class="javascript">                    ]</span></span><br><span class="line"><span class="javascript">                &#125;,</span></span><br><span class="line"><span class="javascript">                &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;5&quot;</span>,     <span class="comment">//菜单项所对应的路由路径</span></span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;统计分析&quot;</span>,     <span class="comment">//菜单项名称</span></span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;icon&quot;</span>:<span class="string">&quot;fa-heartbeat&quot;</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;children&quot;</span>:[<span class="comment">//是否有子菜单，若没有，则为[]</span></span></span><br><span class="line"><span class="javascript">                        &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/5-1&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;会员数量统计&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;linkUrl&quot;</span>:<span class="string">&quot;/pages/report_member.html&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;children&quot;</span>:[]</span></span><br><span class="line"><span class="javascript">                        &#125;,</span></span><br><span class="line"><span class="javascript">                        &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/5-2&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;预约套餐占比&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;linkUrl&quot;</span>:<span class="string">&quot;/pages/report_setmeal.html&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;children&quot;</span>:[]</span></span><br><span class="line"><span class="javascript">                        &#125;,</span></span><br><span class="line"><span class="javascript">                        &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/5-3&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;运营数据统计&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;linkUrl&quot;</span>:<span class="string">&quot;/pages/report_business.html&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">&quot;children&quot;</span>:[]</span></span><br><span class="line"><span class="javascript">                        &#125;</span></span><br><span class="line"><span class="javascript">                    ]</span></span><br><span class="line"><span class="javascript">                &#125;</span></span><br><span class="line"><span class="javascript">            ]</span></span><br><span class="line"><span class="javascript">        &#125;,</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="title">mounted</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="comment">// 获取登陆用户名</span></span></span><br><span class="line"><span class="javascript">            axios.get(<span class="string">&#x27;/user/getUsername.do&#x27;</span>).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span>(res.data.flag)&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">this</span>.loginUsername = res.data.data;</span></span><br><span class="line"><span class="javascript">                &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">this</span>.$message.error(res.data.message);</span></span><br><span class="line"><span class="javascript">                &#125;</span></span><br><span class="line"><span class="javascript">            &#125;)</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">    &#125;);</span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> wd = <span class="number">200</span>;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">&quot;.el-main&quot;</span>).css(<span class="string">&#x27;width&#x27;</span>, $(<span class="string">&#x27;body&#x27;</span>).width() - wd + <span class="string">&#x27;px&#x27;</span>);</span></span><br><span class="line"><span class="javascript">    &#125;);</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第二步：创建UserController并提供getUsername方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.health.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.health.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.health.entity.Result;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description: No Description</span></span><br><span class="line"><span class="comment"> * User: Eric</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取登陆用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getUsername&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">getUsername</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 获取登陆用户的认证信息</span></span><br><span class="line">        User loginUser = (User) SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br><span class="line">        <span class="comment">// 登陆用户名</span></span><br><span class="line">        String username = loginUser.getUsername();</span><br><span class="line">        <span class="comment">// 返回给前端</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Result(<span class="keyword">true</span>, MessageConstant.GET_USERNAME_SUCCESS,username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过debug调试可以看到Spring Security框架在其上下文中保存的用户相关信息：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163926.png" alt="img"> </p>
<p>显示当前登录人：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209163927.png" alt="img"> </p>
<h2 id="2-4-用户退出"><a href="#2-4-用户退出" class="headerlink" title="2.4. 用户退出"></a>2.4. <strong>用户退出</strong></h2><p>【路径】</p>
<p>1：在main.html中提供的退出菜单上加入超链接</p>
<p>2：在spring-security.xml文件中配置</p>
<p>【讲解】</p>
<p>第一步：在main.html中提供的退出菜单上加入超链接</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-dropdown-item</span> <span class="attr">divided</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;display:block;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/logout.do&quot;</span>&gt;</span>退出<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">el-dropdown-item</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二步：在spring-security.xml文件中配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  logout：退出登录</span></span><br><span class="line"><span class="comment">  logout-url：退出登录操作对应的请求路径</span></span><br><span class="line"><span class="comment">  logout-success-url：退出登录后的跳转页面</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">security:logout</span> <span class="attr">logout-url</span>=<span class="string">&quot;/logout.do&quot;</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">logout-success-url</span>=<span class="string">&quot;/login.html&quot;</span> <span class="attr">invalidate-session</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="【小结】-4"><a href="#【小结】-4" class="headerlink" title="【小结】"></a>【小结】</h3><p>1：导入SpringSecurity环境</p>
<p>（1）pom.xml中添加依赖</p>
<p>（2）web.xml添加代理过滤器</p>
<p>2：实现认证和授权</p>
<p>（1）导入login.html登录页面 webapp目录下</p>
<p>（2）认证：SpringSecurityUserService（@Component），实现UserDetailsService接口</p>
<p>（3）创建UserService类、UserDao接口类、UserDao映射文件（使用用户名查询当前用户信息，包括角色集合和权限集合）</p>
<p>（4）springmvc.xml（dubbo注解扫描范围扩大, 扫到SpringSecurityUserService）</p>
<p>（5）spring-security.xml（重点 存小抄 ）</p>
<ul>
<li>静态资源过滤</li>
<li>拦截的规则 security:http auto-config…., intercept-url, form-login, form-logout, csrf, security:header</li>
<li>开启注解支持 </li>
<li>关闭跨域访问限制</li>
<li>认证管理器-&gt;提供者user-service-ref-&gt;加密器</li>
<li>加密器</li>
</ul>
<p>（6）springmvc.xml（导入spring-security.xml）</p>
<p>（7）CheckItemController类（@PreAuthorize(“hasAuthority(‘CHECKITEM_ADD’)”)：对类中的方法完成权限控制）, hasAuthority  权限校验(t_permission.keyword), hasRole角色校验(t_role.keyword)</p>
<p>（8）checkitem.html（如果没有权限，可以提示错误信息）</p>
<p>异常捕获HealthExceptionHandler, AccessDeniedException, return 没有权限的result</p>
<p>3：显示用户名</p>
<p>从SecurityContextHolder对象中获取认证的用户信息，页面定义一个vue的data变量业接收，使用插值表达式在页面显示,页面加载时发送请求(vue created axios)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取登陆用户的认证信息</span></span><br><span class="line">User loginUser = (User) SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br></pre></td></tr></table></figure>

<p>在jsp中获取登陆用户信息</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">$&#123;sessionScope.SPRING_SECURITY_CONTEXT.authentication.principal.username&#125;</span><br></pre></td></tr></table></figure>

<p>4：用户退出</p>
<p>调用/logout.do   security帮我们做好了</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">小肥龙吃大冰淇淋</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://lvxueyang.vip/post/8f17f32d.html">http://lvxueyang.vip/post/8f17f32d.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://lvxueyang.vip" target="_blank">小肥龙吃大冰淇淋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/javase%E5%9F%BA%E7%A1%80/">javase基础</a><a class="post-meta__tags" href="/tags/%E4%BC%A0%E6%99%BA%E5%81%A5%E5%BA%B7/">传智健康</a></div><div class="post_share"><div class="social-share" data-image="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/86857cf.html"><img class="prev-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">传智健康day10</div></div></a></div><div class="next-post pull-right"><a href="/post/1fa8eebc.html"><img class="next-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">传智健康day08</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/66745618.html" title="传智健康day01"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-08</div><div class="title">传智健康day01</div></div></a></div><div><a href="/post/ff7d07a2.html" title="传智健康day02"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-08</div><div class="title">传智健康day02</div></div></a></div><div><a href="/post/61199201.html" title="传智健康day05"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-08</div><div class="title">传智健康day05</div></div></a></div><div><a href="/post/887a3734.html" title="传智健康day03"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-08</div><div class="title">传智健康day03</div></div></a></div><div><a href="/post/f810c3bb.html" title="传智健康day06"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-08</div><div class="title">传智健康day06</div></div></a></div><div><a href="/post/86857cf.html" title="传智健康day10"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-08</div><div class="title">传智健康day10</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC7%E7%AB%A0-%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-%E6%9D%83%E9%99%90%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">第7章 系统管理-权限设置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%E3%80%81SpringSecurity%E5%85%A5%E9%97%A8%E5%8F%8A%E8%BF%9B%E9%98%B6"><span class="toc-number">2.</span> <span class="toc-text">1. 权限控制、SpringSecurity入门及进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E7%9B%AE%E6%A0%87%E3%80%91"><span class="toc-number">2.0.1.</span> <span class="toc-text">【目标】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E8%B7%AF%E5%BE%84%E3%80%91"><span class="toc-number">2.0.2.</span> <span class="toc-text">【路径】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E8%AE%B2%E8%A7%A3%E3%80%91"><span class="toc-number">2.0.3.</span> <span class="toc-text">【讲解】</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83%E6%A6%82%E5%BF%B5%E3%80%90%E7%90%86%E8%A7%A3%E3%80%91"><span class="toc-number">2.1.</span> <span class="toc-text">1.1. 认证和授权概念【理解】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E6%9D%83%E9%99%90%E6%A8%A1%E5%9D%97%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.2.</span> <span class="toc-text">1.2. 权限模块数据模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E5%B0%8F%E7%BB%93%E3%80%91"><span class="toc-number">2.2.1.</span> <span class="toc-text">【小结】</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-Spring-Security%E7%AE%80%E4%BB%8B"><span class="toc-number">2.3.</span> <span class="toc-text">1.3. Spring Security简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E7%9B%AE%E6%A0%87%E3%80%91-1"><span class="toc-number">2.3.1.</span> <span class="toc-text">【目标】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E8%B7%AF%E5%BE%84%E3%80%91-1"><span class="toc-number">2.3.2.</span> <span class="toc-text">【路径】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E8%AE%B2%E8%A7%A3%E3%80%91-1"><span class="toc-number">2.3.3.</span> <span class="toc-text">【讲解】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E5%B0%8F%E7%BB%93%E3%80%91-1"><span class="toc-number">2.3.4.</span> <span class="toc-text">【小结】</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-Spring-Security%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B-%E3%80%90%E9%87%8D%E7%82%B9%E3%80%91"><span class="toc-number">2.4.</span> <span class="toc-text">1.4. Spring Security入门案例-【重点】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E7%9B%AE%E6%A0%87%E3%80%91-2"><span class="toc-number">2.4.1.</span> <span class="toc-text">【目标】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E8%B7%AF%E5%BE%84%E3%80%91-2"><span class="toc-number">2.4.2.</span> <span class="toc-text">【路径】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E8%AE%B2%E8%A7%A3%E3%80%91-2"><span class="toc-number">2.4.3.</span> <span class="toc-text">【讲解】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-1-%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA"><span class="toc-number">2.4.4.</span> <span class="toc-text">1.4.1. 工程搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-2-%E9%85%8D%E7%BD%AEweb-xml"><span class="toc-number">2.4.5.</span> <span class="toc-text">1.4.2. 配置web.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-3-%E9%85%8D%E7%BD%AEspring-security-xml"><span class="toc-number">2.4.6.</span> <span class="toc-text">1.4.3. 配置spring-security.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E5%B0%8F%E7%BB%93%E3%80%91-2"><span class="toc-number">2.4.7.</span> <span class="toc-text">【小结】</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-Spring-Security%E8%BF%9B%E9%98%B6"><span class="toc-number">2.5.</span> <span class="toc-text">1.5. Spring Security进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E7%9B%AE%E6%A0%87%E3%80%91-3"><span class="toc-number">2.5.1.</span> <span class="toc-text">【目标】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E8%B7%AF%E5%BE%84%E3%80%91-3"><span class="toc-number">2.5.2.</span> <span class="toc-text">【路径】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E8%AE%B2%E8%A7%A3%E3%80%91-3"><span class="toc-number">2.5.3.</span> <span class="toc-text">【讲解】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-1-%E9%85%8D%E7%BD%AE%E5%8F%AF%E5%8C%BF%E5%90%8D%E8%AE%BF%E9%97%AE%E7%9A%84%E8%B5%84%E6%BA%90"><span class="toc-number">2.5.4.</span> <span class="toc-text">1.5.1. 配置可匿名访问的资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-2-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%AE%9A%E7%9A%84%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2"><span class="toc-number">2.5.5.</span> <span class="toc-text">1.5.2. 使用指定的登录页面</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-2-1-%E6%B3%A8%E6%84%8F1%EF%BC%9A"><span class="toc-number">2.5.5.1.</span> <span class="toc-text">1.5.2.1. 注意1：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-2-2-%E6%B3%A8%E6%84%8F2%EF%BC%9A"><span class="toc-number">2.5.5.2.</span> <span class="toc-text">1.5.2.2. 注意2：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-3-%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">2.5.6.</span> <span class="toc-text">1.5.3. 从数据库查询用户信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-4-%E5%AF%B9%E5%AF%86%E7%A0%81%E8%BF%9B%E8%A1%8C%E5%8A%A0%E5%AF%86"><span class="toc-number">2.5.7.</span> <span class="toc-text">1.5.4. 对密码进行加密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-5-%E9%85%8D%E7%BD%AE%E5%A4%9A%E7%A7%8D%E9%AA%8C%E8%AF%81%E8%A7%84%E5%88%99%EF%BC%88%E5%AF%B9%E9%A1%B5%E9%9D%A2%EF%BC%89"><span class="toc-number">2.5.8.</span> <span class="toc-text">1.5.5.  配置多种验证规则（对页面）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-6-%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%EF%BC%88%E5%AF%B9%E7%B1%BB%EF%BC%89"><span class="toc-number">2.5.9.</span> <span class="toc-text">1.5.6. 注解方式权限控制（对类）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-7-%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95"><span class="toc-number">2.5.10.</span> <span class="toc-text">1.5.7. 退出登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E5%B0%8F%E7%BB%93%E3%80%91-3"><span class="toc-number">2.5.11.</span> <span class="toc-text">【小结】</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8Spring-Security%E3%80%90%E9%87%8D%E7%82%B9%E3%80%91"><span class="toc-number">3.</span> <span class="toc-text">2. 项目中使用Spring Security【重点】</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E7%94%A8%E6%88%B7%E3%80%81%E8%A7%92%E8%89%B2%E3%80%81%E6%9D%83%E9%99%90%E3%80%81%E8%8F%9C%E5%8D%95%E7%9A%84%E5%88%9D%E5%A7%8B%E6%95%B0%E6%8D%AE"><span class="toc-number">3.1.</span> <span class="toc-text">导入用户、角色、权限、菜单的初始数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E7%9B%AE%E6%A0%87%E3%80%91-4"><span class="toc-number">3.1.1.</span> <span class="toc-text">【目标】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E8%B7%AF%E5%BE%84%E3%80%91-4"><span class="toc-number">3.1.2.</span> <span class="toc-text">【路径】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E8%AE%B2%E8%A7%A3%E3%80%91-4"><span class="toc-number">3.1.3.</span> <span class="toc-text">【讲解】</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%AF%BC%E5%85%A5Spring-Security%E7%8E%AF%E5%A2%83"><span class="toc-number">3.2.</span> <span class="toc-text">2.1. 导入Spring Security环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9Apom-xml%E5%AF%BC%E5%85%A5%E5%9D%90%E6%A0%87"><span class="toc-number">3.2.1.</span> <span class="toc-text">2.1.1. 第一步：pom.xml导入坐标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9Aweb-xml%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%90%86%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">3.2.2.</span> <span class="toc-text">2.1.2. 第二步：web.xml添加代理过滤器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%AE%9E%E7%8E%B0%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83"><span class="toc-number">3.3.</span> <span class="toc-text">2.2. 实现认证和授权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%AF%BC%E5%85%A5login-html%E9%A1%B5%E9%9D%A2"><span class="toc-number">3.3.1.</span> <span class="toc-text">2.2.1. 第一步：导入login.html页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9ASpringSecurityUserService-java"><span class="toc-number">3.3.2.</span> <span class="toc-text">2.2.2. 第二步：SpringSecurityUserService.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9AService%E3%80%81Dao%E6%8E%A5%E5%8F%A3%E3%80%81Mapper%E6%98%A0%E5%B0%84%E6%96%87%E4%BB%B6"><span class="toc-number">3.3.3.</span> <span class="toc-text">2.2.3. 第三步：Service、Dao接口、Mapper映射文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9Aspringmvc-xml"><span class="toc-number">3.3.4.</span> <span class="toc-text">2.2.4. 第四步：springmvc.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-5-%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9Aspring-security-xml"><span class="toc-number">3.3.5.</span> <span class="toc-text">2.2.5. 第五步：spring-security.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-6-%E7%AC%AC%E5%85%AD%E6%AD%A5%EF%BC%9Aspringmvc-xml"><span class="toc-number">3.3.6.</span> <span class="toc-text">2.2.6. 第六步：springmvc.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-7-%E7%AC%AC%E4%B8%83%E6%AD%A5%EF%BC%9ACheckItemController%E7%B1%BB"><span class="toc-number">3.3.7.</span> <span class="toc-text">2.2.7. 第七步：CheckItemController类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-8-%E7%AC%AC%E5%85%AB%E6%AD%A5%EF%BC%9A%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7"><span class="toc-number">3.3.8.</span> <span class="toc-text">2.2.8. 第八步：异常捕获</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E6%98%BE%E7%A4%BA%E7%94%A8%E6%88%B7%E5%90%8D"><span class="toc-number">3.4.</span> <span class="toc-text">2.3. 显示用户名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E7%94%A8%E6%88%B7%E9%80%80%E5%87%BA"><span class="toc-number">3.5.</span> <span class="toc-text">2.4. 用户退出</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E5%B0%8F%E7%BB%93%E3%80%91-4"><span class="toc-number">3.5.1.</span> <span class="toc-text">【小结】</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 小肥龙吃大冰淇淋</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'pinglun-9gh2lmcnd8587831',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'pinglun-9gh2lmcnd8587831',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/hexo-theme-volantis@latest/source/js/issues.min.js"></script><script src="//code.tidio.co/smwivpnwumemac2wohardi3d3gpud1ag.js" async="async"></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>