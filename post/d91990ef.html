<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>数据库分库分表 | 小肥龙吃大冰淇淋</title><meta name="keywords" content="数据库分库分表"><meta name="author" content="小肥龙吃大冰淇淋"><meta name="copyright" content="小肥龙吃大冰淇淋"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="数据库分库分表​    在项目开发的过程中，随着项目的不断庞大，伴随着的就是数据量的不断膨胀，当数据达到了一个量级之后，就会考虑数据的拆分。这个问题对于所有的中大型项目都不可避免要进行处理。 1）docker下安装mysqldocker run --name mysql3311 -p 3311:3306 --privileged&#x3D;true -ti -e MYSQL_ROOT_PASSWORD&#x3D;12">
<meta property="og:type" content="article">
<meta property="og:title" content="数据库分库分表">
<meta property="og:url" content="https://lvxueyangtiger.github.io/post/d91990ef.html">
<meta property="og:site_name" content="小肥龙吃大冰淇淋">
<meta property="og:description" content="数据库分库分表​    在项目开发的过程中，随着项目的不断庞大，伴随着的就是数据量的不断膨胀，当数据达到了一个量级之后，就会考虑数据的拆分。这个问题对于所有的中大型项目都不可避免要进行处理。 1）docker下安装mysqldocker run --name mysql3311 -p 3311:3306 --privileged&#x3D;true -ti -e MYSQL_ROOT_PASSWORD&#x3D;12">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082055.jpg">
<meta property="article:published_time" content="2021-12-08T07:27:00.000Z">
<meta property="article:modified_time" content="2022-11-27T09:16:44.031Z">
<meta property="article:author" content="小肥龙吃大冰淇淋">
<meta property="article:tag" content="数据库分库分表">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082055.jpg"><link rel="shortcut icon" href="https://lvxueyangboke.oss-cn-beijing.aliyuncs.com/images/20210805191028.png"><link rel="canonical" href="https://lvxueyangtiger.github.io/post/d91990ef"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '数据库分库分表',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-27 17:16:44'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/ali_icon.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mogai.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="小肥龙吃大冰淇淋" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">303</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">108</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">73</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082055.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">小肥龙吃大冰淇淋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">数据库分库分表</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-12-08T07:27:00.000Z" title="发表于 2021-12-08 15:27:00">2021-12-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-27T09:16:44.031Z" title="更新于 2022-11-27 17:16:44">2022-11-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java%E5%AD%A6%E4%B9%A0/">java学习</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java%E5%AD%A6%E4%B9%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/">数据库分库分表</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">20.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>82分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="数据库分库分表"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="数据库分库分表"><a href="#数据库分库分表" class="headerlink" title="数据库分库分表"></a>数据库分库分表</h1><p>​    在项目开发的过程中，随着项目的不断庞大，伴随着的就是数据量的不断膨胀，当数据达到了一个量级之后，就会考虑数据的拆分。这个问题对于所有的中大型项目都不可避免要进行处理。</p>
<h1 id="1）docker下安装mysql"><a href="#1）docker下安装mysql" class="headerlink" title="1）docker下安装mysql"></a>1）docker下安装mysql</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker run --name mysql3311 -p 3311:3306 --privileged=true -ti -e MYSQL_ROOT_PASSWORD=123456 -e MYSQL_USER=user -e MYSQL_PASSWORD=pass -v /home/mysql/docker-data/3311/conf:/etc/mysql/conf.d -v /home/mysql/docker-data/3311/data/:/var/lib/mysql -v /home/mysql/docker-data/3311/logs/:/var/log/mysql -d mysql:5.7</span><br></pre></td></tr></table></figure>

<h1 id="2）数据库扩展思想"><a href="#2）数据库扩展思想" class="headerlink" title="2）数据库扩展思想"></a>2）数据库扩展思想</h1><ul>
<li>热备份：数据库在运行的过程中，对数据进行备份操作。相对的，还有冷备份，冷备份需要停机，然后对数据进行备份操作。</li>
<li>多活：所谓的多活，就是让数据库机器节点会存在多个，避免单点情况的出现。</li>
<li>故障切换：当一台数据库物理机出现异常状况时，可以自动的切换到其他物理机上。</li>
<li>读写分离：当存在存在多台数据库物理机，将读写操作分别交给不同的机器完成。</li>
<li>负载均衡：假设当存在多台数据库物理机接收读请求时，多个请求会均匀的分配到不同的机器上，避免大量请求压在某一台机器上。</li>
</ul>
<h1 id="3）Mysql常见架构设计"><a href="#3）Mysql常见架构设计" class="headerlink" title="3）Mysql常见架构设计"></a>3）Mysql常见架构设计</h1><p>​    首先对于架构设计来说，没有百分百的完美架构，只有适合的架构。要想理解mysql的分库分表，必须要先对mysql的架构设计有一定的了解，对于mysql架构，一定会使用到读写分离，在此基础上有五种常见架构设计：一主一从或多从、主主复制、级联复制、主主与级联复制结合。</p>
<h2 id="3-1）主从复制"><a href="#3-1）主从复制" class="headerlink" title="3.1）主从复制"></a>3.1）主从复制</h2><h4 id="3-1-1）概念"><a href="#3-1-1）概念" class="headerlink" title="3.1.1）概念"></a>3.1.1）概念</h4><p>​    这种架构设计是使用的最多的。在读写分离的基础上，会存在一台master作为写机，一个或多个slave作为读机。因为在实际的情况下，读的请求量一般是远远大于写请求的。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183908.png" alt="image-20200524232250958"></p>
<p>​    采用这种架构之后，当应用写入输入时，会把数据写入到master节点，然后由master节点将写入数据复制到slave节点上。</p>
<p>缺点：</p>
<p>​    1）因为master是单点存在的，所以如果要对master进行停机维护，则无法接收写请求。</p>
<p>​    2）master需要将写入数据复制到各个slave节点，但是复制是有一定的时间延迟的，因此有可能出现查询数据延迟。</p>
<p>​    3）如必须要对master进行停机维护，则需将某一个slave提升为master节点，将哪一个slave提升为master也需要考虑。</p>
<p>​    4）当某一个slave被提升为master后，则会造成被提升的master节点与原master的数据不一致。并且之前的master并没有最新的binlog信息。</p>
<h4 id="3-1-2）搭建"><a href="#3-1-2）搭建" class="headerlink" title="3.1.2）搭建"></a>3.1.2）搭建</h4><p>​    此处以一主一备来进行演示。</p>
<p>​    根据刚才docker创建mysql容器的参数指定，需要在两台机器上的**/home/mysql/docker-data/3307/conf<strong>目录下，需要创建mysql的配置文件</strong>my.cnf**。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># For advice on how to change settings please see</span><br><span class="line"># http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">#</span><br><span class="line"># Remove leading # and set to the amount of RAM for the most important data</span><br><span class="line"># cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.</span><br><span class="line"># innodb_buffer_pool_size = 128M</span><br><span class="line">#</span><br><span class="line"># Remove leading # to turn on a very important data integrity option: logging</span><br><span class="line"># changes to the binary log between backups.</span><br><span class="line"># log_bin</span><br><span class="line">#</span><br><span class="line"># Remove leading # to set options mainly useful for reporting servers.</span><br><span class="line"># The server defaults are faster for transactions and fast SELECTs.</span><br><span class="line"># Adjust sizes as needed, experiment to find the optimal values.</span><br><span class="line"># join_buffer_size = 128M</span><br><span class="line"># sort_buffer_size = 2M</span><br><span class="line"># read_rnd_buffer_size = 2M</span><br><span class="line">#datadir=/home/mysql/docker-data/3307/data</span><br><span class="line">#socket=/home/mysql/docker-data/3307/mysql.sock</span><br><span class="line"></span><br><span class="line">character_set_server=utf8</span><br><span class="line">init_connect=&#x27;SET NAMES utf8&#x27;</span><br><span class="line"></span><br><span class="line"># Disabling symbolic-links is recommended to prevent assorted security risks</span><br><span class="line">symbolic-links=0</span><br><span class="line"></span><br><span class="line">#log-error=/home/mysql/docker-data/3307/logs/mysqld.log</span><br><span class="line">#pid-file=/home/mysql/docker-data/3307/mysqld.pid</span><br><span class="line">lower_case_table_names=1</span><br><span class="line">#指定主机号，不允许出现重复</span><br><span class="line">server-id=1423307</span><br><span class="line">#开启binlog</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line">auto_increment_increment=2</span><br><span class="line">auto_increment_offset=1</span><br><span class="line"></span><br><span class="line">#rpl_semi_sync_master_enabled=1</span><br><span class="line">#rpl_semi_sync_master_timeout=10000</span><br></pre></td></tr></table></figure>

<p>​    在master的docker容器中添加mysql权限，开启备份机复制，并且设置备份用户信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#添加权限</span><br><span class="line">GRANT REPLICATION SLAVE,FILE,REPLICATION CLIENT ON *.* TO &#x27;repluser&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;123456&#x27;;</span><br><span class="line"></span><br><span class="line">#刷新权限</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183909.png" alt="image-20200525231404926"></p>
<p>​    设置并刷新权限后，<strong>重启mysql服务器</strong>，可以查看master上的binlog信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show master status;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183910.png" alt="image-20200525231505062"></p>
<p>​    <code>注：如果没有查询到任何信息代表master的binlog日志没有开启，查看配置文件或者重启docker容器</code>。</p>
<p>​    接着在slave中进入到mysql容器，设置master信息，用于标注当前slave的master是谁。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">change master to master_host=&#x27;master的ip&#x27;,master_port=master的端口号,master_user=&#x27;repluser&#x27;,master_password=&#x27;123456&#x27;,master_log_file=&#x27;master中的binlob文件&#x27;,master_log_pos=master中的position位置信息;</span><br><span class="line"></span><br><span class="line">change master to master_host=&#x27;192.168.200.180&#x27;,master_port=3310,master_user=&#x27;repluser&#x27;,master_password=&#x27;123456&#x27;,master_log_file=&#x27;mysql-bin.000001&#x27;,master_log_pos=154;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    <img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183911.png" alt="image-20200525231937581"></p>
<p>​    设置完成后，还要开启slave中的<strong>IO</strong>和<strong>SQL</strong>线程，这两个线程主要用于slave中进行数据备份，可以先查看slave中这两个线程的状态</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show slave status\G</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183912.png" alt="image-20200525232119712"></p>
<p>​    此时，在slave中，这两个线程是关闭的，需要将这两个线程进行开启</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">start slave;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183913.png" alt="image-20200525232307499"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183914.png" alt="image-20200525232323712"></p>
<p>​    此时可以看到，这两个线程已经开启。</p>
<p>​    截止到此，mysql主从复制就已经搭建完毕了。接着可以来查看相关的状态信息。</p>
<p>​    首先可以先查看slave中的binlog是否已经开启</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show global variables like &quot;%log%&quot;;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183915.png" alt="image-20200525233252673"></p>
<p>​    根据信息，slave节点中的binlog日志已经开启。</p>
<p>​    接着还可以查看master、slave中的进程信息，</p>
<p>​    在master中输入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show processlist</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183916.png" alt="image-20200525233400935"></p>
<p>​    根据信息已经告诉我们，master已经发送的自身的binlog信息到slave上，并且正在等待更多的更新操作。</p>
<p>​    同时也可以在slave中输入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show processlist</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183917.png" alt="image-20200525233509873"></p>
<p>​    根据信息可以看到，在slave它已经连接到了master，正在等待master发送事件，并且slave已经读取了所有的relay log信息，并且正在等待更多的更新操作。</p>
<h4 id="3-1-3）测试"><a href="#3-1-3）测试" class="headerlink" title="3.1.3）测试"></a>3.1.3）测试</h4><p>​    1）在master中的user数据库中创建一张表。创建成功后，slave中也会同步更新出相同的表。</p>
<p>​    2）在master中enjoy数据库的表中新增一条记录，新增成功后，slave中也会同步新增一条数据。</p>
<p>​    3）但在slave中新增记录，master中并不会同步更新，因为现在配置的是单向复制。只会master向slave中复制数据。</p>
<h2 id="3-2）Mysql复制原理解析"><a href="#3-2）Mysql复制原理解析" class="headerlink" title="3.2）Mysql复制原理解析"></a>3.2）Mysql复制原理解析</h2><p>​    刚才已经搭建完了主从复制，虽然效果已经实现了，但是对于mysql内部的复制操作，其内部又是如何完成的呢？</p>
<p>​    在mysql中，其有两种复制机制，分别是：<strong>异步复制</strong>、<strong>半同步复制</strong>。默认采用异步复制。</p>
<h3 id="3-2-1）复制机制的实现原理"><a href="#3-2-1）复制机制的实现原理" class="headerlink" title="3.2.1）复制机制的实现原理"></a>3.2.1）复制机制的实现原理</h3><h4 id="3-2-1-1）异步复制执行流程"><a href="#3-2-1-1）异步复制执行流程" class="headerlink" title="3.2.1.1）异步复制执行流程"></a>3.2.1.1）异步复制执行流程</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183918.png" alt="image-20200824144352020"></p>
<p>1）应用事务提交到master</p>
<p>2）master接收到应用事务提交请求后，会更新内部的binlog日志，接着让mysql引擎执行事务操作，并返回给客户端执行结果信息。同时在master中会存在一个事件监听，其会一直监听着master中binlog日志文件的改变，一旦发现日志文件发生改变，则会触发dump线程。</p>
<p>3）dump线程被触发后，会通知slave中的IO线程现在有事务操作要进行同步。</p>
<p>4）slave中IO线程接收到通知后，会从slave中<strong>relay-log.info</strong>文件中获取slave中的binlog日志文件和pos位置信息。接着会把这部分信息发送给master的dump线程。</p>
<p>5）master的dump线程收到这些信息后，会根据slave发送的binlog日志文件和pos位置，将最新的binlog日志和pos位置后面的内容同步给slave的IO线程。</p>
<p>6）slave的IO线程接收到这些信息后，会将这部分内容同步到slave中的relay-bin文件中。</p>
<p>7）当relay-bin文件发生改变后，会触发slave 线程执行sql操作，【异步操作】</p>
<p>8）当slave向relay-bin写入完成后，还会向master返回一个ACK消息，通知slave已经执行成功。</p>
<p>​    对于这一系列的操作，可以发现master和slave在进行同步时是以异步的方式完成的，master写入完binlog后，会马上通过引擎进行事务提交并向客户端返回响应，对于与slave同步的操作，则是异步完成的。</p>
<p>​    虽然这种方式的RT很快，但是容易出现数据不一致的情况。</p>
<h4 id="3-2-1-2）半同步复制执行流程"><a href="#3-2-1-2）半同步复制执行流程" class="headerlink" title="3.2.1.2）半同步复制执行流程"></a>3.2.1.2）半同步复制执行流程</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183919.png" alt="image-20200824144623639"></p>
<p>​    半同步复制与异步复制的工作流程大体相似，但不同的是，当master中的binlog日志写入完成后，其不会马上通过引擎进行事务提交，而会处于等待，等到slave同步完成向master返回ACK通知后，才会唤醒等待，继续向下执行。</p>
<p>​    等待的时长，默认为10秒，但该时间可以配置。</p>
<p>​    半同步复制尽量的避免的主从数据不一致的情况，但是会造成吞吐量的降低。</p>
<p>​    对于这个问题，mysql也进行了解决，假设使用半同步复制进行备份时，slave节点挂掉了，那么当master等待10秒后，仍然会进行引擎提交，同时会将半同步复制切换为异步复制。等到slave节点重启后，又会自动的从异步复制切换到半同步复制。</p>
<h3 id="3-2-2）主从异步复制日志效果"><a href="#3-2-2）主从异步复制日志效果" class="headerlink" title="3.2.2）主从异步复制日志效果"></a>3.2.2）主从异步复制日志效果</h3><p>​    Mysql在进行复制操作时，默认是基于异步复制完成的。那为了更好的体会异步复制的效果，可以通过mysql日志来查看具体的复制过程效果。</p>
<p>1）启动主从两台Mysql服务器。</p>
<p>2）查看master的Mysql日志信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker logs -f mysql3307</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183920.png" alt="image-20200529224302948"></p>
<p>​    根据当前查看的日志信息，在master中已经开启了dump线程连接到了id为1453307的slave节点，并且该id就是在slave的mysql配置文件中设置的id。</p>
<p>​    同时pos内容包括当前的binlog日志和pos位置。</p>
<p>3）查看slave的Mysql日志信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker logs -f mysql3307</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183921.png" alt="image-20200529224651937"></p>
<p>​    根据slave中的日志信息，可以看到，当前slave中已经开启了relay-log日志，其对应文件信息就是xxxxx-relay-bin。其内部保存的就是slave中的相关binlog信息和pos位置信息。</p>
<p>​    同时在slave中也已经开启了SQL Thread，并且根据信息可以，它会从xxxx-relay-bin.0006文件的367位置开始复制。</p>
<p>​    同时在slave中也开启了IO Thread，其已经连接到master，并且会从master的binlog日志的154的位置开启复制。</p>
<p>4）查看master当前的binlog日志信息。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#确定当前master正在使用的binlog日志文件</span><br><span class="line">cat mysql-bin.index</span><br><span class="line"></span><br><span class="line">#查看当前binlog日志文件内容</span><br><span class="line">tail -f mysql-bin.000001</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183922.png" alt="image-20200529230743091"></p>
<p>5）查看slave当前的日志信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@bogon data]# cat relay-log.info </span><br><span class="line">7</span><br><span class="line">./8122977f8b0a-relay-bin.000002</span><br><span class="line">864</span><br><span class="line">mysql-bin.000004</span><br><span class="line">1251</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">[root@bogon data]# cat master.info </span><br><span class="line">25</span><br><span class="line">mysql-bin.000004</span><br><span class="line">1251</span><br><span class="line">192.168.200.142</span><br><span class="line">repluser</span><br><span class="line">123456</span><br><span class="line">3307</span><br><span class="line"></span><br><span class="line">[root@bogon data]# cat 8122977f8b0a-relay-bin.index</span><br><span class="line">./8122977f8b0a-relay-bin.000001</span><br><span class="line">./8122977f8b0a-relay-bin.000002</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183923.png" alt="image-20200529231644827"></p>
<p>6）监控slave日志信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tail -f 8122977f8b0a-relay-bin.000002</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183924.png" alt="image-20200529231855898"></p>
<p>7）master中新增数据，触发主从同步</p>
<p>master中日志改变内容如下</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183925.png" alt="image-20200529232120418"></p>
<p>slave中日志改变内容如下</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183926.png" alt="image-20200529232202700"></p>
<h3 id="3-2-3）主从半同步复制配置-amp-效果演示"><a href="#3-2-3）主从半同步复制配置-amp-效果演示" class="headerlink" title="3.2.3）主从半同步复制配置&amp;效果演示"></a>3.2.3）主从半同步复制配置&amp;效果演示</h3><h4 id="3-2-3-1）配置"><a href="#3-2-3-1）配置" class="headerlink" title="3.2.3.1）配置"></a>3.2.3.1）配置</h4><p>1）进入mysql容器，加载lib，<strong>主从节点都要配置</strong>，因为主从节点间会存在切换。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">install plugin rpl_semi_sync_master soname &#x27;semisync_master.so&#x27;;</span><br><span class="line"></span><br><span class="line">install plugin rpl_semi_sync_slave soname &#x27;semisync_slave.so&#x27;;</span><br></pre></td></tr></table></figure>

<p>2）查看插件信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show plugins;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183927.png" alt="image-20200530005008363"></p>
<p>3）启用半同步<strong>（务必先启用从库，再启用主库）</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#先启用从库，再启用主库</span><br><span class="line"></span><br><span class="line">从库：set global rpl_semi_sync_slave_enabled= &#123;0|1&#125;;   # 1：启用，0：禁止</span><br><span class="line"></span><br><span class="line">主库：</span><br><span class="line">     set global rpl_semi_sync_master_enabled= &#123;0|1&#125;;   # 1：启用，0：禁止</span><br><span class="line">     set global rpl_semi_sync_master_timeout=10000;   # 单位为ms</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    当主库开启半同步复制后，打印日志信息如下：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183928.png" alt="image-20200530005339598"></p>
<p>4）从库重启IO Thread</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">stop slave io_thread;</span><br><span class="line">start slave io_thread;</span><br></pre></td></tr></table></figure>

<p>5）截止到此已经完成半同步开启配置，可以查看<strong>主库</strong>状态信息和参数信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#查询状态信息</span><br><span class="line">show global status like &quot;%sync%&quot;;</span><br><span class="line"></span><br><span class="line">#查询参数信息</span><br><span class="line">show global variables like &#x27;%sync%&#x27;;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183929.png" alt="image-20200530005851845"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183930.png" alt="image-20200530005802183"></p>
<h4 id="3-2-2-2）效果演示"><a href="#3-2-2-2）效果演示" class="headerlink" title="3.2.2.2）效果演示"></a>3.2.2.2）效果演示</h4><p>​    根据上述的配置，当前主从两台服务器的复制方式已经改为半同步复制。接下来就可以来查看具体的效果。</p>
<p>1）正常的向master中添加数据，slave可以进行正常数据更新。</p>
<p>master打印日志信息如下： 开启半同步复制，关闭异步复制</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183931.png" alt="image-20200530010448157"></p>
<p>2）关闭slave的IO Thread。 </p>
<p>​    <img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183932.png" alt="image-20200530010702895"></p>
<p>​    再次向master中添加数据。此时可以发现，当进行数据提交时，会出现等待，过了十秒后，会对数据进行保存。同时slave中不会同步的进行数据更新。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183933.png" alt="image-20200530010747005"></p>
<p>​    并且master中会打印日志信息，等待超时，关闭半同步复制。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183934.png" alt="image-20200530010928093"></p>
<p>​    此时复制机制就会由半同步复制转换为异步复制，当再次向master中添加数据，不会再次出现等待。</p>
<p>3）slave中重新开启IO Thread。</p>
<p>​    首先：异步复制会再次转换为半同步复制，master中打印日志信息如下：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183935.png" alt="image-20200530011251399"></p>
<p>​    其次：在slave IO Tthread关闭这段时间内的数据，会同步到slave中，不会出现数据丢失。</p>
<h2 id="3-3）主主复制"><a href="#3-3）主主复制" class="headerlink" title="3.3）主主复制"></a>3.3）主主复制</h2><h3 id="3-3-1）概念"><a href="#3-3-1）概念" class="headerlink" title="3.3.1）概念"></a>3.3.1）概念</h3><p>​    对于主从复制来说，其内部会存在一台master以及一台或多台slave。但有一个非常明显的问题，<strong>master是单点存在</strong>。一旦master宕机，则无法进行数据的写入。为了解决这个问题，可以使用主主复制架构。</p>
<p>​    在主主复制架构中，会存在两台master，没有slave。并且会对这两台master进行读写分离，两台master会进行相互的复制。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183936.png" alt="image-20200530012403644"></p>
<p>​    在此架构中，两台master会进行双向复制，为什么这么做呢？ 因为假设现在负责写的master宕机了，那么写的工作则会交给之前负责读的服务器来完成，相当于它即负责写又负责读。等到原先负责写的master恢复了，其在继续负责写工作。 反之亦然。因此才需要两者间进行双向复制。</p>
<p>​    此时缺点也非常明显，虽然master不存在单点了，但是对于读来说，如果并发量大的话，它肯定扛不住。对于主主复制架构来说，应用较少。</p>
<h3 id="3-3-2）搭建"><a href="#3-3-2）搭建" class="headerlink" title="3.3.2）搭建"></a>3.3.2）搭建</h3><p>​    主主复制的搭建和主从非常类似，只不过主主复制会进行互指。</p>
<p>1）参照主从完成搭建。</p>
<p>2）原slave端也要开启权限</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#添加权限</span><br><span class="line">GRANT REPLICATION SLAVE,FILE,REPLICATION CLIENT ON *.* TO &#x27;repluser&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;123456&#x27;;</span><br><span class="line"></span><br><span class="line">#刷新权限</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line">#重启mysql服务并查看binlog信息</span><br><span class="line">show master status</span><br></pre></td></tr></table></figure>

<p>3）在master这一端也要配置slave的相关配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">change master to master_host=&#x27;master的ip&#x27;,master_port=master的端口号,master_user=&#x27;repluser&#x27;,master_password=&#x27;123456&#x27;,master_log_file=&#x27;master中的binlob文件&#x27;,master_log_pos=master中的position位置信息;</span><br><span class="line"></span><br><span class="line">change master to master_host=&#x27;192.168.200.181&#x27;,master_port=3308,master_user=&#x27;repluser&#x27;,master_password=&#x27;123456&#x27;,master_log_file=&#x27;mysql-bin.000002&#x27;,master_log_pos=154;</span><br><span class="line"></span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure>

<p>3）查看master和slave的进程列表：show processlist。可以发现他们现在互为主备。</p>
<p>master： </p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183937.png" alt="image-20200530020237138"></p>
<p>slave：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183938.png" alt="image-20200530020332258"></p>
<h3 id="3-3-3）测试"><a href="#3-3-3）测试" class="headerlink" title="3.3.3）测试"></a>3.3.3）测试</h3><p>​    当在两台服务器中添加数据，都可以完成双向同步。</p>
<h2 id="3-4）级联复制架构"><a href="#3-4）级联复制架构" class="headerlink" title="3.4）级联复制架构"></a>3.4）级联复制架构</h2><p>​    当读压力现在增大并且还想减小主从复制的性能消耗，可以采用级联复制架构。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183939.png" alt="image-20200601225751946"></p>
<p>​    写请求的入口仍为一个，但当master向slave进行复制时，对于slave可以分为多层， master只要向其中两台slave复制即可，然后再由slave将其数据复制到后面更多的slave中。</p>
<p>​    通过这种方式可以减轻master向slave复制的IO压力。</p>
<p>​    但是这种架构也存在一个弊端：slave的延迟会加大。</p>
<h2 id="3-5）双主与级联复制结合架构"><a href="#3-5）双主与级联复制结合架构" class="headerlink" title="3.5）双主与级联复制结合架构"></a>3.5）双主与级联复制结合架构</h2><p>​    对于master在前面几种架构设计中，都存在单点问题， 对于master单点问题的解决，可以采用当前的架构。通过这种架构不仅可以解决master单点的问题，也可以解决slave延迟的问题。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183940.png" alt="image-20200601230908495"></p>
<h1 id="4）Mysql高可用实践"><a href="#4）Mysql高可用实践" class="headerlink" title="4）Mysql高可用实践"></a>4）Mysql高可用实践</h1><h2 id="4-1）高可用简介"><a href="#4-1）高可用简介" class="headerlink" title="4.1）高可用简介"></a>4.1）高可用简介</h2><p>​    以主主架构为例，现在不管写或者读，只要其中一个宕机，则会把它本身工作交给另外一台服务器完成。此时就需要对IP进行一个自动的指向。而且这种服务器IP切换，对于上层应用来说，应该是完全隐藏的，其无需知道当前是由谁来完成具体工作，其只需要来连接一个IP就可以。</p>
<p>​    对于这种需求，就需要通过<strong>keepAlived</strong>来完成IP的自动切换。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183941.png" alt="image-20200530020827979"></p>
<p>​        对于keepalived会在多台mysql服务器进行安装， 同时keepalived间也分为master和slave，  同时master会虚拟化一个VIP供应用进行连接。  如果一旦master挂掉后，会由slave节点继续工作，同时slave节点也会虚拟出相同VIP，供应用进行连接</p>
<h2 id="4-2）keepAlived高可用配置"><a href="#4-2）keepAlived高可用配置" class="headerlink" title="4.2）keepAlived高可用配置"></a>4.2）keepAlived高可用配置</h2><p>1）安装keepalived</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 下载keepalied安装包 http://www.keepalived.org/download.html</span><br><span class="line">2. yum -y install openssl-devel gcc gcc-c++</span><br><span class="line">3. mkdir /etc/keepalived</span><br><span class="line">4. 上传安装包并解压  tar -zxvf keepalived-2.0.18.tar.gz</span><br><span class="line">5. mv keepalived-2.0.18 /usr/local/keepalived</span><br><span class="line">6. cd /usr/local/keepalived</span><br><span class="line">7. ./configure &amp;&amp; make &amp;&amp; make install</span><br><span class="line">8.创建启动文件</span><br><span class="line">cp  -a /usr/local/etc/keepalived   /etc/init.d/</span><br><span class="line">cp  -a /usr/local/etc/sysconfig/keepalived    /etc/sysconfig/</span><br><span class="line">cp  -a /usr/local/sbin/keepalived    /usr/sbin/</span><br></pre></td></tr></table></figure>

<p>2）编写执行shell脚本</p>
<p><strong>进入/etc/keepalived。创建chk.sh</strong>，同时赋予执行权限：<strong>chmod +x chk.sh</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">! /bin/bash</span></span><br><span class="line">mysql -h 192.168.200.180 -u root -p123456 -P 3312 -e &quot;show status;&quot; &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">if [ $? == 0 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot; $host mysql login successfully &quot;</span><br><span class="line">    exit 0</span><br><span class="line">else</span><br><span class="line">    echo &quot;  mysql login faild&quot;</span><br><span class="line">    killall keepalived</span><br><span class="line">    exit 2</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>3）编写keepAlived配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /etc/keepalived</span><br><span class="line"></span><br><span class="line">vi keepalived.conf</span><br><span class="line"></span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">#简单的头部，这里主要可以做邮件通知报警等的设置，此处就暂不配置了；</span><br><span class="line">global_defs &#123;</span><br><span class="line">    #notificationd LVS_DEVEL</span><br><span class="line">    router_id MYSQL_4   #唯一标识不允许出现重复</span><br><span class="line">    script_user root</span><br><span class="line">    enable_script_security</span><br><span class="line">&#125;</span><br><span class="line">#预先定义一个脚本，方便后面调用，也可以定义多个，方便选择；</span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">    script &quot;/etc/keepalived/chk.sh&quot;</span><br><span class="line">    interval 2  #脚本循环运行间隔</span><br><span class="line">&#125;</span><br><span class="line">#VRRP虚拟路由冗余协议配置</span><br><span class="line">vrrp_instance VI_1 &#123;   #VI_1 是自定义的名称；</span><br><span class="line">    state BACKUP    #MASTER表示是一台主设备，BACKUP表示为备用设备【我们这里因为设置为开启不抢占，所以都设置为备用】</span><br><span class="line">    nopreempt      #开启不抢占</span><br><span class="line">    interface ens33   #指定VIP需要绑定的物理网卡</span><br><span class="line">    virtual_router_id 11   #VRID虚拟路由标识，也叫做分组名称，该组内的设备需要相同</span><br><span class="line">    priority 130   #定义这台设备的优先级 1-254；开启了不抢占，所以此处优先级必须高于另一台</span><br><span class="line"></span><br><span class="line">    advert_int 1   #生存检测时的组播信息发送间隔，组内一致</span><br><span class="line">    authentication &#123;    #设置验证信息，组内一致</span><br><span class="line">        auth_type PASS   #有PASS 和 AH 两种，常用 PASS</span><br><span class="line">        auth_pass 111111    #密码</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.200.200    #指定VIP地址，组内一致，可以设置多个IP</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;    #使用在这个域中使用预先定义的脚本，上面定义的</span><br><span class="line">        chk_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>7）启动keepAlived</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start keepalived</span><br></pre></td></tr></table></figure>

<p>8）查看keepAlived执行状态</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ps -ef|grep keepalived</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183942.png" alt="image-20200601220145818"></p>
<p>9）可以通过tail -f /var/log/messages</p>
<p>10）查看ip信息，此时可以发现出现了配置的虚拟ip</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ip a</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183943.png" alt="image-20200601220246701"></p>
<p>11）测试</p>
<p>通过navicat连接mysql，但是当前连接IP为VIP。可以连接成功。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183944.png" alt="image-20200601221633754"></p>
<p>根据上述配置可知，当前连接的为142的mysql。测试添加数据。可以添加成功。</p>
<p>此时将142的mysql服务停止掉，再去查看145机器上的ip a，可以发现145机器上已经出现200的虚拟ip。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183945.png" alt="image-20200601222627661"></p>
<p>再去navicat中添加数据，仍可以添加成功。但此时连接的则为145的mysql了。</p>
<h1 id="5）数据切分核心思想"><a href="#5）数据切分核心思想" class="headerlink" title="5）数据切分核心思想"></a>5）数据切分核心思想</h1><h2 id="5-1）为什么要进行数据切分"><a href="#5-1）为什么要进行数据切分" class="headerlink" title="5.1）为什么要进行数据切分"></a>5.1）为什么要进行数据切分</h2><p>​    当前微服务架构非常流行，很多都会采用微服务架构对其系统进行拆分。 而虽然产生了多个微服务，但因为其用户量和数据量的问题，很有可能仍然使用的是同一个数据库。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183946.png" alt="image-20200601232224434"></p>
<p>​    但是随着用户量和数据量增加，就会出现很多影响数据库性能的因素，如：数据存储量、IO瓶颈、访问量瓶颈等。此时就需要将数据进行拆分，从一个库拆分成多个库。</p>
<h2 id="5-2）数据拆分方式"><a href="#5-2）数据拆分方式" class="headerlink" title="5.2）数据拆分方式"></a>5.2）数据拆分方式</h2><h3 id="5-2-1）垂直拆分"><a href="#5-2-1）垂直拆分" class="headerlink" title="5.2.1）垂直拆分"></a>5.2.1）垂直拆分</h3><p>​    垂直拆分是按照业务将表进行分类并分布到不同的数据节点上。在初始进行数据拆分时，使用垂直拆分是非常直观的一种方式。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183947.png" alt="image-20200601235540364"></p>
<p>垂直拆分的优点：</p>
<ul>
<li>拆分规则明确，按照不同的功能模块或服务分配不同的数据库。</li>
<li>数据维护与定位简单。</li>
</ul>
<p>垂直拆分的缺点：</p>
<ul>
<li>对于读写极其频繁且数据量超大的表，仍然存在存储与性能瓶颈。简单的索引此时已经无法解决问题。</li>
<li>会出现跨库join。</li>
<li>需要对代码进行重构，修改原有的事务操作。</li>
<li>某个表数据量达到一定程度后扩展起来较为困难</li>
</ul>
<h3 id="5-2-2）水平拆分"><a href="#5-2-2）水平拆分" class="headerlink" title="5.2.2）水平拆分"></a>5.2.2）水平拆分</h3><p>​    为了解决垂直拆分出现的问题，可以使用水平拆分继续横向扩展，首先，可以如果<strong>当前数据库的容量没有问题</strong>的话，可以对读写极其频繁且数据量超大的表进行<strong>分表</strong>操作。由一张表拆分出多张表。</p>
<p>​    在一个库中，拆分出多张表，每张表存储不同的数据，这样对于其操作效率会有明显的提升。而且因为处于同一个库中，也不会出现分布式事务的问题。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183948.png" alt="image-20200602001628392"></p>
<p>​    而拆分出多张表后，如果当前数据库的容量已经不够了，但是还要继续拆分的话，就可以进行<strong>分库</strong>操作，产生多个数据库，然后在扩展出的数据库中继续扩展表。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183949.png" alt="image-20200602002017703"></p>
<p>水平拆分的优点：</p>
<ul>
<li>尽量的避免了跨库join操作。</li>
<li>不会存在超大型表的性能瓶颈问题。</li>
<li>事务处理相对简单。</li>
<li>只要拆分规则定义好，很难出现扩展性的限制。</li>
</ul>
<p>水平拆分的缺点：</p>
<ul>
<li>拆分规则不好明确，规则一定会和业务挂钩，如根据id、根据时间等。</li>
<li>不好明确数据位置，难以进行维护。</li>
<li>多数据源管理难度加大，代码复杂度增加。</li>
<li>也会存在分布式事务问题</li>
<li>数据库维护成本增加</li>
</ul>
<h2 id="5-3）数据切分带来的问题"><a href="#5-3）数据切分带来的问题" class="headerlink" title="5.3）数据切分带来的问题"></a>5.3）数据切分带来的问题</h2><ul>
<li>按照用户ID求模，将数据分散到不同的数据库，具有相同数据用户的数据都被分散到一个库中。</li>
<li>按照日期，将不同月甚至日的数据分散到不同的库中。</li>
<li>按照某个特定的字段求模，或者根据特定范围段分散到不同的库中。</li>
</ul>
<p>数据切分带来的核心问题</p>
<ul>
<li>产生引入分布式事务的问题。</li>
<li>跨节点 Join 的问题。</li>
<li>跨节点合并排序分页问题。</li>
</ul>
<h1 id="6）Mycat核心概念-amp-源码部署"><a href="#6）Mycat核心概念-amp-源码部署" class="headerlink" title="6）Mycat核心概念&amp;源码部署"></a>6）Mycat核心概念&amp;源码部署</h1><h2 id="6-1）Mycat简介"><a href="#6-1）Mycat简介" class="headerlink" title="6.1）Mycat简介"></a>6.1）Mycat简介</h2><p>​    当对数据拆分后会产生诸多的问题，对于这些问题的解决，可以借助于数据库中间件来进行解决，现在时下比较流行的是使用Mycat。</p>
<p>​    Mycat是一款数据库中间件，对于应用程序来说是完全透明化的，不管底层的数据如何拆分，应用只需要连接Mycat即可完成对数据的操作。同时它还支持MySQL、SQL Server、Oracle、DB2、PostgreSQL等主流数据库。但是Mycat不会进行数据存储，它只是用于数据的路由。</p>
<p>​    其底层是基于拦截思想实现，其会拦截用户发送过来的SQL语句，首先对SQL语句做了一些特定的分析：如分片分析、路由分析、读写分离分析、缓存分析等，然后将此SQL发往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户。</p>
<p>​    <img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183950.png" alt="image-20200602235241816"></p>
<h2 id="6-2）Mycat特性"><a href="#6-2）Mycat特性" class="headerlink" title="6.2）Mycat特性"></a>6.2）Mycat特性</h2><ul>
<li>支持SQL92标准</li>
<li>遵守Mysql原生协议，跨语言，跨平台，跨数据库的通用中间件代理。</li>
<li>基于心跳的自动故障切换，支持读写分离，支持MySQL主从，以及galera cluster集群。</li>
<li>支持Galera for MySQL集群，Percona Cluster或者MariaDB cluster</li>
<li>基于Nio实现，有效管理线程，高并发问题。</li>
<li>支持数据的多片自动路由与聚合，支持sum,count,max等常用的聚合函数。</li>
<li>支持单库内部任意join，支持跨库2表join。</li>
<li>支持通过全局表，ER关系的分片策略，实现了高效的多表join查询。</li>
<li>支持多租户方案。</li>
<li>支持分布式事务（弱xa）。</li>
<li>支持全局序列号，解决分布式下的主键生成问题。</li>
<li>分片规则丰富，插件化开发，易于扩展。</li>
<li>强大的web，命令行监控。</li>
<li>支持前端作为mysq通用代理，后端JDBC方式支持Oracle、DB2、SQL Server 、 mongodb 。</li>
<li>支持密码加密</li>
<li>支持服务降级</li>
<li>支持IP白名单</li>
<li>支持SQL黑名单、sql注入攻击拦截</li>
<li>支持分表（1.6）</li>
<li>集群基于ZooKeeper管理，在线升级，扩容，智能优化，大数据处理（2.0开发版）。</li>
</ul>
<h2 id="6-3）Mycat源码调试-amp-部署"><a href="#6-3）Mycat源码调试-amp-部署" class="headerlink" title="6.3）Mycat源码调试&amp;部署"></a>6.3）Mycat源码调试&amp;部署</h2><p><strong>源码下载：</strong><a target="_blank" rel="noopener" href="https://codeload.github.com/MyCATApache/Mycat-Server/zip/Mycat-server-1675-release">https://codeload.github.com/MyCATApache/Mycat-Server/zip/Mycat-server-1675-release</a></p>
<p><strong>默认端口：8066</strong></p>
<p><strong>配置启动参数：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-DMYCAT_HOME=D:\workspace\Mycat-Server-Mycat-server-1675-release\src\main</span><br><span class="line">#设置堆外内存大小</span><br><span class="line">-XX:MaxDirectMemorySize=512M </span><br></pre></td></tr></table></figure>

<p><code>为什么要设置堆外内存：当使用mycat对非分片查询时，会把所有的数据查询出来，然后把这部分数据放在堆外内存中</code></p>
<p>​    在Mycat有核心三个配置文件，分别为：sever.xml、schema.xml、rule.xml</p>
<ul>
<li><strong>server.xml</strong>：是Mycat服务器参数调整和用户授权的配置文件。</li>
<li><strong>schema.xml</strong>：是逻辑库定义和表以及分片定义的配置文件</li>
<li><strong>rule.xml</strong>：是分片规则的配置文件，分片规则的具体一些参数信息单独存放为文件，也在这个目录下，配置文件修改需要重启MyCAT。</li>
</ul>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183951.png" alt="image-20200603000918666"></p>
<h2 id="6-4）MyCat核心概念"><a href="#6-4）MyCat核心概念" class="headerlink" title="6.4）MyCat核心概念"></a>6.4）MyCat核心概念</h2><p>​    在学习Mycat首先需要先对其内部一些核心概念有足够的了解。</p>
<ul>
<li><strong>逻辑库</strong>：Mycat中的虚拟数据库。对应实际数据库的概念。在没有使用mycat时，应用需要确定当前连接的数据库等信息，那么当使用mycat后，也需要先虚拟一个数据库，用于应用的连接。</li>
<li><strong>逻辑表</strong>：mycat中的虚拟数据表。对应时间数据库中数据表的概念。</li>
<li><strong>非分片表</strong>：没有进行数据切分的表。</li>
<li><strong>分片表</strong>：已经被数据拆分的表，每个分片表中都有原有数据表的一部分数据。多张分片表可以构成一个完整数据表。</li>
<li><strong>ER表</strong>：子表的记录与所关联的父表记录存放在同一个数据分片上，即子表依赖于父表，通过表分组（Table Group）保证数据Join不会跨库操作。表分组（Table Group）是解决跨分片数据join的一种很好的思路，也是数据切分规划的重要一条规则</li>
<li><strong>全局表</strong>：可以理解为是一张数据冗余表，如状态表，每一个数据分片节点又保存了一份状态表数据。数据冗余是解决跨分片数据join的一种很好的思路，也是数据切分规划的另外一条重要规则。</li>
<li><strong>分片节点（dataNode）</strong>：数据切分后，每一个数据分片表所在的数据库就是分片节点。</li>
<li><strong>节点主机（dataHost）</strong>：数据切分后，每个分片节点（dataNode）不一定都会独占一台机器，同一机器上面可以有多个分片数据库，这样一个或多个分片节点（dataNode）所在的机器就是节点主机（dataHost）,为了规避单节点主机并发数限制，尽量将读写压力高的分片节点（dataNode）均衡的放在不同的节点主机（dataHost）。</li>
<li><strong>分片规则（rule）</strong>：按照某种业务规则把数据分到某个分片的规则就是分片规则。</li>
<li><strong>全局序列号（sequence）</strong>：也可以理解为分布式id。数据切分后，原有的关系数据库中的主键约束在分布式条件下将无法使用，因此需要引入外部机制保证数据唯一性标识，这种保证全局性的数据唯一标识的机制就是全局序列号（sequence），如UUID、雪花算法等。</li>
</ul>
<h1 id="7）Mycat企业级应用实践"><a href="#7）Mycat企业级应用实践" class="headerlink" title="7）Mycat企业级应用实践"></a>7）Mycat企业级应用实践</h1><h2 id="7-1）环境参数配置"><a href="#7-1）环境参数配置" class="headerlink" title="7.1）环境参数配置"></a>7.1）环境参数配置</h2><p>​    在server.xml 文件中的system标签下配置所有的参数，全部为环境参数，可以根据当前需要进行开启和配置，如：设置mycat连接端口号</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;serverPort&quot;</span>&gt;</span>8066<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183952.png" alt="image-20200603010530819"></p>
<h2 id="7-2）数据非分片"><a href="#7-2）数据非分片" class="headerlink" title="7.2）数据非分片"></a>7.2）数据非分片</h2><h3 id="7-2-1）配置初始化信息"><a href="#7-2-1）配置初始化信息" class="headerlink" title="7.2.1）配置初始化信息"></a>7.2.1）配置初始化信息</h3><p>​    应用连接mycat的话，也需要设置用户名、密码、被连接数据库信息，要配置这些信息的话，可以修改server.xml，在其内部添加内容如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置自定义用户信息--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--连接用户名--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;mycat&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--连接密码--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>mycat<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--创建虚拟数据库--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>userdb<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--指定该库是否只读--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;property name=&quot;readOnly&quot;&gt;true&lt;/property&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-2）配置虚拟数据库-amp-表"><a href="#7-2-2）配置虚拟数据库-amp-表" class="headerlink" title="7.2.2）配置虚拟数据库&amp;表"></a>7.2.2）配置虚拟数据库&amp;表</h3><p>当配置了一个虚拟数据库后，还需要修改schema.xml，对虚拟库进行详细配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mycat</span>:schema <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!--配置虚拟数据库--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--name：虚拟逻辑数据库名称，对应server.xml中的schemas属性值--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--dataNode：逻辑库中逻辑表的默认数据节点--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--sqlMaxLimit：类似于SQL上添加limit，如schema为非分片库，则该属性无效--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;userdb&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;localdn&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;500&quot;</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--配置虚拟逻辑表--&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--name：逻辑表名称，必须唯一--&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--dataNode：逻辑表所处的数据节点，值必须与dataNode标签中的name属性对应。如果值过多可以用$连接，如：dn$1-99,dn$200-400--&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--primaryKey：逻辑表对应的真实表的主键id的字段名--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;localdn&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;user_id&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!--配置dataNode信息--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--name：当前datanode名称--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--dataHost：分片节点所处的节点主机，该值必须与dataHost标签中的name属性对应--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--database：当前数据节点所对应的实际物理数据库--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;localdn&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;localdh&quot;</span> <span class="attr">database</span>=<span class="string">&quot;user&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!--配置节点主机--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--balance：用于进行读操作指向，有三个值可选</span></span><br><span class="line"><span class="comment">		0：所有读操作都发送到当前可用的writeHost上</span></span><br><span class="line"><span class="comment">		1：所有读操作都随机的发送到readHost上</span></span><br><span class="line"><span class="comment">		2：所有读操作都随机发送在writeHost与readHost上</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--maxCon：指定每个读写实例连接池的最大连接。也就是说，标签内嵌套的writeHost、readHost标签都会使用这个属性的值来实例化出连接池的最大连接数--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--minCon：指定每个读写实例连接池的最小连接，初始化连接池的大小--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--name：当前节点主机名称，不允许出现重复--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--dbType：当时使用的数据库类型--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--dbDriver：当前使用的数据库驱动--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--writeType：用于写操作指向，有三个值可选</span></span><br><span class="line"><span class="comment">		0：所有写操作都发送到可用的writeHost上</span></span><br><span class="line"><span class="comment">		1：所有写操作都随机发送到readHost上</span></span><br><span class="line"><span class="comment">		2：所有写操作都随机发送在writeHost与readHost上</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--readHost是从属于writeHost的，即意味着它从那个writeHost获取同步数据。</span></span><br><span class="line"><span class="comment">		因此，当它所属的writeHost宕机了，则它也不会再参与到读写分离中来，即“不工作了”。这是因为此时，它的数据已经“不可靠”了。</span></span><br><span class="line"><span class="comment">		基于这个考虑，目前mycat 1.3和1.4版本中，若想支持MySQL一主一从的标准配置，并且在主节点宕机的情况下，从节点还能读取数据。</span></span><br><span class="line"><span class="comment">		则需要在Mycat里配置为两个writeHost并设置banlance=1。”--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--switchType：设置节点切换操作，有三个值可选</span></span><br><span class="line"><span class="comment">		-1：不自动切换</span></span><br><span class="line"><span class="comment">		1：自动切换，默认值</span></span><br><span class="line"><span class="comment">		2：基于mysql主从同步的状态决定是否切换</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--slaveThreshold：主从同步状态决定是否切换，延迟超过该值就不切换--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;100&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">name</span>=<span class="string">&quot;localdh&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">slaveThreshold</span>=<span class="string">&quot;1000&quot;</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--查询心跳--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--配置写节点实际物理数据库信息--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://localhost:3306&quot;</span> <span class="attr">host</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-3）测试"><a href="#7-2-3）测试" class="headerlink" title="7.2.3）测试"></a>7.2.3）测试</h3><p>​    通过navicat创建本地数据库连接并创建对应数据库，同时创建mycat连接。 在mycat连接中操作表，添加数据，可以发现，本地数据库中同步的也新增了对应的数据。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183953.png" alt="image-20200603020230476"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183954.png" alt="image-20200603020257486"></p>
<h2 id="7-3）根据ID取模数据分片"><a href="#7-3）根据ID取模数据分片" class="headerlink" title="7.3）根据ID取模数据分片"></a>7.3）根据ID取模数据分片</h2><p>​    当一个数据表中的数据量非常大时，就需要考虑对表内数据进行分片，拆分的规则有很多种，比较简单的一种就是，通过对id进行取模，完成数据分片。</p>
<p>1）修改schema.xml</p>
<p>​    table标签新增属性：subTables、rule</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mycat</span>:schema <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!--配置虚拟数据库--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--name：虚拟逻辑数据库名称，对应server.xml中的schemas属性值--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--dataNode：逻辑库中逻辑表的默认数据节点--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--sqlMaxLimit：类似于SQL上添加limit，如schema为非分片库，则该属性无效--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;userdb&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;localdn&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;500&quot;</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--配置虚拟逻辑表--&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--name：逻辑表名称，必须唯一--&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--dataNode：逻辑表所处的数据节点，值必须与dataNode标签中的name属性对应。如果值过多可以用$连接，如：dn$1-99,dn$200-400--&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--primaryKey：逻辑表对应的真实表的主键id的字段名--&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--subTables：分表的名称。可以存在多个，tb_user1,tb_user2,tb_user3.如果分表较多，可以通过$连接：tb_user$1-3--&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--rule：分片规则，对应rule.xml中配置--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;localdn&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">subTables</span>=<span class="string">&quot;tb_user$1-3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;mod-long&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!--配置dataNode信息--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--name：当前datanode名称--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--dataHost：分片节点所处的节点主机，该值必须与dataHost标签中的name属性对应--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--database：当前数据节点所对应的实际物理数据库--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;localdn&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;localdh&quot;</span> <span class="attr">database</span>=<span class="string">&quot;user&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!--配置节点主机--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--balance：用于进行读操作指向，有三个值可选</span></span><br><span class="line"><span class="comment">		0：所有读操作都发送到当前可用的writeHost上</span></span><br><span class="line"><span class="comment">		1：所有读操作都随机的发送到readHost上</span></span><br><span class="line"><span class="comment">		2：所有读操作都随机发送在writeHost与readHost上</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--maxCon：指定每个读写实例连接池的最大连接。也就是说，标签内嵌套的writeHost、readHost标签都会使用这个属性的值来实例化出连接池的最大连接数--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--minCon：指定每个读写实例连接池的最小连接，初始化连接池的大小--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--name：当前节点主机名称，不允许出现重复--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--dbType：当时使用的数据库类型--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--dbDriver：当前使用的数据库驱动--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--writeType：用于写操作指向，有三个值可选</span></span><br><span class="line"><span class="comment">		0：所有写操作都发送到可用的writeHost上</span></span><br><span class="line"><span class="comment">		1：所有写操作都随机发送到readHost上</span></span><br><span class="line"><span class="comment">		2：所有写操作都随机发送在writeHost与readHost上</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--readHost是从属于writeHost的，即意味着它从那个writeHost获取同步数据。</span></span><br><span class="line"><span class="comment">		因此，当它所属的writeHost宕机了，则它也不会再参与到读写分离中来，即“不工作了”。这是因为此时，它的数据已经“不可靠”了。</span></span><br><span class="line"><span class="comment">		基于这个考虑，目前mycat 1.3和1.4版本中，若想支持MySQL一主一从的标准配置，并且在主节点宕机的情况下，从节点还能读取数据。</span></span><br><span class="line"><span class="comment">		则需要在Mycat里配置为两个writeHost并设置banlance=1。”--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--switchType：设置节点切换操作，有三个值可选</span></span><br><span class="line"><span class="comment">		-1：不自动切换</span></span><br><span class="line"><span class="comment">		1：自动切换，默认值</span></span><br><span class="line"><span class="comment">		2：基于mysql主从同步的状态决定是否切换</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--slaveThreshold：主从同步状态决定是否切换，延迟超过该值就不切换--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;100&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">name</span>=<span class="string">&quot;localdh&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">slaveThreshold</span>=<span class="string">&quot;1000&quot;</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--查询心跳--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--配置写节点实际物理数据库信息--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://localhost:3306&quot;</span> <span class="attr">host</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）修改rule.xml</p>
<p>​    在schema.xml中已经指定规则为mod-long。因此需要到该文件中修改对应信息。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--当用用于id取模的字段--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>mod-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--修改当前的分片数量--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- how many data nodes --&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 根据datanode数量进行取模分片，也就是要模几。 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3）测试</p>
<p>1）向数据库中插入一千条数据，可以发现，其会根据id取模，放入不同的三张表中。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183955.png" alt="image-20200604003934504"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183956.png" alt="image-20200604003948529"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183957.png" alt="image-20200604004000971"></p>
<p>2）当根据id查询时，会通过对id的取模，确定当前要查询的分片。并且首先会先查询mycat中的ehcache缓存，再来查询数据分片</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183958.png" alt="image-20200604004554041"></p>
<p>3）当查询所有数据时，会查询所有数据分片。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209183959.png" alt="image-20200604004806962"></p>
<p>4）缺陷</p>
<p>​    通过id取模分片这种方式实际中应用较少。主要因为两点问题：</p>
<p>根据id取模，1）散列不均匀，出现数据倾斜。2）动态扩容时，存在rehash，出现数据丢失。</p>
<p>1）数据散列不均匀，容易出现数据倾斜。每张表中的数据量差距较大。</p>
<p>2）动态扩容后，当需要新增表时，需要对模数修改，有可能就会造成当查询某个分片时，在该分片中找不到对应数据。</p>
<p>3）动态扩容后，要进行rehash操作。</p>
<h2 id="7-4）全局序列号"><a href="#7-4）全局序列号" class="headerlink" title="7.4）全局序列号"></a>7.4）全局序列号</h2><p>​    当进行数据切分后，数据会存放在多张表中，如果仍然通过数据库自增id的方式，就会出现ID重复的问题，造成数据错乱。所以当拆分完数据后，需要让每一条数据都有自己的ID，并且在多表中不能出现重复。比较常见的会使用雪花算法来生成分布式id。</p>
<p>​    在Mycat中也提供了四种方式来进行分布式id生成：基于文件、基于数据库、基于时间戳和基于ZK。</p>
<h3 id="7-4-1）基于本地文件方式生成"><a href="#7-4-1）基于本地文件方式生成" class="headerlink" title="7.4.1）基于本地文件方式生成"></a>7.4.1）基于本地文件方式生成</h3><p>优点：本地加载，读取速度较快。</p>
<p>缺点：当MyCAT重新发布后，配置文件中的sequence会恢复到初始值。</p>
<p>​            生成的id没有含义，如时间。</p>
<p>​            MyCat如果存在多个，会出现id重复问题。</p>
<p>​    1）修改<strong>sequence_conf.properties</strong></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">USER.HISIDS</span>=  <span class="string">#使用过的历史分段，可不配置</span></span><br><span class="line"><span class="meta">USER.MINID</span>=<span class="string">1  #最小ID值</span></span><br><span class="line"><span class="meta">USER.MAXID</span>=<span class="string">200000  #最大ID值</span></span><br><span class="line"><span class="meta">USER.CURID</span>=<span class="string">1000  #当前ID值</span></span><br></pre></td></tr></table></figure>

<p>​    2）修改<strong>server.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--设置全局序号生成方式</span></span><br><span class="line"><span class="comment">   0：文件</span></span><br><span class="line"><span class="comment">   1：数据库</span></span><br><span class="line"><span class="comment">   2：时间戳</span></span><br><span class="line"><span class="comment">   3：zookeeper</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerType&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--进入序列匹配流程, 必须带有MYCATSEQ_或者 mycatseq_--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerPattern&quot;</span>&gt;</span>(?:(\s*next\s+value\s+for\s*MYCATSEQ_(\w+))(,|\)|\s)*)+<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequenceHanlderClass&quot;</span>&gt;</span>io.mycat.route.sequence.handler.HttpIncrSequenceHandler<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    3）测试</p>
<p>重启mycat，并查询是否修改成功</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> @<span class="variable">@sysparam</span></span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184000.png" alt="image-20200605183431528"></p>
<p>通过navicat插入数据</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(user_id,user_name) <span class="keyword">values</span>(<span class="string">&#x27;next value for MYCATSEQ_USER&#x27;</span>,<span class="string">&#x27;wangwu&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>通过程序插入数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Insert(&quot;insert into tb_user(user_id,user_name) values(&#x27;next value for MYCATSEQ_USER&#x27;,#&#123;userName&#125;)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addUser</span><span class="params">(User user)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-4-2）基于数据库生成"><a href="#7-4-2）基于数据库生成" class="headerlink" title="7.4.2）基于数据库生成"></a>7.4.2）基于数据库生成</h3><p>​    优点：能够进行id批量生成，在分布式下，可以避免id重复问题。</p>
<p>​    缺点：ID没有意义，对数据库有压力。</p>
<p>1）<strong>在实际数据库执行dbseq.sql中的sql语句</strong>，执行完毕后，会创建一张表。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184001.png" alt="image-20200605191200321"></p>
<p>2）<strong>修改sequence_db_conf.properties</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TB_USER=localdn</span><br></pre></td></tr></table></figure>

<p>3）<strong>修改server.xml文件</strong>，修改全局序列号生成方式为数据库方式</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerType&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>4）修改schema.xml。在table中添加自增属性</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;localdn&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">subTables</span>=<span class="string">&quot;tb_user$1-3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;mod-long&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>5）测试</p>
<p>通过navicat新增记录</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(user_id,user_name) <span class="keyword">values</span>(<span class="string">&#x27;next value for MYCATSEQ_TB_USER&#x27;</span>,<span class="string">&#x27;wangwu&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184002.png" alt="image-20200605194130010"></p>
<h3 id="7-4-3）基于zookeeper生成"><a href="#7-4-3）基于zookeeper生成" class="headerlink" title="7.4.3）基于zookeeper生成"></a>7.4.3）基于zookeeper生成</h3><p>1）修改<strong>server.xml</strong>，更改生成模式</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequenceHandlerType&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）修改<strong>myid.properties</strong>，配置zk连接信息</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">loadZk</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">zkURL</span>=<span class="string">192.168.200.131:2181</span></span><br><span class="line"><span class="attr">clusterId</span>=<span class="string">01</span></span><br><span class="line"><span class="attr">myid</span>=<span class="string">mycat_fz_01</span></span><br><span class="line"><span class="attr">clusterNodes</span>=<span class="string">mycat_fz_01</span></span><br><span class="line"><span class="comment">#server  booster  ;   booster install on db same server,will reset all minCon to 1</span></span><br><span class="line"><span class="comment">#type=server</span></span><br><span class="line"><span class="comment">#boosterDataHosts=localhost1</span></span><br></pre></td></tr></table></figure>

<p>3）修改<strong>sequence_distributed_conf.properties</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INSTANCEID=ZK #声明使用zk生成</span><br><span class="line">CLUSTERID=01</span><br></pre></td></tr></table></figure>

<p>4）测试</p>
<p>启动mycatServer后，通过zk客户端查看节点信息。会发现新增了一个mycat节点</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./zkCli.sh</span><br><span class="line"></span><br><span class="line">ls /</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184003.png" alt="image-20200609225750661"></p>
<p>插入数据</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(user_id,user_name) <span class="keyword">values</span>(<span class="string">&#x27;next value for MYCATSEQ_TB_USER12&#x27;</span>,<span class="string">&#x27;heima&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>next value for MYCATSEQ_  后的内容可以随意指定。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184004.png" alt="image-20200609233738919"></p>
<p>5）特性：</p>
<p>ID 结构：<strong>long 64 位</strong>，ID 最大可占 63 位</p>
<p>* |current time millis(微秒时间戳 38 位,可以使用 17 年)|clusterId（机房或者 ZKid，通过配置文件配置 5位）|instanceId（实例 ID，可以通过 ZK 或者配置文件获取，5 位）|threadId（线程 ID，9 位）|increment(自增,6 位)</p>
<p>* 一共 63 位，可以承受单机房单机器单线程 1000*(2^6)=640000 的并发。</p>
<p>* 无悲观锁，无强竞争，吞吐量更高</p>
<h3 id="7-4-4）基于时间戳生成"><a href="#7-4-4）基于时间戳生成" class="headerlink" title="7.4.4）基于时间戳生成"></a>7.4.4）基于时间戳生成</h3><p>优点：不存在上面两种方案因为mycat的重启导致id重复的现象</p>
<p>​    ID= 64 位二进制 (42(毫秒)+5(机器 ID)+5(业务编码)+12(重复累加)，每毫秒可以并发 12 位二进制的累加。</p>
<p>缺点：数据类型太长，建议采用bigint(最大取值18446744073709551615)</p>
<p>1）修改<strong>server.xml</strong>。更改生成方式</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequenceHandlerType&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）修改<strong>sequence_time_conf.properties</strong></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#sequence depend on TIME</span></span><br><span class="line"><span class="comment">#WORKID与DATAACENTERID: 0-31 任意整数。多mycat节点下，每个节点的WORKID、DATAACENTERID不能重复，组成唯一标识，总共支持32*32=1024 种组合</span></span><br><span class="line"><span class="attr">WORKID</span>=<span class="string">01</span></span><br><span class="line"><span class="attr">DATAACENTERID</span>=<span class="string">01</span></span><br></pre></td></tr></table></figure>

<p>3）测试</p>
<p>新增数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">insert into tb_user(user_id,user_name) values(&#x27;next value for MYCATSEQ_TB_USER12&#x27;,&#x27;heima&#x27;)</span><br></pre></td></tr></table></figure>

<p>next value for MYCATSEQ_  后的内容可以随意指定。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184005.png" alt="image-20200609234814418"></p>
<h2 id="7-5）Mycat分库-amp-读写分离"><a href="#7-5）Mycat分库-amp-读写分离" class="headerlink" title="7.5）Mycat分库&amp;读写分离"></a>7.5）Mycat分库&amp;读写分离</h2><p>​    之前已经基于id取模完成了分表操作，但是一个数据库的容量毕竟是有限制的，如果数据量非常大，分表已经满足不了的话，就会进行分库操作。</p>
<p>​    当前分库架构如下：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184006.png" alt="image-20200612002109456"></p>
<p>​    现在存在两个主库，并且各自都有从节点。 当插入数据时，根据id取模放入不同的库中。同时主从间在进行写时复制的同时，还要完成主从读写分离的配置。</p>
<p>1）修改schema.xml。配置多datenode与datahost。同时配置主从读写分离。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mycat</span>:schema <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;userdb&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn09&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;500&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn09,dn10&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;mod-long&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn09&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dh09&quot;</span> <span class="attr">database</span>=<span class="string">&quot;user&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn10&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dh10&quot;</span> <span class="attr">database</span>=<span class="string">&quot;user&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dh09&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;100&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span>  <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">slaveThreshold</span>=<span class="string">&quot;1000&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--查询心跳--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--配置写节点实际物理数据库信息--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.142:3309&quot;</span> <span class="attr">host</span>=<span class="string">&quot;host1&quot;</span>  <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--配置读节点实际物理数据库信息--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;host2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.145:3309&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">readHost</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dh10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;100&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span>  <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">slaveThreshold</span>=<span class="string">&quot;1000&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--查询心跳--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--配置写节点实际物理数据库信息--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.142:3310&quot;</span> <span class="attr">host</span>=<span class="string">&quot;host1&quot;</span>  <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--配置读节点实际物理数据库信息--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;host2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.145:3310&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">readHost</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）修改rule.xml。配置取模时的模数</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- how many data nodes --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 根据datanode数量进行取模分片，也就是要模几。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3）进行批量数据添加，可以发现数据落在了不同的库中。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184007.png" alt="image-20200612005132092"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184008.png" alt="image-20200612005159630"></p>
<p>4）读写分离验证</p>
<p>​    设置log4j2.xml的日志级别为DEBUG</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">status</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">		........</span><br><span class="line">        <span class="tag">&lt;<span class="name">asyncRoot</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span> <span class="attr">includeLocation</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">			........</span><br><span class="line">        <span class="tag">&lt;/<span class="name">asyncRoot</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    基于mysql服务进行数据查看，观察控制台信息，可以看到对于read请求的数据源，分别使用的是配置文件的配置</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184009.png" alt="image-20200621213109545"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184010.png" alt="image-20200621213153827"></p>
<h2 id="7-6）MyCat分片规则"><a href="#7-6）MyCat分片规则" class="headerlink" title="7.6）MyCat分片规则"></a>7.6）MyCat分片规则</h2><h3 id="7-6-1）枚举分片"><a href="#7-6-1）枚举分片" class="headerlink" title="7.6.1）枚举分片"></a>7.6.1）枚举分片</h3><h4 id="7-6-1-1）实现"><a href="#7-6-1-1）实现" class="headerlink" title="7.6.1.1）实现"></a>7.6.1.1）实现</h4><p>​    适用于在特定业务场景下，将不同的数据存放于不同的数据库中，如按省份、按人员信息等。</p>
<p>1）修改<strong>schema.xml</strong>，修改<strong>table</strong>标签中<strong>name</strong>属性为当前操作的表名，<strong>rule</strong>属性为<strong>sharding-by-intfile</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user_sharding_by_intfile&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn142,dn145&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-intfile&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）修改<strong>rule.xml</strong>，配置<strong>tableRule</strong>为<strong>sharding-by-intfile</strong>中<strong>columns</strong>属性为当前指定分片字段</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-intfile&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>sex<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>hash-int<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3）修改<strong>rule.xml</strong>中<strong>hash-int</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;hash-int&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByFileMap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-hash-int.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--type默认值为0，0表示Integer，非零表示String--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--defaultNode 当有一些特殊数据信息可以存放于默认节点中，如即不是male也不是female。默认节点：小于0表示不设置默认节点，大于等于0表示设置默认节点,不能解析的枚举就存到默认节点--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultNode&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>4）修改<strong>partition-hash-int.txt</strong>。指定分片字段不同值存在于不同的数据库节点</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">male=0 #代表第一个datanode</span><br><span class="line">female=1 #代表第二个datanode</span><br></pre></td></tr></table></figure>

<p>5）执行测试</p>
<p>​    修改mapper</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Insert(&quot;insert into tb_user_sharding_by_intfile(user_id,user_name,sex) values(&#x27;next value for MYCATSEQ_TB_USER12&#x27;,#&#123;userName&#125;,#&#123;sex&#125;)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addUserShareBySex</span><span class="params">(User user)</span></span>;</span><br></pre></td></tr></table></figure>

<p>​    执行测试，此时可以发现，当sex为male时，数据会进入142节点，当sex为female时，数据会进入145节点。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184011.png" alt="image-20200613004923752"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184012.png" alt="image-20200613004947984">6.8.1.2）</p>
<h4 id="7-6-1-2）问题"><a href="#7-6-1-2）问题" class="headerlink" title="7.6.1.2）问题"></a>7.6.1.2）问题</h4><p>​    该方案适用于特定业务场景进行数据分片，但该方式容易出现数据倾斜，如不同省份的订单量一定会不同。订单量大的省份还会进行数据分库，数据库架构就会继续发生对应改变。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184013.png" alt="image-20200613005457354"></p>
<h3 id="7-6-2）固定hash分片"><a href="#7-6-2）固定hash分片" class="headerlink" title="7.6.2）固定hash分片"></a>7.6.2）固定hash分片</h3><p>​    固定hash分片的工作原理类似与redis cluster槽的概念，在固定hash中会有一个范围是0-1024，内部会进行二进制运算操作，如取 id 的二进制低 10 位 与 1111111111 进行 &amp; 运算。从而当出现连接数据插入，其有可能会进入到同一个分片中，减少了分布式事务操作，提升插入效率同时尽量减少了数据倾斜问题，但不能避免不出现数据倾斜。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184014.png" alt="image-20200613210301026"></p>
<p>​    按照上面这张图就存在两个分区，partition1和partition2。partition1的范围是0-255，partition2的范围是256-1024。</p>
<p>​    当向分区中存数据时，先将id值转换为二进制，接着&amp;1111111111，再对结果值转换为十进制，从而确定当前数据应该存入哪个分区中。</p>
<ul>
<li><p>1023的二进制&amp;1111111111运算后为1023，故落入第二个分区 </p>
</li>
<li><p>1024的二进制&amp;1111111111运算后为0，故落入第一个分区</p>
</li>
<li><p>266 的二进制&amp;1111111111运算后为266，故落入第二个分区内</p>
</li>
</ul>
<h4 id="7-6-2-1）实现"><a href="#7-6-2-1）实现" class="headerlink" title="7.6.2.1）实现"></a>7.6.2.1）实现</h4><p>1）修改<strong>schema.xml</strong>，配置自定义固定hash分配规则</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user_fixed_hash&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn142,dn145&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;partition-by-fixed-hash&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）修改<strong>rule.xml</strong>，配置自定义固定hash分片规则</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;partition-by-fixed-hash&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>partition-by-fixed-hash<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  partitionCount: 存在多少个节点，如1,1    1,1,1    1,2</span></span><br><span class="line"><span class="comment">  partitionLength: 每个节点分配的范围大小</span></span><br><span class="line"><span class="comment"> --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;partition-by-fixed-hash&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByLong&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionCount&quot;</span>&gt;</span>1,1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionLength&quot;</span>&gt;</span>256,768<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3）测试，添加数据，可以发现数据会根据计算，落入相应的数据库节点。</p>
<h3 id="7-6-3）固定范围分片"><a href="#7-6-3）固定范围分片" class="headerlink" title="7.6.3）固定范围分片"></a>7.6.3）固定范围分片</h3><p>​    该规则有点像枚举与固定hash的综合体，设置某一个字段，然后规定该字段值的不同范围值会进入到哪一个dataNode。适用于明确知道分片字段的某个范围属于某个分片</p>
<p>优点：适用于想明确知道某个分片字段的某个范围具体在哪一个节点； </p>
<p>缺点：如果短时间内有大量的批量插入操作，那么某个分片节点可能一下子会承受比较大的数据库压力，而别的分片节点此时可能处于闲置状态，无法利用其它节点进行分担压力（热点数据问题);</p>
<p>1）修改<strong>schema.xml</strong>。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user_range&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn142,dn145&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;auto-sharding-long&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）修改<strong>rule.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;auto-sharding-long&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>age<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3）修改<strong>autopartition-long.txt</strong>，定义自定义范围</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#用于定义dataNode对应的数据范围，如果配置多了会报错。</span><br><span class="line"># range start-end ,data node index</span><br><span class="line"># K=1000,M=10000.</span><br><span class="line">#0-500M=0</span><br><span class="line">#500M-1000M=1</span><br><span class="line">#1000M-1500M=2</span><br><span class="line"></span><br><span class="line">#所有的节点配置都是从0开始，0代表节点1</span><br><span class="line">0-20=0</span><br><span class="line">21-50=1</span><br></pre></td></tr></table></figure>

<p>4）测试，添加用户信息，年龄分别为9和33，可以看到，数据落入到对应的数据节点</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184015.png" alt="image-20200613220321220"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184016.png" alt="image-20200613220333523"></p>
<h3 id="7-6-4）取模范围分片"><a href="#7-6-4）取模范围分片" class="headerlink" title="7.6.4）取模范围分片"></a>7.6.4）取模范围分片</h3><p>​    这种方式结合了范围分片和取模分片，主要是为后续的数据迁移做准备。</p>
<p>​    优点：可以自主决定取模后数据的节点分布。</p>
<p>​    缺点：dataNode 划分节点是事先建好的，需要扩展时比较麻烦。</p>
<p>1）修改schema.xml，配置分片规则</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user_mod_range&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn142,dn145&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-partition&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）修改rule.xml，添加分片规则</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-partition&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-partition<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-partition&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByPattern&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--求模基数--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;patternValue&quot;</span>&gt;</span>256<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--默认节点--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultNode&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--指定规则配置文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-pattern.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3）添加partition-pattern.txt，文件内部配置节点中数据范围</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#0-128表示id%256后的数据范围。</span><br><span class="line">0-128=0</span><br><span class="line">129-256=1</span><br></pre></td></tr></table></figure>

<p>4）测试</p>
<p>​    可以发现数据根据id取模并进入到了不同的分片节点中。</p>
<h3 id="7-6-5）字符串hash求模范围分片"><a href="#7-6-5）字符串hash求模范围分片" class="headerlink" title="7.6.5）字符串hash求模范围分片"></a>7.6.5）字符串hash求模范围分片</h3><p>​    在业务场景下，有时可能会根据某个分片字段的前几个值来进行取模。如地址信息只取省份、姓名只取前一个字的姓等。此时则可以使用该种方式。</p>
<p>​    其工作方式与取模范围分片类型，该分片方式支持数值、符号、字母取模。</p>
<p>1）修改schema.xml。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user_string_hash&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn142,dn145&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-string-hash&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）修改rule.xml，定义拆分规则</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-string-hash&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_name<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-string-hash-function<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-string-hash-function&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByPrefixPattern&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--求模基数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;patternValue&quot;</span>&gt;</span>256<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 截取的位数  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefixLength&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-pattern-string-hash.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3）新建partition-pattern-string-hash.txt。指定数据分片节点</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0-128=0</span><br><span class="line">129-256=1</span><br></pre></td></tr></table></figure>

<p>4）运行后可以发现 ，不同的姓名取模后，会进入不同的分片节点。</p>
<h3 id="7-6-6）一致性hash分片"><a href="#7-6-6）一致性hash分片" class="headerlink" title="7.6.6）一致性hash分片"></a>7.6.6）一致性hash分片</h3><p>​    通过一致性hash分片可以最大限度的让数据均匀分布，但是均匀分布也会带来问题，就是分布式事务。</p>
<h4 id="7-6-6-1）原理"><a href="#7-6-6-1）原理" class="headerlink" title="7.6.6.1）原理"></a>7.6.6.1）原理</h4><p>​    一致性hash算法引入了hash环的概念。环的大小是0~2^32-1。首先通过crc16算法计算出数据节点在hash环中的位置。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184017.png" alt="image-20200614115947722"></p>
<p>​    当存储数据时，也会采用同样的算法，计算出数据key的hash值，映射到hash环上。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184018.png" alt="image-20200614120302675"></p>
<p>​    然后从数据映射的位置开始，以顺时针的方式找出距离最近的数据节点，接着将数据存入到该节点中。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184019.png" alt="image-20200614121047323"></p>
<p>​    此时可以发现，数据并没有达到预期的数据均匀，可以发现如果两个数据节点在环上的距离，决定有大量数据存入了dataNode2，而仅有少量数据存入dataNode1。</p>
<p>​    为了解决数据不均匀的问题，在mycat中可以设置<strong>虚拟数据映射节点</strong>。同时这些虚拟节点会映射到实际数据节点。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184020.png" alt="image-20200614121729209"></p>
<p>​    数据仍然以顺时针方式寻找数据节点，当找到最近的数据节点无论是实际还是虚拟，都会进行存储，如果是虚拟数据节点的话，最终会将数据保存到实际数据节点中。 从而尽量的使数据均匀分布。</p>
<h4 id="7-6-6-2）实现"><a href="#7-6-6-2）实现" class="headerlink" title="7.6.6.2）实现"></a>7.6.6.2）实现</h4><p>1）修改schema.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user_murmur&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn142,dn145&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-murmur&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）修改rule.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-murmur&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>murmur<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;murmur&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMurmurHash&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;seed&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="comment">&lt;!-- 默认是0 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="comment">&lt;!-- 要分片的数据库节点数量，必须指定，否则没法分片 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;virtualBucketTimes&quot;</span>&gt;</span>160<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="comment">&lt;!-- 一个实际的数据库节点被映射为这么多虚拟节点，默认是160倍，也就是虚拟节点数是物理节点数的160倍 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;property name=&quot;weightMapFile&quot;&gt;weightMapFile&lt;/property&gt; 节点的权重，没有指定权重的节点默认是1。以properties文件的格式填写，以从0开始到count-1的整数值也就是节点索引为key，以节点权重值为值。所有权重值必须是正整数，否则以1代替 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;property name=&quot;bucketMapPath&quot;&gt;/etc/mycat/bucketMapPath&lt;/property&gt;</span></span><br><span class="line"><span class="comment">   用于测试时观察各物理节点与虚拟节点的分布情况，如果指定了这个属性，会把虚拟节点的murmur hash值与物理节点的映射按行输出到这个文件，没有默认值，如果不指定，就不会输出任何东西 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3）测试</p>
<p>​    循环插入一千条数据，可以数据会尽量均匀的分布在142和145两个节点中。</p>
<h3 id="7-6-7）时间分片"><a href="#7-6-7）时间分片" class="headerlink" title="7.6.7）时间分片"></a>7.6.7）时间分片</h3><h4 id="7-6-7-1）按天分片"><a href="#7-6-7-1）按天分片" class="headerlink" title="7.6.7.1）按天分片"></a>7.6.7.1）按天分片</h4><p>​    当数据量非常大时，有时会考虑，按天去分库分表。这种场景是非常常见的。同时也有利于后期的数据查询。</p>
<p>1）修改schema.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user_day&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn142,dn145&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-date&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）修改rule.xml，每十天一个分片，从起始时间开始计算，分片不够，则报错。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-date&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>create_time<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>partbyday<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;partbyday&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByDate&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--日期格式--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dateFormat&quot;</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sNaturalDay&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--从哪天开始,并且只能插入2020年的数据，2021的无法插入--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sBeginDate&quot;</span>&gt;</span>2020-01-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--每隔几天一个分片--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sPartionDay&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3）测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUserDay</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setUserName(<span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">    user.setCreateTime(<span class="string">&quot;2020-01-31&quot;</span>);</span><br><span class="line">    userMapper.addUserDay(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当时间为1月1-10号之间，会进入142节点。当时间为11-20号之间，会进入145节点，当超出则报错。</p>
<h4 id="7-6-7-2）按月分片"><a href="#7-6-7-2）按月分片" class="headerlink" title="7.6.7.2）按月分片"></a>7.6.7.2）按月分片</h4><p>​    按月进行数据分片，每月一个分片</p>
<p>1）修改schema.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user_month&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn142,dn145&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-month&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）修改rule.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-month&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>create_time<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-month-function<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-month-function&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMonth&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dateFormat&quot;</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sBeginDate&quot;</span>&gt;</span>2020-05-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3）测试</p>
<p>​    可以发现当为五月会进入到节点1中，当为六月会进入到节点2中。当为七月则报错，因为需要每月一个分片，当前测试只有两个分片。</p>
<h2 id="7-7）跨库join"><a href="#7-7）跨库join" class="headerlink" title="7.7）跨库join"></a>7.7）跨库join</h2><h3 id="7-7-1）全局表"><a href="#7-7-1）全局表" class="headerlink" title="7.7.1）全局表"></a>7.7.1）全局表</h3><h4 id="7-7-1-1）简介"><a href="#7-7-1-1）简介" class="headerlink" title="7.7.1.1）简介"></a>7.7.1.1）简介</h4><p>​    系统中基本都会存在数据字典信息，如数据分类信息、项目的配置信息等。这些字典数据最大的特点就是数据量不大并且很少会被改变。同时绝大多数的业务场景都会涉及到字典表的操作。 因此为了避免频繁的跨库join操作，结合冗余数据思想，可以考虑把这些字典信息在每一个分库中都存在一份。</p>
<p>​    mycat在进行join操作时，当业务表与全局表进行聚合会优先选择相同分片的全局表，从而避免跨库join操作。在进行数据插入时，会把数据同时插入到所有分片的全局表中。</p>
<h4 id="7-7-1-2）实现"><a href="#7-7-1-2）实现" class="headerlink" title="7.7.1.2）实现"></a>7.7.1.2）实现</h4><p>1）修改<strong>schema.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_global&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn142,dn145&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;global_id&quot;</span> <span class="attr">type</span>=<span class="string">&quot;global&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）测试，可以发现会同时向两张表中插入数据</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184021.png" alt="image-20200614172334771"></p>
<h3 id="7-7-2）ER表"><a href="#7-7-2）ER表" class="headerlink" title="7.7.2）ER表"></a>7.7.2）ER表</h3><h4 id="7-7-2-1）介绍"><a href="#7-7-2-1）介绍" class="headerlink" title="7.7.2.1）介绍"></a>7.7.2.1）介绍</h4><p>ER表也是一种为了避免跨库join的手段，在业务开发时，经常会使用到主从表关系的查询，如商品表与商品详情表。<img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184022.png" alt="image-20200614180130992"></p>
<p>​    根据上图就是一个简单的表关系，但是现在有可能出现一个问题：<strong>goods_detail中goods_id为1，2这两条数据有可能存在于142中</strong>。这样就造成了跨库join的问题的。并且在不使用ER表的情况下，还有可能出现数据丢失的问题。</p>
<p>​    ER表的出现就是为了让有关系的表数据存储于同一个分片中，从而避免跨库join的出现。</p>
<h4 id="7-7-2-2）不使用ER表问题演示"><a href="#7-7-2-2）不使用ER表问题演示" class="headerlink" title="7.7.2.2）不使用ER表问题演示"></a>7.7.2.2）不使用ER表问题演示</h4><p>1）修改schema.xml，配置商品与商品详情表信息</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_goods&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn142,dn145&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;goods_id&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-murmur-goods&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_goods_detail&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn142,dn145&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;goods_detail_id&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-murmur-goods-detail&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）修改rule.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-murmur-goods&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>goods_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>murmur<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-murmur-goods-detail&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>goods_detail_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>murmur<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3）插入数据，<strong>不要使用自动生成id。</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IdWorker idWorker;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addGoodsInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">1000</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">        Goods goods = <span class="keyword">new</span> Goods();</span><br><span class="line">        <span class="keyword">long</span> goodsId = idWorker.nextId();</span><br><span class="line">        goods.setGoodsId(goodsId);</span><br><span class="line">        goods.setGoodsName(<span class="string">&quot;heima&quot;</span>+i);</span><br><span class="line">        goodsMapper.addGoods(goods);</span><br><span class="line"></span><br><span class="line">        GoodsDetail goodsDetail = <span class="keyword">new</span> GoodsDetail();</span><br><span class="line">        goodsDetail.setGoodsDetailId(idWorker.nextId());</span><br><span class="line">        goodsDetail.setGoodsId(goodsId);</span><br><span class="line">        goodsDetail.setGoodsDetailName(<span class="string">&quot;heima goodsDetail&quot;</span>+i);</span><br><span class="line">        goodsDetailMapper.addGoodsDetail(goodsDetail);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）连接mycat查询数据，可以发现出现数据丢失。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_goods a <span class="keyword">join</span> tb_goods_detail b <span class="keyword">on</span> a.goods_id <span class="operator">=</span> b.goods_id</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184023.png" alt="image-20200614194232402"></p>
<h4 id="7-7-2-3）ER实现"><a href="#7-7-2-3）ER实现" class="headerlink" title="7.7.2.3）ER实现"></a>7.7.2.3）ER实现</h4><p>1）修改schema.xml。配置er表</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_goods&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn142,dn145&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;goods_id&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-murmur-goods&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;tb_goods_detail&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;goods_detail_id&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;goods_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;goods_id&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">childTable</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）测试</p>
<p>​    删除原有数据，并重新插入数据，此时再次join查询，可以发现全部的一千条数据都已经获取到了。同时有关联关系的数据，也都存在于同一个数据分片中。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184024.png" alt="image-20200614230514278"></p>
<h1 id="8）Mycat企业级架构设计-amp-应用"><a href="#8）Mycat企业级架构设计-amp-应用" class="headerlink" title="8）Mycat企业级架构设计&amp;应用"></a>8）Mycat企业级架构设计&amp;应用</h1><h2 id="8-1）Mycat主从切换"><a href="#8-1）Mycat主从切换" class="headerlink" title="8.1）Mycat主从切换"></a>8.1）Mycat主从切换</h2><p>​    基于Mycat主从复制方案，当前存在一个主节点和一个从节点，主节点负责写操作，从节点负责读操作。当在一个dataHost中配置了两个或多个writeHost，如果第一个writeHost宕机，则Mycat会在默认3次心跳检查失败后，自动切换到下一个可用的writeHost执行DML语句，并在<strong>conf/dnindex.properties</strong>文件里记录当前所用的writeHost的index。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184025.png" alt="image-20200621190210292"></p>
<p>​    在Mycat主从切换中，可以将从节点也配置为是一个写节点（相当于从节点同时负责读写）。当原有的master写节点宕机后，从节点会被提升为主节点，同时负责读写操作。当写节点恢复后，会被作为从节点使用，保持现有状态不变，跟随新的主节点。</p>
<p>​    简单点说就是：原来的主变成从，原来的从一直为主。</p>
<h3 id="8-1-1）修改schema-xml"><a href="#8-1-1）修改schema-xml" class="headerlink" title="8.1.1）修改schema.xml"></a>8.1.1）修改schema.xml</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mycat</span>:schema <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;userdb&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn142&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;500&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn142&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;user_id&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn142&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dh142&quot;</span> <span class="attr">database</span>=<span class="string">&quot;user&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">		writeType:0  所有的写操作都发送到writeHost上</span></span><br><span class="line"><span class="comment">		balance:1 所有读操作都发送到readHost上</span></span><br><span class="line"><span class="comment">		switchType:2 基于mysql主从同步的状态决定是否切换</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dh142&quot;</span>  <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;1&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;100&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span>  <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;1000&quot;</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--查询心跳--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>show slave status<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--配置写节点实际物理数据库信息--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.142:3309&quot;</span> <span class="attr">host</span>=<span class="string">&quot;host1&quot;</span>  <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!--配置读节点实际物理数据库信息--&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;host2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.145:3309&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">readHost</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">&lt;!--配置从节点也会作为写节点使用--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.145:3309&quot;</span> <span class="attr">host</span>=<span class="string">&quot;host2&quot;</span>  <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="8-1-2）测试"><a href="#8-1-2）测试" class="headerlink" title="8.1.2）测试"></a>8.1.2）测试</h3><p>​    开始测试时，当前host1为master写节点，host2为slave读节点同时作为备用写节点。</p>
<p>1）查看conf/dnindex.properties。可以发现dn142的值0，代表为第一个写节点。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184026.png" alt="image-20200621194835074"></p>
<p>2）向tb_user表中插入数据。期望效果：当前host1为写节点，数据会进入到host1中，并复制到host2中</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(user_name) <span class="keyword">values</span>(<span class="string">&#x27;zhangsan&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184027.png" alt="image-20200621193213163"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184028.png" alt="image-20200621193227331"></p>
<p>3）停止host1的mysql服务。并重新执行添加操作。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(user_name) <span class="keyword">values</span>(<span class="string">&#x27;lisi&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>此时mycat Server控制台信息</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184029.png" alt="image-20200621194645750"></p>
<p>同时查看conf/dnindex.properties。可以发现dn142的值已从0变为1。进行了节点更改。<img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184030.png" alt="image-20200621194803521"></p>
<p>数据可以插入成功，但是数据会进入到第二个写节点中</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184031.png" alt="image-20200621194946743"></p>
<p>4）重启host1服务。并重新插入数据。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(user_name) <span class="keyword">values</span>(<span class="string">&#x27;wangwu&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>此时可以发现数据仍然会进入到host2中，因为就算之前的host1恢复了，根据mycat的规则其也不会自动提升为写节点，因此写节点仍然为host2。 </p>
<p>并且当前为主从架构，并没有配置为双向复制。所以数据进入到host2后，host1中仍然没有数据，符合预期。此时host2会同时负责读、写请求。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184032.png" alt="image-20200621195436688"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184033.png" alt="image-20200621195444753"></p>
<h2 id="8-2）动态扩容-amp-数据迁移"><a href="#8-2）动态扩容-amp-数据迁移" class="headerlink" title="8.2）动态扩容&amp;数据迁移"></a>8.2）动态扩容&amp;数据迁移</h2><p>​    在生产环境下，当原有的数据库节点已经满足不了当前的数据存储量，此时就会在现有数据库基础上新增数据节点。但是当新增数据节点后，就要考虑原有的数据应该如何迁移一部分数据到新增的数据节点上。</p>
<p>​    <img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184034.png" alt="image-20200628172038412"></p>
<p>1）上传mycat，并在mycat目录下创建logs目录，并在logs目录中创建mycat.pid文件</p>
<p>1）/conf目录下新建newSchema.xml和newRule.xml，用于配置扩容节点。修改内容如下</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mycat</span>:schema <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;userdb&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn180&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;500&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn180,dn181,dn182&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;mod-long&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn180&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dh180&quot;</span> <span class="attr">database</span>=<span class="string">&quot;user&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn181&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dh181&quot;</span> <span class="attr">database</span>=<span class="string">&quot;user&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn182&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dh182&quot;</span> <span class="attr">database</span>=<span class="string">&quot;user&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dh180&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;100&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span>  <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">slaveThreshold</span>=<span class="string">&quot;1000&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.180:3311&quot;</span> <span class="attr">host</span>=<span class="string">&quot;host1&quot;</span>  <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dh181&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;100&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span>  <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">slaveThreshold</span>=<span class="string">&quot;1000&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.181:3311&quot;</span> <span class="attr">host</span>=<span class="string">&quot;host1&quot;</span>  <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dh182&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;100&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span>  <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">slaveThreshold</span>=<span class="string">&quot;1000&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.182:3311&quot;</span> <span class="attr">host</span>=<span class="string">&quot;host1&quot;</span>  <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- - - Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); </span></span><br><span class="line"><span class="comment"> - you may not use this file except in compliance with the License. - You </span></span><br><span class="line"><span class="comment"> may obtain a copy of the License at - - http://www.apache.org/licenses/LICENSE-2.0 </span></span><br><span class="line"><span class="comment"> - - Unless required by applicable law or agreed to in writing, software - </span></span><br><span class="line"><span class="comment"> distributed under the License is distributed on an &quot;AS IS&quot; BASIS, - WITHOUT </span></span><br><span class="line"><span class="comment"> WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. - See the </span></span><br><span class="line"><span class="comment"> License for the specific language governing permissions and - limitations </span></span><br><span class="line"><span class="comment"> under the License. --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mycat</span>:rule <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;rule.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:rule</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;rule1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>func1<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;partition-by-fixed-hash&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>partition-by-fixed-hash<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-date&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>create_time<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>partbyday<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;rule2&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>func1<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-intfile&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>sex<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>hash-int<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;auto-sharding-long&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>age<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>mod-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-murmur&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>murmur<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-murmur-goods&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>goods_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>murmur<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-murmur-goods-detail&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>goods_detail_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>murmur<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;crc32slot&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>crc32slot<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-month&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>create_time<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-month-function<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;latest-month-calldate&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>calldate<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>latestMonth<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;auto-sharding-rang-mod&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-mod<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;jch&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>jump-consistent-hash<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-hour&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_hour<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-hour-function<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;murmur&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMurmurHash&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;seed&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;virtualBucketTimes&quot;</span>&gt;</span>160<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;crc32slot&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByCRC32PreSlot&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;hash-int&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByFileMap&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-hash-int.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultNode&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;rang-long&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.AutoPartitionByLong&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>autopartition-long.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;func1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByLong&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionCount&quot;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionLength&quot;</span>&gt;</span>128<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;partition-by-fixed-hash&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByLong&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionCount&quot;</span>&gt;</span>1,1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionLength&quot;</span>&gt;</span>256,768<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;latestMonth&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.LatestMonthPartion&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;splitOneDay&quot;</span>&gt;</span>24<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;partbymonth&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMonth&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dateFormat&quot;</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sBeginDate&quot;</span>&gt;</span>2015-01-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;partbyday&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByDate&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dateFormat&quot;</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sNaturalDay&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sBeginDate&quot;</span>&gt;</span>2020-01-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sPartionDay&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;rang-mod&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByRangeMod&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-range-mod.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;jump-consistent-hash&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByJumpConsistentHash&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;totalBuckets&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-hour-function&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.LatestMonthPartion&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;splitOneDay&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-month-function&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMonth&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dateFormat&quot;</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sBeginDate&quot;</span>&gt;</span>2020-05-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:rule</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2）修改/conf下migrateTables.properties，指定虚拟库和表</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">userdb</span>=<span class="string">tb_user</span></span><br></pre></td></tr></table></figure>

<p>3）修改/bin下dataMigrate.sh</p>
<p>修改该文件编码格式由原有dos修改为unix</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#查看文件格式</span><br><span class="line">:set ff</span><br><span class="line"></span><br><span class="line">#修改文件格式</span><br><span class="line">:set ff=unix</span><br></pre></td></tr></table></figure>

<p>修改mysqldump文件路径</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#查看mysqldump文件路径</span><br><span class="line">find / -name mysqldump</span><br><span class="line"></span><br><span class="line">#修改dataMigrate.sh文件配置</span><br><span class="line">RUN_CMD=&quot;$RUN_CMD -mysqlBin=/usr/bin/&quot;</span><br></pre></td></tr></table></figure>

<p>4）执行数据扩容与迁移</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd bin</span><br><span class="line"></span><br><span class="line">./dataMigrate.sh</span><br></pre></td></tr></table></figure>

<p>5）执行后结果</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184035.png" alt="image-20200628173237529"></p>
<p><code>ps:执行数据扩容&amp;迁移时，务必注意虚拟库的名称必须要全部是小写，不能大小写混合</code></p>
<p>6）数据迁移后还应考虑后续的数据查询，此时还需将文件进行替换，用于查询路由。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mv newRule.xml rule.xml</span><br><span class="line"></span><br><span class="line">mv newSchema.xml schema.xml</span><br></pre></td></tr></table></figure>

<h2 id="8-3）Haproxy-keepalived-mycat高可用负载均衡集群"><a href="#8-3）Haproxy-keepalived-mycat高可用负载均衡集群" class="headerlink" title="8.3）Haproxy+keepalived+mycat高可用负载均衡集群"></a>8.3）Haproxy+keepalived+mycat高可用负载均衡集群</h2><p>​    当线上服务器压力过大时，可以考虑基于keepalived进行高可用避免出现mycat单点问题，同时为了防止线上压力集中在某一台实例上，可以通过haproxy进行请求的负载均衡。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184036.png" alt="image-20200628173502183"></p>
<h3 id="8-3-1）mycat准备"><a href="#8-3-1）mycat准备" class="headerlink" title="8.3.1）mycat准备"></a>8.3.1）mycat准备</h3><p>​    142&amp;145两台机器准备mycat-server并启动</p>
<h3 id="8-3-2）haproxy安装-amp-配置"><a href="#8-3-2）haproxy安装-amp-配置" class="headerlink" title="8.3.2）haproxy安装&amp;配置"></a>8.3.2）haproxy安装&amp;配置</h3><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#下载haproxy镜像</span></span><br><span class="line"><span class="string">docker</span> <span class="string">pull</span> <span class="string">haproxy:1.9.6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在宿主机指定文件夹创建haproxy.cfg</span></span><br><span class="line"></span><br><span class="line"><span class="string">global</span></span><br><span class="line">    <span class="string">log</span>         <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="string">local2</span></span><br><span class="line">    <span class="string">maxconn</span>     <span class="number">4000</span></span><br><span class="line">    <span class="string">daemon</span></span><br><span class="line"></span><br><span class="line"><span class="string">defaults</span></span><br><span class="line">        <span class="string">log</span>     <span class="string">global</span></span><br><span class="line">        <span class="string">log</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="string">local3</span></span><br><span class="line">        <span class="string">mode</span>    <span class="string">http</span></span><br><span class="line">        <span class="string">option</span>  <span class="string">tcplog</span></span><br><span class="line">        <span class="string">option</span>  <span class="string">dontlognull</span></span><br><span class="line">        <span class="string">retries</span> <span class="number">10</span></span><br><span class="line">        <span class="string">option</span> <span class="string">redispatch</span></span><br><span class="line">        <span class="string">maxconn</span>         <span class="number">2000</span></span><br><span class="line">        <span class="string">timeout</span> <span class="string">connect</span>         <span class="string">10s</span></span><br><span class="line">        <span class="string">timeout</span> <span class="string">client</span>          <span class="string">1m</span></span><br><span class="line">        <span class="string">timeout</span> <span class="string">server</span>          <span class="string">1m</span></span><br><span class="line">        <span class="string">timeout</span> <span class="string">http-keep-alive</span> <span class="string">10s</span></span><br><span class="line">        <span class="string">timeout</span> <span class="string">check</span>           <span class="string">10s</span></span><br><span class="line"></span><br><span class="line"><span class="string">listen</span> <span class="string">admin_stats</span></span><br><span class="line">        <span class="string">bind</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:10080</span></span><br><span class="line">        <span class="string">mode</span> <span class="string">http</span></span><br><span class="line">        <span class="string">option</span> <span class="string">httplog</span></span><br><span class="line">        <span class="string">maxconn</span> <span class="number">10</span></span><br><span class="line">        <span class="string">stats</span> <span class="string">refresh</span> <span class="string">30s</span></span><br><span class="line">        <span class="string">stats</span> <span class="string">uri</span> <span class="string">/stats</span></span><br><span class="line">        <span class="string">stats</span> <span class="string">realm</span> <span class="string">XingCloud\</span> <span class="string">Haproxy</span></span><br><span class="line">        <span class="string">stats</span> <span class="string">auth</span> <span class="string">admin:admin</span> <span class="comment">#用这个账号登录，可以自己设置</span></span><br><span class="line">        <span class="string">stats</span> <span class="string">hide-version</span></span><br><span class="line">        <span class="string">stats</span> <span class="string">admin</span> <span class="string">if</span> <span class="literal">TRUE</span></span><br><span class="line">        </span><br><span class="line"><span class="string">listen</span>  <span class="string">mycat</span></span><br><span class="line">        <span class="string">bind</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:3300</span></span><br><span class="line">        <span class="string">mode</span> <span class="string">tcp</span></span><br><span class="line">        <span class="string">balance</span> <span class="string">roundrobin</span></span><br><span class="line">        <span class="string">server</span> <span class="string">mycat-180</span> <span class="number">192.168</span><span class="number">.200</span><span class="number">.180</span><span class="string">:8066</span> <span class="string">check</span> <span class="string">port</span> <span class="number">8066 </span><span class="string">maxconn</span> <span class="number">300</span></span><br><span class="line">        <span class="string">server</span> <span class="string">mycat-181</span> <span class="number">192.168</span><span class="number">.200</span><span class="number">.181</span><span class="string">:8066</span> <span class="string">check</span> <span class="string">port</span> <span class="number">8066 </span><span class="string">maxconn</span> <span class="number">300</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">#启动容器</span></span><br><span class="line"><span class="string">docker</span> <span class="string">run</span> <span class="string">-d</span> <span class="string">--name</span> <span class="string">haproxy</span> <span class="string">-p</span> <span class="number">10080</span><span class="string">:10080</span> <span class="string">-v</span> <span class="string">/usr/local/haproxy:/usr/local/etc/haproxy</span> <span class="string">haproxy:1.9.6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#访问web管理页面</span></span><br><span class="line"><span class="string">http://192.168.200.142:10080/stats</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://192.168.200.142:10080/stats">http://192.168.200.142:10080/stats</a>     帐号：admin  密码：admin</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184037.png" alt="image-20200628195202338"></p>
<h3 id="8-3-3）keepalived安装-amp-配置"><a href="#8-3-3）keepalived安装-amp-配置" class="headerlink" title="8.3.3）keepalived安装&amp;配置"></a>8.3.3）keepalived安装&amp;配置</h3><p>1）安装epel-release源</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum list installed|grep epel-release</span><br></pre></td></tr></table></figure>

<p>2）查找可用安装源</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum search keepalived</span><br></pre></td></tr></table></figure>

<p>3）keepAlived安装</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install keepalived -y</span><br></pre></td></tr></table></figure>

<p>4）安装虚拟服务器管理命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install ipvsadm -y</span><br></pre></td></tr></table></figure>

<p>5）编写执行shell脚本</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vi /etc/keepalived/chk.sh<span class="comment">#!/bin/bash</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="keyword">if</span> [ $(ps -C haproxy --no-header | wc -l) -eq 0 ]; <span class="keyword">then</span></span></span><br><span class="line">       killall keepalived</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>6）配置keepAlived配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /etc/keepalived</span><br><span class="line"></span><br><span class="line">vi keepalvied.conf</span><br><span class="line"></span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">#简单的头部，这里主要可以做邮件通知报警等的设置，此处就暂不配置了；</span><br><span class="line">global_defs &#123;</span><br><span class="line">        #notificationd LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">#预先定义一个脚本，方便后面调用，也可以定义多个，方便选择；</span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check.sh&quot;</span><br><span class="line">    interval 2  #脚本循环运行间隔</span><br><span class="line">&#125;</span><br><span class="line">#VRRP虚拟路由冗余协议配置</span><br><span class="line">vrrp_instance VI_1 &#123;   #VI_1 是自定义的名称；</span><br><span class="line">    state BACKUP    #MASTER表示是一台主设备，BACKUP表示为备用设备【我们这里因为设置为开启不抢占，所以都设置为备用】</span><br><span class="line">    nopreempt      #开启不抢占</span><br><span class="line">    interface ens33   #指定VIP需要绑定的物理网卡</span><br><span class="line">    virtual_router_id 11   #VRID虚拟路由标识，也叫做分组名称，该组内的设备需要相同</span><br><span class="line">    priority 130   #定义这台设备的优先级 1-254；开启了不抢占，所以此处优先级必须高于另一台</span><br><span class="line"></span><br><span class="line">    advert_int 1   #生存检测时的组播信息发送间隔，组内一致</span><br><span class="line">    authentication &#123;    #设置验证信息，组内一致</span><br><span class="line">        auth_type PASS   #有PASS 和 AH 两种，常用 PASS</span><br><span class="line">        auth_pass 111111    #密码</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.200.200    #指定VIP地址，组内一致，可以设置多个IP</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;    #使用在这个域中使用预先定义的脚本，上面定义的</span><br><span class="line">        chk_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>7）启动keepAlived</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start keepalived</span><br></pre></td></tr></table></figure>

<p>8）查看keepAlived执行状态</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ps -ef|grep keepalived</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184038.png" alt="image-20200628202404850"></p>
<p>9）此时通过ip a可以看到优先级高的机器已经有了虚拟ip</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184039.png" alt="image-20200628202617986"></p>
<p>10）访问haproxy</p>
<p>192.168.200.200:10080/stats   访问成功</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184040.png" alt="image-20200628202701140"></p>
<p>11）访问mycat</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184041.png" alt="image-20200628202822392"></p>
<p>访问成功，现在已经成功通过keepalived+haproxy跳转到mycat上。</p>
<h1 id="9）Mycat企业级运维"><a href="#9）Mycat企业级运维" class="headerlink" title="9）Mycat企业级运维"></a>9）Mycat企业级运维</h1><h2 id="9-1）Mycat-Web性能监控平台"><a href="#9-1）Mycat-Web性能监控平台" class="headerlink" title="9.1）Mycat-Web性能监控平台"></a>9.1）Mycat-Web性能监控平台</h2><p>​    在现在的企业开发中，作为一个合格的开发人员来说，不仅要完成正常的编码任务，同时也要掌握一定的运维能力。当线上系统出现问题时，要能够快速的将隐藏问题找出来并进行解决。</p>
<p>​    Mycat-web是mycat的可视化运维监控平台。其能够管理和监控mycat的流量、连接数、线程数、JVM、内存。并且基于内部统计还能够分析出慢SQL与高频SQL。为sql优化提供了重要的依据。</p>
<h3 id="9-1-1）Mycat-web安装"><a href="#9-1-1）Mycat-web安装" class="headerlink" title="9.1.1）Mycat-web安装"></a>9.1.1）Mycat-web安装</h3><p>1）安装zookeeper</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#创建zk文件夹</span><br><span class="line">mkdir -p /usr/local/zookeeper</span><br><span class="line"></span><br><span class="line">#在zk文件夹下下载zk安装包</span><br><span class="line">wget https://archive.apache.org/dist/zookeeper/zookeeper-3.4.9/zookeeper-3.4.9.tar.gz</span><br><span class="line"></span><br><span class="line">#解压安装包</span><br><span class="line">tar -zxvf zookeeper-3.4.9.tar.gz</span><br><span class="line"></span><br><span class="line">#进入/conf文件夹，修改配置文件名称</span><br><span class="line">cp zoo_sample.cfg zoo.cfg</span><br><span class="line"></span><br><span class="line">#修改配置文件内容</span><br><span class="line"># The number of milliseconds of each tick</span><br><span class="line">tickTime=2000</span><br><span class="line"># The number of ticks that the initial</span><br><span class="line"># synchronization phase can take</span><br><span class="line">initLimit=10</span><br><span class="line"># The number of ticks that can pass between</span><br><span class="line"># sending a request and getting an acknowledgement</span><br><span class="line">syncLimit=5</span><br><span class="line"># the directory where the snapshot is stored.</span><br><span class="line"># do not use /tmp for storage, /tmp here is just</span><br><span class="line"># example sakes.</span><br><span class="line">dataDir=/usr/local/services/zookeeper/zookeeper-3.4.9/data</span><br><span class="line">dataLogDir=/usr/local/services/zookeeper/zookeeper-3.4.9/logs</span><br><span class="line"># the port at which the clients will connect</span><br><span class="line">clientPort=2181</span><br><span class="line"># the maximum number of client connections.</span><br><span class="line"># increase this if you need to handle more clients</span><br><span class="line">#maxClientCnxns=60</span><br><span class="line">#</span><br><span class="line"># Be sure to read the maintenance section of the</span><br><span class="line"># administrator guide before turning on autopurge.</span><br><span class="line">#</span><br><span class="line"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span><br><span class="line">#</span><br><span class="line"># The number of snapshots to retain in dataDir</span><br><span class="line">#autopurge.snapRetainCount=3</span><br><span class="line"># Purge task interval in hours</span><br><span class="line"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class="line">#autopurge.purgeInterval=1</span><br><span class="line"></span><br><span class="line">#配置环境变量</span><br><span class="line">export ZOOKEEPER_HOME=/usr/local/zookeeper/zookeeper-3.4.9/</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH:$MYCAT_HOME/bin:$ZOOKEEPER_HOME/bin</span><br><span class="line"></span><br><span class="line">#启动zk</span><br><span class="line">zkServer.sh start</span><br></pre></td></tr></table></figure>

<p>2）Mycat-web安装</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#解压mycat安装包</span><br><span class="line">tar -zxvf Mycat-web-1.0-SNAPSHOT-20170102153329-linux.tar.gz</span><br><span class="line"></span><br><span class="line">#启动mycat-web，默认端口8082</span><br><span class="line">./start.sh</span><br><span class="line"></span><br><span class="line">#查看mycat-web是否启动成功</span><br><span class="line">netstat -ant | grep 8082</span><br><span class="line"></span><br><span class="line">#访问mycat-web</span><br><span class="line">ip:8082/mycat</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184042.png" alt="image-20200628211259421"></p>
<h3 id="9-1-2）mycat-web使用"><a href="#9-1-2）mycat-web使用" class="headerlink" title="9.1.2）mycat-web使用"></a>9.1.2）mycat-web使用</h3><p>​    mycat-web的使用非常简单，其内部已经提供了mycat配置、mycat监控、sql监控与sql上线检查。只需要在其内部配置好自己的mycat服务器信息即可完成使用。</p>
<h2 id="9-2）Mycat调优"><a href="#9-2）Mycat调优" class="headerlink" title="9.2）Mycat调优"></a>9.2）Mycat调优</h2><p>​    在mycat使用过程中，也有可能涉及到对其进行调优。对于mycat调优主要是从JVM、操作系统、mycat本身、缓存、I/O、mysql这几部分分别进行调优</p>
<h3 id="9-2-1）JVM优化"><a href="#9-2-1）JVM优化" class="headerlink" title="9.2.1）JVM优化"></a>9.2.1）JVM优化</h3><p>​    JVM调优主要分为两部分<strong>堆内存</strong>和<strong>直接内存</strong>。直接内存尽可能的大，合理情况下应在操作系统的50%~67%之间。以16G内存服务器为例：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-server -Xms4G -Mmx4G XX:MaxPermSize=64M -XX:MaxDirectMemorySize=6G</span><br></pre></td></tr></table></figure>

<p>​    Mycat中JVM参数修改可配置/conf/wrapper.conf</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">wrapper.java.additional.4</span>=<span class="string">-XX:MaxDirectMemorySize=2G</span></span><br><span class="line"><span class="comment"># Initial Java Heap Size (in MB)</span></span><br><span class="line"><span class="comment">#wrapper.java.initmemory=3</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Maximum Java Heap Size (in MB)</span></span><br><span class="line"><span class="comment">#wrapper.java.maxmemory=64</span></span><br></pre></td></tr></table></figure>

<h3 id="9-2-2）操作系统优化"><a href="#9-2-2）操作系统优化" class="headerlink" title="9.2.2）操作系统优化"></a>9.2.2）操作系统优化</h3><p>​    Linux系统对每个进行打开的文件句柄数量是有限的，可以把mysql和mycat服务器的最大文件句柄数量设置为5000~10000，可以通过ulimit命令修改，但只对当前用户有效，且服务器重启后失效。</p>
<h3 id="9-2-3）mycat优化"><a href="#9-2-3）mycat优化" class="headerlink" title="9.2.3）mycat优化"></a>9.2.3）mycat优化</h3><p>​    修改/conf/server.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--设置可用CPU数量，当CPU压力小时，可以通过该参数优化mycat--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;processors&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--设置可用CPU线程池大小，一般为16~64之间，根据系统能力决定--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;processorExecutor&quot;</span>&gt;</span>32<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    修改/conf/schema.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--checkSQLschema建议设置为false，可以优化sql解析--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;userDB&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn142&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;500&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--maxCon建议设置在1000~2000之间，同一个mysql实例上所有dataNode节点共享本datahost上的所有物理节点--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dh142&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;3&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;100&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span>  <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">slaveThreshold</span>=<span class="string">&quot;1000&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="9-2-4）缓存优化"><a href="#9-2-4）缓存优化" class="headerlink" title="9.2.4）缓存优化"></a>9.2.4）缓存优化</h3><p>​    在mycat中通过<code>show @@cache</code>可以查看当前mycat缓存的使用情况</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql -umycat -h192.168.200.142 -P9066 -pmycat</span><br><span class="line"></span><br><span class="line">show @@cache</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211209184043.png" alt="image-20200628231722460"></p>
<p>​    如果CUR接近MAX，而PUT比MAX大很多，则表明MAX需要增大。HIT/ACCESS为缓存命中率，该值越高越好。当调整后需要观察缓存命中率是否增加、PUT是否在下降。</p>
<p>​    可以修改**/conf/cacheservice.properties**修改缓存配置，其使用的是encache，在encache.xml中设置了encache缓存的全局属性</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#used for mycat cache service conf</span></span><br><span class="line"><span class="meta">factory.encache</span>=<span class="string">io.mycat.cache.impl.EnchachePooFactory</span></span><br><span class="line"><span class="comment">#key is pool name ,value is type,max size, expire seconds</span></span><br><span class="line"><span class="comment">#SQL解析和路由使用的缓存</span></span><br><span class="line"><span class="meta">pool.SQLRouteCache</span>=<span class="string">encache,10000,1800</span></span><br><span class="line"><span class="comment">#ER分片时使用的缓存</span></span><br><span class="line"><span class="meta">pool.ER_SQL2PARENTID</span>=<span class="string">encache,1000,1800</span></span><br><span class="line"><span class="comment">#当根据主键查询比较多时，该值设置的较大，可以有效提升性能</span></span><br><span class="line"><span class="meta">layedpool.TableID2DataNodeCache</span>=<span class="string">encache,10000,18000</span></span><br><span class="line"><span class="meta">layedpool.TableID2DataNodeCache.TESTDB_ORDERS</span>=<span class="string">50000,18000</span></span><br></pre></td></tr></table></figure>

<p>​    </p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">小肥龙吃大冰淇淋</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lvxueyangtiger.github.io/post/d91990ef.html">https://lvxueyangtiger.github.io/post/d91990ef.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lvxueyangtiger.github.io" target="_blank">小肥龙吃大冰淇淋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/">数据库分库分表</a></div><div class="post_share"><div class="social-share" data-image="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082055.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/b829b66a.html"><img class="prev-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212100.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Zookeeper</div></div></a></div><div class="next-post pull-right"><a href="/post/1bc87318.html"><img class="next-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212120.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">畅购day10</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-number">1.</span> <span class="toc-text">数据库分库分表</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1%EF%BC%89docker%E4%B8%8B%E5%AE%89%E8%A3%85mysql"><span class="toc-number">2.</span> <span class="toc-text">1）docker下安装mysql</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%EF%BC%89%E6%95%B0%E6%8D%AE%E5%BA%93%E6%89%A9%E5%B1%95%E6%80%9D%E6%83%B3"><span class="toc-number">3.</span> <span class="toc-text">2）数据库扩展思想</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%EF%BC%89Mysql%E5%B8%B8%E8%A7%81%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">4.</span> <span class="toc-text">3）Mysql常见架构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1%EF%BC%89%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">4.1.</span> <span class="toc-text">3.1）主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1%EF%BC%89%E6%A6%82%E5%BF%B5"><span class="toc-number">4.1.0.1.</span> <span class="toc-text">3.1.1）概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2%EF%BC%89%E6%90%AD%E5%BB%BA"><span class="toc-number">4.1.0.2.</span> <span class="toc-text">3.1.2）搭建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-3%EF%BC%89%E6%B5%8B%E8%AF%95"><span class="toc-number">4.1.0.3.</span> <span class="toc-text">3.1.3）测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2%EF%BC%89Mysql%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90"><span class="toc-number">4.2.</span> <span class="toc-text">3.2）Mysql复制原理解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1%EF%BC%89%E5%A4%8D%E5%88%B6%E6%9C%BA%E5%88%B6%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">4.2.1.</span> <span class="toc-text">3.2.1）复制机制的实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-1%EF%BC%89%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">4.2.1.1.</span> <span class="toc-text">3.2.1.1）异步复制执行流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-2%EF%BC%89%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">4.2.1.2.</span> <span class="toc-text">3.2.1.2）半同步复制执行流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2%EF%BC%89%E4%B8%BB%E4%BB%8E%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6%E6%97%A5%E5%BF%97%E6%95%88%E6%9E%9C"><span class="toc-number">4.2.2.</span> <span class="toc-text">3.2.2）主从异步复制日志效果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3%EF%BC%89%E4%B8%BB%E4%BB%8E%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6%E9%85%8D%E7%BD%AE-amp-%E6%95%88%E6%9E%9C%E6%BC%94%E7%A4%BA"><span class="toc-number">4.2.3.</span> <span class="toc-text">3.2.3）主从半同步复制配置&amp;效果演示</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3-1%EF%BC%89%E9%85%8D%E7%BD%AE"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">3.2.3.1）配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-2%EF%BC%89%E6%95%88%E6%9E%9C%E6%BC%94%E7%A4%BA"><span class="toc-number">4.2.3.2.</span> <span class="toc-text">3.2.2.2）效果演示</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3%EF%BC%89%E4%B8%BB%E4%B8%BB%E5%A4%8D%E5%88%B6"><span class="toc-number">4.3.</span> <span class="toc-text">3.3）主主复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1%EF%BC%89%E6%A6%82%E5%BF%B5"><span class="toc-number">4.3.1.</span> <span class="toc-text">3.3.1）概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2%EF%BC%89%E6%90%AD%E5%BB%BA"><span class="toc-number">4.3.2.</span> <span class="toc-text">3.3.2）搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3%EF%BC%89%E6%B5%8B%E8%AF%95"><span class="toc-number">4.3.3.</span> <span class="toc-text">3.3.3）测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4%EF%BC%89%E7%BA%A7%E8%81%94%E5%A4%8D%E5%88%B6%E6%9E%B6%E6%9E%84"><span class="toc-number">4.4.</span> <span class="toc-text">3.4）级联复制架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5%EF%BC%89%E5%8F%8C%E4%B8%BB%E4%B8%8E%E7%BA%A7%E8%81%94%E5%A4%8D%E5%88%B6%E7%BB%93%E5%90%88%E6%9E%B6%E6%9E%84"><span class="toc-number">4.5.</span> <span class="toc-text">3.5）双主与级联复制结合架构</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%EF%BC%89Mysql%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%9E%E8%B7%B5"><span class="toc-number">5.</span> <span class="toc-text">4）Mysql高可用实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1%EF%BC%89%E9%AB%98%E5%8F%AF%E7%94%A8%E7%AE%80%E4%BB%8B"><span class="toc-number">5.1.</span> <span class="toc-text">4.1）高可用简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2%EF%BC%89keepAlived%E9%AB%98%E5%8F%AF%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">5.2.</span> <span class="toc-text">4.2）keepAlived高可用配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5%EF%BC%89%E6%95%B0%E6%8D%AE%E5%88%87%E5%88%86%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3"><span class="toc-number">6.</span> <span class="toc-text">5）数据切分核心思想</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1%EF%BC%89%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%87%E5%88%86"><span class="toc-number">6.1.</span> <span class="toc-text">5.1）为什么要进行数据切分</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2%EF%BC%89%E6%95%B0%E6%8D%AE%E6%8B%86%E5%88%86%E6%96%B9%E5%BC%8F"><span class="toc-number">6.2.</span> <span class="toc-text">5.2）数据拆分方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1%EF%BC%89%E5%9E%82%E7%9B%B4%E6%8B%86%E5%88%86"><span class="toc-number">6.2.1.</span> <span class="toc-text">5.2.1）垂直拆分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2%EF%BC%89%E6%B0%B4%E5%B9%B3%E6%8B%86%E5%88%86"><span class="toc-number">6.2.2.</span> <span class="toc-text">5.2.2）水平拆分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3%EF%BC%89%E6%95%B0%E6%8D%AE%E5%88%87%E5%88%86%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">6.3.</span> <span class="toc-text">5.3）数据切分带来的问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6%EF%BC%89Mycat%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5-amp-%E6%BA%90%E7%A0%81%E9%83%A8%E7%BD%B2"><span class="toc-number">7.</span> <span class="toc-text">6）Mycat核心概念&amp;源码部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1%EF%BC%89Mycat%E7%AE%80%E4%BB%8B"><span class="toc-number">7.1.</span> <span class="toc-text">6.1）Mycat简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2%EF%BC%89Mycat%E7%89%B9%E6%80%A7"><span class="toc-number">7.2.</span> <span class="toc-text">6.2）Mycat特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3%EF%BC%89Mycat%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95-amp-%E9%83%A8%E7%BD%B2"><span class="toc-number">7.3.</span> <span class="toc-text">6.3）Mycat源码调试&amp;部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4%EF%BC%89MyCat%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">7.4.</span> <span class="toc-text">6.4）MyCat核心概念</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7%EF%BC%89Mycat%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5"><span class="toc-number">8.</span> <span class="toc-text">7）Mycat企业级应用实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1%EF%BC%89%E7%8E%AF%E5%A2%83%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><span class="toc-number">8.1.</span> <span class="toc-text">7.1）环境参数配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2%EF%BC%89%E6%95%B0%E6%8D%AE%E9%9D%9E%E5%88%86%E7%89%87"><span class="toc-number">8.2.</span> <span class="toc-text">7.2）数据非分片</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-1%EF%BC%89%E9%85%8D%E7%BD%AE%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BF%A1%E6%81%AF"><span class="toc-number">8.2.1.</span> <span class="toc-text">7.2.1）配置初始化信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-2%EF%BC%89%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E6%95%B0%E6%8D%AE%E5%BA%93-amp-%E8%A1%A8"><span class="toc-number">8.2.2.</span> <span class="toc-text">7.2.2）配置虚拟数据库&amp;表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-3%EF%BC%89%E6%B5%8B%E8%AF%95"><span class="toc-number">8.2.3.</span> <span class="toc-text">7.2.3）测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3%EF%BC%89%E6%A0%B9%E6%8D%AEID%E5%8F%96%E6%A8%A1%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87"><span class="toc-number">8.3.</span> <span class="toc-text">7.3）根据ID取模数据分片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4%EF%BC%89%E5%85%A8%E5%B1%80%E5%BA%8F%E5%88%97%E5%8F%B7"><span class="toc-number">8.4.</span> <span class="toc-text">7.4）全局序列号</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-1%EF%BC%89%E5%9F%BA%E4%BA%8E%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E6%96%B9%E5%BC%8F%E7%94%9F%E6%88%90"><span class="toc-number">8.4.1.</span> <span class="toc-text">7.4.1）基于本地文件方式生成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-2%EF%BC%89%E5%9F%BA%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%94%9F%E6%88%90"><span class="toc-number">8.4.2.</span> <span class="toc-text">7.4.2）基于数据库生成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-3%EF%BC%89%E5%9F%BA%E4%BA%8Ezookeeper%E7%94%9F%E6%88%90"><span class="toc-number">8.4.3.</span> <span class="toc-text">7.4.3）基于zookeeper生成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-4%EF%BC%89%E5%9F%BA%E4%BA%8E%E6%97%B6%E9%97%B4%E6%88%B3%E7%94%9F%E6%88%90"><span class="toc-number">8.4.4.</span> <span class="toc-text">7.4.4）基于时间戳生成</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-5%EF%BC%89Mycat%E5%88%86%E5%BA%93-amp-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">8.5.</span> <span class="toc-text">7.5）Mycat分库&amp;读写分离</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-6%EF%BC%89MyCat%E5%88%86%E7%89%87%E8%A7%84%E5%88%99"><span class="toc-number">8.6.</span> <span class="toc-text">7.6）MyCat分片规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-1%EF%BC%89%E6%9E%9A%E4%B8%BE%E5%88%86%E7%89%87"><span class="toc-number">8.6.1.</span> <span class="toc-text">7.6.1）枚举分片</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-6-1-1%EF%BC%89%E5%AE%9E%E7%8E%B0"><span class="toc-number">8.6.1.1.</span> <span class="toc-text">7.6.1.1）实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-6-1-2%EF%BC%89%E9%97%AE%E9%A2%98"><span class="toc-number">8.6.1.2.</span> <span class="toc-text">7.6.1.2）问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-2%EF%BC%89%E5%9B%BA%E5%AE%9Ahash%E5%88%86%E7%89%87"><span class="toc-number">8.6.2.</span> <span class="toc-text">7.6.2）固定hash分片</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-6-2-1%EF%BC%89%E5%AE%9E%E7%8E%B0"><span class="toc-number">8.6.2.1.</span> <span class="toc-text">7.6.2.1）实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-3%EF%BC%89%E5%9B%BA%E5%AE%9A%E8%8C%83%E5%9B%B4%E5%88%86%E7%89%87"><span class="toc-number">8.6.3.</span> <span class="toc-text">7.6.3）固定范围分片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-4%EF%BC%89%E5%8F%96%E6%A8%A1%E8%8C%83%E5%9B%B4%E5%88%86%E7%89%87"><span class="toc-number">8.6.4.</span> <span class="toc-text">7.6.4）取模范围分片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-5%EF%BC%89%E5%AD%97%E7%AC%A6%E4%B8%B2hash%E6%B1%82%E6%A8%A1%E8%8C%83%E5%9B%B4%E5%88%86%E7%89%87"><span class="toc-number">8.6.5.</span> <span class="toc-text">7.6.5）字符串hash求模范围分片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-6%EF%BC%89%E4%B8%80%E8%87%B4%E6%80%A7hash%E5%88%86%E7%89%87"><span class="toc-number">8.6.6.</span> <span class="toc-text">7.6.6）一致性hash分片</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-6-6-1%EF%BC%89%E5%8E%9F%E7%90%86"><span class="toc-number">8.6.6.1.</span> <span class="toc-text">7.6.6.1）原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-6-6-2%EF%BC%89%E5%AE%9E%E7%8E%B0"><span class="toc-number">8.6.6.2.</span> <span class="toc-text">7.6.6.2）实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-7%EF%BC%89%E6%97%B6%E9%97%B4%E5%88%86%E7%89%87"><span class="toc-number">8.6.7.</span> <span class="toc-text">7.6.7）时间分片</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-6-7-1%EF%BC%89%E6%8C%89%E5%A4%A9%E5%88%86%E7%89%87"><span class="toc-number">8.6.7.1.</span> <span class="toc-text">7.6.7.1）按天分片</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-6-7-2%EF%BC%89%E6%8C%89%E6%9C%88%E5%88%86%E7%89%87"><span class="toc-number">8.6.7.2.</span> <span class="toc-text">7.6.7.2）按月分片</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-7%EF%BC%89%E8%B7%A8%E5%BA%93join"><span class="toc-number">8.7.</span> <span class="toc-text">7.7）跨库join</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-7-1%EF%BC%89%E5%85%A8%E5%B1%80%E8%A1%A8"><span class="toc-number">8.7.1.</span> <span class="toc-text">7.7.1）全局表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-7-1-1%EF%BC%89%E7%AE%80%E4%BB%8B"><span class="toc-number">8.7.1.1.</span> <span class="toc-text">7.7.1.1）简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-7-1-2%EF%BC%89%E5%AE%9E%E7%8E%B0"><span class="toc-number">8.7.1.2.</span> <span class="toc-text">7.7.1.2）实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-7-2%EF%BC%89ER%E8%A1%A8"><span class="toc-number">8.7.2.</span> <span class="toc-text">7.7.2）ER表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-7-2-1%EF%BC%89%E4%BB%8B%E7%BB%8D"><span class="toc-number">8.7.2.1.</span> <span class="toc-text">7.7.2.1）介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-7-2-2%EF%BC%89%E4%B8%8D%E4%BD%BF%E7%94%A8ER%E8%A1%A8%E9%97%AE%E9%A2%98%E6%BC%94%E7%A4%BA"><span class="toc-number">8.7.2.2.</span> <span class="toc-text">7.7.2.2）不使用ER表问题演示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-7-2-3%EF%BC%89ER%E5%AE%9E%E7%8E%B0"><span class="toc-number">8.7.2.3.</span> <span class="toc-text">7.7.2.3）ER实现</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8%EF%BC%89Mycat%E4%BC%81%E4%B8%9A%E7%BA%A7%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1-amp-%E5%BA%94%E7%94%A8"><span class="toc-number">9.</span> <span class="toc-text">8）Mycat企业级架构设计&amp;应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1%EF%BC%89Mycat%E4%B8%BB%E4%BB%8E%E5%88%87%E6%8D%A2"><span class="toc-number">9.1.</span> <span class="toc-text">8.1）Mycat主从切换</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-1%EF%BC%89%E4%BF%AE%E6%94%B9schema-xml"><span class="toc-number">9.1.1.</span> <span class="toc-text">8.1.1）修改schema.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-2%EF%BC%89%E6%B5%8B%E8%AF%95"><span class="toc-number">9.1.2.</span> <span class="toc-text">8.1.2）测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2%EF%BC%89%E5%8A%A8%E6%80%81%E6%89%A9%E5%AE%B9-amp-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB"><span class="toc-number">9.2.</span> <span class="toc-text">8.2）动态扩容&amp;数据迁移</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3%EF%BC%89Haproxy-keepalived-mycat%E9%AB%98%E5%8F%AF%E7%94%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%9B%86%E7%BE%A4"><span class="toc-number">9.3.</span> <span class="toc-text">8.3）Haproxy+keepalived+mycat高可用负载均衡集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-1%EF%BC%89mycat%E5%87%86%E5%A4%87"><span class="toc-number">9.3.1.</span> <span class="toc-text">8.3.1）mycat准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-2%EF%BC%89haproxy%E5%AE%89%E8%A3%85-amp-%E9%85%8D%E7%BD%AE"><span class="toc-number">9.3.2.</span> <span class="toc-text">8.3.2）haproxy安装&amp;配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-3%EF%BC%89keepalived%E5%AE%89%E8%A3%85-amp-%E9%85%8D%E7%BD%AE"><span class="toc-number">9.3.3.</span> <span class="toc-text">8.3.3）keepalived安装&amp;配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9%EF%BC%89Mycat%E4%BC%81%E4%B8%9A%E7%BA%A7%E8%BF%90%E7%BB%B4"><span class="toc-number">10.</span> <span class="toc-text">9）Mycat企业级运维</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1%EF%BC%89Mycat-Web%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0"><span class="toc-number">10.1.</span> <span class="toc-text">9.1）Mycat-Web性能监控平台</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-1%EF%BC%89Mycat-web%E5%AE%89%E8%A3%85"><span class="toc-number">10.1.1.</span> <span class="toc-text">9.1.1）Mycat-web安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-2%EF%BC%89mycat-web%E4%BD%BF%E7%94%A8"><span class="toc-number">10.1.2.</span> <span class="toc-text">9.1.2）mycat-web使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2%EF%BC%89Mycat%E8%B0%83%E4%BC%98"><span class="toc-number">10.2.</span> <span class="toc-text">9.2）Mycat调优</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-1%EF%BC%89JVM%E4%BC%98%E5%8C%96"><span class="toc-number">10.2.1.</span> <span class="toc-text">9.2.1）JVM优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-2%EF%BC%89%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%BC%98%E5%8C%96"><span class="toc-number">10.2.2.</span> <span class="toc-text">9.2.2）操作系统优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-3%EF%BC%89mycat%E4%BC%98%E5%8C%96"><span class="toc-number">10.2.3.</span> <span class="toc-text">9.2.3）mycat优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-4%EF%BC%89%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-number">10.2.4.</span> <span class="toc-text">9.2.4）缓存优化</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 小肥龙吃大冰淇淋</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="framework-info"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202301132049386.png"/><span> </span><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/">晋ICP备2022012091号-1</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'pinglun-9gh2lmcnd8587831',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'pinglun-9gh2lmcnd8587831',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/hexo-theme-volantis@latest/source/js/issues.min.js"></script><script src="//code.tidio.co/smwivpnwumemac2wohardi3d3gpud1ag.js" async="async"></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>