<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Shiro从入门到放弃 | 小肥龙吃大冰淇淋</title><meta name="keywords" content="Shiro"><meta name="author" content="小肥龙吃大冰淇淋"><meta name="copyright" content="小肥龙吃大冰淇淋"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="权限概述什么是权限​        权限管理，一般指根据系统设置的安全策略或者安全规则，用户可以访问而且只能访问自己被授权的资源，不多不少。权限管理几乎出现在任何系统里面，只要有用户和密码的系统。  权限管理在系统中一般分为：  访问权限   一般表示你能做什么样的操作，或者能够访问那些资源。例如：给张三赋予“店铺主管”角色，“店铺主管”具有“查询员工”、“添加员工”、“修改员工”和“删除员工”权">
<meta property="og:type" content="article">
<meta property="og:title" content="Shiro从入门到放弃">
<meta property="og:url" content="http://lvxueyang.vip/post/f46cf4b5.html">
<meta property="og:site_name" content="小肥龙吃大冰淇淋">
<meta property="og:description" content="权限概述什么是权限​        权限管理，一般指根据系统设置的安全策略或者安全规则，用户可以访问而且只能访问自己被授权的资源，不多不少。权限管理几乎出现在任何系统里面，只要有用户和密码的系统。  权限管理在系统中一般分为：  访问权限   一般表示你能做什么样的操作，或者能够访问那些资源。例如：给张三赋予“店铺主管”角色，“店铺主管”具有“查询员工”、“添加员工”、“修改员工”和“删除员工”权">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210806165213.jpg">
<meta property="article:published_time" content="2021-08-07T08:18:00.000Z">
<meta property="article:modified_time" content="2022-11-27T09:16:40.837Z">
<meta property="article:author" content="小肥龙吃大冰淇淋">
<meta property="article:tag" content="Shiro">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210806165213.jpg"><link rel="shortcut icon" href="https://lvxueyangboke.oss-cn-beijing.aliyuncs.com/images/20210805191028.png"><link rel="canonical" href="http://lvxueyang.vip/post/f46cf4b5"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Shiro从入门到放弃',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-27 17:16:40'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/ali_icon.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mogai.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="小肥龙吃大冰淇淋" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">303</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">108</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">73</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210806165213.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">小肥龙吃大冰淇淋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Shiro从入门到放弃</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-08-07T08:18:00.000Z" title="发表于 2021-08-07 16:18:00">2021-08-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-27T09:16:40.837Z" title="更新于 2022-11-27 17:16:40">2022-11-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Shiro/">Shiro</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">37.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>181分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Shiro从入门到放弃"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="权限概述"><a href="#权限概述" class="headerlink" title="权限概述"></a>权限概述</h2><h3 id="什么是权限"><a href="#什么是权限" class="headerlink" title="什么是权限"></a>什么是权限</h3><p>​        权限管理，一般指根据系统设置的安全策略或者安全规则，用户可以访问而且只能访问自己被授权的资源，不多不少。权限管理几乎出现在任何系统里面，只要有用户和密码的系统。 </p>
<p>权限管理在系统中一般分为：</p>
<ul>
<li><p>访问权限</p>
  <figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">一般表示你能做什么样的操作，或者能够访问那些资源。例如：给张三赋予“店铺主管”角色，“店铺主管”具有“查询员工”、“添加员工”、“修改员工”和“删除员工”权限。此时张三能够进入系统，则可以进行这些操作</span></span><br></pre></td></tr></table></figure></li>
<li><p>数据权限</p>
  <figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">一般表示某些数据你是否属于你，或者属于你可以操作范围。例如：张三是&quot;店铺主管&quot;角色，他可以看他手下客服人员所有的服务的买家订单信息，他的手下只能看自己负责的订单信息</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="认证概念"><a href="#认证概念" class="headerlink" title="认证概念"></a>认证概念</h3><h4 id="什么是认证"><a href="#什么是认证" class="headerlink" title="什么是认证"></a>什么是认证</h4><p>​        身份认证，就是判断一个用户是否为合法用户的处理过程。最常用的简单身份认证方式是系统通过核对用户输入的用户名和密码，看其是否与系统中存储的该用户的用户名和密码一致，来判断用户身份是否正确。例如：密码登录，手机短信验证、三方授权等</p>
<h4 id="认证流程"><a href="#认证流程" class="headerlink" title="认证流程"></a>认证流程</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205656.png" alt="1580044671870"></p>
<h4 id="关键对象"><a href="#关键对象" class="headerlink" title="关键对象"></a>关键对象</h4><p>​        上边的流程图中需要理解以下关键对象：</p>
<p>​        <strong>Subject</strong>：主体：访问系统的用户，主体可以是用户、程序等，进行认证的都称为主体；</p>
<p>​        <strong>Principal</strong>：身份信息是主体（subject）进行身份认证的标识，标识必须具有唯一性，如用户名、手机号、邮箱地址等，一个主体可以有多个身份，但是必须有一个主身份（Primary Principal）。</p>
<p>​        <strong>credential</strong>：凭证信息：是只有主体自己知道的安全信息，如密码、证书等。</p>
<h3 id="授权概念"><a href="#授权概念" class="headerlink" title="授权概念"></a>授权概念</h3><h4 id="什么是授权"><a href="#什么是授权" class="headerlink" title="什么是授权"></a>什么是授权</h4><p>​        授权，即访问控制，控制谁能访问哪些资源。主体进行身份认证后，系统会为其分配对应的权限，当访问资</p>
<p>源时，会校验其是否有访问此资源的权限。</p>
<p>这里首先理解4个对象。</p>
<p>​        用户对象user：当前操作的用户、程序。</p>
<p>​        资源对象resource：当前被访问的对象</p>
<p>​        角色对象role ：一组 “权限操作许可权” 的集合。</p>
<p>​        权限对象permission：权限操作许可权</p>
<h4 id="授权流程"><a href="#授权流程" class="headerlink" title="授权流程"></a>授权流程</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205704.png" alt="1582789303655"></p>
<h4 id="关键对象-1"><a href="#关键对象-1" class="headerlink" title="关键对象"></a>关键对象</h4><p><strong>授权可简单理解为who对what进行How操作</strong></p>
<p><strong>Who：</strong>主体（Subject），可以是一个用户、也可以是一个程序</p>
<p><strong>What：</strong>资源（Resource），如系统菜单、页面、按钮、方法、系统商品信息等。</p>
<p>​        访问类型：商品菜单，订单菜单、分销商菜单</p>
<p>​        数据类型：我的商品，我的订单，我的评价</p>
<p><strong>How：</strong>权限/许可（Permission）</p>
<p>​        我的商品（资源）===&gt;访问我的商品(权限许可)</p>
<p>​        分销商菜单（资源）===》访问分销商列表（权限许可）        </p>
<h2 id="Shiro概述"><a href="#Shiro概述" class="headerlink" title="Shiro概述"></a>Shiro概述</h2><h3 id="Shiro简介"><a href="#Shiro简介" class="headerlink" title="Shiro简介"></a>Shiro简介</h3><h4 id="什么是Shiro"><a href="#什么是Shiro" class="headerlink" title="什么是Shiro?"></a>什么是Shiro?</h4><p>​        Shiro是apache旗下一个开源框架，它将软件系统的安全认证相关的功能抽取出来，实现用户身份认证，权限授权、加密、会话管理等功能，组成了一个通用的安全认证框架。</p>
<h4 id="Shiro-的特点"><a href="#Shiro-的特点" class="headerlink" title="Shiro 的特点"></a>Shiro 的特点</h4><p>​        Shiro 是一个强大而灵活的开源安全框架，能够非常清晰的处理认证、授权、管理会话以及密码加密。如下是它所具有的特点：</p>
<p>· 易于理解的 Java Security API；</p>
<p>· 简单的身份认证（登录），支持多种数据源（LDAP，JDBC 等）；</p>
<p>· 对角色的简单的签权（访问控制），也支持细粒度的鉴权；</p>
<p>· 支持一级缓存，以提升应用程序的性能；</p>
<p>· 内置的基于 POJO 企业会话管理，适用于 Web 以及非 Web 的环境；</p>
<p>· 异构客户端会话访问；</p>
<p>· 非常简单的加密 API；</p>
<p>· 不跟任何的框架或者容器捆绑，可以独立运行。</p>
<h3 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h3><ul>
<li>Shiro架构图</li>
</ul>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205708.png"></p>
<ul>
<li>Subject</li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">Subject主体，外部应用与subject进行交互，subject将用户作为当前操作的主体，这个主体：可以是一个通过浏览器请求的用户，也可能是一个运行的程序。Subject在shiro中是一个接口，接口中定义了很多认证授相关的方法，外部程序通过subject进行认证授，而subject是通过SecurityManager安全管理器进行认证授权</span></span><br></pre></td></tr></table></figure>

<ul>
<li>SecurityManager</li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">SecurityManager权限管理器，它是shiro的核心，负责对所有的subject进行安全管理。通过SecurityManager可以完成subject的认证、授权等，SecurityManager是通过Authenticator进行认证，通过Authorizer进行授权，通过SessionManager进行会话管理等。SecurityManager是一个接口，继承了Authenticator,</span> <span class="string">Authorizer, SessionManager这三个接口</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Authenticator</li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">Authenticator即认证器，对用户登录时进行身份认证</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Authorizer</li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">Authorizer授权器，用户通过认证器认证通过，在访问功能时需要通过授权器判断用户是否有此功能的操作权限。</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Realm（数据库读取+认证功能+授权功能实现）</li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">Realm领域，相当于datasource数据源，securityManager进行安全认证需要通过Realm获取用户权限数据</span></span><br><span class="line"><span class="attr">比如：</span></span><br><span class="line">	<span class="attr">如果用户身份数据在数据库那么realm就需要从数据库获取用户身份信息。</span></span><br><span class="line"><span class="attr">注意：</span></span><br><span class="line">	<span class="attr">不要把realm理解成只是从数据源取数据，在realm中还有认证授权校验的相关的代码。　</span></span><br></pre></td></tr></table></figure>

<ul>
<li>SessionManager</li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">SessionManager会话管理，shiro框架定义了一套会话管理，它不依赖web容器的session，所以shiro可以使用在非web应用上，也可以将分布式应用的会话集中在一点管理，此特性可使它实现单点登录。</span></span><br></pre></td></tr></table></figure>

<ul>
<li>SessionDAO</li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">SessionDAO即会话dao，是对session会话操作的一套接口</span></span><br><span class="line"><span class="meta">比如</span>:<span class="string"></span></span><br><span class="line">	<span class="attr">可以通过jdbc将会话存储到数据库</span></span><br><span class="line">	<span class="attr">也可以把session存储到缓存服务器</span></span><br></pre></td></tr></table></figure>

<ul>
<li>CacheManager </li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">CacheManager缓存管理，将用户权限数据存储在缓存，这样可以提高性能</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Cryptography</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Cryptography密码管理，shiro提供了一套加密/解密的组件，方便开发。比如提供常用的散列、加/解密等功能</span><br></pre></td></tr></table></figure>



<h2 id="Shiro入门"><a href="#Shiro入门" class="headerlink" title="Shiro入门"></a>Shiro入门</h2><h3 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h3><h4 id="基本流程"><a href="#基本流程" class="headerlink" title="基本流程"></a>基本流程</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205718.png" alt="1580047247677"></p>
<p> 流程如下：</p>
<p>​    1、Shiro把用户的数据封装成标识token，token一般封装着用户名，密码等信息</p>
<p>​    2、使用Subject门面获取到封装着用户的数据的标识token</p>
<p>​    3、Subject把标识token交给SecurityManager，在SecurityManager安全中心中，SecurityManager把标识token委托给认证器Authenticator进行身份验证。认证器的作用一般是用来指定如何验证，它规定本次认证用到哪些Realm</p>
<p>​    4、认证器Authenticator将传入的标识token，与数据源Realm对比，验证token是否合法</p>
<h4 id="案例演示"><a href="#案例演示" class="headerlink" title="案例演示"></a>案例演示</h4><h5 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、使用shiro完成一个用户的登录</span><br></pre></td></tr></table></figure>

<h5 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h5><h6 id="新建项目"><a href="#新建项目" class="headerlink" title="新建项目"></a>新建项目</h6><p>shiro-day01-01authenticator</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205722.png" alt="1580048751209"></p>
<h6 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h6><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-day01-01authenticator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>shiro-day01-01authenticator<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- FIXME change it to the project&#x27;s website --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://www.example.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- compiler插件, 设定JDK版本 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">showWarnings</span>&gt;</span>true<span class="tag">&lt;/<span class="name">showWarnings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="编写shiro-ini"><a href="#编写shiro-ini" class="headerlink" title="编写shiro.ini"></a>编写shiro.ini</h6><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment">#声明用户账号</span></span><br><span class="line"><span class="section">[users]</span></span><br><span class="line"><span class="attr">jay</span>=<span class="number">123</span></span><br></pre></td></tr></table></figure>

<h6 id="编写HelloShiro"><a href="#编写HelloShiro" class="headerlink" title="编写HelloShiro"></a>编写HelloShiro</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.config.IniSecurityManagerFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.Factory;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：shiro的第一个例子</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloShiro</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shiroLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//导入权限ini文件构建权限工厂</span></span><br><span class="line">        Factory&lt;SecurityManager&gt; factory = <span class="keyword">new</span> IniSecurityManagerFactory(<span class="string">&quot;classpath:shiro.ini&quot;</span>);</span><br><span class="line">        <span class="comment">//工厂构建安全管理器</span></span><br><span class="line">        SecurityManager securityManager = factory.getInstance();</span><br><span class="line">        <span class="comment">//使用SecurityUtils工具生效安全管理器</span></span><br><span class="line">        SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line">        <span class="comment">//使用SecurityUtils工具获得主体</span></span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        <span class="comment">//构建账号token</span></span><br><span class="line">        UsernamePasswordToken usernamePasswordToken = <span class="keyword">new</span> UsernamePasswordToken(<span class="string">&quot;jay&quot;</span>, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="comment">//登录操作</span></span><br><span class="line">        subject.login(usernamePasswordToken);</span><br><span class="line">        System.out.println(<span class="string">&quot;是否登录成功：&quot;</span> + subject.isAuthenticated());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h6><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205729.png" alt="1580049504816"></p>
<h5 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、权限定义：ini文件</span><br><span class="line">2、加载过程:</span><br><span class="line">	导入权限ini文件构建权限工厂</span><br><span class="line">	工厂构建安全管理器</span><br><span class="line">	使用SecurityUtils工具生效安全管理器</span><br><span class="line">	使用SecurityUtils工具获得主体</span><br><span class="line">	使构建账号token用SecurityUtils工具获得主体</span><br><span class="line">	构建账号token</span><br><span class="line">	登录操作</span><br></pre></td></tr></table></figure>

<h3 id="Realm"><a href="#Realm" class="headerlink" title="Realm"></a>Realm</h3><h4 id="Realm接口"><a href="#Realm接口" class="headerlink" title="Realm接口"></a>Realm接口</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205733.png" alt="1580050317405"></p>
<p>所以，一般在真实的项目中，我们不会直接实现Realm接口，我们一般的情况就是直接继承AuthorizingRealm，能够继承到认证与授权功能。它需要强制重写两个方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefinitionRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@Description</span> 认证</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> authcToken token对象</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authcToken)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@Description</span> 鉴权</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> principals 令牌</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="自定义Realm"><a href="#自定义Realm" class="headerlink" title="自定义Realm"></a>自定义Realm</h4><h5 id="需求-1"><a href="#需求-1" class="headerlink" title="需求"></a>需求</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、自定义Realm，取得密码用于比较</span><br></pre></td></tr></table></figure>

<h5 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h5><h6 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h6><p>shiro-day01-02realm</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205736.png" alt="1580107180701"></p>
<h6 id="定义SecurityService"><a href="#定义SecurityService" class="headerlink" title="定义SecurityService"></a>定义SecurityService</h6><p>SecurityService</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：权限服务接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SecurityService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查找密码按用户登录名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loginName 登录名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">findPasswordByLoginName</span><span class="params">(String loginName)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>SecurityServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.SecurityService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：权限服务层</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityServiceImpl</span> <span class="keyword">implements</span> <span class="title">SecurityService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findPasswordByLoginName</span><span class="params">(String loginName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;123&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="定义DefinitionRealm"><a href="#定义DefinitionRealm" class="headerlink" title="定义DefinitionRealm"></a>定义DefinitionRealm</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.realm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.SecurityService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.impl.SecurityServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：声明自定义realm</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefinitionRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 认证接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token 传递登录token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        <span class="comment">//从AuthenticationToken中获得登录名称</span></span><br><span class="line">        String loginName = (String) token.getPrincipal();</span><br><span class="line">        SecurityService securityService = <span class="keyword">new</span> SecurityServiceImpl();</span><br><span class="line">        String password = securityService.findPasswordByLoginName(loginName);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(password)||password==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(<span class="string">&quot;账户不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//传递账号和密码</span></span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">new</span> SimpleAuthenticationInfo(loginName,password,getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="编辑shiro-ini"><a href="#编辑shiro-ini" class="headerlink" title="编辑shiro.ini"></a>编辑shiro.ini</h6><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment">#声明自定义的realm，且为安全管理器指定realms</span></span><br><span class="line"><span class="section">[main]</span></span><br><span class="line"><span class="attr">definitionRealm</span>=com.itheima.shiro.realm.DefinitionRealm</span><br><span class="line"><span class="attr">securityManager.realms</span>=<span class="variable">$definitionRealm</span></span><br><span class="line"><span class="comment">#声明用户账号</span></span><br><span class="line"><span class="comment">#[users]</span></span><br><span class="line"><span class="comment">#jay=123</span></span><br></pre></td></tr></table></figure>

<h4 id="认证源码跟踪"><a href="#认证源码跟踪" class="headerlink" title="认证源码跟踪"></a>认证源码跟踪</h4><p>（1）通过debug模式追踪源码subject.login(token) 发现。首先是进入Subject接口的默认实现类。果然，Subject将用户的用户名密码委托给了securityManager去做。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205741.png" alt="1580107715689"></p>
<p>（2）然后，securityManager说：“卧槽，认证器authenticator小弟，听说你的大学学的专业就是认证呀，那么这个认证的任务就交给你咯”。遂将用户的token委托给内部认证组件authenticator去做</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205749.png" alt="1580107767167"></p>
<p>（3）事实上，securityManager的内部组件一个比一个懒。内部认证组件authenticator说：“你们传过来的token我需要拿去跟数据源Realm做对比，这样吧，这个光荣的任务就交给Realm你去做吧”。Realm对象：“一群大懒虫！”。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205754.png" alt="1580107849133"></p>
<p>（4）Realm在接到内部认证组件authenticator组件后很伤心，最后对电脑前的你说：“大兄弟，对不住了，你去实现一下呗”。从图中的方法体中可以看到，当前对象是Realm类对象，即将调用的方法是doGetAuthenticationInfo(token)。而这个方法，就是你即将要重写的方法。如果帐号密码通过了，那么返回一个认证成功的info凭证。如果认证失败，抛出一个异常就好了。你说：“什么?最终还是劳资来认证？”没错，就是苦逼的你去实现了，谁叫你是程序猿呢。所以，你不得不查询一下数据库，重写doGetAuthenticationInfo方法，查出来正确的帐号密码，返回一个正确的凭证info<br><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205758.png" alt="1580108004686"></p>
<p>（5）好了，这个时候你自己编写了一个类，继承了AuthorizingRealm，并实现了上述doGetAuthenticationInfo方法。你在doGetAuthenticationInfo中编写了查询数据库的代码，并将数据库中存放的用户名与密码封装成了一个AuthenticationInfo对象返回。可以看到下图中，info这个对象是有值的，说明从数据库中查询出来了正确的帐号密码</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205801.png" alt="1580108049930"></p>
<p>（6）那么，接下来就很简单了。把用户输入的帐号密码与刚才你从数据库中查出来的帐号密码对比一下即可。token封装着用户的帐号密码，AuthenticationInfo封装着从数据库中查询出来的帐号密码。再往下追踪一下代码，最终到了下图中的核心区域。如果没有报异常，说明本次登录成功。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205804.png" alt="1580192296050"></p>
<h3 id="编码、散列算法"><a href="#编码、散列算法" class="headerlink" title="编码、散列算法"></a>编码、散列算法</h3><h4 id="编码与解码"><a href="#编码与解码" class="headerlink" title="编码与解码"></a>编码与解码</h4><p>Shiro提供了base64和16进制字符串编码/解码的API支持，方便一些编码解码操作。</p>
<p>Shiro内部的一些数据的【存储/表示】都使用了base64和16进制字符串</p>
<h5 id="需求-2"><a href="#需求-2" class="headerlink" title="需求"></a>需求</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">理解base64和16进制字符串编码/解码</span><br></pre></td></tr></table></figure>

<h5 id="新建项目-1"><a href="#新建项目-1" class="headerlink" title="新建项目"></a>新建项目</h5><p>新建shiro-day01-03encode-decode</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205808.png" alt="1580196809749"></p>
<h5 id="新建EncodesUtil"><a href="#新建EncodesUtil" class="headerlink" title="新建EncodesUtil"></a>新建EncodesUtil</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.tools;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.codec.Base64;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.codec.Hex;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：封装base64和16进制编码解码工具类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EncodesUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> HEX-byte[]--String转换</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input 输入数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encodeHex</span><span class="params">(<span class="keyword">byte</span>[] input)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Hex.encodeToString(input);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> HEX-String--byte[]转换</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input 输入字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> byte数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] decodeHex(String input)&#123;</span><br><span class="line">        <span class="keyword">return</span> Hex.decode(input);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> Base64-byte[]--String转换</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input 输入数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encodeBase64</span><span class="params">(<span class="keyword">byte</span>[] input)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Base64.encodeToString(input);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> Base64-String--byte[]转换</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input 输入字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> byte数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] decodeBase64(String input)&#123;</span><br><span class="line">        <span class="keyword">return</span> Base64.decode(input);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="新建ClientTest"><a href="#新建ClientTest" class="headerlink" title="新建ClientTest"></a>新建ClientTest</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.tools.EncodesUtil;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：测试</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 测试16进制编码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHex</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String val = <span class="string">&quot;holle&quot;</span>;</span><br><span class="line">        String flag = EncodesUtil.encodeHex(val.getBytes());</span><br><span class="line">        String valHandler = <span class="keyword">new</span> String(EncodesUtil.decodeHex(flag));</span><br><span class="line">        System.out.println(<span class="string">&quot;比较结果：&quot;</span>+val.equals(valHandler));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 测试base64编码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBase64</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String val = <span class="string">&quot;holle&quot;</span>;</span><br><span class="line">        String flag = EncodesUtil.encodeBase64(val.getBytes());</span><br><span class="line">        String valHandler = <span class="keyword">new</span> String(EncodesUtil.decodeBase64(flag));</span><br><span class="line">        System.out.println(<span class="string">&quot;比较结果：&quot;</span>+val.equals(valHandler));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、shiro目前支持的编码与解码：</span><br><span class="line">	base64</span><br><span class="line">   （HEX）16进制字符串</span><br><span class="line">2、那么shiro的编码与解码什么时候使用呢？又是怎么使用的呢？</span><br></pre></td></tr></table></figure>

<h4 id="散列算法"><a href="#散列算法" class="headerlink" title="散列算法"></a>散列算法</h4><p>散列算法一般用于生成数据的摘要信息，是一种不可逆的算法，一般适合存储密码之类的数据，常见的散列算法如MD5、SHA等。一般进行散列时最好提供一个salt（盐），比如加密密码“admin”，产生的散列值是“21232f297a57a5a743894a0e4a801fc3”，可以到一些md5解密网站很容易的通过散列值得到密码“admin”，即如果直接对密码进行散列相对来说破解更容易，此时我们可以加一些只有系统知道的干扰数据，如salt（即盐）；这样散列的对象是“密码+salt”，这样生成的散列值相对来说更难破解。</p>
<p>shiro支持的散列算法：</p>
<p>Md2Hash、Md5Hash、Sha1Hash、Sha256Hash、Sha384Hash、Sha512Hash</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205814.png" alt="1580277706466"></p>
<h5 id="新增DigestsUtil"><a href="#新增DigestsUtil" class="headerlink" title="新增DigestsUtil"></a>新增DigestsUtil</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.tools;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.generic.NEW;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.SecureRandomNumberGenerator;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.hash.SimpleHash;</span><br><span class="line"><span class="keyword">import</span> sun.security.util.Password;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：摘要</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DigestsUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SHA1 = <span class="string">&quot;SHA-1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer ITERATIONS =<span class="number">512</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> sha1方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input 需要散列字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> salt 盐字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">sha1</span><span class="params">(String input, String salt)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SimpleHash(SHA1, input, salt,ITERATIONS).toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 随机获得salt字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">generateSalt</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SecureRandomNumberGenerator randomNumberGenerator = <span class="keyword">new</span> SecureRandomNumberGenerator();</span><br><span class="line">        <span class="keyword">return</span> randomNumberGenerator.nextBytes().toHex();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 生成密码字符密文和salt密文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String,String&gt; <span class="title">entryptPassword</span><span class="params">(String passwordPlain)</span> </span>&#123;</span><br><span class="line">       Map&lt;String,String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">       String salt = generateSalt();</span><br><span class="line">       String password =sha1(passwordPlain,salt);</span><br><span class="line">       map.put(<span class="string">&quot;salt&quot;</span>, salt);</span><br><span class="line">       map.put(<span class="string">&quot;password&quot;</span>, password);</span><br><span class="line">       <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="新增ClientTest"><a href="#新增ClientTest" class="headerlink" title="新增ClientTest"></a>新增ClientTest</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.tools.DigestsUtil;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.tools.EncodesUtil;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：测试</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 测试16进制编码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHex</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String val = <span class="string">&quot;holle&quot;</span>;</span><br><span class="line">        String flag = EncodesUtil.encodeHex(val.getBytes());</span><br><span class="line">        String valHandler = <span class="keyword">new</span> String(EncodesUtil.decodeHex(flag));</span><br><span class="line">        System.out.println(<span class="string">&quot;比较结果：&quot;</span>+val.equals(valHandler));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 测试base64编码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBase64</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String val = <span class="string">&quot;holle&quot;</span>;</span><br><span class="line">        String flag = EncodesUtil.encodeBase64(val.getBytes());</span><br><span class="line">        String valHandler = <span class="keyword">new</span> String(EncodesUtil.decodeBase64(flag));</span><br><span class="line">        System.out.println(<span class="string">&quot;比较结果：&quot;</span>+val.equals(valHandler));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDigestsUtil</span><span class="params">()</span></span>&#123;</span><br><span class="line">       Map&lt;String,String&gt; map =  DigestsUtil.entryptPassword(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;获得结果：&quot;</span>+map.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="Realm使用散列算法"><a href="#Realm使用散列算法" class="headerlink" title="Realm使用散列算法"></a>Realm使用散列算法</h3><p>上面我们了解编码，以及散列算法，那么在realm中怎么使用？在shiro-day01-02realm中我们使用的密码是明文的校验方式，也就是SecurityServiceImpl中findPasswordByLoginName返回的是明文123的密码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.SecurityService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：权限服务层</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityServiceImpl</span> <span class="keyword">implements</span> <span class="title">SecurityService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findPasswordByLoginName</span><span class="params">(String loginName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;123&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="新建项目-2"><a href="#新建项目-2" class="headerlink" title="新建项目"></a>新建项目</h4><p>shiro-day01-05-ciphertext-realm</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205821.png" alt="1580281644492"></p>
<h4 id="创建密文密码"><a href="#创建密文密码" class="headerlink" title="创建密文密码"></a>创建密文密码</h4><p>使用ClientTest的testDigestsUtil创建密码为“123”的password密文和salt密文</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">password:56265d624e484ca62c6dfbc523e6d6fc7932d0d5</span><br><span class="line">salt:845a66ac80174c0e486db9354cf84f9a</span><br></pre></td></tr></table></figure>

<h4 id="修改SecurityService"><a href="#修改SecurityService" class="headerlink" title="修改SecurityService"></a>修改SecurityService</h4><p>SecurityService修改成返回salt和password的map</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：权限服务接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SecurityService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查找密码按用户登录名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loginName 登录名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Map&lt;String,String&gt; <span class="title">findPasswordByLoginName</span><span class="params">(String loginName)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.SecurityService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：权限服务层</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityServiceImpl</span> <span class="keyword">implements</span> <span class="title">SecurityService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,String&gt; <span class="title">findPasswordByLoginName</span><span class="params">(String loginName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//模拟数据库中存储的密文信息</span></span><br><span class="line">       <span class="keyword">return</span>  DigestsUtil.entryptPassword(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="指定密码匹配方式"><a href="#指定密码匹配方式" class="headerlink" title="指定密码匹配方式"></a>指定密码匹配方式</h4><p>为DefinitionRealm类添加构造方法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 构造函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefinitionRealm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//指定密码匹配方式为sha1</span></span><br><span class="line">    HashedCredentialsMatcher matcher = <span class="keyword">new</span> HashedCredentialsMatcher(DigestsUtil.SHA1);</span><br><span class="line">    <span class="comment">//指定密码迭代次数</span></span><br><span class="line">    matcher.setHashIterations(DigestsUtil.ITERATIONS);</span><br><span class="line">    <span class="comment">//使用父亲方法使匹配方式生效</span></span><br><span class="line">    setCredentialsMatcher(matcher);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改DefinitionRealm类的认证doGetAuthenticationInfo方法如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 认证接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token 传递登录token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    <span class="comment">//从AuthenticationToken中获得登录名称</span></span><br><span class="line">    String loginName = (String) token.getPrincipal();</span><br><span class="line">    SecurityService securityService = <span class="keyword">new</span> SecurityServiceImpl();</span><br><span class="line">    Map&lt;String, String&gt; map = securityService.findPasswordByLoginName(loginName);</span><br><span class="line">    <span class="keyword">if</span> (map.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(<span class="string">&quot;账户不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    String salt = map.get(<span class="string">&quot;salt&quot;</span>);</span><br><span class="line">    String password = map.get(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">    <span class="comment">//传递账号和密码:参数1：缓存对象，参数2：明文密码，参数三：字节salt,参数4：当前DefinitionRealm名称</span></span><br><span class="line">    <span class="keyword">return</span>  <span class="keyword">new</span> SimpleAuthenticationInfo(loginName,password, ByteSource.Util.bytes(salt),getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210823.png" alt="1580282597761"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210819.png" alt="1580282723275"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210815.png" alt="1580282829816"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210811.png" alt="1580282869315"></p>
<h3 id="身份授权"><a href="#身份授权" class="headerlink" title="身份授权"></a>身份授权</h3><h4 id="基本流程-1"><a href="#基本流程-1" class="headerlink" title="基本流程"></a>基本流程</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210806.png" alt="1580284991759"></p>
<p>1、首先调用Subject.isPermitted/hasRole接口，其会委托给SecurityManager。</p>
<p>2、SecurityManager接着会委托给内部组件Authorizer；</p>
<p>3、Authorizer再将其请求委托给我们的Realm去做；Realm才是真正干活的；</p>
<p>4、Realm将用户请求的参数封装成权限对象。再从我们重写的doGetAuthorizationInfo方法中获取从数据库中查询到的权限集合。</p>
<p>5、Realm将用户传入的权限对象，与从数据库中查出来的权限对象，进行一一对比。如果用户传入的权限对象在从数据库中查出来的权限对象中，则返回true，否则返回false。</p>
<p>进行授权操作的前提：用户必须通过认证。</p>
<p>在真实的项目中，角色与权限都存放在数据库中。为了快速上手，我们先创建一个自定义DefinitionRealm，模拟它已经登录成功。直接返回一个登录验证凭证，告诉Shiro框架，我们从数据库中查询出来的密码是也是就是你输入的密码。所以，不管用户输入什么，本次登录验证都是通过的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 认证接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token 传递登录token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    <span class="comment">//从AuthenticationToken中获得登录名称</span></span><br><span class="line">    String loginName = (String) token.getPrincipal();</span><br><span class="line">    SecurityService securityService = <span class="keyword">new</span> SecurityServiceImpl();</span><br><span class="line">    Map&lt;String, String&gt; map = securityService.findPasswordByLoginName(loginName);</span><br><span class="line">    <span class="keyword">if</span> (map.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(<span class="string">&quot;账户不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    String salt = map.get(<span class="string">&quot;salt&quot;</span>);</span><br><span class="line">    String password = map.get(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">    <span class="comment">//传递账号和密码:参数1：用户认证凭证信息，参数2：明文密码，参数三：字节salt,参数4：当前DefinitionRealm名称</span></span><br><span class="line">    <span class="keyword">return</span>  <span class="keyword">new</span> SimpleAuthenticationInfo(loginName,password, ByteSource.Util.bytes(salt),getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好了，接下来，我们要重写我们本小节的核心方法了。在DefinitionRealm中找到下列方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此方法的传入的参数PrincipalCollection  principals，是一个包装对象，它表示”用户认证凭证信息”。包装的是谁呢？没错，就是认证doGetAuthenticationInfo（）方法的返回值的第一个参数loginName。你可以通过这个包装对象的getPrimaryPrincipal（）方法拿到此值,然后再从数据库中拿到对应的角色和资源，构建SimpleAuthorizationInfo。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 授权方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//拿到用户认证凭证信息</span></span><br><span class="line">    String loginName = (String) principals.getPrimaryPrincipal();</span><br><span class="line">    <span class="comment">//从数据库中查询对应的角色和资源</span></span><br><span class="line">    SecurityService securityService = <span class="keyword">new</span> SecurityServiceImpl();</span><br><span class="line">    List&lt;String&gt; roles = securityService.findRoleByloginName(loginName);</span><br><span class="line">    List&lt;String&gt; permissions = securityService.findPermissionByloginName(loginName);</span><br><span class="line">    <span class="comment">//构建资源校验</span></span><br><span class="line">    SimpleAuthorizationInfo authorizationInfo = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">    authorizationInfo.addRoles(roles);</span><br><span class="line">    authorizationInfo.addStringPermissions(permissions);</span><br><span class="line">    <span class="keyword">return</span> authorizationInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="案例演示-1"><a href="#案例演示-1" class="headerlink" title="案例演示"></a>案例演示</h4><h5 id="需求-3"><a href="#需求-3" class="headerlink" title="需求"></a>需求</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、实现doGetAuthorizationInfo方法实现鉴权</span><br><span class="line">2、使用subject类实现权限的校验</span><br></pre></td></tr></table></figure>

<h5 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h5><h6 id="创建项目-1"><a href="#创建项目-1" class="headerlink" title="创建项目"></a>创建项目</h6><p>拷贝shiro-day01-05-ciphertext-realm新建shiro-day01-06-authentication-realm</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210801.png" alt="1580367506898"></p>
<h6 id="编写SecurityService"><a href="#编写SecurityService" class="headerlink" title="编写SecurityService"></a>编写SecurityService</h6><p>在SecurityService中添加</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> 	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查找角色按用户登录名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  loginName 登录名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function">List&lt;String&gt; <span class="title">findRoleByloginName</span><span class="params">(String loginName)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查找资源按用户登录名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  loginName 登录名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function">List&lt;String&gt;  <span class="title">findPermissionByloginName</span><span class="params">(String loginName)</span></span>;</span><br></pre></td></tr></table></figure>

<p>SecurityServiceImpl添加实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findRoleByloginName</span><span class="params">(String loginName)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    list.add(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;dev&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt;  <span class="title">findPermissionByloginName</span><span class="params">(String loginName)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    list.add(<span class="string">&quot;order:add&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;order:list&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;order:del&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="编写DefinitionRealm"><a href="#编写DefinitionRealm" class="headerlink" title="编写DefinitionRealm"></a>编写DefinitionRealm</h6><p>在DefinitionRealm中修改doGetAuthorizationInfo方法如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@Description</span> 授权方法</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//拿到用户认证凭证信息</span></span><br><span class="line">    String loginName = (String) principals.getPrimaryPrincipal();</span><br><span class="line">    <span class="comment">//从数据库中查询对应的角色和资源</span></span><br><span class="line">    SecurityService securityService = <span class="keyword">new</span> SecurityServiceImpl();</span><br><span class="line">    List&lt;String&gt; roles = securityService.findRoleByloginName(loginName);</span><br><span class="line">    List&lt;String&gt; permissions = securityService.findPermissionByloginName(loginName);</span><br><span class="line">    <span class="comment">//构建资源校验</span></span><br><span class="line">    SimpleAuthorizationInfo authorizationInfo = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">    authorizationInfo.addRoles(roles);</span><br><span class="line">    authorizationInfo.addStringPermissions(permissions);</span><br><span class="line">    <span class="keyword">return</span> authorizationInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="编写HelloShiro-1"><a href="#编写HelloShiro-1" class="headerlink" title="编写HelloShiro"></a>编写HelloShiro</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.config.IniSecurityManagerFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.Factory;</span><br><span class="line"><span class="keyword">import</span> org.junit.Assert;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：shiro的第一个例子</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloShiro</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPermissionRealm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Subject subject = shiroLogin(<span class="string">&quot;jay&quot;</span>, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="comment">//判断用户是否已经登录</span></span><br><span class="line">        System.out.println(<span class="string">&quot;是否登录成功：&quot;</span> + subject.isAuthenticated());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//---------检查当前用户的角色信息------------</span></span><br><span class="line">        System.out.println(<span class="string">&quot;是否有管理员角色：&quot;</span>+subject.hasRole(<span class="string">&quot;admin&quot;</span>));</span><br><span class="line">        <span class="comment">//---------如果当前用户有此角色，无返回值。若没有此权限，则抛 UnauthorizedException------------</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            subject.checkRole(<span class="string">&quot;coder&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;有coder角色&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;没有coder角色&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//---------检查当前用户的权限信息------------</span></span><br><span class="line">        System.out.println(<span class="string">&quot;是否有查看订单列表资源：&quot;</span>+subject.isPermitted(<span class="string">&quot;order:list&quot;</span>));</span><br><span class="line">        <span class="comment">//---------如果当前用户有此权限，无返回值。若没有此权限，则抛 UnauthorizedException------------</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            subject.checkPermissions(<span class="string">&quot;order:add&quot;</span>, <span class="string">&quot;order:del&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;有添加和删除订单资源&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;没有有添加和删除订单资源&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 登录方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Subject <span class="title">shiroLogin</span><span class="params">(String loginName,String password)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//导入权限ini文件构建权限工厂</span></span><br><span class="line">        Factory&lt;SecurityManager&gt; factory = <span class="keyword">new</span> IniSecurityManagerFactory(<span class="string">&quot;classpath:shiro.ini&quot;</span>);</span><br><span class="line">        <span class="comment">//工厂构建安全管理器</span></span><br><span class="line">        SecurityManager securityManager = factory.getInstance();</span><br><span class="line">        <span class="comment">//使用SecurityUtils工具生效安全管理器</span></span><br><span class="line">        SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line">        <span class="comment">//使用SecurityUtils工具获得主体</span></span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        <span class="comment">//构建账号token</span></span><br><span class="line">        UsernamePasswordToken usernamePasswordToken = <span class="keyword">new</span> UsernamePasswordToken(loginName, password);</span><br><span class="line">        <span class="comment">//登录操作</span></span><br><span class="line">        subject.login(usernamePasswordToken);</span><br><span class="line">        <span class="keyword">return</span> subject;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="授权源码追踪"><a href="#授权源码追踪" class="headerlink" title="授权源码追踪"></a>授权源码追踪</h5><p>（1）客户端调用 subject.hasRole(“admin”)，判断当前用户是否有”admin”角色权限。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210753.png" alt="1580368931926"></p>
<p>(2）Subject门面对象接收到要被验证的角色信息”admin”，并将其委托给securityManager中验证。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210747.png" alt="1580368995672"></p>
<p>(3）securityManager将验证请求再次委托给内部的小弟：内部组件Authorizer authorizer</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210744.png" alt="1580369087293"></p>
<p>(4)内部小弟authorizer也是个混子，将其委托给了我们自定义的Realm去做</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210740.png" alt="1580369205937"></p>
<p>   （5） 先拿到PrincipalCollection principal对象，同时传入校验的角色循环校验,循环中先创建鉴权信息</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210735.png" alt="1580369895496"></p>
<p>（6）先看缓存中是否已经有鉴权信息</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210727.png" alt="1580369979541"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210723.png" alt="1580370086849"></p>
<p>(7)都是一群懒货！！最后干活的还是我这个猴子！</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210719.png" alt="1580370172670"></p>
<h4 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、鉴权需要实现doGetAuthorizationInfo方法</span><br><span class="line">2、鉴权使用门面subject中方法进行鉴权</span><br><span class="line">	以check开头的会抛出异常</span><br><span class="line">	以is和has开头会返回布尔值</span><br></pre></td></tr></table></figure>



<h2 id="Web项目集成Shiro"><a href="#Web项目集成Shiro" class="headerlink" title="Web项目集成Shiro"></a>Web项目集成Shiro</h2><h3 id="Web集成原理分析"><a href="#Web集成原理分析" class="headerlink" title="Web集成原理分析"></a>Web集成原理分析</h3><h4 id="web集成的配置"><a href="#web集成的配置" class="headerlink" title="web集成的配置"></a>web集成的配置</h4><p>还记得吗，以前我们在没有与WEB环境进行集成的时候，为了生成SecurityManager对象，是通过手动读取配置文件生成工厂对象，再通过工厂对象获取到SecurityManager的。就像下面代码展示的那样</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@Description</span> 登录方法</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Subject <span class="title">shiroLogin</span><span class="params">(String loginName,String password)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//导入权限ini文件构建权限工厂</span></span><br><span class="line">    Factory&lt;SecurityManager&gt; factory = <span class="keyword">new</span> IniSecurityManagerFactory(<span class="string">&quot;classpath:shiro.ini&quot;</span>);</span><br><span class="line">    <span class="comment">//工厂构建安全管理器</span></span><br><span class="line">    SecurityManager securityManager = factory.getInstance();</span><br><span class="line">    <span class="comment">//使用SecurityUtils工具生效安全管理器</span></span><br><span class="line">    SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line">    <span class="comment">//使用SecurityUtils工具获得主体</span></span><br><span class="line">    Subject subject = SecurityUtils.getSubject();</span><br><span class="line">    <span class="comment">//构建账号token</span></span><br><span class="line">    UsernamePasswordToken usernamePasswordToken = <span class="keyword">new</span> UsernamePasswordToken(loginName, password);</span><br><span class="line">    <span class="comment">//登录操作</span></span><br><span class="line">    subject.login(usernamePasswordToken);</span><br><span class="line">    <span class="keyword">return</span> subject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过，现在我们既然说要与WEB集成，那么首先要做的事情就是把我们的shiro.ini这个配置文件交付到WEB环境中，定义shiro.ini文件如下</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment">#声明自定义的realm，且为安全管理器指定realms</span></span><br><span class="line"><span class="section">[main]</span></span><br><span class="line"><span class="attr">definitionRealm</span>=com.itheima.shiro.realm.DefinitionRealm</span><br><span class="line"><span class="attr">securityManager.realms</span>=<span class="variable">$definitionRealm</span></span><br></pre></td></tr></table></figure>

<h5 id="新建项目-3"><a href="#新建项目-3" class="headerlink" title="新建项目"></a>新建项目</h5><p>新建web项目shiro-day01-07web,其中realm、service、resources内容从shiro-day01-06authentication-realm中拷贝即可</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210714.png" alt="1580538893171"></p>
<h5 id="pom-xml配置"><a href="#pom-xml配置" class="headerlink" title="pom.xml配置"></a>pom.xml配置</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-day01-07web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>shiro-day01-07web Maven Webapp<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- FIXME change it to the project&#x27;s website --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://www.example.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- tomcat7插件,命令： mvn tomcat7:run -DskipTests --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">uriEncoding</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">uriEncoding</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">path</span>&gt;</span>/platform<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!-- compiler插件, 设定JDK版本 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">showWarnings</span>&gt;</span>true<span class="tag">&lt;/<span class="name">showWarnings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="web-xml配置"><a href="#web-xml配置" class="headerlink" title="web.xml配置"></a>web.xml配置</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;3.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>shiro-day01-07web<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 初始化SecurityManager对象所需要的环境--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>shiroEnvironmentClass<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>org.apache.shiro.web.env.IniWebEnvironment<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 指定Shiro的配置文件的位置 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>shiroConfigLocations<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:shiro.ini<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 监听服务器启动时，创建shiro的web环境。</span></span><br><span class="line"><span class="comment">       即加载shiroEnvironmentClass变量指定的IniWebEnvironment类--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.apache.shiro.web.env.EnvironmentLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- shiro的l过滤入口，过滤一切请求 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.apache.shiro.web.servlet.ShiroFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 过滤所有请求 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="SecurityManager对象创建"><a href="#SecurityManager对象创建" class="headerlink" title="SecurityManager对象创建"></a>SecurityManager对象创建</h4><p>上面我们集成shiro到web项目了，下面我们来追踪下源码，看下SecurityManager对象是如何创建的</p>
<p>（1）我启动了服务器，监听器捕获到了服务器启动事件。我现在所处的位置EnvironmentLoaderListener监听器的入口处</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210707.png" alt="1580539365062"></p>
<p>（2）进入方法内查看，它先根据我们的shiroEnvironmentClass变量的值org.apache.shiro.web.env.IniWebEnvironment，初始化一个shiro环境对象</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210702.png" alt="1580539658469"></p>
<p>（3）最后在创建一个SecurityManager对象，再将其绑定到刚才通过字节码创建的Shiro环境对象中</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210658.png" alt="1580540126770"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210652.png" alt="1580540180066"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210648.png" alt="1580540218911"></p>
<p>到这来SecurityManager就完成了初始化</p>
<h3 id="Shiro默认过滤器"><a href="#Shiro默认过滤器" class="headerlink" title="Shiro默认过滤器"></a>Shiro默认过滤器</h3><p>Shiro内置了很多默认的过滤器，比如身份验证、授权等相关的。默认过滤器可以参考org.apache.shiro.web.filter.mgt.DefaultFilter中的枚举过滤器</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210643.png" alt="1580542509773"></p>
<h4 id="认证相关"><a href="#认证相关" class="headerlink" title="认证相关"></a>认证相关</h4><table>
<thead>
<tr>
<th>过滤器</th>
<th>过滤器类</th>
<th>说明</th>
<th>默认</th>
</tr>
</thead>
<tbody><tr>
<td>authc</td>
<td>FormAuthenticationFilter</td>
<td>基于表单的过滤器；如“/**=authc”，如果没有登录会跳到相应的登录页面登录</td>
<td>无</td>
</tr>
<tr>
<td>logout</td>
<td>LogoutFilter</td>
<td>退出过滤器，主要属性：redirectUrl：退出成功后重定向的地址，如“/logout=logout”</td>
<td>/</td>
</tr>
<tr>
<td>anon</td>
<td>AnonymousFilter</td>
<td>匿名过滤器，即不需要登录即可访问；一般用于静态资源过滤；示例“/static/**=anon”</td>
<td>无</td>
</tr>
</tbody></table>
<h4 id="授权相关"><a href="#授权相关" class="headerlink" title="授权相关"></a>授权相关</h4><table>
<thead>
<tr>
<th>过滤器</th>
<th>过滤器类</th>
<th>说明</th>
<th>默认</th>
</tr>
</thead>
<tbody><tr>
<td>roles</td>
<td>RolesAuthorizationFilter</td>
<td>角色授权拦截器，验证用户是否拥有所有角色；主要属性： loginUrl：登录页面地址（/login.jsp）；unauthorizedUrl：未授权后重定向的地址；示例“/admin/**=roles[admin]”</td>
<td>无</td>
</tr>
<tr>
<td>perms</td>
<td>PermissionsAuthorizationFilter</td>
<td>权限授权拦截器，验证用户是否拥有所有权限；属性和roles一样；示例“/user/**=perms[“user:create”]”</td>
<td>无</td>
</tr>
<tr>
<td>port</td>
<td>PortFilter</td>
<td>端口拦截器，主要属性：port（80）：可以通过的端口；示例“/test= port[80]”，如果用户访问该页面是非80，将自动将请求端口改为80并重定向到该80端口，其他路径/参数等都一样</td>
<td>无</td>
</tr>
<tr>
<td>rest</td>
<td>HttpMethodPermissionFilter</td>
<td>rest风格拦截器，自动根据请求方法构建权限字符串（GET=read, POST=create,PUT=update,DELETE=delete,HEAD=read,TRACE=read,OPTIONS=read, MKCOL=create）构建权限字符串；示例“/users=rest[user]”，会自动拼出“user:read,user:create,user:update,user:delete”权限字符串进行权限匹配（所有都得匹配，isPermittedAll）</td>
<td>无</td>
</tr>
<tr>
<td>ssl</td>
<td>SslFilter</td>
<td>SSL拦截器，只有请求协议是https才能通过；否则自动跳转会https端口（443）；其他和port拦截器一样；</td>
<td>无</td>
</tr>
</tbody></table>
<h3 id="Web集成完整案例"><a href="#Web集成完整案例" class="headerlink" title="Web集成完整案例"></a>Web集成完整案例</h3><p>基于shiro-day01-07web继续集成</p>
<h4 id="编写pom-xml"><a href="#编写pom-xml" class="headerlink" title="编写pom.xml"></a>编写pom.xml</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-day01-07web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>shiro-day01-07web Maven Webapp<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- FIXME change it to the project&#x27;s website --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://www.example.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>taglibs<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>standard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- tomcat7插件,命令： mvn tomcat7:run -DskipTests --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">uriEncoding</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">uriEncoding</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">path</span>&gt;</span>/platform<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!-- compiler插件, 设定JDK版本 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">showWarnings</span>&gt;</span>true<span class="tag">&lt;/<span class="name">showWarnings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="编写shiro-ini文件"><a href="#编写shiro-ini文件" class="headerlink" title="编写shiro.ini文件"></a>编写shiro.ini文件</h4><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment">#声明自定义的realm，且为安全管理器指定realms</span></span><br><span class="line"><span class="section">[main]</span></span><br><span class="line"><span class="attr">definitionRealm</span>=com.itheima.shiro.realm.DefinitionRealm</span><br><span class="line"><span class="attr">securityManager.realms</span>=<span class="variable">$definitionRealm</span></span><br><span class="line"><span class="comment">#用户退出后跳转指定JSP页面</span></span><br><span class="line"><span class="attr">logout.redirectUrl</span>=/login.jsp</span><br><span class="line"><span class="comment">#若没有登录，则被authc过滤器重定向到login.jsp页面</span></span><br><span class="line"><span class="attr">authc.loginUrl</span> = /login.jsp</span><br><span class="line"><span class="section">[urls]</span></span><br><span class="line">/<span class="attr">login</span>=anon</span><br><span class="line"><span class="comment">#发送/home请求需要先登录</span></span><br><span class="line">/<span class="attr">home</span>= authc</span><br><span class="line"><span class="comment">#发送/order/list请求需要先登录</span></span><br><span class="line">/<span class="attr">order-list</span> = roles[admin]</span><br><span class="line"><span class="comment">#提交代码需要order:add权限</span></span><br><span class="line">/<span class="attr">order-add</span> = perms[<span class="string">&quot;order:add&quot;</span>]</span><br><span class="line"><span class="comment">#更新代码需要order:del权限</span></span><br><span class="line">/<span class="attr">order-del</span> = perms[<span class="string">&quot;order:del&quot;</span>]</span><br><span class="line"><span class="comment">#发送退出请求则用退出过滤器</span></span><br><span class="line">/<span class="attr">logout</span> = logout</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="编写LoginService"><a href="#编写LoginService" class="headerlink" title="编写LoginService"></a>编写LoginService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.management.LockInfo;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：登录服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoginService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 登录方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token 登录对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">login</span><span class="params">(UsernamePasswordToken token)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 登出方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">logout</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.LoginService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：登录服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginServiceImpl</span> <span class="keyword">implements</span> <span class="title">LoginService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">login</span><span class="params">(UsernamePasswordToken token)</span> </span>&#123;</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            subject.login(token);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> subject.isAuthenticated();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        subject.logout();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="编写SecurityServiceImpl"><a href="#编写SecurityServiceImpl" class="headerlink" title="编写SecurityServiceImpl"></a>编写SecurityServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.SecurityService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：权限服务层</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityServiceImpl</span> <span class="keyword">implements</span> <span class="title">SecurityService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,String&gt; <span class="title">findPasswordByLoginName</span><span class="params">(String loginName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DigestsUtil.entryptPassword(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findRoleByloginName</span><span class="params">(String loginName)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;admin&quot;</span>.equals(loginName))&#123;</span><br><span class="line">            list.add(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        list.add(<span class="string">&quot;dev&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt;  <span class="title">findPermissionByloginName</span><span class="params">(String loginName)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;jay&quot;</span>.equals(loginName))&#123;</span><br><span class="line">            list.add(<span class="string">&quot;order:list&quot;</span>);</span><br><span class="line">            list.add(<span class="string">&quot;order:add&quot;</span>);</span><br><span class="line">            list.add(<span class="string">&quot;order:del&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="添加web层内容"><a href="#添加web层内容" class="headerlink" title="添加web层内容"></a>添加web层内容</h4><h5 id="LoginServlet"><a href="#LoginServlet" class="headerlink" title="LoginServlet"></a>LoginServlet</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.LoginService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.impl.LoginServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：登录方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">//获取输入的帐号密码</span></span><br><span class="line">        String username = req.getParameter(<span class="string">&quot;loginName&quot;</span>);</span><br><span class="line">        String password = req.getParameter(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">        <span class="comment">//封装用户数据，成为Shiro能认识的token标识</span></span><br><span class="line">        UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(username, password);</span><br><span class="line">        LoginService loginService = <span class="keyword">new</span> LoginServiceImpl();</span><br><span class="line">        <span class="comment">//将封装用户信息的token进行验证</span></span><br><span class="line">        <span class="keyword">boolean</span> isLoginSuccess = loginService.login(token);</span><br><span class="line">        <span class="keyword">if</span> (!isLoginSuccess) &#123;</span><br><span class="line">            <span class="comment">//重定向到未登录成功页面</span></span><br><span class="line">            resp.sendRedirect(<span class="string">&quot;login.jsp&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        req.getRequestDispatcher(<span class="string">&quot;/home&quot;</span>).forward(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="HomeServlet"><a href="#HomeServlet" class="headerlink" title="HomeServlet"></a>HomeServlet</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：系统home页面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/home&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        req.getRequestDispatcher(<span class="string">&quot;home.jsp&quot;</span>).forward(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="OrderAddServlet"><a href="#OrderAddServlet" class="headerlink" title="OrderAddServlet"></a>OrderAddServlet</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.LoginService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.impl.LoginServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：添加页码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/order-add&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderAddServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        req.getRequestDispatcher(<span class="string">&quot;order-add.jsp&quot;</span>).forward(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="OrderListServlet"><a href="#OrderListServlet" class="headerlink" title="OrderListServlet"></a>OrderListServlet</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.LoginService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.impl.LoginServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：订单列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/order-list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderListServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        req.getRequestDispatcher(<span class="string">&quot;order-list.jsp&quot;</span>).forward(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="LogoutServlet"><a href="#LogoutServlet" class="headerlink" title="LogoutServlet"></a>LogoutServlet</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.LoginService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.impl.LoginServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：登出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/logout&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogoutServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        LoginService loginService = <span class="keyword">new</span> LoginServiceImpl();</span><br><span class="line">        loginService.logout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="添加JSP"><a href="#添加JSP" class="headerlink" title="添加JSP"></a>添加JSP</h4><p>login.jsp登录页面</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">action</span>=<span class="string">&quot;$&#123;pageContext.request.contextPath&#125;/login&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>登陆名称<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>  <span class="attr">name</span>=<span class="string">&quot;loginName&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>home.jsp系统页</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&lt;%@ taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;</span><br><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h6</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;pageContext.request.contextPath&#125;/logout&quot;</span>&gt;</span>退出<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;pageContext.request.contextPath&#125;/order-list&quot;</span>&gt;</span>列表<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;pageContext.request.contextPath&#125;/order-add&quot;</span>&gt;</span>添加<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>order-add.jsp订单添加（伪代码）</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">添加页面</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>order-list.jsp订单列表</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;%--导入jstl标签库--%&gt;</span><br><span class="line">&lt;%@ taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>用户列表jsp页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></span><br><span class="line"><span class="css">        <span class="selector-tag">table</span> &#123;<span class="attribute">border</span>:<span class="number">1px</span> solid <span class="number">#000000</span>&#125;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">table</span> <span class="selector-tag">th</span>&#123;<span class="attribute">border</span>:<span class="number">1px</span> solid <span class="number">#000000</span>&#125;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">table</span> <span class="selector-tag">td</span>&#123;<span class="attribute">border</span>:<span class="number">1px</span> solid <span class="number">#000000</span>&#125;</span></span><br><span class="line"><span class="css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">cellpadding</span>=<span class="string">&quot;0&quot;</span> <span class="attr">cellspacing</span>=<span class="string">&quot;0&quot;</span> <span class="attr">width</span>=<span class="string">&quot;80%&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>编号<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>公司名称<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>信息来源<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>所属行业<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>级别<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>联系地址<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>联系电话<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>1<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>传智播客<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>网络营销<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>互联网<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>普通客户<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>津安创意园<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>0208888887<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>2<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>黑马程序员<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>j2ee<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>互联网<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>VIP客户<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>津安创意园<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>0208888887<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>3<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>黑马程序员<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>大数据<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>互联网<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>VIP客户<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>津安创意园<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>0208888887<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h4><h5 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h5><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210632.png" alt="1580712098325"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210628.png" alt="1580712149790"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210625.png" alt="1580712207992"></p>
<p>点击apply然后点击OK</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210621.png" alt="1580712304894"></p>
<h5 id="登录过滤"><a href="#登录过滤" class="headerlink" title="登录过滤"></a>登录过滤</h5><p>访问<a target="_blank" rel="noopener" href="http://localhost:8080/platform/home%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E4%BC%9A%E8%A2%AB">http://localhost:8080/platform/home的时候，会被</a></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210615.png" alt="1580712567791"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210611.png" alt="1580712593905"></p>
<h5 id="角色过滤"><a href="#角色过滤" class="headerlink" title="角色过滤"></a>角色过滤</h5><p>使用“admin”用户登录，密码：123</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210608.png" alt="1580713051410"></p>
<p>根据SecurityServiceImpl我们可以知道使用admin账号</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210604.png" alt="1580712777098"></p>
<p>登录成功之后：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210600.png" alt="1580713214523"></p>
<p>此时点击“列表”，因为当前admin用户是有admin角色</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210540.png" alt="1580713320621"></p>
<p>所有可以正常访问</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210537.png" alt="1580713360368"></p>
<p>点击“添加”，因为当前admin用户是没有order:add的资源</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210533.png" alt="1580713455483"></p>
<p>所以回401</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210530.png" alt="1580713488156"></p>
<h5 id="资源过滤"><a href="#资源过滤" class="headerlink" title="资源过滤"></a>资源过滤</h5><p>点击“退出”</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210527.png" alt="1580713654616"></p>
<p>使用“jay”用户登录，密码为123</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210523.png" alt="1580713770711"></p>
<p>点击“添加”</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210520.png" alt="1580713818625"></p>
<p>因为SecurityServiceImpl中为jay用户添加如下的资源</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210516.png" alt="1580713855307"></p>
<p>点击“添加”之后正常访问</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210512.png" alt="1580713814501"></p>
<p>点击“列表”之后，因为“jay”用户没有“admin”角色，所以访问受限</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210509.png" alt="1580713925370"></p>
<h3 id="web项目授权"><a href="#web项目授权" class="headerlink" title="web项目授权"></a>web项目授权</h3><p>前面我们学习了基于ini文件配置方式来完成授权，下面我们来看下其他2种方式的授权</p>
<h4 id="基于代码"><a href="#基于代码" class="headerlink" title="基于代码"></a>基于代码</h4><h5 id="登录相关"><a href="#登录相关" class="headerlink" title="登录相关"></a>登录相关</h5><table>
<thead>
<tr>
<th>Subject 登录相关方法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>isAuthenticated()</td>
<td>返回true 表示已经登录，否则返回false。</td>
</tr>
</tbody></table>
<h5 id="角色相关"><a href="#角色相关" class="headerlink" title="角色相关"></a>角色相关</h5><table>
<thead>
<tr>
<th>Subject 角色相关方法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>hasRole(String roleName)</td>
<td>返回true 如果Subject 被分配了指定的角色，否则返回false。</td>
</tr>
<tr>
<td>hasRoles(List<String> roleNames)</td>
<td>返回true 如果Subject 被分配了所有指定的角色，否则返回false。</td>
</tr>
<tr>
<td>hasAllRoles(Collection<String>roleNames)</td>
<td>返回一个与方法参数中目录一致的hasRole 结果的集合。有性能的提高如果许多角色需要执行检查（例如，当自定义一个复杂的视图）。</td>
</tr>
<tr>
<td>checkRole(String roleName)</td>
<td>安静地返回，如果Subject 被分配了指定的角色，不然的话就抛出AuthorizationException。</td>
</tr>
<tr>
<td>checkRoles(Collection<String>roleNames)</td>
<td>安静地返回，如果Subject 被分配了所有的指定的角色，不然的话就抛出AuthorizationException。</td>
</tr>
<tr>
<td>checkRoles(String… roleNames)</td>
<td>与上面的checkRoles 方法的效果相同，但允许Java5 的var-args 类型的参数</td>
</tr>
</tbody></table>
<h5 id="资源相关"><a href="#资源相关" class="headerlink" title="资源相关"></a>资源相关</h5><table>
<thead>
<tr>
<th>Subject 资源相关方法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>isPermitted(Permission p)</td>
<td>返回true 如果该Subject 被允许执行某动作或访问被权限实例指定的资源，否则返回false</td>
</tr>
<tr>
<td>isPermitted(List<Permission> perms)</td>
<td>返回一个与方法参数中目录一致的isPermitted 结果的集合。</td>
</tr>
<tr>
<td>isPermittedAll(Collection<Permission>perms)</td>
<td>返回true 如果该Subject 被允许所有指定的权限，否则返回false有性能的提高如果需要执行许多检查（例如，当自定义一个复杂的视图）</td>
</tr>
<tr>
<td>isPermitted(String perm)</td>
<td>返回true 如果该Subject 被允许执行某动作或访问被字符串权限指定的资源，否则返回false。</td>
</tr>
<tr>
<td>isPermitted(String…perms)</td>
<td>返回一个与方法参数中目录一致的isPermitted 结果的数组。有性能的提高如果许多字符串权限检查需要被执行（例如，当自定义一个复杂的视图）。</td>
</tr>
<tr>
<td>isPermittedAll(String…perms)</td>
<td>返回true 如果该Subject 被允许所有指定的字符串权限，否则返回false。</td>
</tr>
<tr>
<td>checkPermission(Permission p)</td>
<td>安静地返回，如果Subject 被允许执行某动作或访问被特定的权限实例指定的资源，不然的话就抛出AuthorizationException 异常。</td>
</tr>
<tr>
<td>checkPermission(String perm)</td>
<td>安静地返回，如果Subject 被允许执行某动作或访问被特定的字符串权限指定的资源，不然的话就抛出AuthorizationException 异常。</td>
</tr>
<tr>
<td>checkPermissions(Collection<Permission> perms)</td>
<td>安静地返回，如果Subject 被允许所有的权限，不然的话就抛出AuthorizationException 异常。有性能的提高如果需要执行许多检查（例如，当自定义一个复杂的视图）</td>
</tr>
<tr>
<td>checkPermissions(String… perms)</td>
<td>和上面的checkPermissions 方法效果相同，但是使用的是基于字符串的权限。</td>
</tr>
</tbody></table>
<h5 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h5><h6 id="创建项目-2"><a href="#创建项目-2" class="headerlink" title="创建项目"></a>创建项目</h6><p>拷贝shiro-day01-07web新建shiro-day01-08web-java</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210503.png" alt="1580799013486"></p>
<h6 id="修改shiro-ini"><a href="#修改shiro-ini" class="headerlink" title="修改shiro.ini"></a>修改shiro.ini</h6><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment">#声明自定义的realm，且为安全管理器指定realms</span></span><br><span class="line"><span class="section">[main]</span></span><br><span class="line"><span class="attr">definitionRealm</span>=com.itheima.shiro.realm.DefinitionRealm</span><br><span class="line"><span class="attr">securityManager.realms</span>=<span class="variable">$definitionRealm</span></span><br><span class="line"><span class="comment">#用户退出后跳转指定JSP页面</span></span><br><span class="line"><span class="attr">logout.redirectUrl</span>=/login.jsp</span><br><span class="line"><span class="comment">#若没有登录，则被authc过滤器重定向到login.jsp页面</span></span><br><span class="line"><span class="attr">authc.loginUrl</span> = /login.jsp</span><br><span class="line"><span class="section">[urls]</span></span><br><span class="line">/<span class="attr">login</span>=anon</span><br><span class="line"><span class="comment">#发送/home请求需要先登录</span></span><br><span class="line"><span class="comment">#/home= authc</span></span><br><span class="line"><span class="comment">#发送/order/list请求需要先登录</span></span><br><span class="line"><span class="comment">#/order-list = roles[admin]</span></span><br><span class="line"><span class="comment">#提交代码需要order:add权限</span></span><br><span class="line"><span class="comment">#/order-add = perms[&quot;order:add&quot;]</span></span><br><span class="line"><span class="comment">#更新代码需要order:del权限</span></span><br><span class="line"><span class="comment">#/order-del = perms[&quot;order:del&quot;]</span></span><br><span class="line"><span class="comment">#发送退出请求则用退出过滤器</span></span><br><span class="line">/<span class="attr">logout</span> = logout</span><br></pre></td></tr></table></figure>

<h6 id="登录相关-1"><a href="#登录相关-1" class="headerlink" title="登录相关"></a>登录相关</h6><p>修改HomeServlet的doPost方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：系统home页面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/home&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">//通过subjectd对象去判断是否登录</span></span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        <span class="keyword">boolean</span> flag  = subject.isAuthenticated();</span><br><span class="line">        <span class="keyword">if</span> (flag)&#123;</span><br><span class="line">            resp.sendRedirect(<span class="string">&quot;home.jsp&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            req.getRequestDispatcher(<span class="string">&quot;/login&quot;</span>).forward(req, resp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>访问<a target="_blank" rel="noopener" href="http://localhost:8080/platform/home">http://localhost:8080/platform/home</a>   进行debug</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210453.png" alt="1580800060589"></p>
<p>此时我们通过subject.isAuthenticated()判断是否登录，如果登录则重定向到home.jsp,如果没有登录则转发到/login对应的servlet</p>
<h6 id="角色相关-1"><a href="#角色相关-1" class="headerlink" title="角色相关"></a>角色相关</h6><p>修改OrderListServlet的doPost方法，判断是否有admin角色，如果有则转发order-list.jsp,没有则转发/login</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：订单列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/order-list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderListServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        <span class="comment">//判断当前角色</span></span><br><span class="line">        <span class="keyword">boolean</span> flag = subject.hasRole(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (flag)&#123;</span><br><span class="line">            req.getRequestDispatcher(<span class="string">&quot;order-list.jsp&quot;</span>).forward(req, resp);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            req.getRequestDispatcher(<span class="string">&quot;/login&quot;</span>).forward(req, resp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问<a target="_blank" rel="noopener" href="http://localhost:8080/platform/order-list">http://localhost:8080/platform/order-list</a></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210443.png" alt="1580801658680"></p>
<p>因为此时我未登录，也就是说当前没有admin角色，这是通过subject.hasRole(“admin”)返回未false</p>
<h6 id="资源相关-1"><a href="#资源相关-1" class="headerlink" title="资源相关"></a>资源相关</h6><p>修改OrderAddServlet</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：添加页码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/order-add&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderAddServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        <span class="comment">//判断是否有对应资源</span></span><br><span class="line">        <span class="keyword">boolean</span> flag = subject.isPermitted(<span class="string">&quot;order:add&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (flag)&#123;</span><br><span class="line">            req.getRequestDispatcher(<span class="string">&quot;order-add.jsp&quot;</span>).forward(req, resp);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            req.getRequestDispatcher(<span class="string">&quot;/login&quot;</span>).forward(req, resp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>访问<a target="_blank" rel="noopener" href="http://localhost:8080/platform/order-add">http://localhost:8080/platform/order-add</a></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210439.png" alt="1580802789329"></p>
<p>因为此时我未登录，也就是说当前没有order:add资源，通过 subject.isPermitted(“order:add”)返回未false</p>
<h4 id="基于Jsp标签"><a href="#基于Jsp标签" class="headerlink" title="基于Jsp标签"></a>基于Jsp标签</h4><h5 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h5><p>Shiro提供了一套JSP标签库来实现页面级的授权控制， 在使用Shiro标签库前，首先需要在JSP引入shiro标签： </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&lt;%@ taglib prefix=&quot;shiro&quot; uri=&quot;http://shiro.apache.org/tags&quot; %&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="相关标签"><a href="#相关标签" class="headerlink" title="相关标签"></a>相关标签</h5><table>
<thead>
<tr>
<th>标签</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>&lt; shiro:guest &gt;</td>
<td>验证当前用户是否为“访客”，即未认证（包含未记住）的用户</td>
</tr>
<tr>
<td>&lt; shiro:user &gt;</td>
<td>认证通过或已记住的用户</td>
</tr>
<tr>
<td>&lt; shiro:authenticated &gt;</td>
<td>已认证通过的用户。不包含已记住的用户，这是与user标签的区别所在</td>
</tr>
<tr>
<td>&lt; shiro:notAuthenticated &gt;</td>
<td>未认证通过用户。与guest标签的区别是，该标签包含已记住用户</td>
</tr>
<tr>
<td>&lt; shiro:principal /&gt;</td>
<td>输出当前用户信息，通常为登录帐号信息</td>
</tr>
<tr>
<td>&lt; shiro:hasRole name=”角色”&gt;</td>
<td>验证当前用户是否属于该角色</td>
</tr>
<tr>
<td>&lt; shiro:lacksRole name=”角色”&gt;</td>
<td>与hasRole标签逻辑相反，当用户不属于该角色时验证通过</td>
</tr>
<tr>
<td>&lt; shiro:hasAnyRoles name=”a,b”&gt;</td>
<td>验证当前用户是否属于以下任意一个角色</td>
</tr>
<tr>
<td>&lt;shiro:hasPermission name=“资源”&gt;</td>
<td>验证当前用户是否拥有制定权限</td>
</tr>
<tr>
<td>&lt;shiro:lacksPermission name=”资源”&gt;</td>
<td>与permission标签逻辑相反，当前用户没有制定权限时，验证通过</td>
</tr>
</tbody></table>
<h5 id="案例-1"><a href="#案例-1" class="headerlink" title="案例"></a>案例</h5><h6 id="新建项目-4"><a href="#新建项目-4" class="headerlink" title="新建项目"></a>新建项目</h6><p>拷贝shiro-day01-08web-java新建shiro-day01-09web-jsp-taglib项目</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210435.png" alt="1580805725438"></p>
<h6 id="修改home-jsp"><a href="#修改home-jsp" class="headerlink" title="修改home.jsp"></a>修改home.jsp</h6><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&lt;%@ taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;</span><br><span class="line">&lt;%@ taglib prefix=&quot;shiro&quot; uri=&quot;http://shiro.apache.org/tags&quot; %&gt;</span><br><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h6</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;pageContext.request.contextPath&#125;/logout&quot;</span>&gt;</span>退出<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shiro:hasRole</span> <span class="attr">name</span>=<span class="string">&quot;admin&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;pageContext.request.contextPath&#125;/order-list&quot;</span>&gt;</span>列表<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shiro:hasRole</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shiro:hasPermission</span> <span class="attr">name</span>=<span class="string">&quot;order:add&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;pageContext.request.contextPath&#125;/order-add&quot;</span>&gt;</span>添加<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shiro:hasPermission</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h6><p>访问<a target="_blank" rel="noopener" href="http://localhost:8080/platform/login">http://localhost:8080/platform/login</a></p>
<p>使用admin/123登录</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210431.png" alt="1580806179855"></p>
<p>这个时候我们只能看见“列表”，看不见“添加”，点击“退出”</p>
<p>使用jay/123登录</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210428.png" alt="1580806253525"></p>
<p>这个时候我们只能看见“添加”，看不见“列表”，点击“退出”</p>
<p>需要注意的是，这里只是页面是否显示内容，不能防止盗链的发生</p>
<h2 id="Springboot集成Shiro"><a href="#Springboot集成Shiro" class="headerlink" title="Springboot集成Shiro"></a>Springboot集成Shiro</h2><h3 id="技术栈"><a href="#技术栈" class="headerlink" title="技术栈"></a>技术栈</h3><p>主框架：springboot</p>
<p>响应层：springMVC</p>
<p>持久层：mybatis</p>
<p>事务控制：jta</p>
<p>前端技术：easyui</p>
<h3 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h3><h4 id="数据库图解"><a href="#数据库图解" class="headerlink" title="数据库图解"></a>数据库图解</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210422.png" alt="1580807847384"></p>
<p>sh_user:用户表，一个用户可以有多个角色</p>
<p>sh_role:角色表，一个角色可以有多个资源</p>
<p>sh_resource:资源表</p>
<p>sh_user_role:用户角色中间表</p>
<p>sh_role_resource:角色资源中间表</p>
<h4 id="数据库脚本"><a href="#数据库脚本" class="headerlink" title="数据库脚本"></a>数据库脚本</h4><p>sh_user</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sh_user` (</span><br><span class="line">  `ID` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `LOGIN_NAME` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;登录名称&#x27;</span>,</span><br><span class="line">  `REAL_NAME` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;真实姓名&#x27;</span>,</span><br><span class="line">  `NICK_NAME` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;昵称&#x27;</span>,</span><br><span class="line">  `PASS_WORD` <span class="type">varchar</span>(<span class="number">150</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">  `SALT` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;加密因子&#x27;</span>,</span><br><span class="line">  `SEX` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">  `ZIPCODE` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line">  `ADDRESS` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;地址&#x27;</span>,</span><br><span class="line">  `TEL` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;固定电话&#x27;</span>,</span><br><span class="line">  `MOBIL` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;电话&#x27;</span>,</span><br><span class="line">  `EMAIL` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line">  `DUTIES` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;职务&#x27;</span>,</span><br><span class="line">  `SORT_NO` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;排序&#x27;</span>,</span><br><span class="line">  `ENABLE_FLAG` <span class="type">varchar</span>(<span class="number">18</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;是否有效&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`ID`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 ROW_FORMAT<span class="operator">=</span>COMPACT COMMENT<span class="operator">=</span><span class="string">&#x27;用户表&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>sh_role</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sh_role` (</span><br><span class="line">  `ID` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `ROLE_NAME` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色名称&#x27;</span>,</span><br><span class="line">  `LABEL` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色标识&#x27;</span>,</span><br><span class="line">  `DESCRIPTION` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色描述&#x27;</span>,</span><br><span class="line">  `SORT_NO` <span class="type">int</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;排序&#x27;</span>,</span><br><span class="line">  `ENABLE_FLAG` <span class="type">varchar</span>(<span class="number">18</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;是否有效&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`ID`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 ROW_FORMAT<span class="operator">=</span>COMPACT COMMENT<span class="operator">=</span><span class="string">&#x27;用户角色表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>sh_resource</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sh_resource` (</span><br><span class="line">  `ID` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `PARENT_ID` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;父资源&#x27;</span>,</span><br><span class="line">  `RESOURCE_NAME` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;资源名称&#x27;</span>,</span><br><span class="line">  `REQUEST_PATH` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;资源路径&#x27;</span>,</span><br><span class="line">  `LABEL` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;资源标签&#x27;</span>,</span><br><span class="line">  `ICON` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;图标&#x27;</span>,</span><br><span class="line">  `IS_LEAF` <span class="type">varchar</span>(<span class="number">18</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;是否叶子节点&#x27;</span>,</span><br><span class="line">  `RESOURCE_TYPE` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;资源类型&#x27;</span>,</span><br><span class="line">  `SORT_NO` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;排序&#x27;</span>,</span><br><span class="line">  `DESCRIPTION` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;描述&#x27;</span>,</span><br><span class="line">  `SYSTEM_CODE` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;系统code&#x27;</span>,</span><br><span class="line">  `IS_SYSTEM_ROOT` <span class="type">varchar</span>(<span class="number">18</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;是否根节点&#x27;</span>,</span><br><span class="line">  `ENABLE_FLAG` <span class="type">varchar</span>(<span class="number">18</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;是否有效&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`ID`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 ROW_FORMAT<span class="operator">=</span>COMPACT COMMENT<span class="operator">=</span><span class="string">&#x27;资源表&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>sh_role_resource</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sh_role_resource` (</span><br><span class="line">  `ID` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `ENABLE_FLAG` <span class="type">varchar</span>(<span class="number">18</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `ROLE_ID` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `RESOURCE_ID` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`ID`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 ROW_FORMAT<span class="operator">=</span>COMPACT COMMENT<span class="operator">=</span><span class="string">&#x27;角色资源表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>sh_user_role</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `sh_user_role` (</span><br><span class="line">  `ID` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `ENABLE_FLAG` <span class="type">varchar</span>(<span class="number">18</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `USER_ID` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `ROLE_ID` <span class="type">varchar</span>(<span class="number">36</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`ID`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 ROW_FORMAT<span class="operator">=</span>COMPACT COMMENT<span class="operator">=</span><span class="string">&#x27;用户角色表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="项目骨架"><a href="#项目骨架" class="headerlink" title="项目骨架"></a>项目骨架</h3><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210417.png" alt="1581062691221"></p>
<h3 id="ShiroDbRealm定义"><a href="#ShiroDbRealm定义" class="headerlink" title="ShiroDbRealm定义"></a>ShiroDbRealm定义</h3><h4 id="图解"><a href="#图解" class="headerlink" title="图解"></a>图解</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210412.png" alt="1583895738811"></p>
<h4 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h4><p>（1）、ShiroDbRealmImpl继承ShiroDbRealm向上继承AuthorizingRealm，ShiroDbRealmImpl实例化时会创建密码匹配器HashedCredentialsMatcher实例，HashedCredentialsMatcher指定hash次数与方式，交于AuthenticatingRealm</p>
<p>（2）、调用login方法后，最终调用doGetAuthenticationInfo(AuthenticationToken authcToken)方法，拿到SimpleToken的对象，调用UserBridgeService的查找用户方法，把ShiroUser对象、密码和salt交于SimpleAuthenticationInfo去认证</p>
<p>（3）、访问需要鉴权时，调用doGetAuthorizationInfo(PrincipalCollection principals)方法，然后调用UserBridgeService的授权验证 </p>
<h4 id="核心类代码"><a href="#核心类代码" class="headerlink" title="核心类代码"></a>核心类代码</h4><h5 id="ShiroDbRealm"><a href="#ShiroDbRealm" class="headerlink" title="ShiroDbRealm"></a>ShiroDbRealm</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> shiro自定义realm</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroDbRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@Description</span> 认证</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> authcToken token对象</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authcToken)</span> </span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@Description</span> 鉴权</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> principals 令牌</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@Description</span> 密码匹配器</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@PostConstruct</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">initCredentialsMatcher</span><span class="params">()</span> </span>;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="ShiroDbRealmImpl"><a href="#ShiroDbRealmImpl" class="headerlink" title="ShiroDbRealmImpl"></a>ShiroDbRealmImpl</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.SuperConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.ShiroUser;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.SimpleToken;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.ShiroDbRealm;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.bridge.UserBridgeService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.BeanConv;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.DigestsUtil;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.SimpleAuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UnknownAccountException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.credential.HashedCredentialsMatcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：自定义shiro的实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroDbRealmImpl</span> <span class="keyword">extends</span> <span class="title">ShiroDbRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserBridgeService userBridgeService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 认证方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authcToken 校验传入令牌</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> AuthenticationInfo</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authcToken)</span> </span>&#123;</span><br><span class="line">        SimpleToken token = (SimpleToken)authcToken;</span><br><span class="line">        User user  = userBridgeService.findUserByLoginName(token.getUsername());</span><br><span class="line">        <span class="keyword">if</span>(EmptyUtil.isNullOrEmpty(user))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(<span class="string">&quot;账号不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ShiroUser shiroUser = BeanConv.toBean(user, ShiroUser.class);</span><br><span class="line">        shiroUser.setResourceIds(userBridgeService.findResourcesIdsList(user.getId()));</span><br><span class="line">        String salt = user.getSalt();</span><br><span class="line">        String password = user.getPassWord();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(shiroUser, password, ByteSource.Util.bytes(salt), getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 授权方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> principals SimpleAuthenticationInfo对象第一个参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        ShiroUser shiroUser = (ShiroUser) principals.getPrimaryPrincipal();</span><br><span class="line">        <span class="keyword">return</span> userBridgeService.getAuthorizationInfo(shiroUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 加密方式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initCredentialsMatcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HashedCredentialsMatcher matcher = <span class="keyword">new</span> HashedCredentialsMatcher(SuperConstant.HASH_ALGORITHM);</span><br><span class="line">        matcher.setHashIterations(SuperConstant.HASH_INTERATIONS);</span><br><span class="line">        setCredentialsMatcher(matcher);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="SimpleToken"><a href="#SimpleToken" class="headerlink" title="SimpleToken"></a>SimpleToken</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 自定义tooken</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleToken</span> <span class="keyword">extends</span> <span class="title">UsernamePasswordToken</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** serialVersionUID */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">4849823851197352099L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String tokenType;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String quickPassword;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Constructor for SimpleToken</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> tokenType</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SimpleToken</span><span class="params">(String tokenType, String username,String password)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(username,password);</span><br><span class="line">		<span class="keyword">this</span>.tokenType = tokenType;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SimpleToken</span><span class="params">(String tokenType, String username,String password,String quickPassword)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(username,password);</span><br><span class="line">		<span class="keyword">this</span>.tokenType = tokenType;</span><br><span class="line">		<span class="keyword">this</span>.quickPassword = quickPassword;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getTokenType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> tokenType;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTokenType</span><span class="params">(String tokenType)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.tokenType = tokenType;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getQuickPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> quickPassword;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setQuickPassword</span><span class="params">(String quickPassword)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.quickPassword = quickPassword;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="ShiroUser"><a href="#ShiroUser" class="headerlink" title="ShiroUser"></a>ShiroUser</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.ToString;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 自定义Authentication对象，使得Subject除了携带用户的登录名外还可以携带更多信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span>  <span class="title">ShiroUser</span> <span class="keyword">extends</span> <span class="title">ToString</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** serialVersionUID */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">5024855628064590607L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 主键</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 登录名称</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String loginName;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 真实姓名</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String realName;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 昵称</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String nickName;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 密码</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String passWord;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 加密因子</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String salt;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 性别</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> Integer sex;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 邮箱</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String zipcode;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 地址</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 固定电话</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String tel;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 电话</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String mobil;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 邮箱</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 职务</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String duties;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 排序</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> Integer sortNo;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 是否有效</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String enableFlag;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">private</span> List&lt;String&gt; resourceIds;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ShiroUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ShiroUser</span><span class="params">(String id, String loginName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">		<span class="keyword">this</span>.loginName = loginName;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> prime = <span class="number">31</span>;</span><br><span class="line">		<span class="keyword">int</span> result = <span class="number">1</span>;</span><br><span class="line">		result = prime * result + ((email == <span class="keyword">null</span>) ? <span class="number">0</span> : email.hashCode());</span><br><span class="line">		result = prime * result + ((id == <span class="keyword">null</span>) ? <span class="number">0</span> : id.hashCode());</span><br><span class="line">		result = prime * result</span><br><span class="line">				+ ((loginName == <span class="keyword">null</span>) ? <span class="number">0</span> : loginName.hashCode());</span><br><span class="line">		result = prime * result + ((mobil == <span class="keyword">null</span>) ? <span class="number">0</span> : mobil.hashCode());</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span> == obj)</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">if</span> (obj == <span class="keyword">null</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">if</span> (getClass() != obj.getClass())</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		ShiroUser other = (ShiroUser) obj;</span><br><span class="line">		<span class="keyword">if</span> (email == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (other.email != <span class="keyword">null</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!email.equals(other.email))</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (other.id != <span class="keyword">null</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!id.equals(other.id))</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">if</span> (loginName == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (other.loginName != <span class="keyword">null</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!loginName.equals(other.loginName))</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">if</span> (mobil == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (other.mobil != <span class="keyword">null</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mobil.equals(other.mobil))</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="UserBridgeService"><a href="#UserBridgeService" class="headerlink" title="UserBridgeService"></a>UserBridgeService</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.bridge;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.ShiroUser;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：用户信息桥接（后期会做缓存）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserBridgeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查找用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loginName 用户名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> user对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">User <span class="title">findUserByLoginName</span><span class="params">(String loginName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 鉴权方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shiroUser 令牌对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 鉴权信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">AuthorizationInfo <span class="title">getAuthorizationInfo</span><span class="params">(ShiroUser shiroUser)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查询用户对应角色标识list</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 角色标识集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">findRoleList</span><span class="params">(String userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查询用户对应资源标识list</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 资源标识集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">findResourcesList</span><span class="params">(String userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查询资源ids</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 资源id集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">findResourcesIds</span><span class="params">(String userId)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="UserBridgeServiceImpl"><a href="#UserBridgeServiceImpl" class="headerlink" title="UserBridgeServiceImpl"></a>UserBridgeServiceImpl</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.bridge.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.adapter.UserAdapter;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.ShiroUser;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.bridge.UserBridgeService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.Resource;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：用户信息桥接（后期会做缓存）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(&quot;userBridgeService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserBridgeServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserBridgeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserAdapter userAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserByLoginName</span><span class="params">(String loginName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userAdapter.findUserByLoginName(loginName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationInfo <span class="title">getAuthorizationInfo</span><span class="params">(ShiroUser shiroUser)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//查询用户对应的角色标识</span></span><br><span class="line">        List&lt;String&gt; roleList = <span class="keyword">this</span>.findRoleList(shiroUser.getId());</span><br><span class="line">        <span class="comment">//查询用户对于的资源标识</span></span><br><span class="line">        List&lt;String&gt; resourcesList = <span class="keyword">this</span>.findResourcesList(shiroUser.getId());</span><br><span class="line">        <span class="comment">//构建鉴权信息对象</span></span><br><span class="line">        SimpleAuthorizationInfo simpleAuthorizationInfo = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">        simpleAuthorizationInfo.addRoles(roleList);</span><br><span class="line">        simpleAuthorizationInfo.addStringPermissions(resourcesList);</span><br><span class="line">        <span class="keyword">return</span> simpleAuthorizationInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findRoleList</span><span class="params">(String userId)</span></span>&#123;</span><br><span class="line">        List&lt;Role&gt; roles = userAdapter.findRoleByUserId(userId);</span><br><span class="line">        List&lt;String&gt; roleLabel = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Role role : roles) &#123;</span><br><span class="line">            roleLabel.add(role.getLabel());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> roleLabel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findResourcesList</span><span class="params">(String userId)</span></span>&#123;</span><br><span class="line">        List&lt;Resource&gt; resources = userAdapter.findResourceByUserId(userId);</span><br><span class="line">        List&lt;String&gt; resourceLabel = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Resource resource : resources) &#123;</span><br><span class="line">            resourceLabel.add(resource.getLabel());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resourceLabel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findResourcesIds</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">        List&lt;Resource&gt; resources = userAdapter.findResourceByUserId(userId);</span><br><span class="line">        List&lt;String&gt; ids = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Resource resource : resources) &#123;</span><br><span class="line">            ids.add(resource.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ids;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="UserAdapter"><a href="#UserAdapter" class="headerlink" title="UserAdapter"></a>UserAdapter</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.Resource;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 后台登陆用户适配器接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserAdapter</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@Description</span> 按用户名查找用户</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> loginName 登录名</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">User <span class="title">findUserByLoginName</span><span class="params">(String loginName)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@Description</span> 查找用户所有角色</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> userId 用户Id</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">List&lt;Role&gt; <span class="title">findRoleByUserId</span><span class="params">(String userId)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@Description</span> 查询用户有那些资源</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> userId 用户Id</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">List&lt;Resource&gt; <span class="title">findResourceByUserId</span><span class="params">(String userId)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="UserAdapterImpl"><a href="#UserAdapterImpl" class="headerlink" title="UserAdapterImpl"></a>UserAdapterImpl</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.adapter.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.SuperConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.adapter.UserAdapter;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.mappercustom.UserAdapterMapper;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.Resource;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.UserExample;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 后台登陆用户适配器接口实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(&quot;userAdapter&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserAdapterImpl</span> <span class="keyword">implements</span> <span class="title">UserAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserAdapterMapper userAdapterMapper;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">findUserByLoginName</span><span class="params">(String loginName)</span> </span>&#123;</span><br><span class="line">		UserExample userExample = <span class="keyword">new</span> UserExample();</span><br><span class="line">		userExample.createCriteria().andEnableFlagEqualTo(SuperConstant.YES).andLoginNameEqualTo(loginName);</span><br><span class="line">		List&lt;User&gt; userList = userMapper.selectByExample(userExample);</span><br><span class="line">		<span class="keyword">if</span> (userList.size()==<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> userList.get(<span class="number">0</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Role&gt; <span class="title">findRoleByUserId</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">		Map&lt;String, Object&gt; values = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">		values.put(<span class="string">&quot;userId&quot;</span>, userId);</span><br><span class="line">		values.put(<span class="string">&quot;enableFlag&quot;</span>, SuperConstant.YES);</span><br><span class="line">		List&lt;Role&gt; list = userAdapterMapper.findRoleByUserId(values);</span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Resource&gt; <span class="title">findResourceByUserId</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">		Map&lt;String, Object&gt; values = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">		values.put(<span class="string">&quot;userId&quot;</span>, userId);</span><br><span class="line">		values.put(<span class="string">&quot;enableFlag&quot;</span>, SuperConstant.YES);</span><br><span class="line">		List&lt;Resource&gt; list=userAdapterMapper.findResourceByUserId(values);</span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ShiroConfig配置"><a href="#ShiroConfig配置" class="headerlink" title="ShiroConfig配置"></a>ShiroConfig配置</h3><h4 id="图解-1"><a href="#图解-1" class="headerlink" title="图解"></a>图解</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210401.png" alt="1581064915787"></p>
<h4 id="原理分析-1"><a href="#原理分析-1" class="headerlink" title="原理分析"></a>原理分析</h4><p>（1）、创建SimpleCookie，访问项目时，会在客户端中cookie中存放ShiroSession的对</p>
<p>（2）、创建DefaultWebSessionManager会话管理器定义cookie机制、定时刷新、全局会话超时时间然后交</p>
<p>于DefaultWebSecurityManager权限管理器管理</p>
<p>（3）、创建自定义ShiroDbRealm实现，用于权限认证、授权、加密方式的管理，同时从数据库中取得相关的</p>
<p>角色、资源、用户的信息，然后交于DefaultWebSecurityManager权限管理器管理</p>
<p>（4）、创建DefaultWebSecurityManager权限管理器用于管理DefaultWebSessionManager会话管理器、ShiroDbRealm</p>
<p>（5）、创建lifecycleBeanPostProcessor和DefaultAdvisorAutoProxyCreator相互配合事项注解的权限鉴权</p>
<p>（6）、创建ShiroFilterFactoryBean的shiro过滤器指定权限管理器、同时启动连接链及登录URL、未登录的URL</p>
<p>的跳转</p>
<h4 id="ShiroConfig代码"><a href="#ShiroConfig代码" class="headerlink" title="ShiroConfig代码"></a>ShiroConfig代码</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.ShiroDbRealm;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.impl.ShiroDbRealmImpl;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.properties.PropertiesUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.LifecycleBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.servlet.SimpleCookie;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.session.mgt.DefaultWebSessionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.DependsOn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：权限配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &quot;com.itheima.shiro.core&quot;)</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 创建cookie对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;sessionIdCookie&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleCookie <span class="title">simpleCookie</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SimpleCookie simpleCookie = <span class="keyword">new</span> SimpleCookie();</span><br><span class="line">        simpleCookie.setName(<span class="string">&quot;ShiroSession&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> simpleCookie;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 权限管理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;securityManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">defaultWebSecurityManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        securityManager.setRealm(shiroDbRealm());</span><br><span class="line">        securityManager.setSessionManager(shiroSessionManager());</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义RealmImpl</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;shiroDbRealm&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroDbRealm <span class="title">shiroDbRealm</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ShiroDbRealmImpl();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 会话管理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;sessionManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultWebSessionManager <span class="title">shiroSessionManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultWebSessionManager sessionManager = <span class="keyword">new</span> DefaultWebSessionManager();</span><br><span class="line">        sessionManager.setSessionValidationSchedulerEnabled(<span class="keyword">false</span>);</span><br><span class="line">        sessionManager.setSessionIdCookieEnabled(<span class="keyword">true</span>);</span><br><span class="line">        sessionManager.setSessionIdCookie(simpleCookie());</span><br><span class="line">        sessionManager.setGlobalSessionTimeout(<span class="number">3600000</span>);</span><br><span class="line">        <span class="keyword">return</span> sessionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 保证实现了Shiro内部lifecycle函数的bean执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;lifecycleBeanPostProcessor&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LifecycleBeanPostProcessor <span class="title">getLifecycleBeanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LifecycleBeanPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> AOP式方法级权限检查</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@DependsOn(&quot;lifecycleBeanPostProcessor&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title">getDefaultAdvisorAutoProxyCreator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultAdvisorAutoProxyCreator defaultAdvisorAutoProxyCreator = <span class="keyword">new</span> DefaultAdvisorAutoProxyCreator();</span><br><span class="line">        defaultAdvisorAutoProxyCreator.setProxyTargetClass(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultAdvisorAutoProxyCreator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 配合DefaultAdvisorAutoProxyCreator事项注解权限校验</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title">getAuthorizationAttributeSourceAdvisor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        AuthorizationAttributeSourceAdvisor aasa = <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">        aasa.setSecurityManager(defaultWebSecurityManager());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 过滤器链</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">filterChainDefinition</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;Object&gt; list  = PropertiesUtil.propertiesShiro.getKeyList();</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Object object : list) &#123;</span><br><span class="line">            String key = object.toString();</span><br><span class="line">            String value = PropertiesUtil.getShiroValue(key);</span><br><span class="line">            log.info(<span class="string">&quot;读取防止盗链控制：---key&#123;&#125;,---value:&#123;&#125;&quot;</span>,key,value);</span><br><span class="line">            map.put(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> Shiro过滤器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;shiroFilter&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shiroFilterFactoryBean</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ShiroFilterFactoryBean shiroFilter = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">        shiroFilter.setSecurityManager(defaultWebSecurityManager());</span><br><span class="line">        shiroFilter.setFilterChainDefinitionMap(filterChainDefinition());</span><br><span class="line">        shiroFilter.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        shiroFilter.setUnauthorizedUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> shiroFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Shiro过滤器、过滤器链"><a href="#Shiro过滤器、过滤器链" class="headerlink" title="Shiro过滤器、过滤器链"></a>Shiro过滤器、过滤器链</h3><h4 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h4><p>Shiro内置了很多默认的过滤器，比如身份验证、授权等相关的。默认过滤器可以参考org.apache.shiro.web.filter.mgt.DefaultFilter中的枚举过滤器</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210353.png" alt="1580542509773"></p>
<h4 id="过滤器链"><a href="#过滤器链" class="headerlink" title="过滤器链"></a>过滤器链</h4><p>定义：authentication.properties</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#静态资源不过滤</span></span><br><span class="line"><span class="meta">/static/**</span>=<span class="string">anon</span></span><br><span class="line"><span class="comment">#登录链接不过滤</span></span><br><span class="line"><span class="meta">/login/**</span>=<span class="string">anon</span></span><br><span class="line"><span class="comment">#其他链接是需要登录的</span></span><br><span class="line"><span class="meta">/**</span>=<span class="string">authc</span></span><br></pre></td></tr></table></figure>

<p>注意：这里定义的过滤器是有执行顺序的，从上向下执行</p>
<h4 id="加载原理分析"><a href="#加载原理分析" class="headerlink" title="加载原理分析"></a>加载原理分析</h4><p>定义：PropertiesUtil，从classpath中加载authentication.properties</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 读取Properties的工具类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LinkProperties propertiesShiro = <span class="keyword">new</span> LinkProperties();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取properties配置文件信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        String sysName = System.getProperty(<span class="string">&quot;sys.name&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (EmptyUtil.isNullOrEmpty(sysName)) &#123;</span><br><span class="line">            sysName = <span class="string">&quot;application.properties&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sysName += <span class="string">&quot;.properties&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            propertiesShiro.load(PropertiesUtil.class.getClassLoader()</span><br><span class="line">                    .getResourceAsStream(<span class="string">&quot;authentication.properties&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;资源路径中不存在authentication.properties权限文件，忽略读取！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据key得到value的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getShiroValue</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> propertiesShiro.getProperty(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>定义LinkProperties，这个类保证了Properties类的有序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 有序Properties类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkProperties</span> <span class="keyword">extends</span> <span class="title">Properties</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** serialVersionUID */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7573016303908223266L</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> List&lt;Object&gt; keyList = <span class="keyword">new</span> ArrayList&lt;Object&gt;();  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 默认构造方法 </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LinkProperties</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">          </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 从指定路径加载信息到Properties </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LinkProperties</span><span class="params">(String path)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            InputStream is = <span class="keyword">new</span> FileInputStream(path);  </span><br><span class="line">            <span class="keyword">this</span>.load(is);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;指定文件不存在！&quot;</span>);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 重写put方法，按照property的存入顺序保存key到keyList，遇到重复的后者将覆盖前者。 </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Object <span class="title">put</span><span class="params">(Object key, Object value)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.removeKeyIfExists(key);  </span><br><span class="line">        keyList.add(key);  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.put(key, value);  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 重写remove方法，删除属性时清除keyList中对应的key。 </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Object <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.removeKeyIfExists(key);  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.remove(key);  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * keyList中存在指定的key时则将其删除 </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeKeyIfExists</span><span class="params">(Object key)</span> </span>&#123;  </span><br><span class="line">        keyList.remove(key);  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 获取Properties中key的有序集合 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">getKeyList</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> keyList;  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 保存Properties到指定文件，默认使用UTF-8编码 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path 指定文件路径 </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">store</span><span class="params">(String path)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.store(path, <span class="string">&quot;UTF-8&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 保存Properties到指定文件，并指定对应存放编码 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path 指定路径 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> charset 文件编码 </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">store</span><span class="params">(String path, String charset)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span> (path != <span class="keyword">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(path)) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                OutputStream os = <span class="keyword">new</span> FileOutputStream(path);  </span><br><span class="line">                BufferedWriter bw = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(os, charset));  </span><br><span class="line">                <span class="keyword">this</span>.store(bw, <span class="keyword">null</span>);  </span><br><span class="line">                bw.close();  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;  </span><br><span class="line">                e.printStackTrace();  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">                e.printStackTrace();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;存储路径不能为空!&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 重写keys方法，返回根据keyList适配的Enumeration，且保持HashTable keys()方法的原有语义， </span></span><br><span class="line"><span class="comment">     * 每次都调用返回一个新的Enumeration对象，且和之前的不产生冲突 </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Enumeration&lt;Object&gt; <span class="title">keys</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EnumerationAdapter&lt;Object&gt;(keyList);  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * List到Enumeration的适配器 </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">EnumerationAdapter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Enumeration</span>&lt;<span class="title">T</span>&gt; </span>&#123;  </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> index = <span class="number">0</span>;  </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> List&lt;T&gt; list;  </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isEmpty;  </span><br><span class="line">          </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">EnumerationAdapter</span><span class="params">(List&lt;T&gt; list)</span> </span>&#123;  </span><br><span class="line">            <span class="keyword">this</span>.list = list;  </span><br><span class="line">            <span class="keyword">this</span>.isEmpty = list.isEmpty();  </span><br><span class="line">        &#125;  </span><br><span class="line">          </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasMoreElements</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">            <span class="comment">//isEmpty的引入是为了更贴近HashTable原有的语义，在HashTable中添加元素前调用其keys()方法获得一个Enumeration的引用，  </span></span><br><span class="line">            <span class="comment">//之后往HashTable中添加数据后，调用之前获取到的Enumeration的hasMoreElements()将返回false，但如果此时重新获取一个  </span></span><br><span class="line">            <span class="comment">//Enumeration的引用，则新Enumeration的hasMoreElements()将返回true，而且之后对HashTable数据的增、删、改都是可以在  </span></span><br><span class="line">            <span class="comment">//nextElement中获取到的。  </span></span><br><span class="line">            <span class="keyword">return</span> !isEmpty &amp;&amp; index &lt; list.size();  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">nextElement</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.hasMoreElements()) &#123;  </span><br><span class="line">                <span class="keyword">return</span> list.get(index++);  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">          </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看shirocConfig</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210344.png" alt="1581078295529"></p>
<p>加载完整之后交于ShiroFilterFactoryBean使用setFilterChainDefinitionMap使得过滤生效</p>
<h4 id="自定义过滤器"><a href="#自定义过滤器" class="headerlink" title="自定义过滤器"></a>自定义过滤器</h4><p>上面我们使用了shiro的默认过滤器，但是由于业务需求，咱们可能要定义自己的过滤器，那么咱们定义呢？</p>
<p>这里我们先查看RolesAuthorizationFilter</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210341.png" alt="1581071730065"></p>
<p>分析：改源码表示，例如：/admin/order= roles[“admin, root”] ，只有当放问该接口同时具备admin和root两种角色时，才可以被访问。</p>
<h4 id="自定义过滤器使用"><a href="#自定义过滤器使用" class="headerlink" title="自定义过滤器使用"></a>自定义过滤器使用</h4><h5 id="需求-4"><a href="#需求-4" class="headerlink" title="需求"></a>需求</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1、实现只要有其中一个角色，则可访问对应路径</span><br></pre></td></tr></table></figure>

<h5 id="RolesOrAuthorizationFilter"><a href="#RolesOrAuthorizationFilter" class="headerlink" title="RolesOrAuthorizationFilter"></a>RolesOrAuthorizationFilter</h5><p>新建filter层，新建类RolesOrAuthorizationFilter</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.CollectionUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.authz.AuthorizationFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：角色或关系</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RolesOrAuthorizationFilter</span> <span class="keyword">extends</span> <span class="title">AuthorizationFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//TODO - complete JavaDoc</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Subject subject = getSubject(request, response);</span><br><span class="line">        String[] rolesArray = (String[]) mappedValue;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rolesArray == <span class="keyword">null</span> || rolesArray.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//no roles specified, so nothing to check - allow access.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Set&lt;String&gt; roles = CollectionUtils.asSet(rolesArray);</span><br><span class="line">        <span class="comment">//循环roles判断只要有角色则返回true</span></span><br><span class="line">        <span class="keyword">for</span> (String role : roles) &#123;</span><br><span class="line">            <span class="keyword">if</span>(subject.hasRole(role))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="编辑ShiroConfig"><a href="#编辑ShiroConfig" class="headerlink" title="编辑ShiroConfig"></a>编辑ShiroConfig</h5><p>在ShiroConfig类中添加如下内容</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义过滤器定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, Filter&gt; <span class="title">filters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Filter&gt; map = <span class="keyword">new</span> HashMap&lt;String, Filter&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;role-or&quot;</span>, <span class="keyword">new</span> RolesOrAuthorizationFilter());</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> Shiro过滤器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;shiroFilter&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shiroFilterFactoryBean</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ShiroFilterFactoryBean shiroFilter = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">        shiroFilter.setSecurityManager(defaultWebSecurityManager());</span><br><span class="line">        <span class="comment">//使自定义过滤器生效</span></span><br><span class="line">        shiroFilter.setFilters(filters());</span><br><span class="line">        shiroFilter.setFilterChainDefinitionMap(filterChainDefinition());</span><br><span class="line">        shiroFilter.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        shiroFilter.setUnauthorizedUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> shiroFilter;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="编辑authentication-properties"><a href="#编辑authentication-properties" class="headerlink" title="编辑authentication.properties"></a>编辑authentication.properties</h5><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment">#静态资源不过滤</span></span><br><span class="line">/static/**=anon</span><br><span class="line"><span class="comment">#登录链接不过滤</span></span><br><span class="line">/login/**=anon</span><br><span class="line"><span class="comment">#访问/resource/**需要有admin的角色</span></span><br><span class="line">/resource/**=role-or<span class="section">[admin]</span></span><br><span class="line"><span class="comment">#其他链接是需要登录的</span></span><br><span class="line">/**=authc</span><br></pre></td></tr></table></figure>

<h3 id="注解方式鉴权"><a href="#注解方式鉴权" class="headerlink" title="注解方式鉴权"></a>注解方式鉴权</h3><h4 id="注解介绍"><a href="#注解介绍" class="headerlink" title="注解介绍"></a>注解介绍</h4><p>以下为常用注解</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>@RequiresAuthentication</td>
<td>表明当前用户需是经过认证的用户</td>
</tr>
<tr>
<td>@ RequiresGuest</td>
<td>表明该用户需为”guest”用户</td>
</tr>
<tr>
<td>@RequiresPermissions</td>
<td>当前用户需拥有指定权限</td>
</tr>
<tr>
<td>@RequiresRoles</td>
<td>当前用户需拥有指定角色</td>
</tr>
<tr>
<td>@ RequiresUser</td>
<td>当前用户需为已认证用户或已记住用户</td>
</tr>
</tbody></table>
<p>例如RoleAction类中我们添加</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 *<span class="doctag">@Description</span>: 跳转到角色的初始化页面</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@RequiresRoles(value =&#123;&quot;SuperAdmin&quot;,&quot;dev&quot;&#125;,logical = Logical.OR)</span></span><br><span class="line">	<span class="meta">@RequestMapping(value = &quot;listInitialize&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ModelAndView <span class="title">listInitialize</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span>  <span class="keyword">new</span> ModelAndView(<span class="string">&quot;/role/role-listInitialize&quot;</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="注解原理分析"><a href="#注解原理分析" class="headerlink" title="注解原理分析"></a>注解原理分析</h4><h4 id="装载过程"><a href="#装载过程" class="headerlink" title="装载过程"></a>装载过程</h4><h4 id="调用过程"><a href="#调用过程" class="headerlink" title="调用过程"></a>调用过程</h4><h2 id="Realm缓存机制"><a href="#Realm缓存机制" class="headerlink" title="Realm缓存机制"></a>Realm缓存机制</h2><h3 id="Realm缓存机制意义"><a href="#Realm缓存机制意义" class="headerlink" title="Realm缓存机制意义"></a>Realm缓存机制意义</h3><p>在上面我们自定了自己的realm，但是我们发现</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210335.png" alt="1581758782223"></p>
<p>在认证和授权的时候，程序需要频繁的访问数据库，这样对于数据库的压力可想而知，那我们怎么处理呢？</p>
<h3 id="Realm缓存机制实现思路"><a href="#Realm缓存机制实现思路" class="headerlink" title="Realm缓存机制实现思路"></a>Realm缓存机制实现思路</h3><h4 id="缓存机制图解"><a href="#缓存机制图解" class="headerlink" title="缓存机制图解"></a>缓存机制图解</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202112221034019.png" alt="1584067476241"></p>
<h4 id="原理分析-2"><a href="#原理分析-2" class="headerlink" title="原理分析"></a>原理分析</h4><p>此时我们对UserBridgeServiceImpl的实现类里面的逻辑加入了自定义的SimpleCacheService缓存服务接口，简单来说实现了在认证和鉴权时不需要每次都去查询数据库，而是把认证和鉴权信息放入到redis缓存中，以减低数据库的访问压力</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">1、集成redis服务器，作为集中存储认证和鉴权信息</span></span><br><span class="line"><span class="attr">2、改写UserBridgeServiceImpl使其优先从缓存中读取</span></span><br></pre></td></tr></table></figure>



<h3 id="redission集成"><a href="#redission集成" class="headerlink" title="redission集成"></a>redission集成</h3><h4 id="添加ShiroRedisProperties"><a href="#添加ShiroRedisProperties" class="headerlink" title="添加ShiroRedisProperties"></a>添加ShiroRedisProperties</h4><p>此类主要负责yaml文件的配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>  redis配置文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;itheima.framework.shiro.redis&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroRedisProperties</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * redis连接地址</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String nodes ;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取连接超时时间</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> connectTimeout ;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 连接池大小</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> connectPoolSize;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 初始化连接数</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> connectionMinimumidleSize ;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 等待数据返回超时时间</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> timeout ;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 *  全局超时时间</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> globalSessionTimeout;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="编辑ShiroConfig-1"><a href="#编辑ShiroConfig-1" class="headerlink" title="编辑ShiroConfig"></a>编辑ShiroConfig</h4><p>集成redisson的相关配置，同时启用ShiroRedisProperties的配置</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.ShiroDbRealm;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.impl.ShiroDbRealmImpl;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.filter.RolesOrAuthorizationFilter;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.properties.PropertiesUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.LifecycleBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.servlet.SimpleCookie;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.session.mgt.DefaultWebSessionManager;</span><br><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.redisson.config.Config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.DependsOn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 权限配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &quot;com.itheima.shiro.core&quot;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;ShiroRedisProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShiroRedisProperties shiroRedisProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> redission客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;redissonClientForShiro&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedissonClient <span class="title">redissonClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;=====初始化redissonClientForShiro开始======&quot;</span>);</span><br><span class="line">        String[] nodeList = shiroRedisProperties.getNodes().split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        Config config = <span class="keyword">new</span> Config();</span><br><span class="line">        <span class="keyword">if</span> (nodeList.length == <span class="number">1</span>) &#123;</span><br><span class="line">            config.useSingleServer().setAddress(nodeList[<span class="number">0</span>])</span><br><span class="line">                    .setConnectTimeout(shiroRedisProperties.getConnectTimeout())</span><br><span class="line">                    .setConnectionMinimumIdleSize(shiroRedisProperties.getConnectionMinimumidleSize())</span><br><span class="line">                    .setConnectionPoolSize(shiroRedisProperties.getConnectPoolSize()).setTimeout(shiroRedisProperties.getTimeout());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            config.useClusterServers().addNodeAddress(nodeList)</span><br><span class="line">                    .setConnectTimeout(shiroRedisProperties.getConnectTimeout())</span><br><span class="line">                    .setMasterConnectionMinimumIdleSize(shiroRedisProperties.getConnectionMinimumidleSize())</span><br><span class="line">                    .setMasterConnectionPoolSize(shiroRedisProperties.getConnectPoolSize()).setTimeout(shiroRedisProperties.getTimeout());</span><br><span class="line">        &#125;</span><br><span class="line">        RedissonClient redissonClient =  Redisson.create(config);</span><br><span class="line">        log.info(<span class="string">&quot;=====初始化redissonClientForShiro完成======&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> redissonClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 创建cookie对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;sessionIdCookie&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleCookie <span class="title">simpleCookie</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SimpleCookie simpleCookie = <span class="keyword">new</span> SimpleCookie();</span><br><span class="line">        simpleCookie.setName(<span class="string">&quot;ShiroSession&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> simpleCookie;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 权限管理器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;securityManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">defaultWebSecurityManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        securityManager.setRealm(shiroDbRealm());</span><br><span class="line">        securityManager.setSessionManager(shiroSessionManager());</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义RealmImpl</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;shiroDbRealm&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroDbRealm <span class="title">shiroDbRealm</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ShiroDbRealmImpl();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 会话管理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;sessionManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultWebSessionManager <span class="title">shiroSessionManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultWebSessionManager sessionManager = <span class="keyword">new</span> DefaultWebSessionManager();</span><br><span class="line">        sessionManager.setSessionValidationSchedulerEnabled(<span class="keyword">false</span>);</span><br><span class="line">        sessionManager.setSessionIdCookieEnabled(<span class="keyword">true</span>);</span><br><span class="line">        sessionManager.setSessionIdCookie(simpleCookie());</span><br><span class="line">        sessionManager.setGlobalSessionTimeout(<span class="number">3600000</span>);</span><br><span class="line">        <span class="keyword">return</span> sessionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 保证实现了Shiro内部lifecycle函数的bean执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;lifecycleBeanPostProcessor&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LifecycleBeanPostProcessor <span class="title">getLifecycleBeanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LifecycleBeanPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> AOP式方法级权限检查</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@DependsOn(&quot;lifecycleBeanPostProcessor&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title">getDefaultAdvisorAutoProxyCreator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultAdvisorAutoProxyCreator defaultAdvisorAutoProxyCreator = <span class="keyword">new</span> DefaultAdvisorAutoProxyCreator();</span><br><span class="line">        defaultAdvisorAutoProxyCreator.setProxyTargetClass(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultAdvisorAutoProxyCreator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 配合DefaultAdvisorAutoProxyCreator事项注解权限校验</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title">getAuthorizationAttributeSourceAdvisor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        AuthorizationAttributeSourceAdvisor aasa = <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">        aasa.setSecurityManager(defaultWebSecurityManager());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 过滤器链</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">filterChainDefinition</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;Object&gt; list  = PropertiesUtil.propertiesShiro.getKeyList();</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Object object : list) &#123;</span><br><span class="line">            String key = object.toString();</span><br><span class="line">            String value = PropertiesUtil.getShiroValue(key);</span><br><span class="line">            log.info(<span class="string">&quot;读取防止盗链控制：---key&#123;&#125;,---value:&#123;&#125;&quot;</span>,key,value);</span><br><span class="line">            map.put(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义过滤器定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, Filter&gt; <span class="title">filters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Filter&gt; map = <span class="keyword">new</span> HashMap&lt;String, Filter&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;roleOr&quot;</span>, <span class="keyword">new</span> RolesOrAuthorizationFilter());</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> Shiro过滤器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;shiroFilter&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shiroFilterFactoryBean</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ShiroFilterFactoryBean shiroFilter = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">        shiroFilter.setSecurityManager(defaultWebSecurityManager());</span><br><span class="line">        <span class="comment">//使自定义过滤器生效</span></span><br><span class="line">        shiroFilter.setFilters(filters());</span><br><span class="line">        shiroFilter.setFilterChainDefinitionMap(filterChainDefinition());</span><br><span class="line">        shiroFilter.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        shiroFilter.setUnauthorizedUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> shiroFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="缓存对象SimpleMapCache"><a href="#缓存对象SimpleMapCache" class="headerlink" title="缓存对象SimpleMapCache"></a>缓存对象SimpleMapCache</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.cache.Cache;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.cache.CacheException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 缓存实现类, 实现序列 接口方便对象存储于第三方容器(Map存放键值对)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleMapCache</span> <span class="keyword">implements</span> <span class="title">Cache</span>&lt;<span class="title">Object</span>, <span class="title">Object</span>&gt;, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, Object&gt; attributes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleMapCache</span><span class="params">(String name, Map&lt;Object, Object&gt; backingMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Cache name cannot be null.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (backingMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Backing map cannot be null.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">            attributes = backingMap;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> <span class="keyword">throws</span> CacheException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> attributes.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">put</span><span class="params">(Object key, Object value)</span> <span class="keyword">throws</span> CacheException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> attributes.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">remove</span><span class="params">(Object key)</span> <span class="keyword">throws</span> CacheException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> attributes.remove(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> <span class="keyword">throws</span> CacheException </span>&#123;</span><br><span class="line">        attributes.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> attributes.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;Object&gt; <span class="title">keys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Set&lt;Object&gt; keys = attributes.keySet();</span><br><span class="line">        <span class="keyword">if</span> (!keys.isEmpty())</span><br><span class="line">            <span class="keyword">return</span> Collections.unmodifiableSet(keys);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;Object&gt; <span class="title">values</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Collection&lt;Object&gt; values = attributes.values();</span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(values))</span><br><span class="line">            <span class="keyword">return</span> Collections.unmodifiableCollection(values);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SimpleMapCache [attributes=&quot;</span> + attributes + <span class="string">&quot;, name=&quot;</span> + name</span><br><span class="line">                + <span class="string">&quot;, keys()=&quot;</span> + keys() + <span class="string">&quot;, size()=&quot;</span> + size() + <span class="string">&quot;, values()=&quot;</span></span><br><span class="line">                + values() + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="ShiroRedissionSerialize序列化工具"><a href="#ShiroRedissionSerialize序列化工具" class="headerlink" title="ShiroRedissionSerialize序列化工具"></a>ShiroRedissionSerialize序列化工具</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.codec.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：实现shiro会话的序列化存储</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroRedissionSerialize</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">deserialize</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (EmptyUtil.isNullOrEmpty(str)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ByteArrayInputStream bis = <span class="keyword">null</span>;</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">null</span>;</span><br><span class="line">        Object object=<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bis = <span class="keyword">new</span> ByteArrayInputStream(EncodesUtil.decodeBase64(str));</span><br><span class="line">            ois = <span class="keyword">new</span> ObjectInputStream(bis);</span><br><span class="line">            object = ois.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException |ClassNotFoundException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;流读取异常：&#123;&#125;&quot;</span>,e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bis.close();</span><br><span class="line">                ois.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;流读取异常：&#123;&#125;&quot;</span>,e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">serialize</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (EmptyUtil.isNullOrEmpty(obj)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">null</span>;</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">null</span>;</span><br><span class="line">        String base64String = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            oos = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">            oos.writeObject(obj);</span><br><span class="line">            base64String = EncodesUtil.encodeBase64(bos.toByteArray());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;流写入异常：&#123;&#125;&quot;</span>,e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bos.close();</span><br><span class="line">                oos.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;流写入异常：&#123;&#125;&quot;</span>,e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> base64String;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="缓存服务接口SimpleCacheService"><a href="#缓存服务接口SimpleCacheService" class="headerlink" title="缓存服务接口SimpleCacheService"></a>缓存服务接口SimpleCacheService</h3><p>SimpleCacheService</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.cache.Cache;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.cache.CacheException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 简单的缓存管理接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SimpleCacheService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;b&gt;功能说明：&lt;/b&gt;：新增缓存堆到管理器&lt;br&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="function"><span class="keyword">void</span> <span class="title">createCache</span><span class="params">(String cacheName, Cache&lt;Object, Object&gt; cache)</span> <span class="keyword">throws</span> CacheException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;b&gt;方法名：&lt;/b&gt;：getCache&lt;br&gt;</span></span><br><span class="line"><span class="comment">     * &lt;b&gt;功能说明：&lt;/b&gt;：获取缓存堆&lt;br&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="function">Cache&lt;Object, Object&gt; <span class="title">getCache</span><span class="params">(String cacheName)</span> <span class="keyword">throws</span> CacheException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;b&gt;方法名：&lt;/b&gt;：removeCache&lt;br&gt;</span></span><br><span class="line"><span class="comment">     * &lt;b&gt;功能说明：&lt;/b&gt;：移除缓存堆&lt;br&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="function"><span class="keyword">void</span> <span class="title">removeCache</span><span class="params">(String cacheName)</span> <span class="keyword">throws</span> CacheException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;b&gt;方法名：&lt;/b&gt;：updateCahce&lt;br&gt;</span></span><br><span class="line"><span class="comment">     * &lt;b&gt;功能说明：&lt;/b&gt;：更新缓存堆&lt;br&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="function"><span class="keyword">void</span> <span class="title">updateCahce</span><span class="params">(String cacheName, Cache&lt;Object, Object&gt; cache)</span> <span class="keyword">throws</span> CacheException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>SimpleCacheServiceImpl</p>
<p>调用RedissonClient去实现缓存，同时使用ShiroRedissionSerialize实现序列化</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.CacheConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.SimpleCacheService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.ShiroRedissionSerialize;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.cache.Cache;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.cache.CacheException;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RBucket;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 简单的缓存管理接口的实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleCacheServiceImpl</span> <span class="keyword">implements</span> <span class="title">SimpleCacheService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Resource(name = &quot;redissonClientForShiro&quot;)</span></span><br><span class="line">	RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createCache</span><span class="params">(String name, Cache&lt;Object, Object&gt; cache)</span></span>&#123;</span><br><span class="line">		RBucket&lt;String&gt; bucket =  redissonClient.getBucket(CacheConstant.GROUP_CAS+name);</span><br><span class="line">		bucket.trySet(ShiroRedissionSerialize.serialize(cache), SecurityUtils.getSubject().getSession().getTimeout()/<span class="number">1000</span>, TimeUnit.SECONDS);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Cache&lt;Object, Object&gt; <span class="title">getCache</span><span class="params">(String name)</span> <span class="keyword">throws</span> CacheException </span>&#123;</span><br><span class="line">		RBucket&lt;String&gt; bucket =  redissonClient.getBucket(CacheConstant.GROUP_CAS+name);</span><br><span class="line">		<span class="keyword">return</span> (Cache&lt;Object, Object&gt;) ShiroRedissionSerialize.deserialize(bucket.get());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeCache</span><span class="params">(String name)</span> <span class="keyword">throws</span> CacheException </span>&#123;</span><br><span class="line">		RBucket&lt;String&gt; bucket =  redissonClient.getBucket(CacheConstant.GROUP_CAS+name);</span><br><span class="line">		bucket.delete();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateCahce</span><span class="params">(String name, Cache&lt;Object, Object&gt; cache)</span></span>&#123;</span><br><span class="line">		RBucket&lt;String&gt; bucket =  redissonClient.getBucket(CacheConstant.GROUP_CAS+name);</span><br><span class="line">		bucket.set(ShiroRedissionSerialize.serialize(cache), SecurityUtils.getSubject().getSession().getTimeout()/<span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="桥接器BridgeService"><a href="#桥接器BridgeService" class="headerlink" title="桥接器BridgeService"></a>桥接器BridgeService</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.bridge;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.ShiroUser;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：用户信息桥接（后期会做缓存）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserBridgeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查找用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loginName 用户名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> user对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">User <span class="title">findUserByLoginName</span><span class="params">(String loginName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 鉴权方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shiroUser 令牌对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 鉴权信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">AuthorizationInfo <span class="title">getAuthorizationInfo</span><span class="params">(ShiroUser shiroUser)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查询用户对应角色标识list</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 角色标识集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">findRoleList</span><span class="params">(String key,String userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查询用户对应资源标识list</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 资源标识集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">findResourcesList</span><span class="params">(String key,String userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查询资源ids</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 资源id集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">findResourcesIds</span><span class="params">(String userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 加载缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shiroUser 令牌对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">loadUserAuthorityToCache</span><span class="params">(ShiroUser shiroUser)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时我们就可以修改UserBridgeServiceImpl实现缓存了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.bridge.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.CacheConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.SimpleCacheService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.adapter.UserAdapter;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.ShiroUser;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.SimpleMapCache;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.bridge.UserBridgeService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.Resource;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.ShiroUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.cache.Cache;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：用户信息桥接（后期会做缓存）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(&quot;userBridgeService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserBridgeServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserBridgeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserAdapter userAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    SimpleCacheService simpleCacheService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserByLoginName</span><span class="params">(String loginName)</span> </span>&#123;</span><br><span class="line">        String key = CacheConstant.FIND_USER_BY_LOGINNAME + loginName;</span><br><span class="line">        <span class="comment">//获取缓存</span></span><br><span class="line">        Cache&lt;Object, Object&gt; cache = simpleCacheService.getCache(key);</span><br><span class="line">        <span class="comment">//缓存存在</span></span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(cache))&#123;</span><br><span class="line">            <span class="keyword">return</span> (User) cache.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//缓存不存在</span></span><br><span class="line">        User user = userAdapter.findUserByLoginName(loginName);</span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(user))&#123;</span><br><span class="line">            Map&lt;Object,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            map.put(key, user);</span><br><span class="line">            SimpleMapCache simpleMapCache = <span class="keyword">new</span> SimpleMapCache(key, map);</span><br><span class="line">            simpleCacheService.creatCache(key, simpleMapCache);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findResourcesIds</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">        String sessionId = ShiroUtil.getShiroSessionId();</span><br><span class="line">        String key = CacheConstant.RESOURCES_KEY_IDS+sessionId;</span><br><span class="line">        List&lt;Resource&gt; resources = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">//获取缓存</span></span><br><span class="line">        Cache&lt;Object, Object&gt; cache = simpleCacheService.getCache(key);</span><br><span class="line">        <span class="comment">//缓存存在</span></span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(cache))&#123;</span><br><span class="line">            resources = (List&lt;Resource&gt;) cache.get(key);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//缓存不存在</span></span><br><span class="line">            resources = userAdapter.findResourceByUserId(userId);</span><br><span class="line">            <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(resources))&#123;</span><br><span class="line">                Map&lt;Object,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                map.put(key, resources);</span><br><span class="line">                SimpleMapCache simpleMapCache = <span class="keyword">new</span> SimpleMapCache(key, map);</span><br><span class="line">                simpleCacheService.creatCache(key,simpleMapCache );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; ids = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Resource resource : resources) &#123;</span><br><span class="line">            ids.add(resource.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ids;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationInfo <span class="title">getAuthorizationInfo</span><span class="params">(ShiroUser shiroUser)</span> </span>&#123;</span><br><span class="line">        String sessionId = ShiroUtil.getShiroSessionId();</span><br><span class="line">        String roleKey = CacheConstant.ROLE_KEY+sessionId;</span><br><span class="line">        String resourcesKey = CacheConstant.RESOURCES_KEY+sessionId;</span><br><span class="line">        <span class="comment">//查询用户对应的角色标识</span></span><br><span class="line">        List&lt;String&gt; roleList = <span class="keyword">this</span>.findRoleList(roleKey,shiroUser.getId());</span><br><span class="line">        <span class="comment">//查询用户对于的资源标识</span></span><br><span class="line">        List&lt;String&gt; resourcesList = <span class="keyword">this</span>.findResourcesList(resourcesKey,shiroUser.getId());</span><br><span class="line">        <span class="comment">//构建鉴权信息对象</span></span><br><span class="line">        SimpleAuthorizationInfo simpleAuthorizationInfo = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">        simpleAuthorizationInfo.addRoles(roleList);</span><br><span class="line">        simpleAuthorizationInfo.addStringPermissions(resourcesList);</span><br><span class="line">        <span class="keyword">return</span> simpleAuthorizationInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findRoleList</span><span class="params">(String key,String userId)</span></span>&#123;</span><br><span class="line">        List&lt;Role&gt; roles = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">//获得缓存</span></span><br><span class="line">        Cache&lt;Object, Object&gt; cache = simpleCacheService.getCache(key);</span><br><span class="line">        <span class="comment">//缓存存在</span></span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(cache))&#123;</span><br><span class="line">            roles = (List&lt;Role&gt;) cache.get(key);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//缓存不存在</span></span><br><span class="line">            roles = userAdapter.findRoleByUserId(userId);</span><br><span class="line">            <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(roles))&#123;</span><br><span class="line">                Map&lt;Object,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                map.put(key, roles);</span><br><span class="line">                SimpleMapCache simpleMapCache = <span class="keyword">new</span> SimpleMapCache(key, map);</span><br><span class="line">                simpleCacheService.creatCache(key,simpleMapCache );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; roleLabel = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Role role : roles) &#123;</span><br><span class="line">            roleLabel.add(role.getLabel());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> roleLabel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findResourcesList</span><span class="params">(String key,String userId)</span></span>&#123;</span><br><span class="line">        List&lt;Resource&gt; resources = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">//获得缓存</span></span><br><span class="line">        Cache&lt;Object, Object&gt; cache = simpleCacheService.getCache(key);</span><br><span class="line">        <span class="comment">//缓存存在</span></span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(cache))&#123;</span><br><span class="line">            resources = (List&lt;Resource&gt;) cache.get(key);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//缓存不存在</span></span><br><span class="line">            resources = userAdapter.findResourceByUserId(userId);</span><br><span class="line">            <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(resources))&#123;</span><br><span class="line">                Map&lt;Object,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                map.put(key, resources);</span><br><span class="line">                SimpleMapCache simpleMapCache = <span class="keyword">new</span> SimpleMapCache(key, map);</span><br><span class="line">                simpleCacheService.creatCache(key,simpleMapCache );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;String&gt; resourceLabel = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Resource resource : resources) &#123;</span><br><span class="line">            resourceLabel.add(resource.getLabel());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resourceLabel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadUserAuthorityToCache</span><span class="params">(ShiroUser shiroUser)</span> </span>&#123;</span><br><span class="line">        String sessionId = ShiroUtil.getShiroSessionId();</span><br><span class="line">        String roleKey = CacheConstant.ROLE_KEY+sessionId;</span><br><span class="line">        String resourcesKey = CacheConstant.RESOURCES_KEY+sessionId;</span><br><span class="line">        <span class="comment">//查询用户对应的角色标识</span></span><br><span class="line">        List&lt;String&gt; roleList = <span class="keyword">this</span>.findRoleList(roleKey,shiroUser.getId());</span><br><span class="line">        <span class="comment">//查询用户对于的资源标识</span></span><br><span class="line">        List&lt;String&gt; resourcesList = <span class="keyword">this</span>.findResourcesList(resourcesKey,shiroUser.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="测试-4"><a href="#测试-4" class="headerlink" title="测试"></a>测试</h3><p>使用debug模式启动项目，使用admin/pass登录系统，访问资源，进入debug模式</p>
<p>第一次访问走数据库</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210321.png" alt="1581845508601"></p>
<p>第二次走缓存</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210317.png" alt="1581845570053"></p>
<h3 id="缓存的清理"><a href="#缓存的清理" class="headerlink" title="缓存的清理"></a>缓存的清理</h3><p>我们实现的realm的集中式缓存，那么还有什么问题没有解决呢？</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210314.png" alt="1584603830411"></p>
<p>用户在点击退出时候，我们还没有清理缓存！如果不清理，在用户量大的时候，可能会有大量的垃圾信息在redis中存在。</p>
<p>重写ShiroConfig</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.CacheConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.SuperConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.ShiroDbRealm;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.SimpleCacheService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.ShiroUser;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.SimpleToken;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.bridge.UserBridgeService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.BeanConv;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.ShiroUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.credential.HashedCredentialsMatcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：自定义realm的抽象类实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroDbRealmImpl</span> <span class="keyword">extends</span> <span class="title">ShiroDbRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserBridgeService userBridgeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    SimpleCacheService simpleCacheService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        <span class="comment">//token令牌信息</span></span><br><span class="line">        SimpleToken simpleToken = (SimpleToken) token;</span><br><span class="line">        <span class="comment">//查询user对象</span></span><br><span class="line">        User user = userBridgeService.findUserByLoginName(simpleToken.getUsername());</span><br><span class="line">        <span class="keyword">if</span> (EmptyUtil.isNullOrEmpty(user))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(<span class="string">&quot;账号不存在！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//构建认证令牌对象</span></span><br><span class="line">        ShiroUser shiroUser = BeanConv.toBean(user, ShiroUser.class);</span><br><span class="line">        shiroUser.setResourceIds(userBridgeService.findResourcesIds(shiroUser.getId()));</span><br><span class="line">        String slat  = shiroUser.getSalt();</span><br><span class="line">        String password = shiroUser.getPassWord();</span><br><span class="line">        <span class="comment">//构建认证信息对象:1、令牌对象 2、密文密码  3、加密因子 4、当前realm的名称</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(shiroUser, password, ByteSource.Util.bytes(slat), getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        ShiroUser shiroUser = (ShiroUser) principals.getPrimaryPrincipal();</span><br><span class="line">        <span class="keyword">return</span> userBridgeService.getAuthorizationInfo(shiroUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doClearCache</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        ShiroUser shiroUser = (ShiroUser) principals.getPrimaryPrincipal();</span><br><span class="line">        String sessionId = ShiroUtil.getShiroSessionId();</span><br><span class="line">        String roleKey = CacheConstant.ROLE_KEY+sessionId;</span><br><span class="line">        String resourcesKey = CacheConstant.RESOURCES_KEY+sessionId;</span><br><span class="line">        String loginNamekey = CacheConstant.FIND_USER_BY_LOGINNAME + shiroUser.getLoginName();</span><br><span class="line">        String resourcesIdKey = CacheConstant.RESOURCES_KEY_IDS+sessionId;</span><br><span class="line">        simpleCacheService.removeCache(roleKey);</span><br><span class="line">        simpleCacheService.removeCache(resourcesKey);</span><br><span class="line">        simpleCacheService.removeCache(loginNamekey);</span><br><span class="line">        simpleCacheService.removeCache(resourcesIdKey);</span><br><span class="line">        <span class="keyword">super</span>.doClearCache(principals);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initCredentialsMatcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//指定密码算法</span></span><br><span class="line">        HashedCredentialsMatcher hashedCredentialsMatcher = <span class="keyword">new</span> HashedCredentialsMatcher(SuperConstant.HASH_ALGORITHM);</span><br><span class="line">        <span class="comment">//指定迭代次数</span></span><br><span class="line">        hashedCredentialsMatcher.setHashIterations(SuperConstant.HASH_INTERATIONS);</span><br><span class="line">        <span class="comment">//生效密码比较器</span></span><br><span class="line">        setCredentialsMatcher(hashedCredentialsMatcher);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="实现分布式会话SessionManager"><a href="#实现分布式会话SessionManager" class="headerlink" title="实现分布式会话SessionManager"></a>实现分布式会话SessionManager</h2><h3 id="会话的问题"><a href="#会话的问题" class="headerlink" title="会话的问题"></a>会话的问题</h3><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210309.png" alt="1581846589128"></p>
<h3 id="分布式会话实现思路"><a href="#分布式会话实现思路" class="headerlink" title="分布式会话实现思路"></a>分布式会话实现思路</h3><h4 id="原理分析-3"><a href="#原理分析-3" class="headerlink" title="原理分析"></a>原理分析</h4><p>​        所有服务器的session信息都存储到了同一个Redis集群中，即所有的服务都将 Session 的信息存储到 Redis 集群中，无论是对 Session 的注销、更新都会同步到集群中，达到了 Session 共享的目的。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210306.png" alt="1581846769926"></p>
<p>​        Cookie 保存在客户端浏览器中，而 Session 保存在服务器上。客户端浏览器访问服务器的时候，服务器把客户端信息以某种形式记录在服务器上，这就是 Session。客户端浏览器再次访问时只需要从该 Session 中查找该客户的状态就可以了。</p>
<p>​        在实际工作中我们建议使用外部的缓存设备(包括Redis)来共享 Session，避免单个服务器节点挂掉而影响服务，共享数据都会放到外部缓存容器中</p>
<h4 id="设计类图详解"><a href="#设计类图详解" class="headerlink" title="设计类图详解"></a>设计类图详解</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210301.png" alt="1584524503148"></p>
<h3 id="RedisSessionDao"><a href="#RedisSessionDao" class="headerlink" title="RedisSessionDao"></a>RedisSessionDao</h3><p>RedisSessionDao继承AbstractSessionDAO，重写了会话的创建、读取、修改等操作，全部缓存与redis中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.CacheConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.ShiroRedissionSerialize;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.Session;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.mgt.eis.AbstractSessionDAO;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RBucket;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 实现shiro session的memcached集中式管理~</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisSessionDao</span> <span class="keyword">extends</span> <span class="title">AbstractSessionDAO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Resource(name = &quot;redissonClientForShiro&quot;)</span></span><br><span class="line">	RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Long globalSessionTimeout;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Serializable <span class="title">doCreate</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">		Serializable sessionId = generateSessionId(session);</span><br><span class="line">		assignSessionId(session, sessionId);</span><br><span class="line"><span class="comment">//		log.info(&quot;=============创建sessionId:&#123;&#125;&quot;,sessionId);</span></span><br><span class="line">		RBucket&lt;String&gt; sessionIdRBucket = redissonClient.getBucket(CacheConstant.GROUP_CAS+sessionId.toString());</span><br><span class="line">		sessionIdRBucket.trySet(ShiroRedissionSerialize.serialize(session), globalSessionTimeout, TimeUnit.SECONDS);</span><br><span class="line">		<span class="keyword">return</span> sessionId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Session <span class="title">doReadSession</span><span class="params">(Serializable sessionId)</span> </span>&#123;</span><br><span class="line">		RBucket&lt;String&gt; sessionIdRBucket = redissonClient.getBucket(CacheConstant.GROUP_CAS+sessionId.toString());</span><br><span class="line">		Session session = (Session) ShiroRedissionSerialize.deserialize(sessionIdRBucket.get());</span><br><span class="line"><span class="comment">//		log.info(&quot;=============读取sessionId:&#123;&#125;&quot;,session.getId().toString());</span></span><br><span class="line">		<span class="keyword">return</span> session;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line"><span class="comment">//		log.info(&quot;=============删除sessionId:&#123;&#125;&quot;,session.getId().toString());</span></span><br><span class="line">		RBucket&lt;String&gt; sessionIdRBucket = redissonClient.getBucket(CacheConstant.GROUP_CAS+session.getId().toString());</span><br><span class="line">		sessionIdRBucket.delete();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Collection&lt;Session&gt; <span class="title">getActiveSessions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Collections.emptySet();  </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">		RBucket&lt;String&gt; sessionIdRBucket = redissonClient.getBucket(CacheConstant.GROUP_CAS+session.getId().toString());</span><br><span class="line">		sessionIdRBucket.set(ShiroRedissionSerialize.serialize(session), globalSessionTimeout, TimeUnit.SECONDS);</span><br><span class="line"><span class="comment">//		log.info(&quot;=============修改sessionId:&#123;&#125;&quot;,session.getId().toString());</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGlobalSessionTimeout</span><span class="params">(Long globalSessionTimeout)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.globalSessionTimeout = globalSessionTimeout;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="重写ShiroConfig"><a href="#重写ShiroConfig" class="headerlink" title="重写ShiroConfig"></a>重写ShiroConfig</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.ShiroDbRealm;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.impl.RedisSessionDao;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.impl.ShiroCacheManager;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.impl.ShiroDbRealmImpl;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.filter.RolesOrAuthorizationFilter;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.properties.PropertiesUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.mgt.eis.SessionDAO;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.LifecycleBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.servlet.SimpleCookie;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.session.mgt.DefaultWebSessionManager;</span><br><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.redisson.config.Config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.DependsOn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 权限配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &quot;com.itheima.shiro.core&quot;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;ShiroRedisProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShiroRedisProperties shiroRedisProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> redission客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;redissonClientForShiro&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedissonClient <span class="title">redissonClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;=====初始化redissonClientForShiro开始======&quot;</span>);</span><br><span class="line">        String[] nodeList = shiroRedisProperties.getNodes().split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        Config config = <span class="keyword">new</span> Config();</span><br><span class="line">        <span class="keyword">if</span> (nodeList.length == <span class="number">1</span>) &#123;</span><br><span class="line">            config.useSingleServer().setAddress(nodeList[<span class="number">0</span>])</span><br><span class="line">                    .setConnectTimeout(shiroRedisProperties.getConnectTimeout())</span><br><span class="line">                    .setConnectionMinimumIdleSize(shiroRedisProperties.getConnectionMinimumidleSize())</span><br><span class="line">                    .setConnectionPoolSize(shiroRedisProperties.getConnectPoolSize()).setTimeout(shiroRedisProperties.getTimeout());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            config.useClusterServers().addNodeAddress(nodeList)</span><br><span class="line">                    .setConnectTimeout(shiroRedisProperties.getConnectTimeout())</span><br><span class="line">                    .setMasterConnectionMinimumIdleSize(shiroRedisProperties.getConnectionMinimumidleSize())</span><br><span class="line">                    .setMasterConnectionPoolSize(shiroRedisProperties.getConnectPoolSize()).setTimeout(shiroRedisProperties.getTimeout());</span><br><span class="line">        &#125;</span><br><span class="line">        RedissonClient redissonClient =  Redisson.create(config);</span><br><span class="line">        log.info(<span class="string">&quot;=====初始化redissonClientForShiro完成======&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> redissonClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 创建cookie对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;sessionIdCookie&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleCookie <span class="title">simpleCookie</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SimpleCookie simpleCookie = <span class="keyword">new</span> SimpleCookie();</span><br><span class="line">        simpleCookie.setName(<span class="string">&quot;ShiroSession&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> simpleCookie;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 权限管理器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;securityManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">defaultWebSecurityManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        securityManager.setRealm(shiroDbRealm());</span><br><span class="line">        securityManager.setSessionManager(shiroSessionManager());</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义RealmImpl</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;shiroDbRealm&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroDbRealm <span class="title">shiroDbRealm</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ShiroDbRealmImpl();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义session会话存储的实现类 ，使用Redis来存储共享session，达到分布式部署目的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;redisSessionDao&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SessionDAO <span class="title">redisSessionDao</span><span class="params">()</span></span>&#123;</span><br><span class="line">        RedisSessionDao sessionDAO =   <span class="keyword">new</span> RedisSessionDao();</span><br><span class="line">        sessionDAO.setGlobalSessionTimeout(shiroRedisProperties.getGlobalSessionTimeout());</span><br><span class="line">        <span class="keyword">return</span> sessionDAO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 会话管理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;sessionManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultWebSessionManager <span class="title">shiroSessionManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultWebSessionManager sessionManager = <span class="keyword">new</span> DefaultWebSessionManager();</span><br><span class="line">        sessionManager.setSessionDAO(redisSessionDao());</span><br><span class="line">        sessionManager.setSessionValidationSchedulerEnabled(<span class="keyword">false</span>);</span><br><span class="line">        sessionManager.setSessionIdCookieEnabled(<span class="keyword">true</span>);</span><br><span class="line">        sessionManager.setSessionIdCookie(simpleCookie());</span><br><span class="line">        sessionManager.setGlobalSessionTimeout(shiroRedisProperties.getGlobalSessionTimeout());</span><br><span class="line">        <span class="keyword">return</span> sessionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 保证实现了Shiro内部lifecycle函数的bean执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;lifecycleBeanPostProcessor&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LifecycleBeanPostProcessor <span class="title">getLifecycleBeanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LifecycleBeanPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> AOP式方法级权限检查</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@DependsOn(&quot;lifecycleBeanPostProcessor&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title">getDefaultAdvisorAutoProxyCreator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultAdvisorAutoProxyCreator defaultAdvisorAutoProxyCreator = <span class="keyword">new</span> DefaultAdvisorAutoProxyCreator();</span><br><span class="line">        defaultAdvisorAutoProxyCreator.setProxyTargetClass(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultAdvisorAutoProxyCreator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 配合DefaultAdvisorAutoProxyCreator事项注解权限校验</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title">getAuthorizationAttributeSourceAdvisor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        AuthorizationAttributeSourceAdvisor aasa = <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">        aasa.setSecurityManager(defaultWebSecurityManager());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 过滤器链</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">filterChainDefinition</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;Object&gt; list  = PropertiesUtil.propertiesShiro.getKeyList();</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Object object : list) &#123;</span><br><span class="line">            String key = object.toString();</span><br><span class="line">            String value = PropertiesUtil.getShiroValue(key);</span><br><span class="line">            log.info(<span class="string">&quot;读取防止盗链控制：---key&#123;&#125;,---value:&#123;&#125;&quot;</span>,key,value);</span><br><span class="line">            map.put(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义过滤器定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, Filter&gt; <span class="title">filters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Filter&gt; map = <span class="keyword">new</span> HashMap&lt;String, Filter&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;roleOr&quot;</span>, <span class="keyword">new</span> RolesOrAuthorizationFilter());</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> Shiro过滤器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;shiroFilter&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shiroFilterFactoryBean</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ShiroFilterFactoryBean shiroFilter = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">        shiroFilter.setSecurityManager(defaultWebSecurityManager());</span><br><span class="line">        <span class="comment">//使自定义过滤器生效</span></span><br><span class="line">        shiroFilter.setFilters(filters());</span><br><span class="line">        shiroFilter.setFilterChainDefinitionMap(filterChainDefinition());</span><br><span class="line">        shiroFilter.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        shiroFilter.setUnauthorizedUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> shiroFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="测试-5"><a href="#测试-5" class="headerlink" title="测试"></a>测试</h3><p>此时我们需要2个相同的项目shiro-day01-12shiro-redis-SessionManager-A和shiro-day01-13shiro-redis-SessionManager-B</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210251.png" alt="1581929726816"></p>
<p>分别启动A,B2个项目</p>
<p>访问<a target="_blank" rel="noopener" href="http://127.0.0.1:8081/shiro/login%EF%BC%8C%E4%BD%BF%E7%94%A8admin/pass%E7%99%BB%E5%BD%95">http://127.0.0.1:8081/shiro/login，使用admin/pass登录</a></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210247.png" alt="1581929790783"></p>
<p>修改地址栏<a target="_blank" rel="noopener" href="http://127.0.0.1:8081/shiro/menus/system%E4%B8%BAhttp://127.0.0.1:8082/shiro/menus/system%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E6%AD%A3%E5%B8%B8%E8%AE%BF%E9%97%AE">http://127.0.0.1:8081/shiro/menus/system为http://127.0.0.1:8082/shiro/menus/system，也可以正常访问</a></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210242.png" alt="1581929843249"></p>
<p>此时我们实现了在A服务登录，直接访问B服务则无需登录</p>
<h2 id="限制密码重试次数"><a href="#限制密码重试次数" class="headerlink" title="限制密码重试次数"></a>限制密码重试次数</h2><h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>保证原子性：</p>
<p>​        单系统：AtomicLong计数</p>
<p>​        集群系统：RedissionClient提供的RAtomicLong计数</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">1、获取系统中是否已有登录次数缓存,缓存对象结构预期为：&quot;用户名--登录次数&quot;。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">2、如果之前没有登录缓存，则创建一个登录次数缓存。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">3、如果缓存次数已经超过限制，则驳回本次登录请求。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">4、将缓存记录的登录次数加1,设置指定时间内有效</span></span><br><span class="line"></span><br><span class="line"><span class="attr">5、验证用户本次输入的帐号密码，如果登录登录成功，则清除掉登录次数的缓存</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>思路有了，那我们在哪里实现呢？我们知道AuthenticatingRealm里有比较密码的入口doCredentialsMatch方法</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210237.png" alt="1581930861293"></p>
<p>查看其实现</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210231.png" alt="1581930945007"></p>
<h3 id="自定义密码比较器"><a href="#自定义密码比较器" class="headerlink" title="自定义密码比较器"></a>自定义密码比较器</h3><p>新建项目shiro-day01-14shiro-RetryLimit</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210229.png" alt="1581934188203"></p>
<h4 id="RetryLimitCredentialsMatcher"><a href="#RetryLimitCredentialsMatcher" class="headerlink" title="RetryLimitCredentialsMatcher"></a>RetryLimitCredentialsMatcher</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.ShiroUser;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.ExcessiveAttemptsException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.credential.HashedCredentialsMatcher;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RAtomicLong;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：密码重试比较器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RetryLimitCredentialsMatcher</span> <span class="keyword">extends</span> <span class="title">HashedCredentialsMatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Long RETRY_LIMIT_NUM = <span class="number">4L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 构造函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> hashAlgorithmName 匹配次数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RetryLimitCredentialsMatcher</span><span class="params">(String hashAlgorithmName,RedissonClient redissonClient)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(hashAlgorithmName);</span><br><span class="line">        <span class="keyword">this</span>.redissonClient = redissonClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">doCredentialsMatch</span><span class="params">(AuthenticationToken token, AuthenticationInfo info)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获得登录吗</span></span><br><span class="line">        String loginName = (String) token.getPrincipal();</span><br><span class="line">        <span class="comment">//获得缓存</span></span><br><span class="line">        RAtomicLong atomicLong = redissonClient.getAtomicLong(loginName);</span><br><span class="line">        <span class="keyword">long</span> retryFlag = atomicLong.get();</span><br><span class="line">        <span class="comment">//判断次数</span></span><br><span class="line">        <span class="keyword">if</span> (retryFlag&gt;RETRY_LIMIT_NUM)&#123;</span><br><span class="line">            <span class="comment">//超过次数设计10分钟后重试</span></span><br><span class="line">            atomicLong.expire(<span class="number">10</span>, TimeUnit.MICROSECONDS);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExcessiveAttemptsException(<span class="string">&quot;密码错误5次，请10分钟以后再试&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//累加次数</span></span><br><span class="line">        atomicLong.incrementAndGet();</span><br><span class="line">        atomicLong.expire(<span class="number">10</span>, TimeUnit.MICROSECONDS);</span><br><span class="line">        <span class="comment">//密码校验</span></span><br><span class="line">        <span class="keyword">boolean</span> flag =  <span class="keyword">super</span>.doCredentialsMatch(token, info);</span><br><span class="line">        <span class="keyword">if</span> (flag)&#123;</span><br><span class="line">            <span class="comment">//校验成功删除限制</span></span><br><span class="line">            atomicLong.delete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="重写ShiroDbRealmImpl"><a href="#重写ShiroDbRealmImpl" class="headerlink" title="重写ShiroDbRealmImpl"></a>重写ShiroDbRealmImpl</h4><p>修改initCredentialsMatcher方法，使用RetryLimitCredentialsMatcher</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.CacheConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.SuperConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.SimpleCacheManager;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.ShiroUser;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.SimpleToken;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.ShiroDbRealm;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.bridge.UserBridgeService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.SimpleAuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UnknownAccountException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.credential.HashedCredentialsMatcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：自定义shiro的实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroDbRealmImpl</span> <span class="keyword">extends</span> <span class="title">ShiroDbRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserBridgeService userBridgeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SimpleCacheManager simpleCacheManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;redissonClientForShiro&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 认证方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authcToken 校验传入令牌</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> AuthenticationInfo</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authcToken)</span> </span>&#123;</span><br><span class="line">        SimpleToken token = (SimpleToken)authcToken;</span><br><span class="line">        User user  = userBridgeService.findUserByLoginName(token.getUsername());</span><br><span class="line">        <span class="keyword">if</span>(EmptyUtil.isNullOrEmpty(user))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(<span class="string">&quot;账号不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ShiroUser shiroUser = BeanConv.toBean(user, ShiroUser.class);</span><br><span class="line">        String sessionId = ShiroUserUtil.getShiroSessionId();</span><br><span class="line">        String cacheKeyResourcesIds = CacheConstant.RESOURCES_KEY_IDS+sessionId;</span><br><span class="line">        shiroUser.setResourceIds(userBridgeService.findResourcesIdsList(cacheKeyResourcesIds,user.getId()));</span><br><span class="line">        String salt = user.getSalt();</span><br><span class="line">        String password = user.getPassWord();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(shiroUser, password, ByteSource.Util.bytes(salt), getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 授权方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> principals SimpleAuthenticationInfo对象第一个参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        ShiroUser shiroUser = (ShiroUser) principals.getPrimaryPrincipal();</span><br><span class="line">        <span class="keyword">return</span> userBridgeService.getAuthorizationInfo(shiroUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 清理缓存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doClearCache</span><span class="params">(PrincipalCollection principalcollection)</span> </span>&#123;</span><br><span class="line">        String sessionId = ShiroUtil.getShiroSessionId();</span><br><span class="line">        simpleCacheManager.removeCache(CacheConstant.ROLE_KEY+sessionId);</span><br><span class="line">        simpleCacheManager.removeCache(CacheConstant.RESOURCES_KEY+sessionId);</span><br><span class="line">        simpleCacheManager.removeCache(CacheConstant.TOKEN+sessionId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 加密方式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initCredentialsMatcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RetryLimitCredentialsMatcher matcher = <span class="keyword">new</span> RetryLimitCredentialsMatcher(SuperConstant.HASH_ALGORITHM,redissonClient);</span><br><span class="line">        matcher.setHashIterations(SuperConstant.HASH_INTERATIONS);</span><br><span class="line">        setCredentialsMatcher(matcher);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="测试-6"><a href="#测试-6" class="headerlink" title="测试"></a>测试</h3><p>访问<a target="_blank" rel="noopener" href="http://127.0.0.1/shiro/login%EF%BC%8C%E4%BD%BF%E7%94%A8admin%E8%B4%A6%E5%8F%B7%E8%BE%93%E5%85%A5%E9%94%99%E8%AF%AF%E5%AF%86%E7%A0%815%E6%AC%A1">http://127.0.0.1/shiro/login，使用admin账号输入错误密码5次</a></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210218.png" alt="1581933402187"></p>
<h2 id="在线并发登录人数控制"><a href="#在线并发登录人数控制" class="headerlink" title="在线并发登录人数控制"></a>在线并发登录人数控制</h2><h3 id="实现原理-1"><a href="#实现原理-1" class="headerlink" title="实现原理"></a>实现原理</h3><p>在实际开发中，我们可能会遇到这样的需求，一个账号只允许同时一个在线，当账号在其他地方登陆的时候，会踢出前面登陆的账号，那我们怎么实现</p>
<ul>
<li><p>自定义过滤器:继承AccessControlFilter</p>
</li>
<li><p>使用redis队列控制账号在线数目</p>
<p>  实现步骤：</p>
</li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">1、只针对登录用户处理，首先判断是否登录</span></span><br><span class="line"><span class="attr">2、使用RedissionClien创建队列</span></span><br><span class="line"><span class="meta">3、判断当前sessionId是否存在于此用户的队列</span>=<span class="string">key:登录名 value：多个sessionId</span></span><br><span class="line"><span class="meta">4、不存在则放入队列尾端</span>=<span class="string">=&gt;存入sessionId</span></span><br><span class="line"><span class="attr">5、判断当前队列大小是否超过限定此账号的可在线人数</span></span><br><span class="line"><span class="attr">6、超过：</span></span><br><span class="line">	<span class="attr">*从队列头部拿到用户sessionId</span></span><br><span class="line">	<span class="attr">*从sessionManger根据sessionId拿到session</span></span><br><span class="line">	<span class="attr">*从sessionDao中移除session会话</span></span><br><span class="line"><span class="attr">7、未超过：放过操作</span></span><br></pre></td></tr></table></figure>

<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><h4 id="KickedOutAuthorizationFilter"><a href="#KickedOutAuthorizationFilter" class="headerlink" title="KickedOutAuthorizationFilter"></a>KickedOutAuthorizationFilter</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.impl.RedisSessionDao;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.ShiroUserUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.ExpiredSessionException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.Session;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.UnknownSessionException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.mgt.DefaultSessionKey;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.mgt.eis.SessionDAO;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.AccessControlFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.session.mgt.DefaultWebSessionManager;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RDeque;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KickedOutAuthorizationFilter</span> <span class="keyword">extends</span> <span class="title">AccessControlFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SessionDAO redisSessionDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DefaultWebSessionManager sessionManager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">KickedOutAuthorizationFilter</span><span class="params">(RedissonClient redissonClient, SessionDAO redisSessionDao, DefaultWebSessionManager sessionManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.redissonClient = redissonClient;</span><br><span class="line">        <span class="keyword">this</span>.redisSessionDao = redisSessionDao;</span><br><span class="line">        <span class="keyword">this</span>.sessionManager = sessionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isAccessAllowed</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, Object o)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onAccessDenied</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Subject subject = getSubject(servletRequest, servletResponse);</span><br><span class="line">        <span class="keyword">if</span> (!subject.isAuthenticated()) &#123;</span><br><span class="line">            <span class="comment">//如果没有登录，直接进行之后的流程</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//存放session对象进入队列</span></span><br><span class="line">        String sessionId = ShiroUserUtil.getShiroSessionId();</span><br><span class="line">        String LoginName = ShiroUserUtil.getShiroUser().getLoginName();</span><br><span class="line">        RDeque&lt;String&gt; queue = redissonClient.getDeque(<span class="string">&quot;KickedOutAuthorizationFilter:&quot;</span>+LoginName);</span><br><span class="line">        <span class="comment">//判断sessionId是否存在于此用户的队列中</span></span><br><span class="line">        <span class="keyword">boolean</span> flag = queue.contains(sessionId);</span><br><span class="line">        <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">            queue.addLast(sessionId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果此时队列大于1，则开始踢人</span></span><br><span class="line">        <span class="keyword">if</span> (queue.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            sessionId = queue.getFirst();</span><br><span class="line">            queue.removeFirst();</span><br><span class="line">            Session session = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                session = sessionManager.getSession(<span class="keyword">new</span> DefaultSessionKey(sessionId));</span><br><span class="line">            &#125;<span class="keyword">catch</span> (UnknownSessionException ex)&#123;</span><br><span class="line">                log.info(<span class="string">&quot;session已经失效&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (ExpiredSessionException expiredSessionException)&#123;</span><br><span class="line">                log.info(<span class="string">&quot;session已经过期&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(session))&#123;</span><br><span class="line">                redisSessionDao.delete(session);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="修改ShiroConfig"><a href="#修改ShiroConfig" class="headerlink" title="修改ShiroConfig"></a>修改ShiroConfig</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@Description</span> 自定义过滤器定义</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, Filter&gt; <span class="title">filters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Filter&gt; map = <span class="keyword">new</span> HashMap&lt;String, Filter&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;roleOr&quot;</span>, <span class="keyword">new</span> RolesOrAuthorizationFilter());</span><br><span class="line">    map.put(<span class="string">&quot;kickedOut&quot;</span>, <span class="keyword">new</span> KickedOutAuthorizationFilter(redissonClient(), redisSessionDao(), shiroSessionManager()));</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="修改authentication-properties"><a href="#修改authentication-properties" class="headerlink" title="修改authentication.properties"></a>修改authentication.properties</h4><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#静态资源不过滤</span></span><br><span class="line"><span class="meta">/static/**</span>=<span class="string">anon</span></span><br><span class="line"><span class="comment">#登录链接不过滤</span></span><br><span class="line"><span class="meta">/login/**</span>=<span class="string">anon</span></span><br><span class="line"><span class="comment">#访问/resource/**需要有admin的角色</span></span><br><span class="line"><span class="meta">/resource/**</span>=<span class="string">role-or[MangerRole,SuperAdmin]</span></span><br><span class="line"><span class="comment">#其他链接是需要登录的</span></span><br><span class="line"><span class="meta">/**</span>=<span class="string">kickedOut,auth</span></span><br></pre></td></tr></table></figure>

<h3 id="测试-7"><a href="#测试-7" class="headerlink" title="测试"></a>测试</h3><p>使用谷歌访问<a target="_blank" rel="noopener" href="http://127.0.0.1/shiro/login%EF%BC%8C%E4%BD%BF%E7%94%A8admin/pass%E7%99%BB%E9%99%86">http://127.0.0.1/shiro/login，使用admin/pass登陆</a></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210213.png" alt="1581948184529"></p>
<p>使用IE再访问<a target="_blank" rel="noopener" href="http://127.0.0.1/shiro/login%EF%BC%8C%E4%BD%BF%E7%94%A8admin/pass%E7%99%BB%E9%99%86">http://127.0.0.1/shiro/login，使用admin/pass登陆</a></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210208.png" alt="1581948255302"></p>
<p>再刷新谷歌浏览器,发现账号被踢出</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210204.png" alt="1581948283827"></p>
<h2 id="Springboot-Shiro-Jwt前后端分离鉴权"><a href="#Springboot-Shiro-Jwt前后端分离鉴权" class="headerlink" title="Springboot+Shiro+Jwt前后端分离鉴权"></a>Springboot+Shiro+Jwt前后端分离鉴权</h2><h3 id="前后端分离会话问题"><a href="#前后端分离会话问题" class="headerlink" title="前后端分离会话问题"></a>前后端分离会话问题</h3><h4 id="问题追踪"><a href="#问题追踪" class="headerlink" title="问题追踪"></a>问题追踪</h4><p>​        前面我们实现分布式的会话缓存，但是我们发现此功能的实现是基于浏览的cookie机制，也就是说用户禁用cookie后，我们的系统会就会产生会话不同的问题</p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p>​       我们的前端可能是web、Android、ios等应用，同时我们每一个接口都提供了无状态的应答方式，这里我们提供了基于JWT的token生成方案</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">1、用户登陆之后，获得此时会话的sessionId,使用JWT根据sessionId颁发签名并设置过期时间(与session过期时间相同)返回token</span></span><br><span class="line"></span><br><span class="line"><span class="attr">2、将token保存到客户端本地，并且每次发送请求时都在header上携带JwtToken</span></span><br><span class="line"></span><br><span class="line"><span class="attr">3、ShiroSessionManager继承DefaultWebSessionManager，重写getSessionId方法，从header上检测是否携带JwtToken，如果携带，则进行解码JwtToken，使用JwtToken中的jti作为SessionId。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">4、重写shiro的默认过滤器，使其支持jwtToken有效期校验、及对JSON的返回支持</span></span><br><span class="line">	<span class="attr">JwtAuthcFilter</span>:<span class="string">实现是否需要登录的过滤，拒绝时如果header上携带JwtToken,则返回对应json</span></span><br><span class="line">	<span class="attr">JwtPermsFilter</span>:<span class="string">实现是否有对应资源的过滤，拒绝时如果header上携带JwtToken,则返回对应json</span></span><br><span class="line">	<span class="attr">JwtRolesFilter</span>:<span class="string">实现是否有对应角色的过滤，拒绝时如果header上携带JwtToken,则返回对应json</span></span><br></pre></td></tr></table></figure>



<h3 id="JWT概述"><a href="#JWT概述" class="headerlink" title="JWT概述"></a>JWT概述</h3><p>JWT（JSON WEB TOKEN）：JSON网络令牌，JWT是一个轻便的安全跨平台传输格式，定义了一个紧凑的自包含的方式在不同实体之间安全传输信息（JSON格式）。它是在Web环境下两个实体之间传输数据的一项标准。实际上传输的就是一个字符串。</p>
<ul>
<li><p>广义上：JWT是一个标准的名称；</p>
</li>
<li><p>狭义上：JWT指的就是用来传递的那个token字符串</p>
</li>
</ul>
<p>JWT由三部分构成：header（头部）、payload（载荷）和signature（签名）。</p>
<ol>
<li><p>Header</p>
<p> 存储两个变量</p>
<ol>
<li>秘钥（可以用来比对）</li>
<li>算法（也就是下面将Header和payload加密成Signature）</li>
</ol>
</li>
<li><p>payload</p>
<p> 存储很多东西，基础信息有如下几个</p>
<ol>
<li>签发人，也就是这个“令牌”归属于哪个用户。一般是<code>userId</code> </li>
<li>创建时间，也就是这个令牌是什么时候创建的</li>
<li>失效时间，也就是这个令牌什么时候失效(session的失效时间)</li>
<li>唯一标识，一般可以使用算法生成一个唯一标识（jti==&gt;sessionId）</li>
</ol>
</li>
<li><p>Signature</p>
<p> 这个是上面两个经过Header中的算法加密生成的，用于比对信息，防止篡改Header和payload</p>
</li>
</ol>
<p>然后将这三个部分的信息经过加密生成一个<code>JwtToken</code>的字符串，发送给客户端，客户端保存在本地。当客户端发起请求的时候携带这个到服务端(可以是在<code>cookie</code>，可以是在<code>header</code>)，在服务端进行验证，我们需要解密对于的payload的内容</p>
<h3 id="集成JWT"><a href="#集成JWT" class="headerlink" title="集成JWT"></a>集成JWT</h3><h4 id="JwtProperties"><a href="#JwtProperties" class="headerlink" title="JwtProperties"></a>JwtProperties</h4><p>​    用于支持yaml文件配置的配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：jw配置文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;itheima.framework.jwt&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtProperties</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 签名密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String hexEncodedSecretKey;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="JwtTokenManager"><a href="#JwtTokenManager" class="headerlink" title="JwtTokenManager"></a>JwtTokenManager</h4><p>负责令牌的颁发、解析、校验</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.JWT;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.JWTVerifier;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.algorithms.Algorithm;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.config.JwtProperties;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EncodesUtil;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.JwtBuilder;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jwts;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.SignatureAlgorithm;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service(&quot;jwtTokenManager&quot;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;JwtProperties.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtTokenManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JwtProperties jwtProperties;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 签发令牌</span></span><br><span class="line"><span class="comment">     *      jwt字符串包括三个部分</span></span><br><span class="line"><span class="comment">     *        1. header</span></span><br><span class="line"><span class="comment">     *            -当前字符串的类型，一般都是“JWT”</span></span><br><span class="line"><span class="comment">     *            -哪种算法加密，“HS256”或者其他的加密算法</span></span><br><span class="line"><span class="comment">     *            所以一般都是固定的，没有什么变化</span></span><br><span class="line"><span class="comment">     *        2. payload</span></span><br><span class="line"><span class="comment">     *            一般有四个最常见的标准字段（下面有）</span></span><br><span class="line"><span class="comment">     *            iat：签发时间，也就是这个jwt什么时候生成的</span></span><br><span class="line"><span class="comment">     *            jti：JWT的唯一标识</span></span><br><span class="line"><span class="comment">     *            iss：签发人，一般都是username或者userId</span></span><br><span class="line"><span class="comment">     *            exp：过期时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> iss 签发人</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ttlMillis 有效时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> claims jwt中存储的一些非隐私信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">IssuedToken</span><span class="params">(String iss, <span class="keyword">long</span> ttlMillis,String sessionId, Map&lt;String, Object&gt; claims)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (claims == <span class="keyword">null</span>) &#123;</span><br><span class="line">            claims = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> nowMillis = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        String base64EncodedSecretKey = EncodesUtil.encodeHex(jwtProperties.getBase64EncodedSecretKey().getBytes());</span><br><span class="line"></span><br><span class="line">        JwtBuilder builder = Jwts.builder()</span><br><span class="line">                .setClaims(claims)</span><br><span class="line">                .setId(sessionId)<span class="comment">//2. 这个是JWT的唯一标识，一般设置成唯一的，这个方法可以生成唯一标识,此时存储的为sessionId,登录成功后回写</span></span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> Date(nowMillis))<span class="comment">//1. 这个地方就是以毫秒为单位，换算当前系统时间生成的iat</span></span><br><span class="line">                .setSubject(iss)<span class="comment">//3. 签发人，也就是JWT是给谁的（逻辑上一般都是username或者userId）</span></span><br><span class="line">                .signWith(SignatureAlgorithm.HS256, base64EncodedSecretKey);<span class="comment">//这个地方是生成jwt使用的算法和秘钥</span></span><br><span class="line">        <span class="keyword">if</span> (ttlMillis &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">long</span> expMillis = nowMillis + ttlMillis;</span><br><span class="line">            Date exp = <span class="keyword">new</span> Date(expMillis);<span class="comment">//4. 过期时间，这个也是使用毫秒生成的，使用当前时间+前面传入的持续时间生成</span></span><br><span class="line">            builder.setExpiration(exp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 解析令牌</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwtToken 令牌</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Claims <span class="title">decodeToken</span><span class="params">(String jwtToken)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String base64EncodedSecretKey = EncodesUtil.encodeHex(jwtProperties.getBase64EncodedSecretKey().getBytes());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 得到 DefaultJwtParser</span></span><br><span class="line">        <span class="keyword">return</span> Jwts.parser()</span><br><span class="line">                <span class="comment">// 设置签名的秘钥</span></span><br><span class="line">                .setSigningKey(base64EncodedSecretKey)</span><br><span class="line">                <span class="comment">// 设置需要解析的 jwt</span></span><br><span class="line">                .parseClaimsJws(jwtToken)</span><br><span class="line">                .getBody();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 判断令牌是否合法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwtToken 令牌</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isVerifyToken</span><span class="params">(String jwtToken)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String base64EncodedSecretKey = EncodesUtil.encodeHex(jwtProperties.getBase64EncodedSecretKey().getBytes());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这个是官方的校验规则，这里只写了一个”校验算法“，可以自己加</span></span><br><span class="line">        Algorithm algorithm = Algorithm.HMAC256(EncodesUtil.decodeBase64(base64EncodedSecretKey));</span><br><span class="line">        JWTVerifier verifier = JWT.require(algorithm).build();</span><br><span class="line">        verifier.verify(jwtToken);  <span class="comment">// 校验不通过会抛出异常</span></span><br><span class="line">        <span class="comment">//判断合法的标准：1. 头部和荷载部分没有篡改过。2. 没有过期</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="重写DefaultWebSessionManager"><a href="#重写DefaultWebSessionManager" class="headerlink" title="重写DefaultWebSessionManager"></a>重写DefaultWebSessionManager</h3><p>ShiroSessionManager主要是添加jwtToken的jti作为会话的唯一标识</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.servlet.ShiroHttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.session.mgt.DefaultWebSessionManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.util.WebUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 重写Jwt会话管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroSessionManager</span> <span class="keyword">extends</span> <span class="title">DefaultWebSessionManager</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORIZATION = <span class="string">&quot;jwtToken&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REFERENCED_SESSION_ID_SOURCE = <span class="string">&quot;Stateless request&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ShiroSessionManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JwtTokenManager jwtTokenManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Serializable <span class="title">getSessionId</span><span class="params">(ServletRequest request, ServletResponse response)</span></span>&#123;</span><br><span class="line">        String jwtToken = WebUtils.toHttp(request).getHeader(AUTHORIZATION);</span><br><span class="line">        <span class="keyword">if</span>(EmptyUtil.isNullOrEmpty(jwtToken))&#123;</span><br><span class="line">            <span class="comment">//如果没有携带id参数则按照父类的方式在cookie进行获取</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.getSessionId(request, response);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//如果请求头中有 authToken 则其值为jwtToken，然后解析出会话session</span></span><br><span class="line">        	request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_SOURCE,REFERENCED_SESSION_ID_SOURCE);</span><br><span class="line">            Claims decode = jwtTokenManager.decodeToken(jwtToken);</span><br><span class="line">            String id = (String) decode.get(<span class="string">&quot;jti&quot;</span>);</span><br><span class="line">            request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID,id);</span><br><span class="line">            request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_IS_VALID,Boolean.TRUE);</span><br><span class="line">            <span class="keyword">return</span> id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="重写默认过滤器"><a href="#重写默认过滤器" class="headerlink" title="重写默认过滤器"></a>重写默认过滤器</h3><p>BaseResponse返回统一json的对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.ToString;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 基础返回封装</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseResponse</span> <span class="keyword">extends</span> <span class="title">ToString</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer code ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String msg ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String date;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseResponse</span><span class="params">(Integer code, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseResponse</span><span class="params">(Integer code, String msg, String date)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">        <span class="keyword">this</span>.date = date;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="JwtAuthcFilter"><a href="#JwtAuthcFilter" class="headerlink" title="JwtAuthcFilter"></a>JwtAuthcFilter</h4><p>使用wtTokenManager.isVerifyToken(jwtToken)校验颁发jwtToken是否合法，同时在拒绝的时候返回对应的json数据格式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.ShiroConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.BaseResponse;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.impl.JwtTokenManager;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.impl.ShiroSessionManager;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.authc.FormAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.util.WebUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：自定义登录验证过滤器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtAuthcFilter</span> <span class="keyword">extends</span> <span class="title">FormAuthenticationFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JwtTokenManager jwtTokenManager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtAuthcFilter</span><span class="params">(JwtTokenManager jwtTokenManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jwtTokenManager = jwtTokenManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 是否允许访问</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//判断当前请求头中是否带有jwtToken的字符串</span></span><br><span class="line">        String jwtToken = WebUtils.toHttp(request).getHeader(<span class="string">&quot;jwtToken&quot;</span>);</span><br><span class="line">        <span class="comment">//如果有：走jwt校验</span></span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(jwtToken))&#123;</span><br><span class="line">            <span class="keyword">boolean</span> verifyToken = jwtTokenManager.isVerifyToken(jwtToken);</span><br><span class="line">            <span class="keyword">if</span> (verifyToken)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">super</span>.isAccessAllowed(request, response, mappedValue);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//没有没有：走原始校验</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.isAccessAllowed(request, response, mappedValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 访问拒绝时调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//判断当前请求头中是否带有jwtToken的字符串</span></span><br><span class="line">        String jwtToken = WebUtils.toHttp(request).getHeader(<span class="string">&quot;jwtToken&quot;</span>);</span><br><span class="line">        <span class="comment">//如果有：返回json的应答</span></span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(jwtToken))&#123;</span><br><span class="line">            BaseResponse baseResponse = <span class="keyword">new</span> BaseResponse(ShiroConstant.NO_LOGIN_CODE,ShiroConstant.NO_LOGIN_MESSAGE);</span><br><span class="line">            response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            response.setContentType(<span class="string">&quot;application/json; charset=utf-8&quot;</span>);</span><br><span class="line">            response.getWriter().write(JSONObject.toJSONString(baseResponse));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果没有：走原始方式</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onAccessDenied(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="JwtPermsFilter"><a href="#JwtPermsFilter" class="headerlink" title="JwtPermsFilter"></a>JwtPermsFilter</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.ShiroConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.BaseResponse;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.util.WebUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：自定义jwt的资源校验</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtPermsFilter</span> <span class="keyword">extends</span> <span class="title">PermissionsAuthorizationFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 访问拒绝时调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//判断当前请求头中是否带有jwtToken的字符串</span></span><br><span class="line">        String jwtToken = WebUtils.toHttp(request).getHeader(<span class="string">&quot;jwtToken&quot;</span>);</span><br><span class="line">        <span class="comment">//如果有：返回json的应答</span></span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(jwtToken))&#123;</span><br><span class="line">            BaseResponse baseResponse = <span class="keyword">new</span> BaseResponse(ShiroConstant.NO_AUTH_CODE,ShiroConstant.NO_AUTH_MESSAGE);</span><br><span class="line">            response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            response.setContentType(<span class="string">&quot;application/json; charset=utf-8&quot;</span>);</span><br><span class="line">            response.getWriter().write(JSONObject.toJSONString(baseResponse));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果没有：走原始方式</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onAccessDenied(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="JwtRolesFilter"><a href="#JwtRolesFilter" class="headerlink" title="JwtRolesFilter"></a>JwtRolesFilter</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.ShiroConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.BaseResponse;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.authz.RolesAuthorizationFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.util.WebUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：自定义jwt角色校验</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtRolesFilter</span> <span class="keyword">extends</span> <span class="title">RolesAuthorizationFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 访问拒绝时调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//判断当前请求头中是否带有jwtToken的字符串</span></span><br><span class="line">        String jwtToken = WebUtils.toHttp(request).getHeader(<span class="string">&quot;jwtToken&quot;</span>);</span><br><span class="line">        <span class="comment">//如果有：返回json的应答</span></span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(jwtToken))&#123;</span><br><span class="line">            BaseResponse baseResponse = <span class="keyword">new</span> BaseResponse(ShiroConstant.NO_ROLE_CODE,ShiroConstant.NO_ROLE_MESSAGE);</span><br><span class="line">            response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            response.setContentType(<span class="string">&quot;application/json; charset=utf-8&quot;</span>);</span><br><span class="line">            response.getWriter().write(JSONObject.toJSONString(baseResponse));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果没有：走原始方式</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onAccessDenied(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="重写ShiroConfig-1"><a href="#重写ShiroConfig-1" class="headerlink" title="重写ShiroConfig"></a>重写ShiroConfig</h3><p>1、ShiroSessionManager替换DefaultWebSessionManager</p>
<p>2、生效过滤器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.ShiroDbRealm;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.impl.*;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.filter.*;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.properties.PropertiesUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.mgt.eis.SessionDAO;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.LifecycleBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.servlet.SimpleCookie;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.session.mgt.DefaultWebSessionManager;</span><br><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.redisson.config.Config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.DependsOn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 权限配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &#123;&quot;com.itheima.shiro.core&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;ShiroRedisProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShiroRedisProperties shiroRedisProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JwtTokenManager jwtTokenManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> redission客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;redissonClientForShiro&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedissonClient <span class="title">redissonClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;=====初始化redissonClientForShiro开始======&quot;</span>);</span><br><span class="line">        String[] nodeList = shiroRedisProperties.getNodes().split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        Config config = <span class="keyword">new</span> Config();</span><br><span class="line">        <span class="keyword">if</span> (nodeList.length == <span class="number">1</span>) &#123;</span><br><span class="line">            config.useSingleServer().setAddress(nodeList[<span class="number">0</span>])</span><br><span class="line">                    .setConnectTimeout(shiroRedisProperties.getConnectTimeout())</span><br><span class="line">                    .setConnectionMinimumIdleSize(shiroRedisProperties.getConnectionMinimumidleSize())</span><br><span class="line">                    .setConnectionPoolSize(shiroRedisProperties.getConnectPoolSize()).setTimeout(shiroRedisProperties.getTimeout());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            config.useClusterServers().addNodeAddress(nodeList)</span><br><span class="line">                    .setConnectTimeout(shiroRedisProperties.getConnectTimeout())</span><br><span class="line">                    .setMasterConnectionMinimumIdleSize(shiroRedisProperties.getConnectionMinimumidleSize())</span><br><span class="line">                    .setMasterConnectionPoolSize(shiroRedisProperties.getConnectPoolSize()).setTimeout(shiroRedisProperties.getTimeout());</span><br><span class="line">        &#125;</span><br><span class="line">        RedissonClient redissonClient =  Redisson.create(config);</span><br><span class="line">        log.info(<span class="string">&quot;=====初始化redissonClientForShiro完成======&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> redissonClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 创建cookie对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;sessionIdCookie&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleCookie <span class="title">simpleCookie</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SimpleCookie simpleCookie = <span class="keyword">new</span> SimpleCookie();</span><br><span class="line">        simpleCookie.setName(<span class="string">&quot;ShiroSession&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> simpleCookie;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 缓存管理器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;shiroCacheManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroCacheManager <span class="title">shiroCacheManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ShiroCacheManager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 权限管理器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;securityManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">defaultWebSecurityManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        securityManager.setRealm(shiroDbRealm());</span><br><span class="line">        securityManager.setSessionManager(shiroSessionManager());</span><br><span class="line">        securityManager.setCacheManager(shiroCacheManager());</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义RealmImpl</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;shiroDbRealm&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroDbRealm <span class="title">shiroDbRealm</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ShiroDbRealmImpl();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义session会话存储的实现类 ，使用Redis来存储共享session，达到分布式部署目的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;redisSessionDao&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SessionDAO <span class="title">redisSessionDao</span><span class="params">()</span></span>&#123;</span><br><span class="line">        RedisSessionDao sessionDAO =   <span class="keyword">new</span> RedisSessionDao();</span><br><span class="line">        sessionDAO.setGlobalSessionTimeout(shiroRedisProperties.getGlobalSessionTimeout());</span><br><span class="line">        <span class="keyword">return</span> sessionDAO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 会话管理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;sessionManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroSessionManager <span class="title">shiroSessionManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ShiroSessionManager sessionManager = <span class="keyword">new</span> ShiroSessionManager();</span><br><span class="line">        sessionManager.setSessionDAO(redisSessionDao());</span><br><span class="line">        sessionManager.setSessionValidationSchedulerEnabled(<span class="keyword">false</span>);</span><br><span class="line">        sessionManager.setSessionIdCookieEnabled(<span class="keyword">true</span>);</span><br><span class="line">        sessionManager.setSessionIdCookie(simpleCookie());</span><br><span class="line">        sessionManager.setGlobalSessionTimeout(shiroRedisProperties.getGlobalSessionTimeout());</span><br><span class="line">        <span class="keyword">return</span> sessionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 保证实现了Shiro内部lifecycle函数的bean执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;lifecycleBeanPostProcessor&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LifecycleBeanPostProcessor <span class="title">getLifecycleBeanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LifecycleBeanPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> AOP式方法级权限检查</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@DependsOn(&quot;lifecycleBeanPostProcessor&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title">getDefaultAdvisorAutoProxyCreator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultAdvisorAutoProxyCreator defaultAdvisorAutoProxyCreator = <span class="keyword">new</span> DefaultAdvisorAutoProxyCreator();</span><br><span class="line">        defaultAdvisorAutoProxyCreator.setProxyTargetClass(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultAdvisorAutoProxyCreator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 配合DefaultAdvisorAutoProxyCreator事项注解权限校验</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title">getAuthorizationAttributeSourceAdvisor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        AuthorizationAttributeSourceAdvisor aasa = <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">        aasa.setSecurityManager(defaultWebSecurityManager());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 过滤器链</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">filterChainDefinition</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;Object&gt; list  = PropertiesUtil.propertiesShiro.getKeyList();</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Object object : list) &#123;</span><br><span class="line">            String key = object.toString();</span><br><span class="line">            String value = PropertiesUtil.getShiroValue(key);</span><br><span class="line">            log.info(<span class="string">&quot;读取防止盗链控制：---key&#123;&#125;,---value:&#123;&#125;&quot;</span>,key,value);</span><br><span class="line">            map.put(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义过滤器定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, Filter&gt; <span class="title">filters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Filter&gt; map = <span class="keyword">new</span> HashMap&lt;String, Filter&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;roleOr&quot;</span>, <span class="keyword">new</span> RolesOrAuthorizationFilter());</span><br><span class="line">        map.put(<span class="string">&quot;kicked-out&quot;</span>, <span class="keyword">new</span> KickedOutAuthorizationFilter(redissonClient(), redisSessionDao(), shiroSessionManager()));</span><br><span class="line">        map.put(<span class="string">&quot;jwt-authc&quot;</span>, <span class="keyword">new</span> JwtAuthcFilter(jwtTokenManager));</span><br><span class="line">        map.put(<span class="string">&quot;jwt-perms&quot;</span>, <span class="keyword">new</span> JwtPermsFilter());</span><br><span class="line">        map.put(<span class="string">&quot;jwt-roles&quot;</span>, <span class="keyword">new</span> JwtRolesFilter());</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> Shiro过滤器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;shiroFilter&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shiroFilterFactoryBean</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ShiroFilterFactoryBean shiroFilter = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">        shiroFilter.setSecurityManager(defaultWebSecurityManager());</span><br><span class="line">        <span class="comment">//使自定义过滤器生效</span></span><br><span class="line">        shiroFilter.setFilters(filters());</span><br><span class="line">        shiroFilter.setFilterChainDefinitionMap(filterChainDefinition());</span><br><span class="line">        shiroFilter.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        shiroFilter.setUnauthorizedUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> shiroFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="业务代码"><a href="#业务代码" class="headerlink" title="业务代码"></a>业务代码</h3><h4 id="LoginAction"><a href="#LoginAction" class="headerlink" title="LoginAction"></a>LoginAction</h4><p>添加LoginForJwt方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@Description</span> jwt的json登录方式</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> loginVo</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@RequestMapping(&quot;login-jwt&quot;)</span></span><br><span class="line">	<span class="meta">@ResponseBody</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> BaseResponse <span class="title">LoginForJwt</span><span class="params">(<span class="meta">@RequestBody</span> LoginVo loginVo)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> loginService.routeForJwt(loginVo);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="LoginService"><a href="#LoginService" class="headerlink" title="LoginService"></a>LoginService</h4><p>添加routeForJwt方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.BaseResponse;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.LoginVo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.IncorrectCredentialsException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UnknownAccountException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 登陆业务接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoginService</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@Description</span> 登陆路由</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> loginVo 登录参数</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">route</span><span class="params">(LoginVo loginVo)</span> <span class="keyword">throws</span> UnknownAccountException,IncorrectCredentialsException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@Description</span> jwt方式登录</span></span><br><span class="line"><span class="comment">	 <span class="doctag">@param</span> loginVo 登录参数</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> BaseResponse <span class="title">routeForJwt</span><span class="params">(LoginVo loginVo)</span> <span class="keyword">throws</span> UnknownAccountException,IncorrectCredentialsException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="LoginServiceImpl"><a href="#LoginServiceImpl" class="headerlink" title="LoginServiceImpl"></a>LoginServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.itheima.shiro.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.CacheConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.ShiroConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.BaseResponse;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.ShiroUser;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.SimpleToken;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.bridge.UserBridgeService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.impl.JwtTokenManager;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.LoginService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.BeanConv;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.ShiroUserUtil;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.ShiroUtil;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.LoginVo;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.IncorrectCredentialsException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UnknownAccountException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 登陆业务实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service(&quot;loginService&quot;)</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginServiceImpl</span> <span class="keyword">implements</span> <span class="title">LoginService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;redissonClientForShiro&quot;)</span></span><br><span class="line">    RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserBridgeService userBridgeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JwtTokenManager jwtTokenManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (non-Javadoc)</span></span><br><span class="line"><span class="comment">     * @see LoginService#route(com.yz.commons.vo.LoginVo)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">route</span><span class="params">(LoginVo loginVo)</span> <span class="keyword">throws</span> UnknownAccountException, IncorrectCredentialsException </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            SimpleToken token = <span class="keyword">new</span> SimpleToken(<span class="keyword">null</span>, loginVo.getLoginName(), loginVo.getPassWord());</span><br><span class="line">            Subject subject = SecurityUtils.getSubject();</span><br><span class="line">            subject.login(token);</span><br><span class="line">            <span class="comment">//创建缓存</span></span><br><span class="line">            <span class="keyword">this</span>.loadAuthorityToCache();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownAccountException ex) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;登陆异常:&#123;&#125;&quot;</span>, ex);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IncorrectCredentialsException ex) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;登陆异常:&#123;&#125;&quot;</span>, ex);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IncorrectCredentialsException(ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BaseResponse <span class="title">routeForJwt</span><span class="params">(LoginVo loginVo)</span> <span class="keyword">throws</span> UnknownAccountException, IncorrectCredentialsException </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        String jwtToken = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            SimpleToken token = <span class="keyword">new</span> SimpleToken(<span class="keyword">null</span>, loginVo.getLoginName(), loginVo.getPassWord());</span><br><span class="line">            Subject subject = SecurityUtils.getSubject();</span><br><span class="line">            subject.login(token);</span><br><span class="line">            String shiroSessionId = ShiroUserUtil.getShiroSessionId();</span><br><span class="line">            <span class="comment">//登录后颁发的令牌</span></span><br><span class="line">            ShiroUser shiroUser = ShiroUserUtil.getShiroUser();</span><br><span class="line">            Map&lt;String, Object&gt; claims = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            claims.put(<span class="string">&quot;shiroUser&quot;</span>, JSONObject.toJSONString(shiroUser));</span><br><span class="line">            jwtToken = jwtTokenManager.IssuedToken(<span class="string">&quot;system&quot;</span>, subject.getSession().getTimeout(),shiroSessionId,claims);</span><br><span class="line">            map.put(<span class="string">&quot;jwtToken&quot;</span>,jwtToken );</span><br><span class="line">            log.info(<span class="string">&quot;jwtToken:&#123;&#125;&quot;</span>,map.toString());</span><br><span class="line">            <span class="comment">//创建缓存</span></span><br><span class="line">            <span class="keyword">this</span>.loadAuthorityToCache();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            BaseResponse baseResponse = <span class="keyword">new</span> BaseResponse(ShiroConstant.LOGIN_FAILURE_CODE, ShiroConstant.LOGIN_FAILURE_MESSAGE);</span><br><span class="line">            <span class="keyword">return</span> baseResponse;</span><br><span class="line">        &#125;</span><br><span class="line">        BaseResponse baseResponse = <span class="keyword">new</span> BaseResponse(ShiroConstant.LOGIN_SUCCESS_CODE,ShiroConstant.LOGIN_SUCCESS_MESSAGE,jwtToken);</span><br><span class="line">        <span class="keyword">return</span> baseResponse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;b&gt;方法名：&lt;/b&gt;：loadAuthorityToCache&lt;br&gt;</span></span><br><span class="line"><span class="comment">     * &lt;b&gt;功能说明：&lt;/b&gt;：加载缓存&lt;br&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadAuthorityToCache</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//登陆成功后缓存用户的权限信息进入缓存</span></span><br><span class="line">        ShiroUser shiroUser = ShiroUserUtil.getShiroUser();</span><br><span class="line">        User user = BeanConv.toBean(shiroUser, User.class);</span><br><span class="line">        userBridgeService.loadUserAuthorityToCache(user);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="authentication-properties"><a href="#authentication-properties" class="headerlink" title="authentication.properties"></a>authentication.properties</h4><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#静态资源不过滤</span></span><br><span class="line"><span class="meta">/static/**</span>=<span class="string">anon</span></span><br><span class="line"><span class="comment">#登录链接不过滤</span></span><br><span class="line"><span class="meta">/login/**</span>=<span class="string">anon</span></span><br><span class="line"><span class="comment">#访问/resource/**需要有admin的角色</span></span><br><span class="line"><span class="comment">#/resource/**=roleOr[MangerRole,SuperAdmin]</span></span><br><span class="line"><span class="meta">/role/**</span> =<span class="string">jwt-roles[SuperAdmin]</span></span><br><span class="line"><span class="meta">/resource/**</span> =<span class="string">jwt-perms[role:listInitialize]</span></span><br><span class="line"><span class="comment">#其他链接是需要登录的</span></span><br><span class="line"><span class="meta">/**</span>=<span class="string">kicked-out,jwt-authc</span></span><br></pre></td></tr></table></figure>

<h3 id="测试-8"><a href="#测试-8" class="headerlink" title="测试"></a>测试</h3><p>1、测试登录后，jwtToken的生成，且校验会话是否使用新的jwtToken里的会话jti</p>
<p>2、测试自定义过滤器是否生效</p>
<p>使用jay/pass登录</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210152.png" alt="1582109588294"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210143.png" alt="1582109618404"></p>
<p>使用admin/pass登录</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210139.png" alt="1582116805841"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210136.png" alt="1582116832446"></p>
<h2 id="分布式统一权限系统"><a href="#分布式统一权限系统" class="headerlink" title="分布式统一权限系统"></a>分布式统一权限系统</h2><h3 id="系统需求"><a href="#系统需求" class="headerlink" title="系统需求"></a>系统需求</h3><h4 id="前后端分离"><a href="#前后端分离" class="headerlink" title="前后端分离"></a>前后端分离</h4><p>在第十章中我们已经实现，使用jwt的令牌实现，重写DefaultWebSessionManager,从ServletRequest获得jwtToken作为会话sessionId</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.servlet.ShiroHttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.session.mgt.DefaultWebSessionManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.util.WebUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 重写Jwt会话管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroSessionManager</span> <span class="keyword">extends</span> <span class="title">DefaultWebSessionManager</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORIZATION = <span class="string">&quot;jwtToken&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REFERENCED_SESSION_ID_SOURCE = <span class="string">&quot;Stateless request&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ShiroSessionManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JwtTokenManager jwtTokenManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Serializable <span class="title">getSessionId</span><span class="params">(ServletRequest request, ServletResponse response)</span></span>&#123;</span><br><span class="line">        String jwtToken = WebUtils.toHttp(request).getHeader(AUTHORIZATION);</span><br><span class="line">        <span class="keyword">if</span>(EmptyUtil.isNullOrEmpty(jwtToken))&#123;</span><br><span class="line">            <span class="comment">// 如果没有携带id参数则按照父类的方式在cookie进行获取</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.getSessionId(request, response);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//如果请求头中有 authToken 则其值为jwtToken，然后解析出会话session</span></span><br><span class="line">        	request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_SOURCE,REFERENCED_SESSION_ID_SOURCE);</span><br><span class="line">            Claims decode = jwtTokenManager.decodeToken(jwtToken);</span><br><span class="line">            String id = (String) decode.get(<span class="string">&quot;jti&quot;</span>);</span><br><span class="line">            request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID,id);</span><br><span class="line">            request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_IS_VALID,Boolean.TRUE);</span><br><span class="line">            <span class="keyword">return</span> id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="集中式会话"><a href="#集中式会话" class="headerlink" title="集中式会话"></a>集中式会话</h4><p>在第七章中RedisSessionDao继承AbstractSessionDAO，重写了会话的创建、读取、修改等操作，全部缓存于redis中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.CacheConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.ShiroRedissionSerialize;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.Session;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.mgt.eis.AbstractSessionDAO;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RBucket;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 实现shiro session的memcached集中式管理~</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisSessionDao</span> <span class="keyword">extends</span> <span class="title">AbstractSessionDAO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Resource(name = &quot;redissonClientForShiro&quot;)</span></span><br><span class="line">	RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Long globalSessionTimeout;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Serializable <span class="title">doCreate</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">		Serializable sessionId = generateSessionId(session);</span><br><span class="line">		assignSessionId(session, sessionId);</span><br><span class="line"><span class="comment">//		log.info(&quot;=============创建sessionId:&#123;&#125;&quot;,sessionId);</span></span><br><span class="line">		RBucket&lt;String&gt; sessionIdRBucket = redissonClient.getBucket(CacheConstant.GROUP_CAS+sessionId.toString());</span><br><span class="line">		sessionIdRBucket.trySet(ShiroRedissionSerialize.serialize(session), globalSessionTimeout, TimeUnit.SECONDS);</span><br><span class="line">		<span class="keyword">return</span> sessionId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Session <span class="title">doReadSession</span><span class="params">(Serializable sessionId)</span> </span>&#123;</span><br><span class="line">		RBucket&lt;String&gt; sessionIdRBucket = redissonClient.getBucket(CacheConstant.GROUP_CAS+sessionId.toString());</span><br><span class="line">		Session session = (Session) ShiroRedissionSerialize.deserialize(sessionIdRBucket.get());</span><br><span class="line"><span class="comment">//		log.info(&quot;=============读取sessionId:&#123;&#125;&quot;,session.getId().toString());</span></span><br><span class="line">		<span class="keyword">return</span> session;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line"><span class="comment">//		log.info(&quot;=============删除sessionId:&#123;&#125;&quot;,session.getId().toString());</span></span><br><span class="line">		RBucket&lt;String&gt; sessionIdRBucket = redissonClient.getBucket(CacheConstant.GROUP_CAS+session.getId().toString());</span><br><span class="line">		sessionIdRBucket.delete();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Collection&lt;Session&gt; <span class="title">getActiveSessions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Collections.emptySet();  </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">		RBucket&lt;String&gt; sessionIdRBucket = redissonClient.getBucket(CacheConstant.GROUP_CAS+session.getId().toString());</span><br><span class="line">		sessionIdRBucket.set(ShiroRedissionSerialize.serialize(session), globalSessionTimeout, TimeUnit.SECONDS);</span><br><span class="line"><span class="comment">//		log.info(&quot;=============修改sessionId:&#123;&#125;&quot;,session.getId().toString());</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGlobalSessionTimeout</span><span class="params">(Long globalSessionTimeout)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.globalSessionTimeout = globalSessionTimeout;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="认证与鉴权服务化"><a href="#认证与鉴权服务化" class="headerlink" title="认证与鉴权服务化"></a>认证与鉴权服务化</h4><p>第六章中，我们实现了realm的缓存机制，这里我们会把UserBridgeService使用dubbo服务化</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210130.png"></p>
<p>其目的使得实际项目中的认证与鉴权走dubbo，减少服务器压力</p>
<h4 id="动态过滤器链"><a href="#动态过滤器链" class="headerlink" title="动态过滤器链"></a>动态过滤器链</h4><p>在第十章中，我们加载过滤器链的方式</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#静态资源不过滤</span></span><br><span class="line"><span class="meta">/static/**</span>=<span class="string">anon#登录链接不过滤/login/**=anon</span></span><br><span class="line"><span class="comment">#访问/resource/**需要有admin的角色#</span></span><br><span class="line"><span class="meta">/resource/**</span>=<span class="string">role-or[MangerRole,SuperAdmin]</span></span><br><span class="line"><span class="meta">/role/**</span>=<span class="string">jwt-roles[SuperAdmin]</span></span><br><span class="line"><span class="meta">/resource/**</span> =<span class="string">jwt-perms[role:listInitialize]</span></span><br><span class="line"><span class="comment">#其他链接是需要登录的</span></span><br><span class="line"><span class="meta">/**</span>=<span class="string">kicked-out,jwt-authc</span></span><br></pre></td></tr></table></figure>

<p>在统一鉴权系统中，我们不可能每次发布新的过滤器链，就去重启服务器，我们更希望可以动态管理过滤器链</p>
<h4 id="权限客户端"><a href="#权限客户端" class="headerlink" title="权限客户端"></a>权限客户端</h4><p>shiro-client作为jar的依赖，满足以下需求：</p>
<p>1、非侵入式：使用者只需要对jar依赖和做少量的配置，就可以达到统一鉴权的目标</p>
<p>2、可扩展性：用户除使用提供的过滤器外，可以轻松安自己的业务去定义过滤器</p>
<p>3、集中式管理：依赖jar之后，shiro-mgt后台可以同时管控多个平台的权限的认证、鉴权、及动态配置过滤器链</p>
<h4 id="网关平台"><a href="#网关平台" class="headerlink" title="网关平台"></a>网关平台</h4><p>springboot-shiro-gateway:</p>
<p>1、依赖shiro-client项目作为权限的被控制层</p>
<p>2、实现dubbo传输协议到HTTP传输协议的转化，当然这里提供的为通用的转换方式。</p>
<p>3、可复制、复制后只需要在shiro-mgt后台中做简单的配置，就可以实现一个新网关的接入</p>
<h3 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h3><h4 id="系统网络通讯"><a href="#系统网络通讯" class="headerlink" title="系统网络通讯"></a>系统网络通讯</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210125.png" alt="1582876876486"></p>
<p>1、网关服务集群性，同时实现会话的统一管理</p>
<p>2、鉴权服务集群化，提供统一鉴权服务</p>
<p>3、管理后台集群化</p>
<h4 id="模块依赖关系"><a href="#模块依赖关系" class="headerlink" title="模块依赖关系"></a>模块依赖关系</h4><h5 id="springboot-shiro-parent"><a href="#springboot-shiro-parent" class="headerlink" title="springboot-shiro-parent"></a>springboot-shiro-parent</h5><p>springboot-shiro-parent:项目统一jar和plugIn的POM定义</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210123.png" alt="1582880473745"></p>
<h5 id="springboot-shiro-gateway-handler"><a href="#springboot-shiro-gateway-handler" class="headerlink" title="springboot-shiro-gateway-handler"></a>springboot-shiro-gateway-handler</h5><p>​        1、dubbo业务服务转换http通讯</p>
<p>​        2、认证与鉴权服务化消费者</p>
<p>​        3、生成业务服务化消费者</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210120.png" alt="1582880165581"></p>
<h5 id="springboot-shiro-producer"><a href="#springboot-shiro-producer" class="headerlink" title="springboot-shiro-producer"></a>springboot-shiro-producer</h5><p>​        认证与鉴权服务化的生成者</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210117.png" alt="1582710657210"></p>
<h5 id="springboot-shiro-mgt"><a href="#springboot-shiro-mgt" class="headerlink" title="springboot-shiro-mgt"></a>springboot-shiro-mgt</h5><p>​        认证与鉴权服务化消费者</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210033.png" alt="1582881763304"></p>
<h5 id="springboot-shiro-dubbo-app-handler"><a href="#springboot-shiro-dubbo-app-handler" class="headerlink" title="springboot-shiro-dubbo-app-handler"></a>springboot-shiro-dubbo-app-handler</h5><p>​        生产业务服务化生产者</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210031.png" alt="1582711000178"></p>
<h3 id="认证鉴权服务化"><a href="#认证鉴权服务化" class="headerlink" title="认证鉴权服务化"></a>认证鉴权服务化</h3><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210027.png" alt="1585539347157"></p>
<p>上面的图解中我们可以看到，这里服务化的为UserAdapterFace</p>
<p>模块springboot-shiro-face中的接口定义UserAdapterFace</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.face;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.ResourceVo;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.RoleVo;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.UserVo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：用户服务接口定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserAdapterFace</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 按用户名查找用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loginName 登录名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">UserVo <span class="title">findUserByLoginName</span><span class="params">(String loginName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查找用户所有角色</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;RoleVo&gt; <span class="title">findRoleByUserId</span><span class="params">(String userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查询用户有那些资源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;ResourceVo&gt; <span class="title">findResourceByUserId</span><span class="params">(String userId)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>springboot-shiro-producer模块中的生产者UserAdapterFaceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.faceImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.adapter.UserAdapter;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.face.UserAdapterFace;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.Resource;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.BeanConv;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.ResourceVo;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.RoleVo;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.UserVo;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service(version = &quot;1.0.0&quot;, retries = 3,timeout = 5000)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserAdapterFaceImpl</span> <span class="keyword">implements</span> <span class="title">UserAdapterFace</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserAdapter userAdapter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserVo <span class="title">findUserByLoginName</span><span class="params">(String loginName)</span> </span>&#123;</span><br><span class="line">        User user = userAdapter.findUserByLoginName(loginName);</span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(user))&#123;</span><br><span class="line">            <span class="keyword">return</span> BeanConv.toBean(user,UserVo.class);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;RoleVo&gt; <span class="title">findRoleByUserId</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">        List&lt;Role&gt; list = userAdapter.findRoleByUserId(userId);</span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(list))&#123;</span><br><span class="line">            <span class="keyword">return</span> BeanConv.toBeanList(list, RoleVo.class);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ResourceVo&gt; <span class="title">findResourceByUserId</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">        List&lt;Resource&gt; list = userAdapter.findResourceByUserId(userId);</span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(list))&#123;</span><br><span class="line">            <span class="keyword">return</span> BeanConv.toBeanList(list, ResourceVo.class);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>springboot-shiro-handler模块下的消费者UserBridgeServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.CacheConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.SimpleCacheManager;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.ShiroUser;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.SimpleMapCache;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.SimpleToken;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.bridge.UserBridgeService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.face.UserAdapterFace;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.BeanConv;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.ShiroUserUtil;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.ResourceVo;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.RoleVo;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.UserVo;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.Reference;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.SimpleAuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UnknownAccountException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RBucket;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 权限桥接器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component(&quot;userBridgeService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserBridgeServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserBridgeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Reference(version = &quot;1.0.0&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> UserAdapterFace userAdapterFace;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SimpleCacheManager simpleCacheManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@javax</span>.annotation.Resource(name = <span class="string">&quot;redissonClientForShiro&quot;</span>)</span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authcToken,String realmName)</span> </span>&#123;</span><br><span class="line">        SimpleToken token = (SimpleToken)authcToken;</span><br><span class="line">        UserVo user  = <span class="keyword">this</span>.findUserByLoginName(token.getUsername());</span><br><span class="line">        <span class="keyword">if</span>(EmptyUtil.isNullOrEmpty(user))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(<span class="string">&quot;账号不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ShiroUser shiroUser = BeanConv.toBean(user, ShiroUser.class);</span><br><span class="line">        String sessionId = ShiroUserUtil.getShiroSessionId();</span><br><span class="line">        String cacheKeyResourcesIds = CacheConstant.RESOURCES_KEY_IDS+sessionId;</span><br><span class="line">        shiroUser.setResourceIds(<span class="keyword">this</span>.findResourcesIdsList(cacheKeyResourcesIds,user.getId()));</span><br><span class="line">        String salt = user.getSalt();</span><br><span class="line">        String password = user.getPassWord();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(shiroUser, password, ByteSource.Util.bytes(salt), realmName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleAuthorizationInfo <span class="title">getAuthorizationInfo</span><span class="params">(ShiroUser shiroUser)</span> </span>&#123;</span><br><span class="line">        UserVo user = BeanConv.toBean(shiroUser, UserVo.class);</span><br><span class="line">        SimpleAuthorizationInfo info = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">        String sessionId = ShiroUserUtil.getShiroSessionId();</span><br><span class="line">        <span class="comment">//查询用户拥有的角色</span></span><br><span class="line">        String cacheKeyRole = CacheConstant.ROLE_KEY + sessionId;</span><br><span class="line">        info.addRoles(<span class="keyword">this</span>.findRoleList(cacheKeyRole, user.getId()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询用户拥有的资源</span></span><br><span class="line">        String cacheKeyResources = CacheConstant.RESOURCES_KEY + sessionId;</span><br><span class="line">        info.addStringPermissions(<span class="keyword">this</span>.findResourcesList(cacheKeyResources, user.getId()));</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findRoleList</span><span class="params">(String cacheKeyRole, String userId)</span> </span>&#123;</span><br><span class="line">        List&lt;RoleVo&gt; roles = <span class="keyword">new</span> ArrayList&lt;RoleVo&gt;();</span><br><span class="line">        <span class="keyword">if</span> (simpleCacheManager.getCache(cacheKeyRole) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            roles = (List&lt;RoleVo&gt;) simpleCacheManager.getCache(cacheKeyRole).get(cacheKeyRole);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            roles = userAdapterFace.findRoleByUserId(userId);</span><br><span class="line">            <span class="keyword">if</span> (roles.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//用户角色存放到map</span></span><br><span class="line">                Map&lt;Object, Object&gt; mapRole = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">                mapRole.put(cacheKeyRole, roles);</span><br><span class="line">                <span class="comment">//新建SimpleMapCache实例并放入缓存管理器</span></span><br><span class="line">                SimpleMapCache cacheRole = <span class="keyword">new</span> SimpleMapCache(cacheKeyRole, mapRole);</span><br><span class="line">                simpleCacheManager.createCache(cacheKeyRole, cacheRole);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;String&gt; rolesLabel = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        <span class="keyword">for</span> (RoleVo role : roles) &#123;</span><br><span class="line">            rolesLabel.add(role.getLabel());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rolesLabel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findResourcesList</span><span class="params">(String cacheKeyResources,String userId)</span> </span>&#123;</span><br><span class="line">        List&lt;ResourceVo&gt; resourcesList = <span class="keyword">new</span> ArrayList&lt;ResourceVo&gt;();</span><br><span class="line">        <span class="keyword">if</span> (simpleCacheManager.getCache(cacheKeyResources) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resourcesList = (List&lt;ResourceVo&gt;) simpleCacheManager.getCache(cacheKeyResources).get(cacheKeyResources);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resourcesList = userAdapterFace.findResourceByUserId(userId);</span><br><span class="line">            <span class="keyword">if</span> (resourcesList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//用户资源存放到map</span></span><br><span class="line">                Map&lt;Object, Object&gt; mapResource = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">                mapResource.put(cacheKeyResources, resourcesList);</span><br><span class="line">                <span class="comment">//新建SimpleMapCache实例并放入缓存管理器</span></span><br><span class="line">                SimpleMapCache cacheResource = <span class="keyword">new</span> SimpleMapCache(cacheKeyResources, mapResource);</span><br><span class="line">                simpleCacheManager.createCache(cacheKeyResources, cacheResource);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;String&gt; resourcesLabel = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ResourceVo resources : resourcesList) &#123;</span><br><span class="line">            resourcesLabel.add(resources.getLabel());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resourcesLabel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserVo <span class="title">findUserByLoginName</span><span class="params">(String loginName)</span> </span>&#123;</span><br><span class="line">        String key = CacheConstant.FIND_USER_BY_LOGINNAME+loginName;</span><br><span class="line">        RBucket&lt;UserVo&gt; rBucket = redissonClient.getBucket(key);</span><br><span class="line">        UserVo user = rBucket.get();</span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(user)) &#123;</span><br><span class="line">            <span class="keyword">return</span> user;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            user = userAdapterFace.findUserByLoginName(loginName);</span><br><span class="line">            <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(user)) &#123;</span><br><span class="line">                rBucket.set(user, <span class="number">300</span>, TimeUnit.SECONDS);</span><br><span class="line">                <span class="keyword">return</span> user;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        rBucket.set(<span class="keyword">new</span> UserVo(), <span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findResourcesIdsList</span><span class="params">(String cacheKeyResources,String userId)</span> </span>&#123;</span><br><span class="line">        List&lt;ResourceVo&gt; resourcesList = <span class="keyword">new</span> ArrayList&lt;ResourceVo&gt;();</span><br><span class="line">        <span class="keyword">if</span> (simpleCacheManager.getCache(cacheKeyResources) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resourcesList = (List&lt;ResourceVo&gt;) simpleCacheManager.getCache(cacheKeyResources).get(cacheKeyResources);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resourcesList = userAdapterFace.findResourceByUserId(userId);</span><br><span class="line">            <span class="keyword">if</span> (resourcesList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//用户资源存放到map</span></span><br><span class="line">                Map&lt;Object, Object&gt; mapResource = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">                mapResource.put(cacheKeyResources, resourcesList);</span><br><span class="line">                <span class="comment">//新建SimpleMapCache实例并放入缓存管理器</span></span><br><span class="line">                SimpleMapCache cacheResource = <span class="keyword">new</span> SimpleMapCache(cacheKeyResources, mapResource);</span><br><span class="line">                simpleCacheManager.createCache(cacheKeyResources, cacheResource);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;String&gt; resourcesLabel = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ResourceVo resources : resourcesList) &#123;</span><br><span class="line">            resourcesLabel.add(resources.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resourcesLabel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadUserAuthorityToCache</span><span class="params">(ShiroUser user)</span> </span>&#123;</span><br><span class="line">        String sessionId = user.getSessionId();</span><br><span class="line">        List&lt;RoleVo&gt; roles = userAdapterFace.findRoleByUserId(user.getId());</span><br><span class="line">        <span class="comment">//创建角色cachaeKey</span></span><br><span class="line">        String cacheKeyRole = CacheConstant.ROLE_KEY + sessionId;</span><br><span class="line">        <span class="comment">//用户角色存放到map</span></span><br><span class="line">        Map&lt;Object, Object&gt; mapRole = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">        mapRole.put(cacheKeyRole, roles);</span><br><span class="line">        <span class="comment">//新建SimpleMapCache实例并放入缓存管理器</span></span><br><span class="line">        SimpleMapCache cacheRole = <span class="keyword">new</span> SimpleMapCache(cacheKeyRole, mapRole);</span><br><span class="line">        simpleCacheManager.createCache(cacheKeyRole, cacheRole);</span><br><span class="line"></span><br><span class="line">        List&lt;ResourceVo&gt; resourcesList = userAdapterFace.findResourceByUserId(user.getId());</span><br><span class="line">        <span class="keyword">if</span> (resourcesList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//创建资源cachaeKey</span></span><br><span class="line">            String cacheKeyResources = CacheConstant.RESOURCES_KEY + sessionId;</span><br><span class="line">            <span class="comment">//用户资源存放到map</span></span><br><span class="line">            Map&lt;Object, Object&gt; mapResource = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">            mapResource.put(cacheKeyResources, resourcesList);</span><br><span class="line">            <span class="comment">//新建SimpleMapCache实例并放入缓存管理器</span></span><br><span class="line">            SimpleMapCache cacheResource = <span class="keyword">new</span> SimpleMapCache(cacheKeyResources, mapResource);</span><br><span class="line">            simpleCacheManager.createCache(cacheKeyResources, cacheResource);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过上面的改造，我们可以发现：用户在认证与鉴权时走的都是dubbo的服务，而在实际业务项目中不会再去操作鉴权相关的内容</p>
<h3 id="动态过滤器链-1"><a href="#动态过滤器链-1" class="headerlink" title="动态过滤器链"></a>动态过滤器链</h3><p>在第十章中，我们加载过滤器链的方式</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#静态资源不过滤</span></span><br><span class="line"><span class="meta">/static/**</span>=<span class="string">anon</span></span><br><span class="line"><span class="comment">#登录链接不过滤</span></span><br><span class="line"><span class="meta">/login/**</span>=<span class="string">anon</span></span><br><span class="line"><span class="comment">#访问/resource/**需要有admin的角色</span></span><br><span class="line"><span class="comment">#/resource/**=roleOr[MangerRole,SuperAdmin]</span></span><br><span class="line"><span class="comment">#/role/** =jwt-roles[SuperAdmin]</span></span><br><span class="line"><span class="meta">/resource/**</span> =<span class="string">jwt-perms[role:listInitialize]</span></span><br><span class="line"><span class="comment">#其他链接是需要登录的</span></span><br><span class="line"><span class="meta">/**</span>=<span class="string">kicked-out,jwt-authc</span></span><br></pre></td></tr></table></figure>

<p>在统计鉴权系统中，我们不可能每次发布新的过滤器链，就去重启服务器，我们更希望可以动态管理过滤器链</p>
<h4 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h4><p>实现动态过滤器链，我们需要保证以下几个特性：</p>
<p>1、持久化：原有的properties内容放入数据库，</p>
<p>2、有序性：因过滤器链有序加载的特性，读取过滤器链的时保证其有序性</p>
<p>3、服务化：过滤器链的服务做成dubbo服务，做到集中式管理</p>
<p>4、同步性：不同业务系统对于过滤器链的加载需要同步</p>
<p>5、热加载：过滤器链修改之后，各个业务系统不需要重启服务，以达到热加载的目的</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210019.png" alt="1582619578346"></p>
<h4 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h4><h5 id="持久化、有序化"><a href="#持久化、有序化" class="headerlink" title="持久化、有序化"></a>持久化、有序化</h5><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210017.png" alt="1582683705723"></p>
<p>主要是对FilterChain类的CRUD这里就不做赘述，需要注意的是排序：升序排列，以保障过滤器链的有序加载</p>
<h5 id="服务化"><a href="#服务化" class="headerlink" title="服务化"></a>服务化</h5><p>服务化过滤器链加载</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">FilterChainFace</span>:<span class="string">过滤器链桥接器dubbo接口层</span></span><br><span class="line"><span class="attr">FilterChainFaceImpl</span>:<span class="string">过滤器链桥接器dubbo接口层实现</span></span><br></pre></td></tr></table></figure>

<p>FilterChainFace接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.face;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.FilterChainVo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：过滤器查询接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FilterChainFace</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;FilterChainVo&gt; <span class="title">findFilterChainList</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>FilterChainFaceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.faceImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.face.FilterChainFace;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.FilterChain;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.FilterChainService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.BeanConv;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.FilterChainVo;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service(version = &quot;1.0.0&quot;, retries = 3,timeout = 5000)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilterChainFaceImpl</span> <span class="keyword">implements</span> <span class="title">FilterChainFace</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    FilterChainService filterChainService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;FilterChainVo&gt; <span class="title">findFilterChainList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;FilterChain&gt; filterChainList = filterChainService.findFilterChainList();</span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(filterChainList))&#123;</span><br><span class="line">            <span class="keyword">return</span> BeanConv.toBeanList(filterChainList, FilterChainVo.class);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里只是简单的dubbo服务，也不做赘述</p>
<h5 id="同步性"><a href="#同步性" class="headerlink" title="同步性"></a>同步性</h5><p>定义启动加载过滤器链服务同步：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">FilterChainBridgeService</span>:<span class="string">过滤器链桥接器service接口层</span></span><br><span class="line"><span class="attr">FilterChainBridgeServiceImpl</span>:<span class="string">过滤器链桥接器service接口层实现</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ShiroFilerChainService</span>:<span class="string">shiro过滤器链服务加载接口</span></span><br><span class="line"><span class="attr">ShiroFilerChainService</span>:<span class="string">shiro过滤器链服务加载接口实现</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>FilterChainBridgeService</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.bridge;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.FilterChainVo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 过滤器链service接口层</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FilterChainBridgeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查询所有有效的过滤器链</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;FilterChainVo&gt; <span class="title">findFilterChainList</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FilterChainBridgeServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.bridge.FilterChainBridgeService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.face.FilterChainFace;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.FilterChainVo;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.Reference;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(&quot;filterChainBridgeService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilterChainBridgeServiceImpl</span> <span class="keyword">implements</span> <span class="title">FilterChainBridgeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Reference(version = &quot;1.0.0&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> FilterChainFace filterChainFace;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;FilterChainVo&gt; <span class="title">findFilterChainList</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> filterChainFace.findFilterChainList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ShiroFilerChainService过滤器链同步接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.FilterChainVo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：过滤器链同步接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ShiroFilerChainService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 启动时加载数据库中的过滤器链</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 初始化过滤器链</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">initFilterChains</span><span class="params">(List&lt;FilterChainVo&gt; FilterChainVos)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ShiroFilerChainServiceImpl过滤器链同步接口实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.impl.CustomDefaultFilterChainManager;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.ShiroFilerChainService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.bridge.FilterChainBridgeService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.FilterChainVo;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.mgt.DefaultFilterChainManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.mgt.NamedFilterList;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ScheduledExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：过滤器链同步接口实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service(&quot;shiroFilerChainManager&quot;)</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroFilerChainServiceImpl</span> <span class="keyword">implements</span> <span class="title">ShiroFilerChainService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//此时注入的为CustomDefaultFilterChainManager</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomDefaultFilterChainManager filterChainManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    FilterChainBridgeService filterChainBridgeService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, NamedFilterList&gt; defaultFilterChains;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ScheduledExecutorService executor = Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 启动定时器，间隔2分钟同步数据库的过滤器链</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        defaultFilterChains = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        executor.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    initFilterChains(filterChainBridgeService.findFilterChainList());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(e.getMessage(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>, <span class="number">120</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initFilterChains</span><span class="params">(List&lt;FilterChainVo&gt; FilterChainVos)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、首先删除以前老的filter chain并注册默认的</span></span><br><span class="line">        filterChainManager.getFilterChains().clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、循环URL Filter 注册filter chain</span></span><br><span class="line">        <span class="keyword">for</span> (FilterChainVo urlFilterVo : FilterChainVos) &#123;</span><br><span class="line">            String url = urlFilterVo.getUrl();</span><br><span class="line">            String filterName = urlFilterVo.getFilterName();</span><br><span class="line">            String[] filterNames = filterName.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (String name : filterNames) &#123;</span><br><span class="line">                <span class="comment">//注册所有filter，包含自定义的过滤器</span></span><br><span class="line">                <span class="keyword">switch</span>(name)&#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;anon&quot;</span>:</span><br><span class="line">                        filterChainManager.addToChain(url, name);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;authc&quot;</span>:</span><br><span class="line">                        filterChainManager.addToChain(url, name);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;roles&quot;</span>:</span><br><span class="line">                        filterChainManager.addToChain(url, name, urlFilterVo.getRoles());</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;perms&quot;</span>:</span><br><span class="line">                        filterChainManager.addToChain(url, name,urlFilterVo.getPermissions());</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;role-or&quot;</span>:</span><br><span class="line">                        filterChainManager.addToChain(url, name,urlFilterVo.getRoles());</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;kicked-out&quot;</span>:</span><br><span class="line">                        filterChainManager.addToChain(url, name);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;jwt-authc&quot;</span>:</span><br><span class="line">                        filterChainManager.addToChain(url, name);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;jwt-roles&quot;</span>:</span><br><span class="line">                        filterChainManager.addToChain(url, name, urlFilterVo.getRoles());</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;jwt-perms&quot;</span>:</span><br><span class="line">                        filterChainManager.addToChain(url, name,urlFilterVo.getPermissions());</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="热加载"><a href="#热加载" class="headerlink" title="热加载"></a>热加载</h5><p>为了实现热加载我们需要定义以下3个类</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">CustomDefaultFilterChainManager</span>:<span class="string">自定义的默认过滤器链管理者</span></span><br><span class="line"><span class="attr">CustomPathMatchingFilterChainResolver</span>:<span class="string">自定义的路径匹配过滤器链解析器</span></span><br><span class="line"><span class="attr">CustomShiroFilterFactoryBean</span>:<span class="string">自定义shiro过滤器工厂bean</span></span><br></pre></td></tr></table></figure>

<h6 id="CustomDefaultFilterChainManager"><a href="#CustomDefaultFilterChainManager" class="headerlink" title="CustomDefaultFilterChainManager"></a>CustomDefaultFilterChainManager</h6><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210011.png" alt="1582685943872"></p>
<p>咱们来看下顶级接口FilterChainManager </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.config.Ini;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.CollectionUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.Nameable;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.config.IniFilterChainResolverFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.AccessControlFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.authc.AuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.authz.AuthorizationFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.mgt.DefaultFilterChainManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.mgt.NamedFilterList;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.mgt.SimpleNamedFilterList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：自定义默认过滤器管理者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomDefaultFilterChainManager</span> <span class="keyword">extends</span> <span class="title">DefaultFilterChainManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//登录地址</span></span><br><span class="line">    <span class="keyword">private</span> String loginUrl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//登录成功后默认跳转地址</span></span><br><span class="line">    <span class="keyword">private</span> String successUrl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//未授权跳转地址</span></span><br><span class="line">    <span class="keyword">private</span> String unauthorizedUrl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomDefaultFilterChainManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//构建过滤器</span></span><br><span class="line">        setFilters(<span class="keyword">new</span> LinkedHashMap&lt;String, Filter&gt;());</span><br><span class="line">        <span class="comment">//构建过滤器链</span></span><br><span class="line">        setFilterChains(<span class="keyword">new</span> LinkedHashMap&lt;String, NamedFilterList&gt;());</span><br><span class="line">        <span class="comment">//构建默认过滤器</span></span><br><span class="line">        addDefaultFilters(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 注册我们自定义的过滤器，相当于ShiroFilterFactoryBean的filters属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> customFilters 过滤器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCustomFilters</span><span class="params">(Map&lt;String, Filter&gt; customFilters)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(Map.Entry&lt;String, Filter&gt; entry : customFilters.entrySet()) &#123;</span><br><span class="line">            addFilter(entry.getKey(), entry.getValue(), <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> Spring容器启动时调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//配置默认过滤器</span></span><br><span class="line">        Map&lt;String, Filter&gt; filters = getFilters();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//为过滤器链配置全局URL处理属性</span></span><br><span class="line">        <span class="keyword">for</span> (Filter filter : filters.values()) &#123;</span><br><span class="line">            applyGlobalPropertiesIfNecessary(filter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 此时交于spring容器出事化，这里忽略</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initFilter</span><span class="params">(Filter filter)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyGlobalPropertiesIfNecessary</span><span class="params">(Filter filter)</span> </span>&#123;</span><br><span class="line">        applyLoginUrlIfNecessary(filter);</span><br><span class="line">        applySuccessUrlIfNecessary(filter);</span><br><span class="line">        applyUnauthorizedUrlIfNecessary(filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyLoginUrlIfNecessary</span><span class="params">(Filter filter)</span> </span>&#123;</span><br><span class="line">        String loginUrl = getLoginUrl();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(loginUrl) &amp;&amp; (filter <span class="keyword">instanceof</span> AccessControlFilter)) &#123;</span><br><span class="line">            AccessControlFilter acFilter = (AccessControlFilter) filter;</span><br><span class="line">            <span class="comment">//only apply the login url if they haven&#x27;t explicitly configured one already:</span></span><br><span class="line">            String existingLoginUrl = acFilter.getLoginUrl();</span><br><span class="line">            <span class="keyword">if</span> (AccessControlFilter.DEFAULT_LOGIN_URL.equals(existingLoginUrl)) &#123;</span><br><span class="line">                acFilter.setLoginUrl(loginUrl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applySuccessUrlIfNecessary</span><span class="params">(Filter filter)</span> </span>&#123;</span><br><span class="line">        String successUrl = getSuccessUrl();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(successUrl) &amp;&amp; (filter <span class="keyword">instanceof</span> AuthenticationFilter)) &#123;</span><br><span class="line">            AuthenticationFilter authcFilter = (AuthenticationFilter) filter;</span><br><span class="line">            <span class="comment">//only apply the successUrl if they haven&#x27;t explicitly configured one already:</span></span><br><span class="line">            String existingSuccessUrl = authcFilter.getSuccessUrl();</span><br><span class="line">            <span class="keyword">if</span> (AuthenticationFilter.DEFAULT_SUCCESS_URL.equals(existingSuccessUrl)) &#123;</span><br><span class="line">                authcFilter.setSuccessUrl(successUrl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyUnauthorizedUrlIfNecessary</span><span class="params">(Filter filter)</span> </span>&#123;</span><br><span class="line">        String unauthorizedUrl = getUnauthorizedUrl();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(unauthorizedUrl) &amp;&amp; (filter <span class="keyword">instanceof</span> AuthorizationFilter)) &#123;</span><br><span class="line">            AuthorizationFilter authzFilter = (AuthorizationFilter) filter;</span><br><span class="line">            <span class="comment">//only apply the unauthorizedUrl if they haven&#x27;t explicitly configured one already:</span></span><br><span class="line">            String existingUnauthorizedUrl = authzFilter.getUnauthorizedUrl();</span><br><span class="line">            <span class="keyword">if</span> (existingUnauthorizedUrl == <span class="keyword">null</span>) &#123;</span><br><span class="line">                authzFilter.setUnauthorizedUrl(unauthorizedUrl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLoginUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> loginUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginUrl</span><span class="params">(String loginUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.loginUrl = loginUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSuccessUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> successUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSuccessUrl</span><span class="params">(String successUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.successUrl = successUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUnauthorizedUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unauthorizedUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUnauthorizedUrl</span><span class="params">(String unauthorizedUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.unauthorizedUrl = unauthorizedUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>CustomDefaultFilterChainManager：主要是把原来对象的创建交于spring容器，同时指定过滤器，然后构建过滤器链</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.config.Ini;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.CollectionUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.Nameable;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.config.IniFilterChainResolverFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.AccessControlFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.authc.AuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.authz.AuthorizationFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.mgt.DefaultFilterChainManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.mgt.NamedFilterList;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.mgt.SimpleNamedFilterList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：自定义默认过滤器管理者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomDefaultFilterChainManager</span> <span class="keyword">extends</span> <span class="title">DefaultFilterChainManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//登录地址</span></span><br><span class="line">    <span class="keyword">private</span> String loginUrl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//登录成功后默认跳转地址</span></span><br><span class="line">    <span class="keyword">private</span> String successUrl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//未授权跳转地址</span></span><br><span class="line">    <span class="keyword">private</span> String unauthorizedUrl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomDefaultFilterChainManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//构建过滤器</span></span><br><span class="line">        setFilters(<span class="keyword">new</span> LinkedHashMap&lt;String, Filter&gt;());</span><br><span class="line">        <span class="comment">//构建过滤器链</span></span><br><span class="line">        setFilterChains(<span class="keyword">new</span> LinkedHashMap&lt;String, NamedFilterList&gt;());</span><br><span class="line">        <span class="comment">//构建默认过滤器</span></span><br><span class="line">        addDefaultFilters(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 注册我们自定义的过滤器，相当于ShiroFilterFactoryBean的filters属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> customFilters 过滤器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCustomFilters</span><span class="params">(Map&lt;String, Filter&gt; customFilters)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(Map.Entry&lt;String, Filter&gt; entry : customFilters.entrySet()) &#123;</span><br><span class="line">            addFilter(entry.getKey(), entry.getValue(), <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> Spring容器启动时调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//配置默认过滤器</span></span><br><span class="line">        Map&lt;String, Filter&gt; filters = getFilters();</span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(filters)) &#123;</span><br><span class="line">            <span class="comment">//注册过滤器</span></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, Filter&gt; entry : filters.entrySet()) &#123;</span><br><span class="line">                <span class="comment">//过滤器名称</span></span><br><span class="line">                String name = entry.getKey();</span><br><span class="line">                <span class="comment">//过滤器</span></span><br><span class="line">                Filter filter = entry.getValue();</span><br><span class="line">                <span class="keyword">if</span> (filter <span class="keyword">instanceof</span> Nameable) &#123;</span><br><span class="line">                    ((Nameable) filter).setName(name);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//配置3个URL</span></span><br><span class="line">                applyGlobalPropertiesIfNecessary(filter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 此时交于spring容器出事化，这里忽略</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initFilter</span><span class="params">(Filter filter)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyGlobalPropertiesIfNecessary</span><span class="params">(Filter filter)</span> </span>&#123;</span><br><span class="line">        applyLoginUrlIfNecessary(filter);</span><br><span class="line">        applySuccessUrlIfNecessary(filter);</span><br><span class="line">        applyUnauthorizedUrlIfNecessary(filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyLoginUrlIfNecessary</span><span class="params">(Filter filter)</span> </span>&#123;</span><br><span class="line">        String loginUrl = getLoginUrl();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(loginUrl) &amp;&amp; (filter <span class="keyword">instanceof</span> AccessControlFilter)) &#123;</span><br><span class="line">            AccessControlFilter acFilter = (AccessControlFilter) filter;</span><br><span class="line">            <span class="comment">//only apply the login url if they haven&#x27;t explicitly configured one already:</span></span><br><span class="line">            String existingLoginUrl = acFilter.getLoginUrl();</span><br><span class="line">            <span class="keyword">if</span> (AccessControlFilter.DEFAULT_LOGIN_URL.equals(existingLoginUrl)) &#123;</span><br><span class="line">                acFilter.setLoginUrl(loginUrl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applySuccessUrlIfNecessary</span><span class="params">(Filter filter)</span> </span>&#123;</span><br><span class="line">        String successUrl = getSuccessUrl();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(successUrl) &amp;&amp; (filter <span class="keyword">instanceof</span> AuthenticationFilter)) &#123;</span><br><span class="line">            AuthenticationFilter authcFilter = (AuthenticationFilter) filter;</span><br><span class="line">            <span class="comment">//only apply the successUrl if they haven&#x27;t explicitly configured one already:</span></span><br><span class="line">            String existingSuccessUrl = authcFilter.getSuccessUrl();</span><br><span class="line">            <span class="keyword">if</span> (AuthenticationFilter.DEFAULT_SUCCESS_URL.equals(existingSuccessUrl)) &#123;</span><br><span class="line">                authcFilter.setSuccessUrl(successUrl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyUnauthorizedUrlIfNecessary</span><span class="params">(Filter filter)</span> </span>&#123;</span><br><span class="line">        String unauthorizedUrl = getUnauthorizedUrl();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(unauthorizedUrl) &amp;&amp; (filter <span class="keyword">instanceof</span> AuthorizationFilter)) &#123;</span><br><span class="line">            AuthorizationFilter authzFilter = (AuthorizationFilter) filter;</span><br><span class="line">            <span class="comment">//only apply the unauthorizedUrl if they haven&#x27;t explicitly configured one already:</span></span><br><span class="line">            String existingUnauthorizedUrl = authzFilter.getUnauthorizedUrl();</span><br><span class="line">            <span class="keyword">if</span> (existingUnauthorizedUrl == <span class="keyword">null</span>) &#123;</span><br><span class="line">                authzFilter.setUnauthorizedUrl(unauthorizedUrl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLoginUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> loginUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginUrl</span><span class="params">(String loginUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.loginUrl = loginUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSuccessUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> successUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSuccessUrl</span><span class="params">(String successUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.successUrl = successUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUnauthorizedUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unauthorizedUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUnauthorizedUrl</span><span class="params">(String unauthorizedUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.unauthorizedUrl = unauthorizedUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="CustomPathMatchingFilterChainResolver"><a href="#CustomPathMatchingFilterChainResolver" class="headerlink" title="CustomPathMatchingFilterChainResolver"></a>CustomPathMatchingFilterChainResolver</h6><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702210004.png" alt="1582687131628"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.shiro.web.filter.mgt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FilterChainResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//根据请求获得对应的过滤器链</span></span><br><span class="line">    <span class="function">FilterChain <span class="title">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>CustomPathMatchingFilterChainResolver</p>
<p>这里主要核心内容是：指定使用过滤器链管理器为自己定的过滤器管理器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.mgt.FilterChainManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomPathMatchingFilterChainResolver</span> <span class="keyword">extends</span> <span class="title">PathMatchingFilterChainResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CustomDefaultFilterChainManager customDefaultFilterChainManager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCustomDefaultFilterChainManager</span><span class="params">(CustomDefaultFilterChainManager customDefaultFilterChainManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.customDefaultFilterChainManager = customDefaultFilterChainManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CustomDefaultFilterChainManager <span class="title">getCustomDefaultFilterChainManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> customDefaultFilterChainManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterChain <span class="title">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//指定使用过滤器链管理器为自己定的过滤器管理器</span></span><br><span class="line">        FilterChainManager filterChainManager = getCustomDefaultFilterChainManager();</span><br><span class="line">        <span class="keyword">if</span> (!filterChainManager.hasChains()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String requestURI = getPathWithinApplication(request);</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; chainNames = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        <span class="comment">//the &#x27;chain names&#x27; in this implementation are actually path patterns defined by the user.  We just use them</span></span><br><span class="line">        <span class="comment">//as the chain name for the FilterChainManager&#x27;s requirements</span></span><br><span class="line">        <span class="keyword">for</span> (String pathPattern : filterChainManager.getChainNames()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the path does match, then pass on to the subclass implementation for specific checks:</span></span><br><span class="line">            <span class="keyword">if</span> (pathMatches(pathPattern, requestURI)) &#123;</span><br><span class="line">                <span class="keyword">return</span> filterChainManager.proxy(originalChain, pathPattern);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="CustomShiroFilterFactoryBean"><a href="#CustomShiroFilterFactoryBean" class="headerlink" title="CustomShiroFilterFactoryBean"></a>CustomShiroFilterFactoryBean</h6><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205957.png" alt="1582688545621"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> AbstractShiroFilter <span class="title">createInstance</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;Creating Shiro Filter instance.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        SecurityManager securityManager = getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (securityManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">            String msg = <span class="string">&quot;SecurityManager property must be set.&quot;</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanInitializationException(msg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(securityManager <span class="keyword">instanceof</span> WebSecurityManager)) &#123;</span><br><span class="line">            String msg = <span class="string">&quot;The security manager does not implement the WebSecurityManager interface.&quot;</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanInitializationException(msg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        FilterChainManager manager = createFilterChainManager();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Expose the constructed FilterChainManager by first wrapping it in a</span></span><br><span class="line">        <span class="comment">// FilterChainResolver implementation. The AbstractShiroFilter implementations</span></span><br><span class="line">        <span class="comment">// do not know about FilterChainManagers - only resolvers:</span></span><br><span class="line">        PathMatchingFilterChainResolver chainResolver = <span class="keyword">new</span> PathMatchingFilterChainResolver();</span><br><span class="line">        chainResolver.setFilterChainManager(manager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Now create a concrete ShiroFilter instance and apply the acquired SecurityManager and built</span></span><br><span class="line">        <span class="comment">//FilterChainResolver.  It doesn&#x27;t matter that the instance is an anonymous inner class</span></span><br><span class="line">        <span class="comment">//here - we&#x27;re just using it because it is a concrete AbstractShiroFilter instance that accepts</span></span><br><span class="line">        <span class="comment">//injection of the SecurityManager and FilterChainResolver:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringShiroFilter((WebSecurityManager) securityManager, chainResolver);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ShiroFilterFactoryBean源码我们发现PathMatchingFilterChainResolver未暴露set方法，我们改写一下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.mgt.FilterChainManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.mgt.FilterChainResolver;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.WebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.servlet.AbstractShiroFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanInitializationException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomShiroFilterFactoryBean</span> <span class="keyword">extends</span> <span class="title">ShiroFilterFactoryBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    PathMatchingFilterChainResolver chainResolver ;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setChainResolver</span><span class="params">(PathMatchingFilterChainResolver chainResolver)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.chainResolver = chainResolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AbstractShiroFilter <span class="title">createInstance</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        SecurityManager securityManager = getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (securityManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">            String msg = <span class="string">&quot;SecurityManager property must be set.&quot;</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanInitializationException(msg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(securityManager <span class="keyword">instanceof</span> WebSecurityManager)) &#123;</span><br><span class="line">            String msg = <span class="string">&quot;The security manager does not implement the WebSecurityManager interface.&quot;</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanInitializationException(msg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        FilterChainManager manager = createFilterChainManager();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        chainResolver.setFilterChainManager(manager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Now create a concrete ShiroFilter instance and apply the acquired SecurityManager and built</span></span><br><span class="line">        <span class="comment">//FilterChainResolver.  It doesn&#x27;t matter that the instance is an anonymous inner class</span></span><br><span class="line">        <span class="comment">//here - we&#x27;re just using it because it is a concrete AbstractShiroFilter instance that accepts</span></span><br><span class="line">        <span class="comment">//injection of the SecurityManager and FilterChainResolver:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringShiroFilter((WebSecurityManager) securityManager, chainResolver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringShiroFilter</span> <span class="keyword">extends</span> <span class="title">AbstractShiroFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">SpringShiroFilter</span><span class="params">(WebSecurityManager webSecurityManager, FilterChainResolver resolver)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>();</span><br><span class="line">            <span class="keyword">if</span> (webSecurityManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;WebSecurityManager property cannot be null.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            setSecurityManager(webSecurityManager);</span><br><span class="line">            <span class="keyword">if</span> (resolver != <span class="keyword">null</span>) &#123;</span><br><span class="line">                setFilterChainResolver(resolver);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="ShiroConfig改造"><a href="#ShiroConfig改造" class="headerlink" title="ShiroConfig改造"></a>ShiroConfig改造</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.SuperConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.ShiroDbRealm;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.filter.*;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.impl.*;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.credential.HashedCredentialsMatcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.mgt.eis.SessionDAO;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.LifecycleBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.servlet.SimpleCookie;</span><br><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.redisson.config.Config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.DependsOn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 权限配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &#123;&quot;com.itheima.shiro.core&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;ShiroRedisProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShiroRedisProperties shiroRedisProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JwtTokenManager jwtTokenManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> redission客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;redissonClientForShiro&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedissonClient <span class="title">redissonClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;=====初始化redissonClientForShiro开始======&quot;</span>);</span><br><span class="line">        String[] nodeList = shiroRedisProperties.getNodes().split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        Config config = <span class="keyword">new</span> Config();</span><br><span class="line">        <span class="keyword">if</span> (nodeList.length == <span class="number">1</span>) &#123;</span><br><span class="line">            config.useSingleServer().setAddress(nodeList[<span class="number">0</span>])</span><br><span class="line">                    .setConnectTimeout(shiroRedisProperties.getConnectTimeout())</span><br><span class="line">                    .setConnectionMinimumIdleSize(shiroRedisProperties.getConnectionMinimumidleSize())</span><br><span class="line">                    .setConnectionPoolSize(shiroRedisProperties.getConnectPoolSize()).setTimeout(shiroRedisProperties.getTimeout());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            config.useClusterServers().addNodeAddress(nodeList)</span><br><span class="line">                    .setConnectTimeout(shiroRedisProperties.getConnectTimeout())</span><br><span class="line">                    .setMasterConnectionMinimumIdleSize(shiroRedisProperties.getConnectionMinimumidleSize())</span><br><span class="line">                    .setMasterConnectionPoolSize(shiroRedisProperties.getConnectPoolSize()).setTimeout(shiroRedisProperties.getTimeout());</span><br><span class="line">        &#125;</span><br><span class="line">        RedissonClient redissonClient =  Redisson.create(config);</span><br><span class="line">        log.info(<span class="string">&quot;=====初始化redissonClientForShiro完成======&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> redissonClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 创建cookie对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;sessionIdCookie&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleCookie <span class="title">simpleCookie</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SimpleCookie simpleCookie = <span class="keyword">new</span> SimpleCookie();</span><br><span class="line">        simpleCookie.setName(<span class="string">&quot;ShiroSession&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> simpleCookie;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 缓存管理器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;shiroCacheManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroCacheManager <span class="title">shiroCacheManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ShiroCacheManager(shiroRedisProperties.getGlobalSessionTimeout());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 权限管理器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;securityManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">defaultWebSecurityManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        securityManager.setRealm(shiroDbRealm());</span><br><span class="line">        securityManager.setSessionManager(shiroSessionManager());</span><br><span class="line">        securityManager.setCacheManager(shiroCacheManager());</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 密码比较器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HashedCredentialsMatcher <span class="title">hashedCredentialsMatcher</span> <span class="params">()</span></span>&#123;</span><br><span class="line">        RetryLimitCredentialsMatcher matcher = <span class="keyword">new</span> RetryLimitCredentialsMatcher(SuperConstant.HASH_ALGORITHM);</span><br><span class="line">        matcher.setHashIterations(SuperConstant.HASH_INTERATIONS);</span><br><span class="line">        <span class="keyword">return</span> matcher;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义RealmImpl</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;shiroDbRealm&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroDbRealm <span class="title">shiroDbRealm</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ShiroDbRealm shiroDbRealm =<span class="keyword">new</span> ShiroDbRealmImpl();</span><br><span class="line">        shiroDbRealm.setCredentialsMatcher(hashedCredentialsMatcher());</span><br><span class="line">        <span class="keyword">return</span> shiroDbRealm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义session会话存储的实现类 ，使用Redis来存储共享session，达到分布式部署目的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;redisSessionDao&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SessionDAO <span class="title">redisSessionDao</span><span class="params">()</span></span>&#123;</span><br><span class="line">        RedisSessionDao sessionDAO =   <span class="keyword">new</span> RedisSessionDao();</span><br><span class="line">        sessionDAO.setGlobalSessionTimeout(shiroRedisProperties.getGlobalSessionTimeout());</span><br><span class="line">        <span class="keyword">return</span> sessionDAO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 会话管理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name=&quot;sessionManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroSessionManager <span class="title">shiroSessionManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ShiroSessionManager sessionManager = <span class="keyword">new</span> ShiroSessionManager();</span><br><span class="line">        sessionManager.setSessionDAO(redisSessionDao());</span><br><span class="line">        sessionManager.setSessionValidationSchedulerEnabled(<span class="keyword">false</span>);</span><br><span class="line">        sessionManager.setSessionIdCookieEnabled(<span class="keyword">true</span>);</span><br><span class="line">        sessionManager.setSessionIdCookie(simpleCookie());</span><br><span class="line">        sessionManager.setGlobalSessionTimeout(shiroRedisProperties.getGlobalSessionTimeout());</span><br><span class="line">        <span class="keyword">return</span> sessionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 保证实现了Shiro内部lifecycle函数的bean执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;lifecycleBeanPostProcessor&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LifecycleBeanPostProcessor <span class="title">getLifecycleBeanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LifecycleBeanPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> AOP式方法级权限检查</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@DependsOn(&quot;lifecycleBeanPostProcessor&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title">getDefaultAdvisorAutoProxyCreator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultAdvisorAutoProxyCreator defaultAdvisorAutoProxyCreator = <span class="keyword">new</span> DefaultAdvisorAutoProxyCreator();</span><br><span class="line">        defaultAdvisorAutoProxyCreator.setProxyTargetClass(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultAdvisorAutoProxyCreator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 配合DefaultAdvisorAutoProxyCreator事项注解权限校验</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title">getAuthorizationAttributeSourceAdvisor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        AuthorizationAttributeSourceAdvisor aasa = <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">        aasa.setSecurityManager(defaultWebSecurityManager());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义拦截器定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, Filter&gt; <span class="title">filters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Filter&gt; map = <span class="keyword">new</span> HashMap&lt;String, Filter&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;role-or&quot;</span>, <span class="keyword">new</span> RolesOrAuthorizationFilter());</span><br><span class="line">        map.put(<span class="string">&quot;kicked-out&quot;</span>, <span class="keyword">new</span> KickedOutAuthorizationFilter(redissonClient(), redisSessionDao(), shiroSessionManager()));</span><br><span class="line">        map.put(<span class="string">&quot;jwt-authc&quot;</span>, <span class="keyword">new</span> JwtAuthcFilter(jwtTokenManager));</span><br><span class="line">        map.put(<span class="string">&quot;jwt-perms&quot;</span>, <span class="keyword">new</span> JwtPermsFilter());</span><br><span class="line">        map.put(<span class="string">&quot;jwt-roles&quot;</span>, <span class="keyword">new</span> JwtRolesFilter());</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> Shiro过滤器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;shiroFilter&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CustomShiroFilterFactoryBean <span class="title">shiroFilterFactoryBean</span><span class="params">()</span></span>&#123;</span><br><span class="line">        CustomShiroFilterFactoryBean shiroFilter = <span class="keyword">new</span> CustomShiroFilterFactoryBean();</span><br><span class="line">        shiroFilter.setSecurityManager(defaultWebSecurityManager());</span><br><span class="line">        shiroFilter.setChainResolver(filterChainResolver());</span><br><span class="line">        <span class="keyword">return</span> shiroFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CustomDefaultFilterChainManager <span class="title">defaultFilterChainManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        CustomDefaultFilterChainManager filterChainManager = <span class="keyword">new</span> CustomDefaultFilterChainManager();</span><br><span class="line">        filterChainManager.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        filterChainManager.setUnauthorizedUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        filterChainManager.setCustomFilters(filters());</span><br><span class="line">        <span class="keyword">return</span> filterChainManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">CustomPathMatchingFilterChainResolver <span class="title">filterChainResolver</span><span class="params">()</span></span>&#123;</span><br><span class="line">        CustomPathMatchingFilterChainResolver pathMatchingFilterChainResolver = <span class="keyword">new</span> CustomPathMatchingFilterChainResolver();</span><br><span class="line">        pathMatchingFilterChainResolver.setCustomDefaultFilterChainManager(defaultFilterChainManager());</span><br><span class="line">        <span class="keyword">return</span> pathMatchingFilterChainResolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="shiro-client客户端"><a href="#shiro-client客户端" class="headerlink" title="shiro-client客户端"></a>shiro-client客户端</h3><p>shiro-client作为jar的依赖，满足以下需求：</p>
<p>1、非侵入式：使用者只需要对jar依赖和做少量的配置，就可以达到统一鉴权的目标</p>
<p>2、可扩展性：用户除使用提供的过滤器外，可以轻松安自己的业务区定义过滤器</p>
<p>3、集中式管理：依赖jar之后，shiro-mgt后台可以同时管控多个平台的权限的认证、鉴权、及动态配置过滤器链</p>
<h4 id="模块依赖关系-1"><a href="#模块依赖关系-1" class="headerlink" title="模块依赖关系"></a>模块依赖关系</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205948.png" alt="1582688991837"></p>
<h4 id="原理分析-4"><a href="#原理分析-4" class="headerlink" title="原理分析"></a>原理分析</h4><p>springboot-shiro-framework-client项目向上继承了springboot-shiro-framework-core项目，springboot-shiro-framework-core是主要实现认证、鉴权、过滤器定义、会话统一、realm缓存的核心项目。</p>
<p>springboot-shiro-framework-client项目以jar的方式被需要做权限控制的gateway项目所依赖，再由gateway通过对springboot-shiro-producer的dubbo消费，以达到统一认证、鉴权</p>
<p>springboot-shiro-framework-client模块实现了springboot-shiro-framework-core接口的3个类：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">UserBridgeServiceImpl</span>:<span class="string">提供用户基本资源操作的业务实现</span></span><br><span class="line"><span class="attr">FilterChainBridgeServiceImpl</span>:<span class="string">提供过滤器链接口的查询</span></span><br><span class="line"><span class="attr">ResourceBridgeServiceImpl</span>:<span class="string">提供资源查询</span></span><br></pre></td></tr></table></figure>

<p>UserBridgeServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.CacheConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.SimpleCacheManager;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.ShiroUser;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.SimpleMapCache;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.base.SimpleToken;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.bridge.UserBridgeService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.face.UserAdapterFace;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.BeanConv;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.ShiroUserUtil;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.ResourceVo;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.RoleVo;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.UserVo;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.Reference;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.SimpleAuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UnknownAccountException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RBucket;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 权限桥接器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component(&quot;userBridgeService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserBridgeServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserBridgeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Reference(version = &quot;1.0.0&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> UserAdapterFace userAdapterFace;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SimpleCacheManager simpleCacheManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@javax</span>.annotation.Resource(name = <span class="string">&quot;redissonClientForShiro&quot;</span>)</span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authcToken,String realmName)</span> </span>&#123;</span><br><span class="line">        SimpleToken token = (SimpleToken)authcToken;</span><br><span class="line">        UserVo user  = <span class="keyword">this</span>.findUserByLoginName(token.getUsername());</span><br><span class="line">        <span class="keyword">if</span>(EmptyUtil.isNullOrEmpty(user))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(<span class="string">&quot;账号不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ShiroUser shiroUser = BeanConv.toBean(user, ShiroUser.class);</span><br><span class="line">        String sessionId = ShiroUserUtil.getShiroSessionId();</span><br><span class="line">        String cacheKeyResourcesIds = CacheConstant.RESOURCES_KEY_IDS+sessionId;</span><br><span class="line">        shiroUser.setResourceIds(<span class="keyword">this</span>.findResourcesIdsList(cacheKeyResourcesIds,user.getId()));</span><br><span class="line">        String salt = user.getSalt();</span><br><span class="line">        String password = user.getPassWord();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(shiroUser, password, ByteSource.Util.bytes(salt), realmName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleAuthorizationInfo <span class="title">getAuthorizationInfo</span><span class="params">(ShiroUser shiroUser)</span> </span>&#123;</span><br><span class="line">        UserVo user = BeanConv.toBean(shiroUser, UserVo.class);</span><br><span class="line">        SimpleAuthorizationInfo info = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">        String sessionId = ShiroUserUtil.getShiroSessionId();</span><br><span class="line">        <span class="comment">//查询用户拥有的角色</span></span><br><span class="line">        String cacheKeyRole = CacheConstant.ROLE_KEY + sessionId;</span><br><span class="line">        info.addRoles(<span class="keyword">this</span>.findRoleList(cacheKeyRole, user.getId()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询用户拥有的资源</span></span><br><span class="line">        String cacheKeyResources = CacheConstant.RESOURCES_KEY + sessionId;</span><br><span class="line">        info.addStringPermissions(<span class="keyword">this</span>.findResourcesList(cacheKeyResources, user.getId()));</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findRoleList</span><span class="params">(String cacheKeyRole, String userId)</span> </span>&#123;</span><br><span class="line">        List&lt;RoleVo&gt; roles = <span class="keyword">new</span> ArrayList&lt;RoleVo&gt;();</span><br><span class="line">        <span class="keyword">if</span> (simpleCacheManager.getCache(cacheKeyRole) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            roles = (List&lt;RoleVo&gt;) simpleCacheManager.getCache(cacheKeyRole).get(cacheKeyRole);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            roles = userAdapterFace.findRoleByUserId(userId);</span><br><span class="line">            <span class="keyword">if</span> (roles.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//用户角色存放到map</span></span><br><span class="line">                Map&lt;Object, Object&gt; mapRole = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">                mapRole.put(cacheKeyRole, roles);</span><br><span class="line">                <span class="comment">//新建SimpleMapCache实例并放入缓存管理器</span></span><br><span class="line">                SimpleMapCache cacheRole = <span class="keyword">new</span> SimpleMapCache(cacheKeyRole, mapRole);</span><br><span class="line">                simpleCacheManager.createCache(cacheKeyRole, cacheRole);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;String&gt; rolesLabel = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        <span class="keyword">for</span> (RoleVo role : roles) &#123;</span><br><span class="line">            rolesLabel.add(role.getLabel());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rolesLabel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findResourcesList</span><span class="params">(String cacheKeyResources,String userId)</span> </span>&#123;</span><br><span class="line">        List&lt;ResourceVo&gt; resourcesList = <span class="keyword">new</span> ArrayList&lt;ResourceVo&gt;();</span><br><span class="line">        <span class="keyword">if</span> (simpleCacheManager.getCache(cacheKeyResources) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resourcesList = (List&lt;ResourceVo&gt;) simpleCacheManager.getCache(cacheKeyResources).get(cacheKeyResources);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resourcesList = userAdapterFace.findResourceByUserId(userId);</span><br><span class="line">            <span class="keyword">if</span> (resourcesList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//用户资源存放到map</span></span><br><span class="line">                Map&lt;Object, Object&gt; mapResource = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">                mapResource.put(cacheKeyResources, resourcesList);</span><br><span class="line">                <span class="comment">//新建SimpleMapCache实例并放入缓存管理器</span></span><br><span class="line">                SimpleMapCache cacheResource = <span class="keyword">new</span> SimpleMapCache(cacheKeyResources, mapResource);</span><br><span class="line">                simpleCacheManager.createCache(cacheKeyResources, cacheResource);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;String&gt; resourcesLabel = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ResourceVo resources : resourcesList) &#123;</span><br><span class="line">            resourcesLabel.add(resources.getLabel());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resourcesLabel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserVo <span class="title">findUserByLoginName</span><span class="params">(String loginName)</span> </span>&#123;</span><br><span class="line">        String key = CacheConstant.FIND_USER_BY_LOGINNAME+loginName;</span><br><span class="line">        RBucket&lt;UserVo&gt; rBucket = redissonClient.getBucket(key);</span><br><span class="line">        UserVo user = rBucket.get();</span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(user)) &#123;</span><br><span class="line">            <span class="keyword">return</span> user;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            user = userAdapterFace.findUserByLoginName(loginName);</span><br><span class="line">            <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(user)) &#123;</span><br><span class="line">                rBucket.set(user, <span class="number">300</span>, TimeUnit.SECONDS);</span><br><span class="line">                <span class="keyword">return</span> user;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        rBucket.set(<span class="keyword">new</span> UserVo(), <span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findResourcesIdsList</span><span class="params">(String cacheKeyResources,String userId)</span> </span>&#123;</span><br><span class="line">        List&lt;ResourceVo&gt; resourcesList = <span class="keyword">new</span> ArrayList&lt;ResourceVo&gt;();</span><br><span class="line">        <span class="keyword">if</span> (simpleCacheManager.getCache(cacheKeyResources) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resourcesList = (List&lt;ResourceVo&gt;) simpleCacheManager.getCache(cacheKeyResources).get(cacheKeyResources);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resourcesList = userAdapterFace.findResourceByUserId(userId);</span><br><span class="line">            <span class="keyword">if</span> (resourcesList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//用户资源存放到map</span></span><br><span class="line">                Map&lt;Object, Object&gt; mapResource = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">                mapResource.put(cacheKeyResources, resourcesList);</span><br><span class="line">                <span class="comment">//新建SimpleMapCache实例并放入缓存管理器</span></span><br><span class="line">                SimpleMapCache cacheResource = <span class="keyword">new</span> SimpleMapCache(cacheKeyResources, mapResource);</span><br><span class="line">                simpleCacheManager.createCache(cacheKeyResources, cacheResource);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;String&gt; resourcesLabel = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ResourceVo resources : resourcesList) &#123;</span><br><span class="line">            resourcesLabel.add(resources.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resourcesLabel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadUserAuthorityToCache</span><span class="params">(ShiroUser user)</span> </span>&#123;</span><br><span class="line">        String sessionId = user.getSessionId();</span><br><span class="line">        List&lt;RoleVo&gt; roles = userAdapterFace.findRoleByUserId(user.getId());</span><br><span class="line">        <span class="comment">//创建角色cachaeKey</span></span><br><span class="line">        String cacheKeyRole = CacheConstant.ROLE_KEY + sessionId;</span><br><span class="line">        <span class="comment">//用户角色存放到map</span></span><br><span class="line">        Map&lt;Object, Object&gt; mapRole = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">        mapRole.put(cacheKeyRole, roles);</span><br><span class="line">        <span class="comment">//新建SimpleMapCache实例并放入缓存管理器</span></span><br><span class="line">        SimpleMapCache cacheRole = <span class="keyword">new</span> SimpleMapCache(cacheKeyRole, mapRole);</span><br><span class="line">        simpleCacheManager.createCache(cacheKeyRole, cacheRole);</span><br><span class="line"></span><br><span class="line">        List&lt;ResourceVo&gt; resourcesList = userAdapterFace.findResourceByUserId(user.getId());</span><br><span class="line">        <span class="keyword">if</span> (resourcesList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//创建资源cachaeKey</span></span><br><span class="line">            String cacheKeyResources = CacheConstant.RESOURCES_KEY + sessionId;</span><br><span class="line">            <span class="comment">//用户资源存放到map</span></span><br><span class="line">            Map&lt;Object, Object&gt; mapResource = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">            mapResource.put(cacheKeyResources, resourcesList);</span><br><span class="line">            <span class="comment">//新建SimpleMapCache实例并放入缓存管理器</span></span><br><span class="line">            SimpleMapCache cacheResource = <span class="keyword">new</span> SimpleMapCache(cacheKeyResources, mapResource);</span><br><span class="line">            simpleCacheManager.createCache(cacheKeyResources, cacheResource);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>FilterChainBridgeServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.bridge.FilterChainBridgeService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.face.FilterChainFace;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.FilterChainVo;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.Reference;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：过滤器链查询</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(&quot;filterChainBridgeService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilterChainBridgeServiceImpl</span> <span class="keyword">implements</span> <span class="title">FilterChainBridgeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Reference(version = &quot;1.0.0&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> FilterChainFace filterChainFace;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;FilterChainVo&gt; <span class="title">findFilterChainList</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> filterChainFace.findFilterChainList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ResourceBridgeServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.bridge.ResourceBridgeService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.face.ResourceAdapterFace;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.ResourceVo;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.Reference;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：查询资源</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(&quot;resourceBridgeService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceBridgeServiceImpl</span> <span class="keyword">implements</span> <span class="title">ResourceBridgeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;itheima.resource.systemcode&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String systemCode;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Reference(version = &quot;1.0.0&quot;)</span></span><br><span class="line">    ResourceAdapterFace resourceAdapterFace;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ResourceVo&gt; <span class="title">findValidResourceVoAll</span><span class="params">(String systemCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> resourceAdapterFace.findValidResourceVoAll(systemCode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从中我们可以看到3个类调用了springboot-shiro-handler中提供的dubbo鉴权服务化内容</p>
<h3 id="shiro-gateway网关"><a href="#shiro-gateway网关" class="headerlink" title="shiro-gateway网关"></a>shiro-gateway网关</h3><h4 id="原理分析-5"><a href="#原理分析-5" class="headerlink" title="原理分析"></a>原理分析</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205940.png" alt="1582880165581"></p>
<p>​    1、依赖springboot-shiro-framework-client实现认证、鉴权、过滤器定义、会话统一、realm缓存等功能</p>
<p>​    2、springboot-shiro-mgt管理后台持久化网关资源</p>
<p>​    3、springboot-shiro-handler实现网关资源查询服务化</p>
<p>​    4、gateway-service依据持久化的网关资源，动态创建消费端服务</p>
<h4 id="代码实现-2"><a href="#代码实现-2" class="headerlink" title="代码实现"></a>代码实现</h4><h5 id="网关资源持久化"><a href="#网关资源持久化" class="headerlink" title="网关资源持久化"></a>网关资源持久化</h5><p>这里在原有资源的基础上，增加的网关资源的管理：</p>
<p>​        1、定义网关systemcode，用以区分不同网关系统</p>
<p>​        2、定义访问的路径</p>
<p>​        3、定义资源的唯一标识，作为权限控制的标识</p>
<p>​        4、定义业务端dubbo服务端接口、目标方法、传入阐述、轮训算法、超时时间、重试次数等参数，这些内容会在gateway-service项目中解析</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205932.png" alt="1582704703769"></p>
<h5 id="网关资源服务化"><a href="#网关资源服务化" class="headerlink" title="网关资源服务化"></a>网关资源服务化</h5><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">ResourceAdapterFace</span>:<span class="string">网关资源服务接口</span></span><br><span class="line"><span class="attr">ResourceAdapterFaceImpl</span>:<span class="string">网关资源服务接口实现</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ResourceBridgeService</span>:<span class="string">网关资源桥接器接口</span></span><br><span class="line"><span class="attr">ResourceBridgeServiceImpl</span>:<span class="string">网关资源桥接器接口实现</span></span><br></pre></td></tr></table></figure>
<p>ResourceAdapterFace</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.face;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.ResourceVo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：网关资源服务接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourceAdapterFace</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 获得当前系统是由有效的dubbo的资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;ResourceVo&gt; <span class="title">findValidResourceVoAll</span><span class="params">(String systemCode)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ResourceAdapterFaceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.faceImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.face.ResourceAdapterFace;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.Resource;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.service.ResourceService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.BeanConv;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.ResourceVo;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：网关资源服务接口实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service(version = &quot;1.0.0&quot;, retries = 3,timeout = 5000)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceAdapterFaceImpl</span> <span class="keyword">implements</span> <span class="title">ResourceAdapterFace</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ResourceService resourceService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ResourceVo&gt; <span class="title">findValidResourceVoAll</span><span class="params">(String systemCode)</span> </span>&#123;</span><br><span class="line">        List&lt;Resource&gt; resourceList =  resourceService.findValidResourceVoAll(systemCode);</span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(resourceList))&#123;</span><br><span class="line">            <span class="keyword">return</span> BeanConv.toBeanList(resourceList, ResourceVo.class);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ResourceBridgeService</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.core.bridge;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.ResourceVo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：网关资源桥接器接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourceBridgeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查询当前系统所有有效的DUBBO类型的服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> systemCode 系统编号：与mgt添加系统编号相同</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ResourceVo&gt; <span class="title">findValidResourceVoAll</span><span class="params">(String systemCode)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ResourceBridgeServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.bridge.ResourceBridgeService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.face.ResourceAdapterFace;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.ResourceVo;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.Reference;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：网关资源桥接器接口实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(&quot;resourceBridgeService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceBridgeServiceImpl</span> <span class="keyword">implements</span> <span class="title">ResourceBridgeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;itheima.resource.systemcode&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String systemCode;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Reference(version = &quot;1.0.0&quot;)</span></span><br><span class="line">    ResourceAdapterFace resourceAdapterFace;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ResourceVo&gt; <span class="title">findValidResourceVoAll</span><span class="params">(String systemCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> resourceAdapterFace.findValidResourceVoAll(systemCode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="动态消费端"><a href="#动态消费端" class="headerlink" title="动态消费端"></a>动态消费端</h5><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205911.png" alt="1582882166870"></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">CacheWare</span>:<span class="string">缓存仓库</span></span><br><span class="line"></span><br><span class="line"><span class="attr">CacheWareService</span>:<span class="string">缓存仓库服务接口</span></span><br><span class="line"><span class="attr">CacheWareServiceImpl</span>:<span class="string">缓存仓库服务接口实现</span></span><br><span class="line"></span><br><span class="line"><span class="attr">CacheWareSyncService</span>:<span class="string">缓存仓库同步服务接口</span></span><br><span class="line"><span class="attr">CacheWareSyncServiceImpl</span>:<span class="string">缓存仓库同步服务接口实现</span></span><br><span class="line"></span><br><span class="line"><span class="attr">LoginAction</span>:<span class="string">登录相应接口</span></span><br><span class="line"><span class="attr">GateWayController</span>:<span class="string">相应层的统一入口</span></span><br></pre></td></tr></table></figure>



<h6 id="CacheWareService"><a href="#CacheWareService" class="headerlink" title="CacheWareService"></a>CacheWareService</h6><p>其主要负责：</p>
<p>1、缓存的清除</p>
<p>2、向map容器中创建缓存</p>
<p>3、获得缓存仓库执行对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.cache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Multimap;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.CacheWare;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：缓存仓库服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CacheWareService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 清除缓存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clearCacheWare</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 向map容器中创建缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> CacheWareMap</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">createCacheWare</span><span class="params">(Multimap&lt;String, CacheWare&gt; CacheWareMap)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 获得缓存仓库执行对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceName 服务名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> methodName  方法名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> CacheWare&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">CacheWare <span class="title">queryCacheWare</span><span class="params">(String serviceName, String methodName)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>CacheWareServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.cache.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.ArrayListMultimap;</span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Multimap;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.cache.CacheWareService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.CacheWare;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service(&quot;cacheWareService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheWareServiceImpl</span> <span class="keyword">implements</span> <span class="title">CacheWareService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Multimap&lt;String, CacheWare&gt; cacheWareMaps = ArrayListMultimap.create();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReentrantLock reentrantLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearCacheWare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            reentrantLock.lock();</span><br><span class="line">            cacheWareMaps.clear();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            reentrantLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createCacheWare</span><span class="params">(Multimap&lt;String, CacheWare&gt; CacheWareMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            reentrantLock.lock();</span><br><span class="line">            <span class="keyword">this</span>.cacheWareMaps = CacheWareMap;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            reentrantLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheWare <span class="title">queryCacheWare</span><span class="params">(String serviceName, String methodName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (EmptyUtil.isNullOrEmpty(serviceName) || EmptyUtil.isNullOrEmpty(serviceName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer serviceNameStringBuffer = <span class="keyword">new</span> StringBuffer(serviceName);</span><br><span class="line">        StringBuffer methodNameStringBuffer = <span class="keyword">new</span> StringBuffer(methodName);</span><br><span class="line">        String key = serviceNameStringBuffer.append(<span class="string">&quot;:&quot;</span>).append(methodName).toString();</span><br><span class="line">        Collection&lt;CacheWare&gt; cacheWares = cacheWareMaps.get(key);</span><br><span class="line">        <span class="keyword">return</span> EmptyUtil.isNullOrEmpty(cacheWares) ? <span class="keyword">null</span> : cacheWares.iterator().next();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="CacheWareSyncService"><a href="#CacheWareSyncService" class="headerlink" title="CacheWareSyncService"></a>CacheWareSyncService</h6><p>其主要职责：</p>
<p>1、启动时、调用CacheWareService的创建缓存方法初始化缓存仓库</p>
<p>2、同步缓存仓库</p>
<p>3、网关资源转化缓存仓库可执行对象</p>
<p>4、从dubbo中，初始化代理对象</p>
<p>注意：为了在多个网关系统下，接口转换的无干扰，读取的只是本网关所对应的资源</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.cache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.CacheWare;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.ResourceVo;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：缓存仓库同步刷新</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CacheWareSyncService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 初始化缓存仓库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">initCacheWare</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 同步缓存仓库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refreshCacheWare</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 资源转换缓存仓库对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">CacheWare <span class="title">resourceConvCacheWare</span><span class="params">(ResourceVo resource)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 初始化代理对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> interfaceClass 接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loadbalance 算法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> version 版本</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeout 超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> retries 重试次数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Object <span class="title">initProxy</span><span class="params">(Class&lt;?&gt; interfaceClass,</span></span></span><br><span class="line"><span class="params"><span class="function">                     String loadbalance,</span></span></span><br><span class="line"><span class="params"><span class="function">                     String version,</span></span></span><br><span class="line"><span class="params"><span class="function">                     Integer timeout,</span></span></span><br><span class="line"><span class="params"><span class="function">                     Integer retries)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 回收资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destoryCacheWare</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>CacheWareSyncServiceImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.cache.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.ArrayListMultimap;</span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Multimap;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.cache.CacheWareService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.cache.CacheWareSyncService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.core.bridge.ResourceBridgeService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.face.ResourceAdapterFace;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.CacheWare;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.vo.ResourceVo;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.ApplicationConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.ReferenceConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.RegistryConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.Reference;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.utils.ReferenceConfigCache;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.PreDestroy;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ScheduledExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service(&quot;cacheWareSyncService&quot;)</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheWareSyncServiceImpl</span> <span class="keyword">implements</span> <span class="title">CacheWareSyncService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;itheima.resource.systemcode&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String systemCode;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ResourceBridgeService resourceBridgeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CacheWareService cacheWareService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationConfig applicationConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RegistryConfig registryConfig;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ScheduledExecutorService executor = Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initCacheWare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        executor.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    refreshCacheWare();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(e.getMessage(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>, <span class="number">2</span>, TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshCacheWare</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        List&lt;ResourceVo&gt; resources = resourceBridgeService.findValidResourceVoAll(systemCode);</span><br><span class="line">        <span class="comment">//如果当前系统没有资源，则清空</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(resources)) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;No apis can be used.&quot;</span>);</span><br><span class="line">            cacheWareService.clearCacheWare();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//构建执行集合</span></span><br><span class="line">        Multimap&lt;String, CacheWare&gt; cacheWareMaps = ArrayListMultimap.create();</span><br><span class="line">        <span class="keyword">for</span> (ResourceVo resource : resources) &#123;</span><br><span class="line">            <span class="keyword">if</span> (EmptyUtil.isNullOrEmpty(resource.getServiceName())</span><br><span class="line">            ||EmptyUtil.isNullOrEmpty(resource.getMethodName()))&#123;</span><br><span class="line">                log.warn(<span class="string">&quot;&#123;&#125; not found serviceName or methodName&quot;</span>,resources.toString());</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            CacheWare cacheWare = resourceConvCacheWare(resource);</span><br><span class="line">            <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(cacheWare))&#123;</span><br><span class="line">                cacheWareMaps.put(cacheWare.getServiceName()+<span class="string">&quot;:&quot;</span>+cacheWare.getMethodName(), cacheWare);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cacheWareService.createCacheWare(cacheWareMaps);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheWare <span class="title">resourceConvCacheWare</span><span class="params">(ResourceVo resource)</span>  </span>&#123;</span><br><span class="line">        <span class="comment">//获得类型</span></span><br><span class="line">        Class&lt;?&gt; serviceClass = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            serviceClass = Class.forName(resource.getServiceName());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;容器中未发现：&#123;&#125;接口类&quot;</span>,resource.getServiceName());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String serviceName = resource.getServiceName().substring(resource.getServiceName().lastIndexOf(<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>).toLowerCase();</span><br><span class="line">        Method[] methods = serviceClass.getDeclaredMethods();</span><br><span class="line">        Method methodTarget = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//获得方法</span></span><br><span class="line">        <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">            <span class="keyword">if</span> (method.getName().equals(resource.getMethodName())) &#123;</span><br><span class="line">                methodTarget = method;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 未在接口类中找到方法</span></span><br><span class="line">        <span class="keyword">if</span> (methodTarget == <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;&#123;&#125; not found in &#123;&#125;&quot;</span>, resource.getMethodName(), resource.getServiceName());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获得方法上的参数</span></span><br><span class="line">        Class&lt;?&gt;[] methodParamsClasss = methodTarget.getParameterTypes();</span><br><span class="line">        Class&lt;?&gt; methodParamClasssTarget = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; methodParamsClass : methodParamsClasss) &#123;</span><br><span class="line">            <span class="keyword">if</span> (methodParamsClass.getName().equals(resource.getMethodParam())) &#123;</span><br><span class="line">                methodParamClasssTarget = methodParamsClass;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//初始化代理类</span></span><br><span class="line">        Object proxy = initProxy(serviceClass, resource.getLoadbalance(), resource.getDubboVersion(), resource.getTimeout(), resource.getRetries());</span><br><span class="line">        <span class="keyword">if</span> (proxy == <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;&#123;&#125; not found in proxy&quot;</span>, resource.getServiceName());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">       	<span class="comment">//构建CacheWare对象</span></span><br><span class="line">        CacheWare cacheWare = CacheWare.builder()</span><br><span class="line">                .serviceName(serviceName)</span><br><span class="line">                .methodName(resource.getMethodName())</span><br><span class="line">                .method(methodTarget)</span><br><span class="line">                .methodParamsClass(methodParamClasssTarget)</span><br><span class="line">                .proxy(proxy)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> cacheWare;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">initProxy</span><span class="params">(Class&lt;?&gt; interfaceClass,</span></span></span><br><span class="line"><span class="params"><span class="function">                            String loadbalance,</span></span></span><br><span class="line"><span class="params"><span class="function">                            String version,</span></span></span><br><span class="line"><span class="params"><span class="function">                            Integer timeout,</span></span></span><br><span class="line"><span class="params"><span class="function">                            Integer retries)</span> </span>&#123;</span><br><span class="line">        ReferenceConfig&lt;Object&gt; reference = <span class="keyword">new</span> ReferenceConfig&lt;Object&gt;();</span><br><span class="line">        reference.setApplication(applicationConfig);</span><br><span class="line">        reference.setRegistry(registryConfig);</span><br><span class="line">        reference.setLoadbalance(EmptyUtil.isNullOrEmpty(loadbalance)?<span class="string">&quot;random&quot;</span>:loadbalance);</span><br><span class="line">        reference.setInterface(interfaceClass);</span><br><span class="line">        reference.setVersion(version);</span><br><span class="line">        reference.setTimeout(EmptyUtil.isNullOrEmpty(timeout)?<span class="number">20000</span>:timeout);</span><br><span class="line">        reference.setCheck(<span class="keyword">false</span>);</span><br><span class="line">        reference.setRetries(EmptyUtil.isNullOrEmpty(retries)?<span class="number">0</span>:retries);</span><br><span class="line">        ReferenceConfigCache cache = ReferenceConfigCache.getCache();</span><br><span class="line">        <span class="keyword">return</span> cache.get(reference);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destoryCacheWare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        executor.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="网关资源解析"><a href="#网关资源解析" class="headerlink" title="网关资源解析"></a>网关资源解析</h5><p>其主要负责：</p>
<p>1、传入参数处理</p>
<p>2、获得可执行缓存仓库</p>
<p>3、执行远程服务</p>
<p>4、处理返回结果</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.base.BaseRequest;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.cache.CacheWareService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.constant.GateWayConstant;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.pojo.CacheWare;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.response.MultiResponse;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.response.PageResponse;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.response.SingleResponse;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.utils.EmptyUtil;</span><br><span class="line"><span class="keyword">import</span> com.itheima.shiro.view.JsonResult;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.PathParam;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>：网关统一入口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GateWayController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CacheWareService cacheWareService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;&#123;serviceName&#125;/&#123;methodName&#125;&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonResult <span class="title">postGateWay</span><span class="params">(<span class="meta">@PathVariable(&quot;serviceName&quot;)</span> String serviceName,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="meta">@PathVariable(&quot;methodName&quot;)</span> String methodName,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="meta">@RequestBody</span> BaseRequest baseRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Object datas = baseRequest.getDatas();</span><br><span class="line">        JsonResult jsonResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (EmptyUtil.isNullOrEmpty(serviceName)||EmptyUtil.isNullOrEmpty(methodName))&#123;</span><br><span class="line">            jsonResult = JsonResult.builder()</span><br><span class="line">                    .result(GateWayConstant.FAIL)</span><br><span class="line">                    .msg(<span class="string">&quot;参数缺失&quot;</span>)</span><br><span class="line">                    .code(GateWayConstant.PARAMETERS_MISSING)</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="keyword">return</span> jsonResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//1、传入参数处理</span></span><br><span class="line">        JSONObject datasJson = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!EmptyUtil.isNullOrEmpty(datas))&#123;</span><br><span class="line">            datasJson = JSONObject.parseObject(JSONObject.toJSONString(datas));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2、获得可执行缓存仓库可执行对象</span></span><br><span class="line">        CacheWare cacheWare = cacheWareService.queryCacheWare(serviceName, methodName);</span><br><span class="line">        <span class="keyword">if</span> (EmptyUtil.isNullOrEmpty(serviceName)||EmptyUtil.isNullOrEmpty(methodName))&#123;</span><br><span class="line">            jsonResult = JsonResult.builder()</span><br><span class="line">                    .result(GateWayConstant.FAIL)</span><br><span class="line">                    .msg(<span class="string">&quot;请求链接异常&quot;</span>)</span><br><span class="line">                    .code(GateWayConstant.URL_MISSING)</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="keyword">return</span> jsonResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3、执行远程服务</span></span><br><span class="line">        Object proxy = cacheWare.getProxy();</span><br><span class="line">        Method method = cacheWare.getMethod();</span><br><span class="line">        Class&lt;?&gt; methodParamsClass = cacheWare.getMethodParamsClass();</span><br><span class="line">        Object result;</span><br><span class="line">        <span class="keyword">if</span> (EmptyUtil.isNullOrEmpty(methodParamsClass))&#123;</span><br><span class="line">            result = method.invoke(proxy);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            Object arguments = JSONObject.toJavaObject(datasJson, methodParamsClass);</span><br><span class="line">            result = method.invoke(proxy,arguments);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4、处理返回结果</span></span><br><span class="line">        <span class="keyword">return</span> convResult(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 处理请求结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> JsonResult <span class="title">convResult</span><span class="params">(Object result)</span> </span>&#123;</span><br><span class="line">        JsonResult jsonResult = JsonResult.builder()</span><br><span class="line">                .result(GateWayConstant.SUCCEED)</span><br><span class="line">                .msg(<span class="string">&quot;相应正常&quot;</span>)</span><br><span class="line">                .code(GateWayConstant.SUCCEED_CODE)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">if</span> (EmptyUtil.isNullOrEmpty(result)) &#123;</span><br><span class="line">            jsonResult = JsonResult.builder()</span><br><span class="line">                    .result(GateWayConstant.FAIL)</span><br><span class="line">                    .msg(<span class="string">&quot;返回结果为空&quot;</span>)</span><br><span class="line">                    .code(GateWayConstant.RESULT_ISNULLOREMPTY)</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="keyword">return</span> jsonResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (result <span class="keyword">instanceof</span> SingleResponse) &#123;</span><br><span class="line">            BeanUtils.copyProperties(result, jsonResult);</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span></span><br><span class="line">            SingleResponse singleResponse = (SingleResponse) result;</span><br><span class="line">            jsonResult.setDatas(singleResponse.getValue());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result <span class="keyword">instanceof</span> MultiResponse) &#123;</span><br><span class="line">            BeanUtils.copyProperties(result, jsonResult);</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span></span><br><span class="line">            MultiResponse multiResponse = (MultiResponse) result;</span><br><span class="line">            jsonResult.setDatas(multiResponse.getValues());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result <span class="keyword">instanceof</span> PageResponse) &#123;</span><br><span class="line">            BeanUtils.copyProperties(result, jsonResult);</span><br><span class="line">            PageResponse pageResponse = (PageResponse)result;</span><br><span class="line">            jsonResult.setDatas( pageResponse.getValues());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            jsonResult = JsonResult.builder()</span><br><span class="line">                    .result(GateWayConstant.FAIL)</span><br><span class="line">                    .msg(<span class="string">&quot;返回结果格式不正确&quot;</span>)</span><br><span class="line">                    .code(GateWayConstant.RESULT_MISSING)</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="keyword">return</span> jsonResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jsonResult;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="shiro-mgt管理平台"><a href="#shiro-mgt管理平台" class="headerlink" title="shiro-mgt管理平台"></a>shiro-mgt管理平台</h3><h4 id="模块依赖关系-2"><a href="#模块依赖关系-2" class="headerlink" title="模块依赖关系"></a>模块依赖关系</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205855.png" alt="1582881763304"></p>
<h4 id="原理分析-6"><a href="#原理分析-6" class="headerlink" title="原理分析"></a>原理分析</h4><p>​        通过上面的模块依赖关系，我们可以看出，shiro-mgt管理平台也是依赖springboot-shiro-framework-client项目实现权限的校验，而他本身主要是负责对角色、资源、用户、过滤器链的CRUD，来实现各个网关平台的权限控制。</p>
<p>资源：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205901.png" alt="1582704703769"></p>
<p>1、定义了网关systemcode，用以区分不同网关、系统</p>
<p>2、定义了访问的路径</p>
<p>3、定义了资源的唯一标识，作为过滤器过滤的标记</p>
<p>4、定义dubbo服务端接口的解析、同时为每个服务定义：轮训算法、超时时间、重试次数等参数，这些参数会在shiro-gateway中解析</p>
<p>角色：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205845.png" alt="1582704738045"></p>
<p>1、定义角色的唯一标识，作为过滤器过滤的标记</p>
<p>2、为角色定义多个资源</p>
<p>用户：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205841.png" alt="1582704772681"></p>
<p>1、用户基本信息</p>
<p>2、为用户定义多个角色</p>
<p>过滤器链：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210702205838.png" alt="1582704833744"></p>
<p>1、为所有系统定义统一的过滤器链路管理（可以扩展：按资源类型那样为每个网关系统定义过滤器链）</p>
<p>2、保证过滤器器链的有序性</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">小肥龙吃大冰淇淋</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://lvxueyang.vip/post/f46cf4b5.html">http://lvxueyang.vip/post/f46cf4b5.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://lvxueyang.vip" target="_blank">小肥龙吃大冰淇淋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Shiro/">Shiro</a></div><div class="post_share"><div class="social-share" data-image="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210806165213.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/9f6dbf88.html"><img class="prev-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210806165214.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">编码和解码</div></div></a></div><div class="next-post pull-right"><a href="/post/65b69107.html"><img class="next-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210806165212.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Nginx</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">权限概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%9D%83%E9%99%90"><span class="toc-number">1.1.</span> <span class="toc-text">什么是权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.</span> <span class="toc-text">认证概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%AE%A4%E8%AF%81"><span class="toc-number">1.2.1.</span> <span class="toc-text">什么是认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">认证流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.2.3.</span> <span class="toc-text">关键对象</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.</span> <span class="toc-text">授权概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%8E%88%E6%9D%83"><span class="toc-number">1.3.1.</span> <span class="toc-text">什么是授权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.2.</span> <span class="toc-text">授权流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E5%AF%B9%E8%B1%A1-1"><span class="toc-number">1.3.3.</span> <span class="toc-text">关键对象</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shiro%E6%A6%82%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">Shiro概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Shiro%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.</span> <span class="toc-text">Shiro简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFShiro"><span class="toc-number">2.1.1.</span> <span class="toc-text">什么是Shiro?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Shiro-%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-number">2.1.2.</span> <span class="toc-text">Shiro 的特点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="toc-number">2.2.</span> <span class="toc-text">核心组件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shiro%E5%85%A5%E9%97%A8"><span class="toc-number">3.</span> <span class="toc-text">Shiro入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81"><span class="toc-number">3.1.</span> <span class="toc-text">身份认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.1.</span> <span class="toc-text">基本流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA"><span class="toc-number">3.1.2.</span> <span class="toc-text">案例演示</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%82"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">需求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">3.1.2.2.1.</span> <span class="toc-text">新建项目</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">3.1.2.2.2.</span> <span class="toc-text">导入依赖</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%96%E5%86%99shiro-ini"><span class="toc-number">3.1.2.2.3.</span> <span class="toc-text">编写shiro.ini</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%96%E5%86%99HelloShiro"><span class="toc-number">3.1.2.2.4.</span> <span class="toc-text">编写HelloShiro</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">3.1.2.2.5.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">3.1.2.3.</span> <span class="toc-text">小结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Realm"><span class="toc-number">3.2.</span> <span class="toc-text">Realm</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Realm%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.2.1.</span> <span class="toc-text">Realm接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Realm"><span class="toc-number">3.2.2.</span> <span class="toc-text">自定义Realm</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%82-1"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">需求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">3.2.2.2.1.</span> <span class="toc-text">创建项目</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89SecurityService"><span class="toc-number">3.2.2.2.2.</span> <span class="toc-text">定义SecurityService</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89DefinitionRealm"><span class="toc-number">3.2.2.2.3.</span> <span class="toc-text">定义DefinitionRealm</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%96%E8%BE%91shiro-ini"><span class="toc-number">3.2.2.2.4.</span> <span class="toc-text">编辑shiro.ini</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%BA%90%E7%A0%81%E8%B7%9F%E8%B8%AA"><span class="toc-number">3.2.3.</span> <span class="toc-text">认证源码跟踪</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E3%80%81%E6%95%A3%E5%88%97%E7%AE%97%E6%B3%95"><span class="toc-number">3.3.</span> <span class="toc-text">编码、散列算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E4%B8%8E%E8%A7%A3%E7%A0%81"><span class="toc-number">3.3.1.</span> <span class="toc-text">编码与解码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%82-2"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">需求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE-1"><span class="toc-number">3.3.1.2.</span> <span class="toc-text">新建项目</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAEncodesUtil"><span class="toc-number">3.3.1.3.</span> <span class="toc-text">新建EncodesUtil</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAClientTest"><span class="toc-number">3.3.1.4.</span> <span class="toc-text">新建ClientTest</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="toc-number">3.3.1.5.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%A3%E5%88%97%E7%AE%97%E6%B3%95"><span class="toc-number">3.3.2.</span> <span class="toc-text">散列算法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%A2%9EDigestsUtil"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">新增DigestsUtil</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%A2%9EClientTest"><span class="toc-number">3.3.2.2.</span> <span class="toc-text">新增ClientTest</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Realm%E4%BD%BF%E7%94%A8%E6%95%A3%E5%88%97%E7%AE%97%E6%B3%95"><span class="toc-number">3.4.</span> <span class="toc-text">Realm使用散列算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE-2"><span class="toc-number">3.4.1.</span> <span class="toc-text">新建项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AF%86%E6%96%87%E5%AF%86%E7%A0%81"><span class="toc-number">3.4.2.</span> <span class="toc-text">创建密文密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9SecurityService"><span class="toc-number">3.4.3.</span> <span class="toc-text">修改SecurityService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%AF%86%E7%A0%81%E5%8C%B9%E9%85%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">3.4.4.</span> <span class="toc-text">指定密码匹配方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="toc-number">3.4.5.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BA%AB%E4%BB%BD%E6%8E%88%E6%9D%83"><span class="toc-number">3.5.</span> <span class="toc-text">身份授权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B-1"><span class="toc-number">3.5.1.</span> <span class="toc-text">基本流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA-1"><span class="toc-number">3.5.2.</span> <span class="toc-text">案例演示</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%82-3"><span class="toc-number">3.5.2.1.</span> <span class="toc-text">需求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">3.5.2.2.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE-1"><span class="toc-number">3.5.2.2.1.</span> <span class="toc-text">创建项目</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%96%E5%86%99SecurityService"><span class="toc-number">3.5.2.2.2.</span> <span class="toc-text">编写SecurityService</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%96%E5%86%99DefinitionRealm"><span class="toc-number">3.5.2.2.3.</span> <span class="toc-text">编写DefinitionRealm</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%96%E5%86%99HelloShiro-1"><span class="toc-number">3.5.2.2.4.</span> <span class="toc-text">编写HelloShiro</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E6%BA%90%E7%A0%81%E8%BF%BD%E8%B8%AA"><span class="toc-number">3.5.2.3.</span> <span class="toc-text">授权源码追踪</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-2"><span class="toc-number">3.5.3.</span> <span class="toc-text">小结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web%E9%A1%B9%E7%9B%AE%E9%9B%86%E6%88%90Shiro"><span class="toc-number">4.</span> <span class="toc-text">Web项目集成Shiro</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Web%E9%9B%86%E6%88%90%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">4.1.</span> <span class="toc-text">Web集成原理分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#web%E9%9B%86%E6%88%90%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.1.</span> <span class="toc-text">web集成的配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE-3"><span class="toc-number">4.1.1.1.</span> <span class="toc-text">新建项目</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#pom-xml%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.1.2.</span> <span class="toc-text">pom.xml配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#web-xml%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.1.3.</span> <span class="toc-text">web.xml配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SecurityManager%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA"><span class="toc-number">4.1.2.</span> <span class="toc-text">SecurityManager对象创建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shiro%E9%BB%98%E8%AE%A4%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">4.2.</span> <span class="toc-text">Shiro默认过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E7%9B%B8%E5%85%B3"><span class="toc-number">4.2.1.</span> <span class="toc-text">认证相关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E7%9B%B8%E5%85%B3"><span class="toc-number">4.2.2.</span> <span class="toc-text">授权相关</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web%E9%9B%86%E6%88%90%E5%AE%8C%E6%95%B4%E6%A1%88%E4%BE%8B"><span class="toc-number">4.3.</span> <span class="toc-text">Web集成完整案例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99pom-xml"><span class="toc-number">4.3.1.</span> <span class="toc-text">编写pom.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99shiro-ini%E6%96%87%E4%BB%B6"><span class="toc-number">4.3.2.</span> <span class="toc-text">编写shiro.ini文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99LoginService"><span class="toc-number">4.3.3.</span> <span class="toc-text">编写LoginService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99SecurityServiceImpl"><span class="toc-number">4.3.4.</span> <span class="toc-text">编写SecurityServiceImpl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0web%E5%B1%82%E5%86%85%E5%AE%B9"><span class="toc-number">4.3.5.</span> <span class="toc-text">添加web层内容</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#LoginServlet"><span class="toc-number">4.3.5.1.</span> <span class="toc-text">LoginServlet</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#HomeServlet"><span class="toc-number">4.3.5.2.</span> <span class="toc-text">HomeServlet</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#OrderAddServlet"><span class="toc-number">4.3.5.3.</span> <span class="toc-text">OrderAddServlet</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#OrderListServlet"><span class="toc-number">4.3.5.4.</span> <span class="toc-text">OrderListServlet</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#LogoutServlet"><span class="toc-number">4.3.5.5.</span> <span class="toc-text">LogoutServlet</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0JSP"><span class="toc-number">4.3.6.</span> <span class="toc-text">添加JSP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-2"><span class="toc-number">4.3.7.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8"><span class="toc-number">4.3.7.1.</span> <span class="toc-text">启动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E8%BF%87%E6%BB%A4"><span class="toc-number">4.3.7.2.</span> <span class="toc-text">登录过滤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%92%E8%89%B2%E8%BF%87%E6%BB%A4"><span class="toc-number">4.3.7.3.</span> <span class="toc-text">角色过滤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E8%BF%87%E6%BB%A4"><span class="toc-number">4.3.7.4.</span> <span class="toc-text">资源过滤</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#web%E9%A1%B9%E7%9B%AE%E6%8E%88%E6%9D%83"><span class="toc-number">4.4.</span> <span class="toc-text">web项目授权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E4%BB%A3%E7%A0%81"><span class="toc-number">4.4.1.</span> <span class="toc-text">基于代码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E7%9B%B8%E5%85%B3"><span class="toc-number">4.4.1.1.</span> <span class="toc-text">登录相关</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%92%E8%89%B2%E7%9B%B8%E5%85%B3"><span class="toc-number">4.4.1.2.</span> <span class="toc-text">角色相关</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%9B%B8%E5%85%B3"><span class="toc-number">4.4.1.3.</span> <span class="toc-text">资源相关</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">4.4.1.4.</span> <span class="toc-text">案例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE-2"><span class="toc-number">4.4.1.4.1.</span> <span class="toc-text">创建项目</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9shiro-ini"><span class="toc-number">4.4.1.4.2.</span> <span class="toc-text">修改shiro.ini</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E7%9B%B8%E5%85%B3-1"><span class="toc-number">4.4.1.4.3.</span> <span class="toc-text">登录相关</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%A7%92%E8%89%B2%E7%9B%B8%E5%85%B3-1"><span class="toc-number">4.4.1.4.4.</span> <span class="toc-text">角色相关</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%9B%B8%E5%85%B3-1"><span class="toc-number">4.4.1.4.5.</span> <span class="toc-text">资源相关</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EJsp%E6%A0%87%E7%AD%BE"><span class="toc-number">4.4.2.</span> <span class="toc-text">基于Jsp标签</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">4.4.2.1.</span> <span class="toc-text">使用方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%A0%87%E7%AD%BE"><span class="toc-number">4.4.2.2.</span> <span class="toc-text">相关标签</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B-1"><span class="toc-number">4.4.2.3.</span> <span class="toc-text">案例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE-4"><span class="toc-number">4.4.2.3.1.</span> <span class="toc-text">新建项目</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9home-jsp"><span class="toc-number">4.4.2.3.2.</span> <span class="toc-text">修改home.jsp</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-3"><span class="toc-number">4.4.2.3.3.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Springboot%E9%9B%86%E6%88%90Shiro"><span class="toc-number">5.</span> <span class="toc-text">Springboot集成Shiro</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="toc-number">5.1.</span> <span class="toc-text">技术栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.2.</span> <span class="toc-text">数据库设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9B%BE%E8%A7%A3"><span class="toc-number">5.2.1.</span> <span class="toc-text">数据库图解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%84%9A%E6%9C%AC"><span class="toc-number">5.2.2.</span> <span class="toc-text">数据库脚本</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%AA%A8%E6%9E%B6"><span class="toc-number">5.3.</span> <span class="toc-text">项目骨架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ShiroDbRealm%E5%AE%9A%E4%B9%89"><span class="toc-number">5.4.</span> <span class="toc-text">ShiroDbRealm定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%BE%E8%A7%A3"><span class="toc-number">5.4.1.</span> <span class="toc-text">图解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">5.4.2.</span> <span class="toc-text">原理分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%B1%BB%E4%BB%A3%E7%A0%81"><span class="toc-number">5.4.3.</span> <span class="toc-text">核心类代码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ShiroDbRealm"><span class="toc-number">5.4.3.1.</span> <span class="toc-text">ShiroDbRealm</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ShiroDbRealmImpl"><span class="toc-number">5.4.3.2.</span> <span class="toc-text">ShiroDbRealmImpl</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SimpleToken"><span class="toc-number">5.4.3.3.</span> <span class="toc-text">SimpleToken</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ShiroUser"><span class="toc-number">5.4.3.4.</span> <span class="toc-text">ShiroUser</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#UserBridgeService"><span class="toc-number">5.4.3.5.</span> <span class="toc-text">UserBridgeService</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#UserBridgeServiceImpl"><span class="toc-number">5.4.3.6.</span> <span class="toc-text">UserBridgeServiceImpl</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#UserAdapter"><span class="toc-number">5.4.3.7.</span> <span class="toc-text">UserAdapter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#UserAdapterImpl"><span class="toc-number">5.4.3.8.</span> <span class="toc-text">UserAdapterImpl</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ShiroConfig%E9%85%8D%E7%BD%AE"><span class="toc-number">5.5.</span> <span class="toc-text">ShiroConfig配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%BE%E8%A7%A3-1"><span class="toc-number">5.5.1.</span> <span class="toc-text">图解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-1"><span class="toc-number">5.5.2.</span> <span class="toc-text">原理分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ShiroConfig%E4%BB%A3%E7%A0%81"><span class="toc-number">5.5.3.</span> <span class="toc-text">ShiroConfig代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shiro%E8%BF%87%E6%BB%A4%E5%99%A8%E3%80%81%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE"><span class="toc-number">5.6.</span> <span class="toc-text">Shiro过滤器、过滤器链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">5.6.1.</span> <span class="toc-text">过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE"><span class="toc-number">5.6.2.</span> <span class="toc-text">过滤器链</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">5.6.3.</span> <span class="toc-text">加载原理分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">5.6.4.</span> <span class="toc-text">自定义过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%87%E6%BB%A4%E5%99%A8%E4%BD%BF%E7%94%A8"><span class="toc-number">5.6.5.</span> <span class="toc-text">自定义过滤器使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%82-4"><span class="toc-number">5.6.5.1.</span> <span class="toc-text">需求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RolesOrAuthorizationFilter"><span class="toc-number">5.6.5.2.</span> <span class="toc-text">RolesOrAuthorizationFilter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E8%BE%91ShiroConfig"><span class="toc-number">5.6.5.3.</span> <span class="toc-text">编辑ShiroConfig</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E8%BE%91authentication-properties"><span class="toc-number">5.6.5.4.</span> <span class="toc-text">编辑authentication.properties</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F%E9%89%B4%E6%9D%83"><span class="toc-number">5.7.</span> <span class="toc-text">注解方式鉴权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.7.1.</span> <span class="toc-text">注解介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">5.7.2.</span> <span class="toc-text">注解原理分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A3%85%E8%BD%BD%E8%BF%87%E7%A8%8B"><span class="toc-number">5.7.3.</span> <span class="toc-text">装载过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">5.7.4.</span> <span class="toc-text">调用过程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Realm%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="toc-number">6.</span> <span class="toc-text">Realm缓存机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Realm%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%E6%84%8F%E4%B9%89"><span class="toc-number">6.1.</span> <span class="toc-text">Realm缓存机制意义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Realm%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">6.2.</span> <span class="toc-text">Realm缓存机制实现思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%E5%9B%BE%E8%A7%A3"><span class="toc-number">6.2.1.</span> <span class="toc-text">缓存机制图解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-2"><span class="toc-number">6.2.2.</span> <span class="toc-text">原理分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redission%E9%9B%86%E6%88%90"><span class="toc-number">6.3.</span> <span class="toc-text">redission集成</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0ShiroRedisProperties"><span class="toc-number">6.3.1.</span> <span class="toc-text">添加ShiroRedisProperties</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%BE%91ShiroConfig-1"><span class="toc-number">6.3.2.</span> <span class="toc-text">编辑ShiroConfig</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%AF%B9%E8%B1%A1SimpleMapCache"><span class="toc-number">6.4.</span> <span class="toc-text">缓存对象SimpleMapCache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ShiroRedissionSerialize%E5%BA%8F%E5%88%97%E5%8C%96%E5%B7%A5%E5%85%B7"><span class="toc-number">6.5.</span> <span class="toc-text">ShiroRedissionSerialize序列化工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3SimpleCacheService"><span class="toc-number">6.6.</span> <span class="toc-text">缓存服务接口SimpleCacheService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%A5%E6%8E%A5%E5%99%A8BridgeService"><span class="toc-number">6.7.</span> <span class="toc-text">桥接器BridgeService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-4"><span class="toc-number">6.8.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%9A%84%E6%B8%85%E7%90%86"><span class="toc-number">6.9.</span> <span class="toc-text">缓存的清理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E4%BC%9A%E8%AF%9DSessionManager"><span class="toc-number">7.</span> <span class="toc-text">实现分布式会话SessionManager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">7.1.</span> <span class="toc-text">会话的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BC%9A%E8%AF%9D%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">7.2.</span> <span class="toc-text">分布式会话实现思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-3"><span class="toc-number">7.2.1.</span> <span class="toc-text">原理分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E7%B1%BB%E5%9B%BE%E8%AF%A6%E8%A7%A3"><span class="toc-number">7.2.2.</span> <span class="toc-text">设计类图详解</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RedisSessionDao"><span class="toc-number">7.3.</span> <span class="toc-text">RedisSessionDao</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%86%99ShiroConfig"><span class="toc-number">7.4.</span> <span class="toc-text">重写ShiroConfig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-5"><span class="toc-number">7.5.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E5%AF%86%E7%A0%81%E9%87%8D%E8%AF%95%E6%AC%A1%E6%95%B0"><span class="toc-number">8.</span> <span class="toc-text">限制密码重试次数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">8.1.</span> <span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AF%86%E7%A0%81%E6%AF%94%E8%BE%83%E5%99%A8"><span class="toc-number">8.2.</span> <span class="toc-text">自定义密码比较器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RetryLimitCredentialsMatcher"><span class="toc-number">8.2.1.</span> <span class="toc-text">RetryLimitCredentialsMatcher</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E5%86%99ShiroDbRealmImpl"><span class="toc-number">8.2.2.</span> <span class="toc-text">重写ShiroDbRealmImpl</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-6"><span class="toc-number">8.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E7%BA%BF%E5%B9%B6%E5%8F%91%E7%99%BB%E5%BD%95%E4%BA%BA%E6%95%B0%E6%8E%A7%E5%88%B6"><span class="toc-number">9.</span> <span class="toc-text">在线并发登录人数控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-1"><span class="toc-number">9.1.</span> <span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">9.2.</span> <span class="toc-text">代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#KickedOutAuthorizationFilter"><span class="toc-number">9.2.1.</span> <span class="toc-text">KickedOutAuthorizationFilter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9ShiroConfig"><span class="toc-number">9.2.2.</span> <span class="toc-text">修改ShiroConfig</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9authentication-properties"><span class="toc-number">9.2.3.</span> <span class="toc-text">修改authentication.properties</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-7"><span class="toc-number">9.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Springboot-Shiro-Jwt%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%89%B4%E6%9D%83"><span class="toc-number">10.</span> <span class="toc-text">Springboot+Shiro+Jwt前后端分离鉴权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E4%BC%9A%E8%AF%9D%E9%97%AE%E9%A2%98"><span class="toc-number">10.1.</span> <span class="toc-text">前后端分离会话问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%BF%BD%E8%B8%AA"><span class="toc-number">10.1.1.</span> <span class="toc-text">问题追踪</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">10.1.2.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT%E6%A6%82%E8%BF%B0"><span class="toc-number">10.2.</span> <span class="toc-text">JWT概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90JWT"><span class="toc-number">10.3.</span> <span class="toc-text">集成JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JwtProperties"><span class="toc-number">10.3.1.</span> <span class="toc-text">JwtProperties</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JwtTokenManager"><span class="toc-number">10.3.2.</span> <span class="toc-text">JwtTokenManager</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%86%99DefaultWebSessionManager"><span class="toc-number">10.4.</span> <span class="toc-text">重写DefaultWebSessionManager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%86%99%E9%BB%98%E8%AE%A4%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">10.5.</span> <span class="toc-text">重写默认过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JwtAuthcFilter"><span class="toc-number">10.5.1.</span> <span class="toc-text">JwtAuthcFilter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JwtPermsFilter"><span class="toc-number">10.5.2.</span> <span class="toc-text">JwtPermsFilter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JwtRolesFilter"><span class="toc-number">10.5.3.</span> <span class="toc-text">JwtRolesFilter</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%86%99ShiroConfig-1"><span class="toc-number">10.6.</span> <span class="toc-text">重写ShiroConfig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81"><span class="toc-number">10.7.</span> <span class="toc-text">业务代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LoginAction"><span class="toc-number">10.7.1.</span> <span class="toc-text">LoginAction</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LoginService"><span class="toc-number">10.7.2.</span> <span class="toc-text">LoginService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LoginServiceImpl"><span class="toc-number">10.7.3.</span> <span class="toc-text">LoginServiceImpl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#authentication-properties"><span class="toc-number">10.7.4.</span> <span class="toc-text">authentication.properties</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-8"><span class="toc-number">10.8.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%BB%9F%E4%B8%80%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F"><span class="toc-number">11.</span> <span class="toc-text">分布式统一权限系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E9%9C%80%E6%B1%82"><span class="toc-number">11.1.</span> <span class="toc-text">系统需求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB"><span class="toc-number">11.1.1.</span> <span class="toc-text">前后端分离</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E4%B8%AD%E5%BC%8F%E4%BC%9A%E8%AF%9D"><span class="toc-number">11.1.2.</span> <span class="toc-text">集中式会话</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E4%B8%8E%E9%89%B4%E6%9D%83%E6%9C%8D%E5%8A%A1%E5%8C%96"><span class="toc-number">11.1.3.</span> <span class="toc-text">认证与鉴权服务化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE"><span class="toc-number">11.1.4.</span> <span class="toc-text">动态过滤器链</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">11.1.5.</span> <span class="toc-text">权限客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E5%B9%B3%E5%8F%B0"><span class="toc-number">11.1.6.</span> <span class="toc-text">网关平台</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">11.2.</span> <span class="toc-text">架构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C%E9%80%9A%E8%AE%AF"><span class="toc-number">11.2.1.</span> <span class="toc-text">系统网络通讯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB"><span class="toc-number">11.2.2.</span> <span class="toc-text">模块依赖关系</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#springboot-shiro-parent"><span class="toc-number">11.2.2.1.</span> <span class="toc-text">springboot-shiro-parent</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#springboot-shiro-gateway-handler"><span class="toc-number">11.2.2.2.</span> <span class="toc-text">springboot-shiro-gateway-handler</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#springboot-shiro-producer"><span class="toc-number">11.2.2.3.</span> <span class="toc-text">springboot-shiro-producer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#springboot-shiro-mgt"><span class="toc-number">11.2.2.4.</span> <span class="toc-text">springboot-shiro-mgt</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#springboot-shiro-dubbo-app-handler"><span class="toc-number">11.2.2.5.</span> <span class="toc-text">springboot-shiro-dubbo-app-handler</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E9%89%B4%E6%9D%83%E6%9C%8D%E5%8A%A1%E5%8C%96"><span class="toc-number">11.3.</span> <span class="toc-text">认证鉴权服务化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE-1"><span class="toc-number">11.4.</span> <span class="toc-text">动态过滤器链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">11.4.1.</span> <span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">11.4.2.</span> <span class="toc-text">代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E3%80%81%E6%9C%89%E5%BA%8F%E5%8C%96"><span class="toc-number">11.4.2.1.</span> <span class="toc-text">持久化、有序化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8C%96"><span class="toc-number">11.4.2.2.</span> <span class="toc-text">服务化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%80%A7"><span class="toc-number">11.4.2.3.</span> <span class="toc-text">同步性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%83%AD%E5%8A%A0%E8%BD%BD"><span class="toc-number">11.4.2.4.</span> <span class="toc-text">热加载</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#CustomDefaultFilterChainManager"><span class="toc-number">11.4.2.4.1.</span> <span class="toc-text">CustomDefaultFilterChainManager</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#CustomPathMatchingFilterChainResolver"><span class="toc-number">11.4.2.4.2.</span> <span class="toc-text">CustomPathMatchingFilterChainResolver</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#CustomShiroFilterFactoryBean"><span class="toc-number">11.4.2.4.3.</span> <span class="toc-text">CustomShiroFilterFactoryBean</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#ShiroConfig%E6%94%B9%E9%80%A0"><span class="toc-number">11.4.2.4.4.</span> <span class="toc-text">ShiroConfig改造</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shiro-client%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">11.5.</span> <span class="toc-text">shiro-client客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB-1"><span class="toc-number">11.5.1.</span> <span class="toc-text">模块依赖关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-4"><span class="toc-number">11.5.2.</span> <span class="toc-text">原理分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shiro-gateway%E7%BD%91%E5%85%B3"><span class="toc-number">11.6.</span> <span class="toc-text">shiro-gateway网关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-5"><span class="toc-number">11.6.1.</span> <span class="toc-text">原理分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">11.6.2.</span> <span class="toc-text">代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E8%B5%84%E6%BA%90%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">11.6.2.1.</span> <span class="toc-text">网关资源持久化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%8C%96"><span class="toc-number">11.6.2.2.</span> <span class="toc-text">网关资源服务化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%B6%88%E8%B4%B9%E7%AB%AF"><span class="toc-number">11.6.2.3.</span> <span class="toc-text">动态消费端</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#CacheWareService"><span class="toc-number">11.6.2.3.1.</span> <span class="toc-text">CacheWareService</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#CacheWareSyncService"><span class="toc-number">11.6.2.3.2.</span> <span class="toc-text">CacheWareSyncService</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E8%B5%84%E6%BA%90%E8%A7%A3%E6%9E%90"><span class="toc-number">11.6.2.4.</span> <span class="toc-text">网关资源解析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shiro-mgt%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0"><span class="toc-number">11.7.</span> <span class="toc-text">shiro-mgt管理平台</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB-2"><span class="toc-number">11.7.1.</span> <span class="toc-text">模块依赖关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-6"><span class="toc-number">11.7.2.</span> <span class="toc-text">原理分析</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 小肥龙吃大冰淇淋</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'pinglun-9gh2lmcnd8587831',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'pinglun-9gh2lmcnd8587831',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/hexo-theme-volantis@latest/source/js/issues.min.js"></script><script src="//code.tidio.co/smwivpnwumemac2wohardi3d3gpud1ag.js" async="async"></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>