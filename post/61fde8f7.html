<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ElasticSearch高级应用 | 小肥龙吃大冰淇淋</title><meta name="keywords" content="搜索引擎,Elasticsearch"><meta name="author" content="小肥龙吃大冰淇淋"><meta name="copyright" content="小肥龙吃大冰淇淋"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1. 映射高级1.1 地理坐标点数据类型 地理坐标点   地理坐标点是指地球表面可以用经纬度描述的一个点。 地理坐标点可以用来计算两个坐标间的距离，还可以判断一个坐标是否在一个区域中。地理坐标点需要显式声明对应字段类型为 geo_point ： PUT &#x2F;company-locations &amp;#123;   &quot;mappings&quot;: &amp;#123;    &quot;propert">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch高级应用">
<meta property="og:url" content="http://lvxueyang.vip/post/61fde8f7.html">
<meta property="og:site_name" content="小肥龙吃大冰淇淋">
<meta property="og:description" content="1. 映射高级1.1 地理坐标点数据类型 地理坐标点   地理坐标点是指地球表面可以用经纬度描述的一个点。 地理坐标点可以用来计算两个坐标间的距离，还可以判断一个坐标是否在一个区域中。地理坐标点需要显式声明对应字段类型为 geo_point ： PUT &#x2F;company-locations &amp;#123;   &quot;mappings&quot;: &amp;#123;    &quot;propert">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg">
<meta property="article:published_time" content="2024-05-30T01:10:36.218Z">
<meta property="article:modified_time" content="2022-11-27T09:16:31.159Z">
<meta property="article:author" content="小肥龙吃大冰淇淋">
<meta property="article:tag" content="搜索引擎">
<meta property="article:tag" content="Elasticsearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg"><link rel="shortcut icon" href="https://lvxueyangboke.oss-cn-beijing.aliyuncs.com/images/20210805191028.png"><link rel="canonical" href="http://lvxueyang.vip/post/61fde8f7"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ElasticSearch高级应用',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-27 17:16:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/ali_icon.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mogai.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="小肥龙吃大冰淇淋" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">303</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">108</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">73</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">小肥龙吃大冰淇淋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ElasticSearch高级应用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-30T01:10:36.218Z" title="发表于 2024-05-30 09:10:36">2024-05-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-27T09:16:31.159Z" title="更新于 2022-11-27 17:16:31">2022-11-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/">搜索引擎</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/Elasticsearch/">Elasticsearch</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">19.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>87分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ElasticSearch高级应用"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1-映射高级"><a href="#1-映射高级" class="headerlink" title="1. 映射高级"></a>1. 映射高级</h1><h2 id="1-1-地理坐标点数据类型"><a href="#1-1-地理坐标点数据类型" class="headerlink" title="1.1 地理坐标点数据类型"></a>1.1 地理坐标点数据类型</h2><ul>
<li>地理坐标点 </li>
</ul>
<p>地理坐标点是指地球表面可以用经纬度描述的一个点。 地理坐标点可以用来计算两个坐标间的距离，还可以判断一个坐标是否在一个区域中。地理坐标点需要显式声明对应字段类型为 geo_point ：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /company-locations </span><br><span class="line">&#123; </span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123; </span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123; </span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span> </span><br><span class="line">        </span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;location&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;geo_point&quot;</span> </span><br><span class="line">      &#125; </span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>经纬度坐标格式 </li>
</ul>
<p>如上例， location 字段被声明为 geo_point 后，我们就可以索引包含了经纬度信息的文档了。 经纬度信息的形式可以是字符串、数组或者对象</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"># 字符串形式</span><br><span class="line">PUT /company-locations/_doc/<span class="number">1</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;NetEase&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;location&quot;</span>:<span class="string">&quot;40.715,74.011&quot;</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 对象形式 </span><br><span class="line">PUT /company-locations/_doc/<span class="number">2</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;Sina&quot;</span>, </span><br><span class="line">  <span class="attr">&quot;location&quot;</span>:&#123; </span><br><span class="line">    <span class="attr">&quot;lat&quot;</span>:<span class="number">40.722</span>, </span><br><span class="line">    <span class="attr">&quot;lon&quot;</span>:<span class="number">73.989</span> </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 数组形式</span><br><span class="line">PUT /company-locations/_doc/<span class="number">3</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;Baidu&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;location&quot;</span>:[<span class="number">73.983</span>,<span class="number">40.719</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>**注意 **<br>字符串形式以半角逗号分割，如 “lat,lon” 。<br>对象形式显式命名为 lat 和 lon 。<br>数组形式表示为 [lon,lat] 。</p>
<ul>
<li>通过地理坐标点过滤 </li>
</ul>
<p>有四种地理坐标点相关的过滤器 可以用来选中或者排除文档。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201032147252.png" alt="image-20220103214758196"></p>
<ul>
<li>geo_bounding_box查询 </li>
</ul>
<p>这是目前为止最有效的地理坐标过滤器了，因为它计算起来非常简单。 你指定一个矩形的顶部 ,底部 , 左边界和右边界，然后过滤器只需判断坐标的经度是否在左右边界之间，纬度是否在上下边界之间<br>然后可以使用 geo_bounding_box 过滤器执行以下查询</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">GET /company-locations/_search</span><br><span class="line">&#123; </span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123; </span><br><span class="line">    <span class="attr">&quot;bool&quot;</span> : &#123; </span><br><span class="line">      <span class="attr">&quot;must&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;match_all&quot;</span> : &#123;&#125; </span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;geo_bounding_box&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;location&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;top_left&quot;</span> : &#123;</span><br><span class="line">              <span class="attr">&quot;lat&quot;</span> : <span class="number">40.73</span>,</span><br><span class="line">              <span class="attr">&quot;lon&quot;</span> : <span class="number">71.12</span></span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">&quot;bottom_right&quot;</span> : &#123; </span><br><span class="line">                <span class="attr">&quot;lat&quot;</span> : <span class="number">40.01</span>,</span><br><span class="line">                <span class="attr">&quot;lon&quot;</span> : <span class="number">74.1</span></span><br><span class="line">              &#125; </span><br><span class="line">          &#125; </span><br><span class="line">        &#125;</span><br><span class="line">      &#125; </span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> location这些坐标也可以用 bottom_left 和 top_right 来表示。</p>
<ul>
<li>geo_distance </li>
</ul>
<p>过滤仅包含与地理位置相距特定距离内的匹配的文档。假设以下映射和索引文档然后可以使用 geo_distance 过滤器执行以下查询。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /company-locations/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123; </span><br><span class="line">    <span class="attr">&quot;bool&quot;</span> : &#123; </span><br><span class="line">      <span class="attr">&quot;must&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;match_all&quot;</span> : &#123;&#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;geo_distance&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;distance&quot;</span> : <span class="string">&quot;200km&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;location&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;lat&quot;</span> : <span class="number">40</span>, </span><br><span class="line">            <span class="attr">&quot;lon&quot;</span> : <span class="number">70</span></span><br><span class="line">          &#125; </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-2-动态映射"><a href="#1-2-动态映射" class="headerlink" title="1.2 动态映射"></a>1.2 动态映射</h2><p>Elasticsearch在遇到文档中以前未遇到的字段，可以使用dynamic mapping（动态映射机制） 来确定字段的数据类型并自动把新的字段添加到类型映射。<br>Elastic的动态映射机制可以进行开关控制，通过设置mappings的dynamic属性，dynamic有如下设置项 。</p>
<ul>
<li>true：遇到陌生字段就执行dynamic mapping处理机制 。</li>
<li>false：遇到陌生字段就忽略。</li>
<li>strict：遇到陌生字段就报错。<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"># 设置为报错 </span><br><span class="line">PUT /user &#123; </span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>:&#123; </span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span>: <span class="number">0</span> </span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>:&#123; </span><br><span class="line">    <span class="attr">&quot;dynamic&quot;</span>: <span class="string">&quot;strict&quot;</span>, </span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123; </span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">      &#125;, <span class="attr">&quot;</span></span><br><span class="line"><span class="attr">      address&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;dynamic&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 插入以下文档，将会报错</span><br><span class="line"># user索引层设置dynamic是strict，在user层内设置age将报错</span><br><span class="line"># 在address层设置dynamic是ture，将动态映射生成字段 </span><br><span class="line">PUT /user/_doc/<span class="number">1</span> </span><br><span class="line">&#123; </span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;lisi&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;age&quot;</span>: <span class="string">&quot;20&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;address&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;province&quot;</span>: <span class="string">&quot;beijing&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;city&quot;</span>: <span class="string">&quot;beijing&quot;</span></span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /user</span><br><span class="line">&#123; </span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span>: <span class="number">0</span> </span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;dynamic&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123; </span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;<span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">      <span class="attr">&quot;address&quot;</span>: &#123;<span class="attr">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>, <span class="attr">&quot;dynamic&quot;</span>: <span class="literal">true</span>&#125;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-3-自定义动态映射"><a href="#1-3-自定义动态映射" class="headerlink" title="1.3 自定义动态映射"></a>1.3 自定义动态映射</h2>如果你想在运行时增加新的字段，你可能会启用动态映射。 然而，有时候，动态映射 规则 可能不太智能。幸运的是，我们可以通过设置去自定义这些规则，以便更好的适用于你的数据。</li>
</ul>
<p><strong>日期检测</strong><br>当 Elasticsearch 遇到一个新的字符串字段时，它会检测这个字段是否包含一个可识别的日期，比如 2014-01-01 如果它像日期，这个字段就会被作为 date 类型添加。否则，它会被作为 string 类型添加。 有些时候这个行为可能导致一些问题。想象下，你有如下这样的一个文档： <code>&#123; &quot;note&quot;: &quot;2014-01-01&quot; &#125;</code><br>假设这是第一次识别 note 字段，它会被添加为 date 字段。但是如果下一个文档像这样： <code>&#123; &quot;note&quot;: &quot;Logged out&quot; &#125; </code><br>这显然不是一个日期，但为时已晚。这个字段已经是一个日期类型，这个 不合法的日期 将会造成一个异常。<br>日期检测可以通过在根对象上设置 date_detection 为 false 来关闭 。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_index/_doc/<span class="number">1</span> </span><br><span class="line">&#123; </span><br><span class="line">  <span class="attr">&quot;note&quot;</span>: <span class="string">&quot;2014-01-01&quot;</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /my_index/_doc/<span class="number">1</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;note&quot;</span>: <span class="string">&quot;Logged out&quot;</span> </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">PUT /my_index </span><br><span class="line">&#123; </span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123; </span><br><span class="line">    <span class="attr">&quot;date_detection&quot;</span>: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用这个映射，字符串将始终作为 string 类型。如果需要一个 date 字段，必须手动添加。<br>Elasticsearch 判断字符串为日期的规则可以通过 dynamic_date_formats setting 来设置。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_index </span><br><span class="line">&#123; </span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;dynamic_date_formats&quot;</span>: <span class="string">&quot;MM/dd/yyyy&quot;</span> </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /my_index/_doc/<span class="number">1</span> </span><br><span class="line">&#123; </span><br><span class="line">  <span class="attr">&quot;note&quot;</span>: <span class="string">&quot;2014-01-01&quot;</span></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">PUT /my_index/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;note&quot;</span>: <span class="string">&quot;01/01/2014&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>**dynamic_templates **<br>    使用 dynamic_templates 可以完全控制新生成字段的映射，甚至可以通过字段名称或数据类型来应用不同的映射。每个模板都有一个名称，你可以用来描述这个模板的用途，一个 mapping 来指定映射应该怎样使用，以及至少一个参数 (如 match) 来定义这个模板适用于哪个字段。<br>模板按照顺序来检测；第一个匹配的模板会被启用。例如，我们给 string 类型字段定义两个模板：<br>es ：以 _es 结尾的字段名需要使用 spanish 分词器。<br>en ：所有其他字段使用 english 分词器。 </p>
<p>我们将 es 模板放在第一位，因为它比匹配所有字符串字段的 en 模板更特殊：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /my_index2 </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123; </span><br><span class="line">    <span class="attr">&quot;dynamic_templates&quot;</span>: [ </span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;es&quot;</span>: &#123; </span><br><span class="line">          <span class="attr">&quot;match&quot;</span>: <span class="string">&quot;*_es&quot;</span>, </span><br><span class="line">          <span class="attr">&quot;match_mapping_type&quot;</span>: <span class="string">&quot;string&quot;</span>, </span><br><span class="line">          <span class="attr">&quot;mapping&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;spanish&quot;</span> </span><br><span class="line">          &#125; </span><br><span class="line">        &#125; </span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;en&quot;</span>: &#123; </span><br><span class="line">          <span class="attr">&quot;match&quot;</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;match_mapping_type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;mapping&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;english&quot;</span> </span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1）匹配字段名以 _es 结尾的字段<br>2）匹配其他所有字符串类型字段 </p>
<ul>
<li><p>match_mapping_type 允许你应用模板到特定类型的字段上，就像有标准动态映射规则检测的一样 (例如 string 或 long) </p>
</li>
<li><p>match参数只匹配字段名称，path_match 参数匹配字段在对象上的完整路径，所以 address.*.name 将匹配这样的字段</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123; </span><br><span class="line">  <span class="attr">&quot;address&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;city&quot;</span>: &#123; </span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;New York&quot;</span></span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-Query-DSL"><a href="#2-Query-DSL" class="headerlink" title="2. Query DSL"></a>2. Query DSL</h1><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.3/query-dsl.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.3/query-dsl.html</a><br>Elasticsearch提供了基于JSON的完整查询DSL（Domain Specifific Language 特定域的语言）来定义查询。将查询DSL视为查询的AST（抽象语法树），它由两种子句组成：</p>
</li>
<li><p>叶子查询子句 </p>
</li>
</ul>
<p>叶子查询子句 在特定域中寻找特定的值，如 match，term或 range查询。 </p>
<ul>
<li>复合查询子句 </li>
</ul>
<p>复合查询子句包装其他叶子查询或复合查询，并用于以逻辑方式组合多个查询（例如 bool或 dis_max查询），或更改其行为（例如 constant_score查询）。 </p>
<p>我们在使用ElasticSearch的时候，避免不了使用DSL语句去查询，就像使用关系型数据库的时候要学会SQL语法一样。如果我们学习好了DSL语法的使用，那么在日后使用和使用Java Client调用时候也会变得非常简单。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /索引库名/_search</span><br><span class="line">&#123; </span><br><span class="line">  <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;查询类型&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;查询条件&quot;</span>:<span class="string">&quot;查询条件值&quot;</span></span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的query代表一个查询对象，里面可以有不同的查询属性 。</p>
<ul>
<li>查询类型： <ul>
<li>例如： match_all ， match ， term ， range 等等 。</li>
</ul>
</li>
<li>查询条件：查询条件会根据类型的不同，写法也有差异，后面详细讲解。</li>
</ul>
<h2 id="2-1-查询所有-match-all-query"><a href="#2-1-查询所有-match-all-query" class="headerlink" title="2.1 查询所有(match_all query)"></a>2.1 查询所有(match_all query)</h2><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /lagou-company-index/_search </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span>: &#123;&#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>query ：代表查询对象 </p>
</li>
<li><p>match_all ：代表查询所有</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;lagou-company-index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;百度&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;job&quot;</span> : <span class="string">&quot;小度用户运营经理&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;payment&quot;</span> : <span class="string">&quot;30000&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;logo&quot;</span> : <span class="string">&quot;http://www.lgstatic.com/thubnail_120x120/i/image/M00/21/3E/CgpFT1kVdzeAJNbU AABJB7x9sm8374.png&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果</p>
</li>
<li><p>took：查询花费时间，单位是毫秒 。</p>
</li>
<li><p>time_out：是否超时 。</p>
</li>
<li><p>_shards：分片信息 。</p>
</li>
<li><p>hits：搜索结果总览对象 。</p>
<ul>
<li>total：搜索到的总条数 。</li>
<li>max_score：所有结果中文档得分的最高分 。</li>
<li>hits：搜索结果的文档对象数组，每个元素是一条搜索到的文档信息。<ul>
<li>_index：索引库 </li>
<li>_type：文档类型 </li>
<li>_id：文档id </li>
<li>_score：文档得分 </li>
<li>_source：文档的源数据</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="2-2-全文搜索-full-text-query"><a href="#2-2-全文搜索-full-text-query" class="headerlink" title="2.2 全文搜索(full-text query)"></a>2.2 全文搜索(full-text query)</h2><p>全文搜索能够搜索已分析的文本字段，如电子邮件正文，商品描述等。使用索引期间应用于字段的同一分析器处理查询字符串。全文搜索的分类很多几个典型的如下:</p>
<h3 id="2-2-1-匹配搜索-match-query"><a href="#2-2-1-匹配搜索-match-query" class="headerlink" title="2.2.1 匹配搜索(match query)"></a>2.2.1 匹配搜索(match query)</h3><p>全文查询的标准查询，它可以对一个字段进行模糊、短语查询。 match queries 接收text/numerics/dates, 对它们进行分词分析, 再组织成一个boolean查询。可通过operator 指定bool组合操作（or、and 默认是 or ）。<br>现在，索引库中有2部手机，1台电视; </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /lagou-property </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123; </span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;images&quot;</span>: &#123; </span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span> </span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;float&quot;</span> </span><br><span class="line">      &#125; </span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /lagou-property/_doc/ </span><br><span class="line">&#123; </span><br><span class="line">  <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;小米电视4A&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;images&quot;</span>: <span class="string">&quot;http://image.lagou.com/12479122.jpg&quot;</span>, </span><br><span class="line">  <span class="attr">&quot;price&quot;</span>: <span class="number">4288</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /lagou-property/_doc/ </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;小米手机&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;images&quot;</span>: <span class="string">&quot;http://image.lagou.com/12479622.jpg&quot;</span>, </span><br><span class="line">  <span class="attr">&quot;price&quot;</span>: <span class="number">2699</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /lagou-property/_doc/ </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;华为手机&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;images&quot;</span>: <span class="string">&quot;http://image.lagou.com/12479922.jpg&quot;</span>, </span><br><span class="line">  <span class="attr">&quot;price&quot;</span>: <span class="number">5699</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>or关系 </li>
</ul>
<p>match 类型查询，会把查询条件进行分词，然后进行查询,多个词条之间是or的关系。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /lagou-property/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>:&#123; </span><br><span class="line">      <span class="attr">&quot;title&quot;</span>:<span class="string">&quot;小米电视4A&quot;</span></span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">51</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">2.8330114</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;lagou-property&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;UzLef3oBYYHsZaOa-I1O&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">2.8330114</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;title&quot;</span> : <span class="string">&quot;小米电视4A&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;images&quot;</span> : <span class="string">&quot;http://image.lagou.com/12479122.jpg&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;price&quot;</span> : <span class="number">4288</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;lagou-property&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;VDLff3oBYYHsZaOaAY2f&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">0.52354836</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;title&quot;</span> : <span class="string">&quot;小米手机&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;images&quot;</span> : <span class="string">&quot;http://image.lagou.com/12479622.jpg&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;price&quot;</span> : <span class="number">2699</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在上面的案例中，不仅会查询到电视，而且与小米相关的都会查询到，多个词之间是 or 的关系。 </p>
<ul>
<li>and关系 </li>
</ul>
<p>某些情况下，我们需要更精确查找，我们希望这个关系变成 and ，可以这样做：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /lagou-property/_search </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;小米电视4A&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span></span><br><span class="line">      &#125; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">2.8330114</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;lagou-property&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;UzLef3oBYYHsZaOa-I1O&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">2.8330114</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;title&quot;</span> : <span class="string">&quot;小米电视4A&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;images&quot;</span> : <span class="string">&quot;http://image.lagou.com/12479122.jpg&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;price&quot;</span> : <span class="number">4288</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>本例中，只有同时包含 小米 和 电视 的词条才会被搜索到<br>​</p>
<h3 id="2-2-2-短语搜索-match-phrase-query"><a href="#2-2-2-短语搜索-match-phrase-query" class="headerlink" title="2.2.2 短语搜索(match phrase query)"></a>2.2.2 短语搜索(match phrase query)</h3><p>match_phrase 查询用来对一个字段进行短语查询，可以指定 analyzer、slop移动因子</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">#可查询到数据</span><br><span class="line">GET /lagou-property/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;小米电视&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#查询不到数据</span><br><span class="line">GET /lagou-property/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;小米 4A&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#可查询到数据 加了移动因子 -&gt; 跨度</span><br><span class="line">GET /lagou-property/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;小米 4A&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;slop&quot;</span>: <span class="number">2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-3-query-string-查询"><a href="#2-2-3-query-string-查询" class="headerlink" title="2.2.3 query_string 查询"></a>2.2.3 query_string 查询</h3><p>   Query String: Query提供了无需指定某字段而对文档全文进行匹配查询的一个高级查询,同时可以指定在哪些字段上进行匹配。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"># 默认 和 指定字段 </span><br><span class="line">GET /lagou-property/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;2699&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /lagou-property/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;2699&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;default_field&quot;</span>: <span class="string">&quot;title&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 逻辑查询</span><br><span class="line">GET /lagou-property/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;手机 OR 小米&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;default_field&quot;</span>: <span class="string">&quot;title&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /lagou-property/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;手机 AND 小米&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;default_field&quot;</span>: <span class="string">&quot;title&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 模糊查询  ~<span class="number">1</span> 表示修正 修正一个字符  ~<span class="number">2</span>修正两个字符</span><br><span class="line">GET /lagou-property/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;大米~1&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;default_field&quot;</span>: <span class="string">&quot;title&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 多字段支持</span><br><span class="line">GET /lagou-property/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;2699&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fields&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;title&quot;</span>,</span><br><span class="line">        <span class="string">&quot;price&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-4-多字段匹配搜索-multi-match-query"><a href="#2-2-4-多字段匹配搜索-multi-match-query" class="headerlink" title="2.2.4 多字段匹配搜索(multi match query)"></a>2.2.4 多字段匹配搜索(multi match query)</h3><p>   如果你需要在多个字段上进行文本搜索，可用multi_match 。multi_match在 match的基础上支持对多个字段进行文本查询。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">GET /lagou-property/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;2699&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fields&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;title&quot;</span>,</span><br><span class="line">        <span class="string">&quot;price&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>还可以使用*匹配多个字段：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">GET /lagou-property/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;http://image.lagou.com/12479622.jpg&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fields&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;title&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ima*&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-词条级搜索-term-level-queries"><a href="#2-3-词条级搜索-term-level-queries" class="headerlink" title="2.3 词条级搜索(term-level queries)"></a>2.3 词条级搜索(term-level queries)</h2><p> 可以使用<strong>term-level queries</strong>根据结构化数据中的精确值查找文档。结构化数据的值包括日期范围、IP 地址、价格或产品ID。<br>与全文查询不同，term-level queries不分析搜索词。相反，词条与存储在字段级别中的术语完全匹配。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">PUT /book</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;float&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;timestamp&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /book/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;lucene&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Lucene Core is a Java library providing powerful indexing and search features, as well as spellchecking, hit highlighting and advanced analysis/tokenization capabilities. The PyLucene sub project provides Python bindings for Lucene Core. &quot;</span>,</span><br><span class="line">  <span class="attr">&quot;price&quot;</span>: <span class="number">100.45</span>,</span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2020-08-21 19:11:35&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /book/_doc/<span class="number">2</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;solr&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Solr is highly scalable, providing fully fault tolerant distributed indexing, search and analytics. It exposes Lucenes features through easy to use JSON/HTTP interfaces or native clients for Java and other languages.&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;price&quot;</span>: <span class="number">320.45</span>,</span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2020-07-21 17:11:35&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /book/_doc/<span class="number">3</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Hadoop&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;The Apache Hadoop software library is a framework that allows for the distributed processing of large data sets across clusters of computers using simple programming models.&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;price&quot;</span>: <span class="number">620.45</span>,</span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2020-08-22 19:18:35&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /book/_doc/<span class="number">4</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ElasticSearch&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Elasticsearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力 的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java语言开发的，并作为Apache许可条 款下的开放源码发布，是一种流行的企业级搜索引擎。Elasticsearch用于云计算中，能够达到实时搜 索，稳定，可靠，快速，安装使用方便。官方客户端在Java、.NET（C#）、PHP、Python、Apache Groovy、Ruby和许多其他语言中都是可用的。根据DB-Engines的排名显示，Elasticsearch是最受欢 迎的企业搜索引擎，其次是Apache Solr，也是基于Lucene。&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;price&quot;</span>: <span class="number">999.99</span>,</span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2020-08-15 10:11:35&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-1-词条搜索-term-query"><a href="#2-3-1-词条搜索-term-query" class="headerlink" title="2.3.1 词条搜索(term query)"></a>2.3.1 词条搜索(term query)</h3><p>term 查询用于查询指定字段包含某个词项的文档。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;solr&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-2-词条集合搜索-terms-query"><a href="#2-3-2-词条集合搜索-terms-query" class="headerlink" title="2.3.2 词条集合搜索(terms query)"></a>2.3.2 词条集合搜索(terms query)</h3><p>terms 查询用于查询指定字段包含某些词项的文档。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;solr&quot;</span>,</span><br><span class="line">        <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-3-范围搜索-range-query"><a href="#2-3-3-范围搜索-range-query" class="headerlink" title="2.3.3 范围搜索(range query)"></a>2.3.3 范围搜索(range query)</h3><ul>
<li>gte：大于等于 </li>
<li>gt：大于 </li>
<li>lte：小于等于 </li>
<li>lt：小于 </li>
<li>boost：查询权重<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;gte&quot;</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="attr">&quot;lte&quot;</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">&quot;boost&quot;</span>: <span class="number">2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#now<span class="number">-2</span>d  当前时间减<span class="number">2</span>天</span><br><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;timestamp&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;gte&quot;</span>: <span class="string">&quot;now-2d/d&quot;</span>, </span><br><span class="line">        <span class="attr">&quot;lt&quot;</span>: <span class="string">&quot;now/d&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;timestamp&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;gte&quot;</span>: <span class="string">&quot;18/08/2020&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;lte&quot;</span>: <span class="string">&quot;2021&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;dd/MM/yyyy||yyyy&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="2-3-4-不为空搜索-exists-query"><a href="#2-3-4-不为空搜索-exists-query" class="headerlink" title="2.3.4 不为空搜索(exists query)"></a>2.3.4 不为空搜索(exists query)</h3>查询指定字段值不为空的文档。相当 SQL 中的 column is not null。<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;exists&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-5-词项前缀搜索-prefifix-query"><a href="#2-3-5-词项前缀搜索-prefifix-query" class="headerlink" title="2.3.5 词项前缀搜索(prefifix query)"></a>2.3.5 词项前缀搜索(prefifix query)</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;prefix&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;so&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="2-3-6-通配符搜索-wildcard-query"><a href="#2-3-6-通配符搜索-wildcard-query" class="headerlink" title="2.3.6 通配符搜索(wildcard query)"></a>2.3.6 通配符搜索(wildcard query)</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;wildcard&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;so*r&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;wildcard&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;lu*&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;boost&quot;</span>: <span class="number">2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="2-3-7-正则搜索-regexp-query"><a href="#2-3-7-正则搜索-regexp-query" class="headerlink" title="2.3.7 正则搜索(regexp query)"></a>2.3.7 正则搜索(regexp query)</h3>regexp允许使用正则表达式进行term查询.注意regexp如果使用不正确，会给服务器带来很严重的性能压力。比如.*开头的查询，将会匹配所有的倒排索引中的关键字，这几乎相当于全表扫描，会很慢。因此如果可以的话，最好在使用正则前，加上匹配的前缀。<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;regexp&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;s.*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;regexp&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;s.*&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;boost&quot;</span>: <span class="number">1.2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-8-模糊搜索-fuzzy-query"><a href="#2-3-8-模糊搜索-fuzzy-query" class="headerlink" title="2.3.8 模糊搜索(fuzzy query)"></a>2.3.8 模糊搜索(fuzzy query)</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;fuzzy&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;so&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;fuzzy&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;so&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;boost&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;fuzziness&quot;</span>: <span class="number">2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#fuzziness 允许修正的字符数</span><br><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;fuzzy&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;sorl&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;boost&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;fuzziness&quot;</span>: <span class="number">2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-9-ids搜索-id集合查询"><a href="#2-3-9-ids搜索-id集合查询" class="headerlink" title="2.3.9 ids搜索(id集合查询)"></a>2.3.9 ids搜索(id集合查询)</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;ids&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;values&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;3&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-4-复合搜索-compound-query"><a href="#2-4-复合搜索-compound-query" class="headerlink" title="2.4 复合搜索(compound query)"></a>2.4 复合搜索(compound query)</h2></li>
</ul>
<ol>
<li>constant_score query<br>用来包装另一个查询，将查询匹配的文档的评分设为一个常值。<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;solr&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;constant_score&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;solr&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;boost&quot;</span>: <span class="number">1.2</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>布尔搜索(bool query)<br>bool 查询用bool操作来组合多个查询字句为一个查询。 可用的关键字： </li>
</ol>
<ul>
<li>must：必须满足 。</li>
<li>fifilter：必须满足，但执行的是fifilter上下文，不参与、不影响评分 。</li>
<li>should：或 。</li>
<li>must_not：必须不满足，在fifilter上下文中执行，不参与、不影响评分。<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;must&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;solr&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;must_not&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;gte&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;lte&quot;</span>: <span class="number">300</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;minimum_should_match&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;boost&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
minimum_should_match代表了最小匹配精度，如果设置minimum_should_match=1，那么should 语句中至少需要有一个条件满足。</li>
</ul>
<h2 id="2-5-排序"><a href="#2-5-排序" class="headerlink" title="2.5 排序"></a>2.5 排序</h2><ul>
<li>相关性评分排序 </li>
</ul>
<p>默认情况下，返回的结果是按照 相关性 进行排序的——最相关的文档排在最前。 在本章的后面部分，我们会解释 相关性 意味着什么以及它是如何计算的， 不过让我们首先看看 sort 参数以及如何使用它。<br>为了按照相关性来排序，需要将相关性表示为一个数值。在 Elasticsearch 中， 相关性得分由一个浮点数进行表示，并在搜索结果中通过 _score 参数返回， 默认排序是 _score 降序，按照相关性评分升序排序如下</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;solr&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;solr&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;_score&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;order&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>字段值排序</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>多级排序 </p>
</li>
</ul>
<p>假定我们想要结合使用 price和 _score（得分） 进行查询，并且匹配的结果首先按照价格排序， 然后按照相关性得分排序： </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;timestamp&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-6-分页"><a href="#2-6-分页" class="headerlink" title="2.6 分页"></a>2.6 分页</h2><p>Elasticsearch中实现分页的语法非常简单：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;from&quot;</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;from&quot;</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>size:每页显示多少条 。<br>from:当前页起始索引, int start = (pageNum - 1) * size。</p>
<h2 id="2-7-高亮"><a href="#2-7-高亮" class="headerlink" title="2.7 高亮"></a>2.7 高亮</h2><p>Elasticsearch中实现高亮的语法比较简单：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;pre_tags&quot;</span>: <span class="string">&quot;&lt;font color=&#x27;pink&#x27;&gt;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;post_tags&quot;</span>: <span class="string">&quot;&lt;/font&gt;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;fields&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: &#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;pre_tags&quot;</span>: <span class="string">&quot;&lt;font color=&#x27;pink&#x27;&gt;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;post_tags&quot;</span>: <span class="string">&quot;&lt;/font&gt;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;fields&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: &#123;&#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;description&quot;</span>: &#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;pre_tags&quot;</span>: <span class="string">&quot;&lt;font color=&#x27;pink&#x27;&gt;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;post_tags&quot;</span>: <span class="string">&quot;&lt;/font&gt;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;fields&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: &#123;&#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;description&quot;</span>: &#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在使用match查询的同时，加上一个highlight属性： </p>
<ul>
<li>pre_tags：前置标签 。</li>
<li>post_tags：后置标签 。</li>
<li>fifields：需要高亮的字段 。<ul>
<li>name：这里声明title字段需要高亮，后面可以为这个字段设置特有配置，也可以空。</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">8</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="number">1.6207945</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;book&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;4&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="number">1.6207945</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;ElasticSearch&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;Elasticsearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力 的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java语言开发的，并作为Apache许可条 款下的开放源码发布，是一种流行的企业级搜索引擎。Elasticsearch用于云计算中，能够达到实时搜 索，稳定，可靠，快速，安装使用方便。官方客户端在Java、.NET（C#）、PHP、Python、Apache Groovy、Ruby和许多其他语言中都是可用的。根据DB-Engines的排名显示，Elasticsearch是最受欢 迎的企业搜索引擎，其次是Apache Solr，也是基于Lucene。&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;price&quot;</span> : <span class="number">999.99</span>,</span><br><span class="line">          <span class="attr">&quot;timestamp&quot;</span> : <span class="string">&quot;2020-08-15 10:11:35&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;highlight&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span> : [</span><br><span class="line">            <span class="string">&quot;&lt;font color=&#x27;pink&#x27;&gt;ElasticSearch&lt;/font&gt;&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;description&quot;</span> : [</span><br><span class="line">            <span class="string">&quot;&lt;font color=&#x27;pink&#x27;&gt;Elasticsearch&lt;/font&gt;是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力 的全文搜索引擎，基于RESTful web接口。&quot;</span>,</span><br><span class="line">            <span class="string">&quot;&lt;font color=&#x27;pink&#x27;&gt;Elasticsearch&lt;/font&gt;是用Java语言开发的，并作为Apache许可条 款下的开放源码发布，是一种流行的企业级搜索引擎。&quot;</span>,</span><br><span class="line">            <span class="string">&quot;&lt;font color=&#x27;pink&#x27;&gt;Elasticsearch&lt;/font&gt;用于云计算中，能够达到实时搜 索，稳定，可靠，快速，安装使用方便。&quot;</span>,</span><br><span class="line">            <span class="string">&quot;根据DB-Engines的排名显示，&lt;font color=&#x27;pink&#x27;&gt;Elasticsearch&lt;/font&gt;是最受欢 迎的企业搜索引擎，其次是Apache Solr，也是基于Lucene。&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="2-8-文档批量操作（bulk-和-mget）"><a href="#2-8-文档批量操作（bulk-和-mget）" class="headerlink" title="2.8 文档批量操作（bulk 和 mget）"></a>2.8 文档批量操作（bulk 和 mget）</h2><p>**mget 批量查询 **<br>单条查询 GET /test_index/_doc/1，如果查询多个id的文档一条一条查询，网络开销太大。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">GET /_mget</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;docs&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;book&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_id&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;book&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_id&quot;</span>: <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">#! Elasticsearch built-in security features are not enabled. Without authentication, your cluster could be accessible to anyone. See https:<span class="comment">//www.elastic.co/guide/en/elasticsearch/reference/7.13/security-minimal-setup.html to enable security.</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;docs&quot;</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;book&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_version&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;found&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;lucene&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;Lucene Core is a Java library providing powerful indexing and search features, as well as spellchecking, hit highlighting and advanced analysis/tokenization capabilities. The PyLucene sub project provides Python bindings for Lucene Core. &quot;</span>,</span><br><span class="line">        <span class="attr">&quot;price&quot;</span> : <span class="number">100.45</span>,</span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span> : <span class="string">&quot;2020-08-21 19:11:35&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;book&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_version&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">5</span>,</span><br><span class="line">      <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;found&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;solr&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;Solr is highly scalable, providing fully fault tolerant distributed indexing, search and analytics. It exposes Lucenes features through easy to use JSON/HTTP interfaces or native clients for Java and other languages.&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;price&quot;</span> : <span class="number">320.45</span>,</span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span> : <span class="string">&quot;2020-07-21 17:11:35&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>同一索引下批量查询：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">GET /book/_mget</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;docs&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;_id&quot;</span>: <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;_id&quot;</span>: <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>搜索简化写法</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;ids&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;values&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;4&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>**bulk 批量增删改 **<br>Bulk 操作解释将文档的增删改查一些列操作，通过一次请求全都做完。减少网络传输次数。<br>语法：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123;<span class="attr">&quot;action&quot;</span>: &#123;<span class="attr">&quot;metadata&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;data&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>如下操作，删除1，新增5，修改2。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123; <span class="attr">&quot;delete&quot;</span>: &#123; <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;book&quot;</span>, <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">&quot;create&quot;</span>: &#123; <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;book&quot;</span>, <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;5&quot;</span> &#125;&#125; </span><br><span class="line">&#123; <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;test14&quot;</span>,<span class="attr">&quot;price&quot;</span>:<span class="number">100.99</span> &#125;</span><br><span class="line">&#123; <span class="attr">&quot;update&quot;</span>: &#123; <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;book&quot;</span>, <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;2&quot;</span>&#125; &#125; </span><br><span class="line">&#123; <span class="attr">&quot;doc&quot;</span> : &#123;<span class="attr">&quot;name&quot;</span> : <span class="string">&quot;test&quot;</span>&#125; &#125;</span><br></pre></td></tr></table></figure>
<p>功能： </p>
<ul>
<li>delete：删除一个文档，只要1个json串就可以了 删除的批量操作不需要请求体 。</li>
<li>create：相当于强制创建 PUT /index/type/id/_create 。</li>
<li>index：普通的put操作，可以是创建文档，也可以是全量替换文档。 </li>
<li>update：执行的是局部更新partial update操作 。</li>
</ul>
<p>格式：每个json不能换行。相邻json必须换行。<br>隔离：每个操作互不影响。操作失败的行会返回其失败信息。</p>
<p>实际用法：bulk请求一次不要太大，否则一下积压到内存中，性能会下降。所以，一次请求几千个操作、大小在几M正好。<br>bulk会将要处理的数据载入内存中，所以数据量是有限的，最佳的数据两不是一个确定的数据，它取决于你的硬件，你的文档大小以及复杂性，你的索引以及搜索的负载。<br>一般建议是1000-5000个文档，大小建议是5-15MB，默认不能超过100M，可以在es的配置文件（ES的<br>config下的elasticsearch.yml）中配置。<br><code>http.max_content_length: 10mb</code></p>
<h1 id="3-Filter-DSL"><a href="#3-Filter-DSL" class="headerlink" title="3. Filter DSL"></a>3. Filter DSL</h1><p>Elasticsearch中的所有的查询都会触发相关度得分的计算。对于那些我们不需要相关度得分的场景下，Elasticsearch以过滤器的形式提供了另一种查询功能，过滤器在概念上类似于查询，但是它们有非常快的执行速度，执行速度快主要有以下两个原因： </p>
<ul>
<li>过滤器不会计算相关度的得分，所以它们在计算上更快一些。 </li>
<li>过滤器可以被缓存到内存中，这使得在重复的搜索查询上，其要比相应的查询快出许多。 </li>
</ul>
<p>为了理解过滤器，可以将一个查询（像是match_all，match，bool等）和一个过滤器结合起来。我们以范围过滤器为例，它允许我们通过一个区间的值来过滤文档。这通常被用在数字和日期的过滤上。<br>下面这个例子使用一个被过滤的查询，其返回price值是在200到1000之间（闭区间）的书。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;filtered&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;gte&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;lte&quot;</span>: <span class="number">1000</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#<span class="number">5.0</span> 之后的写法</span><br><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;must&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;gte&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;lte&quot;</span>: <span class="number">1000</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>分解上面的例子，被过滤的查询包含一个match_all查询（查询部分）和一个过滤器（fifilter部分）。我们可以在查询部分中放入其他查询，在fifilter部分放入其它过滤器。在上面的应用场景中，由于所有的在这个范围之内的文档都是平等的（或者说相关度都是一样的），没有一个文档比另一个文档更相关，所以这个时候使用范围过滤器就非常合适了。通常情况下，要决定是使用过滤器还是使用查询，你就需要问自己是否需要相关度得分。如果相关度是不重要的，使用过滤器，否则使用查询。查询和过滤器在概念上类似于SELECT WHERE语句。</p>
<h1 id="4-定位非法搜索及原因"><a href="#4-定位非法搜索及原因" class="headerlink" title="4. 定位非法搜索及原因"></a>4. 定位非法搜索及原因</h1><p>在开发的时候，我们可能会写到上百行的查询语句，如果出错的话，找起来很麻烦，Elasticsearch提供了帮助开发人员定位不合法的查询的api _validate。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /book/_search?explain </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match1&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;test&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#使用 validate </span><br><span class="line">GET /book/_validate/query?explain </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match1&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;test&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>返回结果:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;valid&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;error&quot;</span> : <span class="string">&quot;ParsingException[unknown query [match1] did you mean any of [match, match_all]?]; nested: NamedObjectNotFoundException[[3:15] unknown field [match1]];; org.elasticsearch.common.xcontent.NamedObjectNotFoundException: [3:15] unknown field [match1]&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在查询时，不小心把 match 写成了 match1 ，通过 validate api 可以清楚的看到错误原因 。<br>正确查询返回。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;valid&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;explanations&quot;</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;index&quot;</span> : <span class="string">&quot;book&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;valid&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;explanation&quot;</span> : <span class="string">&quot;name:test&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="5-聚合分析"><a href="#5-聚合分析" class="headerlink" title="5. 聚合分析"></a>5. 聚合分析</h1><h2 id="5-1-聚合介绍"><a href="#5-1-聚合介绍" class="headerlink" title="5.1.聚合介绍"></a>5.1.聚合介绍</h2><p>聚合分析是数据库中重要的功能特性，完成对一个查询的数据集中数据的聚合计算，如：找出某字段（或计算表达式的结果）的最大值、最小值，计算和、平均值等。Elasticsearch作为搜索引擎兼数据库，同样提供了强大的聚合分析能力。<br>对一个数据集求最大、最小、和、平均值等指标的聚合，在ES中称为<strong>指标聚合 metric <strong>而关系型数据库中除了有聚合函数外，还可以对查询出的数据进行分组group by，再在组上进行指标聚合。在 ES 中group by 称为</strong>分桶</strong>，**桶聚合 bucketing **。<br><strong>Elasticsearch聚合分析语法</strong><br>在查询请求体中以aggregations节点按如下语法定义聚合分析： </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;aggregations&quot;</span> : &#123;</span><br><span class="line">  <span class="attr">&quot;&lt;aggregation_name&gt;&quot;</span> : &#123; &lt;!--聚合的名字 --&gt;</span><br><span class="line">                          <span class="attr">&quot;&lt;aggregation_type&gt;&quot;</span> : &#123; &lt;!--聚合的类型 --&gt;</span><br><span class="line">                          &lt;aggregation_body&gt; &lt;!--聚合体：对哪些字段进行聚合 --&gt; </span><br><span class="line">                         &#125;</span><br><span class="line">  [,<span class="string">&quot;meta&quot;</span> : &#123; [&lt;meta_data_body&gt;] &#125; ]? &lt;!--元 --&gt; </span><br><span class="line">  [,<span class="string">&quot;aggregations&quot;</span> : &#123; [&lt;sub_aggregation&gt;]+ &#125; ]? &lt;!--在聚合里面在定义子聚合 - -&gt; </span><br><span class="line">&#125;</span><br><span class="line">  [,<span class="string">&quot;&lt;aggregation_name_2&gt;&quot;</span> : &#123; ... &#125; ]*&lt;!--聚合的名字 --&gt; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong>aggregations 也可简写为 aggs。</p>
<h2 id="5-2-指标聚合"><a href="#5-2-指标聚合" class="headerlink" title="5.2 指标聚合"></a>5.2 指标聚合</h2><ul>
<li><p>max min sum avg</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;max_price&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;max&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>文档计数count</p>
</li>
</ul>
<p>示例： 统计price大于100的文档数量</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST /book/_count</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;gt&quot;</span>: <span class="number">100</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>value_count 统计某字段有值的文档数</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST /book/_search?size=<span class="number">0</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;price_count&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;value_count&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>cardinality值去重计数基数</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST /book/_search?size=<span class="number">0</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;_id_count&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;cardinality&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;_id&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;price_count&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;cardinality&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>stats 统计 count max min avg sum 5个值</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /book/_search?size=<span class="number">0</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;price_stats&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;stats&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Extended stats </p>
<p>   高级统计，比stats多4个统计结果： 平方和、方差、标准差、平均值加/减两个标准差的区间</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /book/_search?size=<span class="number">0</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;price_stats&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;extended_stats&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Percentiles 占比百分位对应的值统计</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /book/_search?size=<span class="number">0</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;price_percents&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;percentiles&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>指定分位值</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST /book/_search?size=<span class="number">0</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;price_percents&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;percentiles&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;percents&quot;</span>: [</span><br><span class="line">          <span class="number">75</span>,</span><br><span class="line">          <span class="number">99</span>,</span><br><span class="line">          <span class="number">99.9</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>Percentiles rank 统计值小于等于指定值的文档占比 </p>
</li>
</ul>
<p>统计price小于100和200的文档的占比</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST /book/_search?size=<span class="number">0</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;gge_perc_rank&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;percentile_ranks&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;values&quot;</span>: [</span><br><span class="line">          <span class="number">100</span>,</span><br><span class="line">          <span class="number">200</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="5-3-桶聚合"><a href="#5-3-桶聚合" class="headerlink" title="5.3 桶聚合"></a>5.3 桶聚合</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.3/search-aggregations-bucket.html">Bucket Aggregations</a>，桶聚合。<br>它执行的是对文档分组的操作（与sql中的group by类似），把满足相关特性的文档分到一个桶里，即桶分，输出结果往往是一个个包含多个文档的桶（一个桶就是一个group）<br>bucket：一个数据分组<br>metric：对一个数据分组执行的统计</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;group_by_price&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;from&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;to&quot;</span>: <span class="number">200</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;from&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;to&quot;</span>: <span class="number">400</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;from&quot;</span>: <span class="number">400</span>,</span><br><span class="line">            <span class="attr">&quot;to&quot;</span>: <span class="number">1000</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;average_price&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>值的个数统计</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;count_price&quot;</span>: &#123; </span><br><span class="line">  <span class="attr">&quot;value_count&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span> </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现having 效果</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;group_by_price&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;from&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;to&quot;</span>: <span class="number">200</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;from&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;to&quot;</span>: <span class="number">400</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;from&quot;</span>: <span class="number">400</span>,</span><br><span class="line">            <span class="attr">&quot;to&quot;</span>: <span class="number">1000</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;average_price&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;having&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;bucket_selector&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;buckets_path&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;avg_price&quot;</span>: <span class="string">&quot;average_price&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;script&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;source&quot;</span>: <span class="string">&quot;params.avg_price &gt;= 200 &quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="6-Elasticsearch零停机索引重建"><a href="#6-Elasticsearch零停机索引重建" class="headerlink" title="6. Elasticsearch零停机索引重建"></a>6. Elasticsearch零停机索引重建</h1><h2 id="6-1-说明"><a href="#6-1-说明" class="headerlink" title="6.1 说明"></a>6.1 说明</h2><p>Elasticsearch是一个实时的分布式搜索引擎，为用户提供搜索服务，当我们决定存储某种数据时，在创建索引的时候需要数据结构完整确定下来，与此同时索引的设定和很多固定配置将不能改变。当需要改变数据结构时就需要重建索引，为此，Elasticsearch团队提供了辅助工具帮助开发人员进行索引重建。</p>
<blockquote>
<p>零停机完成索引重建的三种方案。</p>
</blockquote>
<h2 id="6-2-方案一-外部数据导入方案"><a href="#6-2-方案一-外部数据导入方案" class="headerlink" title="6.2 方案一:外部数据导入方案"></a>6.2 方案一:外部数据导入方案</h2><p>**1)整体介绍 **<br>     系统架构设计中，有关系型数据库用来存储数据，Elasticsearch在系统架构里起到查询加速的作用，如果遇到索引重建的操作，待系统模块发布新版本后，可以从数据库将数据查询出来，重新灌到Elasticsearch即可。 </p>
<p>**2)执行步骤 **<br>      建议的功能方案：数据库 + MQ + 应用模块 + Elasticsearch，可以在MQ控制台发送MQ消息来触发重导数据，按批次对数据进行导入，整个过程异步化处理，请求操作示意如下所示：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201032155385.png" alt="image-20220103215532309"><br>**3)详细操作步骤： **</p>
<ol>
<li>通过MQ的web控制台或cli命令行，发送指定的MQ消息 。</li>
<li>MQ消息被微服务模块的消费者消费，触发ES数据重新导入功能 。</li>
<li>微服务模块从数据库里查询数据的总数及批次信息，并将每个数据批次的分页信息重新发送给MQ消息，分页信息包含查询条件和偏移量，此MQ消息还是会被微服务的MQ消息者接收处理。 </li>
<li>微服务根据接收的查询条件和分页信息，从数据库获取到数据后，根据索引结构的定义，将数据组装成ES支持的JSON格式，并执行bulk命令，将数据发送给Elasticsearch集群。 这样就可以完成索引的重建工作。</li>
</ol>
<p>**4)方案特点 **<br>    MQ中间件的选型不做具体要求，常见的rabitmq、activemq、rocketmq等均可。<br>在微服务模块方面，提供MQ消息处理接口、数据处理模块需要事先开发的，一般是创建新的索引时，配套把重建的功能也一起做好。整体功能共用一个topic，针对每个索引，有单独的结构定义和MQ消息处理tag，代码尽可能复用。处理的批次大小需要根据实际的情况设置。<br>微服务模块实例会部署多个，数据是分批处理的，批次信息会一次性全部先发送给MQ，各个实例处理的数据相互不重叠，利用MQ消息的异步处理机制，可以充分利用并发的优势，加快数据重建的速度。</p>
<p>**5)方案缺点 **</p>
<ol>
<li>对数据库造成读取压力，短时间内大量的读操作，会占用数据库的硬件资源，严重时可能引起数据库性能下降。 </li>
<li>网络带宽占用多，数据毕竟是从一个库传到另一个库，虽说是内网，但大量的数据传输带宽占用也需要注意。 </li>
<li>数据重建时间稍长，跟迁移的数据量大小有关。</li>
</ol>
<h2 id="6-3-方案二-基于scroll-bulk-索引别名方案"><a href="#6-3-方案二-基于scroll-bulk-索引别名方案" class="headerlink" title="6.3 方案二:基于scroll+bulk+索引别名方案"></a>6.3 方案二:基于scroll+bulk+索引别名方案</h2><p>**1)整体介绍 **<br>    利用Elasticsearch自带的一些工具完成索引的重建工作，当然在方案实际落地时，可能也会依赖客户端的一些功能，比如用Java客户端持续的做scroll查询、bulk命令的封装等。数据完全自给自足，不依赖其他数据源。 </p>
<p>**2)执行步骤 **<br>假设原索引名称是book，新的索引名称为book_new，Java客户端使用别名book_alias连接Elasticsearch，该别名指向原索引book。 </p>
<ol>
<li>若Java客户端没有使用别名，需要给客户端分配一个: PUT /book/_alias/book_alias 。</li>
<li>新建索引book_new，将mapping信息，settings信息等按新的要求全部定义好。 </li>
<li>使用scroll api将数据批量查询出来 ，为了使用 scroll，初始搜索请求应该在查询中指定 scroll 参数，这可以告诉 Elasticsearch 需要保持搜索的上下文环境多久,1m 就是一分钟。<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /book/_search?scroll=<span class="number">1</span>m </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;sort&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;_doc&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
结果：<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_scroll_id&quot;</span> : <span class="string">&quot;FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFlJkcUdWYzVRU0ItaVpLS29WSnQweUEAAAAAAADJdhZpVzNfQlJOMVRBLUNvc0ZHTVY0aVB3&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;book&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;lucene&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;Lucene Core is a Java library providing powerful indexing and search features, as well as spellchecking, hit highlighting and advanced analysis/tokenization capabilities. The PyLucene sub project provides Python bindings for Lucene Core. &quot;</span>,</span><br><span class="line">          <span class="attr">&quot;price&quot;</span> : <span class="number">100.45</span>,</span><br><span class="line">          <span class="attr">&quot;timestamp&quot;</span> : <span class="string">&quot;2020-08-21 19:11:35&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;sort&quot;</span> : [</span><br><span class="line">          <span class="number">0</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;book&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;solr&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;Solr is highly scalable, providing fully fault tolerant distributed indexing, search and analytics. It exposes Lucenes features through easy to use JSON/HTTP interfaces or native clients for Java and other languages.&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;price&quot;</span> : <span class="number">320.45</span>,</span><br><span class="line">          <span class="attr">&quot;timestamp&quot;</span> : <span class="string">&quot;2020-07-21 17:11:35&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;sort&quot;</span> : [</span><br><span class="line">          <span class="number">1</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>采用bulk api将scoll查出来的一批数据，批量写入新索引。<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /_bulk </span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span>: &#123; <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;book_new&quot;</span>, <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;对应的id值&quot;</span> &#125;&#125;</span><br><span class="line">&#123; 查询出来的数据值 &#125;</span><br></pre></td></tr></table></figure></li>
<li>反复执行修改后的步骤3和步骤4，查询一批导入一批，以后可以借助Java Client或其他语言的API 支持。<br>注意做3时需要指定上一次查询的 scroll_id (scroll_id 有效期是scroll值)<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /_search/scroll </span><br><span class="line">&#123; </span><br><span class="line">  <span class="attr">&quot;scroll&quot;</span>: <span class="string">&quot;1m&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;scroll_id&quot;</span> : <span class="string">&quot;步骤三中查询出来的值&quot;</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>切换别名book_alias到新的索引book_new上面，此时Java客户端仍然使用别名访问，也不需要修改任何代码，不需要停机。<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;actions&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;remove&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;book&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;alias&quot;</span>: <span class="string">&quot;book_alias&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;add&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;book_new&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;alias&quot;</span>: <span class="string">&quot;book_alias&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>验证别名查询的是否为新索引的数据。</li>
</ol>
<p>**3)方案特点 **<br>     在数据传输上基本自给自足，不依赖于其他数据源，Java客户端不需要停机等待数据迁移，网络传输占用带宽较小。只是scroll查询和bulk提交这部分，数据量大时需要依赖一些客户端工具。<br>**4)补充一点 **<br>    在Java客户端或其他客户端访问Elasticsearch集群时，使用别名是一个好习惯。</p>
<h2 id="6-4-方案三-Reindex-API方案"><a href="#6-4-方案三-Reindex-API方案" class="headerlink" title="6.4 方案三:Reindex API方案"></a>6.4 方案三:Reindex API方案</h2><p>Elasticsearch v6.3.1已经支持Reindex API，它对scroll、bulk做了一层封装，能够 对文档重建索引而不需要任何插件或外部工具。<br><strong>1)最基础的命令：</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;source&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;book&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;dest&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;book_new&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>响应结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">276</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;total&quot;</span> : <span class="number">4</span>,</span><br><span class="line">  <span class="attr">&quot;updated&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;created&quot;</span> : <span class="number">4</span>,</span><br><span class="line">  <span class="attr">&quot;deleted&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;batches&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;version_conflicts&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;noops&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;retries&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;bulk&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;search&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;throttled_millis&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;requests_per_second&quot;</span> : <span class="number">-1.0</span>,</span><br><span class="line">  <span class="attr">&quot;throttled_until_millis&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;failures&quot;</span> : [ ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注意： 如果不手动创建新索引book_new的mapping信息，那么Elasticsearch将启动自动映射模板对数据进行类型映射，可能不是期望的类型，这点要注意一下。</p>
<p>**2)version_type 属性 **<br>使用reindex api也是创建快照后再执行迁移的，这样目标索引的数据可能会与原索引有差异， version_type属性可以决定乐观锁并发处理的规则。<br>reindex api可以设置version_type属性，如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;source&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;book&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;dest&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;book_new&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;version_type&quot;</span>: <span class="string">&quot;internal&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>version_type属性含义如下： </p>
<ul>
<li>internal：直接拷贝文档到目标索引，对相同的type、文档ID直接进行覆盖，默认值 </li>
<li>external：迁移文档到目标索引时，保留version信息，对目标索引中不存在的文档进行创建，已存在的文档按version进行更新，遵循乐观锁机制。</li>
</ul>
<p>**3)op_type 属性和conflflicts 属性 **<br>如果op_type设置为create，那么迁移时只在目标索引中创建ID不存在的文档，已存在的文档，会提示错误，如下请求：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;source&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;book&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;dest&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;book_new&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;op_type&quot;</span>: <span class="string">&quot;create&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有错误提示的响应，节选部分：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">13</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;total&quot;</span> : <span class="number">4</span>,</span><br><span class="line">  <span class="attr">&quot;updated&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;created&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;deleted&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;batches&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;version_conflicts&quot;</span> : <span class="number">4</span>,</span><br><span class="line">  <span class="attr">&quot;noops&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;retries&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;bulk&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;search&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;throttled_millis&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;requests_per_second&quot;</span> : <span class="number">-1.0</span>,</span><br><span class="line">  <span class="attr">&quot;throttled_until_millis&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;failures&quot;</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;index&quot;</span> : <span class="string">&quot;book_new&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;id&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;cause&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;version_conflict_engine_exception&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;reason&quot;</span> : <span class="string">&quot;[1]: version conflict, document already exists (current version [2])&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;index_uuid&quot;</span> : <span class="string">&quot;92FIZzTDScWHQtHLOIcP8A&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;shard&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;index&quot;</span> : <span class="string">&quot;book_new&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;status&quot;</span> : <span class="number">409</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;index&quot;</span> : <span class="string">&quot;book_new&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;id&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;cause&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;version_conflict_engine_exception&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;reason&quot;</span> : <span class="string">&quot;[2]: version conflict, document already exists (current version [2])&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;index_uuid&quot;</span> : <span class="string">&quot;92FIZzTDScWHQtHLOIcP8A&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;shard&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;index&quot;</span> : <span class="string">&quot;book_new&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;status&quot;</span> : <span class="number">409</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;index&quot;</span> : <span class="string">&quot;book_new&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;id&quot;</span> : <span class="string">&quot;3&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;cause&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;version_conflict_engine_exception&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;reason&quot;</span> : <span class="string">&quot;[3]: version conflict, document already exists (current version [2])&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;index_uuid&quot;</span> : <span class="string">&quot;92FIZzTDScWHQtHLOIcP8A&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;shard&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;index&quot;</span> : <span class="string">&quot;book_new&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;status&quot;</span> : <span class="number">409</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;index&quot;</span> : <span class="string">&quot;book_new&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;id&quot;</span> : <span class="string">&quot;4&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;cause&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;version_conflict_engine_exception&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;reason&quot;</span> : <span class="string">&quot;[4]: version conflict, document already exists (current version [2])&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;index_uuid&quot;</span> : <span class="string">&quot;92FIZzTDScWHQtHLOIcP8A&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;shard&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;index&quot;</span> : <span class="string">&quot;book_new&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;status&quot;</span> : <span class="number">409</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如果加上”conflflicts”: “proceed”配置项，那么冲突信息将不展示，只展示冲突的文档数量，请求和响应结果将变成这样：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;conflicts&quot;</span>: <span class="string">&quot;proceed&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;source&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;book&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;dest&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;book_new&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;op_type&quot;</span>: <span class="string">&quot;create&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;total&quot;</span> : <span class="number">4</span>,</span><br><span class="line">  <span class="attr">&quot;updated&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;created&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;deleted&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;batches&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;version_conflicts&quot;</span> : <span class="number">4</span>,</span><br><span class="line">  <span class="attr">&quot;noops&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;retries&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;bulk&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;search&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;throttled_millis&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;requests_per_second&quot;</span> : <span class="number">-1.0</span>,</span><br><span class="line">  <span class="attr">&quot;throttled_until_millis&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;failures&quot;</span> : [ ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4)<strong>query支持</strong><br>reindex api支持数据过滤、数据排序、size设置、_source选择等，也支持脚本执行，这里提供一个简单示例：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="attr">&quot;source&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;book&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;language&quot;</span>: <span class="string">&quot;english&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;sort&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;likes&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;dest&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;book_new&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="6-5-小结"><a href="#6-5-小结" class="headerlink" title="6.5 小结"></a>6.5 小结</h2><p>   零停机索引重建操作的三个方案，从自研功能、scroll+bulk到reindex，我们作为Elasticsearch的使用者，三个方案的参与度是逐渐弱化的，但稳定性却是逐渐上升的，我们需要清楚地去了解各个方案的优劣，适宜的场景，然后根据实际的情况去权衡，哪个方案更适合我们的业务模型.。</p>
<h1 id="7-Elasticsearch-Suggester智能搜索建议"><a href="#7-Elasticsearch-Suggester智能搜索建议" class="headerlink" title="7. Elasticsearch Suggester智能搜索建议"></a>7. Elasticsearch Suggester智能搜索建议</h1><p>现代的搜索引擎，一般会具备”Suggest As You Type”功能，即在用户输入搜索的过程中，进行自动补全或者纠错。 通过协助用户输入更精准的关键词，提高后续全文搜索阶段文档匹配的程度。例如在京东上输入部分关键词，甚至输入拼写错误的关键词时，它依然能够提示出用户想要输入的内容:</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201032157993.png" alt="image-20220103215728891"></p>
<p>如果自己亲手去试一下，可以看到京东在用户刚开始输入的时候是自动补全的，而当输入到一定长度， 如果因为单词拼写错误无法补全，就开始尝试提示相似的词。<br>那么类似的功能在Elasticsearch里如何实现呢？ 答案就在Suggesters API。 Suggesters基本的运作原理是将输入的文本分解为token，然后在索引的字典里查找相似的term并返回。 根据使用场景的不同，Elasticsearch里设计了4种类别的Suggester，分别是: </p>
<ul>
<li>Term Suggester </li>
<li>Phrase Suggester </li>
<li>Completion Suggester </li>
<li>Context Suggester</li>
</ul>
<p>在官方的参考文档里，对这4种Suggester API都有比较详细的介绍，下面的案例将在Elasticsearch 7.x 上通过示例讲解Suggester的基础用法，希望能帮助部分国内开发者快速用于实际项目开发。<br>首先来看一个Term Suggester的示例:<br>准备一个叫做notes的索引，配置一个text字段</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /notes/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过bulk api写入几条文档</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST _bulk/?refresh=<span class="literal">true</span> </span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes&quot;</span> &#125; &#125; </span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;Lucene is cool&quot;</span>&#125; </span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;Elasticsearch builds on top of lucene&quot;</span>&#125; </span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;Elasticsearch rocks&quot;</span>&#125; </span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes&quot;</span> &#125; &#125; </span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;Elastic is the company behind ELK stack&quot;</span>&#125; </span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;elk rocks&quot;</span>&#125; </span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes&quot;</span>&#125; &#125;</span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;elasticsearch is rock solid&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>此时notes索引里已经有一些文档了，可以进行下一步的探索。为帮助理解，我们先看看哪些term会存在于词典里。<br>将输入的文本分析一下: </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;Lucene is cool&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Elasticsearch builds on top of lucene&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Elasticsearch rocks&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Elastic is the company behind ELK stack&quot;</span>,</span><br><span class="line">    <span class="string">&quot;elk rocks&quot;</span>,</span><br><span class="line">    <span class="string">&quot;elasticsearch is rock solid&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这些分出来的token都会成为词典里一个term，注意有些token会出现多次，因此在倒排索引里记录的词频会比较高，同时记录的还有这些token在原文档里的偏移量和相对位置信息。<br>执行一次suggester搜索看看效果: </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">POST /notes/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;suggest&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;my-suggestion&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;lucne rock&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;suggest_mode&quot;</span>: <span class="string">&quot;missing&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;body&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>suggest就是一种特殊类型的搜索，DSL内部的”text”指的是api调用方提供的文本，也就是通常用户界面上用户输入的内容。这里的lucne是错误的拼写，模拟用户输入错误。 “term”表示这是一个term suggester。 “fifield”指定suggester针对的字段，另外有一个可选的”suggest_mode”。 范例里的”missing”实际上就是缺省值，它是什么意思？有点挠头… 还是先看看返回结果吧: </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">440</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;suggest&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;my-suggestion&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;text&quot;</span> : <span class="string">&quot;lucne&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;offset&quot;</span> : <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;length&quot;</span> : <span class="number">5</span>,</span><br><span class="line">        <span class="attr">&quot;options&quot;</span> : [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;text&quot;</span> : <span class="string">&quot;lucene&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;score&quot;</span> : <span class="number">0.8</span>,</span><br><span class="line">            <span class="attr">&quot;freq&quot;</span> : <span class="number">2</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;text&quot;</span> : <span class="string">&quot;rock&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;offset&quot;</span> : <span class="number">6</span>,</span><br><span class="line">        <span class="attr">&quot;length&quot;</span> : <span class="number">4</span>,</span><br><span class="line">        <span class="attr">&quot;options&quot;</span> : [ ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在返回结果里”suggest” -&gt; “my-suggestion”部分包含了一个数组，每个数组项对应从输入文本分解出 来的token（存放在”text”这个key里）以及为该token提供的建议词项（存放在options数组里)。示例里返回了”lucne”，”rock”这2个词的建议项(options)，其中”rock”的options是空的，表示没有可以建议的选项，为什么？ 上面提到了，我们为查询提供的suggest mode是”missing”,由于”rock”在索引的词典里已经存在了，够精准，就不建议啦。 只有词典里找不到词，才会为其提供相似的选项。 如果将”suggest_mode”换成”popular”会是什么效果？<br>尝试一下，重新执行查询，返回结果里”rock”这个词的option不再是空的，而是建议为rocks。 </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">4</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;suggest&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;my-suggestion&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;text&quot;</span> : <span class="string">&quot;lucne&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;offset&quot;</span> : <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;length&quot;</span> : <span class="number">5</span>,</span><br><span class="line">        <span class="attr">&quot;options&quot;</span> : [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;text&quot;</span> : <span class="string">&quot;lucene&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;score&quot;</span> : <span class="number">0.8</span>,</span><br><span class="line">            <span class="attr">&quot;freq&quot;</span> : <span class="number">2</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;text&quot;</span> : <span class="string">&quot;rock&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;offset&quot;</span> : <span class="number">6</span>,</span><br><span class="line">        <span class="attr">&quot;length&quot;</span> : <span class="number">4</span>,</span><br><span class="line">        <span class="attr">&quot;options&quot;</span> : [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;text&quot;</span> : <span class="string">&quot;rocks&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;score&quot;</span> : <span class="number">0.75</span>,</span><br><span class="line">            <span class="attr">&quot;freq&quot;</span> : <span class="number">2</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回想一下，rock和rocks在索引词典里都是有的。 不难看出即使用户输入的token在索引的词典里已经有了，但是因为存在一个词频更高的相似项，这个相似项可能是更合适的，就被挑选到options里了。 最后还有一个”always” mode，其含义是不管token是否存在于索引词典里都要给出相似项。 有人可能会问，两个term的相似性是如何判断的？ ES使用了一种叫做Levenstein edit distance的算法，其核心思想就是一个词改动多少个字符就可以和另外一个词一致。 Term suggester还有其他很多可选参数来控制这个相似性的模糊程度，这里就不一一赘述了。 </p>
<p>Phrase suggester在Term suggester的基础上，会考量多个term之间的关系，比如是否同时出现在索引的原文里，相邻程度，以及词频等等。看个范例就比较容易明白了: </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /notes/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;suggest&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;my-suggestion&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;lucne and elasticsear rock&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;phrase&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;body&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;pre_tag&quot;</span>: <span class="string">&quot;&lt;em&gt;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;post_tag&quot;</span>: <span class="string">&quot;&lt;/em&gt;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回结果: </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">202</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;suggest&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;my-suggestion&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;text&quot;</span> : <span class="string">&quot;lucne and elasticsear rock&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;offset&quot;</span> : <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;length&quot;</span> : <span class="number">26</span>,</span><br><span class="line">        <span class="attr">&quot;options&quot;</span> : [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;text&quot;</span> : <span class="string">&quot;lucene and elasticsearch rock&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;highlighted&quot;</span> : <span class="string">&quot;&lt;em&gt;lucene&lt;/em&gt; and &lt;em&gt;elasticsearch&lt;/em&gt; rock&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;score&quot;</span> : <span class="number">0.004993905</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;text&quot;</span> : <span class="string">&quot;lucne and elasticsearch rock&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;highlighted&quot;</span> : <span class="string">&quot;lucne and &lt;em&gt;elasticsearch&lt;/em&gt; rock&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;score&quot;</span> : <span class="number">0.0033391973</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;text&quot;</span> : <span class="string">&quot;lucene and elasticsear rock&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;highlighted&quot;</span> : <span class="string">&quot;&lt;em&gt;lucene&lt;/em&gt; and elasticsear rock&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;score&quot;</span> : <span class="number">0.0029183894</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>options直接返回一个phrase列表，由于加了highlight选项，被替换的term会被高亮。因为lucene和 elasticsearch曾经在同一条原文里出现过，同时替换2个term的可信度更高，所以打分较高，排在第一位返回。Phrase suggester有相当多的参数用于控制匹配的模糊程度，需要根据实际应用情况去挑选和调试。</p>
<p>下面来谈一下Completion Suggester，它主要针对的应用场景就是”Auto Completion”。 此场景下用户每输入一个字符的时候，就需要即时发送一次查询请求到后端查找匹配项，在用户输入速度较高的情况下对后端响应速度要求比较苛刻。因此实现上它和前面两个Suggester采用了不同的数据结构，索引并非通过倒排来完成，而是将analyze过的数据编码成FST和索引一起存放。对于一个open状态的索引， FST会被ES整个装载到内存里的，进行前缀查找速度极快。但是FST只能用于前缀查找，这也是Completion Suggester的局限所在。<br>为了使用Completion Suggester，字段的类型需要专门定义如下:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /notes_completion/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;completion&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用bulk API索引点数据: </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST _bulk/?refresh=<span class="literal">true</span></span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes_completion&quot;</span> &#125; &#125; </span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;Lucene is cool&quot;</span>&#125;</span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes_completion&quot;</span> &#125; &#125; </span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;Elasticsearch builds on top of lucene&quot;</span>&#125; </span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes_completion&quot;</span>&#125; &#125; </span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;Elasticsearch rocks&quot;</span>&#125; </span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes_completion&quot;</span> &#125; &#125; </span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;Elastic is the company behind ELK stack&quot;</span>&#125;</span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes_completion&quot;</span> &#125; &#125; </span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;the elk stack rocks&quot;</span>&#125; </span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes_completion&quot;</span>&#125; &#125;</span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;elasticsearch is rock solid&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>查找: </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /notes_completion/_search?pretty </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;suggest&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;note-suggest&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;elastic i&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;completion&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;body&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>结果: </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">193</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;suggest&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;note-suggest&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;text&quot;</span> : <span class="string">&quot;elastic i&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;offset&quot;</span> : <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;length&quot;</span> : <span class="number">9</span>,</span><br><span class="line">        <span class="attr">&quot;options&quot;</span> : [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;text&quot;</span> : <span class="string">&quot;Elastic is the company behind ELK stack&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes_completion&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;XzJNhXoBYYHsZaOajY0K&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_score&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">            <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">              <span class="attr">&quot;body&quot;</span> : <span class="string">&quot;Elastic is the company behind ELK stack&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>值得注意的一点是Completion Suggester在索引原始数据的时候也要经过analyze阶段，取决于选用的 analyzer不同，某些词可能会被转换，某些词可能被去除，这些会影响FST编码结果，也会影响查找匹配的效果。<br>比如我们删除上面的索引，重新设置索引的mapping，将analyzer更改为”english”:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">PUT /notes_completion/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;body&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;completion&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;english&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST _bulk/?refresh=<span class="literal">true</span></span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes_completion&quot;</span> &#125; &#125; </span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;Lucene is cool&quot;</span>&#125;</span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes_completion&quot;</span> &#125; &#125; </span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;Elasticsearch builds on top of lucene&quot;</span>&#125; </span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes_completion&quot;</span>&#125; &#125; </span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;Elasticsearch rocks&quot;</span>&#125; </span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes_completion&quot;</span> &#125; &#125; </span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;Elastic is the company behind ELK stack&quot;</span>&#125;</span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes_completion&quot;</span> &#125; &#125; </span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;the elk stack rocks&quot;</span>&#125; </span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;notes_completion&quot;</span>&#125; &#125;</span><br><span class="line">&#123; <span class="attr">&quot;body&quot;</span>: <span class="string">&quot;elasticsearch is rock solid&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p> bulk api索引同样的数据后，执行下面的查询: </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /notes_completion/_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;suggest&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;note-suggest&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;elastic i&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;completion&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;body&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>居然没有匹配结果了，多么费解！原来我们用的english analyzer会剥离掉stop word，而is就是其中一个，被剥离掉了！<br>用analyze api测试一下: </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;elasticsearch is rock solid&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;english&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会发现只有3个token: </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;elasticsearch&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">13</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;rock&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">17</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">21</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;solid&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">22</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">27</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>FST(Finite StateTransducers)只编码了这3个token，并且默认的还会记录他们在文档中的位置和分隔符。 用户输入”elastic i”进行查找的时候，输入被分解成”elastic”和”i”，FST没有编码这个“i” , 匹配失败。</p>
<p>好吧，如果你现在还足够清醒的话，试一下搜索”elastic is”，会发现又有结果，why? 因为这次输入的 text经过english analyzer的时候is也被剥离了，只需在FST里查询”elastic”这个前缀，自然就可以匹配到了。</p>
<p>其他能影响completion suggester结果的，还有 如”preserve_separators”，”preserve_position_increments”等等mapping参数来控制匹配的模糊程度。以及搜索时可以选用Fuzzy Queries，使得上面例子里的”elastic i”在使用english analyzer的情况下依然可以匹配到结果。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;preserve_separators&quot;</span>: <span class="literal">false</span>, 这个设置为<span class="literal">false</span>,将忽略空格之类的分隔符</span><br><span class="line"><span class="string">&quot;preserve_position_increments&quot;</span>: <span class="literal">true</span>,如果建议词第一个词是停用词,并且我们使用了过滤停用 词的分析器,需要将此设置为<span class="literal">false</span>。</span><br></pre></td></tr></table></figure>
<p>因此用好Completion Sugester并不是一件容易的事，实际应用开发过程中，需要根据数据特性和业务需要，灵活搭配analyzer和mapping参数，反复调试才可能获得理想的补全效果。<br>回到篇首京东或者百度搜索框的补全/纠错功能，如果用ES怎么实现呢？我能想到的一个的实现方式:<br>在用户刚开始输入的过程中，使用Completion Suggester进行关键词前缀匹配，刚开始匹配项会比较多，随着用户输入字符增多，匹配项越来越少。如果用户输入比较精准，可能Completion Suggester的结果已经够好，用户已经可以看到理想的备选项了。<br>如果Completion Suggester已经到了零匹配，那么可以猜测是否用户有输入错误，这时候可以尝试一下Phrase Suggester。如果Phrase Suggester没有找到任何option，开始尝试term Suggester。<br>精准程度上(Precision)看： Completion &gt; Phrase &gt; term， 而召回率上(Recall)则反之。从性能上看， Completion Suggester是最快的，如果能满足业务需求，只用Completion Suggester做前缀匹配是最理想的。 Phrase和Term由于是做倒排索引的搜索，相比较而言性能应该要低不少，应尽量控制suggester用到的索引的数据量，最理想的状况是经过一定时间预热后，索引可以全量map到内存。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">召回率(Recall) = 系统检索到的相关文件 / 系统所有相关的文件总数</span><br><span class="line"></span><br><span class="line">准确率(Precision) = 系统检索到的相关文件 / 系统所有检索到的文件总数 </span><br><span class="line"></span><br><span class="line">从一个大规模数据集合中检索文档时，可把文档分成四组：</span><br><span class="line">- 系统检索到的相关文档（A） </span><br><span class="line">- 系统检索到的不相关文档（B）</span><br><span class="line">- 相关但是系统没有检索到的文档（C）</span><br><span class="line">- 不相关且没有被系统检索到的文档（D）</span><br><span class="line"></span><br><span class="line">则：</span><br><span class="line">- 召回率R：用实际检索到相关文档数作为分子，所有相关文档总数作为分母，即R = A / ( A + C ) </span><br><span class="line">- 精度P：用实际检索到相关文档数作为分子，所有检索到的文档总数作为分母，即P = A / ( A + B ) </span><br><span class="line"></span><br><span class="line">举例：一个数据库有 <span class="number">1000</span> 个文档，其中有 <span class="number">50</span> 个文档符合相关定义的问题,系统检索到 <span class="number">75</span> 个文档，但 其中只有 <span class="number">45</span> 个文档被检索出。 </span><br><span class="line"></span><br><span class="line">精度：P=<span class="number">45</span>/<span class="number">75</span>=<span class="number">60</span>%</span><br><span class="line">召回率：R=<span class="number">45</span>/<span class="number">50</span>=<span class="number">90</span>%</span><br></pre></td></tr></table></figure>
<p>Context Suggester </p>
<ul>
<li>Completion Suggester 的扩展 。</li>
<li>可以在搜索中加入更多的上下文信息，然后根据不同的上下文信息，对相同的输入，比如”star”。</li>
</ul>
<p>提供不同的建议值，比如：<br>咖啡相关：starbucks<br>电影相关：star wars</p>
<h1 id="8-Elasticsearch-Java-Client"><a href="#8-Elasticsearch-Java-Client" class="headerlink" title="8. Elasticsearch Java Client"></a>8. Elasticsearch Java Client</h1><p>**1.说明 **<br>ES提供多种不同的客户端：<br> 1、TransportClient ES提供的传统客户端，官方计划8.0版本删除此客户端。<br> 2、RestClient RestClient是官方推荐使用的，它包括两种：Java Low Level REST Client和 Java High Level REST Client。 ES在6.0之后提供 Java High Level REST Client， 两种客户端官方更推荐使用 Java High Level REST Client， 使用时加入对应版本的依赖即可。</p>
<p>**2. SpringBoot 中使用 RestClient **<br>1)配置 pom.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>es-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>es-spring<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- FIXME change it to the project&#x27;s website --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://www.example.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>11<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>11<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.13.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.13.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginManagement</span>&gt;</span><span class="comment">&lt;!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- clean lifecycle, see https://maven.apache.org/ref/current/maven-core/lifecycles.html#clean_Lifecycle --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-clean-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- default lifecycle, jar packaging: see https://maven.apache.org/ref/current/maven-core/default-bindings.html#Plugin_bindings_for_jar_packaging --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resources-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.22.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-install-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-deploy-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- site lifecycle, see https://maven.apache.org/ref/current/maven-core/lifecycles.html#site_Lifecycle --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-site-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-project-info-reports-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>application.yml</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">lagouelasticsearch:</span></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">          <span class="attr">hostlist:</span> <span class="number">192.168</span><span class="number">.2</span><span class="number">.118</span><span class="string">:9200</span> <span class="comment">#多个结点中间用逗号分隔</span></span><br></pre></td></tr></table></figure>
<p>3)配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ：xjlonly</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> ：Created in 2021/7/8 17:10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>：</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@modified</span> By：</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>: $</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticsearchConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;lagouelasticsearch.elasticsearch.hostlist&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String hostlist;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestHighLevelClient <span class="title">restHighLevelClient</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//解析hostlist配置信息</span></span><br><span class="line">        String[] split = hostlist.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="comment">//创建HttpHost数组，其中存放es主机和端口的配置信息</span></span><br><span class="line">        HttpHost[] httpHostArray = <span class="keyword">new</span> HttpHost[split.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; split.length; i++) &#123;</span><br><span class="line">            String iterm = split[i];</span><br><span class="line">            httpHostArray[i] = <span class="keyword">new</span> HttpHost(iterm.split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>], Integer.parseInt(iterm.split(<span class="string">&quot;:&quot;</span>)[<span class="number">1</span>]), <span class="string">&quot;http&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建RestHighLevelClient客户端</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestHighLevelClient(RestClient.builder(httpHostArray));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//项目主要使用RestHighLevelClient，对于低级的客户端暂时不用</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestClient <span class="title">restClient</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//解析hostlist配置信息</span></span><br><span class="line">        String[] split = hostlist.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="comment">//创建HttpHost数组，其中存放es主机和端口的配置信息</span></span><br><span class="line">        HttpHost[] httpHostArray = <span class="keyword">new</span> HttpHost[split.length];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;split.length;i++)&#123;</span><br><span class="line">            String item = split[i];</span><br><span class="line">            httpHostArray[i] = <span class="keyword">new</span> HttpHost(item.split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>], Integer.parseInt(item.split(<span class="string">&quot;:&quot;</span>)[<span class="number">1</span>]), <span class="string">&quot;http&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> RestClient.builder(httpHostArray).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>编写启动类<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hello world!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(App.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>索引操作<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.Assert.assertTrue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.admin.indices.create.CreateIndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.admin.indices.create.CreateIndexResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.IndicesClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.settings.Settings;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentFactory;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Unit test for simple App.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppTest</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestHighLevelClient restHighLevelClient;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Rigorous Test :-)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shouldAnswerWithTrue</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        assertTrue( <span class="keyword">true</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建索引库</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    PUT /elasticsearch_test</span></span><br><span class="line"><span class="comment">    &#123; &quot;settings&quot;: &#123;&#125;,</span></span><br><span class="line"><span class="comment">    &quot;mappings&quot;: &#123;</span></span><br><span class="line"><span class="comment">    &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="comment">     &quot;description&quot;: &#123;</span></span><br><span class="line"><span class="comment">      &quot;type&quot;: &quot;text&quot;,</span></span><br><span class="line"><span class="comment">      &quot;analyzer&quot;: &quot;ik_max_word&quot;</span></span><br><span class="line"><span class="comment">      &#125;,</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &#123;</span></span><br><span class="line"><span class="comment">         &quot;type&quot;:</span></span><br><span class="line"><span class="comment">          &quot;keyword&quot;</span></span><br><span class="line"><span class="comment">       &#125;,</span></span><br><span class="line"><span class="comment">      &quot;pic&quot;: &#123;</span></span><br><span class="line"><span class="comment">        &quot;type&quot;: &quot;text&quot;,</span></span><br><span class="line"><span class="comment">        &quot;index&quot;: false</span></span><br><span class="line"><span class="comment">         &#125;,</span></span><br><span class="line"><span class="comment">      &quot;studymodel&quot;: &#123;</span></span><br><span class="line"><span class="comment">        &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        CreateIndexRequest createIndexRequest = <span class="keyword">new</span> CreateIndexRequest(<span class="string">&quot;elasticsearch_test&quot;</span>);</span><br><span class="line"></span><br><span class="line">        createIndexRequest.settings(Settings.builder().put(<span class="string">&quot;number_of_shards&quot;</span>,<span class="string">&quot;1&quot;</span>).put( <span class="string">&quot;number_of_replicas&quot;</span>,<span class="string">&quot;0&quot;</span>));</span><br><span class="line"></span><br><span class="line">        XContentBuilder builder = XContentFactory.jsonBuilder()</span><br><span class="line">                .startObject()</span><br><span class="line">                .field(<span class="string">&quot;properties&quot;</span>)</span><br><span class="line">                .startObject()</span><br><span class="line">                .field(<span class="string">&quot;description&quot;</span>).startObject().field(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;text&quot;</span>).field(<span class="string">&quot;analyzer&quot;</span>,<span class="string">&quot;ik_max_word&quot;</span>).endObject()</span><br><span class="line">                .field(<span class="string">&quot;name&quot;</span>).startObject().field(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;keyword&quot;</span>).endObject()</span><br><span class="line">                .field(<span class="string">&quot;pic&quot;</span>).startObject().field(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;text&quot;</span>).field(<span class="string">&quot;index&quot;</span>,<span class="string">&quot;false&quot;</span>).endObject()</span><br><span class="line">                .field(<span class="string">&quot;studymodel&quot;</span>).startObject().field(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;keyword&quot;</span>).endObject()</span><br><span class="line">                .endObject().endObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        createIndexRequest.mapping(<span class="string">&quot;doc&quot;</span>, builder);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> IndicesClient indices = restHighLevelClient.indices();</span><br><span class="line">        <span class="keyword">final</span> CreateIndexResponse createIndexResponse = indices.create(createIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//得到响应</span></span><br><span class="line">        <span class="keyword">boolean</span> acknowledged = createIndexResponse.isAcknowledged();</span><br><span class="line">        System.out.println(acknowledged);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除索引库 </span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//删除索引的请求对</span></span><br><span class="line">        DeleteIndexRequest deleteIndexRequest = <span class="keyword">new</span> DeleteIndexRequest(<span class="string">&quot;elasticsearch_test&quot;</span>);</span><br><span class="line">        <span class="comment">//操作索引的客户端 </span></span><br><span class="line">        IndicesClient indices = restHighLevelClient.indices();</span><br><span class="line">        <span class="comment">//执行删除索引 </span></span><br><span class="line">        AcknowledgedResponse delete = indices.delete(deleteIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">//得到响应 </span></span><br><span class="line">        <span class="keyword">boolean</span> acknowledged = delete.isAcknowledged();</span><br><span class="line">        System.out.println(acknowledged);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAddDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//创建索引请求对象</span></span><br><span class="line">        IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;elasticsearch_test&quot;</span>,<span class="string">&quot;doc&quot;</span>);</span><br><span class="line">        indexRequest.id(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="comment">//文档内容 准备json数据</span></span><br><span class="line">        Map&lt;String, Object&gt; jsonMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        jsonMap.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;spring cloud实战&quot;</span>);</span><br><span class="line">        jsonMap.put(<span class="string">&quot;description&quot;</span>, <span class="string">&quot;本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud 基础入门 3.实战Spring Boot 4.注册中心eureka。&quot;</span>);</span><br><span class="line">        jsonMap.put(<span class="string">&quot;studymodel&quot;</span>, <span class="string">&quot;201001&quot;</span>);</span><br><span class="line">        SimpleDateFormat dateFormat =<span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        jsonMap.put(<span class="string">&quot;timestamp&quot;</span>, dateFormat.format(<span class="keyword">new</span> Date()));</span><br><span class="line">        jsonMap.put(<span class="string">&quot;price&quot;</span>, <span class="number">5.6f</span>); indexRequest.source(jsonMap);</span><br><span class="line">        <span class="comment">//通过client进行http的请求</span></span><br><span class="line">        IndexResponse indexResponse = restHighLevelClient.index(indexRequest,RequestOptions.DEFAULT);</span><br><span class="line">        DocWriteResponse.Result result = indexResponse.getResult(); System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询文档</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//查询请求对象</span></span><br><span class="line">        GetRequest getRequest = <span class="keyword">new</span> GetRequest(<span class="string">&quot;elasticsearch_test&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        GetResponse getResponse = restHighLevelClient.get(getRequest,RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">//得到文档的内容</span></span><br><span class="line">        Map&lt;String, Object&gt; sourceAsMap = getResponse.getSourceAsMap();</span><br><span class="line">        System.out.println(sourceAsMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>其它搜索操作<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchAll</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ParseException </span>&#123;</span><br><span class="line">        <span class="comment">//搜索请求对象</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;elasticsearch_test&quot;</span>);</span><br><span class="line">        <span class="comment">//搜索源构建对象</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        <span class="comment">//搜索方式</span></span><br><span class="line">        <span class="comment">// matchAllQuery搜索全部</span></span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">        <span class="comment">//设置源字段过虑,第一个参数结果集包括哪些字段，第二个参数表示结果集不包括哪些字段</span></span><br><span class="line">        searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[] &#123;<span class="string">&quot;name&quot;</span>,<span class="string">&quot;studymodel&quot;</span>,<span class="string">&quot;price&quot;</span>,<span class="string">&quot;timestamp&quot;</span>&#125;,<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">        <span class="comment">//向搜索请求对象中设置搜索源</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line">        <span class="comment">//执行搜索,向ES发起http请求</span></span><br><span class="line">        SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">//搜索结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        <span class="comment">//匹配到的总记录数</span></span><br><span class="line">        TotalHits totalHits = hits.getTotalHits();</span><br><span class="line">        <span class="comment">//得到匹配度高的文档</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="comment">//日期格式化对象</span></span><br><span class="line">        SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(SearchHit hit:searchHits)&#123;</span><br><span class="line">            <span class="comment">//文档的主键</span></span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="comment">//源文档内容</span></span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            <span class="comment">//由于前边设置了源文档字段过虑，这时description是取不到的</span></span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">            <span class="comment">//学习模式</span></span><br><span class="line">            String studymodel = (String) sourceAsMap.get(<span class="string">&quot;studymodel&quot;</span>);</span><br><span class="line">            <span class="comment">//价格</span></span><br><span class="line">            Double price = (Double) sourceAsMap.get(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">            <span class="comment">//日期</span></span><br><span class="line">            Date timestamp = dateFormat.parse((String) sourceAsMap.get(<span class="string">&quot;timestamp&quot;</span>));</span><br><span class="line">            System.out.println(name);</span><br><span class="line">            System.out.println(studymodel);</span><br><span class="line">            System.out.println(description);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTermQuery1</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ParseException </span>&#123;</span><br><span class="line">        <span class="comment">//搜索请求对象</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;elasticsearch_test&quot;</span>);</span><br><span class="line">        <span class="comment">//搜索源构建对象</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        <span class="comment">//搜索方式</span></span><br><span class="line">        <span class="comment">// termQuerysearchSourceBuilder.query(QueryBuilders.termQuery(&quot;name&quot;,&quot;spring&quot;));</span></span><br><span class="line">        <span class="comment">// 设置源字段过虑,第一个参数结果集包括哪些字段，第二个参数表示结果集不包括哪些字段</span></span><br><span class="line">        searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[] &#123;<span class="string">&quot;name&quot;</span>,<span class="string">&quot;studymodel&quot;</span>,<span class="string">&quot;price&quot;</span>,<span class="string">&quot;timestamp&quot;</span>&#125;,<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">        <span class="comment">//向搜索请求对象中设置搜索源</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line">        <span class="comment">//执行搜索,向ES发起http请求</span></span><br><span class="line">        SearchResponse searchResponse = restHighLevelClient.search(searchRequest,RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">//搜索结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        <span class="comment">//匹配到的总记录数</span></span><br><span class="line">        TotalHits totalHits = hits.getTotalHits();</span><br><span class="line">        <span class="comment">//得到匹配度高的文档</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="comment">//日期格式化对象</span></span><br><span class="line">        SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(SearchHit hit:searchHits)&#123;</span><br><span class="line">            <span class="comment">//文档的主键</span></span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="comment">//源文档内容</span></span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            <span class="comment">//由于前边设置了源文档字段过虑，这时description是取不到的</span></span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">            <span class="comment">//学习模式</span></span><br><span class="line">            String studymodel = (String) sourceAsMap.get(<span class="string">&quot;studymodel&quot;</span>);</span><br><span class="line">            <span class="comment">//价格</span></span><br><span class="line">            Double price = (Double) sourceAsMap.get(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">            <span class="comment">//日期</span></span><br><span class="line">            Date timestamp = dateFormat.parse((String) sourceAsMap.get(<span class="string">&quot;timestamp&quot;</span>));</span><br><span class="line">            System.out.println(name);</span><br><span class="line">            System.out.println(studymodel);</span><br><span class="line">            System.out.println(description);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//分页查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchPage</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ParseException </span>&#123;</span><br><span class="line">        <span class="comment">//搜索请求对象</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;elasticsearch_test&quot;</span>);</span><br><span class="line">        <span class="comment">//指定类型</span></span><br><span class="line">        searchRequest.types(<span class="string">&quot;doc&quot;</span>);</span><br><span class="line">        <span class="comment">//搜索源构建对象</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        <span class="comment">//设置分页参数</span></span><br><span class="line">        <span class="comment">// 页码</span></span><br><span class="line">        <span class="keyword">int</span> page = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//每页记录数</span></span><br><span class="line">        <span class="keyword">int</span> size = <span class="number">2</span>;</span><br><span class="line">        <span class="comment">//计算出记录起始下标</span></span><br><span class="line">        <span class="keyword">int</span> from = (page-<span class="number">1</span>)*size;</span><br><span class="line">        searchSourceBuilder.from(from);</span><br><span class="line">        <span class="comment">//起始记录下标，从0开始</span></span><br><span class="line">        searchSourceBuilder.size(size);</span><br><span class="line">        <span class="comment">//每页显示的记录数</span></span><br><span class="line">        <span class="comment">// 搜索方式</span></span><br><span class="line">        <span class="comment">// matchAllQuery搜索全部</span></span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">        <span class="comment">//设置源字段过虑,第一个参数结果集包括哪些字段，第二个参数表示结果集不包括哪些字段</span></span><br><span class="line">        searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[] &#123;<span class="string">&quot;name&quot;</span>,<span class="string">&quot;studymodel&quot;</span>,<span class="string">&quot;price&quot;</span>,<span class="string">&quot;timestamp&quot;</span>&#125;,<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">        <span class="comment">//向搜索请求对象中设置搜索源</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line">        <span class="comment">//执行搜索,向ES发起http请求</span></span><br><span class="line">        SearchResponse searchResponse = restHighLevelClient.search(searchRequest,RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">//搜索结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        <span class="comment">//匹配到的总记录数</span></span><br><span class="line">        TotalHits totalHits = hits.getTotalHits();</span><br><span class="line">        <span class="comment">//得到匹配度高的文档</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="comment">//日期格式化对象</span></span><br><span class="line">        SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(SearchHit hit:searchHits)&#123;</span><br><span class="line">            <span class="comment">//文档的主键</span></span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="comment">//源文档内容</span></span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            <span class="comment">//由于前边设置了源文档字段过虑，这时description是取不到的</span></span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">            <span class="comment">//学习模式</span></span><br><span class="line">            String studymodel = (String) sourceAsMap.get(<span class="string">&quot;studymodel&quot;</span>);</span><br><span class="line">            <span class="comment">//价格</span></span><br><span class="line">            Double price = (Double) sourceAsMap.get(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">            <span class="comment">//日期</span></span><br><span class="line">            Date timestamp = dateFormat.parse((String) sourceAsMap.get(<span class="string">&quot;timestamp&quot;</span>));</span><br><span class="line">            System.out.println(name);</span><br><span class="line">            System.out.println(studymodel);</span><br><span class="line">            System.out.println(description);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//TermQuery</span></span><br><span class="line">    <span class="comment">//分页</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTermQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ParseException </span>&#123;</span><br><span class="line">        <span class="comment">//搜索请求对象</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;elasticsearch_test&quot;</span>);</span><br><span class="line">        <span class="comment">//搜索源构建对象</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        <span class="comment">//设置分页参数</span></span><br><span class="line">        <span class="comment">// 页码</span></span><br><span class="line">        <span class="keyword">int</span> page = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//每页记录数</span></span><br><span class="line">        <span class="keyword">int</span> size = <span class="number">2</span>;</span><br><span class="line">        <span class="comment">//计算出记录起始下标</span></span><br><span class="line">        <span class="keyword">int</span> from = (page-<span class="number">1</span>)*size;</span><br><span class="line">        searchSourceBuilder.from(from);</span><br><span class="line">        <span class="comment">//起始记录下标，从0开始</span></span><br><span class="line">        searchSourceBuilder.size(size);</span><br><span class="line">        <span class="comment">//每页显示的记录数</span></span><br><span class="line">        <span class="comment">// 搜索方式</span></span><br><span class="line">        <span class="comment">// termQuery</span></span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.termQuery(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;spring&quot;</span>));</span><br><span class="line">        <span class="comment">//设置源字段过虑,第一个参数结果集包括哪些字段，第二个参数表示结果集不包括哪些字段</span></span><br><span class="line">        searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[] &#123;<span class="string">&quot;name&quot;</span>,<span class="string">&quot;studymodel&quot;</span>,<span class="string">&quot;price&quot;</span>,<span class="string">&quot;timestamp&quot;</span>&#125;,<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">        <span class="comment">//向搜索请求对象中设置搜索源</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line">        <span class="comment">//执行搜索,向ES发起http请求</span></span><br><span class="line">        SearchResponse searchResponse = restHighLevelClient.search(searchRequest,RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">//搜索结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        <span class="comment">//匹配到的总记录数</span></span><br><span class="line">        TotalHits totalHits = hits.getTotalHits();</span><br><span class="line">        <span class="comment">//得到匹配度高的文档</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="comment">//日期格式化对象</span></span><br><span class="line">        SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(SearchHit hit:searchHits)&#123;</span><br><span class="line">            <span class="comment">//文档的主键</span></span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="comment">//源文档内容</span></span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            <span class="comment">//由于前边设置了源文档字段过虑，这时description是取不到的</span></span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">            <span class="comment">//学习模式</span></span><br><span class="line">            String studymodel = (String) sourceAsMap.get(<span class="string">&quot;studymodel&quot;</span>);</span><br><span class="line">            <span class="comment">//价格</span></span><br><span class="line">            Double price = (Double) sourceAsMap.get(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">            <span class="comment">//日期</span></span><br><span class="line">            Date timestamp = dateFormat.parse((String) sourceAsMap.get(<span class="string">&quot;timestamp&quot;</span>));</span><br><span class="line">            System.out.println(name);</span><br><span class="line">            System.out.println(studymodel);</span><br><span class="line">            System.out.println(description);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">小肥龙吃大冰淇淋</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://lvxueyang.vip/post/61fde8f7.html">http://lvxueyang.vip/post/61fde8f7.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://lvxueyang.vip" target="_blank">小肥龙吃大冰淇淋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/">搜索引擎</a><a class="post-meta__tags" href="/tags/Elasticsearch/">Elasticsearch</a></div><div class="post_share"><div class="social-share" data-image="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/b0f534d5.html"><img class="prev-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">ElasticSearch基础</div></div></a></div><div class="next-post pull-right"><a href="/post/5a1f6e0b.html"><img class="next-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">ElasticSearch之深度应用及原理剖析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/7a41cdc3.html" title="ElasticSearch之企业级高可用分布式集群"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">ElasticSearch之企业级高可用分布式集群</div></div></a></div><div><a href="/post/36a0436b.html" title="ElasticSearch之入门使用"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">ElasticSearch之入门使用</div></div></a></div><div><a href="/post/844c8e8e.html" title="ElasticSearch之数据模型构建"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">ElasticSearch之数据模型构建</div></div></a></div><div><a href="/post/b0f534d5.html" title="ElasticSearch基础"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">ElasticSearch基础</div></div></a></div><div><a href="/post/5a1f6e0b.html" title="ElasticSearch之深度应用及原理剖析"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">ElasticSearch之深度应用及原理剖析</div></div></a></div><div><a href="/post/7a4.html" title="ElasticSearch"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">ElasticSearch</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E6%98%A0%E5%B0%84%E9%AB%98%E7%BA%A7"><span class="toc-number">1.</span> <span class="toc-text">1. 映射高级</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%9C%B0%E7%90%86%E5%9D%90%E6%A0%87%E7%82%B9%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 地理坐标点数据类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E5%8A%A8%E6%80%81%E6%98%A0%E5%B0%84"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 动态映射</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8A%A8%E6%80%81%E6%98%A0%E5%B0%84"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 自定义动态映射</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Query-DSL"><span class="toc-number">2.</span> <span class="toc-text">2. Query DSL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89-match-all-query"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 查询所有(match_all query)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2-full-text-query"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 全文搜索(full-text query)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E5%8C%B9%E9%85%8D%E6%90%9C%E7%B4%A2-match-query"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 匹配搜索(match query)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E7%9F%AD%E8%AF%AD%E6%90%9C%E7%B4%A2-match-phrase-query"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 短语搜索(match phrase query)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-query-string-%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3 query_string 查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-%E5%A4%9A%E5%AD%97%E6%AE%B5%E5%8C%B9%E9%85%8D%E6%90%9C%E7%B4%A2-multi-match-query"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.2.4 多字段匹配搜索(multi match query)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E8%AF%8D%E6%9D%A1%E7%BA%A7%E6%90%9C%E7%B4%A2-term-level-queries"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 词条级搜索(term-level queries)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-%E8%AF%8D%E6%9D%A1%E6%90%9C%E7%B4%A2-term-query"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1 词条搜索(term query)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-%E8%AF%8D%E6%9D%A1%E9%9B%86%E5%90%88%E6%90%9C%E7%B4%A2-terms-query"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2 词条集合搜索(terms query)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-%E8%8C%83%E5%9B%B4%E6%90%9C%E7%B4%A2-range-query"><span class="toc-number">2.3.3.</span> <span class="toc-text">2.3.3 范围搜索(range query)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-4-%E4%B8%8D%E4%B8%BA%E7%A9%BA%E6%90%9C%E7%B4%A2-exists-query"><span class="toc-number">2.3.4.</span> <span class="toc-text">2.3.4 不为空搜索(exists query)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-5-%E8%AF%8D%E9%A1%B9%E5%89%8D%E7%BC%80%E6%90%9C%E7%B4%A2-prefifix-query"><span class="toc-number">2.3.5.</span> <span class="toc-text">2.3.5 词项前缀搜索(prefifix query)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-6-%E9%80%9A%E9%85%8D%E7%AC%A6%E6%90%9C%E7%B4%A2-wildcard-query"><span class="toc-number">2.3.6.</span> <span class="toc-text">2.3.6 通配符搜索(wildcard query)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-7-%E6%AD%A3%E5%88%99%E6%90%9C%E7%B4%A2-regexp-query"><span class="toc-number">2.3.7.</span> <span class="toc-text">2.3.7 正则搜索(regexp query)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-8-%E6%A8%A1%E7%B3%8A%E6%90%9C%E7%B4%A2-fuzzy-query"><span class="toc-number">2.3.8.</span> <span class="toc-text">2.3.8 模糊搜索(fuzzy query)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-9-ids%E6%90%9C%E7%B4%A2-id%E9%9B%86%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.3.9.</span> <span class="toc-text">2.3.9 ids搜索(id集合查询)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E5%A4%8D%E5%90%88%E6%90%9C%E7%B4%A2-compound-query"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 复合搜索(compound query)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E6%8E%92%E5%BA%8F"><span class="toc-number">2.5.</span> <span class="toc-text">2.5 排序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-%E5%88%86%E9%A1%B5"><span class="toc-number">2.6.</span> <span class="toc-text">2.6 分页</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-%E9%AB%98%E4%BA%AE"><span class="toc-number">2.7.</span> <span class="toc-text">2.7 高亮</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-8-%E6%96%87%E6%A1%A3%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%EF%BC%88bulk-%E5%92%8C-mget%EF%BC%89"><span class="toc-number">2.8.</span> <span class="toc-text">2.8 文档批量操作（bulk 和 mget）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Filter-DSL"><span class="toc-number">3.</span> <span class="toc-text">3. Filter DSL</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E5%AE%9A%E4%BD%8D%E9%9D%9E%E6%B3%95%E6%90%9C%E7%B4%A2%E5%8F%8A%E5%8E%9F%E5%9B%A0"><span class="toc-number">4.</span> <span class="toc-text">4. 定位非法搜索及原因</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">5. 聚合分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E8%81%9A%E5%90%88%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.1.</span> <span class="toc-text">5.1.聚合介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E6%8C%87%E6%A0%87%E8%81%9A%E5%90%88"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 指标聚合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E6%A1%B6%E8%81%9A%E5%90%88"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 桶聚合</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-Elasticsearch%E9%9B%B6%E5%81%9C%E6%9C%BA%E7%B4%A2%E5%BC%95%E9%87%8D%E5%BB%BA"><span class="toc-number">6.</span> <span class="toc-text">6. Elasticsearch零停机索引重建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E8%AF%B4%E6%98%8E"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E6%96%B9%E6%A1%88%E4%B8%80-%E5%A4%96%E9%83%A8%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5%E6%96%B9%E6%A1%88"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 方案一:外部数据导入方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E6%96%B9%E6%A1%88%E4%BA%8C-%E5%9F%BA%E4%BA%8Escroll-bulk-%E7%B4%A2%E5%BC%95%E5%88%AB%E5%90%8D%E6%96%B9%E6%A1%88"><span class="toc-number">6.3.</span> <span class="toc-text">6.3 方案二:基于scroll+bulk+索引别名方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-%E6%96%B9%E6%A1%88%E4%B8%89-Reindex-API%E6%96%B9%E6%A1%88"><span class="toc-number">6.4.</span> <span class="toc-text">6.4 方案三:Reindex API方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E5%B0%8F%E7%BB%93"><span class="toc-number">6.5.</span> <span class="toc-text">6.5 小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-Elasticsearch-Suggester%E6%99%BA%E8%83%BD%E6%90%9C%E7%B4%A2%E5%BB%BA%E8%AE%AE"><span class="toc-number">7.</span> <span class="toc-text">7. Elasticsearch Suggester智能搜索建议</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-Elasticsearch-Java-Client"><span class="toc-number">8.</span> <span class="toc-text">8. Elasticsearch Java Client</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 小肥龙吃大冰淇淋</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'pinglun-9gh2lmcnd8587831',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'pinglun-9gh2lmcnd8587831',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/hexo-theme-volantis@latest/source/js/issues.min.js"></script><script src="//code.tidio.co/smwivpnwumemac2wohardi3d3gpud1ag.js" async="async"></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>