<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>tomcat启动流程 | 小肥龙吃大冰淇淋</title><meta name="keywords" content="tomcat,服务器"><meta name="author" content="小肥龙吃大冰淇淋"><meta name="copyright" content="小肥龙吃大冰淇淋"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="tomcat启动流程 tomcat源码目录  catalina目录    catalina包含所有的Servlet容器实现，以及涉及到安全、会话、集群、部署管理Servlet容器的各个方面，同时，它还包含了启动入口。  coyote目录    coyote是tomcat链接器框架的名称，是tomcat服务器提供的客户端访问的外部接口，客户端通过Coyote与服务器建立链接、发送请求并接收响应。">
<meta property="og:type" content="article">
<meta property="og:title" content="tomcat启动流程">
<meta property="og:url" content="https://lvxueyangtiger.github.io/post/72c16057.html">
<meta property="og:site_name" content="小肥龙吃大冰淇淋">
<meta property="og:description" content="tomcat启动流程 tomcat源码目录  catalina目录    catalina包含所有的Servlet容器实现，以及涉及到安全、会话、集群、部署管理Servlet容器的各个方面，同时，它还包含了启动入口。  coyote目录    coyote是tomcat链接器框架的名称，是tomcat服务器提供的客户端访问的外部接口，客户端通过Coyote与服务器建立链接、发送请求并接收响应。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082302.jpg">
<meta property="article:published_time" content="2024-05-30T01:10:36.540Z">
<meta property="article:modified_time" content="2022-11-27T09:16:42.475Z">
<meta property="article:author" content="小肥龙吃大冰淇淋">
<meta property="article:tag" content="tomcat">
<meta property="article:tag" content="服务器">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082302.jpg"><link rel="shortcut icon" href="https://lvxueyangboke.oss-cn-beijing.aliyuncs.com/images/20210805191028.png"><link rel="canonical" href="https://lvxueyangtiger.github.io/post/72c16057"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'tomcat启动流程',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-27 17:16:42'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/ali_icon.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mogai.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="小肥龙吃大冰淇淋" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">303</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">108</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">73</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082302.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">小肥龙吃大冰淇淋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">tomcat启动流程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-30T01:10:36.540Z" title="发表于 2024-05-30 09:10:36">2024-05-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-27T09:16:42.475Z" title="更新于 2022-11-27 17:16:42">2022-11-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/%E6%B7%B1%E5%85%A5tomcat/">深入tomcat</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>45分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="tomcat启动流程"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="tomcat启动流程"><a href="#tomcat启动流程" class="headerlink" title="tomcat启动流程"></a>tomcat启动流程</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201121340767.png" alt="img"></p>
<h3 id="tomcat源码目录"><a href="#tomcat源码目录" class="headerlink" title="tomcat源码目录"></a>tomcat源码目录</h3><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201121340830.png" alt="img"></p>
<ul>
<li><p>catalina目录</p>
<p>   catalina包含所有的Servlet容器实现，以及涉及到安全、会话、集群、部署管理Servlet容器的各个方面，同时，它还包含了启动入口。</p>
</li>
<li><p>coyote目录</p>
<p>   coyote是tomcat链接器框架的名称，是tomcat服务器提供的客户端访问的外部接口，客户端通过Coyote与服务器建立链接、发送请求并接收响应。</p>
</li>
<li><p>El目录，提供java表达式语言</p>
</li>
<li><p>Jasper模块提供JSP引擎</p>
</li>
<li><p>Naming模块提供JNDI的服务</p>
</li>
<li><p>Juli提供服务器日志的服务</p>
</li>
<li><p>tomcat提供外部调用的接口api</p>
</li>
</ul>
<h3 id="tomcat启动流程分析"><a href="#tomcat启动流程分析" class="headerlink" title="tomcat启动流程分析"></a>tomcat启动流程分析</h3><ol>
<li><p>启动流程解析：注意是标准的启动，也就是从bin目录下的启动文件中启动tomcat</p>
<p> <img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201121341372.png" alt="img">我们可以看到这个流程非常的清晰，同时注意到，tomcat的启动非常的标准，除去Boostrap和Catalin，我们可以对照一下Server.xml的配置文件。Server,service等等这些组件都是一一对照，同时又有先后顺序。</p>
<p>  基本的顺序是先init方法，然后再start方法。</p>
</li>
<li><p>加入调试信息()：注意是标准的启动，也就是从bin目录下的启动文件中启动tomcat</p>
<p> <img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201121340153.png" alt="img"></p>
</li>
</ol>
<p> 可以看到，在源码中加入调试的信息和流程图是一致的。</p>
<p> 我们可以看到，除了Bootstrap和catalina类，其他的Server,service等等之类的都只是一个接口，实现类均为StandardXXX类。</p>
<p> 我们来看下StandardServer类，</p>
<h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201121340977.png" alt="img"></p>
<p> tomcat主要有两个核心的组件，一个是Connector(连接器)和容器。所谓连接器就是当有HTTP请求到来时，连接器负责接收这个请求，然后将该请求转发到容器。容器有Engine，Host，Context，Wrapper。Engine：表示整个Catalina servlet引擎；Host:表示包含一个或多个Context容器的虚拟主机；Context:表示一个Web应用程序。一个Context可以有多个Wrapper；Wrapper:表示一个独立的servlet。一个容器可以有0个或多个低层级的子容器。例如，一般情况下，一个Context实例会有一个或多个Wrapper实例。一个Host实例中会有0个或多个Context实例。但是，Wrapper类型处于层级结构的最底层，因此，它无法再包含子容器了。</p>
<h4 id="Bootstrap启动类"><a href="#Bootstrap启动类" class="headerlink" title="Bootstrap启动类"></a>Bootstrap启动类</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201121340329.png" alt="img"></p>
<h5 id="main"><a href="#main" class="headerlink" title="main"></a>main</h5><blockquote>
<p>一般启动tomcat会是运行startup.bat或者startup.sh文件，这两个文件最后都会调用，org.apache.catalina.startup包下面Bootstrap类的main方法。main方法具体实现如下：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (daemonLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (daemon == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Don&#x27;t set daemon until init() has completed</span></span><br><span class="line">            <span class="comment">// 在init（）完成之前不要设置守护进程</span></span><br><span class="line">            <span class="comment">// 创建一个Bootstrap对象</span></span><br><span class="line">            Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//调用初始化方法</span></span><br><span class="line">                <span class="comment">// 初始化ClassLoader:</span></span><br><span class="line">                <span class="comment">//      ClassLoader commonLoader = null;</span></span><br><span class="line">                <span class="comment">//      ClassLoader catalinaLoader = null; 绑定到当前线程上</span></span><br><span class="line">                <span class="comment">//      ClassLoader sharedLoader = null;</span></span><br><span class="line">                <span class="comment">// catalinaLoader类加载器创建Catalina实例，赋值给catalinaDaemon</span></span><br><span class="line">                bootstrap.init();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                handleThrowable(t);</span><br><span class="line">                t.printStackTrace();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            daemon = bootstrap;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// When running as a service the call to stop will be on a new</span></span><br><span class="line">            <span class="comment">// thread so make sure the correct class loader is used to</span></span><br><span class="line">            <span class="comment">// prevent a range of class not found exceptions.</span></span><br><span class="line">            <span class="comment">//设置线程的上下文类加载器为 catalinaLoader</span></span><br><span class="line">            Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 默认执行 start 方法</span></span><br><span class="line">        String command = <span class="string">&quot;start&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            command = args[args.length - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (command.equals(<span class="string">&quot;startd&quot;</span>)) &#123;</span><br><span class="line">            args[args.length - <span class="number">1</span>] = <span class="string">&quot;start&quot;</span>;</span><br><span class="line">            daemon.load(args);</span><br><span class="line">            daemon.start();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;stopd&quot;</span>)) &#123;</span><br><span class="line">            args[args.length - <span class="number">1</span>] = <span class="string">&quot;stop&quot;</span>;</span><br><span class="line">            daemon.stop();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;start&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 执行这个位置，【让主线程不退出】</span></span><br><span class="line">            daemon.setAwait(<span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">// 反射调用 catalinaDaemon#load 方法，根据server.xml 创建服务</span></span><br><span class="line">            daemon.load(args);</span><br><span class="line">            <span class="comment">// 反射调用 catalinaDaemon#start 方法，启动服务</span></span><br><span class="line">            daemon.start();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == daemon.getServer()) &#123;</span><br><span class="line">                System.exit(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;stop&quot;</span>)) &#123;</span><br><span class="line">            daemon.stopServer(args);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;configtest&quot;</span>)) &#123;</span><br><span class="line">            daemon.load(args);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == daemon.getServer()) &#123;</span><br><span class="line">                System.exit(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Bootstrap: command \&quot;&quot;</span> + command + <span class="string">&quot;\&quot; does not exist.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="comment">// Unwrap the Exception for clearer error reporting</span></span><br><span class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> InvocationTargetException &amp;&amp;</span><br><span class="line">            t.getCause() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            t = t.getCause();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//处理异常</span></span><br><span class="line">        handleThrowable(t);</span><br><span class="line">        t.printStackTrace();</span><br><span class="line">        System.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> main方法中，首先执行init方法初始化了tomcat自己的类加载器，并通过类加载器创建Catalina实例，然后赋给catalinaDaemon变量，后续操作都使用catalinaDaemon来执行。</p>
<h5 id="setAwait"><a href="#setAwait" class="headerlink" title="setAwait"></a>setAwait</h5><blockquote>
<p>后面默认执行start命令，将调用setAwait(true)，load(args)和start()这三个方法，这三个方法内部都通过反射调用了Catalina的相应方法。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.apache.catalina.startup.Catalina</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAwait</span><span class="params">(<span class="keyword">boolean</span> b)</span> </span>&#123;</span><br><span class="line">    await = b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>setAwait方法用于设置Server启动完成后是否进入等待状态的标志，如果为true则进入，否则不进入。</p>
<h5 id="init"><a href="#init" class="headerlink" title="init"></a>init</h5><blockquote>
<p>main方法先实例化了一个Bootstrap实例，接着调用了init方法。init方法是生命周期方法，以后不再累述。接着看init的具体实现。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Bootsrap--init()&quot;</span>);</span><br><span class="line">    <span class="comment">//类加载器初始化</span></span><br><span class="line">    initClassLoaders();</span><br><span class="line">    <span class="comment">//设置线程的上下文类加载器来解决有可能的ClassNotFoundException问题</span></span><br><span class="line">    Thread.currentThread().setContextClassLoader(catalinaLoader);</span><br><span class="line"></span><br><span class="line">    SecurityClassLoad.securityClassLoad(catalinaLoader);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load our startup class and call its process() method</span></span><br><span class="line">    <span class="comment">// 加载启动类Catalina并调用其process（）方法</span></span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">        log.debug(<span class="string">&quot;Loading startup class&quot;</span>);</span><br><span class="line">    <span class="comment">//加载Catalina类</span></span><br><span class="line">    Class&lt;?&gt; startupClass = catalinaLoader.loadClass(<span class="string">&quot;org.apache.catalina.startup.Catalina&quot;</span>);</span><br><span class="line">    Object startupInstance = startupClass.getConstructor().newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the shared extensions class loader</span></span><br><span class="line">    <span class="comment">// 设置共享扩展类加载器sharedLoader</span></span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">        log.debug(<span class="string">&quot;Setting startup class properties&quot;</span>);</span><br><span class="line">    String methodName = <span class="string">&quot;setParentClassLoader&quot;</span>;</span><br><span class="line">    Class&lt;?&gt; paramTypes[] = <span class="keyword">new</span> Class[<span class="number">1</span>];</span><br><span class="line">    paramTypes[<span class="number">0</span>] = Class.forName(<span class="string">&quot;java.lang.ClassLoader&quot;</span>);</span><br><span class="line">    Object paramValues[] = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">    paramValues[<span class="number">0</span>] = sharedLoader;</span><br><span class="line">    <span class="comment">//通过反射调用setParentClassLoader方法将java.lang.ClassLoader设置为Catalina的父类加载器</span></span><br><span class="line">    Method method =</span><br><span class="line">        startupInstance.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">    <span class="comment">//完成方法调用</span></span><br><span class="line">    method.invoke(startupInstance, paramValues);</span><br><span class="line"></span><br><span class="line">    catalinaDaemon = startupInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="initClassLoaders"><a href="#initClassLoaders" class="headerlink" title="initClassLoaders"></a>initClassLoaders</h5><blockquote>
<p>init方法，先初始化了类加载器。initClassLoaders方法具体实现如下：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//初始化三个类加载器以及确定父子关系</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initClassLoaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// commonLoader的加载路径为common.loader</span></span><br><span class="line">        commonLoader = createClassLoader(<span class="string">&quot;common&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (commonLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// no config file, default to this loader - we might be in a &#x27;single&#x27; env.</span></span><br><span class="line">            commonLoader = <span class="keyword">this</span>.getClass().getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 加载路径为server.loader，默认为空，父类加载器为commonLoader</span></span><br><span class="line">        catalinaLoader = createClassLoader(<span class="string">&quot;server&quot;</span>, commonLoader);</span><br><span class="line">        <span class="comment">// 加载路径为shared.loader，默认为空，父类加载器为commonLoader</span></span><br><span class="line">        sharedLoader = createClassLoader(<span class="string">&quot;shared&quot;</span>, commonLoader);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        handleThrowable(t);</span><br><span class="line">        log.error(<span class="string">&quot;Class loader creation threw exception&quot;</span>, t);</span><br><span class="line">        System.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="createClassLoader"><a href="#createClassLoader" class="headerlink" title="createClassLoader"></a>createClassLoader</h5><blockquote>
<p>createClassLoader是通过工厂模式创建类加载器，从conf目录中的catalina.properties属性文件中读取配置来设置某一个类加载器加载那些jar包的文件</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//创建类加载器</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> ClassLoader <span class="title">createClassLoader</span><span class="params">(String name, ClassLoader parent)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// catalinaLoader与sharedLoader的加载路径均为空，所以直接返回commonLoader对象，默认3者为同一个对象</span></span><br><span class="line">    String value = CatalinaProperties.getProperty(name + <span class="string">&quot;.loader&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((value == <span class="keyword">null</span>) || (value.equals(<span class="string">&quot;&quot;</span>)))</span><br><span class="line">        <span class="keyword">return</span> parent;</span><br><span class="line"></span><br><span class="line">    value = replace(value);</span><br><span class="line"></span><br><span class="line">    List&lt;Repository&gt; repositories = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    String[] repositoryPaths = getPaths(value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (String repository : repositoryPaths) &#123;</span><br><span class="line">        <span class="comment">// Check for a JAR URL repository</span></span><br><span class="line">        <span class="comment">//  检查一个jar的URL仓库</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unused&quot;)</span></span><br><span class="line">            URL url = <span class="keyword">new</span> URL(repository);</span><br><span class="line">            repositories.add(<span class="keyword">new</span> Repository(repository, RepositoryType.URL));</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">            <span class="comment">// Ignore</span></span><br><span class="line">            <span class="comment">//为了防止因为一个jar的加载失败导致整个系统启动失败所以吞掉异常</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Local repository</span></span><br><span class="line">        <span class="comment">// 本地仓库 jar</span></span><br><span class="line">        <span class="keyword">if</span> (repository.endsWith(<span class="string">&quot;*.jar&quot;</span>)) &#123;</span><br><span class="line">            repository = repository.substring</span><br><span class="line">                (<span class="number">0</span>, repository.length() - <span class="string">&quot;*.jar&quot;</span>.length());</span><br><span class="line">            repositories.add(<span class="keyword">new</span> Repository(repository, RepositoryType.GLOB));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (repository.endsWith(<span class="string">&quot;.jar&quot;</span>)) &#123;</span><br><span class="line">            repositories.add(<span class="keyword">new</span> Repository(repository, RepositoryType.JAR));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            repositories.add(<span class="keyword">new</span> Repository(repository, RepositoryType.DIR));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//通过工厂模式创建类加载器</span></span><br><span class="line">    <span class="keyword">return</span> ClassLoaderFactory.createClassLoader(repositories, parent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> createClassLoader需要传入一个父加载器。从具体的代码中可以看出，commonLoader类加载器是catalinaLoader类加载器和sharedLoader类加载器的父加载器。初始化完类加载器后，使用反射机制调用org.apache.catalina.startup.Catalina类下的setParentClassLoader方法。具体代码是:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Load our startup class and call its process() method</span></span><br><span class="line">    <span class="comment">// 加载启动类Catalina并调用其process（）方法</span></span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">        log.debug(<span class="string">&quot;Loading startup class&quot;</span>);</span><br><span class="line">    <span class="comment">//加载Catalina类</span></span><br><span class="line">    Class&lt;?&gt; startupClass = catalinaLoader.loadClass(<span class="string">&quot;org.apache.catalina.startup.Catalina&quot;</span>);</span><br><span class="line">    Object startupInstance = startupClass.getConstructor().newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the shared extensions class loader</span></span><br><span class="line">    <span class="comment">// 设置共享扩展类加载器sharedLoader</span></span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">        log.debug(<span class="string">&quot;Setting startup class properties&quot;</span>);</span><br><span class="line">    String methodName = <span class="string">&quot;setParentClassLoader&quot;</span>;</span><br><span class="line">    Class&lt;?&gt; paramTypes[] = <span class="keyword">new</span> Class[<span class="number">1</span>];</span><br><span class="line">    paramTypes[<span class="number">0</span>] = Class.forName(<span class="string">&quot;java.lang.ClassLoader&quot;</span>);</span><br><span class="line">    Object paramValues[] = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">    paramValues[<span class="number">0</span>] = sharedLoader;</span><br><span class="line">    <span class="comment">//通过反射调用setParentClassLoader方法将java.lang.ClassLoader设置为Catalina的父类加载器</span></span><br><span class="line">    Method method =</span><br><span class="line">        startupInstance.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">    <span class="comment">//完成方法调用</span></span><br><span class="line">    method.invoke(startupInstance, paramValues);</span><br></pre></td></tr></table></figure>

<p>因为tomcat执行的是start操作，调用完init方法后，会执行load方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (command.equals(<span class="string">&quot;startd&quot;</span>)) &#123;</span><br><span class="line">    args[args.length - <span class="number">1</span>] = <span class="string">&quot;start&quot;</span>;</span><br><span class="line">    daemon.load(args);</span><br><span class="line">    daemon.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="load"><a href="#load" class="headerlink" title="load"></a>load</h5><blockquote>
<p>load方法通过反射调用Catalina类的load方法。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(String[] arguments)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Bootsrap--load()&quot;</span>);</span><br><span class="line">    <span class="comment">// Call the load() method</span></span><br><span class="line">    String methodName = <span class="string">&quot;load&quot;</span>;</span><br><span class="line">    Object param[];</span><br><span class="line">    Class&lt;?&gt; paramTypes[];</span><br><span class="line">    <span class="keyword">if</span> (arguments == <span class="keyword">null</span> || arguments.length == <span class="number">0</span>) &#123;</span><br><span class="line">        paramTypes = <span class="keyword">null</span>;</span><br><span class="line">        param = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        paramTypes = <span class="keyword">new</span> Class[<span class="number">1</span>];</span><br><span class="line">        paramTypes[<span class="number">0</span>] = arguments.getClass();</span><br><span class="line">        param = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">        param[<span class="number">0</span>] = arguments;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取catalina类的load方法</span></span><br><span class="line">    Method method =</span><br><span class="line">        catalinaDaemon.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;Calling startup class &quot;</span> + method);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//通过反射完成调用</span></span><br><span class="line">    method.invoke(catalinaDaemon, param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Catalina"><a href="#Catalina" class="headerlink" title="Catalina"></a>Catalina</h4><p>Catalina 的主要任务就是创建 Server，它不是直接 new 一个 Server 实例就完事了，而是需要解析 server.xml，把在 server.xml 里配置的各种组件一一创建出来，接着调用 Server 组件的 init 方法和 start 方法，这样整个 tomcat 就启动起来了。作为“管理者”，Catalina 还需要处理各种“异常”情况，比如当我们通过“Ctrl + C”关闭 tomcat 时，tomcat 将如何优雅的停止并且清理资源呢？因此 Catalina 在 JVM 中注册一个“关闭钩子”。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201121340195.png" alt="img"></p>
<h5 id="load-1"><a href="#load-1" class="headerlink" title="load"></a>load</h5><blockquote>
<p>Catalina的load方法根据conf/server.xml创建了Server对象，并赋值给server属性（具体是通过开源项目Digester完成的），然后调用了server的init方法。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       System.out.println(<span class="string">&quot;Catalina--load()&quot;</span>);</span><br><span class="line">       <span class="comment">// 已经加载就返回</span></span><br><span class="line">       <span class="keyword">if</span> (loaded) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 设置加载状态</span></span><br><span class="line">       loaded = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line">       <span class="comment">//初始化一些临时文件夹</span></span><br><span class="line">       initDirs();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Before digester - it may be needed</span></span><br><span class="line">       <span class="comment">//初始化JNDI服务</span></span><br><span class="line">       initNaming();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Create and execute our Digester</span></span><br><span class="line">       <span class="comment">// 通过 digester 解析 server.xml 配置文件</span></span><br><span class="line">       <span class="comment">//创建并执行Digester来读取conf/server.xml文件</span></span><br><span class="line">       Digester digester = createStartDigester();</span><br><span class="line"></span><br><span class="line">       InputSource inputSource = <span class="keyword">null</span>;</span><br><span class="line">       InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">       File file = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">// 默认指定了 conf/server.xml</span></span><br><span class="line">               file = configFile();</span><br><span class="line">               inputStream = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">               inputSource = <span class="keyword">new</span> InputSource(file.toURI().toURL().toString());</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                   log.debug(sm.getString(<span class="string">&quot;catalina.configFail&quot;</span>, file), e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//读取conf/server.xml的数据</span></span><br><span class="line">           <span class="keyword">if</span> (inputStream == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   inputStream = getClass().getClassLoader()</span><br><span class="line">                       .getResourceAsStream(getConfigFile());</span><br><span class="line">                   inputSource = <span class="keyword">new</span> InputSource</span><br><span class="line">                       (getClass().getClassLoader()</span><br><span class="line">                        .getResource(getConfigFile()).toString());</span><br><span class="line">               &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                       log.debug(sm.getString(<span class="string">&quot;catalina.configFail&quot;</span>,</span><br><span class="line">                               getConfigFile()), e);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// This should be included in catalina.jar</span></span><br><span class="line">           <span class="comment">// Alternative: don&#x27;t bother with xml, just create it manually.</span></span><br><span class="line">           <span class="keyword">if</span> (inputStream == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="comment">// 尝试加载 server-embed.xml</span></span><br><span class="line">                   inputStream = getClass().getClassLoader()</span><br><span class="line">                           .getResourceAsStream(<span class="string">&quot;server-embed.xml&quot;</span>);</span><br><span class="line">                   inputSource = <span class="keyword">new</span> InputSource</span><br><span class="line">                   (getClass().getClassLoader()</span><br><span class="line">                           .getResource(<span class="string">&quot;server-embed.xml&quot;</span>).toString());</span><br><span class="line">               &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                       log.debug(sm.getString(<span class="string">&quot;catalina.configFail&quot;</span>,</span><br><span class="line">                               <span class="string">&quot;server-embed.xml&quot;</span>), e);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 依旧找不到文件，返回</span></span><br><span class="line">           <span class="keyword">if</span> (inputStream == <span class="keyword">null</span> || inputSource == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span>  (file == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   log.warn(sm.getString(<span class="string">&quot;catalina.configFail&quot;</span>,</span><br><span class="line">                           getConfigFile() + <span class="string">&quot;] or [server-embed.xml]&quot;</span>));</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   log.warn(sm.getString(<span class="string">&quot;catalina.configFail&quot;</span>,</span><br><span class="line">                           file.getAbsolutePath()));</span><br><span class="line">                   <span class="keyword">if</span> (file.exists() &amp;&amp; !file.canRead()) &#123;</span><br><span class="line">                       log.warn(<span class="string">&quot;Permissions incorrect, read permission is not allowed on the file.&quot;</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               inputSource.setByteStream(inputStream);</span><br><span class="line">               digester.push(<span class="keyword">this</span>);</span><br><span class="line">               <span class="comment">// 解析 xml</span></span><br><span class="line">               digester.parse(inputSource);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (SAXParseException spe) &#123;</span><br><span class="line">               log.warn(<span class="string">&quot;Catalina.start using &quot;</span> + getConfigFile() + <span class="string">&quot;: &quot;</span> +</span><br><span class="line">                       spe.getMessage());</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               log.warn(<span class="string">&quot;Catalina.start using &quot;</span> + getConfigFile() + <span class="string">&quot;: &quot;</span> , e);</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   inputStream.close();</span><br><span class="line">               &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                   <span class="comment">// Ignore</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 在 static中定义，</span></span><br><span class="line">       <span class="comment">//获取server类完成一些设置</span></span><br><span class="line">       getServer().setCatalina(<span class="keyword">this</span>);</span><br><span class="line">       getServer().setCatalinaHome(Bootstrap.getCatalinaHomeFile());</span><br><span class="line">       getServer().setCatalinaBase(Bootstrap.getCatalinaBaseFile());</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Stream redirection</span></span><br><span class="line">       initStreams();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Start the new server</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 创建 Server</span></span><br><span class="line">           <span class="comment">//经过Digester这里的Server已经是StandardServer ,但是StandardServer类中没有init方法</span></span><br><span class="line">           getServer().init();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">           <span class="keyword">if</span> (Boolean.getBoolean(<span class="string">&quot;org.apache.catalina.startup.EXIT_ON_INIT_FAILURE&quot;</span>)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> java.lang.Error(e);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               log.error(<span class="string">&quot;Catalina.start&quot;</span>, e);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">long</span> t2 = System.nanoTime();</span><br><span class="line">       <span class="keyword">if</span>(log.isInfoEnabled()) &#123;</span><br><span class="line">           log.info(<span class="string">&quot;Initialization processed in &quot;</span> + ((t2 - t1) / <span class="number">1000000</span>) + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h5 id="createStartDigester"><a href="#createStartDigester" class="headerlink" title="createStartDigester"></a>createStartDigester</h5><blockquote>
<p>load方法中比较重要的方法是createStartDigester()，createStartDigester方法主要的作用就是帮我们实例化了所有的服务组件包括server,service和connect。具体的实例化方法</p>
<p>Digester 查相关资料：Java解析xml主要由DOM4J（一次读取到内存并解析）、SAX（一次解析一部分），digester本身采用SAX的解析方式，并提供了一层包装，对使用者更加友好，后来独立出来成为apache的Commons下面的<a target="_blank" rel="noopener" href="http://commons.apache.org/proper/commons-digester/">一个单独的子项目</a>。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Digester <span class="title">createStartDigester</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> t1=System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// Initialize the digester</span></span><br><span class="line">    Digester digester = <span class="keyword">new</span> Digester();</span><br><span class="line">    digester.setValidating(<span class="keyword">false</span>);</span><br><span class="line">    digester.setRulesValidation(<span class="keyword">true</span>);</span><br><span class="line">    Map&lt;Class&lt;?&gt;, List&lt;String&gt;&gt; fakeAttributes = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; objectAttrs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    objectAttrs.add(<span class="string">&quot;className&quot;</span>);</span><br><span class="line">    fakeAttributes.put(Object.class, objectAttrs);</span><br><span class="line">    <span class="comment">// Ignore attribute added by Eclipse for its internal tracking</span></span><br><span class="line">    List&lt;String&gt; contextAttrs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    contextAttrs.add(<span class="string">&quot;source&quot;</span>);</span><br><span class="line">    fakeAttributes.put(StandardContext.class, contextAttrs);</span><br><span class="line">    digester.setFakeAttributes(fakeAttributes);</span><br><span class="line">    digester.setUseContextClassLoader(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Configure the actions we will be using</span></span><br><span class="line">    digester.addObjectCreate(<span class="string">&quot;Server&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;org.apache.catalina.core.StandardServer&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;className&quot;</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">&quot;Server&quot;</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">&quot;Server&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;setServer&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;org.apache.catalina.Server&quot;</span>);</span><br><span class="line"></span><br><span class="line">    digester.addObjectCreate(<span class="string">&quot;Server/GlobalNamingResources&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;org.apache.catalina.deploy.NamingResourcesImpl&quot;</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">&quot;Server/GlobalNamingResources&quot;</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">&quot;Server/GlobalNamingResources&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;setGlobalNamingResources&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;org.apache.catalina.deploy.NamingResourcesImpl&quot;</span>);</span><br><span class="line"></span><br><span class="line">    digester.addObjectCreate(<span class="string">&quot;Server/Listener&quot;</span>,</span><br><span class="line">                             <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                             <span class="string">&quot;className&quot;</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">&quot;Server/Listener&quot;</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">&quot;Server/Listener&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;addLifecycleListener&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;org.apache.catalina.LifecycleListener&quot;</span>);</span><br><span class="line"></span><br><span class="line">    digester.addObjectCreate(<span class="string">&quot;Server/Service&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;org.apache.catalina.core.StandardService&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;className&quot;</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">&quot;Server/Service&quot;</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">&quot;Server/Service&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;addService&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;org.apache.catalina.Service&quot;</span>);</span><br><span class="line"></span><br><span class="line">    digester.addObjectCreate(<span class="string">&quot;Server/Service/Listener&quot;</span>,</span><br><span class="line">                             <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                             <span class="string">&quot;className&quot;</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">&quot;Server/Service/Listener&quot;</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">&quot;Server/Service/Listener&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;addLifecycleListener&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;org.apache.catalina.LifecycleListener&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Executor</span></span><br><span class="line">    digester.addObjectCreate(<span class="string">&quot;Server/Service/Executor&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;org.apache.catalina.core.StandardThreadExecutor&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;className&quot;</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">&quot;Server/Service/Executor&quot;</span>);</span><br><span class="line"></span><br><span class="line">    digester.addSetNext(<span class="string">&quot;Server/Service/Executor&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;addExecutor&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;org.apache.catalina.Executor&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    digester.addRule(<span class="string">&quot;Server/Service/Connector&quot;</span>,</span><br><span class="line">                     <span class="keyword">new</span> ConnectorCreateRule());</span><br><span class="line">    digester.addRule(<span class="string">&quot;Server/Service/Connector&quot;</span>,</span><br><span class="line">                     <span class="keyword">new</span> SetAllPropertiesRule(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;executor&quot;</span>, <span class="string">&quot;sslImplementationName&quot;</span>&#125;));</span><br><span class="line">    digester.addSetNext(<span class="string">&quot;Server/Service/Connector&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;addConnector&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;org.apache.catalina.connector.Connector&quot;</span>);</span><br><span class="line"></span><br><span class="line">    digester.addObjectCreate(<span class="string">&quot;Server/Service/Connector/SSLHostConfig&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;org.apache.tomcat.util.net.SSLHostConfig&quot;</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">&quot;Server/Service/Connector/SSLHostConfig&quot;</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">&quot;Server/Service/Connector/SSLHostConfig&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;addSslHostConfig&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;org.apache.tomcat.util.net.SSLHostConfig&quot;</span>);</span><br><span class="line"></span><br><span class="line">    digester.addRule(<span class="string">&quot;Server/Service/Connector/SSLHostConfig/Certificate&quot;</span>,</span><br><span class="line">                     <span class="keyword">new</span> CertificateCreateRule());</span><br><span class="line">    digester.addRule(<span class="string">&quot;Server/Service/Connector/SSLHostConfig/Certificate&quot;</span>,</span><br><span class="line">                     <span class="keyword">new</span> SetAllPropertiesRule(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;type&quot;</span>&#125;));</span><br><span class="line">    digester.addSetNext(<span class="string">&quot;Server/Service/Connector/SSLHostConfig/Certificate&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;addCertificate&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;org.apache.tomcat.util.net.SSLHostConfigCertificate&quot;</span>);</span><br><span class="line"></span><br><span class="line">    digester.addObjectCreate(<span class="string">&quot;Server/Service/Connector/SSLHostConfig/OpenSSLConf&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;org.apache.tomcat.util.net.openssl.OpenSSLConf&quot;</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">&quot;Server/Service/Connector/SSLHostConfig/OpenSSLConf&quot;</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">&quot;Server/Service/Connector/SSLHostConfig/OpenSSLConf&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;setOpenSslConf&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;org.apache.tomcat.util.net.openssl.OpenSSLConf&quot;</span>);</span><br><span class="line"></span><br><span class="line">    digester.addObjectCreate(<span class="string">&quot;Server/Service/Connector/SSLHostConfig/OpenSSLConf/OpenSSLConfCmd&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;org.apache.tomcat.util.net.openssl.OpenSSLConfCmd&quot;</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">&quot;Server/Service/Connector/SSLHostConfig/OpenSSLConf/OpenSSLConfCmd&quot;</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">&quot;Server/Service/Connector/SSLHostConfig/OpenSSLConf/OpenSSLConfCmd&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;addCmd&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;org.apache.tomcat.util.net.openssl.OpenSSLConfCmd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    digester.addObjectCreate(<span class="string">&quot;Server/Service/Connector/Listener&quot;</span>,</span><br><span class="line">                             <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                             <span class="string">&quot;className&quot;</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">&quot;Server/Service/Connector/Listener&quot;</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">&quot;Server/Service/Connector/Listener&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;addLifecycleListener&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;org.apache.catalina.LifecycleListener&quot;</span>);</span><br><span class="line"></span><br><span class="line">    digester.addObjectCreate(<span class="string">&quot;Server/Service/Connector/UpgradeProtocol&quot;</span>,</span><br><span class="line">                             <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></span><br><span class="line">                             <span class="string">&quot;className&quot;</span>);</span><br><span class="line">    digester.addSetProperties(<span class="string">&quot;Server/Service/Connector/UpgradeProtocol&quot;</span>);</span><br><span class="line">    digester.addSetNext(<span class="string">&quot;Server/Service/Connector/UpgradeProtocol&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;addUpgradeProtocol&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;org.apache.coyote.UpgradeProtocol&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add RuleSets for nested elements</span></span><br><span class="line">    digester.addRuleSet(<span class="keyword">new</span> NamingRuleSet(<span class="string">&quot;Server/GlobalNamingResources/&quot;</span>));</span><br><span class="line">    digester.addRuleSet(<span class="keyword">new</span> EngineRuleSet(<span class="string">&quot;Server/Service/&quot;</span>));</span><br><span class="line">    digester.addRuleSet(<span class="keyword">new</span> HostRuleSet(<span class="string">&quot;Server/Service/Engine/&quot;</span>));</span><br><span class="line">    digester.addRuleSet(<span class="keyword">new</span> ContextRuleSet(<span class="string">&quot;Server/Service/Engine/Host/&quot;</span>));</span><br><span class="line">    addClusterRuleSet(digester, <span class="string">&quot;Server/Service/Engine/Host/Cluster/&quot;</span>);</span><br><span class="line">    digester.addRuleSet(<span class="keyword">new</span> NamingRuleSet(<span class="string">&quot;Server/Service/Engine/Host/Context/&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When the &#x27;engine&#x27; is found, set the parentClassLoader.</span></span><br><span class="line">    digester.addRule(<span class="string">&quot;Server/Service/Engine&quot;</span>,</span><br><span class="line">                     <span class="keyword">new</span> SetParentClassLoaderRule(parentClassLoader));</span><br><span class="line">    addClusterRuleSet(digester, <span class="string">&quot;Server/Service/Engine/Cluster/&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> t2=System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;Digester for server.xml created &quot;</span> + ( t2-t1 ));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> digester;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="start"><a href="#start" class="headerlink" title="start"></a>start</h5><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201121340624.png" alt="img"></p>
<blockquote>
<p>初始化操作完成后，接下来会执行catalina实例的start方法。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Catalina--start()&quot;</span>);</span><br><span class="line">    <span class="comment">// 1. 如果持有的 Server 实例为空，就解析 server.xml 创建出来</span></span><br><span class="line">    <span class="keyword">if</span> (getServer() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        load();</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 2. 如果创建失败，报错退出</span></span><br><span class="line">    <span class="keyword">if</span> (getServer() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        log.fatal(<span class="string">&quot;Cannot start server. Server instance is not configured.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start the new server</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 调用Server的start方法启动服务器</span></span><br><span class="line">        getServer().start();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">        log.fatal(sm.getString(<span class="string">&quot;catalina.serverStartFail&quot;</span>), e);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            getServer().destroy();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LifecycleException e1) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;destroy() failed for failed Server &quot;</span>, e1);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> t2 = System.nanoTime();</span><br><span class="line">    <span class="keyword">if</span>(log.isInfoEnabled()) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;Server startup in &quot;</span> + ((t2 - t1) / <span class="number">1000000</span>) + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register shutdown hook</span></span><br><span class="line">    <span class="comment">// 注册 关闭 钩子方法</span></span><br><span class="line">    <span class="keyword">if</span> (useShutdownHook) &#123;</span><br><span class="line">        <span class="keyword">if</span> (shutdownHook == <span class="keyword">null</span>) &#123;</span><br><span class="line">            shutdownHook = <span class="keyword">new</span> CatalinaShutdownHook();</span><br><span class="line">        &#125;</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(shutdownHook);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If JULI is being used, disable JULI&#x27;s shutdown hook since</span></span><br><span class="line">        <span class="comment">// shutdown hooks run in parallel and log messages may be lost</span></span><br><span class="line">        <span class="comment">// if JULI&#x27;s hook completes before the CatalinaShutdownHook()</span></span><br><span class="line">        LogManager logManager = LogManager.getLogManager();</span><br><span class="line">        <span class="keyword">if</span> (logManager <span class="keyword">instanceof</span> ClassLoaderLogManager) &#123;</span><br><span class="line">            ((ClassLoaderLogManager) logManager).setUseShutdownHook(</span><br><span class="line">                <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 此处判断 主线程是否await</span></span><br><span class="line">    <span class="keyword">if</span> (await) &#123;</span><br><span class="line">        <span class="comment">// 在 StandardServer 中调用，用来监听 8005 端口，</span></span><br><span class="line">        <span class="comment">// 收到 SHUTDOWN 命令关闭 Server</span></span><br><span class="line">        await();</span><br><span class="line">        stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那什么是“关闭钩子”，它又是做什么的呢？如果我们需要在 JVM 关闭时做一些清理工作，比如将缓存数据刷到磁盘上，或者清理一些临时文件，可以向 JVM 注册一个“关闭钩子”。“关闭钩子”其实就是一个线程，JVM 在停止之前会尝试执行这个线程的 run 方法。下面我们来看看 tomcat 的“关闭钩子”CatalinaShutdownHook 做了些什么。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">CatalinaShutdownHook</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (getServer() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Catalina.<span class="keyword">this</span>.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">           ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从这段代码中你可以看到，tomcat 的“关闭钩子”实际上就执行了 Server 的 stop 方法，Server 的 stop 方法会释放和清理所有的资源。</p>
<h4 id="StandardServer"><a href="#StandardServer" class="headerlink" title="StandardServer"></a>StandardServer</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201121340041.png" alt="img"></p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201121341912.png" alt="img"></p>
<blockquote>
<p>从上面加载的组件中，tomcat会默认加载org.apache.catalina.core.StandardServer作为Server的实例类。</p>
</blockquote>
<h5 id="addService"><a href="#addService" class="headerlink" title="addService"></a>addService</h5><p>Server 组件的具体实现类是 StandardServer。Server 继承了 LifeCycleBase，它的生命周期被统一管理，并且它的子组件是 Service，因此它还需要管理 Service 的生命周期，也就是说在启动时调用 Service 组件的启动方法，在停止时调用它们的停止方法。Server 在内部维护了若干 Service 组件，它是以数组来保存的，那 Server 是如何添加一个 Service 到数组中的呢？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addService</span><span class="params">(Service service)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    service.setServer(<span class="keyword">this</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">synchronized</span> (servicesLock) &#123;</span><br><span class="line">        <span class="comment">// 创建一个长度 +1 的新数组</span></span><br><span class="line">        Service results[] = <span class="keyword">new</span> Service[services.length + <span class="number">1</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将老的数据复制过去</span></span><br><span class="line">        System.arraycopy(services, <span class="number">0</span>, results, <span class="number">0</span>, services.length);</span><br><span class="line">        results[services.length] = service;</span><br><span class="line">        services = results;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 启动 Service 组件</span></span><br><span class="line">        <span class="keyword">if</span> (getState().isAvailable()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                service.start();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">                <span class="comment">// Ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 触发监听事件</span></span><br><span class="line">        support.firePropertyChange(<span class="string">&quot;service&quot;</span>, <span class="keyword">null</span>, service);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的代码你能看到，它并没有一开始就分配一个很长的数组，而是在添加的过程中动态地扩展数组长度，当添加一个新的 Service 实例时，会创建一个新数组并把原来数组内容复制到新数组，这样做的目的其实是为了节省内存空间。</p>
<h5 id="initInternal"><a href="#initInternal" class="headerlink" title="initInternal"></a>initInternal</h5><blockquote>
<p>因为StandardServer使用了Lifecycle生命周期管理，调用init会调用到LifecycleBase的init方法，并会调用到StandardServer的initInternal方法。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">super</span>.initInternal();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register global String cache</span></span><br><span class="line">    <span class="comment">// Note although the cache is global, if there are multiple Servers</span></span><br><span class="line">    <span class="comment">// present in the JVM (may happen when embedding) then the same cache</span></span><br><span class="line">    <span class="comment">// will be registered under multiple names</span></span><br><span class="line">    <span class="comment">// 注册全局 String cache</span></span><br><span class="line">    onameStringCache = register(<span class="keyword">new</span> StringCache(), <span class="string">&quot;type=StringCache&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register the MBeanFactory</span></span><br><span class="line">    <span class="comment">// 注册 MBeanFactory</span></span><br><span class="line">    MBeanFactory factory = <span class="keyword">new</span> MBeanFactory();</span><br><span class="line">    factory.setContainer(<span class="keyword">this</span>);</span><br><span class="line">    onameMBeanFactory = register(factory, <span class="string">&quot;type=MBeanFactory&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register the naming resources</span></span><br><span class="line">    <span class="comment">// 注册命名资源</span></span><br><span class="line">    globalNamingResources.init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Populate the extension validator with JARs from common and shared</span></span><br><span class="line">    <span class="comment">// class loaders</span></span><br><span class="line">    <span class="keyword">if</span> (getCatalina() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ClassLoader cl = getCatalina().getParentClassLoader();</span><br><span class="line">        <span class="comment">// Walk the class loader hierarchy. Stop at the system class loader.</span></span><br><span class="line">        <span class="comment">// This will add the shared (if present) and common class loaders</span></span><br><span class="line">        <span class="keyword">while</span> (cl != <span class="keyword">null</span> &amp;&amp; cl != ClassLoader.getSystemClassLoader()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cl <span class="keyword">instanceof</span> URLClassLoader) &#123;</span><br><span class="line">                URL[] urls = ((URLClassLoader) cl).getURLs();</span><br><span class="line">                <span class="keyword">for</span> (URL url : urls) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (url.getProtocol().equals(<span class="string">&quot;file&quot;</span>)) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            File f = <span class="keyword">new</span> File (url.toURI());</span><br><span class="line">                            <span class="keyword">if</span> (f.isFile() &amp;&amp;</span><br><span class="line">                                f.getName().endsWith(<span class="string">&quot;.jar&quot;</span>)) &#123;</span><br><span class="line">                                ExtensionValidator.addSystemResource(f);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">                            <span class="comment">// Ignore</span></span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            <span class="comment">// Ignore</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            cl = cl.getParent();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Initialize our defined Services</span></span><br><span class="line">    <span class="comment">// 初始化定义的所有 Service</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</span><br><span class="line">        services[i].init();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="startInternal"><a href="#startInternal" class="headerlink" title="startInternal"></a>startInternal</h5><blockquote>
<p>因为StandardServer使用了Lifecycle生命周期管理，调用start会调用到LifecycleBase的start方法，并会调用到StandardServer的startInternal方法。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置状态</span></span><br><span class="line">    fireLifecycleEvent(CONFIGURE_START_EVENT, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// 触发事件</span></span><br><span class="line">    setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">    globalNamingResources.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start our defined Services</span></span><br><span class="line">    <span class="comment">//启动所有的service</span></span><br><span class="line">    <span class="keyword">synchronized</span> (servicesLock) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</span><br><span class="line">            services[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="await"><a href="#await" class="headerlink" title="await"></a>await</h5><p>在 await 方法里会创建一个 Socket 监听 8005 端口，并在一个死循环里接收 Socket 上的连接请求，如果有新的连接到来就建立连接，然后从 Socket 中读取数据；如果读到的数据是停止命令“SHUTDOWN”，就退出循环，进入 stop 流程。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// port 默认 8005</span></span><br><span class="line">        awaitSocket = <span class="keyword">new</span> ServerSocket(port, <span class="number">1</span>,</span><br><span class="line">                     InetAddress.getByName(address));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 匹配 SHUTDOWN 命令，用来关闭服务器</span></span><br><span class="line">    <span class="keyword">boolean</span> match = command.toString().equals(shutdown);</span><br><span class="line">    <span class="keyword">if</span> (match) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ServerSocket serverSocket = awaitSocket;</span><br><span class="line">    awaitThread = <span class="keyword">null</span>;</span><br><span class="line">    awaitSocket = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭Server socket并返回</span></span><br><span class="line">    <span class="keyword">if</span> (serverSocket != <span class="keyword">null</span>) &#123;</span><br><span class="line">        serverSocket.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="StandardService"><a href="#StandardService" class="headerlink" title="StandardService"></a>StandardService</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201121341481.png" alt="img"></p>
<p>Service 组件的具体实现类是 StandardService，我们先来看看它的定义以及关键的成员变量。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardService</span> <span class="keyword">extends</span> <span class="title">LifecycleBase</span> <span class="keyword">implements</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 名字</span></span><br><span class="line">    <span class="keyword">private</span> String name = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Server 实例</span></span><br><span class="line">    <span class="keyword">private</span> Server server = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 连接器数组</span></span><br><span class="line">    <span class="keyword">protected</span> Connector connectors[] = <span class="keyword">new</span> Connector[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object connectorsLock = <span class="keyword">new</span> Object();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 对应的 Engine 容器</span></span><br><span class="line">    <span class="keyword">private</span> Engine engine = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 映射器及其监听器</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Mapper mapper = <span class="keyword">new</span> Mapper();</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> MapperListener mapperListener = <span class="keyword">new</span> MapperListener(<span class="keyword">this</span>);</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>

<p>StandardService 继承了 LifecycleBase 抽象类，此外 StandardService 中还有一些我们熟悉的组件，比如 Server、Connector、Engine 和 Mapper。</p>
<p>那为什么还有一个 MapperListener？这是因为 tomcat 支持热部署，当 Web 应用的部署发生变化时，Mapper 中的映射信息也要跟着变化，MapperListener 就是一个监听器，它监听容器的变化，并把信息更新到 Mapper 中，这是典型的观察者模式。</p>
<p>作为“管理”角色的组件，最重要的是维护其他组件的生命周期。此外在启动各种组件时，要注意它们的依赖关系，也就是说，要注意启动的顺序。</p>
<h5 id="initInternal-1"><a href="#initInternal-1" class="headerlink" title="initInternal"></a>initInternal</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">super</span>.initInternal();</span><br><span class="line">    <span class="comment">// Engine初始化，一个Service对应一个Engine</span></span><br><span class="line">    <span class="keyword">if</span> (engine != <span class="keyword">null</span>) &#123;</span><br><span class="line">        engine.init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize any Executors</span></span><br><span class="line">    <span class="comment">// 初始化Executor，默认 不会执行</span></span><br><span class="line">    <span class="keyword">for</span> (Executor executor : findExecutors()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (executor <span class="keyword">instanceof</span> JmxEnabled) &#123;</span><br><span class="line">            ((JmxEnabled) executor).setDomain(getDomain());</span><br><span class="line">        &#125;</span><br><span class="line">        executor.init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize mapper listener</span></span><br><span class="line">    <span class="comment">// 初始化 MapperListener , 默认 LifecycleMBeanBase.java</span></span><br><span class="line">    mapperListener.init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize our defined Connectors</span></span><br><span class="line">    <span class="comment">// 初始化 Connector，server.xml 配置的 Connector</span></span><br><span class="line">    <span class="keyword">synchronized</span> (connectorsLock) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Connector connector : connectors) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connector.init();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                String message = sm.getString(</span><br><span class="line">                    <span class="string">&quot;standardService.connector.initFailed&quot;</span>, connector);</span><br><span class="line">                log.error(message, e);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (Boolean.getBoolean(<span class="string">&quot;org.apache.catalina.startup.EXIT_ON_INIT_FAILURE&quot;</span>))</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="startInternal-1"><a href="#startInternal-1" class="headerlink" title="startInternal"></a>startInternal</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">if</span>(log.isInfoEnabled())</span><br><span class="line">        log.info(sm.getString(<span class="string">&quot;standardService.start.name&quot;</span>, <span class="keyword">this</span>.name));</span><br><span class="line">    <span class="comment">//1. 触发启动监听器</span></span><br><span class="line">    setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start our defined Container first</span></span><br><span class="line">     <span class="comment">//2. 先启动 Engine，Engine 会启动它子容器</span></span><br><span class="line">    <span class="keyword">if</span> (engine != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (engine) &#123;</span><br><span class="line">            engine.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (executors) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Executor executor: executors) &#123;</span><br><span class="line">            executor.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//3. 再启动 Mapper 监听器</span></span><br><span class="line">    mapperListener.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start our defined Connectors second</span></span><br><span class="line">    <span class="comment">//4. 最后启动连接器，连接器会启动它子组件，比如 Endpoint</span></span><br><span class="line">    <span class="keyword">synchronized</span> (connectorsLock) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Connector connector: connectors) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// If it has already failed, don&#x27;t try and start it</span></span><br><span class="line">                <span class="keyword">if</span> (connector.getState() != LifecycleState.FAILED) &#123;</span><br><span class="line">                    <span class="comment">//启动连接器</span></span><br><span class="line">                    connector.start();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(sm.getString(</span><br><span class="line">                    <span class="string">&quot;standardService.connector.startFailed&quot;</span>,</span><br><span class="line">                    connector), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从启动方法可以看到，Service 先启动了 Engine 组件，再启动 Mapper 监听器，最后才是启动连接器。这很好理解，因为内层组件启动好了才能对外提供服务，才能启动外层的连接器组件。而 Mapper 也依赖容器组件，容器组件启动好了才能监听它们的变化，因此 Mapper 和 MapperListener 在容器组件之后启动。组件停止的顺序跟启动顺序正好相反的，也是基于它们的依赖关系。</p>
<h4 id="ContainerBase"><a href="#ContainerBase" class="headerlink" title="ContainerBase"></a>ContainerBase</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201121340247.png" alt="img"></p>
<blockquote>
<p>是容器的抽象父类，定义了容器生命周期中公共方法。Engine、Host、Context、Wrapper继承此父类。</p>
</blockquote>
<h5 id="继承关系"><a href="#继承关系" class="headerlink" title="继承关系"></a>继承关系</h5><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201121340735.png" alt="img"></p>
<h5 id="容器的作用"><a href="#容器的作用" class="headerlink" title="容器的作用"></a>容器的作用</h5><blockquote>
<p>Container的4个容器是逐层包含的关系。它们之间的关系如下图：</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201121341220.png" alt="img"></p>
<p>1、Engine：用来管理多个站点，一个Service最多只能有一个Engine。</p>
<p>2、Host：代表一个站点，通过配置Host可以添加站点。</p>
<p>3、Context：代表一个应用程序，对应一个WEB-INF目录。</p>
<p>4、Wrapper：每个Wrapper封装一个Servlet。</p>
<h5 id="initInternal-2"><a href="#initInternal-2" class="headerlink" title="initInternal"></a>initInternal</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">    <span class="comment">// 创建 线程池</span></span><br><span class="line">    BlockingQueue&lt;Runnable&gt; startStopQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</span><br><span class="line">    startStopExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">        getStartStopThreadsInternal(),</span><br><span class="line">        getStartStopThreadsInternal(), <span class="number">10</span>, TimeUnit.SECONDS,</span><br><span class="line">        startStopQueue,</span><br><span class="line">        <span class="keyword">new</span> StartStopThreadFactory(getName() + <span class="string">&quot;-startStop-&quot;</span>));</span><br><span class="line">    startStopExecutor.allowCoreThreadTimeOut(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">super</span>.initInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="startInternal-2"><a href="#startInternal-2" class="headerlink" title="startInternal"></a>startInternal</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start our subordinate components, if any</span></span><br><span class="line">    logger = <span class="keyword">null</span>;</span><br><span class="line">    getLogger();</span><br><span class="line">    <span class="comment">// 如果有 Cluster和 Realm则调用其 start 方法</span></span><br><span class="line">    Cluster cluster = getClusterInternal();</span><br><span class="line">    <span class="keyword">if</span> (cluster <span class="keyword">instanceof</span> Lifecycle) &#123;</span><br><span class="line">        ((Lifecycle) cluster).start();</span><br><span class="line">    &#125;</span><br><span class="line">    Realm realm = getRealmInternal();</span><br><span class="line">    <span class="keyword">if</span> (realm <span class="keyword">instanceof</span> Lifecycle) &#123;</span><br><span class="line">        ((Lifecycle) realm).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start our child containers, if any</span></span><br><span class="line">    <span class="comment">// 通过 Future 调用所有子容器的 start方法</span></span><br><span class="line">    Container children[] = findChildren();</span><br><span class="line">    List&lt;Future&lt;Void&gt;&gt; results = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">        results.add(startStopExecutor.submit(<span class="keyword">new</span> StartChild(children[i])));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MultiThrowable multiThrowable = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Future&lt;Void&gt; result : results) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取子容器 start 方法结果</span></span><br><span class="line">            result.get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">&quot;containerBase.threadedStartFailed&quot;</span>), e);</span><br><span class="line">            <span class="keyword">if</span> (multiThrowable == <span class="keyword">null</span>) &#123;</span><br><span class="line">                multiThrowable = <span class="keyword">new</span> MultiThrowable();</span><br><span class="line">            &#125;</span><br><span class="line">            multiThrowable.add(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (multiThrowable != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(sm.getString(<span class="string">&quot;containerBase.threadedStartFailed&quot;</span>),</span><br><span class="line">                                     multiThrowable.getThrowable());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start the Valves in our pipeline (including the basic), if any</span></span><br><span class="line">    <span class="comment">// 启用管道,后面介绍到</span></span><br><span class="line">    <span class="keyword">if</span> (pipeline <span class="keyword">instanceof</span> Lifecycle) &#123;</span><br><span class="line">        ((Lifecycle) pipeline).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置状态值</span></span><br><span class="line">    setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start our thread</span></span><br><span class="line">    <span class="comment">// 启动后台线程,日志输出等工作，</span></span><br><span class="line">    threadStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="threadStart"><a href="#threadStart" class="headerlink" title="threadStart"></a>threadStart</h5><blockquote>
<p>开启后台线程，定时检查 session 超时、</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">threadStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (thread != <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (backgroundProcessorDelay &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    threadDone = <span class="keyword">false</span>;</span><br><span class="line">    String threadName = <span class="string">&quot;ContainerBackgroundProcessor[&quot;</span> + toString() + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ContainerBackgroundProcessor(), threadName);</span><br><span class="line">    thread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread.start();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="processChildren"><a href="#processChildren" class="headerlink" title="processChildren"></a>processChildren</h5><blockquote>
<p>内部类 ContainerBackgroundProcessor， 默认 10s一次</p>
<p>在 StandardEngine 构造函数中定义</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processChildren</span><span class="params">(Container container)</span> </span>&#123;</span><br><span class="line">    ClassLoader originalClassLoader = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Context) &#123;</span><br><span class="line">            Loader loader = ((Context) container).getLoader();</span><br><span class="line">            <span class="comment">// Loader will be null for FailedContext instances</span></span><br><span class="line">            <span class="keyword">if</span> (loader == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Ensure background processing for Contexts and Wrappers</span></span><br><span class="line">            <span class="comment">// is performed under the web app&#x27;s class loader</span></span><br><span class="line">            originalClassLoader = ((Context) container).bind(<span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        container.backgroundProcess();</span><br><span class="line">        Container[] children = container.findChildren();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (children[i].getBackgroundProcessorDelay() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                processChildren(children[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        log.error(<span class="string">&quot;Exception invoking periodic operation: &quot;</span>, t);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Context) &#123;</span><br><span class="line">            ((Context) container).unbind(<span class="keyword">false</span>, originalClassLoader);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="backgroundProcess"><a href="#backgroundProcess" class="headerlink" title="backgroundProcess"></a>backgroundProcess</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">backgroundProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!getState().isAvailable())</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    Cluster cluster = getClusterInternal();</span><br><span class="line">    <span class="keyword">if</span> (cluster != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cluster.backgroundProcess();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(sm.getString(<span class="string">&quot;containerBase.backgroundProcess.cluster&quot;</span>,</span><br><span class="line">                                  cluster), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Realm realm = getRealmInternal();</span><br><span class="line">    <span class="keyword">if</span> (realm != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            realm.backgroundProcess();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(sm.getString(<span class="string">&quot;containerBase.backgroundProcess.realm&quot;</span>, realm), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Valve current = pipeline.getFirst();</span><br><span class="line">    <span class="keyword">while</span> (current != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            current.backgroundProcess();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(sm.getString(<span class="string">&quot;containerBase.backgroundProcess.valve&quot;</span>, current), e);</span><br><span class="line">        &#125;</span><br><span class="line">        current = current.getNext();</span><br><span class="line">    &#125;</span><br><span class="line">    fireLifecycleEvent(Lifecycle.PERIODIC_EVENT, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="容器的配置"><a href="#容器的配置" class="headerlink" title="容器的配置"></a>容器的配置</h5><h6 id="Server配置"><a href="#Server配置" class="headerlink" title="Server配置"></a>Server配置</h6><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">&quot;8005&quot;</span> <span class="attr">shutdown</span>=<span class="string">&quot;SHUTDOWN&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Define an AJP 1.3 Connector on port 8009 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8009&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;AJP/1.3&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span> <span class="attr">defaultHost</span>=<span class="string">&quot;localhost&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;localhost&quot;</span>  <span class="attr">appBase</span>=<span class="string">&quot;webapps&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">unpackWARs</span>=<span class="string">&quot;true&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Server 在 8005端口监听关闭命令“SHUTDOWN”；</li>
<li>Server 中定义了一个 Catalina的Service；</li>
<li>Service 中定义了两个Connector：<ul>
<li>一个是HTTP协议；</li>
<li>一个是AJP协议（用于集成）；</li>
</ul>
</li>
<li>Service 中还定义了了一个Catalina的Engine；</li>
<li>Engine 中定义了 localhost 的 Host；<ul>
<li>defaultHost：请求的域名如果在所有的Host的name和Alias中都找不到使用的默认值</li>
</ul>
</li>
<li>Host：<ul>
<li>name：表示域名；</li>
<li>appBase：站点的位置；</li>
<li>unpackWARS：是否自动解压war包；</li>
<li>autoDeploy：是否自动部署；</li>
<li>子标签： excelib.com：给localhost定义别名；</li>
</ul>
</li>
</ul>
<h6 id="Context配置"><a href="#Context配置" class="headerlink" title="Context配置"></a>Context配置</h6><blockquote>
<p>Context通过文件配置的方式一共有5个位置可以配置：</p>
</blockquote>
<ul>
<li>conf/server.xml中的Context标签；</li>
<li>conf/[enginename]/[hostname]/目录下以应用命名的 xml 文件。</li>
<li>应用自己的 /META-INT/context.xml；</li>
<li>conf/context.xml 文件</li>
<li>conf/[enginename]/[hostname]/context.xml.default文件；</li>
</ul>
<h6 id="用于全局配置"><a href="#用于全局配置" class="headerlink" title="用于全局配置"></a>用于全局配置</h6><blockquote>
<p>前三个用于配置单独的应用，后面2种是Context共享的。第4种是 整个 tomcat 共享，第5种配置的内容在对应的站点（Host）中共享。第1种方式只有在tomcat重启才会重新加载，不推荐使用。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">    用于全局配置</span></span><br><span class="line"><span class="comment">    The contents of this file will be loaded for each web application </span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Default set of monitored resources. If one of these changes, the    --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- web application will be reloaded.                                   --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">WatchedResource</span>&gt;</span>WEB-INF/web.xml<span class="tag">&lt;/<span class="name">WatchedResource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">WatchedResource</span>&gt;</span>$&#123;catalina.base&#125;/conf/web.xml<span class="tag">&lt;/<span class="name">WatchedResource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="Wrapper的配置"><a href="#Wrapper的配置" class="headerlink" title="Wrapper的配置"></a>Wrapper的配置</h6><blockquote>
<p>Wrapper的配置，在web.xml中配置的Servlet，一个Servlet对应一个Wrapper、可以在 conf/web.xml 中配置全局的 Wrapper，处理 Jsp的 JspServlet的配置等。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>jsp<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.jasper.servlet.JspServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>fork<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>xpoweredBy<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>3<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>jsp<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.jsp<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.jspx<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--配置了 session 超时时间--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">session-config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">session-timeout</span>&gt;</span>30<span class="tag">&lt;/<span class="name">session-timeout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">session-config</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 很多 mime 类型 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mime-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mime-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="LifecycleBase"><a href="#LifecycleBase" class="headerlink" title="LifecycleBase"></a>LifecycleBase</h4><h5 id="fireLifecycleEvent"><a href="#fireLifecycleEvent" class="headerlink" title="fireLifecycleEvent"></a>fireLifecycleEvent</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">fireLifecycleEvent</span><span class="params">(String type, Object data)</span> </span>&#123;</span><br><span class="line">    LifecycleEvent event = <span class="keyword">new</span> LifecycleEvent(<span class="keyword">this</span>, type, data);</span><br><span class="line">    <span class="keyword">for</span> (LifecycleListener listener : lifecycleListeners) &#123;</span><br><span class="line">        listener.lifecycleEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="HostConfig"><a href="#HostConfig" class="headerlink" title="HostConfig"></a>HostConfig</h4><h5 id="lifecycleEvent"><a href="#lifecycleEvent" class="headerlink" title="lifecycleEvent"></a>lifecycleEvent</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Identify the host we are associated with</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        host = (Host) event.getLifecycle();</span><br><span class="line">        <span class="keyword">if</span> (host <span class="keyword">instanceof</span> StandardHost) &#123;</span><br><span class="line">            setCopyXML(((StandardHost) host).isCopyXML());</span><br><span class="line">            setDeployXML(((StandardHost) host).isDeployXML());</span><br><span class="line">            setUnpackWARs(((StandardHost) host).isUnpackWARs());</span><br><span class="line">            setContextClass(((StandardHost) host).getContextClass());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">        log.error(sm.getString(<span class="string">&quot;hostConfig.cce&quot;</span>, event.getLifecycle()), e);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process the event that has occurred</span></span><br><span class="line">    <span class="keyword">if</span> (event.getType().equals(Lifecycle.PERIODIC_EVENT)) &#123;</span><br><span class="line">        <span class="comment">// 是否自动部署</span></span><br><span class="line">        check();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.BEFORE_START_EVENT)) &#123;</span><br><span class="line">        beforeStart();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.START_EVENT)) &#123;</span><br><span class="line">        start();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(Lifecycle.STOP_EVENT)) &#123;</span><br><span class="line">        stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="StandardEngine"><a href="#StandardEngine" class="headerlink" title="StandardEngine"></a>StandardEngine</h4><p>Engine 本质是一个容器，因此它继承了 ContainerBase 基类，并且实现了 Engine 接口。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardEngine</span> <span class="keyword">extends</span> <span class="title">ContainerBase</span> <span class="keyword">implements</span> <span class="title">Engine</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们知道，Engine 的子容器是 Host，所以它持有了一个 Host 容器的数组，这些功能都被抽象到了 ContainerBase 中，ContainerBase 中有这样一个数据结构：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> HashMap&lt;String, Container&gt; children = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>ContainerBase 用 HashMap 保存了它的子容器，并且 ContainerBase 还实现了子容器的“增删改查”，甚至连子组件的启动和停止都提供了默认实现，比如 ContainerBase 会用专门的线程池来启动子容器。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">   results.add(startStopExecutor.submit(<span class="keyword">new</span> StartChild(children[i])));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以 Engine 在启动 Host 子容器时就直接重用了这个方法。</p>
<p>那 Engine 自己做了什么呢？我们知道容器组件最重要的功能是处理请求，而 Engine 容器对请求的“处理”，其实就是把请求转发给某一个 Host 子容器来处理，具体是通过 Valve 来实现的。</p>
<h5 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StandardEngine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="comment">// pipeline 设置 basicValve</span></span><br><span class="line">    pipeline.setBasic(<span class="keyword">new</span> StandardEngineValve());</span><br><span class="line">    setJvmRoute(System.getProperty(<span class="string">&quot;jvmRoute&quot;</span>));</span><br><span class="line">    <span class="comment">// 设置等待时间 10</span></span><br><span class="line">    backgroundProcessorDelay = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="initInternal-3"><a href="#initInternal-3" class="headerlink" title="initInternal"></a>initInternal</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">    <span class="comment">// Ensure that a Realm is present before any attempt is made to start</span></span><br><span class="line">    <span class="comment">// one. This will create the default NullRealm if necessary.</span></span><br><span class="line">    <span class="comment">// 没有定义 Realm ，设置一个 NullRealm，权限访问。</span></span><br><span class="line">    getRealm();</span><br><span class="line">    <span class="keyword">super</span>.initInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="startInternal-3"><a href="#startInternal-3" class="headerlink" title="startInternal"></a>startInternal</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Log our server identification information</span></span><br><span class="line">    <span class="keyword">if</span>(log.isInfoEnabled())</span><br><span class="line">        log.info( <span class="string">&quot;Starting Servlet Engine: &quot;</span> + ServerInfo.getServerInfo());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Standard container startup</span></span><br><span class="line">    <span class="keyword">super</span>.startInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="StandardHost"><a href="#StandardHost" class="headerlink" title="StandardHost"></a>StandardHost</h4><h5 id="构造方法-1"><a href="#构造方法-1" class="headerlink" title="构造方法"></a>构造方法</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StandardHost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="comment">// 设置 BasicValve</span></span><br><span class="line">    pipeline.setBasic(<span class="keyword">new</span> StandardHostValve());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="startInternal-4"><a href="#startInternal-4" class="headerlink" title="startInternal"></a>startInternal</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set error report valve</span></span><br><span class="line">    <span class="comment">// 设置 error Valve</span></span><br><span class="line">    String errorValve = getErrorReportValveClass();</span><br><span class="line">    <span class="keyword">if</span> ((errorValve != <span class="keyword">null</span>) &amp;&amp; (!errorValve.equals(<span class="string">&quot;&quot;</span>))) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> found = <span class="keyword">false</span>;</span><br><span class="line">            Valve[] valves = getPipeline().getValves();</span><br><span class="line">            <span class="keyword">for</span> (Valve valve : valves) &#123;</span><br><span class="line">                <span class="keyword">if</span> (errorValve.equals(valve.getClass().getName())) &#123;</span><br><span class="line">                    found = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!found) &#123;</span><br><span class="line">                <span class="comment">// 绑定 errorValve</span></span><br><span class="line">                Valve valve =</span><br><span class="line">                    (Valve) Class.forName(errorValve).getConstructor().newInstance();</span><br><span class="line">                getPipeline().addValve(valve);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(t);</span><br><span class="line">            log.error(sm.getString(</span><br><span class="line">                <span class="string">&quot;standardHost.invalidErrorReportValveClass&quot;</span>,</span><br><span class="line">                errorValve), t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">super</span>.startInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="StandardContext"><a href="#StandardContext" class="headerlink" title="StandardContext"></a>StandardContext</h4><h5 id="构造方法-2"><a href="#构造方法-2" class="headerlink" title="构造方法"></a>构造方法</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StandardContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="comment">// 设置 BasicValve</span></span><br><span class="line">    pipeline.setBasic(<span class="keyword">new</span> StandardContextValve());</span><br><span class="line">    <span class="comment">// 广播通知</span></span><br><span class="line">    broadcaster = <span class="keyword">new</span> NotificationBroadcasterSupport();</span><br><span class="line">    <span class="comment">// Set defaults</span></span><br><span class="line">    <span class="keyword">if</span> (!Globals.STRICT_SERVLET_COMPLIANCE) &#123;</span><br><span class="line">        <span class="comment">// Strict servlet compliance requires all extension mapped servlets</span></span><br><span class="line">        <span class="comment">// to be checked against welcome files</span></span><br><span class="line">        resourceOnlyServlets.add(<span class="string">&quot;jsp&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="startInternal-5"><a href="#startInternal-5" class="headerlink" title="startInternal"></a>startInternal</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(log.isDebugEnabled())</span><br><span class="line">        log.debug(<span class="string">&quot;Starting &quot;</span> + getBaseName());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send j2ee.state.starting notification</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.getObjectName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Notification notification = <span class="keyword">new</span> Notification(<span class="string">&quot;j2ee.state.starting&quot;</span>,</span><br><span class="line">                                                     <span class="keyword">this</span>.getObjectName(), sequenceNumber.getAndIncrement());</span><br><span class="line">        broadcaster.sendNotification(notification);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setConfigured(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">boolean</span> ok = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Currently this is effectively a NO-OP but needs to be called to</span></span><br><span class="line">    <span class="comment">// ensure the NamingResources follows the correct lifecycle</span></span><br><span class="line">    <span class="comment">// namingResources 启动</span></span><br><span class="line">    <span class="keyword">if</span> (namingResources != <span class="keyword">null</span>) &#123;</span><br><span class="line">        namingResources.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Post work directory</span></span><br><span class="line">    postWorkDirectory();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add missing components as necessary</span></span><br><span class="line">    <span class="keyword">if</span> (getResources() == <span class="keyword">null</span>) &#123;   <span class="comment">// (1) Required by Loader</span></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">            log.debug(<span class="string">&quot;Configuring default Resources&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            setResources(<span class="keyword">new</span> StandardRoot(<span class="keyword">this</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">&quot;standardContext.resourcesInit&quot;</span>), e);</span><br><span class="line">            ok = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">        <span class="comment">// 加载 /WEB-INF/classes/META-INF/resources 目录下资源</span></span><br><span class="line">        resourcesStart();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置加载器</span></span><br><span class="line">    <span class="keyword">if</span> (getLoader() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        WebappLoader webappLoader = <span class="keyword">new</span> WebappLoader();</span><br><span class="line">        webappLoader.setDelegate(getDelegate());</span><br><span class="line">        setLoader(webappLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// An explicit cookie processor hasn&#x27;t been specified; use the default</span></span><br><span class="line">    <span class="comment">// cookie 处理器</span></span><br><span class="line">    <span class="keyword">if</span> (cookieProcessor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        cookieProcessor = <span class="keyword">new</span> Rfc6265CookieProcessor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize character set mapper</span></span><br><span class="line">    <span class="comment">// 初始化 CharsetMapper</span></span><br><span class="line">    getCharsetMapper();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Validate required extensions</span></span><br><span class="line">    <span class="comment">// 验证 /META-INF/MANIFEST.MF</span></span><br><span class="line">    <span class="keyword">boolean</span> dependencyCheck = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        dependencyCheck = ExtensionValidator.validateApplication</span><br><span class="line">            (getResources(), <span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        log.error(sm.getString(<span class="string">&quot;standardContext.extensionValidationError&quot;</span>), ioe);</span><br><span class="line">        dependencyCheck = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证失败, application 不可用</span></span><br><span class="line">    <span class="keyword">if</span> (!dependencyCheck) &#123;</span><br><span class="line">        <span class="comment">// do not make application available if dependency check fails</span></span><br><span class="line">        ok = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reading the &quot;catalina.useNaming&quot; environment variable</span></span><br><span class="line">    <span class="comment">// catalina.useNaming 环境变量</span></span><br><span class="line">    String useNamingProperty = System.getProperty(<span class="string">&quot;catalina.useNaming&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((useNamingProperty != <span class="keyword">null</span>)</span><br><span class="line">        &amp;&amp; (useNamingProperty.equals(<span class="string">&quot;false&quot;</span>))) &#123;</span><br><span class="line">        useNaming = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ok &amp;&amp; isUseNaming()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (getNamingContextListener() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            NamingContextListener ncl = <span class="keyword">new</span> NamingContextListener();</span><br><span class="line">            ncl.setName(getNamingContextName());</span><br><span class="line">            ncl.setExceptionOnFailedWrite(getJndiExceptionOnFailedWrite());</span><br><span class="line">            <span class="comment">// 注册 LifecycleListener</span></span><br><span class="line">            addLifecycleListener(ncl);</span><br><span class="line">            setNamingContextListener(ncl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Standard container startup</span></span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">        log.debug(<span class="string">&quot;Processing standard container startup&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Binding thread</span></span><br><span class="line">    ClassLoader oldCCL = bindThread();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">            <span class="comment">// Start our subordinate components, if any</span></span><br><span class="line">            Loader loader = getLoader();</span><br><span class="line">            <span class="keyword">if</span> (loader <span class="keyword">instanceof</span> Lifecycle) &#123;</span><br><span class="line">                ((Lifecycle) loader).start();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// since the loader just started, the webapp classloader is now</span></span><br><span class="line">            <span class="comment">// created.</span></span><br><span class="line">            setClassLoaderProperty(<span class="string">&quot;clearReferencesRmiTargets&quot;</span>,</span><br><span class="line">                                   getClearReferencesRmiTargets());</span><br><span class="line">            setClassLoaderProperty(<span class="string">&quot;clearReferencesStopThreads&quot;</span>,</span><br><span class="line">                                   getClearReferencesStopThreads());</span><br><span class="line">            setClassLoaderProperty(<span class="string">&quot;clearReferencesStopTimerThreads&quot;</span>,</span><br><span class="line">                                   getClearReferencesStopTimerThreads());</span><br><span class="line">            setClassLoaderProperty(<span class="string">&quot;clearReferencesHttpClientKeepAliveThread&quot;</span>,</span><br><span class="line">                                   getClearReferencesHttpClientKeepAliveThread());</span><br><span class="line">            setClassLoaderProperty(<span class="string">&quot;clearReferencesObjectStreamClassCaches&quot;</span>,</span><br><span class="line">                                   getClearReferencesObjectStreamClassCaches());</span><br><span class="line">            setClassLoaderProperty(<span class="string">&quot;clearReferencesThreadLocals&quot;</span>,</span><br><span class="line">                                   getClearReferencesThreadLocals());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// By calling unbindThread and bindThread in a row, we setup the</span></span><br><span class="line">            <span class="comment">// current Thread CCL to be the webapp classloader</span></span><br><span class="line">            unbindThread(oldCCL);</span><br><span class="line">            oldCCL = bindThread();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize logger again. Other components might have used it</span></span><br><span class="line">            <span class="comment">// too early, so it should be reset.</span></span><br><span class="line">            logger = <span class="keyword">null</span>;</span><br><span class="line">            getLogger();</span><br><span class="line"></span><br><span class="line">            Realm realm = getRealmInternal();</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> != realm) &#123;</span><br><span class="line">                <span class="keyword">if</span> (realm <span class="keyword">instanceof</span> Lifecycle) &#123;</span><br><span class="line">                    ((Lifecycle) realm).start();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Place the CredentialHandler into the ServletContext so</span></span><br><span class="line">                <span class="comment">// applications can have access to it. Wrap it in a &quot;safe&quot;</span></span><br><span class="line">                <span class="comment">// handler so application&#x27;s can&#x27;t modify it.</span></span><br><span class="line">                CredentialHandler safeHandler = <span class="keyword">new</span> CredentialHandler() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(String inputCredentials, String storedCredentials)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> getRealmInternal().getCredentialHandler().matches(inputCredentials, storedCredentials);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> String <span class="title">mutate</span><span class="params">(String inputCredentials)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> getRealmInternal().getCredentialHandler().mutate(inputCredentials);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">                context.setAttribute(Globals.CREDENTIAL_HANDLER, safeHandler);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Notify our interested LifecycleListeners</span></span><br><span class="line">            <span class="comment">// 调用事件</span></span><br><span class="line">            fireLifecycleEvent(Lifecycle.CONFIGURE_START_EVENT, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start our child containers, if not already started</span></span><br><span class="line">            <span class="comment">// 在不可用的时候，启动子容器</span></span><br><span class="line">            <span class="keyword">for</span> (Container child : findChildren()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!child.getState().isAvailable()) &#123;</span><br><span class="line">                    child.start();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start the Valves in our pipeline (including the basic),</span></span><br><span class="line">            <span class="comment">// if any</span></span><br><span class="line">            <span class="comment">// pipeline 的启动</span></span><br><span class="line">            <span class="keyword">if</span> (pipeline <span class="keyword">instanceof</span> Lifecycle) &#123;</span><br><span class="line">                ((Lifecycle) pipeline).start();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Acquire clustered manager</span></span><br><span class="line">            <span class="comment">// 获取集群管理器</span></span><br><span class="line">            Manager contextManager = <span class="keyword">null</span>;</span><br><span class="line">            Manager manager = getManager();</span><br><span class="line">            <span class="keyword">if</span> (manager == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(sm.getString(<span class="string">&quot;standardContext.cluster.noManager&quot;</span>,</span><br><span class="line">                                           Boolean.valueOf((getCluster() != <span class="keyword">null</span>)),</span><br><span class="line">                                           Boolean.valueOf(distributable)));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((getCluster() != <span class="keyword">null</span>) &amp;&amp; distributable) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        contextManager = getCluster().createManager(getName());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;standardContext.clusterFail&quot;</span>, ex);</span><br><span class="line">                        ok = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    contextManager = <span class="keyword">new</span> StandardManager();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Configure default manager if none was specified</span></span><br><span class="line">            <span class="comment">// 配置默认管理器</span></span><br><span class="line">            <span class="keyword">if</span> (contextManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(sm.getString(<span class="string">&quot;standardContext.manager&quot;</span>,</span><br><span class="line">                                           contextManager.getClass().getName()));</span><br><span class="line">                &#125;</span><br><span class="line">                setManager(contextManager);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 注册管理器</span></span><br><span class="line">            <span class="keyword">if</span> (manager!=<span class="keyword">null</span> &amp;&amp; (getCluster() != <span class="keyword">null</span>) &amp;&amp; distributable) &#123;</span><br><span class="line">                <span class="comment">//let the cluster know that there is a context that is distributable</span></span><br><span class="line">                <span class="comment">//and that it has its own manager</span></span><br><span class="line">                getCluster().registerManager(manager);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!getConfigured()) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">&quot;standardContext.configurationFail&quot;</span>));</span><br><span class="line">            ok = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We put the resources into the servlet context</span></span><br><span class="line">        <span class="comment">// 将资源 放到 servlet Context 中</span></span><br><span class="line">        <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">            getServletContext().setAttribute</span><br><span class="line">                (Globals.RESOURCES_ATTR, getResources());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (getInstanceManager() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                javax.naming.Context context = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (isUseNaming() &amp;&amp; getNamingContextListener() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    context = getNamingContextListener().getEnvContext();</span><br><span class="line">                &#125;</span><br><span class="line">                Map&lt;String, Map&lt;String, String&gt;&gt; injectionMap = buildInjectionMap(</span><br><span class="line">                    getIgnoreAnnotations() ? <span class="keyword">new</span> NamingResourcesImpl(): getNamingResources());</span><br><span class="line">                setInstanceManager(<span class="keyword">new</span> DefaultInstanceManager(context,</span><br><span class="line">                                                              injectionMap, <span class="keyword">this</span>, <span class="keyword">this</span>.getClass().getClassLoader()));</span><br><span class="line">            &#125;</span><br><span class="line">            getServletContext().setAttribute(</span><br><span class="line">                InstanceManager.class.getName(), getInstanceManager());</span><br><span class="line">            InstanceManagerBindings.bind(getLoader().getClassLoader(), getInstanceManager());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create context attributes that will be required</span></span><br><span class="line">            getServletContext().setAttribute(</span><br><span class="line">                JarScanner.class.getName(), getJarScanner());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Make the version info available</span></span><br><span class="line">            getServletContext().setAttribute(Globals.WEBAPP_VERSION, getWebappVersion());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up the context init params</span></span><br><span class="line">        <span class="comment">// 设置上下文 init 参数</span></span><br><span class="line">        mergeParameters();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Call ServletContainerInitializers</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;ServletContainerInitializer, Set&lt;Class&lt;?&gt;&gt;&gt; entry :</span><br><span class="line">             initializers.entrySet()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                entry.getKey().onStartup(entry.getValue(),</span><br><span class="line">                                         getServletContext());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">                log.error(sm.getString(<span class="string">&quot;standardContext.sciFail&quot;</span>), e);</span><br><span class="line">                ok = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Configure and call application event listeners</span></span><br><span class="line">        <span class="comment">// 调用 listener</span></span><br><span class="line">        <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!listenerStart()) &#123;</span><br><span class="line">                log.error(sm.getString(<span class="string">&quot;standardContext.listenerFail&quot;</span>));</span><br><span class="line">                ok = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check constraints for uncovered HTTP methods</span></span><br><span class="line">        <span class="comment">// Needs to be after SCIs and listeners as they may programmatically</span></span><br><span class="line">        <span class="comment">// change constraints</span></span><br><span class="line">        <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">            checkConstraintsForUncoveredMethods(findConstraints());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Start manager</span></span><br><span class="line">            Manager manager = getManager();</span><br><span class="line">            <span class="keyword">if</span> (manager <span class="keyword">instanceof</span> Lifecycle) &#123;</span><br><span class="line">                ((Lifecycle) manager).start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">&quot;standardContext.managerFail&quot;</span>), e);</span><br><span class="line">            ok = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Configure and call application filters</span></span><br><span class="line">        <span class="comment">// filter调用</span></span><br><span class="line">        <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!filterStart()) &#123;</span><br><span class="line">                log.error(sm.getString(<span class="string">&quot;standardContext.filterFail&quot;</span>));</span><br><span class="line">                ok = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load and initialize all &quot;load on startup&quot; servlets</span></span><br><span class="line">        <span class="comment">// 初始化 Servlet，如果配置了 LoadOnStartUp</span></span><br><span class="line">        <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!loadOnStartup(findChildren()))&#123;</span><br><span class="line">                log.error(sm.getString(<span class="string">&quot;standardContext.servletFail&quot;</span>));</span><br><span class="line">                ok = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start ContainerBackgroundProcessor thread</span></span><br><span class="line">        <span class="comment">// 启动后台线程</span></span><br><span class="line">        <span class="keyword">super</span>.threadStart();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// Unbinding thread</span></span><br><span class="line">        unbindThread(oldCCL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set available status depending upon startup success</span></span><br><span class="line">    <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">            log.debug(<span class="string">&quot;Starting completed&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.error(sm.getString(<span class="string">&quot;standardContext.startFailed&quot;</span>, getName()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    startTime=System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send j2ee.state.running notification</span></span><br><span class="line">    <span class="keyword">if</span> (ok &amp;&amp; (<span class="keyword">this</span>.getObjectName() != <span class="keyword">null</span>)) &#123;</span><br><span class="line">        Notification notification =</span><br><span class="line">            <span class="keyword">new</span> Notification(<span class="string">&quot;j2ee.state.running&quot;</span>, <span class="keyword">this</span>.getObjectName(),</span><br><span class="line">                             sequenceNumber.getAndIncrement());</span><br><span class="line">        broadcaster.sendNotification(notification);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The WebResources implementation caches references to JAR files. On</span></span><br><span class="line">    <span class="comment">// some platforms these references may lock the JAR files. Since web</span></span><br><span class="line">    <span class="comment">// application start is likely to have read from lots of JARs, trigger</span></span><br><span class="line">    <span class="comment">// a clean-up now.</span></span><br><span class="line">    <span class="comment">// 资源回收</span></span><br><span class="line">    getResources().gc();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reinitializing if something went wrong</span></span><br><span class="line">    <span class="keyword">if</span> (!ok) &#123;</span><br><span class="line">        setState(LifecycleState.FAILED);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        setState(LifecycleState.STARTING);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="StandardWrapper"><a href="#StandardWrapper" class="headerlink" title="StandardWrapper"></a>StandardWrapper</h4><h5 id="构造方法-3"><a href="#构造方法-3" class="headerlink" title="构造方法"></a>构造方法</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StandardWrapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    swValve=<span class="keyword">new</span> StandardWrapperValve();</span><br><span class="line">    <span class="comment">// 设置 BasicValve</span></span><br><span class="line">    pipeline.setBasic(swValve);</span><br><span class="line">    broadcaster = <span class="keyword">new</span> NotificationBroadcasterSupport();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="startInternal-6"><a href="#startInternal-6" class="headerlink" title="startInternal"></a>startInternal</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send j2ee.state.starting notification</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.getObjectName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Notification notification = <span class="keyword">new</span> Notification(<span class="string">&quot;j2ee.state.starting&quot;</span>,</span><br><span class="line">                                                     <span class="keyword">this</span>.getObjectName(),</span><br><span class="line">                                                     sequenceNumber++);</span><br><span class="line">        broadcaster.sendNotification(notification);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start up this component</span></span><br><span class="line">    <span class="keyword">super</span>.startInternal();</span><br><span class="line"></span><br><span class="line">    setAvailable(<span class="number">0L</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send j2ee.state.running notification</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.getObjectName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Notification notification =</span><br><span class="line">            <span class="keyword">new</span> Notification(<span class="string">&quot;j2ee.state.running&quot;</span>, <span class="keyword">this</span>.getObjectName(),</span><br><span class="line">                             sequenceNumber++);</span><br><span class="line">        broadcaster.sendNotification(notification);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="StandardPipeline"><a href="#StandardPipeline" class="headerlink" title="StandardPipeline"></a>StandardPipeline</h4><h5 id="initInternal-4"><a href="#initInternal-4" class="headerlink" title="initInternal"></a>initInternal</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// NOOP</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="startInternal-7"><a href="#startInternal-7" class="headerlink" title="startInternal"></a>startInternal</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start the Valves in our pipeline (including the basic), if any</span></span><br><span class="line">    Valve current = first;</span><br><span class="line">    <span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line">        current = basic;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (current != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (current <span class="keyword">instanceof</span> Lifecycle)</span><br><span class="line">            ((Lifecycle) current).start();</span><br><span class="line">        current = current.getNext();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setState(LifecycleState.STARTING);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">小肥龙吃大冰淇淋</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lvxueyangtiger.github.io/post/72c16057.html">https://lvxueyangtiger.github.io/post/72c16057.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lvxueyangtiger.github.io" target="_blank">小肥龙吃大冰淇淋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/tomcat/">tomcat</a><a class="post-meta__tags" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</a></div><div class="post_share"><div class="social-share" data-image="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082302.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/eb709392.html"><img class="prev-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082219.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">tomcat基本使用</div></div></a></div><div class="next-post pull-right"><a href="/post/50a36485.html"><img class="next-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212110.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">tomcat关于session实现</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/7767ee9f.html" title="tomcat之http本质"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082055.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">tomcat之http本质</div></div></a></div><div><a href="/post/7337862a.html" title="jetty架构特点值connector组件"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082110.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">jetty架构特点值connector组件</div></div></a></div><div><a href="/post/8612798c.html" title="springboot集成tomcat"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212025.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">springboot集成tomcat</div></div></a></div><div><a href="/post/f61f945.html" title="tomcat ARP提高IO性能的秘密"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212044.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">tomcat ARP提高IO性能的秘密</div></div></a></div><div><a href="/post/3c1c7c35.html" title="tomcat之servlet理解"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212035.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">tomcat之servlet理解</div></div></a></div><div><a href="/post/50a36485.html" title="tomcat关于session实现"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212110.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">tomcat关于session实现</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#tomcat%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">tomcat启动流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tomcat%E6%BA%90%E7%A0%81%E7%9B%AE%E5%BD%95"><span class="toc-number">1.1.</span> <span class="toc-text">tomcat源码目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tomcat%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">tomcat启动流程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.2.1.</span> <span class="toc-text">源码分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Bootstrap%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">1.2.2.</span> <span class="toc-text">Bootstrap启动类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#main"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">main</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#setAwait"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">setAwait</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#init"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">init</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#initClassLoaders"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">initClassLoaders</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#createClassLoader"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">createClassLoader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#load"><span class="toc-number">1.2.2.6.</span> <span class="toc-text">load</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Catalina"><span class="toc-number">1.2.3.</span> <span class="toc-text">Catalina</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#load-1"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">load</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#createStartDigester"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">createStartDigester</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#start"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">start</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StandardServer"><span class="toc-number">1.2.4.</span> <span class="toc-text">StandardServer</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#addService"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">addService</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#initInternal"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">initInternal</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#startInternal"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">startInternal</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#await"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">await</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StandardService"><span class="toc-number">1.2.5.</span> <span class="toc-text">StandardService</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#initInternal-1"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">initInternal</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#startInternal-1"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">startInternal</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ContainerBase"><span class="toc-number">1.2.6.</span> <span class="toc-text">ContainerBase</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">继承关系</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">1.2.6.2.</span> <span class="toc-text">容器的作用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#initInternal-2"><span class="toc-number">1.2.6.3.</span> <span class="toc-text">initInternal</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#startInternal-2"><span class="toc-number">1.2.6.4.</span> <span class="toc-text">startInternal</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#threadStart"><span class="toc-number">1.2.6.5.</span> <span class="toc-text">threadStart</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#processChildren"><span class="toc-number">1.2.6.6.</span> <span class="toc-text">processChildren</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#backgroundProcess"><span class="toc-number">1.2.6.7.</span> <span class="toc-text">backgroundProcess</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.6.8.</span> <span class="toc-text">容器的配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Server%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.6.8.1.</span> <span class="toc-text">Server配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Context%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.6.8.2.</span> <span class="toc-text">Context配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%A8%E4%BA%8E%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.6.8.3.</span> <span class="toc-text">用于全局配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Wrapper%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.6.8.4.</span> <span class="toc-text">Wrapper的配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LifecycleBase"><span class="toc-number">1.2.7.</span> <span class="toc-text">LifecycleBase</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#fireLifecycleEvent"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">fireLifecycleEvent</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HostConfig"><span class="toc-number">1.2.8.</span> <span class="toc-text">HostConfig</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#lifecycleEvent"><span class="toc-number">1.2.8.1.</span> <span class="toc-text">lifecycleEvent</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StandardEngine"><span class="toc-number">1.2.9.</span> <span class="toc-text">StandardEngine</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.9.1.</span> <span class="toc-text">构造方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#initInternal-3"><span class="toc-number">1.2.9.2.</span> <span class="toc-text">initInternal</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#startInternal-3"><span class="toc-number">1.2.9.3.</span> <span class="toc-text">startInternal</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StandardHost"><span class="toc-number">1.2.10.</span> <span class="toc-text">StandardHost</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95-1"><span class="toc-number">1.2.10.1.</span> <span class="toc-text">构造方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#startInternal-4"><span class="toc-number">1.2.10.2.</span> <span class="toc-text">startInternal</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StandardContext"><span class="toc-number">1.2.11.</span> <span class="toc-text">StandardContext</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95-2"><span class="toc-number">1.2.11.1.</span> <span class="toc-text">构造方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#startInternal-5"><span class="toc-number">1.2.11.2.</span> <span class="toc-text">startInternal</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StandardWrapper"><span class="toc-number">1.2.12.</span> <span class="toc-text">StandardWrapper</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95-3"><span class="toc-number">1.2.12.1.</span> <span class="toc-text">构造方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#startInternal-6"><span class="toc-number">1.2.12.2.</span> <span class="toc-text">startInternal</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StandardPipeline"><span class="toc-number">1.2.13.</span> <span class="toc-text">StandardPipeline</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#initInternal-4"><span class="toc-number">1.2.13.1.</span> <span class="toc-text">initInternal</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#startInternal-7"><span class="toc-number">1.2.13.2.</span> <span class="toc-text">startInternal</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 小肥龙吃大冰淇淋</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="framework-info"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202301132049386.png"/><span> </span><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/">晋ICP备2022012091号-1</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'pinglun-9gh2lmcnd8587831',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'pinglun-9gh2lmcnd8587831',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/hexo-theme-volantis@latest/source/js/issues.min.js"></script><script src="//code.tidio.co/smwivpnwumemac2wohardi3d3gpud1ag.js" async="async"></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>