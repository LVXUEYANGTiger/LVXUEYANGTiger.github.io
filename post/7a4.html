<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ElasticSearch | 小肥龙吃大冰淇淋</title><meta name="keywords" content="搜索引擎,Elasticsearch"><meta name="author" content="小肥龙吃大冰淇淋"><meta name="copyright" content="小肥龙吃大冰淇淋"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ElasticSearch 概述 概述Elasticsearch 是什么 Elasticsearch（简称ES）是一个基于Apache Lucene(TM)的开源搜索引擎   Elasticsearch 是一个高伸缩的开源全文搜索和分析引擎，是一个基于JSON的分布式搜索和分析引擎，基于restful web接口，Elasticsearch是用Java语言开发的，基于Apache协议的开源项目，是">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch">
<meta property="og:url" content="https://lvxueyangtiger.github.io/post/7a4.html">
<meta property="og:site_name" content="小肥龙吃大冰淇淋">
<meta property="og:description" content="ElasticSearch 概述 概述Elasticsearch 是什么 Elasticsearch（简称ES）是一个基于Apache Lucene(TM)的开源搜索引擎   Elasticsearch 是一个高伸缩的开源全文搜索和分析引擎，是一个基于JSON的分布式搜索和分析引擎，基于restful web接口，Elasticsearch是用Java语言开发的，基于Apache协议的开源项目，是">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212055.jpg">
<meta property="article:published_time" content="2024-05-30T01:10:36.212Z">
<meta property="article:modified_time" content="2023-10-12T04:26:07.454Z">
<meta property="article:author" content="小肥龙吃大冰淇淋">
<meta property="article:tag" content="搜索引擎">
<meta property="article:tag" content="Elasticsearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212055.jpg"><link rel="shortcut icon" href="https://lvxueyangboke.oss-cn-beijing.aliyuncs.com/images/20210805191028.png"><link rel="canonical" href="https://lvxueyangtiger.github.io/post/7a4"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ElasticSearch',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-12 12:26:07'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/ali_icon.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mogai.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="小肥龙吃大冰淇淋" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">303</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">108</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">73</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212055.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">小肥龙吃大冰淇淋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ElasticSearch</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-30T01:10:36.212Z" title="发表于 2024-05-30 09:10:36">2024-05-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-10-12T04:26:07.454Z" title="更新于 2023-10-12 12:26:07">2023-10-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/">搜索引擎</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/Elasticsearch/">Elasticsearch</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">96.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>349分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ElasticSearch"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="ElasticSearch-概述"><a href="#ElasticSearch-概述" class="headerlink" title="ElasticSearch 概述"></a>ElasticSearch 概述</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch001.png" alt="img"></p>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><h4 id="Elasticsearch-是什么"><a href="#Elasticsearch-是什么" class="headerlink" title="Elasticsearch 是什么"></a>Elasticsearch 是什么</h4><blockquote>
<p>Elasticsearch（简称ES）是一个基于Apache Lucene(TM)的开源搜索引擎</p>
</blockquote>
<p> Elasticsearch 是一个高伸缩的开源全文搜索和分析引擎，是一个基于JSON的分布式搜索和分析引擎，基于restful web接口，Elasticsearch是用Java语言开发的，基于Apache协议的开源项目，是目前最受欢迎的企业搜索引擎。</p>
<p> 它可以快速地、近实时的存储，搜索和分析大规模的数据。一般被用作底层引擎/技术，为具有复杂搜索功能和要求的应用提供强有力的支撑。</p>
<h5 id="ElasticSearch特点"><a href="#ElasticSearch特点" class="headerlink" title="ElasticSearch特点"></a>ElasticSearch特点</h5><blockquote>
<p>Elasticsearch是实时的分布式搜索分析引擎，内部使用Lucene做索引与搜索，有以下特点</p>
</blockquote>
<ul>
<li>近实时性：新增到 ES 中的数据在1秒后就可以被检索到，这种新增数据对搜索的可见性称为“近实时搜索”</li>
<li>全文检索：将全文检索、数据分析以及分布式技术，合并在了一起，才形成了独一无二的ES</li>
<li>分布式：意味着可以动态调整集群规模，弹性扩容</li>
<li>集群规模：可以扩展到上百台服务器，处理PB级结构化或非结构化数据</li>
<li>开箱即用：对用户而言，是开箱即用的，非常简单，作为中小型的应用，直接3分钟部署一下ES</li>
<li>不支持事务：数据库的功能面对很多领域是不够用的，事务，还有各种联机事务型的操作</li>
</ul>
<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><blockquote>
<p>ElasticSearch广泛应用于各行业领域， 比如维基百科， GitHub的代码搜索，电商网站的大数据日志统计分析， BI系统报表统计分析等。</p>
</blockquote>
<h5 id="记录和日志分析"><a href="#记录和日志分析" class="headerlink" title="记录和日志分析"></a>记录和日志分析</h5><blockquote>
<p>ELK结合使用可以实现日志数据的收集整理</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch002.png" alt="img"></p>
<p> 围绕Elasticsearch建立的生态系统使其成为实施和扩展日志记录解决方案最简单的系统之一，利用这一点将日志添加到他们的主要用例中，或者纯粹将我们用于日志记录。</p>
<p> 从Beats到Logstash，再到Ingest Nodes，Elasticsearch为您提供了很多选择，可以随时随地获取数据并将其编入索引，从那里，像Kibana这样的工具使您能够创建丰富的仪表板和分析。</p>
<h5 id="搜集和合并公共数据"><a href="#搜集和合并公共数据" class="headerlink" title="搜集和合并公共数据"></a>搜集和合并公共数据</h5><blockquote>
<p>像日志数据一样，Elastic Stack有很多工具可以使远程数据的获取和索引编制变得容易。</p>
</blockquote>
<p> 而且，像大多数文档存储一样，缺乏严格的架构也使Elasticsearch可以灵活地接收多种不同的数据源，并且仍然可以使所有数据源易于管理和搜索。</p>
<h5 id="全文搜索"><a href="#全文搜索" class="headerlink" title="全文搜索"></a>全文搜索</h5><blockquote>
<p>全文搜索作为Elasticsearch的核心功能，得到了广泛的应用，远远超出了传统的企业搜索或电子商务</p>
</blockquote>
<p> 从欺诈检测/安全性到协作及其他方面，Elasticsearch的搜索功能强大，灵活，并且包含许多工具，可以使搜索变得更加容易，Elasticsearch拥有自己的查询DSL以及内置的功能，可自动完成</p>
<h5 id="事件数据和指标"><a href="#事件数据和指标" class="headerlink" title="事件数据和指标"></a>事件数据和指标</h5><blockquote>
<p>Elasticsearch在如指标和应用程序事件之类的时间序列数据上也能很好地运行</p>
</blockquote>
<p> 这是巨大的Beats生态系统允许您轻松获取常见应用程序数据的另一个区域，无论您使用哪种技术，Elasticsearch都有很大的机会拥有可以立即获取指标和事件的组件。</p>
<h5 id="可视化数据"><a href="#可视化数据" class="headerlink" title="可视化数据"></a>可视化数据</h5><blockquote>
<p>Kibana拥有大量图表选项，用于地理数据的图块服务以及用于时间序列数据的TimeLion，是功能强大且易于使用的可视化工具。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch003.png" alt="img"></p>
<p> 对于上述每个用例，Kibana都会处理一些可视组件，熟悉了各种数据提取工具后，您会发现Elasticsearch + Kibana将成为您可视化试图包裹数据的必备工具。</p>
<h4 id="能做什么"><a href="#能做什么" class="headerlink" title="能做什么"></a>能做什么</h4><blockquote>
<p>要使用ElasticSearch我们需要知道ElasticSearch能够做什么</p>
</blockquote>
<h5 id="提供快速查询"><a href="#提供快速查询" class="headerlink" title="提供快速查询"></a>提供快速查询</h5><blockquote>
<p>试想一下，当你打开一个博客网站，搜索一篇博客的时候，等待了一分钟才有搜索结果，那将会是一个极差的体验。</p>
</blockquote>
<p> 可想而知，这个博客网站肯定没有使用搜索引擎处理搜索的请求，而是使用了传统的关系型数据库查询，在庞大的数据面前，关系型数据库的查询就显得力不从心，相当耗时。Elasticsearch在这个时候可以帮上忙，使用博客数据建立索引库，依赖倒排索引的优势，为用户快速的呈现搜索的相关结果。</p>
<h5 id="确保结果的相关性"><a href="#确保结果的相关性" class="headerlink" title="确保结果的相关性"></a>确保结果的相关性</h5><blockquote>
<p>接下来有一个难题: 如何将真正描述选举的帖子排序在前呢?有了 Elasticsearch，就可以使 用几个算法来计算相关性的得分( relevancy score )，然后根据分数来将结果逐个排序 。</p>
</blockquote>
<p> 默认情况下，计算文档相关性得分的算法是TF-IDF（term frequency-inverse document frequency)，词频逆文档频率。我们将在后面讨论这个概念。除了选择算法，Elasticsearch还提供了很多其他内置的功能来计算概相关性得分，以满足定制需求。</p>
<h5 id="处理错误的拼写"><a href="#处理错误的拼写" class="headerlink" title="处理错误的拼写"></a>处理错误的拼写</h5><blockquote>
<p>当我们在使用搜索时，会出现英文拼写错误，中文错别字等情况时有发生。</p>
</blockquote>
<p> 我们可以通过配置让Elasticsearch容忍一些错误，而不仅仅只是查找精确匹配，如我们输入“book”的时候由于手误输入了“bok”，如果搜索引擎能够意识到这一错误并且在搜索时帮我们修正这个错误，那么搜索会更快让人满意。</p>
<h5 id="给予自动提示"><a href="#给予自动提示" class="headerlink" title="给予自动提示"></a>给予自动提示</h5><blockquote>
<p>当用户开始输入时，你可以帮助他们发现主流的查询和结果。</p>
</blockquote>
<p> 还可以通过自动提示技术预测 他们所要输入的内容，就像 Web 上很多搜索引擎做的那样，你同样可以展示主流的结果，通过 特殊的查询类型来匹配前缀、通配符或正则表达式。</p>
<h5 id="使用统计信息"><a href="#使用统计信息" class="headerlink" title="使用统计信息"></a>使用统计信息</h5><blockquote>
<p>当用户不太清楚具体要搜索什么的时候，可以通过几种方式来协助他们 。</p>
</blockquote>
<p> 一种方法是聚集统计数据， 聚集是在搜索结果里得到一些统计数据，如每个分类有多少议题、每个分 类中“赞”和“分享”的平均数量。</p>
<p> 假想一下，进入博客时，用户会在右侧看见最近流行的议题。 其中之一是自行车。 对其感兴趣的读者会点击这个标题，进一步缩小范围。 然后， 可能还有另外 的聚集方式 ，将自行车相关的帖子分为“ 自行车鉴赏”“自行车大事件”等。</p>
<h4 id="ElasticSearch的发展"><a href="#ElasticSearch的发展" class="headerlink" title="ElasticSearch的发展"></a>ElasticSearch的发展</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch004.png" alt="image-20220825112512298"></p>
<h5 id="起源Lucene"><a href="#起源Lucene" class="headerlink" title="起源Lucene"></a>起源Lucene</h5><blockquote>
<p>Lucene 是一个用 Java 编写的非常古老的搜索引擎工具 包，用来构建倒排索引（一种数据结构）和对这些索引进行检索，从而实现全文检索功能。</p>
</blockquote>
<h6 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h6><blockquote>
<p>Lucene，必须使用Java来作为开发语言并将其直接集成到你的应用中，并且Lucene的配置及使用非常复杂，你需要深入了解检索的相关知识来理解它 是如何工作的，有以下缺点</p>
</blockquote>
<ul>
<li>只能在Java项目中使用，并且要以jar包的方式直接集成项目中</li>
<li>使用非常复杂-创建索引和搜索索引代码繁杂</li>
<li>不支持集群环境-索引数据不同步（不支持大型项目）</li>
<li>索引数据如果太多就不行，索引库和应用所在同一个服务器，共同占用硬盘，共用空间少。</li>
</ul>
<p>lunce 单独占用内存？</p>
<h5 id="诞生"><a href="#诞生" class="headerlink" title="诞生"></a>诞生</h5><blockquote>
<p>ElasticSearch的创始人期初是为了能够为妻子开发一个菜谱搜索应用而接触的Lucene</p>
</blockquote>
<p> 它本身不是一个应用程序无法直接提供用户使用，同样对其他语言不友好的，那么ElastiSearch的开发者在使用过程中遇到的一系列问题，他就在Lucene的基础上对之进行不断的优化形成了自己的一套应用程序‘Compass’。</p>
<p> 后来它自己在工作中同样遇到了一个需要高性能，分布式的搜索服务，所以他就在‘Compass’的基础之上重新构建起了ElasticSearch，从设计之初的目标就是打造成分布式、高性能、基于JSON、Restful的易用性可易用与其他语言的独立服务。</p>
<h5 id="发展"><a href="#发展" class="headerlink" title="发展"></a>发展</h5><blockquote>
<p>围绕ElasticSearch后来成立一家公司(Elastic公司)全面围绕ElasticSearch或者说是数据生态进行发展,该公司已经在去年上市(ESTC)，上市当天暴涨</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch005.png" alt="img"></p>
<p> ELasticSearch当前已经可以与多种客户端进行集成Python、PHP、.NET、Java等，当前同样支持与Hadoop、Spark等大数据分析平台进行集成。</p>
<p> ElasticSearch衍生出一系列的开源项目，例如业内较火的ELK Stack，ELK Stack是负责数据检索服务的ElasticSearch、数据采集解析服务的Logstash和负责数据可视化服务的Kibana的简称，Logstash是由Java语言编写的，同时负责数据的采集与解析工作，会导致服务的CPU与内存资源占用过高，后来ELastic又推出采用Go语言编写的Beats家族</p>
<h3 id="ElasticSearch基本概念"><a href="#ElasticSearch基本概念" class="headerlink" title="ElasticSearch基本概念"></a>ElasticSearch基本概念</h3><h4 id="索引类型"><a href="#索引类型" class="headerlink" title="索引类型"></a>索引类型</h4><blockquote>
<p>我们常见的索引包括正排索引和倒排索引</p>
</blockquote>
<h5 id="正排索引"><a href="#正排索引" class="headerlink" title="正排索引"></a>正排索引</h5><blockquote>
<p>正排索引是以文档的ID为关键字，表中记录文档中每个字段的位置信息，查找时扫描表中每个文档中字段的信息直到找出所有包含查询关键字的文档</p>
</blockquote>
<h6 id="正排索引说明"><a href="#正排索引说明" class="headerlink" title="正排索引说明"></a>正排索引说明</h6><p> 拿MySQL Innodb的聚簇索引来说，如下图所示，一个极简版（无页属性）的B+树索引结构大概是这样，叶子节点存放完整数据，非叶子节点存放建立对应聚簇索引对应的字段（主键），一条可以使用到聚簇索引的SQL，会依次从上到下进行B+树的查找直到字段一致；</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_info (</span><br><span class="line">	id <span class="type">int</span>,</span><br><span class="line">	name <span class="type">varchar</span>(<span class="number">16</span>),</span><br><span class="line">	hobby <span class="type">varchar</span>(<span class="number">256</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch006.png" alt="image-20220819094000248"></p>
<h6 id="索引查询"><a href="#索引查询" class="headerlink" title="索引查询"></a>索引查询</h6><p> 而对应非聚簇索引只是叶子节点的内容存放的是该表的主键信息，查询的顺序则是 先通过非聚簇索引的字段找到叶子节点中一致的 单个或者多个主键id，再使用这些主键id进行<code>回表</code>，最终获得对应的完整实体数据。</p>
<h6 id="全表扫描"><a href="#全表扫描" class="headerlink" title="全表扫描"></a>全表扫描</h6><blockquote>
<p>如果我们看上面在mysql中表的hobby爱好字段，如果我们有业务需求：根据用户爱好关键字如“篮球”去查询对应用户列表，我们怎么做，只能是写个字符串的like sql，全表扫描的逻辑。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> user_info</span><br><span class="line"><span class="keyword">WHERE</span> hobby <span class="keyword">LIKE</span> <span class="string">&#x27;%篮球%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p> 即使我们对hobby字段创建了普通索引，在Innodb引擎下，在查询中想使用字符串类型的索引也只能走最左前缀索引的逻辑，即 LIKE ‘篮球%’。</p>
<h6 id="全文索引"><a href="#全文索引" class="headerlink" title="全文索引"></a>全文索引</h6><p> 幸好Innodb在5.6版本后支持了全文索引full text，在创建完全文索引后，查询中使用MATCH、AGAINST就能够使用全文索引了，比全表扫B+树效率会高很多，但是对应全文索引会占据相当的磁盘空间，全文索引与我们要说的倒排索引就是一个意思了。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> user_info</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">MATCH</span> (hobby) AGAINST (<span class="string">&#x27;篮球&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h5><blockquote>
<p>倒排索引源于实际应用中需要根据属性的值来查找记录，也就是说，不是由记录来确定属性值，而是由属性值来确定记录，因而称为<strong>倒排索引</strong></p>
</blockquote>
<p> 相比B+树的正排索引，如果我们对hobby字段建立了索引，他的倒排索引极简的数据格式如下。</p>
<p> 创建倒排索引的field，会通过分词器根据语义将字段中的field分成一个一个对应的词索引（term index），构成该类型数据的全部词索引集合，如“喜欢篮球、唱歌”会被分成 “篮球”和“唱歌”两个term index；</p>
<p> 第二列是含有这些term index对应的文档Id，这个数据可以帮助我们最终溯源到完整实体数据；</p>
<p> 第三列则是对应term index在该文档字段中的位置，0表示在开头的位置，这个可以帮助标注检索出来数据的高亮信息。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch007.png" alt="image-20220819095714172"></p>
<h5 id="两种索引查找顺序"><a href="#两种索引查找顺序" class="headerlink" title="两种索引查找顺序"></a>两种索引查找顺序</h5><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch008.png" alt="正排索引倒排索引查询顺序.jpg"></p>
<h4 id="逻辑概念"><a href="#逻辑概念" class="headerlink" title="逻辑概念"></a>逻辑概念</h4><blockquote>
<p>假设我们在一个业务系统中选择MySQL做数据存储，那么我们需要先创建一个database，再创建一组相关的table，Elasticsearch同样具有这样的概念，使用<strong>index</strong>和<strong>mapping</strong>来组织数据，下面是Elasticsearch的一些基本概念</p>
</blockquote>
<table>
<thead>
<tr>
<th>概念</th>
<th>关系型数据库</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>索引库（indices)</td>
<td>Databases 数据库</td>
<td>indices是index的复数，代表许多的索引</td>
</tr>
<tr>
<td>类型（type）</td>
<td>Table 数据表</td>
<td>类型是模拟mysql中的table概念，一个索引库下可以有不同类型的索引，比如商品索引，订单索引，其数据格式不同，不过这会导致索引库混乱，因此未来版本中会移除这个概念</td>
</tr>
<tr>
<td>文档（document）</td>
<td>Row 行</td>
<td>存入索引库原始的数据，比如每一条商品信息，就是一个文档</td>
</tr>
<tr>
<td>字段（field）</td>
<td>Columns 列</td>
<td>文档中的属性</td>
</tr>
<tr>
<td>映射配置（mappings）</td>
<td>表结构</td>
<td>字段的数据类型、属性、是否索引、是否存储等特性</td>
</tr>
</tbody></table>
<h5 id="索引（Index）"><a href="#索引（Index）" class="headerlink" title="索引（Index）"></a>索引（Index）</h5><blockquote>
<p>一个索引由一个名字来标识（必须全部是小写字母），并且当我们要对这个索引中的文档进行索引、搜索、更新和删除的时候，都要使用到这个名字。</p>
</blockquote>
<p> 一个索引相当于数据库，是多个相似文档的集合，必须通过索引才能进行搜索，使用使用能够极大的提升查询速度，类似于词典里面的目录。</p>
<p> 当然在底层，肯定用到了倒排索引，最基本的结构就是“keyword”和“PostingList”，Postinglist就是一个int的数组，存储了所有符合某个term的文档id，另外，这个倒排索引相比特定词项出现过的文档列表，会包含更多其它信息。</p>
<p> 它会保存每一个词项出现过的文档总数，在对应的文档中一个具体词项出现的总次数，词项在文档中的顺序，每个文档的长度，所有文档的平均长度等等相关信息。</p>
<h5 id="类型（Type）"><a href="#类型（Type）" class="headerlink" title="类型（Type）"></a>类型（Type）</h5><blockquote>
<p>一个类型过去是索引的逻辑类别/分区，允许你在同一索引中存储不同类型的文档</p>
</blockquote>
<p> 例如，一种类型用于用户，另一种类型用于博客文章，在索引中创建多个类型不再可能，类型的整个概念将在稍后的版本中删除，相当于sql领域中表的概念。</p>
<h6 id="类型的变化"><a href="#类型的变化" class="headerlink" title="类型的变化"></a>类型的变化</h6><blockquote>
<p>在不同的elasticsearch中，类型发生了不同的变化</p>
</blockquote>
<table>
<thead>
<tr>
<th>版本</th>
<th>Type</th>
</tr>
</thead>
<tbody><tr>
<td>5.x</td>
<td>支持多种Type</td>
</tr>
<tr>
<td>6.x</td>
<td>只有一种Type</td>
</tr>
<tr>
<td>7.x</td>
<td>默认不在支持自定义的索引类型，默认类型为_doc</td>
</tr>
</tbody></table>
<h5 id="文档（Document）"><a href="#文档（Document）" class="headerlink" title="文档（Document）"></a>文档（Document）</h5><blockquote>
<p>一个文档是可以被索引的一个基本单元，相当于数据库中的一条数据，索引和搜索数据的最小单位是文档</p>
</blockquote>
<h5 id="字段（Field）"><a href="#字段（Field）" class="headerlink" title="字段（Field）"></a>字段（Field）</h5><blockquote>
<p>相当于数据库表的字段，每个字段有不同的类型</p>
</blockquote>
<h5 id="映射（Mapping）"><a href="#映射（Mapping）" class="headerlink" title="映射（Mapping）"></a>映射（Mapping）</h5><blockquote>
<p>Mapping是对处理数据时的方式和规则作出一定的限制，如字段的类型、默认值、分析器、是否被索引等，映射定义了每个字段的类型、字段所使用的分词器等。</p>
</blockquote>
<p> 可以显式映射，由我们在索引映射中进行预先定义，也可以动态映射，在添加文档的时候，由es自动添加到索引，这个过程不需要事先在索引进行字段数据类型匹配等等，es会自己推断数据类型。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">get itheima/_mapping</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch009.png" alt="image-20220804105342845"></p>
<h4 id="物理概念"><a href="#物理概念" class="headerlink" title="物理概念"></a>物理概念</h4><blockquote>
<p>Elasticsearch是一个分布式系统，其数据会分散存储到不同的节点上，为了实现这一点，需要将每个index中的数据划分到不同的块中，然后将这些数据块分配到不同的节点上存储</p>
</blockquote>
<h5 id="集群-（cluster）"><a href="#集群-（cluster）" class="headerlink" title="集群 （cluster）"></a>集群 （cluster）</h5><blockquote>
<p>一个集群就是由一个或多个节点组织在一起，它们共同持有整个的数据，并一起提供索引和搜索功能</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch010.png" alt="img">集群（cluster）是一个或多个节点（node)的集合，这些节点 将共同拥有完整的数据，并跨节点提供联合索引、搜索和分析功能。</p>
<p> 一个集群由一个唯一的名字标识，这个名字默认就是“elasticsearch”，这个名字是重要的，因为一个节点只能通过指定某个集群的名字，来加入这个集群。</p>
<p> ES集群是一个 P2P类型(使用 gossip 协议)的分布式系统，除了集群状态管理以外，其他所有的请求都可以发送到集群内任意一台节点上，这个节点可以自己找到需要转发给哪些节点，并且直接跟这些节点通信，所以从网络架构及服务配置上来说，构建集群所需要的配置极其简单</p>
<p> 集群中节点数量没有限制，一般大于等于2个节点就可以看做是集群了，一般处于高性能及高可用方面来考虑一般集群中的节点数量都是3个及3个以上。</p>
<h5 id="节点（node）"><a href="#节点（node）" class="headerlink" title="节点（node）"></a>节点（node）</h5><blockquote>
<p>一个节点是集群中的一个服务器，作为集群的一部分，它存储数据，参与集群的索引和搜索功能</p>
</blockquote>
<p> 和集群类似，一个节点也是由一个名字来标识的，默认情况下，这个名字是一个随机的漫威漫画角色的名字，这个名字会在启动的时候赋予节点</p>
<p> 一个节点可以通过配置集群名称的方式来加入一个指定的集群，默认情况下，每个节点都会被安排加入到一个叫做“elasticsearch”的集群中，这意味着，如果你在你的网络中启动了若干个节点，并假定它们能够相互发现彼此，它们将会自动地形成并加入到一个叫做“elasticsearch”的集群中。</p>
<h5 id="分片（Shards）"><a href="#分片（Shards）" class="headerlink" title="分片（Shards）"></a>分片（Shards）</h5><blockquote>
<p>分片的存在是为了解决单个索引大量文档的存储问题、以及搜索是响应慢等问题。</p>
</blockquote>
<p> 比如，一个具有10亿文档的索引占据1TB的磁盘空间，而任一节点都没有这样大的磁盘空间，或者单个节点处理搜索请求，响应太慢，为了解决这个问题，Elasticsearch提供了将索引划分成多份的能力，这些份就叫做分片。</p>
<p> 将一个索引划分成了多份，每一份就称之为分片，每个分片也是一个功能完善的“索引”，这个“索引”可以被放置到集群的任意节点上，通过”分”的思想，可以突破单机在存储空间和处理性能上的限制，这是分布式系统的核心目的</p>
<p> 至于一个分片怎样分布，它的文档怎样聚合回搜索请求，是完全由Elasticsearch管理的，对于作为用户的你来说，这些都是透明的。</p>
<h5 id="副本（Replicas）"><a href="#副本（Replicas）" class="headerlink" title="副本（Replicas）"></a>副本（Replicas）</h5><blockquote>
<p>而对于分布式存储而言，还有一个重要特性是”冗余”，因为分布式的前提是：接受系统中某个节点因为某些故障退出，为了保证在故障节点退出后数据不丢失，同一份数据需要拷贝多份存在不同节点上</p>
</blockquote>
<p> 在一个网络 / 云的环境里，失败随时都可能发生，在某个分片/节点不知怎么的就处于离线状态，或者由于任何原因消失了，这种情况下，有一个故障转移机制是非常有用并且是强烈推荐的。为此目的，Elasticsearch 允许你创建分片的一份或多份拷贝，这些拷贝叫做复制分片(副本)。</p>
<p> 复制之所以重要，有两个主要原因： 在分片/节点失败的情况下，提供了高可用性。因为这个原因，注意到复制分片从不与原/主要（original/primary）分片置于同一节点上是非常重要的。扩展你的搜索量/吞吐量，因为搜索可以在所有的复制上并行运行。总之，每个索引可以被分成多个分片。一个索引也可以被复制0次（意思是没有复制）或多次。一旦复制了，每个索引就有了主分片（作为复制源的原来的分片）和复制分片（主分片的拷贝）之别。分片和复制的数量可以在索引创建的时候指定。在索引创建之后，你可以在任何时候动态地改变复制的数量，但是你事后不能改变分片的数量。</p>
<h5 id="段（segment）"><a href="#段（segment）" class="headerlink" title="段（segment）"></a>段（segment）</h5><blockquote>
<p>segment来自于lucene，因为ES底层就是使用的lucene，一个shard包含一组segment，segment是最小的数据单元</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch011.png" alt="img"></p>
<p> Elasticsearch每隔一段时间产生一个新的segment，里面包含了新写入的数据，lucene的数据写入会先写如到缓存（buffer）中，当达到一定数量以后，会flush成文一个segment，写入到磁盘当中，每个segement有自己独立的索引，可以单独查询。</p>
<p> segment不会被修改，数据的的写入都是进行批量的追加，避免了随机写的存在，提高了吞吐量，segement可以被删除，但也不是修改segement文件，而是由另外的文件记录需要被删除的documentId。</p>
<p> index的查询是对多个segement文件的查询，其中也包含了处理被删除文件的处理，并对查询结果进行合并，为了进行查询优化，lucene有策略对多个segment进行优化。</p>
<h5 id="节点的角色"><a href="#节点的角色" class="headerlink" title="节点的角色"></a>节点的角色</h5><blockquote>
<p>一个Elasticsearch实例代表了一个ES 节点，如果不通过 node.roles 设置节点的角色，一个ES节点默认的节点角色有：master 、data 、data_content、data_hot、data_warm、data_cold、ingest、ml、remote_cluster_client。</p>
</blockquote>
<p>主节点介绍？元数据保存哪里，整体集群介绍</p>
<p> 每个节点既可以是<strong>候选主节点</strong>也可以是<strong>数据节点</strong>，通过在配置文件<code>../config/elasticsearch.yml</code>中设置即可，默认都为<code>true</code>，ES节点有如下角色：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch012.png" alt="img"></p>
<h6 id="master角色"><a href="#master角色" class="headerlink" title="master角色"></a>master角色</h6><blockquote>
<p>其实这个是master准确的来说是具有成为master节点资格的节点，即master-eligible node</p>
</blockquote>
<p> 候选主节点，master节点的职责是创建索引、删除索引、监控集群中的所有节点、决定分片应当分配到哪一个节点上，拥有一个稳定的主节点对集群非常重要，候选主节点可以通过节点选举过程被选举为主节点，主节点最好是专用的，不和其他角色共用，以免其他的操作对master节点负载造成影响，导致集群不可用</p>
<p> 主节点负责轻量级集群范围的操作，例如创建或删除索引、跟踪哪些节点是集群的一部分以及决定将哪些分片分配给哪些节点，任何不是仅投票节点的主合格节点都可以通过主选举过程选举成为主节点。</p>
<p> 主节点必须有一个<code>path.data</code>目录，其内容在重启后仍然存在，就像数据节点一样，因为这是存储集群元数据的地方，集群元数据描述了如何读取存储在数据节点上的数据，因此如果丢失，则无法读取存储在数据节点上的数据。</p>
<p> 如果小型或轻负载集群的主节点具有其他角色和职责，则其可能运行良好，但是一旦您的集群包含多个节点，使用专用的主节点通常是有意义的。</p>
<h6 id="voting-only-仅投票节点"><a href="#voting-only-仅投票节点" class="headerlink" title="voting_only 仅投票节点"></a>voting_only 仅投票节点</h6><blockquote>
<p>只能参与主节点的投票选举环节，但是自己不能被选举为master</p>
</blockquote>
<p> 高可用性 (HA) 集群需要至少三个符合主节点的节点，其中至少两个不是仅投票节点，这样即使其中一个节点发生故障，集群也能够选举出一个主节点。</p>
<p> 仅投票节点用来凑数的，如果只部署了两个候选主节点，当一个节点挂掉后集群将会不可用，加入了候选主节点则不一样，有了仅投票节点可以帮助快速选择一个主节点出来，并且仅投票节点不会选为主节点，不存储数据，所以消耗的资源也很小。</p>
<h6 id="data-数据节点"><a href="#data-数据节点" class="headerlink" title="data 数据节点"></a>data 数据节点</h6><blockquote>
<p>负责数据的存储和相关的操作，例如对数据进行增、删、改、查和聚合等操作</p>
</blockquote>
<p> 保存包含已编入索引的文档的分片，数据节点处理数据相关操作，如 CRUD、搜索和聚合这些操作是 I/O 密集型、内存密集型和 CPU 密集型的，监控这些资源并在它们过载时添加更多数据节点非常重要</p>
<h6 id="ingest-摄取节点"><a href="#ingest-摄取节点" class="headerlink" title="ingest 摄取节点"></a>ingest 摄取节点</h6><blockquote>
<p>摄取节点可以执行由一个或多个摄取处理器组成的预处理管道</p>
</blockquote>
<p> 能执行预处理管道，有自己独立的任务要执行， 在索引数据之前可以先对数据做预处理操作， 不负责数据存储也不负责集群相关的事务，类似于 logstash 中 filter 的作用，功能相当强大。</p>
<p> 在实际文档索引发生之前，使用Ingest节点预处理文档，Ingest节点拦截批量和索引请求，它应用转换，然后将文档传递回索引，在数据被索引之前，通过预定义好的处理管道对数据进行预处理。</p>
<h6 id="coordinating-仅协调节点"><a href="#coordinating-仅协调节点" class="headerlink" title="coordinating 仅协调节点"></a>coordinating 仅协调节点</h6><blockquote>
<p>如果您取消了处理主职责、保存数据和预处理文档的能力，那么您就剩下一个只能路由请求、处理搜索减少阶段和分发批量索引的协调节点</p>
</blockquote>
<p> 本质上，<strong>仅协调节点的行为就像智能负载均衡器</strong>，通过从数据和符合主节点的节点卸载协调节点角色，仅协调节点可以使大型集群受益，他们加入集群并接收完整的集群状态，就像其他每个节点一样，他们使用集群状态将请求直接路由到适当的地方。</p>
<h5 id="配置节点类型"><a href="#配置节点类型" class="headerlink" title="配置节点类型"></a>配置节点类型</h5><table>
<thead>
<tr>
<th>节点类型</th>
<th>配置参数</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>master eligible</td>
<td>node.master</td>
<td>true</td>
</tr>
<tr>
<td>data</td>
<td>node.data</td>
<td>true</td>
</tr>
<tr>
<td>ingest</td>
<td>node.ingest</td>
<td>true</td>
</tr>
<tr>
<td>Coordianting only</td>
<td>无</td>
<td>每个节点默认都是 Coordianting。设置其他类型为 false</td>
</tr>
<tr>
<td>machine learning</td>
<td>node.ml</td>
<td>true (需要 enable x-pack)</td>
</tr>
</tbody></table>
<h3 id="ElasticSearch集群概念"><a href="#ElasticSearch集群概念" class="headerlink" title="ElasticSearch集群概念"></a>ElasticSearch集群概念</h3><h4 id="集群角色"><a href="#集群角色" class="headerlink" title="集群角色"></a>集群角色</h4><blockquote>
<p>一个Elasticsearch实例代表了一个ES 节点，如果不通过 <code>node.roles</code> 设置节点的角色，一个ES节点默认的节点角色有很多个不同的角色</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch012.png" alt="img"></p>
<p> 每个节点既可以是<strong>候选主节点</strong>也可以是<strong>数据节点</strong>，通过在配置文件<code>../config/elasticsearch.yml</code>中设置即可，默认都为<code>true</code>，ES节点有如下角色：</p>
<h5 id="Master节点"><a href="#Master节点" class="headerlink" title="Master节点"></a>Master节点</h5><blockquote>
<p>其实这个是master准确的来说是具有成为master节点资格的节点，即<code>master-eligible node</code></p>
</blockquote>
<h6 id="主要职责"><a href="#主要职责" class="headerlink" title="主要职责"></a>主要职责</h6><p> Master角色的主要职责是负责集群层面的相关操作，管理集群变更，如创建或删除索引，跟踪哪些节点是群集的一部分，并决定哪些分片分配给相关的节点。</p>
<p> 拥有一个稳定的主节点对集群非常重要，候选主节点可以通过节点选举过程被选举为主节点，主节点最好是专用的，不和其他角色共用，以免其他的操作对master节点负载造成影响，导致集群不可用</p>
<h6 id="角色介绍"><a href="#角色介绍" class="headerlink" title="角色介绍"></a>角色介绍</h6><blockquote>
<p>主节点负责轻量级集群范围的操作，任何不是仅投票节点的合格节点都可以通过选举成为主节点</p>
</blockquote>
<p> 主节点必须有一个<code>path.data</code>目录，其内容在重启后仍然存在，就像数据节点一样，因为这是存储集群元数据的地方，集群元数据描述了如何读取存储在数据节点上的数据，因此如果丢失，则无法读取存储在数据节点上的数据。</p>
<h5 id="仅投票节点"><a href="#仅投票节点" class="headerlink" title="仅投票节点"></a>仅投票节点</h5><blockquote>
<p>只能参与主节点的投票选举环节，但是自己不能被选举为master</p>
</blockquote>
<h6 id="主要职责-1"><a href="#主要职责-1" class="headerlink" title="主要职责"></a>主要职责</h6><p> 仅投票节点用来凑数的，如果只部署了两个候选主节点，当一个节点挂掉后集群将会不可用，加入了仅投票节点则不一样，有了仅投票节点可以帮助快速选择一个主节点出来，并且仅投票节点不会选为主节点，不存储数据，所以消耗的资源也很小。</p>
<h6 id="角色介绍-1"><a href="#角色介绍-1" class="headerlink" title="角色介绍"></a>角色介绍</h6><p> 高可用性 (HA) 集群需要至少三个符合主节点的节点，其中至少两个不是仅投票节点，这样即使其中一个节点发生故障，集群也能够选举出一个主节点。</p>
<h5 id="数据节点"><a href="#数据节点" class="headerlink" title="数据节点"></a>数据节点</h5><blockquote>
<p>负责数据的存储和相关的操作，例如对数据进行增、删、改、查和聚合等操作</p>
</blockquote>
<h6 id="主要职责-2"><a href="#主要职责-2" class="headerlink" title="主要职责"></a>主要职责</h6><blockquote>
<p>数据节点主要是存储索引数据的节点，执行数据相关操作：CRUD、搜索，聚合操作等。</p>
</blockquote>
<p> 数据节点对cpu，内存，I/O要求较高， 在优化的时候需要监控数据节点的状态，当资源不够的时候，需要在集群中添加新的节点。</p>
<h6 id="角色介绍-2"><a href="#角色介绍-2" class="headerlink" title="角色介绍"></a>角色介绍</h6><p> 保存包含已编入索引的文档的分片，数据节点处理数据相关操作，如 CRUD、搜索和聚合这些操作是 I/O 密集型、内存密集型以及 CPU 密集型的，监控这些资源并在它们过载时添加更多数据节点非常重要</p>
<h5 id="预处理节点"><a href="#预处理节点" class="headerlink" title="预处理节点"></a>预处理节点</h5><blockquote>
<p>这是从5.0版本开始引入的概念，预处理节点可以执行由一个或多个摄取处理器组成的预处理管道</p>
</blockquote>
<h6 id="主要职责-3"><a href="#主要职责-3" class="headerlink" title="主要职责"></a>主要职责</h6><p> 预处理操作运行在索引文档之前，即写入数据之前，通过事先定义好的一系列processors(处理器)和pipeline（管道），对数据进行某种转换、富化</p>
<h6 id="角色介绍-3"><a href="#角色介绍-3" class="headerlink" title="角色介绍"></a>角色介绍</h6><p> 能执行预处理管道，有自己独立的任务要执行， 在索引数据之前可以先对数据做预处理操作， 不负责数据存储也不负责集群相关的事务，类似于 logstash 中 filter 的作用，功能相当强大。</p>
<p> 在实际文档索引发生之前，使用Ingest节点预处理文档，Ingest节点拦截批量和索引请求，它应用转换，然后将文档传递回索引，在数据被索引之前，通过预定义好的处理管道对数据进行预处理。</p>
<h5 id="仅协调节点"><a href="#仅协调节点" class="headerlink" title="仅协调节点"></a>仅协调节点</h5><blockquote>
<p>如果您取消了候选主节点的职责、保存数据和预处理文档的能力，那么您就剩下一个只能路由请求、处理搜索减少阶段和分发批量索引的协调节点</p>
</blockquote>
<h6 id="只要职责"><a href="#只要职责" class="headerlink" title="只要职责"></a>只要职责</h6><blockquote>
<p>协调节点将请求转发给保存数据的数据节点，每个数据节点在本地执行请求，并将结果返回给协调节点。</p>
</blockquote>
<p> 协调节点收集完数据合，将每个数据节点的结果合并为单个全局结果，对结果收集和排序的过程可能需要很多CPU和内存资源。</p>
<h6 id="角色介绍-4"><a href="#角色介绍-4" class="headerlink" title="角色介绍"></a>角色介绍</h6><p> 本质上，<strong>仅协调节点的行为就像智能负载均衡器</strong>，通过从数据和符合主节点的节点卸载协调节点角色，仅协调节点可以使大型集群受益，他们加入集群并接收完整的集群状态，就像其他每个节点一样，他们使用集群状态将请求直接路由到适当的地方。</p>
<h5 id="节点配置方式"><a href="#节点配置方式" class="headerlink" title="节点配置方式"></a>节点配置方式</h5><blockquote>
<p>以下是个个节点的配置方式</p>
</blockquote>
<table>
<thead>
<tr>
<th>节点类型</th>
<th>配置参数</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>master eligible</td>
<td>node.master</td>
<td>true</td>
</tr>
<tr>
<td>data</td>
<td>node.data</td>
<td>true</td>
</tr>
<tr>
<td>ingest</td>
<td>node.ingest</td>
<td>true</td>
</tr>
<tr>
<td>Coordianting only</td>
<td>无</td>
<td>每个节点默认都是 Coordianting，设置其他类型为 false</td>
</tr>
<tr>
<td>machine learning</td>
<td>node.ml</td>
<td>true (需要 enable x-pack)</td>
</tr>
</tbody></table>
<h4 id="集群脑裂问题"><a href="#集群脑裂问题" class="headerlink" title="集群脑裂问题"></a>集群脑裂问题</h4><blockquote>
<p>脑裂是因为集群中的节点失联导致的</p>
</blockquote>
<h5 id="脑裂分析"><a href="#脑裂分析" class="headerlink" title="脑裂分析"></a>脑裂分析</h5><blockquote>
<p>例如一个集群中，主节点与其它节点失联：</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch142.png" alt="image-20210723223804995"></p>
<h6 id="重新选主"><a href="#重新选主" class="headerlink" title="重新选主"></a>重新选主</h6><blockquote>
<p>此时，node2和node3认为node1宕机，就会重新选主：</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch143.png" alt="image-20210723223845754"></p>
<h6 id="出现脑裂"><a href="#出现脑裂" class="headerlink" title="出现脑裂"></a>出现脑裂</h6><blockquote>
<p>当node3当选后，集群继续对外提供服务，node2和node3自成集群，node1自成集群，两个集群数据不同步，出现数据差异，当网络恢复后，因为集群中有两个master节点，集群状态的不一致，出现脑裂的情况：</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch144.png" alt="image-20210723224000555"></p>
<h5 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h5><blockquote>
<p>解决脑裂的方案是，要求选票超过 ( 候选主节点数量 + 1 ）/ 2 才能当选为主</p>
</blockquote>
<p> 因此候选主节点数量最好是奇数，对应配置项是<code>discovery.zen.minimum_master_nodes</code>，在es7.0以后，已经成为默认配置，因此一般不会发生脑裂问题</p>
<p> 例如：3个节点形成的集群，选票必须超过 （3 + 1） / 2 ，也就是2票，node3得到node2和node3的选票，当选为主，node1只有自己1票，没有当选，集群中依然只有1个主节点，没有出现脑裂。</p>
<h2 id="ElasticSearch-单机部署"><a href="#ElasticSearch-单机部署" class="headerlink" title="ElasticSearch 单机部署"></a>ElasticSearch 单机部署</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch001.png" alt="img"></p>
<h3 id="单机部署"><a href="#单机部署" class="headerlink" title="单机部署"></a>单机部署</h3><h4 id="下载-Elasticsearch"><a href="#下载-Elasticsearch" class="headerlink" title="下载 Elasticsearch"></a>下载 Elasticsearch</h4><blockquote>
<p>我们下载的Elasticsearch 版本是 7.17.5，下载地址<code>https://www.elastic.co/cn/downloads/past-releases/elasticsearch-7-17-5</code></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.17.5-linux-x86_64.tar.gz</span><br><span class="line">tar -zvxf elasticsearch-7.17.5-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>

<h4 id="配置-Elasticsearch"><a href="#配置-Elasticsearch" class="headerlink" title="配置 Elasticsearch"></a>配置 Elasticsearch</h4><h5 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemctl status firewalld.service</span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service</span><br></pre></td></tr></table></figure>

<h5 id="配置elasticsearch-yml"><a href="#配置elasticsearch-yml" class="headerlink" title="配置elasticsearch.yml"></a>配置elasticsearch.yml</h5><blockquote>
<p>该配置文件是ES的主配置文件</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vi elasticsearch.yml</span><br><span class="line"><span class="comment">#设置允许访问地址，配置位0.0.0.0允许任意主机访问</span></span><br><span class="line">- <span class="comment">#network.host: 192.168.0.1</span></span><br><span class="line">+ network.host: 0.0.0.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置集群</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># node.name: node-1</span></span><br><span class="line">+ node.name: node-1</span><br><span class="line"></span><br><span class="line">- <span class="comment">#discovery.seed_hosts: [&quot;host1&quot;, &quot;host2&quot;]</span></span><br><span class="line">discovery.seed_hosts: [<span class="string">&quot;node-1&quot;</span>]</span><br><span class="line"></span><br><span class="line">- <span class="comment">#cluster.initial_master_nodes: [&quot;node-1&quot;, &quot;node-2&quot;]</span></span><br><span class="line">+ cluster.initial_master_nodes: [<span class="string">&quot;node-1&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="修改Linux句柄数"><a href="#修改Linux句柄数" class="headerlink" title="修改Linux句柄数"></a>修改Linux句柄数</h4><h5 id="查看当前最大句柄数"><a href="#查看当前最大句柄数" class="headerlink" title="查看当前最大句柄数"></a>查看当前最大句柄数</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sysctl -a | grep vm.max_map_count</span><br></pre></td></tr></table></figure>

<h5 id="修改句柄数"><a href="#修改句柄数" class="headerlink" title="修改句柄数"></a>修改句柄数</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line">+ vm.max_map_count=262144</span><br></pre></td></tr></table></figure>

<h5 id="生效配置"><a href="#生效配置" class="headerlink" title="生效配置"></a>生效配置</h5><blockquote>
<p>修改后需要重启才能生效，不想重启可以设置临时生效</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sysctl -w vm.max_map_count=262144</span><br></pre></td></tr></table></figure>

<h4 id="关闭swap"><a href="#关闭swap" class="headerlink" title="关闭swap"></a>关闭swap</h4><blockquote>
<p>因为ES的数据大量都是常驻内存的，一旦使用了虚拟内存就会导致查询速度下降，一般需要关闭swap，但是要保证有足够的内存</p>
</blockquote>
<h5 id="临时关闭"><a href="#临时关闭" class="headerlink" title="临时关闭"></a>临时关闭</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">swapoff -a</span><br></pre></td></tr></table></figure>

<h5 id="永久关闭"><a href="#永久关闭" class="headerlink" title="永久关闭"></a>永久关闭</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vi /etc/fstab</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注释掉<code>swap</code>这一行的配置</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch165.png" alt="image-20220914161151689"></p>
<h4 id="修改最大线程数"><a href="#修改最大线程数" class="headerlink" title="修改最大线程数"></a>修改最大线程数</h4><blockquote>
<p>因为ES运行期间可能创建大量线程，如果线程数支持较少可能报错</p>
</blockquote>
<h5 id="配置修改"><a href="#配置修改" class="headerlink" title="配置修改"></a>配置修改</h5><blockquote>
<p>修改后需要重新登录生效</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vi /etc/security/limits.conf</span><br><span class="line"><span class="comment"># 添加以下内容</span></span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br><span class="line">* soft nproc 4096</span><br><span class="line">* hard nproc 4096</span><br></pre></td></tr></table></figure>

<h5 id="重启服务"><a href="#重启服务" class="headerlink" title="重启服务"></a>重启服务</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h4 id="创建ES用户"><a href="#创建ES用户" class="headerlink" title="创建ES用户"></a>创建ES用户</h4><blockquote>
<p>注意ES不能以 root 用户启动，否则会报错</p>
</blockquote>
<h5 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">useradd elasticsearch</span><br><span class="line">passwd elasticsearch</span><br></pre></td></tr></table></figure>

<h5 id="增加管理员权限"><a href="#增加管理员权限" class="headerlink" title="增加管理员权限"></a>增加管理员权限</h5><blockquote>
<p>增加sudoers权限</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vi /etc/sudoers</span><br><span class="line">+ elasticsearch  ALL=(ALL)       ALL</span><br></pre></td></tr></table></figure>

<h5 id="修改Elasticsearch权限"><a href="#修改Elasticsearch权限" class="headerlink" title="修改Elasticsearch权限"></a>修改Elasticsearch权限</h5><blockquote>
<p>给ES的安装目录进行授权</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">chown -R elasticsearch:elasticsearch elasticsearch-7.17.5</span><br></pre></td></tr></table></figure>

<h4 id="JVM配置"><a href="#JVM配置" class="headerlink" title="JVM配置"></a>JVM配置</h4><blockquote>
<p>根据自己的内存自行调整，内存不够则会启动失败</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vi jvm.options</span><br><span class="line">- <span class="comment">##-Xms4g</span></span><br><span class="line">- <span class="comment">##-Xmx4g</span></span><br><span class="line">+ -Xms4g</span><br><span class="line">+ -Xmx4g</span><br></pre></td></tr></table></figure>

<h4 id="添加IK分词器"><a href="#添加IK分词器" class="headerlink" title="添加IK分词器"></a>添加IK分词器</h4><blockquote>
<p>因为后面要用到IK分词，所以我们要安装以下IK分词器</p>
</blockquote>
<h5 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h5><blockquote>
<p>在github中下载对应版本的分词器</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">https://github.com/medcl/elasticsearch-analysis-ik/releases</span><br></pre></td></tr></table></figure>

<blockquote>
<p>根据自己的ES版本选择相应版本的IK分词器，因为安装的ES是<code>7.17.5</code>，所以也下载相应的IK分词器</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch166.png" alt="image-20220805133634676"></p>
<h5 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h5><blockquote>
<p>将下载的分词器复制到ES安装目录的<code>plugins</code>目录中并进行解压</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkdir ik &amp;&amp; <span class="built_in">cd</span> ik</span><br><span class="line">unzip elasticsearch-analysis-ik-7.17.5.zip</span><br></pre></td></tr></table></figure>

<h4 id="启动ElasticSearch"><a href="#启动ElasticSearch" class="headerlink" title="启动ElasticSearch"></a>启动ElasticSearch</h4><h5 id="切换用户"><a href="#切换用户" class="headerlink" title="切换用户"></a>切换用户</h5><blockquote>
<p>切换到刚刚创建的<code>elasticsearch</code>用户</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">su elasticsearch</span><br></pre></td></tr></table></figure>

<h5 id="启动命令"><a href="#启动命令" class="headerlink" title="启动命令"></a>启动命令</h5><blockquote>
<p>我们可以使用以下命令来进行使用</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 前台启动</span></span><br><span class="line">sh bin/elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后台启动</span></span><br><span class="line">sh bin/elasticsearch -d</span><br></pre></td></tr></table></figure>

<h5 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h5><blockquote>
<p>访问对应宿主机的<code>9200</code>端口</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">http://192.168.245.151:9200/</span><br></pre></td></tr></table></figure>

<h5 id="重启ElasticSearch"><a href="#重启ElasticSearch" class="headerlink" title="重启ElasticSearch"></a>重启ElasticSearch</h5><h6 id="查找进程"><a href="#查找进程" class="headerlink" title="查找进程"></a>查找进程</h6><blockquote>
<p>先查找ElasticSearch的进程号</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ps -ef | grep elastic</span><br></pre></td></tr></table></figure>

<h5 id="杀死进程"><a href="#杀死进程" class="headerlink" title="杀死进程"></a>杀死进程</h5><blockquote>
<p>杀死对应的进程</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">kill</span> -9 49736</span><br></pre></td></tr></table></figure>

<h6 id="启动ElasticSearch-1"><a href="#启动ElasticSearch-1" class="headerlink" title="启动ElasticSearch"></a>启动ElasticSearch</h6><blockquote>
<p>注意不要使用ROOT用户启动</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sh bin/elasticsearch -d</span><br></pre></td></tr></table></figure>

<h4 id="kibana安装"><a href="#kibana安装" class="headerlink" title="kibana安装"></a>kibana安装</h4><h5 id="下载安装-Kibana"><a href="#下载安装-Kibana" class="headerlink" title="下载安装 Kibana"></a>下载安装 Kibana</h5><blockquote>
<p>kibana 版本 7.17.5<br>下载地址：<code>https://www.elastic.co/cn/downloads/past-releases/kibana-7-17-5</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/kibana/kibana-7.17.5-linux-x86_64.tar.gz</span><br><span class="line">tar -zvxf kibana-7.17.5-linux-x86_64.tar.gz</span><br><span class="line">mv kibana-7.17.5-linux-x86_64 kibana-7.17.5</span><br></pre></td></tr></table></figure>

<h5 id="配置-Kibana"><a href="#配置-Kibana" class="headerlink" title="配置 Kibana"></a>配置 Kibana</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi config/kibana.yml</span><br><span class="line">- <span class="comment">#server.port: 5601</span></span><br><span class="line">+ server.port: 5601</span><br><span class="line"></span><br><span class="line">- <span class="comment">#server.host: &quot;localhost&quot;</span></span><br><span class="line">+ server.host: <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"></span><br><span class="line">- <span class="comment">#elasticsearch.hosts: [&quot;http://localhost:9200&quot;]</span></span><br><span class="line">+ elasticsearch.hosts: [<span class="string">&quot;http://localhost:9200&quot;</span>]</span><br></pre></td></tr></table></figure>

<h5 id="启动-Kibana"><a href="#启动-Kibana" class="headerlink" title="启动 Kibana"></a>启动 Kibana</h5><h6 id="切换用户-1"><a href="#切换用户-1" class="headerlink" title="切换用户"></a>切换用户</h6><blockquote>
<p>Kibana也不能以root用户运行，需要切换到<code>elasticsearch权限</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">su elasticsearch</span><br></pre></td></tr></table></figure>

<h6 id="启动kibaba"><a href="#启动kibaba" class="headerlink" title="启动kibaba"></a>启动kibaba</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#前台运行</span></span><br><span class="line">sh bin/kibana</span><br><span class="line"></span><br><span class="line"><span class="comment">#后台运行</span></span><br><span class="line">nohup sh bin/kibana  &gt;/dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

<h6 id="访问测试-1"><a href="#访问测试-1" class="headerlink" title="访问测试"></a>访问测试</h6><blockquote>
<p>访问对应宿主机的<code>5601</code>端口</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">http://192.168.245.151:5601/</span><br></pre></td></tr></table></figure>

<h3 id="ES快速入门"><a href="#ES快速入门" class="headerlink" title="ES快速入门"></a>ES快速入门</h3><blockquote>
<p>下面我们看下ES的一些基本使用</p>
</blockquote>
<h4 id="索引管理"><a href="#索引管理" class="headerlink" title="索引管理"></a>索引管理</h4><blockquote>
<p>我们使用数据库的第一步就是创建数据库，同样ES也是一样的，第一步也是对索引进行管理</p>
</blockquote>
<h5 id="列出索引"><a href="#列出索引" class="headerlink" title="列出索引"></a>列出索引</h5><blockquote>
<p>我们使用索引的第一步就是列出索引，查看当前数据库有哪些索引</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GET /_cat/indices?v</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch013.png" alt="image-20220803141523322"></p>
<h5 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h5><blockquote>
<p>我们接下来要使用索引就需要创建索引了，Elasticsearch使用PUT方式来实现索引的新增</p>
</blockquote>
<p> 可以在创建索引的时候不添加任何参数，系统会为你创建一个默认的索引，当然你可以添加附加一些配置信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">PUT customer</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样我们就创建了一个索引</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch014.png" alt="image-20220803151216388"></p>
<h5 id="查看索引"><a href="#查看索引" class="headerlink" title="查看索引"></a>查看索引</h5><blockquote>
<p>索引创建完成后，我们接下来就需要对索引进行查询</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">get customer</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch015.png" alt="image-20220803151945360"></p>
<h6 id="结果说明"><a href="#结果说明" class="headerlink" title="结果说明"></a>结果说明</h6><blockquote>
<p>这里返回了一堆数据，具体什么含义呢，我们需要查看字段的详细信息</p>
</blockquote>
<table>
<thead>
<tr>
<th>字段</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>aliases</td>
<td>别名</td>
</tr>
<tr>
<td>mappings</td>
<td>映射</td>
</tr>
<tr>
<td>settings</td>
<td>配置</td>
</tr>
<tr>
<td>settings.index.creation_date</td>
<td>创建时间</td>
</tr>
<tr>
<td>settings.index.number_of_shards</td>
<td>数据分片数，索引要做多少个分片，只能在创建索引时指定，后期无法修改</td>
</tr>
<tr>
<td>settings.index.number_of_replicas</td>
<td>数据备份数，每个分片有多少个副本，后期可以动态修改</td>
</tr>
<tr>
<td>settings.index.uuid</td>
<td>索引id</td>
</tr>
<tr>
<td>settings.index.provided_name</td>
<td>名称</td>
</tr>
</tbody></table>
<h5 id="索引是否存在"><a href="#索引是否存在" class="headerlink" title="索引是否存在"></a>索引是否存在</h5><blockquote>
<p>有时候我们需要检查索引时候存在，我们可以使用HEAD命令验证索引是否存在</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">HEAD customer</span><br></pre></td></tr></table></figure>

<blockquote>
<p>出现200表示索引存在</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch016.png" alt="image-20220808142523378"></p>
<h5 id="关闭索引"><a href="#关闭索引" class="headerlink" title="关闭索引"></a>关闭索引</h5><blockquote>
<p>在一些业务场景，我们可能需要禁止掉某些索引的访问功能，但是又不想删除这个索引</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">post customer/_close</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里我们就把这个索引给关闭了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch017.png" alt="image-20220803152949392"></p>
<h6 id="查看索引列表"><a href="#查看索引列表" class="headerlink" title="查看索引列表"></a>查看索引列表</h6><blockquote>
<p>再次查看索引列表，查看索引的状态</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GET /_cat/indices?v</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现索引已经被关闭了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch018.png" alt="image-20220803153221311"></p>
<h6 id="为什么关闭索引"><a href="#为什么关闭索引" class="headerlink" title="为什么关闭索引"></a>为什么关闭索引</h6><blockquote>
<p>如果关闭了一个索引，就无法通过Elasticsearch 来读取和写人其中的数据，直到再次打开它</p>
</blockquote>
<p> 在现实世界中，最好永久地保存应用日志，以防要查看很久之前的信息，另一方面，在Elasticsearch中存放大量数据需要增加资源，对于这种使用案例，关闭旧的索引非常有意义，你可能并不需要那些数据，但是也不想删除它们。</p>
<p> 一旦索引被关闭，它在Elasticsearch内存中唯一的痕迹是其元数据，如名字以及分片的位置，如果有足够的磁盘空间，而且也不确定是否需要在那个数据中再次搜索，关闭索引要比删除索引更好，关闭它们会让你非常安心，随时可以重新打开被关闭的索引，然后在其中再次搜索</p>
<h5 id="打开索引"><a href="#打开索引" class="headerlink" title="打开索引"></a>打开索引</h5><blockquote>
<p>如果我们需要继续启动索引可以直接打开索引</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">post customer/_open</span><br></pre></td></tr></table></figure>

<blockquote>
<p>现在我们已经打开了索引</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch019.png" alt="image-20220803153430046"></p>
<h6 id="查看索引列表-1"><a href="#查看索引列表-1" class="headerlink" title="查看索引列表"></a>查看索引列表</h6><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GET /_cat/indices?v</span><br></pre></td></tr></table></figure>

<blockquote>
<p>现在索引的状态已经是打开的状态了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch020.png" alt="image-20220803153525409"></p>
<h5 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h5><blockquote>
<p>如果索引中的数据已经不需要了，可以被删除，我们是可以删除索引的，使用以下命令可以删除索引</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">delete customer</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样我们就把索引给删除了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch021.png" alt="image-20220803175601320"></p>
<h4 id="映射管理"><a href="#映射管理" class="headerlink" title="映射管理"></a>映射管理</h4><blockquote>
<p>映射的创建时基于索引的，你必须要先创建索引才能创建映射，es中的映射相当于传统数据库中的表结构，数据存储的格式就是通过映射来规定的</p>
</blockquote>
<h5 id="创建映射"><a href="#创建映射" class="headerlink" title="创建映射"></a>创建映射</h5><blockquote>
<p>可以在创建索引时指定映射，其中<code>mappings.properties</code>为固定结构，指定创建映射属性</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT customer</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch022.png" alt="image-20220808143910461"></p>
<h5 id="查看映射"><a href="#查看映射" class="headerlink" title="查看映射"></a>查看映射</h5><blockquote>
<p>查看索引完全信息，内容包含映射信息</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GET customer/_mapping</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch023.png" alt="image-20220808144250601"></p>
<h4 id="文档管理"><a href="#文档管理" class="headerlink" title="文档管理"></a>文档管理</h4><h5 id="创建文档-业务ID"><a href="#创建文档-业务ID" class="headerlink" title="创建文档(业务ID)"></a>创建文档(业务ID)</h5><blockquote>
<p>创建文档的时候我们可以手动来指定ID，但是一般不推荐，回对ES插入性能造成影响</p>
</blockquote>
<p> 如果手动指定ID，为了保证ID不冲突，会先查询一次文档库，如果不存在则进行插入，手动插入多了一次查询操作，性能会有损失。</p>
<h6 id="操作说明"><a href="#操作说明" class="headerlink" title="操作说明"></a>操作说明</h6><ul>
<li>文档可以类比为关系型数据库中的表数据，添加的数据格式为 JSON 格式</li>
<li>注意需要在索引后面添加<code>_doc</code>，表示操作文档</li>
<li>在未指定id生成情况，每执行一次post将生成一个新文档</li>
<li>如果index不存在，将会默认创建</li>
</ul>
<h6 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h6><blockquote>
<p>新增文档，自动生成文档id，并且如果如果添加文档的索引不存在时会自动创建索引</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">post customer/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot; : &quot;张三&quot;,</span><br><span class="line">    &quot;age&quot; : 15</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样我们就创建了一个文档</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch024.png" alt="image-20220803181022205"></p>
<h6 id="返回结果说明"><a href="#返回结果说明" class="headerlink" title="返回结果说明"></a>返回结果说明</h6><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;customer&quot;</span>,	#所属索引</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,  		#所属mapping type</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,				#文档id</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">1</span>,			#文档版本</span><br><span class="line">  <span class="attr">&quot;result&quot;</span> : <span class="string">&quot;created&quot;</span>,		#文档创建成功</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">2</span>,			#所在分片有两个分片</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,		#只有一个副本成功写入，可能节点机器只有一台</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span>			#失败副本数</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">0</span>,			#第几次操作该文档</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">1</span>		#词项数</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="创建文档-自动ID"><a href="#创建文档-自动ID" class="headerlink" title="创建文档(自动ID)"></a>创建文档(自动ID)</h5><blockquote>
<p>为了提高插入文档效率，我们一般会使用自动生成ID，这样减少一次插入时的查询性能损耗，插入时不指定文档ID，ES就会自动生成ID</p>
</blockquote>
<p> 自动生成的ID是一个不会重复的随机数，使用GUID算法，可以保证在分布式环境下，不同节点同一时间创建的<code>_id</code>一定是不冲突的</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">post customer/_doc</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;李四&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span> : <span class="number">50</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样创建了一个文档，并且文档ID是系统自动生成的<code>_id</code></p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch025.png" alt="image-20220803184615285"></p>
<h5 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h5><blockquote>
<p>更新文档和插入文档一样，如果文档ID一致则会进行覆盖更新，而更新又分为全量更新和增量更新</p>
</blockquote>
<h6 id="全量更新"><a href="#全量更新" class="headerlink" title="全量更新"></a>全量更新</h6><blockquote>
<p>和新增文档一样，输入相同的 URL 地址请求，如果请求体变化，会将原有的数据内容<strong>覆盖</strong></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">post customer/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span> : <span class="number">50</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch026.png" alt="image-20220803184231987"></p>
<h6 id="增量更新"><a href="#增量更新" class="headerlink" title="增量更新"></a>增量更新</h6><blockquote>
<p>通过指定<code>_doc</code>方式默认是全量更新，如果需要更新指定字段则需要将<code>_doc</code>改为<code>_update</code>，请求内容需要增加doc表示，原始<code>&#123;“key”: value&#125;</code>，更新<code>&#123;“doc”: &#123;“key”: value&#125;&#125;</code></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">post customer/_update/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;doc&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;age&quot;</span> : <span class="number">55</span></span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h5><h6 id="验证是否存在"><a href="#验证是否存在" class="headerlink" title="验证是否存在"></a>验证是否存在</h6><blockquote>
<p>可以通过以下命令检查文档是否存在</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">HEAD customer/_doc/1  #查看是否存储，返回200表示已存储</span><br></pre></td></tr></table></figure>

<h6 id="查询文档-1"><a href="#查询文档-1" class="headerlink" title="查询文档"></a>查询文档</h6><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GET customer/_doc/1  #返回源数据的查询</span><br></pre></td></tr></table></figure>

<h6 id="不返回source"><a href="#不返回source" class="headerlink" title="不返回source"></a>不返回source</h6><blockquote>
<p>有时候只是查询，不需要具体的源文档字段，这样可以提高查询速度，可以使用以下方式</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GET customer/_doc/1?_source=false</span><br></pre></td></tr></table></figure>

<h6 id="查询所有"><a href="#查询所有" class="headerlink" title="查询所有"></a>查询所有</h6><blockquote>
<p>上述只能查询单个，可以查询所有文档，将<code>_doc</code>替换为<code>_search</code></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GET customer/_search</span><br></pre></td></tr></table></figure>

<h5 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h5><h6 id="根据文档ID删除"><a href="#根据文档ID删除" class="headerlink" title="根据文档ID删除"></a>根据文档ID删除</h6><blockquote>
<p>我们可以根据文档ID进行删除</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">DELETE customer/_doc/1  #指定文档id进行删除</span><br></pre></td></tr></table></figure>

<h6 id="根据条件删除"><a href="#根据条件删除" class="headerlink" title="根据条件删除"></a>根据条件删除</h6><blockquote>
<p>根据查询条件删除，会先查询然后在删除，可能耗时会比较长</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">post customer/_delete_by_query</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; </span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;age&quot;: &quot;15&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="中文分词器"><a href="#中文分词器" class="headerlink" title="中文分词器"></a>中文分词器</h4><h5 id="IKAnalyzer"><a href="#IKAnalyzer" class="headerlink" title="IKAnalyzer"></a>IKAnalyzer</h5><blockquote>
<p>IKAnalyzer是一个开源的，基于java的语言开发的轻量级的中文分词工具包</p>
</blockquote>
<p> 从2006年12月推出1.0版开始，IKAnalyzer已经推出了3个大版本，在 2012 版本中，IK 实现了简单的分词歧义排除算法，标志着 IK 分词器从单纯的词典分词向模拟语义分词衍化</p>
<h5 id="使用IK分词器"><a href="#使用IK分词器" class="headerlink" title="使用IK分词器"></a>使用IK分词器</h5><blockquote>
<p>IK提供了两个分词算法:</p>
</blockquote>
<ul>
<li>ik_smart：最少切分。</li>
<li>ik_max_word：最细粒度划分。</li>
</ul>
<h5 id="ik-smart"><a href="#ik-smart" class="headerlink" title="ik_smart"></a>ik_smart</h5><h6 id="使用案例"><a href="#使用案例" class="headerlink" title="使用案例"></a>使用案例</h6><blockquote>
<p>原始内容</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">传智教育的教学质量是杠杠的</span><br></pre></td></tr></table></figure>

<h6 id="测试分词"><a href="#测试分词" class="headerlink" title="测试分词"></a>测试分词</h6><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;传智教育的教学质量是杠杠的&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch167.png" alt="image-20220808115450647"></p>
<h5 id="ik-max-word"><a href="#ik-max-word" class="headerlink" title="ik_max_word"></a>ik_max_word</h5><h6 id="使用案例-1"><a href="#使用案例-1" class="headerlink" title="使用案例"></a>使用案例</h6><blockquote>
<p>原始内容</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">传智教育的教学质量是杠杠的</span><br></pre></td></tr></table></figure>

<h6 id="测试分词-1"><a href="#测试分词-1" class="headerlink" title="测试分词"></a>测试分词</h6><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;传智教育的教学质量是杠杠的&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch168.png" alt="image-20220808115513668"></p>
<h5 id="自定义词库"><a href="#自定义词库" class="headerlink" title="自定义词库"></a>自定义词库</h5><blockquote>
<p>我们在使用IK分词器时会发现其实有时候分词的效果也并不是我们所期待的</p>
</blockquote>
<h6 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h6><p> 例如我们输入“传智教育的教学质量是杠杠的”，但是分词器会把“传智教育”进行拆开，分为了“传”，“智”，“教育”，但我们希望的是<strong>“传智教育”可以不被拆开</strong>。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch169.png" alt="image-20220808115543696"></p>
<h5 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h5><blockquote>
<p>对于以上的问题，我们只需要将自己要保留的词，加到我们的分词器的字典中即可</p>
</blockquote>
<h6 id="编辑字典内容"><a href="#编辑字典内容" class="headerlink" title="编辑字典内容"></a>编辑字典内容</h6><blockquote>
<p>进入elasticsearch目录<code>plugins/ik/config</code>中，创建我们自己的字典文件<code>yixin.dic</code>，并添加内容：</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd plugins/ik/config</span><br><span class="line">echo &quot;传智教育&quot; &gt; custom.dic</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch170.png" alt="image-20220808115806628"></p>
<h6 id="扩展字典"><a href="#扩展字典" class="headerlink" title="扩展字典"></a>扩展字典</h6><blockquote>
<p>进入我们的elasticsearch目录 ：<code>plugins/ik/config</code>，打开<code>IKAnalyzer.cfg.xml</code>文件，进行如下配置：</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vi IKAnalyzer.cfg.xml</span><br><span class="line"><span class="meta">#</span><span class="bash">增加如下内容</span></span><br><span class="line">&lt;entry key=&quot;ext_dict&quot;&gt;custom.dic&lt;/entry&gt;</span><br></pre></td></tr></table></figure>

<h6 id="再次测试"><a href="#再次测试" class="headerlink" title="再次测试"></a>再次测试</h6><blockquote>
<p>重启ElasticSearch，再次使用kibana测试</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;传智教育的教学质量是杠杠的&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以发现，现在我们的词汇”传智教育”就不会被拆开了，达到我们想要的效果了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch171.png" alt="image-20220808134046401"></p>
<h2 id="ElasticSearch-集群部署"><a href="#ElasticSearch-集群部署" class="headerlink" title="ElasticSearch 集群部署"></a>ElasticSearch 集群部署</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch001.png" alt="img"></p>
<h3 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h3><blockquote>
<p>我们将ES的服务部署和同步服务部署分为两套，因为后期我们数据同步完成可以将异构数据同步的服务停止掉</p>
</blockquote>
<h4 id="服务布局"><a href="#服务布局" class="headerlink" title="服务布局"></a>服务布局</h4><blockquote>
<p>我们整体采用Docker方式进行布局，以下是我们需要部署的服务</p>
</blockquote>
<table>
<thead>
<tr>
<th>服务名称</th>
<th>服务名称</th>
<th>开放端口</th>
<th>内存限制</th>
</tr>
</thead>
<tbody><tr>
<td>ES-node1</td>
<td>node-1</td>
<td>9200</td>
<td>1G</td>
</tr>
<tr>
<td>ES-node2</td>
<td>node-2</td>
<td>9201</td>
<td>1G</td>
</tr>
<tr>
<td>ES-node3</td>
<td>node-3</td>
<td>9202</td>
<td>1G</td>
</tr>
<tr>
<td>ES-cerebro</td>
<td>cerebro</td>
<td>9100</td>
<td>不限</td>
</tr>
<tr>
<td>kibana</td>
<td>kibana</td>
<td>5601</td>
<td>不限</td>
</tr>
</tbody></table>
<h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><h5 id="创建挂载目录"><a href="#创建挂载目录" class="headerlink" title="创建挂载目录"></a>创建挂载目录</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#创建配置目录</span></span><br><span class="line">mkdir -p /tmp/etc/elasticsearch/node-&#123;1..3&#125;/&#123;config,plugins&#125;</span><br><span class="line"><span class="comment"># 创建kibana的配置目录</span></span><br><span class="line">mkdir -p /tmp/data/kibana/config</span><br><span class="line"><span class="comment"># 创建数据目录</span></span><br><span class="line">mkdir -p /tmp/data/elasticsearch/node-&#123;1..3&#125;/&#123;data,<span class="built_in">log</span>&#125;</span><br></pre></td></tr></table></figure>

<h5 id="目录授权"><a href="#目录授权" class="headerlink" title="目录授权"></a>目录授权</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chmod 777 /tmp/etc/elasticsearch/node-&#123;1..3&#125;/&#123;config,plugins&#125;</span><br><span class="line">chmod 777 /tmp/etc/kibana/config</span><br><span class="line">chmod 777 /tmp/data/elasticsearch/node-&#123;1..3&#125;/&#123;data,<span class="built_in">log</span>&#125;</span><br></pre></td></tr></table></figure>

<h5 id="修改Linux句柄数-1"><a href="#修改Linux句柄数-1" class="headerlink" title="修改Linux句柄数"></a>修改Linux句柄数</h5><h6 id="查看当前最大句柄数-1"><a href="#查看当前最大句柄数-1" class="headerlink" title="查看当前最大句柄数"></a>查看当前最大句柄数</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sysctl -a | grep vm.max_map_count</span><br></pre></td></tr></table></figure>

<h6 id="修改句柄数-1"><a href="#修改句柄数-1" class="headerlink" title="修改句柄数"></a>修改句柄数</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line">+ vm.max_map_count=262144</span><br></pre></td></tr></table></figure>

<h6 id="生效配置-1"><a href="#生效配置-1" class="headerlink" title="生效配置"></a>生效配置</h6><blockquote>
<p>修改后需要重启才能生效，不想重启可以设置临时生效</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sysctl -w vm.max_map_count=262144</span><br></pre></td></tr></table></figure>

<h5 id="修改句柄数和最大线程数"><a href="#修改句柄数和最大线程数" class="headerlink" title="修改句柄数和最大线程数"></a>修改句柄数和最大线程数</h5><h6 id="配置修改-1"><a href="#配置修改-1" class="headerlink" title="配置修改"></a>配置修改</h6><blockquote>
<p>修改后需要重新登录生效</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/security/limits.conf</span><br><span class="line"><span class="comment"># 添加以下内容</span></span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br><span class="line">* soft nproc 4096</span><br><span class="line">* hard nproc 4096</span><br></pre></td></tr></table></figure>

<h6 id="重启服务-1"><a href="#重启服务-1" class="headerlink" title="重启服务"></a>重启服务</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h5 id="添加IK分词器-1"><a href="#添加IK分词器-1" class="headerlink" title="添加IK分词器"></a>添加IK分词器</h5><blockquote>
<p>因为后面要用到IK分词，所以我们要安装以下IK分词器</p>
</blockquote>
<h6 id="查找-1"><a href="#查找-1" class="headerlink" title="查找"></a>查找</h6><blockquote>
<p>在github中下载对应版本的分词器</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://github.com/medcl/elasticsearch-analysis-ik/releases</span><br></pre></td></tr></table></figure>

<blockquote>
<p>根据自己的ES版本选择相应版本的IK分词器，因为安装的ES是<code>7.17.5</code>，所以也下载相应的IK分词器</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch294.png" alt="image-20220805133634676"></p>
<h6 id="解压-1"><a href="#解压-1" class="headerlink" title="解压"></a>解压</h6><blockquote>
<p>将下载的分词器复制到ES安装目录的<code>plugins</code>目录中并进行解压</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir ik &amp;&amp; <span class="built_in">cd</span> ik</span><br><span class="line">unzip elasticsearch-analysis-ik-7.17.5.zip</span><br></pre></td></tr></table></figure>

<h6 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cp -R ik/ /tmp/etc/elasticsearch/node-1/plugins/</span><br><span class="line">cp -R ik/ /tmp/etc/elasticsearch/node-2/plugins/</span><br><span class="line">cp -R ik/ /tmp/etc/elasticsearch/node-3/plugins/</span><br></pre></td></tr></table></figure>

<h4 id="编写配置文件"><a href="#编写配置文件" class="headerlink" title="编写配置文件"></a>编写配置文件</h4><h5 id="node-1"><a href="#node-1" class="headerlink" title="node-1"></a>node-1</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /tmp/data/elasticsearch/node-1/config/elasticsearch.yml</span><br><span class="line"><span class="comment">#集群名称</span></span><br><span class="line">cluster.name: elastic</span><br><span class="line"><span class="comment">#当前该节点的名称</span></span><br><span class="line">node.name: node-1</span><br><span class="line"><span class="comment">#是不是有资格竞选主节点</span></span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line"><span class="comment">#是否存储数据</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line"><span class="comment">#最大集群节点数</span></span><br><span class="line">node.max_local_storage_nodes: 3</span><br><span class="line"><span class="comment">#给当前节点自定义属性（可以省略）</span></span><br><span class="line"><span class="comment">#node.attr.rack: r1</span></span><br><span class="line"><span class="comment">#数据存档位置</span></span><br><span class="line">path.data: /usr/share/elasticsearch/data</span><br><span class="line"><span class="comment">#日志存放位置</span></span><br><span class="line">path.logs: /usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line"><span class="comment">#是否开启时锁定内存（默认为是）</span></span><br><span class="line"><span class="comment">#bootstrap.memory_lock: true</span></span><br><span class="line"><span class="comment">#设置网关地址，我是被这个坑死了，这个地址我原先填写了自己的实际物理IP地址，</span></span><br><span class="line"><span class="comment">#然后启动一直报无效的IP地址，无法注入9300端口，这里只需要填写0.0.0.0</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="comment">#设置映射端口</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="comment">#内部节点之间沟通端口</span></span><br><span class="line">transport.tcp.port: 9300</span><br><span class="line"><span class="comment">#集群发现默认值为127.0.0.1:9300,如果要在其他主机上形成包含节点的群集,如果搭建集群则需要填写</span></span><br><span class="line"><span class="comment">#es7.x 之后新增的配置，写入候选主节点的设备地址，在开启服务后可以被选为主节点，也就是说把所有的节点都写上</span></span><br><span class="line">discovery.seed_hosts: [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"><span class="comment">#当你在搭建集群的时候，选出合格的节点集群，有些人说的太官方了，</span></span><br><span class="line"><span class="comment">#其实就是，让你选择比较好的几个节点，在你节点启动时，在这些节点中选一个做领导者，</span></span><br><span class="line"><span class="comment">#如果你不设置呢，elasticsearch就会自己选举，这里我们把三个节点都写上</span></span><br><span class="line">cluster.initial_master_nodes: [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"><span class="comment">#在群集完全重新启动后阻止初始恢复，直到启动N个节点</span></span><br><span class="line"><span class="comment">#简单点说在集群启动后，至少复活多少个节点以上，那么这个服务才可以被使用，否则不可以被使用，</span></span><br><span class="line">gateway.recover_after_nodes: 2</span><br><span class="line"><span class="comment">#删除索引是是否需要显示其名称，默认为显示</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true</span></span><br><span class="line"><span class="comment"># 禁用安全配置，否则查询的时候会提示警告</span></span><br><span class="line">xpack.security.enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h5 id="node-2"><a href="#node-2" class="headerlink" title="node-2"></a>node-2</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /tmp/data/elasticsearch/node-2/config/elasticsearch.yml</span><br><span class="line"><span class="comment">#集群名称</span></span><br><span class="line">cluster.name: elastic</span><br><span class="line"><span class="comment">#当前该节点的名称</span></span><br><span class="line">node.name: node-2</span><br><span class="line"><span class="comment">#是不是有资格竞选主节点</span></span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line"><span class="comment">#是否存储数据</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line"><span class="comment">#最大集群节点数</span></span><br><span class="line">node.max_local_storage_nodes: 3</span><br><span class="line"><span class="comment">#给当前节点自定义属性（可以省略）</span></span><br><span class="line"><span class="comment">#node.attr.rack: r1</span></span><br><span class="line"><span class="comment">#数据存档位置</span></span><br><span class="line">path.data: /usr/share/elasticsearch/data</span><br><span class="line"><span class="comment">#日志存放位置</span></span><br><span class="line">path.logs: /usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line"><span class="comment">#是否开启时锁定内存（默认为是）</span></span><br><span class="line"><span class="comment">#bootstrap.memory_lock: true</span></span><br><span class="line"><span class="comment">#设置网关地址，我是被这个坑死了，这个地址我原先填写了自己的实际物理IP地址，</span></span><br><span class="line"><span class="comment">#然后启动一直报无效的IP地址，无法注入9300端口，这里只需要填写0.0.0.0</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="comment">#设置映射端口</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="comment">#内部节点之间沟通端口</span></span><br><span class="line">transport.tcp.port: 9300</span><br><span class="line"><span class="comment">#集群发现默认值为127.0.0.1:9300,如果要在其他主机上形成包含节点的群集,如果搭建集群则需要填写</span></span><br><span class="line"><span class="comment">#es7.x 之后新增的配置，写入候选主节点的设备地址，在开启服务后可以被选为主节点，也就是说把所有的节点都写上</span></span><br><span class="line">discovery.seed_hosts: [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"><span class="comment">#当你在搭建集群的时候，选出合格的节点集群，有些人说的太官方了，</span></span><br><span class="line"><span class="comment">#其实就是，让你选择比较好的几个节点，在你节点启动时，在这些节点中选一个做领导者，</span></span><br><span class="line"><span class="comment">#如果你不设置呢，elasticsearch就会自己选举，这里我们把三个节点都写上</span></span><br><span class="line">cluster.initial_master_nodes: [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"><span class="comment">#在群集完全重新启动后阻止初始恢复，直到启动N个节点</span></span><br><span class="line"><span class="comment">#简单点说在集群启动后，至少复活多少个节点以上，那么这个服务才可以被使用，否则不可以被使用，</span></span><br><span class="line">gateway.recover_after_nodes: 2</span><br><span class="line"><span class="comment">#删除索引是是否需要显示其名称，默认为显示</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true</span></span><br><span class="line"><span class="comment"># 禁用安全配置，否则查询的时候会提示警告</span></span><br><span class="line">xpack.security.enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h5 id="node-3"><a href="#node-3" class="headerlink" title="node-3"></a>node-3</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /tmp/data/elasticsearch/node-3/config/elasticsearch.yml</span><br><span class="line"><span class="comment">#集群名称</span></span><br><span class="line">cluster.name: elastic</span><br><span class="line"><span class="comment">#当前该节点的名称</span></span><br><span class="line">node.name: node-3</span><br><span class="line"><span class="comment">#是不是有资格竞选主节点</span></span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line"><span class="comment">#是否存储数据</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line"><span class="comment">#最大集群节点数</span></span><br><span class="line">node.max_local_storage_nodes: 3</span><br><span class="line"><span class="comment">#给当前节点自定义属性（可以省略）</span></span><br><span class="line"><span class="comment">#node.attr.rack: r1</span></span><br><span class="line"><span class="comment">#数据存档位置</span></span><br><span class="line">path.data: /usr/share/elasticsearch/data</span><br><span class="line"><span class="comment">#日志存放位置</span></span><br><span class="line">path.logs: /usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line"><span class="comment">#是否开启时锁定内存（默认为是）</span></span><br><span class="line"><span class="comment">#bootstrap.memory_lock: true</span></span><br><span class="line"><span class="comment">#设置网关地址，我是被这个坑死了，这个地址我原先填写了自己的实际物理IP地址，</span></span><br><span class="line"><span class="comment">#然后启动一直报无效的IP地址，无法注入9300端口，这里只需要填写0.0.0.0</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="comment">#设置映射端口</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="comment">#内部节点之间沟通端口</span></span><br><span class="line">transport.tcp.port: 9300</span><br><span class="line"><span class="comment">#集群发现默认值为127.0.0.1:9300,如果要在其他主机上形成包含节点的群集,如果搭建集群则需要填写</span></span><br><span class="line"><span class="comment">#es7.x 之后新增的配置，写入候选主节点的设备地址，在开启服务后可以被选为主节点，也就是说把所有的节点都写上</span></span><br><span class="line">discovery.seed_hosts: [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"><span class="comment">#当你在搭建集群的时候，选出合格的节点集群，有些人说的太官方了，</span></span><br><span class="line"><span class="comment">#其实就是，让你选择比较好的几个节点，在你节点启动时，在这些节点中选一个做领导者，</span></span><br><span class="line"><span class="comment">#如果你不设置呢，elasticsearch就会自己选举，这里我们把三个节点都写上</span></span><br><span class="line">cluster.initial_master_nodes: [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"><span class="comment">#在群集完全重新启动后阻止初始恢复，直到启动N个节点</span></span><br><span class="line"><span class="comment">#简单点说在集群启动后，至少复活多少个节点以上，那么这个服务才可以被使用，否则不可以被使用，</span></span><br><span class="line">gateway.recover_after_nodes: 2</span><br><span class="line"><span class="comment">#删除索引是是否需要显示其名称，默认为显示</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true</span></span><br><span class="line"><span class="comment"># 禁用安全配置，否则查询的时候会提示警告</span></span><br><span class="line">xpack.security.enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h5 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi  /tmp/data/kibana/config/kibana.yml</span><br><span class="line">server.host: 0.0.0.0</span><br><span class="line"><span class="comment"># 监听端口</span></span><br><span class="line">server.port: 5601</span><br><span class="line">server.name: <span class="string">&quot;kibana&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kibana访问es服务器的URL,就可以有多个，以逗号&quot;,&quot;隔开</span></span><br><span class="line">elasticsearch.hosts: [<span class="string">&quot;http://node-1:9200&quot;</span>,<span class="string">&quot;http://node-2:9201&quot;</span>,<span class="string">&quot;http://node-3:9202&quot;</span>]</span><br><span class="line">monitoring.ui.container.elasticsearch.enabled: <span class="literal">true</span></span><br><span class="line"><span class="comment"># kibana访问Elasticsearch的账号与密码(如果ElasticSearch设置了的话)</span></span><br><span class="line">elasticsearch.username: <span class="string">&quot;kibana&quot;</span></span><br><span class="line">elasticsearch.password: <span class="string">&quot;12345&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kibana日志文件存储路径</span></span><br><span class="line">logging.dest: stdout</span><br><span class="line"><span class="comment"># 此值为true时，禁止所有日志记录输出</span></span><br><span class="line">logging.silent: <span class="literal">false</span></span><br><span class="line"><span class="comment"># 此值为true时，禁止除错误消息之外的所有日志记录输出</span></span><br><span class="line">logging.quiet: <span class="literal">false</span></span><br><span class="line"><span class="comment"># 此值为true时，记录所有事件，包括系统使用信息和所有请求</span></span><br><span class="line">logging.verbose: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">ops.interval: 5000</span><br><span class="line"><span class="comment"># kibana web语言</span></span><br><span class="line">i18n.locale: <span class="string">&quot;zh-CN&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="编写部署文档"><a href="#编写部署文档" class="headerlink" title="编写部署文档"></a>编写部署文档</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi docker-compose.yml</span><br><span class="line">version: <span class="string">&quot;3&quot;</span></span><br><span class="line">services:</span><br><span class="line">  node-1:</span><br><span class="line">    image: elasticsearch:7.17.5</span><br><span class="line">    container_name: node-1</span><br><span class="line">    environment:</span><br><span class="line">      - <span class="string">&quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;</span></span><br><span class="line">      - <span class="string">&quot;TZ=Asia/Shanghai&quot;</span></span><br><span class="line">    ulimits:</span><br><span class="line">      memlock:</span><br><span class="line">        soft: -1</span><br><span class="line">        hard: -1</span><br><span class="line">      nofile:</span><br><span class="line">        soft: 65536</span><br><span class="line">        hard: 65536</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9200:9200&quot;</span></span><br><span class="line">    logging:</span><br><span class="line">      driver: <span class="string">&quot;json-file&quot;</span></span><br><span class="line">      options:</span><br><span class="line">        max-size: <span class="string">&quot;50m&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /tmp/etc/elasticsearch/node-1/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span><br><span class="line">      - /tmp/etc/elasticsearch/node-1/plugins:/usr/share/elasticsearch/plugins</span><br><span class="line">      - /tmp/data/elasticsearch/node-1/data:/usr/share/elasticsearch/data</span><br><span class="line">      - /tmp/data/elasticsearch/node-1/<span class="built_in">log</span>:/usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">  node-2:</span><br><span class="line">    image: elasticsearch:7.17.5</span><br><span class="line">    container_name: node-2</span><br><span class="line">    environment:</span><br><span class="line">      - <span class="string">&quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;</span></span><br><span class="line">      - <span class="string">&quot;TZ=Asia/Shanghai&quot;</span></span><br><span class="line">    ulimits:</span><br><span class="line">      memlock:</span><br><span class="line">        soft: -1</span><br><span class="line">        hard: -1</span><br><span class="line">      nofile:</span><br><span class="line">        soft: 65536</span><br><span class="line">        hard: 65536</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9201:9200&quot;</span></span><br><span class="line">    logging:</span><br><span class="line">      driver: <span class="string">&quot;json-file&quot;</span></span><br><span class="line">      options:</span><br><span class="line">        max-size: <span class="string">&quot;50m&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /tmp/etc/elasticsearch/node-2/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span><br><span class="line">      - /tmp/etc/elasticsearch/node-2/plugins:/usr/share/elasticsearch/plugins</span><br><span class="line">      - /tmp/data/elasticsearch/node-2/data:/usr/share/elasticsearch/data</span><br><span class="line">      - /tmp/data/elasticsearch/node-2/<span class="built_in">log</span>:/usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">  node-3:</span><br><span class="line">    image: elasticsearch:7.17.5</span><br><span class="line">    container_name: node-3</span><br><span class="line">    environment:</span><br><span class="line">      - <span class="string">&quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;</span></span><br><span class="line">      - <span class="string">&quot;TZ=Asia/Shanghai&quot;</span></span><br><span class="line">    ulimits:</span><br><span class="line">      memlock:</span><br><span class="line">        soft: -1</span><br><span class="line">        hard: -1</span><br><span class="line">      nofile:</span><br><span class="line">        soft: 65536</span><br><span class="line">        hard: 65536</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9202:9200&quot;</span></span><br><span class="line">    logging:</span><br><span class="line">      driver: <span class="string">&quot;json-file&quot;</span></span><br><span class="line">      options:</span><br><span class="line">        max-size: <span class="string">&quot;50m&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /tmp/etc/elasticsearch/node-3/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span><br><span class="line">      - /tmp/etc/elasticsearch/node-3/plugins:/usr/share/elasticsearch/plugins</span><br><span class="line">      - /tmp/data/elasticsearch/node-3/data:/usr/share/elasticsearch/data</span><br><span class="line">      - /tmp/data/elasticsearch/node-3/<span class="built_in">log</span>:/usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">  kibana:</span><br><span class="line">    container_name: kibana</span><br><span class="line">    image: kibana:7.17.5</span><br><span class="line">    volumes:</span><br><span class="line">      - /tmp/data/kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml</span><br><span class="line">    ports:</span><br><span class="line">      - 5601:5601</span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">  elasticsearch-head:</span><br><span class="line">      image: wallbase/elasticsearch-head:6-alpine</span><br><span class="line">      container_name: elasticsearch-head</span><br><span class="line">      environment:</span><br><span class="line">        TZ: <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line">      ports:</span><br><span class="line">        - <span class="string">&#x27;9100:9100&#x27;</span></span><br><span class="line">      networks:</span><br><span class="line">        - elastic</span><br><span class="line">networks:</span><br><span class="line">  elastic:</span><br><span class="line">    driver: bridge</span><br></pre></td></tr></table></figure>

<h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><blockquote>
<p>使用以下命令就可以启动服务了</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<h2 id="ELK异构数据同步"><a href="#ELK异构数据同步" class="headerlink" title="ELK异构数据同步"></a>ELK异构数据同步</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch160.png" alt="img"></p>
<h3 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h3><h4 id="什么是ELK"><a href="#什么是ELK" class="headerlink" title="什么是ELK"></a>什么是ELK</h4><blockquote>
<p>ELK是三个开源软件的缩写，分别表示：Elasticsearch , Logstash, Kibana , 它们都是开源软件</p>
</blockquote>
<ul>
<li>Elasticsearch是强大的数据搜索引擎，并且是分布式、能够通过restful方式进行交互的近实时搜索平台框架</li>
<li>Logstash是免费且开源的服务器端数据处理通道，能够从多个来源收集数据，能够对数据进行转换和清洗，将转换数据后将数据发送到数据存储库中，并且不受格式和复杂度的影响。</li>
<li>Kibana是针对Elasticsearch的开源分析及可视化平台，用于搜索、查看交互存储在Elasticsearch索引中的数据。</li>
</ul>
<h4 id="ELK能做什么"><a href="#ELK能做什么" class="headerlink" title="ELK能做什么"></a>ELK能做什么</h4><h5 id="日志收集"><a href="#日志收集" class="headerlink" title="日志收集"></a>日志收集</h5><blockquote>
<p>一般我们需要进行日志分析场景：直接在日志文件中 grep、awk 就可以获得自己想要的信息</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch161.png" alt="img"></p>
<p> 但在规模较大的场景中，此方法效率低下，面临问题包括日志量太大如何归档、文本搜索太慢怎么办、如何多维度查询，需要集中化的日志管理，所有服务器上的日志收集汇总，常见解决思路是建立集中式日志收集系统，将所有节点上的日志统一收集，管理，访问。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch162.png" alt="img"></p>
<p> 一般大型系统是一个分布式部署的架构，不同的服务模块部署在不同的服务器上，问题出现时，大部分情况需要根据问题暴露的关键信息，定位到具体的服务器和服务模块，构建一套集中式日志系统，可以提高定位问题的效率。</p>
<blockquote>
<p>一个完整的集中式日志系统，需要包含以下几个主要特点：</p>
</blockquote>
<ul>
<li>收集－能够采集多种来源的日志数据</li>
<li>传输－能够稳定的把日志数据传输到中央系统</li>
<li>存储－如何存储日志数据</li>
<li>分析－可以支持 UI 分析</li>
<li>警告－能够提供错误报告，监控机制</li>
</ul>
<p>ELK提供了一整套解决方案，并且都是开源软件，之间互相配合使用，完美衔接，高效的满足了很多场合的应用，是目前主流的一种日志分析平台。</p>
<h5 id="异构数据同步"><a href="#异构数据同步" class="headerlink" title="异构数据同步"></a>异构数据同步</h5><blockquote>
<p>我们可以借助ELK来帮助我们将数据库中的数据同步到ES中</p>
</blockquote>
<p> 我们要将MySQL中的数据同步到ES中可能比较麻烦，但是我们借助<code>ELK+Canal</code>可以很轻易的就可以实现，我们现在要做一个全国小区房产的全文检索系统，但是使用MySQL进行全文检索会很麻烦，我们要使用ElasticSearch进行全文检索，就要涉及到异构数据的同步。</p>
<blockquote>
<p>下面是我们的整体架构图</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch163.png" alt="image-20220819144214109"></p>
<h4 id="常用组件介绍"><a href="#常用组件介绍" class="headerlink" title="常用组件介绍"></a>常用组件介绍</h4><blockquote>
<p>我们实现异构数据同步平台涉及到一下的组件</p>
</blockquote>
<h5 id="MySQL服务"><a href="#MySQL服务" class="headerlink" title="MySQL服务"></a>MySQL服务</h5><p> MySQL是我们的主数据库，所有的操作都会写入到MySQL数据库，这个是我们的主要的数据库，因为MySQL不适合于全文检索，所以我们需要将数据同步的ES中，通过ES来进行全文检索</p>
<h5 id="Canal"><a href="#Canal" class="headerlink" title="Canal"></a>Canal</h5><blockquote>
<p>canal是用java开发的基于数据库增量日志解析，提供增量数据订阅&amp;消费的中间件。</p>
</blockquote>
<p> 目前，canal主要支持了MySQL的binlog解析，解析完成后才利用canal client 用来处理获得的相关数据。（数据库同步需要阿里的otter中间件，基于canal）</p>
<p> 我们这里使用Canal同步来将我们的MySQL的数据同步到ES中</p>
<h6 id="canal-原理"><a href="#canal-原理" class="headerlink" title="canal 原理"></a>canal 原理</h6><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch164.png" alt="img"></p>
<p> canal的工作原理就是把自己伪装成MySQL slave，模拟MySQL slave的交互协议向MySQL Mater发送 dump协议，MySQL mater收到canal发送过来的dump请求，开始推送binary log给canal，然后canal解析binary log，再发送到存储目的地，比如MySQL，Kafka，Elastic Search等等。</p>
<h5 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h5><blockquote>
<p><strong>RabbitMQ</strong>是实现了高级消息队列协议（AMQP）的开源消息代理软件（亦称面向消息的中间件）</p>
</blockquote>
<p> 我们这里使用RabbitMQ来进行消息的削峰填谷，因为全国的房产数据的操作会很频繁，数据量很大的情况下我们需要使用MQ来进行缓冲数据，这样可以进行大量数据的快速同步</p>
<h5 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h5><blockquote>
<p>Logstash是具有实时流水线能力的开源的数据收集引擎</p>
</blockquote>
<p> Logstash可以动态统一不同来源的数据，并将数据标准化到您选择的目标输出，它提供了大量插件，可帮助我们解析，丰富，转换和缓冲任何类型的数据。</p>
<p> 我们需要使用logstash对RabbitMQ过来的数据进行解析以及清晰，并将清洗过的数据放进ES中</p>
<h5 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h5><blockquote>
<p>Elasticsearch 是一个分布式的开源搜索和分析引擎，在 Apache Lucene 的基础上开发而成。</p>
</blockquote>
<p> 我们使用ElasticSearch存储logstash清洗完成的数据，通过ES可以对数据进行全文检索，Elasticsearch还是一个分布式文档数据库，其中每个字段均可被索引，而且每个字段的数据均可被搜索，ES能够横向扩展至数以百计的服务器存储以及处理PB级的数据，可以在极短的时间内存储、搜索和分析大量的数据</p>
<h5 id="kibana-1"><a href="#kibana-1" class="headerlink" title="kibana"></a>kibana</h5><blockquote>
<p>针对es的ES的开源分析可视化工具，与存储在ES的数据进行交互</p>
</blockquote>
<p> Kibana是一个开源的分析与可视化平台，设计出来用于和Elasticsearch一起使用的，你可以用kibana搜索、查看存放在Elasticsearch中的数据，Kibana与Elasticsearch的交互方式是各种不同的图表、表格、地图等，直观的展示数据，从而达到高级的数据分析与可视化的目的。</p>
<h3 id="ES物理部署"><a href="#ES物理部署" class="headerlink" title="ES物理部署"></a>ES物理部署</h3><h4 id="ES单机部署"><a href="#ES单机部署" class="headerlink" title="ES单机部署"></a>ES单机部署</h4><h5 id="下载-Elasticsearch-1"><a href="#下载-Elasticsearch-1" class="headerlink" title="下载 Elasticsearch"></a>下载 Elasticsearch</h5><blockquote>
<p>我们下载的Elasticsearch 版本是 7.17.5，下载地址<code>https://www.elastic.co/cn/downloads/past-releases/elasticsearch-7-17-5</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.17.5-linux-x86_64.tar.gz</span><br><span class="line">tar -zvxf elasticsearch-7.17.5-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>

<h5 id="配置-Elasticsearch-1"><a href="#配置-Elasticsearch-1" class="headerlink" title="配置 Elasticsearch"></a>配置 Elasticsearch</h5><h6 id="关闭防火墙-1"><a href="#关闭防火墙-1" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl status firewalld.service</span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service</span><br></pre></td></tr></table></figure>

<h6 id="配置elasticsearch-yml-1"><a href="#配置elasticsearch-yml-1" class="headerlink" title="配置elasticsearch.yml"></a>配置elasticsearch.yml</h6><blockquote>
<p>该配置文件是ES的主配置文件</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi elasticsearch.yml</span><br><span class="line"><span class="comment">#设置允许访问地址，配置位0.0.0.0允许任意主机访问</span></span><br><span class="line">- <span class="comment">#network.host: 192.168.0.1</span></span><br><span class="line">+ network.host: 0.0.0.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置集群</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># node.name: node-1</span></span><br><span class="line">+ node.name: node-1</span><br><span class="line"></span><br><span class="line">- <span class="comment">#discovery.seed_hosts: [&quot;host1&quot;, &quot;host2&quot;]</span></span><br><span class="line">discovery.seed_hosts: [<span class="string">&quot;node-1&quot;</span>]</span><br><span class="line"></span><br><span class="line">- <span class="comment">#cluster.initial_master_nodes: [&quot;node-1&quot;, &quot;node-2&quot;]</span></span><br><span class="line">+ cluster.initial_master_nodes: [<span class="string">&quot;node-1&quot;</span>]</span><br></pre></td></tr></table></figure>

<h5 id="修改Linux句柄数-2"><a href="#修改Linux句柄数-2" class="headerlink" title="修改Linux句柄数"></a>修改Linux句柄数</h5><h6 id="查看当前最大句柄数-2"><a href="#查看当前最大句柄数-2" class="headerlink" title="查看当前最大句柄数"></a>查看当前最大句柄数</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sysctl -a | grep vm.max_map_count</span><br></pre></td></tr></table></figure>

<h6 id="修改句柄数-2"><a href="#修改句柄数-2" class="headerlink" title="修改句柄数"></a>修改句柄数</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line">+ vm.max_map_count=262144</span><br></pre></td></tr></table></figure>

<h6 id="生效配置-2"><a href="#生效配置-2" class="headerlink" title="生效配置"></a>生效配置</h6><blockquote>
<p>修改后需要重启才能生效，不想重启可以设置临时生效</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sysctl -w vm.max_map_count=262144</span><br></pre></td></tr></table></figure>

<h5 id="关闭swap-1"><a href="#关闭swap-1" class="headerlink" title="关闭swap"></a>关闭swap</h5><blockquote>
<p>因为ES的数据大量都是常驻内存的，一旦使用了虚拟内存就会导致查询速度下降，一般需要关闭swap，但是要保证有足够的内存</p>
</blockquote>
<h6 id="临时关闭-1"><a href="#临时关闭-1" class="headerlink" title="临时关闭"></a>临时关闭</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">swapoff -a</span><br></pre></td></tr></table></figure>

<h6 id="永久关闭-1"><a href="#永久关闭-1" class="headerlink" title="永久关闭"></a>永久关闭</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/fstab</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注释掉<code>swap</code>这一行的配置</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch165.png" alt="image-20220914161151689"></p>
<h5 id="修改最大线程数-1"><a href="#修改最大线程数-1" class="headerlink" title="修改最大线程数"></a>修改最大线程数</h5><blockquote>
<p>因为ES运行期间可能创建大量线程，如果线程数支持较少可能报错</p>
</blockquote>
<h6 id="配置修改-2"><a href="#配置修改-2" class="headerlink" title="配置修改"></a>配置修改</h6><blockquote>
<p>修改后需要重新登录生效</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/security/limits.conf</span><br><span class="line"><span class="comment"># 添加以下内容</span></span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br><span class="line">* soft nproc 4096</span><br><span class="line">* hard nproc 4096</span><br></pre></td></tr></table></figure>

<h6 id="重启服务-2"><a href="#重启服务-2" class="headerlink" title="重启服务"></a>重启服务</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h5 id="创建ES用户-1"><a href="#创建ES用户-1" class="headerlink" title="创建ES用户"></a>创建ES用户</h5><blockquote>
<p>注意ES不能以 root 用户启动，否则会报错</p>
</blockquote>
<h6 id="添加用户-1"><a href="#添加用户-1" class="headerlink" title="添加用户"></a>添加用户</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">useradd elasticsearch</span><br><span class="line">passwd elasticsearch</span><br></pre></td></tr></table></figure>

<h6 id="增加管理员权限-1"><a href="#增加管理员权限-1" class="headerlink" title="增加管理员权限"></a>增加管理员权限</h6><blockquote>
<p>增加sudoers权限</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/sudoers</span><br><span class="line">+ elasticsearch  ALL=(ALL)       ALL</span><br></pre></td></tr></table></figure>

<h6 id="修改Elasticsearch权限-1"><a href="#修改Elasticsearch权限-1" class="headerlink" title="修改Elasticsearch权限"></a>修改Elasticsearch权限</h6><blockquote>
<p>给ES的安装目录进行授权</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chown -R elasticsearch:elasticsearch elasticsearch-7.17.5</span><br></pre></td></tr></table></figure>

<h4 id="JVM配置-1"><a href="#JVM配置-1" class="headerlink" title="JVM配置"></a>JVM配置</h4><blockquote>
<p>根据自己的内存自行调整，内存不够则会启动失败</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi jvm.options</span><br><span class="line">- <span class="comment">##-Xms4g</span></span><br><span class="line">- <span class="comment">##-Xmx4g</span></span><br><span class="line">+ -Xms4g</span><br><span class="line">+ -Xmx4g</span><br></pre></td></tr></table></figure>

<h4 id="添加IK分词器-2"><a href="#添加IK分词器-2" class="headerlink" title="添加IK分词器"></a>添加IK分词器</h4><blockquote>
<p>因为后面要用到IK分词，所以我们要安装以下IK分词器</p>
</blockquote>
<h5 id="查找-2"><a href="#查找-2" class="headerlink" title="查找"></a>查找</h5><blockquote>
<p>在github中下载对应版本的分词器</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://github.com/medcl/elasticsearch-analysis-ik/releases</span><br></pre></td></tr></table></figure>

<blockquote>
<p>根据自己的ES版本选择相应版本的IK分词器，因为安装的ES是<code>7.17.5</code>，所以也下载相应的IK分词器</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch166.png" alt="image-20220805133634676"></p>
<h5 id="解压-2"><a href="#解压-2" class="headerlink" title="解压"></a>解压</h5><blockquote>
<p>将下载的分词器复制到ES安装目录的<code>plugins</code>目录中并进行解压</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir ik &amp;&amp; <span class="built_in">cd</span> ik</span><br><span class="line">unzip elasticsearch-analysis-ik-7.17.5.zip</span><br></pre></td></tr></table></figure>

<h4 id="启动ElasticSearch-2"><a href="#启动ElasticSearch-2" class="headerlink" title="启动ElasticSearch"></a>启动ElasticSearch</h4><h5 id="切换用户-2"><a href="#切换用户-2" class="headerlink" title="切换用户"></a>切换用户</h5><blockquote>
<p>切换到刚刚创建的<code>elasticsearch</code>用户</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">su elasticsearch</span><br></pre></td></tr></table></figure>

<h5 id="启动命令-1"><a href="#启动命令-1" class="headerlink" title="启动命令"></a>启动命令</h5><blockquote>
<p>我们可以使用以下命令来进行使用</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 前台启动</span></span><br><span class="line">sh bin/elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后台启动</span></span><br><span class="line">sh bin/elasticsearch -d</span><br></pre></td></tr></table></figure>

<h5 id="访问测试-2"><a href="#访问测试-2" class="headerlink" title="访问测试"></a>访问测试</h5><blockquote>
<p>访问对应宿主机的<code>9200</code>端口</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">http://192.168.245.151:9200/</span><br></pre></td></tr></table></figure>

<h5 id="重启ElasticSearch-1"><a href="#重启ElasticSearch-1" class="headerlink" title="重启ElasticSearch"></a>重启ElasticSearch</h5><h6 id="查找进程-1"><a href="#查找进程-1" class="headerlink" title="查找进程"></a>查找进程</h6><blockquote>
<p>先查找ElasticSearch的进程号</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ps -ef | grep elastic</span><br></pre></td></tr></table></figure>

<h5 id="杀死进程-1"><a href="#杀死进程-1" class="headerlink" title="杀死进程"></a>杀死进程</h5><blockquote>
<p>杀死对应的进程</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">kill</span> -9 49736</span><br></pre></td></tr></table></figure>

<h6 id="启动ElasticSearch-3"><a href="#启动ElasticSearch-3" class="headerlink" title="启动ElasticSearch"></a>启动ElasticSearch</h6><blockquote>
<p>注意不要使用ROOT用户启动</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sh bin/elasticsearch -d</span><br></pre></td></tr></table></figure>

<h4 id="kibana安装-1"><a href="#kibana安装-1" class="headerlink" title="kibana安装"></a>kibana安装</h4><h5 id="下载安装-Kibana-1"><a href="#下载安装-Kibana-1" class="headerlink" title="下载安装 Kibana"></a>下载安装 Kibana</h5><blockquote>
<p>kibana 版本 7.17.5<br>下载地址：<code>https://www.elastic.co/cn/downloads/past-releases/kibana-7-17-5</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/kibana/kibana-7.17.5-linux-x86_64.tar.gz</span><br><span class="line">tar -zvxf kibana-7.17.5-linux-x86_64.tar.gz</span><br><span class="line">mv kibana-7.17.5-linux-x86_64 kibana-7.17.5</span><br></pre></td></tr></table></figure>

<h5 id="配置-Kibana-1"><a href="#配置-Kibana-1" class="headerlink" title="配置 Kibana"></a>配置 Kibana</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi config/kibana.yml</span><br><span class="line">- <span class="comment">#server.port: 5601</span></span><br><span class="line">+ server.port: 5601</span><br><span class="line"></span><br><span class="line">- <span class="comment">#server.host: &quot;localhost&quot;</span></span><br><span class="line">+ server.host: <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"></span><br><span class="line">- <span class="comment">#elasticsearch.hosts: [&quot;http://localhost:9200&quot;]</span></span><br><span class="line">+ elasticsearch.hosts: [<span class="string">&quot;http://localhost:9200&quot;</span>]</span><br></pre></td></tr></table></figure>

<h5 id="启动-Kibana-1"><a href="#启动-Kibana-1" class="headerlink" title="启动 Kibana"></a>启动 Kibana</h5><h6 id="切换用户-3"><a href="#切换用户-3" class="headerlink" title="切换用户"></a>切换用户</h6><blockquote>
<p>Kibana也不能以root用户运行，需要切换到<code>elasticsearch权限</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">su elasticsearch</span><br></pre></td></tr></table></figure>

<h6 id="启动kibaba-1"><a href="#启动kibaba-1" class="headerlink" title="启动kibaba"></a>启动kibaba</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#前台运行</span></span><br><span class="line">sh bin/kibana</span><br><span class="line"></span><br><span class="line"><span class="comment">#后台运行</span></span><br><span class="line">nohup sh bin/kibana  &gt;/dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

<h6 id="访问测试-3"><a href="#访问测试-3" class="headerlink" title="访问测试"></a>访问测试</h6><blockquote>
<p>访问对应宿主机的<code>5601</code>端口</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">http://192.168.245.151:5601/</span><br></pre></td></tr></table></figure>

<h3 id="ES快速入门-1"><a href="#ES快速入门-1" class="headerlink" title="ES快速入门"></a>ES快速入门</h3><blockquote>
<p>下面我们看下ES的一些基本使用</p>
</blockquote>
<h4 id="索引管理-1"><a href="#索引管理-1" class="headerlink" title="索引管理"></a>索引管理</h4><blockquote>
<p>我们使用数据库的第一步就是创建数据库，同样ES也是一样的，第一步也是对索引进行管理</p>
</blockquote>
<h5 id="列出索引-1"><a href="#列出索引-1" class="headerlink" title="列出索引"></a>列出索引</h5><blockquote>
<p>我们使用索引的第一步就是列出索引，查看当前数据库有哪些索引</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_cat/indices?v</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch013.png" alt="image-20220803141523322"></p>
<h5 id="创建索引-1"><a href="#创建索引-1" class="headerlink" title="创建索引"></a>创建索引</h5><blockquote>
<p>我们接下来要使用索引就需要创建索引了，Elasticsearch使用PUT方式来实现索引的新增</p>
</blockquote>
<p> 可以在创建索引的时候不添加任何参数，系统会为你创建一个默认的索引，当然你可以添加附加一些配置信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT customer</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样我们就创建了一个索引</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch014.png" alt="image-20220803151216388"></p>
<h5 id="查看索引-1"><a href="#查看索引-1" class="headerlink" title="查看索引"></a>查看索引</h5><blockquote>
<p>索引创建完成后，我们接下来就需要对索引进行查询</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">get customer</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch015.png" alt="image-20220803151945360"></p>
<h6 id="结果说明-1"><a href="#结果说明-1" class="headerlink" title="结果说明"></a>结果说明</h6><blockquote>
<p>这里返回了一堆数据，具体什么含义呢，我们需要查看字段的详细信息</p>
</blockquote>
<table>
<thead>
<tr>
<th>字段</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>aliases</td>
<td>别名</td>
</tr>
<tr>
<td>mappings</td>
<td>映射</td>
</tr>
<tr>
<td>settings</td>
<td>配置</td>
</tr>
<tr>
<td>settings.index.creation_date</td>
<td>创建时间</td>
</tr>
<tr>
<td>settings.index.number_of_shards</td>
<td>数据分片数，索引要做多少个分片，只能在创建索引时指定，后期无法修改</td>
</tr>
<tr>
<td>settings.index.number_of_replicas</td>
<td>数据备份数，每个分片有多少个副本，后期可以动态修改</td>
</tr>
<tr>
<td>settings.index.uuid</td>
<td>索引id</td>
</tr>
<tr>
<td>settings.index.provided_name</td>
<td>名称</td>
</tr>
</tbody></table>
<h5 id="索引是否存在-1"><a href="#索引是否存在-1" class="headerlink" title="索引是否存在"></a>索引是否存在</h5><blockquote>
<p>有时候我们需要检查索引时候存在，我们可以使用HEAD命令验证索引是否存在</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">HEAD customer</span><br></pre></td></tr></table></figure>

<blockquote>
<p>出现200表示索引存在</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch016.png" alt="image-20220808142523378"></p>
<h5 id="关闭索引-1"><a href="#关闭索引-1" class="headerlink" title="关闭索引"></a>关闭索引</h5><blockquote>
<p>在一些业务场景，我们可能需要禁止掉某些索引的访问功能，但是又不想删除这个索引</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">post customer/_close</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里我们就把这个索引给关闭了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch017.png" alt="image-20220803152949392"></p>
<h6 id="查看索引列表-2"><a href="#查看索引列表-2" class="headerlink" title="查看索引列表"></a>查看索引列表</h6><blockquote>
<p>再次查看索引列表，查看索引的状态</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_cat/indices?v</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现索引已经被关闭了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch018.png" alt="image-20220803153221311"></p>
<h6 id="为什么关闭索引-1"><a href="#为什么关闭索引-1" class="headerlink" title="为什么关闭索引"></a>为什么关闭索引</h6><blockquote>
<p>如果关闭了一个索引，就无法通过Elasticsearch 来读取和写人其中的数据，直到再次打开它</p>
</blockquote>
<p> 在现实世界中，最好永久地保存应用日志，以防要查看很久之前的信息，另一方面，在Elasticsearch中存放大量数据需要增加资源，对于这种使用案例，关闭旧的索引非常有意义，你可能并不需要那些数据，但是也不想删除它们。</p>
<p> 一旦索引被关闭，它在Elasticsearch内存中唯一的痕迹是其元数据，如名字以及分片的位置，如果有足够的磁盘空间，而且也不确定是否需要在那个数据中再次搜索，关闭索引要比删除索引更好，关闭它们会让你非常安心，随时可以重新打开被关闭的索引，然后在其中再次搜索</p>
<h5 id="打开索引-1"><a href="#打开索引-1" class="headerlink" title="打开索引"></a>打开索引</h5><blockquote>
<p>如果我们需要继续启动索引可以直接打开索引</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">post customer/_open</span><br></pre></td></tr></table></figure>

<blockquote>
<p>现在我们已经打开了索引</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch019.png" alt="image-20220803153430046"></p>
<h6 id="查看索引列表-3"><a href="#查看索引列表-3" class="headerlink" title="查看索引列表"></a>查看索引列表</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET /_cat/indices?v</span><br></pre></td></tr></table></figure>

<blockquote>
<p>现在索引的状态已经是打开的状态了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch020.png" alt="image-20220803153525409"></p>
<h5 id="删除索引-1"><a href="#删除索引-1" class="headerlink" title="删除索引"></a>删除索引</h5><blockquote>
<p>如果索引中的数据已经不需要了，可以被删除，我们是可以删除索引的，使用以下命令可以删除索引</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">delete customer</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样我们就把索引给删除了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch021.png" alt="image-20220803175601320"></p>
<h4 id="映射管理-1"><a href="#映射管理-1" class="headerlink" title="映射管理"></a>映射管理</h4><blockquote>
<p>映射的创建时基于索引的，你必须要先创建索引才能创建映射，es中的映射相当于传统数据库中的表结构，数据存储的格式就是通过映射来规定的</p>
</blockquote>
<h5 id="创建映射-1"><a href="#创建映射-1" class="headerlink" title="创建映射"></a>创建映射</h5><blockquote>
<p>可以在创建索引时指定映射，其中<code>mappings.properties</code>为固定结构，指定创建映射属性</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT customer</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch022.png" alt="image-20220808143910461"></p>
<h5 id="查看映射-1"><a href="#查看映射-1" class="headerlink" title="查看映射"></a>查看映射</h5><blockquote>
<p>查看索引完全信息，内容包含映射信息</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET customer/_mapping</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch023.png" alt="image-20220808144250601"></p>
<h4 id="文档管理-1"><a href="#文档管理-1" class="headerlink" title="文档管理"></a>文档管理</h4><h5 id="创建文档-业务ID-1"><a href="#创建文档-业务ID-1" class="headerlink" title="创建文档(业务ID)"></a>创建文档(业务ID)</h5><blockquote>
<p>创建文档的时候我们可以手动来指定ID，但是一般不推荐，回对ES插入性能造成影响</p>
</blockquote>
<p> 如果手动指定ID，为了保证ID不冲突，会先查询一次文档库，如果不存在则进行插入，手动插入多了一次查询操作，性能会有损失。</p>
<h6 id="操作说明-1"><a href="#操作说明-1" class="headerlink" title="操作说明"></a>操作说明</h6><ul>
<li>文档可以类比为关系型数据库中的表数据，添加的数据格式为 JSON 格式</li>
<li>注意需要在索引后面添加<code>_doc</code>，表示操作文档</li>
<li>在未指定id生成情况，每执行一次post将生成一个新文档</li>
<li>如果index不存在，将会默认创建</li>
</ul>
<h6 id="使用示例-1"><a href="#使用示例-1" class="headerlink" title="使用示例"></a>使用示例</h6><blockquote>
<p>新增文档，自动生成文档id，并且如果如果添加文档的索引不存在时会自动创建索引</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">post customer/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span> : <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span> : 15</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样我们就创建了一个文档</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch024.png" alt="image-20220803181022205"></p>
<h6 id="返回结果说明-1"><a href="#返回结果说明-1" class="headerlink" title="返回结果说明"></a>返回结果说明</h6><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;customer&quot;</span>,	#所属索引</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;_doc&quot;</span>,  		#所属mapping type</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>,				#文档id</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">1</span>,			#文档版本</span><br><span class="line">  <span class="attr">&quot;result&quot;</span> : <span class="string">&quot;created&quot;</span>,		#文档创建成功</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">2</span>,			#所在分片有两个分片</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,		#只有一个副本成功写入，可能节点机器只有一台</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span>			#失败副本数</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> : <span class="number">0</span>,			#第几次操作该文档</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> : <span class="number">1</span>		#词项数</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="创建文档-自动ID-1"><a href="#创建文档-自动ID-1" class="headerlink" title="创建文档(自动ID)"></a>创建文档(自动ID)</h5><blockquote>
<p>为了提高插入文档效率，我们一般会使用自动生成ID，这样减少一次插入时的查询性能损耗，插入时不指定文档ID，ES就会自动生成ID</p>
</blockquote>
<p> 自动生成的ID是一个不会重复的随机数，使用GUID算法，可以保证在分布式环境下，不同节点同一时间创建的<code>_id</code>一定是不冲突的</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">post customer/_doc</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span> : <span class="string">&quot;李四&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span> : 50</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样创建了一个文档，并且文档ID是系统自动生成的<code>_id</code></p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch025.png" alt="image-20220803184615285"></p>
<h5 id="更新文档-1"><a href="#更新文档-1" class="headerlink" title="更新文档"></a>更新文档</h5><blockquote>
<p>更新文档和插入文档一样，如果文档ID一致则会进行覆盖更新，而更新又分为全量更新和增量更新</p>
</blockquote>
<h6 id="全量更新-1"><a href="#全量更新-1" class="headerlink" title="全量更新"></a>全量更新</h6><blockquote>
<p>和新增文档一样，输入相同的 URL 地址请求，如果请求体变化，会将原有的数据内容<strong>覆盖</strong></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">post customer/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span> : <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span> : 50</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch026.png" alt="image-20220803184231987"></p>
<h6 id="增量更新-1"><a href="#增量更新-1" class="headerlink" title="增量更新"></a>增量更新</h6><blockquote>
<p>通过指定<code>_doc</code>方式默认是全量更新，如果需要更新指定字段则需要将<code>_doc</code>改为<code>_update</code>，请求内容需要增加doc表示，原始<code>&#123;“key”: value&#125;</code>，更新<code>&#123;“doc”: &#123;“key”: value&#125;&#125;</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">post customer/_update/1</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;doc&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;age&quot;</span> : 55</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="查询文档-2"><a href="#查询文档-2" class="headerlink" title="查询文档"></a>查询文档</h5><h6 id="验证是否存在-1"><a href="#验证是否存在-1" class="headerlink" title="验证是否存在"></a>验证是否存在</h6><blockquote>
<p>可以通过以下命令检查文档是否存在</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">HEAD customer/_doc/1  <span class="comment">#查看是否存储，返回200表示已存储</span></span><br></pre></td></tr></table></figure>

<h6 id="查询文档-3"><a href="#查询文档-3" class="headerlink" title="查询文档"></a>查询文档</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET customer/_doc/1  <span class="comment">#返回源数据的查询</span></span><br></pre></td></tr></table></figure>

<h6 id="不返回source-1"><a href="#不返回source-1" class="headerlink" title="不返回source"></a>不返回source</h6><blockquote>
<p>有时候只是查询，不需要具体的源文档字段，这样可以提高查询速度，可以使用以下方式</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET customer/_doc/1?_source=<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h6 id="查询所有-1"><a href="#查询所有-1" class="headerlink" title="查询所有"></a>查询所有</h6><blockquote>
<p>上述只能查询单个，可以查询所有文档，将<code>_doc</code>替换为<code>_search</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET customer/_search</span><br></pre></td></tr></table></figure>

<h5 id="删除文档-1"><a href="#删除文档-1" class="headerlink" title="删除文档"></a>删除文档</h5><h6 id="根据文档ID删除-1"><a href="#根据文档ID删除-1" class="headerlink" title="根据文档ID删除"></a>根据文档ID删除</h6><blockquote>
<p>我们可以根据文档ID进行删除</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DELETE customer/_doc/1  <span class="comment">#指定文档id进行删除</span></span><br></pre></td></tr></table></figure>

<h6 id="根据条件删除-1"><a href="#根据条件删除-1" class="headerlink" title="根据条件删除"></a>根据条件删除</h6><blockquote>
<p>根据查询条件删除，会先查询然后在删除，可能耗时会比较长</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">post customer/_delete_by_query</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123; </span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>: <span class="string">&quot;15&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="中文分词器-1"><a href="#中文分词器-1" class="headerlink" title="中文分词器"></a>中文分词器</h4><h5 id="IKAnalyzer-1"><a href="#IKAnalyzer-1" class="headerlink" title="IKAnalyzer"></a>IKAnalyzer</h5><blockquote>
<p>IKAnalyzer是一个开源的，基于java的语言开发的轻量级的中文分词工具包</p>
</blockquote>
<p> 从2006年12月推出1.0版开始，IKAnalyzer已经推出了3个大版本，在 2012 版本中，IK 实现了简单的分词歧义排除算法，标志着 IK 分词器从单纯的词典分词向模拟语义分词衍化</p>
<h5 id="使用IK分词器-1"><a href="#使用IK分词器-1" class="headerlink" title="使用IK分词器"></a>使用IK分词器</h5><blockquote>
<p>IK提供了两个分词算法:</p>
</blockquote>
<ul>
<li>ik_smart：最少切分。</li>
<li>ik_max_word：最细粒度划分。</li>
</ul>
<h5 id="ik-smart-1"><a href="#ik-smart-1" class="headerlink" title="ik_smart"></a>ik_smart</h5><h6 id="使用案例-2"><a href="#使用案例-2" class="headerlink" title="使用案例"></a>使用案例</h6><blockquote>
<p>原始内容</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">传智教育的教学质量是杠杠的</span><br></pre></td></tr></table></figure>

<h6 id="测试分词-2"><a href="#测试分词-2" class="headerlink" title="测试分词"></a>测试分词</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;传智教育的教学质量是杠杠的&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch167.png" alt="image-20220808115450647"></p>
<h5 id="ik-max-word-1"><a href="#ik-max-word-1" class="headerlink" title="ik_max_word"></a>ik_max_word</h5><h6 id="使用案例-3"><a href="#使用案例-3" class="headerlink" title="使用案例"></a>使用案例</h6><blockquote>
<p>原始内容</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">传智教育的教学质量是杠杠的</span><br></pre></td></tr></table></figure>

<h6 id="测试分词-3"><a href="#测试分词-3" class="headerlink" title="测试分词"></a>测试分词</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;传智教育的教学质量是杠杠的&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch168.png" alt="image-20220808115513668"></p>
<h5 id="自定义词库-1"><a href="#自定义词库-1" class="headerlink" title="自定义词库"></a>自定义词库</h5><blockquote>
<p>我们在使用IK分词器时会发现其实有时候分词的效果也并不是我们所期待的</p>
</blockquote>
<h6 id="问题描述-1"><a href="#问题描述-1" class="headerlink" title="问题描述"></a>问题描述</h6><p> 例如我们输入“传智教育的教学质量是杠杠的”，但是分词器会把“传智教育”进行拆开，分为了“传”，“智”，“教育”，但我们希望的是<strong>“传智教育”可以不被拆开</strong>。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch169.png" alt="image-20220808115543696"></p>
<h5 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h5><blockquote>
<p>对于以上的问题，我们只需要将自己要保留的词，加到我们的分词器的字典中即可</p>
</blockquote>
<h6 id="编辑字典内容-1"><a href="#编辑字典内容-1" class="headerlink" title="编辑字典内容"></a>编辑字典内容</h6><blockquote>
<p>进入elasticsearch目录<code>plugins/ik/config</code>中，创建我们自己的字典文件<code>yixin.dic</code>，并添加内容：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> plugins/ik/config</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;传智教育&quot;</span> &gt; custom.dic</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch170.png" alt="image-20220808115806628"></p>
<h6 id="扩展字典-1"><a href="#扩展字典-1" class="headerlink" title="扩展字典"></a>扩展字典</h6><blockquote>
<p>进入我们的elasticsearch目录 ：<code>plugins/ik/config</code>，打开<code>IKAnalyzer.cfg.xml</code>文件，进行如下配置：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi IKAnalyzer.cfg.xml</span><br><span class="line"><span class="comment">#增加如下内容</span></span><br><span class="line">&lt;entry key=<span class="string">&quot;ext_dict&quot;</span>&gt;custom.dic&lt;/entry&gt;</span><br></pre></td></tr></table></figure>

<h6 id="再次测试-1"><a href="#再次测试-1" class="headerlink" title="再次测试"></a>再次测试</h6><blockquote>
<p>重启ElasticSearch，再次使用kibana测试</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;传智教育的教学质量是杠杠的&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以发现，现在我们的词汇”传智教育”就不会被拆开了，达到我们想要的效果了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch171.png" alt="image-20220808134046401"></p>
<h3 id="ES服务集群部署"><a href="#ES服务集群部署" class="headerlink" title="ES服务集群部署"></a>ES服务集群部署</h3><blockquote>
<p>我们将ES的服务部署和同步服务部署分为两套，因为后期我们数据同步完成可以将异构数据同步的服务停止掉</p>
</blockquote>
<h4 id="服务布局-1"><a href="#服务布局-1" class="headerlink" title="服务布局"></a>服务布局</h4><blockquote>
<p>我们整体采用Docker方式进行布局，以下是我们需要部署的服务</p>
</blockquote>
<table>
<thead>
<tr>
<th>服务名称</th>
<th>服务名称</th>
<th>开放端口</th>
<th>内存限制</th>
</tr>
</thead>
<tbody><tr>
<td>ES-node1</td>
<td>node-1</td>
<td>9200</td>
<td>1G</td>
</tr>
<tr>
<td>ES-node2</td>
<td>node-2</td>
<td>9201</td>
<td>1G</td>
</tr>
<tr>
<td>ES-node3</td>
<td>node-3</td>
<td>9202</td>
<td>1G</td>
</tr>
<tr>
<td>ES-cerebro</td>
<td>cerebro</td>
<td>9000</td>
<td>不限</td>
</tr>
<tr>
<td>kibana</td>
<td>kibana</td>
<td>5601</td>
<td>不限</td>
</tr>
</tbody></table>
<h4 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h4><h5 id="创建挂载目录-1"><a href="#创建挂载目录-1" class="headerlink" title="创建挂载目录"></a>创建挂载目录</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#创建ES的数据和配置目录</span></span><br><span class="line">mkdir -p /tmp/data/elasticsearch/node-&#123;1..3&#125;/&#123;config,plugins,data,<span class="built_in">log</span>&#125;</span><br><span class="line"><span class="comment"># 创建kibana的配置目录</span></span><br><span class="line">mkdir -p /tmp/data/kibana/config</span><br></pre></td></tr></table></figure>

<h5 id="目录授权-1"><a href="#目录授权-1" class="headerlink" title="目录授权"></a>目录授权</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chmod 777 /tmp/data/elasticsearch/node-&#123;1..3&#125;/&#123;config,plugins,data,<span class="built_in">log</span>&#125;</span><br><span class="line">chmod 777 /tmp/data/kibana/config</span><br></pre></td></tr></table></figure>

<h5 id="修改Linux句柄数-3"><a href="#修改Linux句柄数-3" class="headerlink" title="修改Linux句柄数"></a>修改Linux句柄数</h5><h6 id="查看当前最大句柄数-3"><a href="#查看当前最大句柄数-3" class="headerlink" title="查看当前最大句柄数"></a>查看当前最大句柄数</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sysctl -a | grep vm.max_map_count</span><br></pre></td></tr></table></figure>

<h6 id="修改句柄数-3"><a href="#修改句柄数-3" class="headerlink" title="修改句柄数"></a>修改句柄数</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line">+ vm.max_map_count=262144</span><br></pre></td></tr></table></figure>

<h6 id="生效配置-3"><a href="#生效配置-3" class="headerlink" title="生效配置"></a>生效配置</h6><blockquote>
<p>修改后需要重启才能生效，不想重启可以设置临时生效</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sysctl -w vm.max_map_count=262144</span><br></pre></td></tr></table></figure>

<h5 id="关闭swap-2"><a href="#关闭swap-2" class="headerlink" title="关闭swap"></a>关闭swap</h5><blockquote>
<p>因为ES的数据大量都是常驻内存的，一旦使用了虚拟内存就会导致查询速度下降，一般需要关闭swap，但是要保证有足够的内存</p>
</blockquote>
<h6 id="临时关闭-2"><a href="#临时关闭-2" class="headerlink" title="临时关闭"></a>临时关闭</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">swapoff -a</span><br></pre></td></tr></table></figure>

<h6 id="永久关闭-2"><a href="#永久关闭-2" class="headerlink" title="永久关闭"></a>永久关闭</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/fstab</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注释掉<code>swap</code>这一行的配置</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch172.png" alt="image-20220914161151689"></p>
<h5 id="修改最大线程数-2"><a href="#修改最大线程数-2" class="headerlink" title="修改最大线程数"></a>修改最大线程数</h5><blockquote>
<p>因为ES运行期间可能创建大量线程，如果线程数支持较少可能报错</p>
</blockquote>
<h6 id="配置修改-3"><a href="#配置修改-3" class="headerlink" title="配置修改"></a>配置修改</h6><blockquote>
<p>修改后需要重新登录生效</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/security/limits.conf</span><br><span class="line"><span class="comment"># 添加以下内容</span></span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br><span class="line">* soft nproc 4096</span><br><span class="line">* hard nproc 4096</span><br></pre></td></tr></table></figure>

<h6 id="重启服务-3"><a href="#重启服务-3" class="headerlink" title="重启服务"></a>重启服务</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h5 id="添加IK分词器-3"><a href="#添加IK分词器-3" class="headerlink" title="添加IK分词器"></a>添加IK分词器</h5><blockquote>
<p>因为后面要用到IK分词，所以我们要安装以下IK分词器</p>
</blockquote>
<h6 id="查找-3"><a href="#查找-3" class="headerlink" title="查找"></a>查找</h6><blockquote>
<p>在github中下载对应版本的分词器</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://github.com/medcl/elasticsearch-analysis-ik/releases</span><br></pre></td></tr></table></figure>

<blockquote>
<p>根据自己的ES版本选择相应版本的IK分词器，因为安装的ES是<code>7.17.5</code>，所以也下载相应的IK分词器</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch173.png" alt="image-20220805133634676"></p>
<h6 id="解压-3"><a href="#解压-3" class="headerlink" title="解压"></a>解压</h6><blockquote>
<p>将下载的分词器复制到ES安装目录的<code>plugins</code>目录中并进行解压</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir ik &amp;&amp; <span class="built_in">cd</span> ik</span><br><span class="line">unzip elasticsearch-analysis-ik-7.17.5.zip</span><br></pre></td></tr></table></figure>

<h6 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cp -R ik/ /tmp/data/elasticsearch/node-1/plugins/</span><br><span class="line">cp -R ik/ /tmp/data/elasticsearch/node-2/plugins/</span><br><span class="line">cp -R ik/ /tmp/data/elasticsearch/node-3/plugins/</span><br></pre></td></tr></table></figure>

<h4 id="编写配置文件-1"><a href="#编写配置文件-1" class="headerlink" title="编写配置文件"></a>编写配置文件</h4><blockquote>
<p>下面我们对三个节点的配置进行配置</p>
</blockquote>
<h5 id="node-1-1"><a href="#node-1-1" class="headerlink" title="node-1"></a>node-1</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /tmp/data/elasticsearch/node-1/config/elasticsearch.yml</span><br><span class="line"><span class="comment">#集群名称</span></span><br><span class="line">cluster.name: elastic</span><br><span class="line"><span class="comment">#当前该节点的名称</span></span><br><span class="line">node.name: node-1</span><br><span class="line"><span class="comment">#是不是有资格竞选主节点</span></span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line"><span class="comment">#是否存储数据</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line"><span class="comment">#最大集群节点数</span></span><br><span class="line">node.max_local_storage_nodes: 3</span><br><span class="line"><span class="comment">#给当前节点自定义属性（可以省略）</span></span><br><span class="line"><span class="comment">#node.attr.rack: r1</span></span><br><span class="line"><span class="comment">#数据存档位置</span></span><br><span class="line">path.data: /usr/share/elasticsearch/data</span><br><span class="line"><span class="comment">#日志存放位置</span></span><br><span class="line">path.logs: /usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line"><span class="comment">#是否开启时锁定内存（默认为是）</span></span><br><span class="line"><span class="comment">#bootstrap.memory_lock: true</span></span><br><span class="line"><span class="comment">#设置网关地址，我是被这个坑死了，这个地址我原先填写了自己的实际物理IP地址，</span></span><br><span class="line"><span class="comment">#然后启动一直报无效的IP地址，无法注入9300端口，这里只需要填写0.0.0.0</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="comment">#设置映射端口</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="comment">#内部节点之间沟通端口</span></span><br><span class="line">transport.tcp.port: 9300</span><br><span class="line"><span class="comment">#集群发现默认值为127.0.0.1:9300,如果要在其他主机上形成包含节点的群集,如果搭建集群则需要填写</span></span><br><span class="line"><span class="comment">#es7.x 之后新增的配置，写入候选主节点的设备地址，在开启服务后可以被选为主节点，也就是说把所有的节点都写上</span></span><br><span class="line">discovery.seed_hosts: [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"><span class="comment">#当你在搭建集群的时候，选出合格的节点集群，有些人说的太官方了，</span></span><br><span class="line"><span class="comment">#其实就是，让你选择比较好的几个节点，在你节点启动时，在这些节点中选一个做领导者，</span></span><br><span class="line"><span class="comment">#如果你不设置呢，elasticsearch就会自己选举，这里我们把三个节点都写上</span></span><br><span class="line">cluster.initial_master_nodes: [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"><span class="comment">#在群集完全重新启动后阻止初始恢复，直到启动N个节点</span></span><br><span class="line"><span class="comment">#简单点说在集群启动后，至少复活多少个节点以上，那么这个服务才可以被使用，否则不可以被使用，</span></span><br><span class="line">gateway.recover_after_nodes: 2</span><br><span class="line"><span class="comment">#删除索引是是否需要显示其名称，默认为显示</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true</span></span><br><span class="line"><span class="comment"># 禁用安全配置，否则查询的时候会提示警告</span></span><br><span class="line">xpack.security.enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h5 id="node-2-1"><a href="#node-2-1" class="headerlink" title="node-2"></a>node-2</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /tmp/data/elasticsearch/node-2/config/elasticsearch.yml</span><br><span class="line"><span class="comment">#集群名称</span></span><br><span class="line">cluster.name: elastic</span><br><span class="line"><span class="comment">#当前该节点的名称</span></span><br><span class="line">node.name: node-2</span><br><span class="line"><span class="comment">#是不是有资格竞选主节点</span></span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line"><span class="comment">#是否存储数据</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line"><span class="comment">#最大集群节点数</span></span><br><span class="line">node.max_local_storage_nodes: 3</span><br><span class="line"><span class="comment">#给当前节点自定义属性（可以省略）</span></span><br><span class="line"><span class="comment">#node.attr.rack: r1</span></span><br><span class="line"><span class="comment">#数据存档位置</span></span><br><span class="line">path.data: /usr/share/elasticsearch/data</span><br><span class="line"><span class="comment">#日志存放位置</span></span><br><span class="line">path.logs: /usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line"><span class="comment">#是否开启时锁定内存（默认为是）</span></span><br><span class="line"><span class="comment">#bootstrap.memory_lock: true</span></span><br><span class="line"><span class="comment">#设置网关地址，我是被这个坑死了，这个地址我原先填写了自己的实际物理IP地址，</span></span><br><span class="line"><span class="comment">#然后启动一直报无效的IP地址，无法注入9300端口，这里只需要填写0.0.0.0</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="comment">#设置映射端口</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="comment">#内部节点之间沟通端口</span></span><br><span class="line">transport.tcp.port: 9300</span><br><span class="line"><span class="comment">#集群发现默认值为127.0.0.1:9300,如果要在其他主机上形成包含节点的群集,如果搭建集群则需要填写</span></span><br><span class="line"><span class="comment">#es7.x 之后新增的配置，写入候选主节点的设备地址，在开启服务后可以被选为主节点，也就是说把所有的节点都写上</span></span><br><span class="line">discovery.seed_hosts: [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"><span class="comment">#当你在搭建集群的时候，选出合格的节点集群，有些人说的太官方了，</span></span><br><span class="line"><span class="comment">#其实就是，让你选择比较好的几个节点，在你节点启动时，在这些节点中选一个做领导者，</span></span><br><span class="line"><span class="comment">#如果你不设置呢，elasticsearch就会自己选举，这里我们把三个节点都写上</span></span><br><span class="line">cluster.initial_master_nodes: [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"><span class="comment">#在群集完全重新启动后阻止初始恢复，直到启动N个节点</span></span><br><span class="line"><span class="comment">#简单点说在集群启动后，至少复活多少个节点以上，那么这个服务才可以被使用，否则不可以被使用，</span></span><br><span class="line">gateway.recover_after_nodes: 2</span><br><span class="line"><span class="comment">#删除索引是是否需要显示其名称，默认为显示</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true</span></span><br><span class="line"><span class="comment"># 禁用安全配置，否则查询的时候会提示警告</span></span><br><span class="line">xpack.security.enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h5 id="node-3-1"><a href="#node-3-1" class="headerlink" title="node-3"></a>node-3</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /tmp/data/elasticsearch/node-3/config/elasticsearch.yml</span><br><span class="line"><span class="comment">#集群名称</span></span><br><span class="line">cluster.name: elastic</span><br><span class="line"><span class="comment">#当前该节点的名称</span></span><br><span class="line">node.name: node-3</span><br><span class="line"><span class="comment">#是不是有资格竞选主节点</span></span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line"><span class="comment">#是否存储数据</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line"><span class="comment">#最大集群节点数</span></span><br><span class="line">node.max_local_storage_nodes: 3</span><br><span class="line"><span class="comment">#给当前节点自定义属性（可以省略）</span></span><br><span class="line"><span class="comment">#node.attr.rack: r1</span></span><br><span class="line"><span class="comment">#数据存档位置</span></span><br><span class="line">path.data: /usr/share/elasticsearch/data</span><br><span class="line"><span class="comment">#日志存放位置</span></span><br><span class="line">path.logs: /usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line"><span class="comment">#是否开启时锁定内存（默认为是）</span></span><br><span class="line"><span class="comment">#bootstrap.memory_lock: true</span></span><br><span class="line"><span class="comment">#设置网关地址，我是被这个坑死了，这个地址我原先填写了自己的实际物理IP地址，</span></span><br><span class="line"><span class="comment">#然后启动一直报无效的IP地址，无法注入9300端口，这里只需要填写0.0.0.0</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="comment">#设置映射端口</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="comment">#内部节点之间沟通端口</span></span><br><span class="line">transport.tcp.port: 9300</span><br><span class="line"><span class="comment">#集群发现默认值为127.0.0.1:9300,如果要在其他主机上形成包含节点的群集,如果搭建集群则需要填写</span></span><br><span class="line"><span class="comment">#es7.x 之后新增的配置，写入候选主节点的设备地址，在开启服务后可以被选为主节点，也就是说把所有的节点都写上</span></span><br><span class="line">discovery.seed_hosts: [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"><span class="comment">#当你在搭建集群的时候，选出合格的节点集群，有些人说的太官方了，</span></span><br><span class="line"><span class="comment">#其实就是，让你选择比较好的几个节点，在你节点启动时，在这些节点中选一个做领导者，</span></span><br><span class="line"><span class="comment">#如果你不设置呢，elasticsearch就会自己选举，这里我们把三个节点都写上</span></span><br><span class="line">cluster.initial_master_nodes: [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"><span class="comment">#在群集完全重新启动后阻止初始恢复，直到启动N个节点</span></span><br><span class="line"><span class="comment">#简单点说在集群启动后，至少复活多少个节点以上，那么这个服务才可以被使用，否则不可以被使用，</span></span><br><span class="line">gateway.recover_after_nodes: 2</span><br><span class="line"><span class="comment">#删除索引是是否需要显示其名称，默认为显示</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true</span></span><br><span class="line"><span class="comment"># 禁用安全配置，否则查询的时候会提示警告</span></span><br><span class="line">xpack.security.enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h5 id="kibana-2"><a href="#kibana-2" class="headerlink" title="kibana"></a>kibana</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi  /tmp/data/kibana/config/kibana.yml</span><br><span class="line">server.host: 0.0.0.0</span><br><span class="line"><span class="comment"># 监听端口</span></span><br><span class="line">server.port: 5601</span><br><span class="line">server.name: <span class="string">&quot;kibana&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kibana访问es服务器的URL,就可以有多个，以逗号&quot;,&quot;隔开</span></span><br><span class="line">elasticsearch.hosts: [<span class="string">&quot;http://node-1:9200&quot;</span>,<span class="string">&quot;http://node-2:9201&quot;</span>,<span class="string">&quot;http://node-3:9202&quot;</span>]</span><br><span class="line">monitoring.ui.container.elasticsearch.enabled: <span class="literal">true</span></span><br><span class="line"><span class="comment"># kibana访问Elasticsearch的账号与密码(如果ElasticSearch设置了的话)</span></span><br><span class="line">elasticsearch.username: <span class="string">&quot;kibana&quot;</span></span><br><span class="line">elasticsearch.password: <span class="string">&quot;12345&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kibana日志文件存储路径</span></span><br><span class="line">logging.dest: stdout</span><br><span class="line"><span class="comment"># 此值为true时，禁止所有日志记录输出</span></span><br><span class="line">logging.silent: <span class="literal">false</span></span><br><span class="line"><span class="comment"># 此值为true时，禁止除错误消息之外的所有日志记录输出</span></span><br><span class="line">logging.quiet: <span class="literal">false</span></span><br><span class="line"><span class="comment"># 此值为true时，记录所有事件，包括系统使用信息和所有请求</span></span><br><span class="line">logging.verbose: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">ops.interval: 5000</span><br><span class="line"><span class="comment"># kibana web语言</span></span><br><span class="line">i18n.locale: <span class="string">&quot;zh-CN&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="编写部署文档-1"><a href="#编写部署文档-1" class="headerlink" title="编写部署文档"></a>编写部署文档</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi docker-compose.yml</span><br><span class="line">version: <span class="string">&quot;3&quot;</span></span><br><span class="line">services:</span><br><span class="line">  node-1:</span><br><span class="line">    image: elasticsearch:7.17.5</span><br><span class="line">    container_name: node-1</span><br><span class="line">    environment:</span><br><span class="line">      - <span class="string">&quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;</span></span><br><span class="line">      - <span class="string">&quot;TZ=Asia/Shanghai&quot;</span></span><br><span class="line">    ulimits:</span><br><span class="line">      memlock:</span><br><span class="line">        soft: -1</span><br><span class="line">        hard: -1</span><br><span class="line">      nofile:</span><br><span class="line">        soft: 65536</span><br><span class="line">        hard: 65536</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9200:9200&quot;</span></span><br><span class="line">    logging:</span><br><span class="line">      driver: <span class="string">&quot;json-file&quot;</span></span><br><span class="line">      options:</span><br><span class="line">        max-size: <span class="string">&quot;50m&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /tmp/data/elasticsearch/node-1/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span><br><span class="line">      - /tmp/data/elasticsearch/node-1/plugins:/usr/share/elasticsearch/plugins</span><br><span class="line">      - /tmp/data/elasticsearch/node-1/data:/usr/share/elasticsearch/data</span><br><span class="line">      - /tmp/data/elasticsearch/node-1/<span class="built_in">log</span>:/usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">  node-2:</span><br><span class="line">    image: elasticsearch:7.17.5</span><br><span class="line">    container_name: node-2</span><br><span class="line">    environment:</span><br><span class="line">      - <span class="string">&quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;</span></span><br><span class="line">      - <span class="string">&quot;TZ=Asia/Shanghai&quot;</span></span><br><span class="line">    ulimits:</span><br><span class="line">      memlock:</span><br><span class="line">        soft: -1</span><br><span class="line">        hard: -1</span><br><span class="line">      nofile:</span><br><span class="line">        soft: 65536</span><br><span class="line">        hard: 65536</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9201:9200&quot;</span></span><br><span class="line">    logging:</span><br><span class="line">      driver: <span class="string">&quot;json-file&quot;</span></span><br><span class="line">      options:</span><br><span class="line">        max-size: <span class="string">&quot;50m&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /tmp/data/elasticsearch/node-2/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span><br><span class="line">      - /tmp/data/elasticsearch/node-2/plugins:/usr/share/elasticsearch/plugins</span><br><span class="line">      - /tmp/data/elasticsearch/node-2/data:/usr/share/elasticsearch/data</span><br><span class="line">      - /tmp/data/elasticsearch/node-2/<span class="built_in">log</span>:/usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">  node-3:</span><br><span class="line">    image: elasticsearch:7.17.5</span><br><span class="line">    container_name: node-3</span><br><span class="line">    environment:</span><br><span class="line">      - <span class="string">&quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;</span></span><br><span class="line">      - <span class="string">&quot;TZ=Asia/Shanghai&quot;</span></span><br><span class="line">    ulimits:</span><br><span class="line">      memlock:</span><br><span class="line">        soft: -1</span><br><span class="line">        hard: -1</span><br><span class="line">      nofile:</span><br><span class="line">        soft: 65536</span><br><span class="line">        hard: 65536</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9202:9200&quot;</span></span><br><span class="line">    logging:</span><br><span class="line">      driver: <span class="string">&quot;json-file&quot;</span></span><br><span class="line">      options:</span><br><span class="line">        max-size: <span class="string">&quot;50m&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /tmp/data/elasticsearch/node-3/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span><br><span class="line">      - /tmp/data/elasticsearch/node-3/plugins:/usr/share/elasticsearch/plugins</span><br><span class="line">      - /tmp/data/elasticsearch/node-3/data:/usr/share/elasticsearch/data</span><br><span class="line">      - /tmp/data/elasticsearch/node-3/<span class="built_in">log</span>:/usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">  kibana:</span><br><span class="line">    container_name: kibana</span><br><span class="line">    image: kibana:7.17.5</span><br><span class="line">    volumes:</span><br><span class="line">      - /tmp/data/kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml</span><br><span class="line">    ports:</span><br><span class="line">      - 5601:5601</span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">  cerebro:</span><br><span class="line">      image: lmenezes/cerebro:0.9.4</span><br><span class="line">      container_name: cerebro</span><br><span class="line">      environment:</span><br><span class="line">        TZ: <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line">      ports:</span><br><span class="line">        - <span class="string">&#x27;9000:9000&#x27;</span></span><br><span class="line">      networks:</span><br><span class="line">        - elastic</span><br><span class="line">networks:</span><br><span class="line">  elastic:</span><br><span class="line">    driver: bridge</span><br></pre></td></tr></table></figure>

<h4 id="启动服务-1"><a href="#启动服务-1" class="headerlink" title="启动服务"></a>启动服务</h4><blockquote>
<p>使用以下命令就可以启动服务了</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<h3 id="同步服务部署"><a href="#同步服务部署" class="headerlink" title="同步服务部署"></a>同步服务部署</h3><blockquote>
<p>下面我们来搭建以下同步服务，该服务主要用来进行将MySQL的数据同步到ES中</p>
</blockquote>
<h4 id="服务布局-2"><a href="#服务布局-2" class="headerlink" title="服务布局"></a>服务布局</h4><blockquote>
<p>我们整体采用Docker方式进行布局，以下是我们需要部署的服务</p>
</blockquote>
<table>
<thead>
<tr>
<th>服务名称</th>
<th>服务名称</th>
<th>开放端口</th>
</tr>
</thead>
<tbody><tr>
<td>MySQL</td>
<td>MySQL</td>
<td>3306</td>
</tr>
<tr>
<td>Canal</td>
<td>Canal</td>
<td>无</td>
</tr>
<tr>
<td>RabbitMQ</td>
<td>RabbitMQ</td>
<td>5672</td>
</tr>
<tr>
<td>logstash</td>
<td>logstash</td>
<td>无</td>
</tr>
</tbody></table>
<h4 id="准备工作-2"><a href="#准备工作-2" class="headerlink" title="准备工作"></a>准备工作</h4><h5 id="创建挂载目录-2"><a href="#创建挂载目录-2" class="headerlink" title="创建挂载目录"></a>创建挂载目录</h5><blockquote>
<p>下面我们需要创建相关的挂载目录</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p /tmp/etc/&#123;canal,logstash,mysql&#125;</span><br><span class="line">mkdir -p /tmp/data/&#123;canal,logstash,mysql,rabbitmq&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建canal日志目录</span></span><br><span class="line">mkdir -p /tmp/data/canal/logs</span><br><span class="line"><span class="comment"># 创建logstash的pipeline配置目录</span></span><br><span class="line">mkdir -p /tmp/etc/logstash/pipeline</span><br><span class="line"><span class="comment"># 创建logstash日志目录</span></span><br><span class="line">mkdir -p /tmp/data/logstash/logs</span><br><span class="line"></span><br><span class="line">chmod -R 777 /tmp/etc/&#123;canal,logstash,mysql&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h4><h5 id="MySQL配置文件"><a href="#MySQL配置文件" class="headerlink" title="MySQL配置文件"></a>MySQL配置文件</h5><blockquote>
<p>我们需要开启binlog的row模式</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /tmp/etc/mysql/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">log-bin=mysql-bin <span class="comment"># 开启 binlog</span></span><br><span class="line">binlog-format=ROW <span class="comment"># 选择 ROW 模式</span></span><br><span class="line">server_id=1 <span class="comment"># 配置 MySQL replaction 需要定义，不要和 canal 的 slaveId 重复</span></span><br></pre></td></tr></table></figure>

<h5 id="Canan配置文件"><a href="#Canan配置文件" class="headerlink" title="Canan配置文件"></a>Canan配置文件</h5><h6 id="配置canal-properties"><a href="#配置canal-properties" class="headerlink" title="配置canal.properties"></a>配置canal.properties</h6><blockquote>
<p>配置Canal配置文件canal.properties的挂载文件</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /tmp/etc/canal/canal.properties</span><br><span class="line"><span class="comment">#################################################</span></span><br><span class="line"><span class="comment">#########               common argument         #############</span></span><br><span class="line"><span class="comment">#################################################</span></span><br><span class="line"><span class="comment"># tcp bind ip</span></span><br><span class="line">canal.ip =</span><br><span class="line"><span class="comment"># register ip to zookeeper</span></span><br><span class="line">canal.register.ip =</span><br><span class="line">canal.port = 11111</span><br><span class="line">canal.metrics.pull.port = 11112</span><br><span class="line"><span class="comment"># canal instance user/passwd</span></span><br><span class="line"><span class="comment"># canal.user = canal</span></span><br><span class="line"><span class="comment"># canal.passwd = E3619321C1A937C46A0D8BD1DAC39F93B27D4458</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># canal admin config</span></span><br><span class="line"><span class="comment">#canal.admin.manager = 127.0.0.1:8089</span></span><br><span class="line">canal.admin.port = 11110</span><br><span class="line">canal.admin.user = admin</span><br><span class="line">canal.admin.passwd = 4ACFE3202A5FF5CF467898FC58AAB1D615029441</span><br><span class="line"></span><br><span class="line">canal.zkServers =</span><br><span class="line"><span class="comment"># flush data to zk</span></span><br><span class="line">canal.zookeeper.flush.period = 1000</span><br><span class="line">canal.withoutNetty = <span class="literal">false</span></span><br><span class="line"><span class="comment"># tcp, kafka, rocketMQ, rabbitMQ</span></span><br><span class="line">canal.serverMode = rabbitMQ</span><br><span class="line"><span class="comment"># flush meta cursor/parse position to file</span></span><br><span class="line">canal.file.data.dir = <span class="variable">$&#123;canal.conf.dir&#125;</span></span><br><span class="line">canal.file.flush.period = 1000</span><br><span class="line"><span class="comment">## memory store RingBuffer size, should be Math.pow(2,n)</span></span><br><span class="line">canal.instance.memory.buffer.size = 16384</span><br><span class="line"><span class="comment">## memory store RingBuffer used memory unit size , default 1kb</span></span><br><span class="line">canal.instance.memory.buffer.memunit = 1024</span><br><span class="line"><span class="comment">## meory store gets mode used MEMSIZE or ITEMSIZE</span></span><br><span class="line">canal.instance.memory.batch.mode = MEMSIZE</span><br><span class="line">canal.instance.memory.rawEntry = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## detecing config</span></span><br><span class="line">canal.instance.detecting.enable = <span class="literal">false</span></span><br><span class="line"><span class="comment">#canal.instance.detecting.sql = insert into retl.xdual values(1,now()) on duplicate key update x=now()</span></span><br><span class="line">canal.instance.detecting.sql = select 1</span><br><span class="line">canal.instance.detecting.interval.time = 3</span><br><span class="line">canal.instance.detecting.retry.threshold = 3</span><br><span class="line">canal.instance.detecting.heartbeatHaEnable = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># support maximum transaction size, more than the size of the transaction will be cut into multiple transactions delivery</span></span><br><span class="line">canal.instance.transaction.size =  1024</span><br><span class="line"><span class="comment"># mysql fallback connected to new master should fallback times</span></span><br><span class="line">canal.instance.fallbackIntervalInSeconds = 60</span><br><span class="line"></span><br><span class="line"><span class="comment"># network config</span></span><br><span class="line">canal.instance.network.receiveBufferSize = 16384</span><br><span class="line">canal.instance.network.sendBufferSize = 16384</span><br><span class="line">canal.instance.network.soTimeout = 30</span><br><span class="line"></span><br><span class="line"><span class="comment"># binlog filter config</span></span><br><span class="line">canal.instance.filter.druid.ddl = <span class="literal">true</span></span><br><span class="line">canal.instance.filter.query.dcl = <span class="literal">false</span></span><br><span class="line">canal.instance.filter.query.dml = <span class="literal">false</span></span><br><span class="line">canal.instance.filter.query.ddl = <span class="literal">false</span></span><br><span class="line">canal.instance.filter.table.error = <span class="literal">false</span></span><br><span class="line">canal.instance.filter.rows = <span class="literal">false</span></span><br><span class="line">canal.instance.filter.transaction.entry = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># binlog format/image check</span></span><br><span class="line">canal.instance.binlog.format = ROW,STATEMENT,MIXED</span><br><span class="line">canal.instance.binlog.image = FULL,MINIMAL,NOBLOB</span><br><span class="line"></span><br><span class="line"><span class="comment"># binlog ddl isolation</span></span><br><span class="line">canal.instance.get.ddl.isolation = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># parallel parser config</span></span><br><span class="line">canal.instance.parser.parallel = <span class="literal">true</span></span><br><span class="line"><span class="comment">## concurrent thread number, default 60% available processors, suggest not to exceed Runtime.getRuntime().availableProcessors()</span></span><br><span class="line"><span class="comment">#canal.instance.parser.parallelThreadSize = 16</span></span><br><span class="line"><span class="comment">## disruptor ringbuffer size, must be power of 2</span></span><br><span class="line">canal.instance.parser.parallelBufferSize = 256</span><br><span class="line"></span><br><span class="line"><span class="comment"># table meta tsdb info</span></span><br><span class="line">canal.instance.tsdb.enable = <span class="literal">true</span></span><br><span class="line">canal.instance.tsdb.dir = <span class="variable">$&#123;canal.file.data.dir:../conf&#125;</span>/<span class="variable">$&#123;canal.instance.destination:&#125;</span></span><br><span class="line">canal.instance.tsdb.url = jdbc:h2:<span class="variable">$&#123;canal.instance.tsdb.dir&#125;</span>/h2;CACHE_SIZE=1000;MODE=MYSQL;</span><br><span class="line">canal.instance.tsdb.dbUsername = canal</span><br><span class="line">canal.instance.tsdb.dbPassword = canal</span><br><span class="line"><span class="comment"># dump snapshot interval, default 24 hour</span></span><br><span class="line">canal.instance.tsdb.snapshot.interval = 24</span><br><span class="line"><span class="comment"># purge snapshot expire , default 360 hour(15 days)</span></span><br><span class="line">canal.instance.tsdb.snapshot.expire = 360</span><br><span class="line"></span><br><span class="line"><span class="comment">#################################################</span></span><br><span class="line"><span class="comment">#########               destinations            #############</span></span><br><span class="line"><span class="comment">#################################################</span></span><br><span class="line">canal.destinations = village</span><br><span class="line"><span class="comment"># conf root dir</span></span><br><span class="line">canal.conf.dir = ../conf</span><br><span class="line"><span class="comment"># auto scan instance dir add/remove and start/stop instance</span></span><br><span class="line">canal.auto.scan = <span class="literal">true</span></span><br><span class="line">canal.auto.scan.interval = 5</span><br><span class="line"></span><br><span class="line">canal.instance.tsdb.spring.xml = classpath:spring/tsdb/h2-tsdb.xml</span><br><span class="line"><span class="comment">#canal.instance.tsdb.spring.xml = classpath:spring/tsdb/mysql-tsdb.xml</span></span><br><span class="line"></span><br><span class="line">canal.instance.global.mode = spring</span><br><span class="line">canal.instance.global.lazy = <span class="literal">false</span></span><br><span class="line">canal.instance.global.manager.address = <span class="variable">$&#123;canal.admin.manager&#125;</span></span><br><span class="line"><span class="comment">#canal.instance.global.spring.xml = classpath:spring/memory-instance.xml</span></span><br><span class="line">canal.instance.global.spring.xml = classpath:spring/file-instance.xml</span><br><span class="line"><span class="comment">#canal.instance.global.spring.xml = classpath:spring/default-instance.xml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##################################################</span></span><br><span class="line"><span class="comment">#########             MQ Properties      #############</span></span><br><span class="line"><span class="comment">##################################################</span></span><br><span class="line"><span class="comment"># aliyun ak/sk , support rds/mq</span></span><br><span class="line">canal.aliyun.accessKey =</span><br><span class="line">canal.aliyun.secretKey =</span><br><span class="line">canal.aliyun.uid=</span><br><span class="line"></span><br><span class="line">canal.mq.flatMessage = <span class="literal">true</span></span><br><span class="line">canal.mq.canalBatchSize = 50</span><br><span class="line">canal.mq.canalGetTimeout = 100</span><br><span class="line"><span class="comment"># Set this value to &quot;cloud&quot;, if you want open message trace feature in aliyun.</span></span><br><span class="line">canal.mq.accessChannel = <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line">canal.mq.database.hash = <span class="literal">true</span></span><br><span class="line">canal.mq.send.thread.size = 30</span><br><span class="line">canal.mq.build.thread.size = 8</span><br><span class="line"></span><br><span class="line"><span class="comment">##################################################</span></span><br><span class="line"><span class="comment">#########                    Kafka                   #############</span></span><br><span class="line"><span class="comment">##################################################</span></span><br><span class="line">kafka.bootstrap.servers = 127.0.0.1:9092</span><br><span class="line">kafka.acks = all</span><br><span class="line">kafka.compression.type = none</span><br><span class="line">kafka.batch.size = 16384</span><br><span class="line">kafka.linger.ms = 1</span><br><span class="line">kafka.max.request.size = 1048576</span><br><span class="line">kafka.buffer.memory = 33554432</span><br><span class="line">kafka.max.in.flight.requests.per.connection = 1</span><br><span class="line">kafka.retries = 0</span><br><span class="line"></span><br><span class="line">kafka.kerberos.enable = <span class="literal">false</span></span><br><span class="line">kafka.kerberos.krb5.file = <span class="string">&quot;../conf/kerberos/krb5.conf&quot;</span></span><br><span class="line">kafka.kerberos.jaas.file = <span class="string">&quot;../conf/kerberos/jaas.conf&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##################################################</span></span><br><span class="line"><span class="comment">#########                   RocketMQ         #############</span></span><br><span class="line"><span class="comment">##################################################</span></span><br><span class="line">rocketmq.producer.group = <span class="built_in">test</span></span><br><span class="line">rocketmq.enable.message.trace = <span class="literal">false</span></span><br><span class="line">rocketmq.customized.trace.topic =</span><br><span class="line">rocketmq.namespace =</span><br><span class="line">rocketmq.namesrv.addr = 127.0.0.1:9876</span><br><span class="line">rocketmq.retry.times.when.send.failed = 0</span><br><span class="line">rocketmq.vip.channel.enabled = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##################################################</span></span><br><span class="line"><span class="comment">#########                   RabbitMQ         #############</span></span><br><span class="line"><span class="comment">##################################################</span></span><br><span class="line">rabbitmq.host = rabbit</span><br><span class="line">rabbitmq.virtual.host = /</span><br><span class="line">rabbitmq.exchange = canal</span><br><span class="line">rabbitmq.username = guest</span><br><span class="line">rabbitmq.password = guest</span><br></pre></td></tr></table></figure>

<h6 id="配置-instance-properties"><a href="#配置-instance-properties" class="headerlink" title="配置 instance.properties"></a>配置 instance.properties</h6><blockquote>
<p>配置Canal的数据源配置文件<code>instance.properties</code>的挂载文件,路径在<code>village/instance.properties</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p /tmp/etc/canal/village</span><br><span class="line">vi /tmp/etc/canal/village/instance.properties</span><br><span class="line"><span class="comment">#################################################</span></span><br><span class="line"><span class="comment">## mysql serverId , v1.0.26+ will autoGen</span></span><br><span class="line"><span class="comment">## mysql slaveId v1.0.26 后的版本支持自动生成 可以不需要配置</span></span><br><span class="line"><span class="comment"># canal.instance.mysql.slaveId=0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># enable gtid use true/false</span></span><br><span class="line">canal.instance.gtidon=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># position info</span></span><br><span class="line"><span class="comment">## 配置连接数据库的地址</span></span><br><span class="line">canal.instance.master.address=mysql:3306</span><br><span class="line">canal.instance.master.journal.name=</span><br><span class="line">canal.instance.master.position=</span><br><span class="line">canal.instance.master.timestamp=</span><br><span class="line">canal.instance.master.gtid=</span><br><span class="line"></span><br><span class="line"><span class="comment"># rds oss binlog</span></span><br><span class="line">canal.instance.rds.accesskey=</span><br><span class="line">canal.instance.rds.secretkey=</span><br><span class="line">canal.instance.rds.instanceId=</span><br><span class="line"></span><br><span class="line"><span class="comment"># table meta tsdb info</span></span><br><span class="line">canal.instance.tsdb.enable=<span class="literal">true</span></span><br><span class="line"><span class="comment">#canal.instance.tsdb.url=jdbc:mysql://172.18.0.10:3306/test</span></span><br><span class="line"><span class="comment">#canal.instance.tsdb.dbUsername=canal</span></span><br><span class="line"><span class="comment">#canal.instance.tsdb.dbPassword=canal</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#canal.instance.standby.address =</span></span><br><span class="line"><span class="comment">#canal.instance.standby.journal.name =</span></span><br><span class="line"><span class="comment">#canal.instance.standby.position =</span></span><br><span class="line"><span class="comment">#canal.instance.standby.timestamp =</span></span><br><span class="line"><span class="comment">#canal.instance.standby.gtid=</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># username/password</span></span><br><span class="line"><span class="comment"># 配置数据库用户名密码</span></span><br><span class="line">canal.instance.dbUsername=canal</span><br><span class="line">canal.instance.dbPassword=canal</span><br><span class="line"><span class="comment"># 配置 连接数据库的编码格式</span></span><br><span class="line">canal.instance.connectionCharset = UTF-8</span><br><span class="line"><span class="comment"># enable druid Decrypt database password</span></span><br><span class="line">canal.instance.enableDruid=<span class="literal">false</span></span><br><span class="line"><span class="comment">#canal.instance.pwdPublicKey=MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBALK4BUxdDltRRE5/zXpVEVPUgunvscYFtEip3pmLlhrWpacX7y7GCMo2/JM6LeHmiiNdH1FWgGCpUfircSwlWKUCAwEAAQ==</span></span><br><span class="line"><span class="comment">#canal.instance.defaultDatabaseName=village</span></span><br><span class="line"><span class="comment"># table regex</span></span><br><span class="line"><span class="comment">## canal 收集表的 过滤正则表达式 这个表示收集所有表数据</span></span><br><span class="line"><span class="comment">#canal.instance.filter.regex=t_village</span></span><br><span class="line">canal.instance.filter.regex=village\\..*</span><br><span class="line"><span class="comment"># table black regex</span></span><br><span class="line"><span class="comment">## canal 收集表的黑名单</span></span><br><span class="line">canal.instance.filter.black.regex=</span><br><span class="line"><span class="comment"># table field filter(format: schema1.tableName1:field1/field2,schema2.tableName2:field1/field2)</span></span><br><span class="line"><span class="comment">#canal.instance.filter.field=test1.t_product:id/subject/keywords,test2.t_company:id/name/contact/ch</span></span><br><span class="line"><span class="comment"># table field black filter(format: schema1.tableName1:field1/field2,schema2.tableName2:field1/field2)</span></span><br><span class="line"><span class="comment">#canal.instance.filter.black.field=test1.t_product:subject/product_image,test2.t_company:id/name/contact/ch</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#################################################</span></span><br></pre></td></tr></table></figure>

<h5 id="Logstash配置文件"><a href="#Logstash配置文件" class="headerlink" title="Logstash配置文件"></a>Logstash配置文件</h5><h6 id="创建-logstash-yml"><a href="#创建-logstash-yml" class="headerlink" title="创建 logstash.yml"></a>创建 logstash.yml</h6><blockquote>
<p>该配置文件时logstash的主要的配置文件</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /tmp/etc/logstash/logstash.yml</span><br><span class="line">http.host: 0.0.0.0</span><br><span class="line">path.config: /usr/share/logstash/config/pipeline/*.conf</span><br><span class="line">path.logs: /usr/share/logstash/logs</span><br><span class="line">pipeline.batch.size: 10</span><br><span class="line">xpack.monitoring.elasticsearch.hosts:</span><br><span class="line">- http://192.168.245.151:9200</span><br><span class="line">xpack.monitoring.enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h6 id="创建village-conf"><a href="#创建village-conf" class="headerlink" title="创建village.conf"></a>创建village.conf</h6><blockquote>
<p>该文件是logstash的pipeline的配置</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /tmp/etc/logstash/pipeline/village.conf</span><br><span class="line">input &#123;</span><br><span class="line">    rabbitmq &#123;</span><br><span class="line">        host =&gt; <span class="string">&quot;rabbit&quot;</span>    <span class="comment">#RabbitMQ-IP地址</span></span><br><span class="line">        port =&gt; 5672             <span class="comment">#端口号</span></span><br><span class="line">        vhost =&gt; <span class="string">&quot;/&quot;</span>      <span class="comment">#虚拟主机</span></span><br><span class="line">        user =&gt; <span class="string">&quot;guest&quot;</span>            <span class="comment">#用户名</span></span><br><span class="line">        password =&gt; <span class="string">&quot;guest&quot;</span>        <span class="comment">#密码</span></span><br><span class="line">        exchange=&gt; <span class="string">&quot;canal&quot;</span> <span class="comment"># rabbitmq中的交换器</span></span><br><span class="line">        key =&gt; <span class="string">&quot;&quot;</span></span><br><span class="line">        queue =&gt; <span class="string">&quot;direct_queue&quot;</span>      <span class="comment">#队列</span></span><br><span class="line">        durable =&gt; <span class="literal">false</span>         <span class="comment">#持久化跟队列配置一致</span></span><br><span class="line">        codec =&gt; <span class="string">&quot;json&quot;</span>         <span class="comment">#格式</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">&quot;DELETE&quot;</span> &#123;</span><br><span class="line">        drop&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    split &#123;</span><br><span class="line">        field =&gt; <span class="string">&quot;data&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutate &#123;</span><br><span class="line">        remove_field  =&gt; [<span class="string">&quot;sqlType&quot;</span>]</span><br><span class="line">        remove_field  =&gt; [<span class="string">&quot;mysqlType&quot;</span>]</span><br><span class="line">        remove_field  =&gt; [<span class="string">&quot;database&quot;</span>]</span><br><span class="line">        remove_field  =&gt; [<span class="string">&quot;sql&quot;</span>]</span><br><span class="line">        remove_field  =&gt; [<span class="string">&quot;es&quot;</span>]</span><br><span class="line">        remove_field  =&gt; [<span class="string">&quot;ts&quot;</span>]</span><br><span class="line">        remove_field  =&gt; [<span class="string">&quot;pkNames&quot;</span>]</span><br><span class="line">        remove_field  =&gt; [<span class="string">&quot;isDdl&quot;</span>]</span><br><span class="line">        remove_field  =&gt; [<span class="string">&quot;table&quot;</span>]</span><br><span class="line">        remove_field  =&gt; [<span class="string">&quot;tags&quot;</span>]</span><br><span class="line">        remove_field  =&gt; [<span class="string">&quot;type&quot;</span>]</span><br><span class="line">        remove_field  =&gt; [<span class="string">&quot;old&quot;</span>]</span><br><span class="line">        remove_field  =&gt; [<span class="string">&quot;id&quot;</span>]</span><br><span class="line">        remove_field  =&gt; [<span class="string">&quot;sql&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    date &#123;</span><br><span class="line">        match =&gt; [<span class="string">&quot;create_date&quot;</span>, <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>]</span><br><span class="line">        locale =&gt; <span class="string">&quot;en&quot;</span></span><br><span class="line">        timezone =&gt; <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">        target =&gt; <span class="string">&quot;@timestamp&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ruby &#123;</span><br><span class="line">          code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">              event.set(&#x27;@timestamp&#x27;, LogStash::Timestamp.at(event.get(&#x27;@timestamp&#x27;).time.localtime + 8*60*60))</span></span><br><span class="line"><span class="string">          &quot;</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [data][name] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;name&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][name]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> [data][province]&#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;province&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][province]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> [data][city]&#123;</span><br><span class="line">         mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;city&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][city]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> [data][area]&#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;area&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][area]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> [data][addr]&#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;addr&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][addr]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [data][lat_gps]&#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;[location][lat]&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][lat_gps]&#125;&quot;</span>&#125;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;[location][lon]&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][lon_gps]&#125;&quot;</span>&#125;</span><br><span class="line">            convert =&gt; &#123; <span class="string">&quot;[location][lat]&quot;</span> =&gt; <span class="string">&quot;float&quot;</span> &#125;</span><br><span class="line">            convert =&gt; &#123; <span class="string">&quot;[location][lon]&quot;</span> =&gt; <span class="string">&quot;float&quot;</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [data][property_type]&#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;property_type&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][property_type]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> [data][property_company]&#123;</span><br><span class="line">                mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;property_company&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][property_company]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> [data][property_cost]&#123;</span><br><span class="line">                mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;property_cost&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][property_cost]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> [data][floorage]&#123;</span><br><span class="line">                mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;floorage&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][floorage]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> [data][houses]&#123;</span><br><span class="line">                mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;houses&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][houses]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> [data][built_year]&#123;</span><br><span class="line">                mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;built_year&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][built_year]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> [data][parkings]&#123;</span><br><span class="line">                mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;parkings&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][parkings]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> [data][volume]&#123;</span><br><span class="line">                mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;volume&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][volume]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> [data][greening]&#123;</span><br><span class="line">                mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;greening&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][greening]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> [data][producer]&#123;</span><br><span class="line">                mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;producer&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][producer]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> [data][school]&#123;</span><br><span class="line">                mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;school&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][school]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> [data][info]&#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; <span class="string">&quot;info&quot;</span> =&gt; <span class="string">&quot;%&#123;[data][info]&#125;&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#    if [data][create_date]&#123;</span></span><br><span class="line"><span class="comment">#        mutate &#123;</span></span><br><span class="line"><span class="comment">#            add_field =&gt; &#123; &quot;create_date&quot; =&gt; &quot;%&#123;[data][create_date]&#125;&quot;&#125;</span></span><br><span class="line"><span class="comment">#        &#125;</span></span><br><span class="line"><span class="comment">#    &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    mutate &#123;</span><br><span class="line">        remove_field  =&gt; [<span class="string">&quot;data&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt; [<span class="string">&quot;192.168.245.151:9200&quot;</span>]</span><br><span class="line">        index =&gt; <span class="string">&quot;logstash-village-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment"># stdout &#123; codec =&gt; rubydebug &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编写部署文档-2"><a href="#编写部署文档-2" class="headerlink" title="编写部署文档"></a>编写部署文档</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi docker-compose.yml</span><br><span class="line">version: <span class="string">&#x27;2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  mysql:</span><br><span class="line">    image: mysql:5.7</span><br><span class="line">    hostname: mysql</span><br><span class="line">    container_name: mysql</span><br><span class="line">    networks:</span><br><span class="line">      - dockernetwork</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD: root</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="string">&quot;/tmp/etc/mysql:/etc/mysql/conf.d&quot;</span></span><br><span class="line">      - <span class="string">&quot;/tmp/data/mysql:/var/lib/mysql&quot;</span></span><br><span class="line">  rabbit:</span><br><span class="line">    image: rabbitmq:management</span><br><span class="line">    hostname: rabbit</span><br><span class="line">    container_name: rabbit</span><br><span class="line">    networks:</span><br><span class="line">      - dockernetwork</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;15672:15672&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="string">&quot;/tmp/data/rabbitmq:/var/lib/rabbitmq&quot;</span></span><br><span class="line">  canal:</span><br><span class="line">    image: canal/canal-server:v1.1.5</span><br><span class="line">    hostname: canal</span><br><span class="line">    container_name: canal</span><br><span class="line">    restart: always</span><br><span class="line">    networks:</span><br><span class="line">      - dockernetwork</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="string">&quot;/tmp/etc/canal/canal.properties:/home/admin/canal-server/conf/canal.properties&quot;</span></span><br><span class="line">      - <span class="string">&quot;/tmp/etc/canal/village:/home/admin/canal-server/conf/village&quot;</span></span><br><span class="line">      - <span class="string">&quot;/tmp/data/canal/logs:/home/admin/canal-server/logs&quot;</span></span><br><span class="line">    depends_on:</span><br><span class="line">      - mysql</span><br><span class="line">      - rabbit</span><br><span class="line">  logstash:</span><br><span class="line">    image: logstash:7.17.5</span><br><span class="line">    hostname: logstash</span><br><span class="line">    container_name: logstash</span><br><span class="line">    privileged: <span class="literal">true</span></span><br><span class="line">    restart: always</span><br><span class="line">    networks:</span><br><span class="line">      - dockernetwork</span><br><span class="line">    environment:</span><br><span class="line">      XPACK_MONITORING_ENABLED: <span class="string">&quot;false&quot;</span></span><br><span class="line">      pipeline.batch.size: 10</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="string">&quot;/tmp/etc/logstash/pipeline/:/usr/share/logstash/config/pipeline&quot;</span></span><br><span class="line">      - <span class="string">&quot;/tmp/etc/logstash/logstash.yml:/usr/share/logstash/config/logstash.yml&quot;</span></span><br><span class="line">      - <span class="string">&quot;/tmp/data/logstash/logs:/usr/share/logstash/logs&quot;</span></span><br><span class="line">    depends_on:</span><br><span class="line">      - mysql</span><br><span class="line">      - rabbit</span><br><span class="line">      - canal</span><br><span class="line">networks:</span><br><span class="line">  dockernetwork:</span><br><span class="line">    driver: bridge</span><br></pre></td></tr></table></figure>

<h4 id="启动服务-2"><a href="#启动服务-2" class="headerlink" title="启动服务"></a>启动服务</h4><blockquote>
<p>执行下面的命令启动服务</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<h3 id="初始化服务"><a href="#初始化服务" class="headerlink" title="初始化服务"></a>初始化服务</h3><h4 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h4><h5 id="检查数据库"><a href="#检查数据库" class="headerlink" title="检查数据库"></a>检查数据库</h5><blockquote>
<p>可以使用远程工具连接MySql检查是否能够正常连接</p>
</blockquote>
<h5 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h5><blockquote>
<p>通过下面的脚本来创建数据库</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE `village` </span><br><span class="line">USE `village`;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `t_village`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_village` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;小区名字&#x27;</span>,</span><br><span class="line">  `province` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;省&#x27;</span>,</span><br><span class="line">  `city` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;市&#x27;</span>,</span><br><span class="line">  `area` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;区&#x27;</span>,</span><br><span class="line">  `addr` <span class="type">varchar</span>(<span class="number">200</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;地址&#x27;</span>,</span><br><span class="line">  `lon_baid` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;经度_百度&#x27;</span>,</span><br><span class="line">  `lat_baid` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;维度_百度&#x27;</span>,</span><br><span class="line">  `lon_gps` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;经度_GPS&#x27;</span>,</span><br><span class="line">  `lat_gps` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;维度_GPS&#x27;</span>,</span><br><span class="line">  `property_type` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;小区物业类型&#x27;</span>,</span><br><span class="line">  `property_cost` <span class="type">float</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;小区物业费用/平米&#x27;</span>,</span><br><span class="line">  `property_company` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;物业公司&#x27;</span>,</span><br><span class="line">  `floorage` <span class="type">float</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;总建筑面积&#x27;</span>,</span><br><span class="line">  `houses` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;总户数&#x27;</span>,</span><br><span class="line">  `built_year` <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;建造年代&#x27;</span>,</span><br><span class="line">  `parkings` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;停车位数量&#x27;</span>,</span><br><span class="line">  `volume` <span class="type">float</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;容积率&#x27;</span>,</span><br><span class="line">  `greening` <span class="type">float</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;绿化率&#x27;</span>,</span><br><span class="line">  `producer` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;开发商&#x27;</span>,</span><br><span class="line">  `school` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;相关学校&#x27;</span>,</span><br><span class="line">  `info` <span class="type">varchar</span>(<span class="number">15000</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;小区介绍&#x27;</span>,</span><br><span class="line">  `create_date` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">334511</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_unicode_ci;</span><br></pre></td></tr></table></figure>

<h5 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据"></a>导入数据</h5><blockquote>
<p>通过服务连接Mysql服务，就可以将excel数据导入到mysql</p>
</blockquote>
<h5 id="创建Canal用户"><a href="#创建Canal用户" class="headerlink" title="创建Canal用户"></a>创建Canal用户</h5><blockquote>
<p>canal的原理是模拟自己为mysql slave，所以这里一定需要做为mysql slave的相关权限</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> canal IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;canal&#x27;</span>;  </span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, REPLICATION SLAVE, REPLICATION CLIENT <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;canal&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="comment">-- GRANT ALL PRIVILEGES ON *.* TO &#x27;canal&#x27;@&#x27;%&#x27; ;</span></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<h4 id="初始化RabbitMQ"><a href="#初始化RabbitMQ" class="headerlink" title="初始化RabbitMQ"></a>初始化RabbitMQ</h4><blockquote>
<p>要将消息推送到RabbitMQ需要先添加交换器以及队列，登录<code>http://192.168.245.151:15672/</code>进行操作</p>
</blockquote>
<h5 id="新增交换器"><a href="#新增交换器" class="headerlink" title="新增交换器"></a>新增交换器</h5><blockquote>
<p>我们新增一个<code>canal</code>的交换器</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch206.png" alt="image-20220920103056195"></p>
<h5 id="建立绑定关系"><a href="#建立绑定关系" class="headerlink" title="建立绑定关系"></a>建立绑定关系</h5><blockquote>
<p>让<code>canal</code>交换器和<code>direct_queue</code>队列建立绑定关系，路由键为空</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch205.png" alt="image-20220920103247945"></p>
<h6 id="查看队列情况"><a href="#查看队列情况" class="headerlink" title="查看队列情况"></a>查看队列情况</h6><blockquote>
<p>我们绑定完成后，可以来查看一下队列的情况</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch174.png" alt="image-20220920103407361"></p>
<h4 id="ElasticSearch初始化"><a href="#ElasticSearch初始化" class="headerlink" title="ElasticSearch初始化"></a>ElasticSearch初始化</h4><blockquote>
<p>因为要导入ES，我们需要先创建索引</p>
</blockquote>
<h5 id="创建索引模板"><a href="#创建索引模板" class="headerlink" title="创建索引模板"></a>创建索引模板</h5><blockquote>
<p>创建一个有三个分片两个副本的索引</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT _index_template/logstash-village</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;index_patterns&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;logstash-village-*&quot;</span>  // 可以通过<span class="string">&quot;logstash-village-*&quot;</span>来适配创建的索引</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;template&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;number_of_shards&quot;</span>: <span class="string">&quot;3&quot;</span>, //指定模板分片数量</span><br><span class="line">      <span class="string">&quot;number_of_replicas&quot;</span>: <span class="string">&quot;2&quot;</span>  //指定模板副本数量</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;aliases&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;logstash-village&quot;</span>: &#123;&#125;  //指定模板索引别名</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;   //设置映射</span><br><span class="line">      <span class="string">&quot;dynamic&quot;</span>: <span class="string">&quot;strict&quot;</span>, //禁用动态映射</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@timestamp&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">          <span class="string">&quot;format&quot;</span>: <span class="string">&quot;strict_date_optional_time||epoch_millis||yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;@version&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;doc_values&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="string">&quot;index&quot;</span>: <span class="string">&quot;false&quot;</span>,</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;province&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;city&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;area&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;addr&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;geo_point&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;property_type&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;property_company&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;property_cost&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;float&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;floorage&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;float&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;houses&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;built_year&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;parkings&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;volume&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;float&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;greening&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;float&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;producer&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;school&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;info&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="导入数据进行同步"><a href="#导入数据进行同步" class="headerlink" title="导入数据进行同步"></a>导入数据进行同步</h4><blockquote>
<p>接下来我们就需要导入相关的Excel的数据进行同步了，logstash会自动的创建索引，并应用上面的模板</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:8080/api/import/crawler-data-4745655-1554808595755.xlsx</span><br></pre></td></tr></table></figure>

<h3 id="KIBANA数据分析"><a href="#KIBANA数据分析" class="headerlink" title="KIBANA数据分析"></a>KIBANA数据分析</h3><blockquote>
<p>我们的数据已经导入到了ES中了，我们来对数据进行一波分析</p>
</blockquote>
<h4 id="管理索引"><a href="#管理索引" class="headerlink" title="管理索引"></a>管理索引</h4><blockquote>
<p>下面我们看下kibana如何进行索引管理</p>
</blockquote>
<h5 id="创建索引模式"><a href="#创建索引模式" class="headerlink" title="创建索引模式"></a>创建索引模式</h5><h6 id="进入索引管理"><a href="#进入索引管理" class="headerlink" title="进入索引管理"></a>进入索引管理</h6><blockquote>
<p>我们点击<code>Stack Management</code>进入索引管理模块</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch175.png" alt="image-20220914172738277"></p>
<h6 id="查看当前索引"><a href="#查看当前索引" class="headerlink" title="查看当前索引"></a>查看当前索引</h6><blockquote>
<p>进入管理模块后，点击索引管理，可以看到我们创建的索引</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch176.png" alt="image-20220914172911866"></p>
<h6 id="创建索引模式-1"><a href="#创建索引模式-1" class="headerlink" title="创建索引模式"></a>创建索引模式</h6><blockquote>
<p>下面我们需要创建索引模式，因为当前的索引是一天一创建的，我们需要匹配所有的索引</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch177.png" alt="image-20220914173054877"></p>
<blockquote>
<p>进入创建索引模式后，接下来就是创建索引匹配模式，我们需要匹配的就是标红的索引</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch178.png" alt="image-20220914173619881"></p>
<blockquote>
<p>接下来就是创建索引模式，我们使用通配符的方式来进行创建</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch179.png" alt="image-20220914173730107"></p>
<blockquote>
<p>确定后我们就创建了一个索引模式，在这里我们可以编辑或者转换ES的字段</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch180.png" alt="image-20220914173816084"></p>
<h5 id="查看索引数据"><a href="#查看索引数据" class="headerlink" title="查看索引数据"></a>查看索引数据</h5><blockquote>
<p>我们点击<code>Discover</code>就可以查看索引数据</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch181.png" alt="image-20220914174026892"></p>
<blockquote>
<p>如果看不到可以选择不同的时间范围</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch182.png" alt="image-20220914174306239"></p>
<h4 id="数据分析"><a href="#数据分析" class="headerlink" title="数据分析"></a>数据分析</h4><blockquote>
<p>接下来我们就按照这些数据进行一些图表分析</p>
</blockquote>
<h5 id="柱状图示例"><a href="#柱状图示例" class="headerlink" title="柱状图示例"></a>柱状图示例</h5><blockquote>
<p>下面我们演示以下柱状图，我们统计以下按照省份统计下个省份的总住户数量</p>
</blockquote>
<h6 id="打开仪表盘"><a href="#打开仪表盘" class="headerlink" title="打开仪表盘"></a>打开仪表盘</h6><blockquote>
<p>下面我们需要到点击进入仪表盘管理节点</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch183.png" alt="image-20220914180311426"></p>
<blockquote>
<p>点击创建仪表盘</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch184.png" alt="image-20220914180526655"></p>
<blockquote>
<p>点击创建仪表盘，进入仪表盘管理界面</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch185.png" alt="image-20220914181154882"></p>
<h6 id="创建柱状图"><a href="#创建柱状图" class="headerlink" title="创建柱状图"></a>创建柱状图</h6><blockquote>
<p>点击<code>创建可视化</code>我们就会打开一个可视化的管理界面</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch186.png" alt="image-20220914181604577"></p>
<blockquote>
<p>并且在这个管理界面选择对应的图形就好</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch187.png" alt="image-20220914181711915"></p>
<h6 id="水平轴数据配置"><a href="#水平轴数据配置" class="headerlink" title="水平轴数据配置"></a>水平轴数据配置</h6><blockquote>
<p>我们先配置水平轴的数据，选择<code>省份</code>字段作为水平轴的参数</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch188.png" alt="image-20220914182058921"></p>
<h6 id="垂直轴数据配置"><a href="#垂直轴数据配置" class="headerlink" title="垂直轴数据配置"></a>垂直轴数据配置</h6><blockquote>
<p>下面我们还需要配置垂直轴的数据，我们设置<code>总户数</code>的平均值作为参数</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch189.png" alt="image-20220914182345699"></p>
<h6 id="查看数据"><a href="#查看数据" class="headerlink" title="查看数据"></a>查看数据</h6><blockquote>
<p>这样我们就可以进行分析数据了，我们看到安徽省是小区住户平均数量最多的省份</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch190.png" alt="image-20220914184329732"></p>
<h6 id="筛选数据"><a href="#筛选数据" class="headerlink" title="筛选数据"></a>筛选数据</h6><blockquote>
<p>我们筛选以下2020年以后新建的小区住户平均数量最多的省份，我们可以使用表达式<code>built_year &gt;= 2020</code>进行筛选</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch191.png" alt="image-20220914184642614"></p>
<h5 id="折线图示例"><a href="#折线图示例" class="headerlink" title="折线图示例"></a>折线图示例</h5><blockquote>
<p>我们分析下全国每年小区新建面试的走势图</p>
</blockquote>
<h6 id="创建折线图"><a href="#创建折线图" class="headerlink" title="创建折线图"></a>创建折线图</h6><blockquote>
<p>点击<code>创建可视化</code>我们创建一个折线图</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch192.png" alt="image-20220914184921414"></p>
<h6 id="水平轴数据配置-1"><a href="#水平轴数据配置-1" class="headerlink" title="水平轴数据配置"></a>水平轴数据配置</h6><blockquote>
<p>我们在水平轴配置小区新建的年份，并选择时间间隔</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch193.png" alt="image-20220915102155168"></p>
<h6 id="垂直轴数据配置-1"><a href="#垂直轴数据配置-1" class="headerlink" title="垂直轴数据配置"></a>垂直轴数据配置</h6><blockquote>
<p>我们在垂直轴配置小区新建面积的总和</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch194.png" alt="image-20220914185251581"></p>
<h6 id="数据分析-1"><a href="#数据分析-1" class="headerlink" title="数据分析"></a>数据分析</h6><blockquote>
<p>我们分析出来数据后可以发现2006年是小区新建面积的高峰期，2006年后就开始慢慢回落了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch195.png" alt="image-20220915102412759"></p>
<h5 id="树状图示例"><a href="#树状图示例" class="headerlink" title="树状图示例"></a>树状图示例</h5><blockquote>
<p>我们狂野配置一个按照省份的绿化率按照树状图进行展示</p>
</blockquote>
<h6 id="创建树状图"><a href="#创建树状图" class="headerlink" title="创建树状图"></a>创建树状图</h6><blockquote>
<p>我们创建一个树状图</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch196.png" alt="image-20220915112937209"></p>
<h6 id="配置分组依据"><a href="#配置分组依据" class="headerlink" title="配置分组依据"></a>配置分组依据</h6><blockquote>
<p>我们可以配置一个分组依据，我们按照省份作为一个外部分组依据</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch197.png" alt="image-20220915113555009"></p>
<blockquote>
<p>接下来我们再按照市级来作为下级的分组依据</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch198.png" alt="image-20220915113717864"></p>
<h6 id="配置大小依据"><a href="#配置大小依据" class="headerlink" title="配置大小依据"></a>配置大小依据</h6><blockquote>
<p>我们按照绿化率的平均值作为大小依据</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch199.png" alt="image-20220915113822513"></p>
<h5 id="创建地图示例"><a href="#创建地图示例" class="headerlink" title="创建地图示例"></a>创建地图示例</h5><blockquote>
<p>我们还可以使用GEO信息创建一个地图</p>
</blockquote>
<h6 id="创建一个地图"><a href="#创建一个地图" class="headerlink" title="创建一个地图"></a>创建一个地图</h6><blockquote>
<p>我们先创建一个地图，选择Maps来创建一个地图</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch200.png" alt="image-20220915135301983"></p>
<h6 id="添加图层"><a href="#添加图层" class="headerlink" title="添加图层"></a>添加图层</h6><blockquote>
<p>在地图上面添加一个图层</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch201.png" alt="image-20220915140656728"></p>
<h6 id="选择文档数据"><a href="#选择文档数据" class="headerlink" title="选择文档数据"></a>选择文档数据</h6><blockquote>
<p>添加图层后选择需要添加的文档数据</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch202.png" alt="image-20220915140745555"></p>
<blockquote>
<p>并且在在弹出的界面选择需要显示索引以及GEO字段</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch203.png" alt="image-20220915140854603"></p>
<h6 id="缩放显示数据"><a href="#缩放显示数据" class="headerlink" title="缩放显示数据"></a>缩放显示数据</h6><blockquote>
<p>然后缩放地图可以看到就可以看到地图数据了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch204.png" alt="elasticsearch204"></p>
<h2 id="ElasticSearch-索引设计"><a href="#ElasticSearch-索引设计" class="headerlink" title="ElasticSearch 索引设计"></a>ElasticSearch 索引设计</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch001.png" alt="img"></p>
<blockquote>
<p>在MySQL中数据库设计非常重要，同样在ES中数据库设计也是非常重要的</p>
</blockquote>
<h3 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h3><blockquote>
<p>我们创建索引就像创建表结构一样，必须非常慎重的，索引如果创建不好后面会出现各种各样的问题</p>
</blockquote>
<h4 id="索引设计的重要性"><a href="#索引设计的重要性" class="headerlink" title="索引设计的重要性"></a>索引设计的重要性</h4><blockquote>
<p>索引创建后，索引的分片只能通过<code>_split</code>和<code>_shrink</code>接口对其进行成倍的增加和缩减</p>
</blockquote>
<p> 主要是因为es的数据是通过<code>_routing</code>分配到各个分片上面的，所以本质上是不推荐去改变索引的分片数量的，因为这样都会对数据进行重新的移动。</p>
<p> 还有就是索引只能新增字段，不能对字段进行修改和删除，缺乏灵活性，所以每次都只能通过<code>_reindex</code>重建索引了，还有就是一个分片的大小以及所以分片数量的多少严重影响到了索引的查询和写入性能，所以可想而知，设计一个好的索引能够减少后期的运维管理和提高不少性能，所以前期对索引的设计是相当的重要的。</p>
<h4 id="基于时间的Index设计"><a href="#基于时间的Index设计" class="headerlink" title="基于时间的Index设计"></a>基于时间的Index设计</h4><blockquote>
<p>Index设计时要考虑的<strong>第一件事</strong>，就是<strong>基于时间对Index进行分割</strong>，即每隔一段时间产生一个新的Index</p>
</blockquote>
<h5 id="这样设计的目的"><a href="#这样设计的目的" class="headerlink" title="这样设计的目的"></a>这样设计的目的</h5><blockquote>
<p>因为现实世界的数据是随着时间的变化而不断产生的，切分管理可以获得足够的灵活性和更好的性能</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch027.png" alt="img"></p>
<p> 如果数据都存储在一个Index中，很难进行扩展和调整，因为Elasticsearch中Index的某些设置在创建时就设定好了，是不能更改的，比如Primary Shard的个数。</p>
<p> 而根据时间来切分Index，则可以实现一定的灵活性，既可以在数据量过大时及时调整Shard个数，也可以及时响应新的业务需求。</p>
<p> 大多数业务场景下，客户对数据的请求都会命中在最近一段时间上，通过切分Index，可以尽可能的避免扫描不必要的数据，提高性能。</p>
<h5 id="时间间隔"><a href="#时间间隔" class="headerlink" title="时间间隔"></a>时间间隔</h5><blockquote>
<p>根据上面的分析，自然是时间越短越能保持灵活性，但是这样做就会导致产生大量的Index，而每个Index都会消耗资源来维护其元信息的，因此需要在灵活性、资源和性能上做权衡</p>
</blockquote>
<ul>
<li>常见的间隔有小时、天、周和月：先考虑总共要存储多久的数据，然后选一个既不会产生大量Index又能够满足一定灵活性的间隔，比如你需要存储6个月的数据，那么一开始选择“周”这个间隔就会比较合适。</li>
<li>考虑业务增长速度：假如业务增长的特别快，比如上周产生了1亿数据，这周就增长到了10亿，那么就需要调低这个间隔来保证有足够的弹性能应对变化。</li>
</ul>
<h5 id="如何实现分割"><a href="#如何实现分割" class="headerlink" title="如何实现分割"></a>如何实现分割</h5><blockquote>
<p>切分行为是由客户端（数据的写入端）发起的，根据时间间隔与数据产生时间将数据写入不同的Index中，为了易于区分，会在Index的名字中加上对应的时间标识</p>
</blockquote>
<p> 创建新Index这件事，可以是客户端主动发起一个创建的请求，带上具体的Settings、Mappings等信息，但是可能会有一个时间错位，即有新数据写入时新的Index还没有建好，Elasticsearch提供了更优雅的方式来实现这个动作，即<code>Index Template</code></p>
<h4 id="分片设计"><a href="#分片设计" class="headerlink" title="分片设计"></a>分片设计</h4><blockquote>
<p>所谓分片设计，就是<strong>如何设定主分片的个数</strong></p>
</blockquote>
<p> 看上去只是一个数字而已，也许在很多场景下，即使不设定也不会有问题（ES7默认是1个主分片一个副本分片），但是如果不提前考虑，一旦出问题就可能导致系统性能下降、不可访问、甚至无法恢复，换句话说，即使使用默认值，也应该是通过足够的评估后作出的决定，而非拍脑袋定的。</p>
<h5 id="限制分片大小"><a href="#限制分片大小" class="headerlink" title="限制分片大小"></a>限制分片大小</h5><blockquote>
<p>单个Shard的存储大小不超过30GB</p>
</blockquote>
<p> Elastic专家根据经验总结出来大家普遍认为30GB是个合适的上限值，实践中发现单个Shard过大（超过30GB）会导致系统不稳定。</p>
<p> 其次，为什么不能超过30GB？主要是考虑Shard Relocate过程的负载，我们知道，如果Shard不均衡或者部分节点故障，Elasticsearch会做Shard Relocate，在这个过程中会搬移Shard，如果单个Shard过大，会导致CPU、IO负载过高进而影响系统性能与稳定性。</p>
<h5 id="评估分片数量"><a href="#评估分片数量" class="headerlink" title="评估分片数量"></a>评估分片数量</h5><blockquote>
<p>单个Index的<code>Primary Shard个数 = k * 数据节点个数</code></p>
</blockquote>
<p> 在保证第一点的前提下，单个Index的Primary Shard个数不宜过多，否则相关的元信息与缓存会消耗过多的系统资源，这里的k，为一个较小的整数值，建议取值为1,2等，整数倍的关系可以让Shard更好地均匀分布，可以充分的将请求分散到不同节点上。</p>
<h5 id="小索引设计"><a href="#小索引设计" class="headerlink" title="小索引设计"></a>小索引设计</h5><blockquote>
<p>对于很小的Index，可以只分配1~2个Primary Shard的</p>
</blockquote>
<p> 有些情况下，Index很小，也许只有几十、几百MB左右，那么就不用按照第二点来分配了，只分配1~2个Primary Shard是可以，不用纠结。</p>
<h4 id="使用索引模板"><a href="#使用索引模板" class="headerlink" title="使用索引模板"></a>使用索引模板</h4><blockquote>
<p>就是把已经创建好的某个索引的参数设置(settings)和索引映射(mapping)保存下来作为模板，在创建新索引时，指定要使用的模板名，就可以直接重用已经定义好的模板中的设置和映射</p>
</blockquote>
<p> Elasticsearch基于与索引名称匹配的通配符模式将模板应用于新索引，也就是说通过索引进行匹配，看看新建的索引是否符合索引模板，如果符合，就将索引模板的相关设置应用到新的索引，如果同时符合多个索引模板呢，这里需要对参数priority进行比较，这样会选择priority大的那个模板进行创建索引。</p>
<p> 在创建索引模板时，如果匹配有包含的关系，或者相同，则必须设置priority为不同的值，否则会报错，索引模板也是只有在新创建的时候起到作用，修改索引模板对现有的索引没有影响，同样如果在索引中设置了一些设置或者mapping都会覆盖索引模板中相同的设置或者mapping</p>
<h5 id="索引模板的用途"><a href="#索引模板的用途" class="headerlink" title="索引模板的用途"></a>索引模板的用途</h5><blockquote>
<p>索引模板一般用在时间序列相关的索引中。</p>
</blockquote>
<p> 也就是说, 如果你需要每间隔一定的时间就建立一次索引，你只需要配置好索引模板，以后就可以直接使用这个模板中的设置，不用每次都设置settings和mappings.</p>
<h5 id="创建索引模板-1"><a href="#创建索引模板-1" class="headerlink" title="创建索引模板"></a>创建索引模板</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT _index_template/logstash-village</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;index_patterns&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;logstash-village-*&quot;</span>  // 可以通过<span class="string">&quot;logstash-village-*&quot;</span>来适配创建的索引</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;template&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;number_of_shards&quot;</span>: <span class="string">&quot;3&quot;</span>, //指定模板分片数量</span><br><span class="line">      <span class="string">&quot;number_of_replicas&quot;</span>: <span class="string">&quot;2&quot;</span>  //指定模板副本数量</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;aliases&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;logstash-village&quot;</span>: &#123;&#125;  //指定模板索引别名</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span>: &#123;   //设置映射</span><br><span class="line">      <span class="string">&quot;dynamic&quot;</span>: <span class="string">&quot;strict&quot;</span>, //禁用动态映射</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@timestamp&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">           <span class="string">&quot;format&quot;</span>: <span class="string">&quot;strict_date_optional_time||epoch_millis||yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;@version&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;doc_values&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="string">&quot;index&quot;</span>: <span class="string">&quot;false&quot;</span>,</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;province&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;city&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;area&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;addr&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;geo_point&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;property_type&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;property_company&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;property_cost&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;float&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;floorage&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;float&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;houses&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;built_year&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;parkings&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;volume&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;float&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;greening&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;float&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;producer&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;school&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;info&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="模板参数"><a href="#模板参数" class="headerlink" title="模板参数"></a>模板参数</h5><blockquote>
<p>下面是创建索引模板的一些参数</p>
</blockquote>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>参数介绍</th>
</tr>
</thead>
<tbody><tr>
<td>index_patterns</td>
<td>必须配置，用于在创建期间匹配索引名称的通配符（*）表达式数组</td>
</tr>
<tr>
<td>template</td>
<td>可选配置，可以选择包括别名、映射或设置配置</td>
</tr>
<tr>
<td>composed_of</td>
<td>可选配置，组件模板名称的有序列表。组件模板按指定的顺序合并，这意味着最后指定的组件模板具有最高的优先级</td>
</tr>
<tr>
<td>priority</td>
<td>可选配置，创建新索引时确定索引模板优先级的优先级。选择具有最高优先级的索引模板。如果未指定优先级，则将模板视为优先级为0（最低优先级）</td>
</tr>
<tr>
<td>version</td>
<td>可选配置，用于外部管理索引模板的版本号</td>
</tr>
<tr>
<td>_meta</td>
<td>可选配置，关于索引模板的可选用户元数据，可能有任何内容</td>
</tr>
</tbody></table>
<h3 id="映射配置"><a href="#映射配置" class="headerlink" title="映射配置"></a>映射配置</h3><blockquote>
<p>上面我们配置了映射模板，但是我们用到了映射，下面我们说下映射</p>
</blockquote>
<h4 id="什么是映射"><a href="#什么是映射" class="headerlink" title="什么是映射"></a>什么是映射</h4><blockquote>
<p>在创建索引时，可以预先定义字段的类型（映射类型）及相关属性</p>
</blockquote>
<p> 数据库建表的时候，我们DDL依据一般都会指定每个字段的存储类型，例如：varchar、int、datetime等，目的很明确，就是更精确的存储数据，防止数据类型格式混乱，在Elasticsearch中也是这样，创建索引的时候一般也需要指定索引的字段类型，这种方式称为映射（Mapping）</p>
<h4 id="被动创建（动态映射）"><a href="#被动创建（动态映射）" class="headerlink" title="被动创建（动态映射）"></a>被动创建（动态映射）</h4><blockquote>
<p>此时字段和映射类型不需要事先定义，只需要存在文档的索引，当向此索引添加数据的时候当遇到不存在的映射字段，ES会根据数据内容自动添加映射字段定义。</p>
</blockquote>
<h5 id="动态映射规则"><a href="#动态映射规则" class="headerlink" title="动态映射规则"></a>动态映射规则</h5><blockquote>
<p>使用动态映射的时候，根据传递请求数据的不同会创建对应的数据类型</p>
</blockquote>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>Elasticsearch 数据类型</th>
</tr>
</thead>
<tbody><tr>
<td>null</td>
<td>不添加任何字段</td>
</tr>
<tr>
<td>true或者false</td>
<td>boolean类型</td>
</tr>
<tr>
<td>浮点数据</td>
<td>float类型</td>
</tr>
<tr>
<td>integer数据</td>
<td>long类型</td>
</tr>
<tr>
<td>object</td>
<td>object类型</td>
</tr>
<tr>
<td>array</td>
<td>取决于数组中的第一个非空值的类型。</td>
</tr>
<tr>
<td>string</td>
<td>如果此内容通过了日期格式检测，则会被认为是date数据类型 如果此值通过了数值类型检测则被认为是double或者long数据类型 带有关键字子字段会被认为一个text字段</td>
</tr>
</tbody></table>
<h5 id="禁止动态映射"><a href="#禁止动态映射" class="headerlink" title="禁止动态映射"></a>禁止动态映射</h5><blockquote>
<p>一般生产环境下需要禁用动态映射，使用动态映射可能出现以下问题</p>
</blockquote>
<ol>
<li>造成集群元数据一直变更，导致不稳定；</li>
<li>可能造成数据类型与实际类型不一致；</li>
</ol>
<blockquote>
<p>如何禁用动态映射，动态<code>mapping</code>的<code>dynamic</code>字段进行配置，可选值及含义如下</p>
</blockquote>
<ul>
<li>true：支持动态扩展，新增数据有新的字段属性时，自动添加对于的mapping，数据写入成功</li>
<li>false：不支持动态扩展，新增数据有新的字段属性时，直接忽略，数据写入成功</li>
<li>strict：不支持动态扩展，新增数据有新的字段时，报错，数据写入失败</li>
</ul>
<h4 id="主动创建（显示映射）"><a href="#主动创建（显示映射）" class="headerlink" title="主动创建（显示映射）"></a>主动创建（显示映射）</h4><blockquote>
<p>动态映射只能保证最基础的数据结构的映射</p>
</blockquote>
<p> 所以很多时候我们需要对字段除了数据结构定义更多的限制的时候，动态映射创建的内容很可能不符合我们的需求，所以可以使用<code>PUT &#123;index&#125;/mapping</code>来更新指定索引的映射内容。</p>
<h3 id="映射类型"><a href="#映射类型" class="headerlink" title="映射类型"></a>映射类型</h3><blockquote>
<p>我们要创建映射必须还要知道映射类型，否则就会走默认的映射类型，下面我们看看常用的映射类型</p>
</blockquote>
<h4 id="准备工作-3"><a href="#准备工作-3" class="headerlink" title="准备工作"></a>准备工作</h4><blockquote>
<p>我们先创建一个用于测试映射类型的索引</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT mapping_demo</span><br></pre></td></tr></table></figure>

<h4 id="字符串类型"><a href="#字符串类型" class="headerlink" title="字符串类型"></a>字符串类型</h4><blockquote>
<p>字符串类型是我们最常用的类型之一，我们操作的时候字符串类型可以被设置为以下几种类型</p>
</blockquote>
<h5 id="text"><a href="#text" class="headerlink" title="text"></a>text</h5><blockquote>
<p>当一个字段是要被全文搜索的，比如Email内容、产品描述，应该使用text类型，text类型会被分词</p>
</blockquote>
<p> 设置text类型以后，字段内容会被分词，在生成倒排索引以前，字符串会被分析器分成一个一个词项，text类型的字段<strong>不用于排序，很少用于聚合</strong></p>
<h5 id="keyword"><a href="#keyword" class="headerlink" title="keyword"></a>keyword</h5><blockquote>
<p>keyword类型不会被分词，常用于关键字搜索，比如姓名、email地址、主机名、状态码和标签等</p>
</blockquote>
<p> 如果字段需要进行过滤(比如查姓名是张三发布的博客)、排序、聚合，<strong>keyword类型的字段只能通过精确值搜索到</strong>，常常被用来过滤、排序和聚合</p>
<h5 id="两者区别"><a href="#两者区别" class="headerlink" title="两者区别"></a>两者区别</h5><blockquote>
<p>它们的区别在于<code>text</code>会对字段进行分词处理而<code>keyword</code>则不会进行分词</p>
</blockquote>
<p> 也就是说如果字段是<code>text</code>类型，存入的数据会先进行分词，然后将分完词的词组存入索引，而<code>keyword</code>则不会进行分词，直接存储，这样划分数据更加节省内存。</p>
<h5 id="使用案例-4"><a href="#使用案例-4" class="headerlink" title="使用案例"></a>使用案例</h5><blockquote>
<p>我们先创建一个映射，name是keyword类型，描述是text类型的</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT mapping_demo/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">     &#125;,</span><br><span class="line">      <span class="string">&quot;city&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>插入数据</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT mapping_demo/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>:<span class="string">&quot;北京小区&quot;</span>,</span><br><span class="line">  <span class="string">&quot;city&quot;</span>:<span class="string">&quot;北京市昌平区回龙观街道&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于keyword的name字段进行精确查询</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET mapping_demo/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;北京小区&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于text的city进行模糊查询</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET mapping_demo/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;city&quot;</span>: <span class="string">&quot;北京市&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="数字类型"><a href="#数字类型" class="headerlink" title="数字类型"></a>数字类型</h4><blockquote>
<p>数字类型也是我们最常用的类型之一，下面我们看下数字类型的使用</p>
</blockquote>
<table>
<thead>
<tr>
<th>类型</th>
<th>取值范围</th>
</tr>
</thead>
<tbody><tr>
<td>long</td>
<td>-263 ~ 263</td>
</tr>
<tr>
<td>integer</td>
<td>-231 ~ 231</td>
</tr>
<tr>
<td>short</td>
<td>-215 ~ 215</td>
</tr>
<tr>
<td>byte</td>
<td>-27 ~ 27</td>
</tr>
<tr>
<td>double</td>
<td>64位的双精度 IEEE754 浮点类型</td>
</tr>
<tr>
<td>float</td>
<td>32位的双精度 IEEE754 浮点类型</td>
</tr>
<tr>
<td>half_float</td>
<td>16位的双精度 IEEE754 浮点类型</td>
</tr>
<tr>
<td>scaled_float</td>
<td>缩放类型的浮点类型</td>
</tr>
</tbody></table>
<h5 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h5><ul>
<li>在满足需求的情况下，优先使用范围小的字段，字段长度越小，索引和搜索的效率越高。</li>
</ul>
<h4 id="日期类型"><a href="#日期类型" class="headerlink" title="日期类型"></a>日期类型</h4><h5 id="JSON表示日期"><a href="#JSON表示日期" class="headerlink" title="JSON表示日期"></a>JSON表示日期</h5><blockquote>
<p>JSON没有表达日期的数据类型，所以在ES里面日期只能是下面其中之一</p>
</blockquote>
<ul>
<li>格式化的日期字符串，比如：<code>&quot;2015-01-01&quot;</code> or <code>&quot;2015/01/01 12:10:30&quot;</code></li>
<li>用数字表示的从新纪元开始的毫秒数</li>
<li>用数字表示的从新纪元开始的秒数（epoch_second）</li>
</ul>
<blockquote>
<p>注意点：毫秒数的值是不能为负数的，如果时间在1970年以前，需要使用格式化的日期表达</p>
</blockquote>
<h5 id="ES如何处理日期"><a href="#ES如何处理日期" class="headerlink" title="ES如何处理日期"></a>ES如何处理日期</h5><p> 在ES的内部，时间会被转换为UTC时间（如果声明了时区）并使用<code>从新纪元开始的毫秒数的</code>长整形数字类型的进行存储，在日期字段上的查询，内部将会转换为使用长整形的毫秒进行范围查询，根据与字段关联的日期格式，聚合和存储字段的结果将转换回字符串</p>
<blockquote>
<p>注意点：日期最终都会作为字符串呈现，即使最开始初始化的时候是利用JSON文档的long声明的</p>
</blockquote>
<h5 id="默认日期格式"><a href="#默认日期格式" class="headerlink" title="默认日期格式"></a>默认日期格式</h5><blockquote>
<p>日期的格式可以被定制化的，如果没有声明日期的格式，它将会使用默认的格式：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;strict_date_optional_time||epoch_millis&quot;</span></span><br></pre></td></tr></table></figure>

<p> 这意味着它将会接收带时间戳的日期，它将遵守strict_date_optional_time限定的格式（<code>yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSZ</code> 或者 <code>yyyy-MM-dd</code>）或者毫秒数</p>
<h5 id="日期格式示例"><a href="#日期格式示例" class="headerlink" title="日期格式示例"></a>日期格式示例</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT mapping_demo/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;datetime&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">        <span class="string">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span></span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 添加数据</span></span><br><span class="line">PUT mapping_demo/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>:<span class="string">&quot;河北区&quot;</span>,</span><br><span class="line">  <span class="string">&quot;city&quot;</span>:<span class="string">&quot;河北省小区&quot;</span>,</span><br><span class="line">  <span class="string">&quot;datetime&quot;</span>:<span class="string">&quot;2022-02-21 11:35:42&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="日期类型参数"><a href="#日期类型参数" class="headerlink" title="日期类型参数"></a>日期类型参数</h5><blockquote>
<p>下面表格里的参数可以用在date字段上面</p>
</blockquote>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>doc_values</td>
<td>该字段是否按照列式存储在磁盘上以便于后续进行排序、聚合和脚本操作，可配置 true（默认）或 false</td>
</tr>
<tr>
<td>format</td>
<td>日期的格式</td>
</tr>
<tr>
<td>locale</td>
<td>解析日期中时使用了本地语言表示月份时的名称和/或缩写，默认是 ROOT locale</td>
</tr>
<tr>
<td>ignore_malformed</td>
<td>如果设置为true，则奇怪的数字就会被忽略，如果是false（默认）奇怪的数字就会导致异常并且该文档将会被拒绝写入。需要注意的是，如果在脚本参数中使用则该属性不能被设置</td>
</tr>
<tr>
<td>index</td>
<td>该字段是否能快速的被查询，默认是true。date类型的字段只有在doc_values设置为true时才能被查询，尽管很慢。</td>
</tr>
<tr>
<td>null_value</td>
<td>替代null的值，默认是null</td>
</tr>
<tr>
<td>on_script_error</td>
<td>定义在脚本中如何处理抛出的异常，fail（默认）则整个文档会被拒绝索引，continue：继续索引</td>
</tr>
<tr>
<td>script</td>
<td>如果该字段被设置，则字段的值将会使用该脚本产生，而不是直接从source里面读取。</td>
</tr>
<tr>
<td>store</td>
<td>true or false(默认)是否在 _source 之外在独立存储一份</td>
</tr>
</tbody></table>
<h4 id="布尔类型"><a href="#布尔类型" class="headerlink" title="布尔类型"></a>布尔类型</h4><blockquote>
<p>boolean类型用于存储文档中的true/false</p>
</blockquote>
<h4 id="范围类型"><a href="#范围类型" class="headerlink" title="范围类型"></a>范围类型</h4><blockquote>
<p>顾名思义，范围类型字段中存储的内容就是一段范围，例如年龄30-55岁，日期在2020-12-28到2021-01-01之间等</p>
</blockquote>
<h5 id="类型范围"><a href="#类型范围" class="headerlink" title="类型范围"></a>类型范围</h5><blockquote>
<p>es中有六种范围类型：</p>
</blockquote>
<ul>
<li>integer_range</li>
<li>float_range</li>
<li>long_range</li>
<li>double_range</li>
<li>date_range</li>
<li>ip_range</li>
</ul>
<h5 id="使用实例"><a href="#使用实例" class="headerlink" title="使用实例"></a>使用实例</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT mapping_demo/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;age_range&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer_range&quot;</span></span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定年龄范围，可以使用 gt、gte、lt、lte。</span></span><br><span class="line">PUT mapping_demo/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>:<span class="string">&quot;张三&quot;</span>,</span><br><span class="line">  <span class="string">&quot;age_range&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;gt&quot;</span>:20,</span><br><span class="line">    <span class="string">&quot;lt&quot;</span>:30</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="分词器"><a href="#分词器" class="headerlink" title="分词器"></a>分词器</h3><h4 id="什么是分词器"><a href="#什么是分词器" class="headerlink" title="什么是分词器"></a>什么是分词器</h4><blockquote>
<p>分词器的主要作用将用户输入的一段文本，按照一定逻辑，分析成多个词语的一种工具</p>
</blockquote>
<p> 顾名思义，文本分析就是<strong>把全文本转换成一系列单词（term/token）的过程</strong>，也叫<strong>分词</strong>，在 ES 中，Analysis 是通过<strong>分词器（Analyzer）</strong> 来实现的，可使用 ES 内置的分析器或者按需定制化分析器。</p>
<p> 举一个分词简单的例子：比如你输入 <code>Mastering Elasticsearch</code>，会自动帮你分成两个单词，一个是 <code>mastering</code>，另一个是 <code>elasticsearch</code>，可以看出单词也被转化成了小写的。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch028.png" alt="图片"></p>
<h4 id="分词器构成"><a href="#分词器构成" class="headerlink" title="分词器构成"></a>分词器构成</h4><blockquote>
<p>分词器是专门处理分词的组件，分词器由以下三部分组成：</p>
</blockquote>
<h5 id="character-filter"><a href="#character-filter" class="headerlink" title="character filter"></a>character filter</h5><blockquote>
<p>接收原字符流，通过添加、删除或者替换操作改变原字符流</p>
</blockquote>
<p> 例如：去除文本中的html标签，或者将罗马数字转换成阿拉伯数字等，一个字符过滤器可以有<code>零个或者多个</code></p>
<h5 id="tokenizer"><a href="#tokenizer" class="headerlink" title="tokenizer"></a>tokenizer</h5><blockquote>
<p>简单的说就是将一整段文本拆分成一个个的词</p>
</blockquote>
<p> 例如拆分英文，通过空格能将句子拆分成一个个的词，但是对于中文来说，无法使用这种方式来实现，在一个分词器中，<code>有且只有一个</code>tokenizeer</p>
<h5 id="token-filters"><a href="#token-filters" class="headerlink" title="token filters"></a>token filters</h5><blockquote>
<p>将切分的单词添加、删除或者改变</p>
</blockquote>
<p> 例如将所有英文单词小写，或者将英文中的停词<code>a</code>删除等，在<code>token filters</code>中，不允许将<code>token(分出的词)</code>的<code>position</code>或者<code>offset</code>改变，同时，在一个分词器中，可以有零个或者多个<code>token filters</code>。</p>
<h4 id="分词顺序"><a href="#分词顺序" class="headerlink" title="分词顺序"></a>分词顺序</h4><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch029.png" alt="图片"></p>
<p> 同时 Analyzer 三个部分也是有顺序的，从图中可以看出，从上到下依次经过 <code>Character Filters</code>，<code>Tokenizer</code> 以及 <code>Token Filters</code>，这个顺序比较好理解，一个文本进来肯定要先对文本数据进行处理，再去分词，最后对分词的结果进行过滤。</p>
<h4 id="测试分词-4"><a href="#测试分词-4" class="headerlink" title="测试分词"></a>测试分词</h4><blockquote>
<p>可以通过<code>_analyzer</code>API来测试分词的效果，我们使用下面的html过滤分词</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;text&quot;</span>:<span class="string">&quot;&lt;b&gt;hello world&lt;b&gt;&quot;</span>  <span class="comment"># 输入的文本</span></span><br><span class="line">    <span class="string">&quot;char_filter&quot;</span>:[<span class="string">&quot;html_strip&quot;</span>], <span class="comment"># 过滤html标签</span></span><br><span class="line">	<span class="string">&quot;tokenizer&quot;</span>:<span class="string">&quot;keyword&quot;</span>, <span class="comment">#原样输出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch030.png" alt="image-20220808135231869"></p>
<h4 id="什么时候分词"><a href="#什么时候分词" class="headerlink" title="什么时候分词"></a>什么时候分词</h4><blockquote>
<p>文本分词会发生在两个地方：</p>
</blockquote>
<ul>
<li><code>创建索引</code>：当索引文档字符类型为<code>text</code>时，在建立索引时将会对该字段进行分词。</li>
<li><code>搜索</code>：当对一个<code>text</code>类型的字段进行全文检索时，会对用户输入的文本进行分词。</li>
</ul>
<h4 id="创建索引时指定分词器"><a href="#创建索引时指定分词器" class="headerlink" title="创建索引时指定分词器"></a>创建索引时指定分词器</h4><blockquote>
<p>如果设置手动设置了分词器，ES将按照下面顺序来确定使用哪个分词器</p>
</blockquote>
<ul>
<li>先判断字段是否有设置分词器，如果有，则使用字段属性上的分词器设置</li>
<li>如果设置了<code>analysis.analyzer.default</code>，则使用该设置的分词器</li>
<li>如果上面两个都未设置，则使用默认的<code>standard</code>分词器</li>
</ul>
<h5 id="字段指定分词器"><a href="#字段指定分词器" class="headerlink" title="字段指定分词器"></a>字段指定分词器</h5><blockquote>
<p>为addr属性指定分词器，这里我们使用的是中文分词器</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">     <span class="string">&quot;info&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="设置默认分词器"><a href="#设置默认分词器" class="headerlink" title="设置默认分词器"></a>设置默认分词器</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;analyzer&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;default&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>:<span class="string">&quot;simple&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="搜索时指定分词器"><a href="#搜索时指定分词器" class="headerlink" title="搜索时指定分词器"></a>搜索时指定分词器</h4><blockquote>
<p>在搜索时，通过下面参数依次检查搜索时使用的分词器，这样我们的搜索语句就会先分词，然后再来进行搜索</p>
</blockquote>
<ul>
<li>搜索时指定<code>analyzer</code>参数</li>
<li>创建mapping时指定字段的<code>search_analyzer</code>属性</li>
<li>创建索引时指定<code>setting</code>的<code>analysis.analyzer.default_search</code></li>
<li>查看创建索引时字段指定的<code>analyzer</code>属性</li>
<li>如果上面几种都未设置，则使用默认的<code>standard</code>分词器。</li>
</ul>
<h5 id="指定analyzer"><a href="#指定analyzer" class="headerlink" title="指定analyzer"></a>指定analyzer</h5><blockquote>
<p>搜索时指定analyzer查询参数</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;message&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;Quick foxes&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;stop&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="指定字段analyzer"><a href="#指定字段analyzer" class="headerlink" title="指定字段analyzer"></a>指定字段analyzer</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>:<span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;whitespace&quot;</span>,</span><br><span class="line">        <span class="string">&quot;search_analyzer&quot;</span>: <span class="string">&quot;simple&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="指定默认default-seach"><a href="#指定默认default-seach" class="headerlink" title="指定默认default_seach"></a>指定默认default_seach</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;analyzer&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;default&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>:<span class="string">&quot;simple&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;default_seach&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>:<span class="string">&quot;whitespace&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="内置分词器"><a href="#内置分词器" class="headerlink" title="内置分词器"></a>内置分词器</h4><blockquote>
<p>es在索引文档时，会通过各种类型 <code>Analyzer</code> 对text类型字段做分析</p>
</blockquote>
<p> 不同的 <code>Analyzer</code> 会有不同的分词结果，内置的分词器有以下几种，基本上内置的 <code>Analyzer</code> 包括 <code>Language Analyzers</code> 在内，对中文的分词都不够友好，中文分词需要安装其它 <code>Analyzer</code></p>
<table>
<thead>
<tr>
<th>分析器</th>
<th>描述</th>
<th>分词对象</th>
<th>结果</th>
</tr>
</thead>
<tbody><tr>
<td>standard</td>
<td>标准分析器是默认的分析器，如果没有指定，则使用该分析器。它提供了基于文法的标记化(基于 Unicode 文本分割算法，如 Unicode 标准附件 # 29所规定) ，并且对大多数语言都有效。</td>
<td>The 2 QUICK Brown-Foxes jumped over the lazy dog’s bone.</td>
<td>[ the, 2, quick, brown, foxes, jumped, over, the, lazy, dog’s, bone ]</td>
</tr>
<tr>
<td>simple</td>
<td>简单分析器将文本分解为任何非字母字符的标记，如数字、空格、连字符和撇号、放弃非字母字符，并将大写字母更改为小写字母。</td>
<td>The 2 QUICK Brown-Foxes jumped over the lazy dog’s bone.</td>
<td>[ the, quick, brown, foxes, jumped, over, the, lazy, dog, s, bone ]</td>
</tr>
<tr>
<td>whitespace</td>
<td>空格分析器在遇到空白字符时将文本分解为术语</td>
<td>The 2 QUICK Brown-Foxes jumped over the lazy dog’s bone.</td>
<td>[ The, 2, QUICK, Brown-Foxes, jumped, over, the, lazy, dog’s, bone. ]</td>
</tr>
<tr>
<td>stop</td>
<td>停止分析器与简单分析器相同，但增加了删除停止字的支持。默认使用的是 <code>_english_</code> 停止词。</td>
<td>The 2 QUICK Brown-Foxes jumped over the lazy dog’s bone.</td>
<td>[ quick, brown, foxes, jumped, over, lazy, dog, s, bone ]</td>
</tr>
<tr>
<td>keyword</td>
<td>不分词，把整个字段当做一个整体返回</td>
<td>The 2 QUICK Brown-Foxes jumped over the lazy dog’s bone.</td>
<td>[The 2 QUICK Brown-Foxes jumped over the lazy dog’s bone.]</td>
</tr>
<tr>
<td>pattern</td>
<td>模式分析器使用正则表达式将文本拆分为术语。正则表达式应该匹配令牌分隔符，而不是令牌本身。正则表达式默认为 <code>w+</code> (或所有非单词字符)。</td>
<td>The 2 QUICK Brown-Foxes jumped over the lazy dog’s bone.</td>
<td>[ the, 2, quick, brown, foxes, jumped, over, the, lazy, dog, s, bone ]</td>
</tr>
<tr>
<td>多种西语系 arabic, armenian, basque, bengali, brazilian, bulgarian, catalan, cjk, czech, danish, dutch, english等等</td>
<td>一组旨在分析特定语言文本的分析程序。</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="IK中文分词器"><a href="#IK中文分词器" class="headerlink" title="IK中文分词器"></a>IK中文分词器</h3><h4 id="IKAnalyzer-2"><a href="#IKAnalyzer-2" class="headerlink" title="IKAnalyzer"></a>IKAnalyzer</h4><blockquote>
<p>IKAnalyzer是一个开源的，基于java的语言开发的轻量级的中文分词工具包</p>
</blockquote>
<p> 从2006年12月推出1.0版开始，IKAnalyzer已经推出了3个大版本，在 2012 版本中，IK 实现了简单的分词歧义排除算法，标志着 IK 分词器从单纯的词典分词向模拟语义分词衍化</p>
<h4 id="中文分词器算法"><a href="#中文分词器算法" class="headerlink" title="中文分词器算法"></a>中文分词器算法</h4><blockquote>
<p>中文分词器最简单的是ik分词器，还有jieba分词，哈工大分词器等</p>
</blockquote>
<table>
<thead>
<tr>
<th>分词器</th>
<th>描述</th>
<th>分词对象</th>
<th>结果</th>
</tr>
</thead>
<tbody><tr>
<td>ik_smart</td>
<td>ik分词器中的简单分词器，支持自定义字典，远程字典</td>
<td>学如逆水行舟，不进则退</td>
<td>[学如逆水行舟,不进则退]</td>
</tr>
<tr>
<td>ik_max_word</td>
<td>ik_分词器的全量分词器，支持自定义字典，远程字典</td>
<td>学如逆水行舟，不进则退</td>
<td>[学如逆水行舟,学如逆水,逆水行舟,逆水,行舟,不进则退,不进,则,退]</td>
</tr>
</tbody></table>
<h4 id="ik-smart-2"><a href="#ik-smart-2" class="headerlink" title="ik_smart"></a>ik_smart</h4><h5 id="原始内容"><a href="#原始内容" class="headerlink" title="原始内容"></a>原始内容</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">传智教育的教学质量是杠杠的</span><br></pre></td></tr></table></figure>

<h5 id="测试分词-5"><a href="#测试分词-5" class="headerlink" title="测试分词"></a>测试分词</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;传智教育的教学质量是杠杠的&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch155.png" alt="image-20220808115450647"></p>
<h4 id="ik-max-word-2"><a href="#ik-max-word-2" class="headerlink" title="ik_max_word"></a>ik_max_word</h4><h5 id="原始内容-1"><a href="#原始内容-1" class="headerlink" title="原始内容"></a>原始内容</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">传智教育的教学质量是杠杠的</span><br></pre></td></tr></table></figure>

<h5 id="测试分词-6"><a href="#测试分词-6" class="headerlink" title="测试分词"></a>测试分词</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;传智教育的教学质量是杠杠的&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ElasticSearch-字段映射"><a href="#ElasticSearch-字段映射" class="headerlink" title="ElasticSearch 字段映射"></a>ElasticSearch 字段映射</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch001.png" alt="img"></p>
<h3 id="概述-4"><a href="#概述-4" class="headerlink" title="概述"></a>概述</h3><h4 id="什么是映射-1"><a href="#什么是映射-1" class="headerlink" title="什么是映射"></a>什么是映射</h4><blockquote>
<p>在创建索引时，可以预先定义字段的类型（映射类型，也就是type，一个索引可以有一个或多个类型）及相关属性</p>
</blockquote>
<p> 数据库建表的时候，我们DDL依据一般都会指定每个字段的存储类型，例如：varchar、int、datetime等，目的很明确，就是更精确的存储数据，防止数据类型格式混乱，在Elasticsearch中也是这样，创建爱你索引的时候一般也需要指定索引的字段类型，这种方式称为映射（Mapping）。</p>
<h5 id="映射的作用"><a href="#映射的作用" class="headerlink" title="映射的作用"></a>映射的作用</h5><blockquote>
<p>Elasticsearch会根据JSON源数据的基础类型猜测你想要的字段映射，将输入的数据转变成可搜索的索引项</p>
</blockquote>
<p> Mapping就是我们定义的字段的数据类型，同时告诉Elasticsearch如何索引数据以及是否可以被搜索，会让索引建立的更加细致和完善</p>
<h3 id="映射的创建"><a href="#映射的创建" class="headerlink" title="映射的创建"></a>映射的创建</h3><blockquote>
<p>和传统数据库不同，传统的数据库我们尝试向表中插入数据的前提是这个表已经存在数据结构的定义，且插入数据的字段要在表结构中被定义，而ES的映射的创建支持主动和被动创建。</p>
</blockquote>
<h4 id="被动创建（动态映射）-1"><a href="#被动创建（动态映射）-1" class="headerlink" title="被动创建（动态映射）"></a>被动创建（动态映射）</h4><blockquote>
<p>此时字段和映射类型不需要事先定义，只需要存在文档的索引，当向此索引添加数据的时候当遇到不存在的映射字段，ES会根据数据内容自动添加映射字段定义。</p>
</blockquote>
<h5 id="动态映射规则-1"><a href="#动态映射规则-1" class="headerlink" title="动态映射规则"></a>动态映射规则</h5><blockquote>
<p>使用动态映射的时候，根据传递请求数据的不同会创建对应的数据类型</p>
</blockquote>
<table>
<thead>
<tr>
<th>JSON中数据类型</th>
<th>Elasticsearch 数据类型</th>
</tr>
</thead>
<tbody><tr>
<td>null</td>
<td>不添加任何字段</td>
</tr>
<tr>
<td>true或者false</td>
<td>boolean类型</td>
</tr>
<tr>
<td>浮点数据</td>
<td>float类型</td>
</tr>
<tr>
<td>integer数据</td>
<td>long类型</td>
</tr>
<tr>
<td>object</td>
<td>object类型</td>
</tr>
<tr>
<td>array</td>
<td>取决于数组中的第一个非空值的类型。</td>
</tr>
<tr>
<td>string</td>
<td>如果此内容通过了日期格式检测，则会被认为是date数据类型。如果此值通过了数值类型检测则被认为是double或者long数据类型，带有关键字子字段会被认为一个text字段</td>
</tr>
</tbody></table>
<h4 id="主动创建（显示映射）-1"><a href="#主动创建（显示映射）-1" class="headerlink" title="主动创建（显示映射）"></a>主动创建（显示映射）</h4><blockquote>
<p>动态映射只能保证最基础的数据结构的映射，所以很多时候我们需要对字段除了数据结构定义更多的限制的时候，动态映射创建的内容很可能不符合我们的需求，所以可以使用<code>PUT &#123;index&#125;/mapping</code>来更新指定索引的映射内容。</p>
</blockquote>
<h5 id="映射限制"><a href="#映射限制" class="headerlink" title="映射限制"></a>映射限制</h5><blockquote>
<p>为索引中的列定义太多太大的字段会使得映射变得十分臃肿，从而导致内存错误和难以恢复的情况。</p>
</blockquote>
<p> 尤其在使用动态映射的时候，新的数据中假如携带不存在的字段数据时系统会自动添加新的字段，假如不做出限制会使映射字段变得非常多。目前ES支持设置的参数有下面几个</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>index.mapping.total_fields.limit</td>
<td>限制索引中字段的最大数量，默认值是1000。</td>
</tr>
<tr>
<td>index.mapping.depth.limit</td>
<td>字段结构中定义的最大深度，基于根节点定义的字段深度为1，,如果有一个对象映射，则深度为2，依此类推。默认值是20。</td>
</tr>
<tr>
<td>index.mapping.nested_fields.limit</td>
<td>索引中嵌套类型的最大数目，默认为50。</td>
</tr>
<tr>
<td>index.mapping.nested_objects.limit</td>
<td>索引嵌套类型的单个文档内嵌套JSON对象的最大数量，默认为10000。</td>
</tr>
<tr>
<td>index.mapping.field_name_length.limit</td>
<td>自定名称的最大长度，模型情况下是没有限制的。</td>
</tr>
</tbody></table>
<h3 id="映射数据类型"><a href="#映射数据类型" class="headerlink" title="映射数据类型"></a>映射数据类型</h3><h4 id="核心类型"><a href="#核心类型" class="headerlink" title="核心类型"></a>核心类型</h4><h5 id="字符串类型-1"><a href="#字符串类型-1" class="headerlink" title="字符串类型"></a>字符串类型</h5><h6 id="string"><a href="#string" class="headerlink" title="string"></a>string</h6><p> string类型在ElasticSearch 旧版本中使用较多，从ElasticSearch 5.x开始不再支持string，由text和keyword类型替代</p>
<h6 id="text-1"><a href="#text-1" class="headerlink" title="text"></a>text</h6><blockquote>
<p>当一个字段是要被全文搜索的，比如Email内容、产品描述，应该使用text类型</p>
</blockquote>
<p> 设置text类型以后，字段内容会被分析，在生成倒排索引以前，字符串会被分析器分成一个一个词项，text类型的字段<strong>不用于排序，很少用于聚合</strong>。</p>
<h6 id="keyword-1"><a href="#keyword-1" class="headerlink" title="keyword"></a>keyword</h6><blockquote>
<p>keyword类型适用于索引结构化的字段，比如email地址、主机名、状态码和标签</p>
</blockquote>
<p> 如果字段需要进行过滤(比如查找已发布博客中status属性为published的文章)、排序、聚合，<strong>keyword类型的字段只能通过精确值搜索到</strong>，常常被用来过滤、排序和聚合</p>
<h5 id="数字类型-1"><a href="#数字类型-1" class="headerlink" title="数字类型"></a>数字类型</h5><blockquote>
<p>以下是整数类型的取值范围</p>
</blockquote>
<table>
<thead>
<tr>
<th>类型</th>
<th>取值范围</th>
</tr>
</thead>
<tbody><tr>
<td>long</td>
<td>-263 ~ 263</td>
</tr>
<tr>
<td>integer</td>
<td>-231 ~ 231</td>
</tr>
<tr>
<td>short</td>
<td>-215 ~ 215</td>
</tr>
<tr>
<td>byte</td>
<td>-27 ~ 27</td>
</tr>
<tr>
<td>double</td>
<td>64位的双精度 IEEE754 浮点类型</td>
</tr>
<tr>
<td>float</td>
<td>32位的双精度 IEEE754 浮点类型</td>
</tr>
<tr>
<td>half_float</td>
<td>16位的双精度 IEEE754 浮点类型</td>
</tr>
<tr>
<td>scaled_float</td>
<td>缩放类型的浮点类型</td>
</tr>
</tbody></table>
<h6 id="注意事项-1"><a href="#注意事项-1" class="headerlink" title="注意事项"></a>注意事项</h6><ul>
<li>在满足需求的情况下，优先使用范围小的字段。字段长度越小，索引和搜索的效率越高。</li>
<li>浮点数，优先考虑使用scaled_float：例如保存一个价格为99.99的商品，当使用了scaled_float类型，定义比例因子scaling_factor为100，在底层保存的数据就是整数9999，可以提高效率。而在运算时，API还是以浮点类型进行运算。</li>
</ul>
<h5 id="日期类型-1"><a href="#日期类型-1" class="headerlink" title="日期类型"></a>日期类型</h5><blockquote>
<p>JSON中并没有日期类型</p>
</blockquote>
<p> 不管是什么样的格式，es 内部都会先将时间转为 UTC，然后将时间按照 <code>millseconds-since-the-epoch</code> 来存储成long类型，在查询的时候，再根据字段定义的格式转为字符串输出。</p>
<h6 id="日期格式示例-1"><a href="#日期格式示例-1" class="headerlink" title="日期格式示例"></a>日期格式示例</h6><blockquote>
<p>日期类型默认的格式是：<code>strict_date_optional_time||epoch_millis</code>，可以通过<code>format</code>属性来自定义日期格式</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT mapping_demo/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;datetime&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">        <span class="string">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span></span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="日期格式"><a href="#日期格式" class="headerlink" title="日期格式"></a>日期格式</h6><blockquote>
<p>所以在es中日期类型可以表现成很多种：</p>
</blockquote>
<ul>
<li>日期格式字符串：“2020-12-28”或”2020/12/28 11:11:11”</li>
<li>毫秒级别的long类型</li>
<li>秒级别的integer类型</li>
</ul>
<h5 id="布尔类型-1"><a href="#布尔类型-1" class="headerlink" title="布尔类型"></a>布尔类型</h5><blockquote>
<p>JSON 中的 “true”、“false”、true、false 都可以存储到布尔类型中。</p>
</blockquote>
<h5 id="二进制类型"><a href="#二进制类型" class="headerlink" title="二进制类型"></a>二进制类型</h5><blockquote>
<p>二进制字段是指用base64来表示索引中存储的二进制数据</p>
</blockquote>
<p> 可用来存储二进制形式的数据，例如图像，默认情况下，该类型的字段只存储不索引，二进制类型只支持index_name属性。</p>
<h5 id="范围类型-1"><a href="#范围类型-1" class="headerlink" title="范围类型"></a>范围类型</h5><blockquote>
<p>顾名思义，范围类型字段中存储的内容就是一段范围，例如年龄30-55岁，日期在2020-12-28到2021-01-01之间等</p>
</blockquote>
<h6 id="类型范围-1"><a href="#类型范围-1" class="headerlink" title="类型范围"></a>类型范围</h6><blockquote>
<p>es中有六种范围类型：</p>
</blockquote>
<ul>
<li>integer_range</li>
<li>float_range</li>
<li>long_range</li>
<li>double_range</li>
<li>date_range</li>
<li>ip_range</li>
</ul>
<h6 id="使用案例-5"><a href="#使用案例-5" class="headerlink" title="使用案例"></a>使用案例</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT mapping_demo/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;age_range&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer_range&quot;</span></span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定年龄范围，可以使用 gt、gte、lt、lte。</span></span><br><span class="line">PUT mapping_demo/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;real_name&quot;</span>:<span class="string">&quot;大方哥&quot;</span>,</span><br><span class="line">  <span class="string">&quot;age_range&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;gt&quot;</span>:20,</span><br><span class="line">    <span class="string">&quot;lt&quot;</span>:30</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="复合类型"><a href="#复合类型" class="headerlink" title="复合类型"></a>复合类型</h4><h5 id="数组类型"><a href="#数组类型" class="headerlink" title="数组类型"></a>数组类型</h5><blockquote>
<p>es 中没有专门的数组类型。</p>
</blockquote>
<p> 默认情况下，任何字段都可以有一个或者多个值，需要注意的是，数组中的元素必须是同一种类型。</p>
<h6 id="使用示例-2"><a href="#使用示例-2" class="headerlink" title="使用示例"></a>使用示例</h6><blockquote>
<p>常用的数组类型是：</p>
</blockquote>
<ol>
<li>字符数组: [ “one”, “two” ]</li>
<li>整数数组: productid:[ 1, 2 ]</li>
<li>对象（文档）数组: “user”:[ { “name”: “Mary”, “age”: 12 }, { “name”: “John”, “age”: 10 }]，ElasticSearch内部把对象数组展开为 {“user.name”: [“Mary”, “John”], “user.age”: [12,10]}</li>
</ol>
<h5 id="对象类型（object）"><a href="#对象类型（object）" class="headerlink" title="对象类型（object）"></a>对象类型（object）</h5><blockquote>
<p>由于 JSON 本身具有层级关系，所以文档包含内部对象。内部对象中，还可以再包含内部对象。</p>
</blockquote>
<h6 id="使用案例-6"><a href="#使用案例-6" class="headerlink" title="使用案例"></a>使用案例</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT <span class="built_in">test</span>/my/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;employee&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;age&quot;</span>:30,</span><br><span class="line">    <span class="string">&quot;fullname&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;first&quot;</span>:<span class="string">&quot;hadron&quot;</span>,</span><br><span class="line">      <span class="string">&quot;last&quot;</span>:<span class="string">&quot;cheng&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="嵌套类型（nested）"><a href="#嵌套类型（nested）" class="headerlink" title="嵌套类型（nested）"></a>嵌套类型（nested）</h5><blockquote>
<p><code>nested</code>类型是一种特殊的对象object数据类型<code>specialised version of the object datatype</code>，允许对象数组彼此独立地进行索引和查询。</p>
</blockquote>
<h6 id="使用示例-3"><a href="#使用示例-3" class="headerlink" title="使用示例"></a>使用示例</h6><blockquote>
<p>Lucene中没有内部对象的概念，所以 es 会将对象层次扁平化，将一个对象转为字段名和值构成的简单列表，例如添加以下文档：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT nested/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;group&quot;</span> : <span class="string">&quot;fans&quot;</span>,</span><br><span class="line">  <span class="string">&quot;user&quot;</span> : [ </span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;first&quot;</span> : <span class="string">&quot;John&quot;</span>,</span><br><span class="line">      <span class="string">&quot;last&quot;</span> :  <span class="string">&quot;Smith&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;first&quot;</span> : <span class="string">&quot;Alice&quot;</span>,</span><br><span class="line">      <span class="string">&quot;last&quot;</span> :  <span class="string">&quot;White&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>user</code>会被动态映射为<code>object</code>类型的，其内部转换成类似下面的文档格式：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;group&quot;</span> :        <span class="string">&quot;fans&quot;</span>,</span><br><span class="line">  <span class="string">&quot;user.first&quot;</span> : [ <span class="string">&quot;alice&quot;</span>, <span class="string">&quot;john&quot;</span> ],</span><br><span class="line">  <span class="string">&quot;user.last&quot;</span> :  [ <span class="string">&quot;smith&quot;</span>, <span class="string">&quot;white&quot;</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>扁平化处理后，用户名之间的关联关系没有，如果我们使用<code>alice</code>和<code>white</code>查询，就会查询出不存在的用户</p>
</blockquote>
<p>如果您需要索引对象数组并保持数组中每个对象的独立性，请使用<code>nested</code>数据类型，而不是<code>object</code>数据类型。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT nested</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;user&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;nested&quot;</span> </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在内部，嵌套对象将数组中的每个对象索引为一个单独的隐藏文档，这意味着每个嵌套对象都可以通过查询独立于其他对象进行<code>nested</code>查询。</p>
<h6 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h6><blockquote>
<p>使用<code>nested</code>类型的优缺点：</p>
</blockquote>
<ul>
<li>优点：文档存储在一起，读取性能高。</li>
<li>缺点：更新父或者子文档时需要更新更个文档</li>
</ul>
<h4 id="地理类型"><a href="#地理类型" class="headerlink" title="地理类型"></a>地理类型</h4><h5 id="geo-point"><a href="#geo-point" class="headerlink" title="geo_point"></a>geo_point</h5><h6 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景"></a>使用场景</h6><ul>
<li>查找某一个范围内的地理位置</li>
<li>通过地理位置或者相对中心点的距离来聚合文档</li>
<li>把距离整合到文档的评分中</li>
<li>通过距离对文档进行排序</li>
</ul>
<h6 id="定义类型"><a href="#定义类型" class="headerlink" title="定义类型"></a>定义类型</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 定义geo_point字段类型</span></span><br><span class="line">PUT people</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;geo_point&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="使用案例-7"><a href="#使用案例-7" class="headerlink" title="使用案例"></a>使用案例</h6><blockquote>
<p>可以通过5种方式来指定一个地理位置：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># object类型指定经纬度</span></span><br><span class="line">PUT people/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;Geo-point as an object&quot;</span>,</span><br><span class="line">  <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;lat&quot;</span>: 34.27,</span><br><span class="line">    <span class="string">&quot;lon&quot;</span>: 108.94</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 字符串形式指定经纬度，中间用逗号,分隔</span></span><br><span class="line">PUT people/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;Geo-point as a string&quot;</span>,</span><br><span class="line">  <span class="string">&quot;location&quot;</span>: <span class="string">&quot;34.27,108.94&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 将经纬度转个Geohash后储存</span></span><br><span class="line">PUT people/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;Geo-point as a geohash&quot;</span>,</span><br><span class="line">  <span class="string">&quot;location&quot;</span>: <span class="string">&quot;uzbrgzfxuzup&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 使用数组指定经纬度，注意经度在前，纬度在后</span></span><br><span class="line">PUT people/_doc/4</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;Geo-point as an array&quot;</span>,</span><br><span class="line">  <span class="string">&quot;location&quot;</span>: [108.94, 34.27]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 使用WKT原点指定经纬度，注意经度在前，纬度在后</span></span><br><span class="line">PUT people/_doc/5</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;Geo-point as a WKT POINT primitive&quot;</span>,</span><br><span class="line">  <span class="string">&quot;location&quot;</span>: <span class="string">&quot;POINT (108.94 34.27)&quot;</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="查询方式"><a href="#查询方式" class="headerlink" title="查询方式"></a>查询方式</h6><blockquote>
<p>通过经纬度来指定两左上角top_left和右下角bottom_rigth，来查询范围中的位置：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET people/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;geo_bounding_box&quot;</span>: &#123; </span><br><span class="line">      <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;top_left&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;lat&quot;</span>: 30,</span><br><span class="line">          <span class="string">&quot;lon&quot;</span>: 100</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;bottom_right&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;lat&quot;</span>: 40,</span><br><span class="line">          <span class="string">&quot;lon&quot;</span>: 110</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="字段参数"><a href="#字段参数" class="headerlink" title="字段参数"></a>字段参数</h6><blockquote>
<p><code>geo_point</code>字段参数：</p>
</blockquote>
<ul>
<li>ignore_malformed：默认为false，存储格式错误的地理位置将会抛出异常，并且文档也不会写入。true则忽略格式错误的地理位置。</li>
<li>ignore_z_value：默认为true，接受并存储第三维z轴坐标，但仅索引经纬度。false则指接受二维经纬度，超过二维的地理坐标将会抛出异常。</li>
<li>null_value：接受null值的地理位置，表示该字段被视为丢失。</li>
</ul>
<h5 id="geo-shape"><a href="#geo-shape" class="headerlink" title="geo_shape"></a>geo_shape</h5><h6 id="GeoJson是什么"><a href="#GeoJson是什么" class="headerlink" title="GeoJson是什么"></a>GeoJson是什么</h6><blockquote>
<p>在学习<code>geo_shape</code>之前，我们先要了解一下<code>GeoJson</code>。</p>
</blockquote>
<p> GeoJSON是一种对各种地理数据结构进行编码的格式，基于Javascript对象表示法(JavaScript Object Notation, 简称JSON)的地理空间信息数据交换格式，GeoJSON对象可以表示几何、特征或者特征集合。GeoJSON支持下面几何类型：点、线、面、多点、多线、多面和几何集合。GeoJSON里的特征包含一个几何对象和其他属性，特征集合表示一系列特征</p>
<table>
<thead>
<tr>
<th>GeoJson</th>
<th>geo_shape</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Point</td>
<td>point</td>
<td>单个由经纬度描述的地理坐标。注意：Elasticsearch仅使用WGS-84坐标</td>
</tr>
<tr>
<td>LineString</td>
<td>linestring</td>
<td>一个任意的线条，由两个以上点组成</td>
</tr>
<tr>
<td>Polygon</td>
<td>polygon</td>
<td>一个封闭的多边形，其第一个点和最后一个点必须匹配，由四个以上点组成</td>
</tr>
<tr>
<td>MultiPoint</td>
<td>multipoint</td>
<td>一组不连续的点</td>
</tr>
<tr>
<td>MultiLineString</td>
<td>multilinestring</td>
<td>多个不关联的线条</td>
</tr>
<tr>
<td>MultiPolygon</td>
<td>multipolygon</td>
<td>多个多边形</td>
</tr>
<tr>
<td>GeometryCollection</td>
<td>geometrycollection</td>
<td>与JSON形状相似的GeoJSON形状， 可以同时存在多种几何对象类型（例如，Point和LineString）。</td>
</tr>
<tr>
<td>N/A</td>
<td>envelope</td>
<td>通过左上角和右下角两个点来指定一个矩形</td>
</tr>
<tr>
<td>N/A</td>
<td>circle</td>
<td>由中心点和半径指定的圆</td>
</tr>
</tbody></table>
<h6 id="定义类型-1"><a href="#定义类型-1" class="headerlink" title="定义类型"></a>定义类型</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 定义geo_shape字段类型</span></span><br><span class="line">PUT people</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;geo_shape&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="添加数据"><a href="#添加数据" class="headerlink" title="添加数据"></a>添加数据</h6><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># point类型</span></span><br><span class="line">PUT people/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;location&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;point&quot;</span>,</span><br><span class="line">    <span class="string">&quot;coordinates&quot;</span>: [108.94, 34.27]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># linestring类型</span></span><br><span class="line">PUT people/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;location&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;linestring&quot;</span>,</span><br><span class="line">    <span class="string">&quot;coordinates&quot;</span>: [[108.94, 34.27], [100, 33]]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># polygon类型</span></span><br><span class="line">POST /people/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;polygon&quot;</span>,</span><br><span class="line">    <span class="string">&quot;coordinates&quot;</span>: [</span><br><span class="line">      [[100.0, 0.0], [101.0, 0.0], [101.0, 1.0], [100.0, 1.0], [100.0, 0.0]]</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="特殊类型"><a href="#特殊类型" class="headerlink" title="特殊类型"></a>特殊类型</h4><blockquote>
<p>es中的特殊类型有很多种，下面主要介绍两种最常用的</p>
</blockquote>
<h5 id="ip类型"><a href="#ip类型" class="headerlink" title="ip类型"></a>ip类型</h5><blockquote>
<p>ip类型的字段用于存储IPv4或者IPv6的地址</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT <span class="built_in">test</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;my&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;nodeIP&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;ip&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="token-count"><a href="#token-count" class="headerlink" title="token_count"></a>token_count</h5><blockquote>
<p><code>token_count</code>用于统计字符串分词后的词项个数.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 增加了length字段，用于统计词项个数</span></span><br><span class="line">PUT blog</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;length&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;token_count&quot;</span>,</span><br><span class="line">            <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;standard&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 添加文档</span></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>: <span class="string">&quot;zhang san&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 使用token_count进行查询</span></span><br><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title.length&quot;</span>: 2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="映射的元信息"><a href="#映射的元信息" class="headerlink" title="映射的元信息"></a>映射的元信息</h3><blockquote>
<p>在创建映射的时候我们定义的字段内容并非映射中所有的字段，每个文档都存在一些和系统有关的元数据，这些数据被存储在映射的元字段中，根据元数据的作用不同可以分为下面几部分：</p>
</blockquote>
<h4 id="文档特征元信息"><a href="#文档特征元信息" class="headerlink" title="文档特征元信息"></a>文档特征元信息</h4><table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>_index</td>
<td>文档所属的索引</td>
</tr>
<tr>
<td>_type</td>
<td>文档的映射类型。6.X之后已删除</td>
</tr>
<tr>
<td>_id</td>
<td>文档的ID</td>
</tr>
</tbody></table>
<h4 id="文档数据源元信息"><a href="#文档数据源元信息" class="headerlink" title="文档数据源元信息"></a>文档数据源元信息</h4><blockquote>
<p>需要注意的<code>_size</code>并不是默认就存在的，此字段需要mapper-size插件提供，该字段会以字节为单位索引<code>_source</code>字段的大小。</p>
</blockquote>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>_source</td>
<td>表示文档主体的原始JSON</td>
</tr>
<tr>
<td>_size</td>
<td>_source字段的大小(以字节为单位)</td>
</tr>
</tbody></table>
<h4 id="索引原信息"><a href="#索引原信息" class="headerlink" title="索引原信息"></a>索引原信息</h4><table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>_field_names</td>
<td>用来索引文档中包含除了null之外的任何值得字段的名称</td>
</tr>
<tr>
<td>_ignored</td>
<td>该字段索引并存储文档中因为格式错误而被忽略的字段的名称</td>
</tr>
</tbody></table>
<h4 id="路由原信息"><a href="#路由原信息" class="headerlink" title="路由原信息"></a>路由原信息</h4><table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>_routing</td>
<td>将文档路由到特定碎片的自定义路由值</td>
</tr>
</tbody></table>
<h4 id="自定义元信息"><a href="#自定义元信息" class="headerlink" title="自定义元信息"></a>自定义元信息</h4><table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>_meta</td>
<td>此字段可以定义一些自定的信息，这些信息Elasticsearch不会使用他们，但是用户可以用其来保存特定的元数据，比如版本信息等。</td>
</tr>
</tbody></table>
<h3 id="映射参数"><a href="#映射参数" class="headerlink" title="映射参数"></a>映射参数</h3><blockquote>
<p>除了<code>type</code>参数，Mapping中还有另外27种映射参数。</p>
</blockquote>
<p> 有些参数对于所有字段类型都是通用的，例如<code>boost</code>权重参数，而有些参数则只适用于特定字段，例如<code>analyzer</code>参数只能作用于<code>text</code>字段。</p>
<h5 id="analyzer"><a href="#analyzer" class="headerlink" title="analyzer"></a>analyzer</h5><blockquote>
<p>将字符串转换成多个分词</p>
</blockquote>
<p> 例如，字符串 “The quick Brown Foxes.”，根据指定分词器可以得到分词：quick, brown, fox。分词器可以自定义，这使得可以有效地搜索大块文本中的单个单词。</p>
<p> 此分析过程不仅需要在索引时进行，还需要在查询时进行：查询字符串需要指定相同或类似的分析器，以便在查询字符串分析得到的分词与索引中的分词格式相同。</p>
<p> Elasticsearch附带了需要预定义的分析器，无需进一步配置即可使用，它还附带了需要字符过滤器、分词器和分词过滤器，可以组合起来为每个索引配置自定义分析器。</p>
<blockquote>
<p><code>analyzer</code>参数定义<code>text</code>字段<strong>索引和查询</strong>所使用的分析器，默认使用es自带的<code>Standard</code>标准分析器。</p>
</blockquote>
<p> 查询分析时，除非使用<code>search_analyzer</code>映射参数覆盖，否则也是使用的也是<code>analyzer</code>定义的分析器。</p>
<h6 id="英文分词"><a href="#英文分词" class="headerlink" title="英文分词"></a>英文分词</h6><blockquote>
<p>我们先创建一个索引，不配置任何类型</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用默认分词器</span></span><br><span class="line">PUT blog</span><br><span class="line"><span class="comment"># 添加英文内容</span></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;content&quot;</span>: <span class="string">&quot;Things in life are aften unpredictable,but the wise advance every step with confidence.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 使用term vectors查看词条向量</span></span><br><span class="line">GET blog/_termvectors/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;fields&quot;</span>: [<span class="string">&quot;content&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现英文默认按照单词空格进行分词的</p>
</blockquote>
<h6 id="中文分词"><a href="#中文分词" class="headerlink" title="中文分词"></a>中文分词</h6><blockquote>
<p>下面我们使用默认分词器为中文分词</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 首先不定义分析器</span></span><br><span class="line">PUT blog</span><br><span class="line"><span class="comment"># 添加文档</span></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>: <span class="string">&quot;中国人民解放军东部战区陆军部队在台湾海峡实施了远程火力实弹射击训练，取得了预期效果&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 使用term vectors查看词条向量</span></span><br><span class="line">GET blog/_termvectors/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;fields&quot;</span>: [<span class="string">&quot;title&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过<code>_termvectors</code>词条向量可以看到，如果不使用分析器，es默认分析器会一个一个将中文拆分。这样的分词结果没有任何意义，因为只能使用单个汉字，而不能使用词语。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch264.png" alt="image-20220804153014026"></p>
<h6 id="使用IK分词器-2"><a href="#使用IK分词器-2" class="headerlink" title="使用IK分词器"></a>使用IK分词器</h6><blockquote>
<p>默认分词器不适合于中文分词，我们使用IK分词器试试</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">DELETE blog</span><br><span class="line"><span class="comment"># 添加索引并设置title为text类型，并设置IK分词器</span></span><br><span class="line">PUT blog</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;content&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加文档</span></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>: <span class="string">&quot;中国人民解放军东部战区陆军部队在台湾海峡实施了远程火力实弹射击训练，取得了预期效果&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 使用term vectors查看词条向量</span></span><br><span class="line">GET blog/_termvectors/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;fields&quot;</span>: [<span class="string">&quot;content&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用了正确的分词器，就可以将中文正确的分开了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch265.png" alt="image-20220805140921988"></p>
<h5 id="search-analyzer"><a href="#search-analyzer" class="headerlink" title="search_analyzer"></a>search_analyzer</h5><blockquote>
<p>通常情况下，索引和查询应该使用相同的分析器，以确保查询时的术语与倒排索引中的术语具有相同的格式</p>
</blockquote>
<p> 但有时，在搜索时使用不同的分析器是有意义的，例如在使用edge_ngrapm tokenizer自动补全。</p>
<p> 默认情况下，查询时也是使用<code>analyzer</code>参数定义的分析器，但有些时候，为了查询更加精准，或是满足不同业务场景，可以通过<code>search_analyzer</code>参数来覆盖。</p>
<h6 id="查询场景"><a href="#查询场景" class="headerlink" title="查询场景"></a>查询场景</h6><blockquote>
<p>我们看下下面的使用场景</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;content&quot;</span>: <span class="string">&quot;普通高中生平均年龄15-18岁&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;content&quot;</span>: <span class="string">&quot;普通高中&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用<code>普通高中</code>查询文档，此时查询默认也是使用<code>analyzer</code>定义的<code>ik_smart</code>分析器，查询失败！！</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch266.png" alt="image-20220805143409828"></p>
<h6 id="查询失败原因"><a href="#查询失败原因" class="headerlink" title="查询失败原因"></a>查询失败原因</h6><blockquote>
<p>首先我们使用<code>_termvectors</code>查看词条向量，会发现ik_smart分析器将“普通高中生”分成“普通”和“高中生”两个词条</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET blog/_termvectors/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;fields&quot;: [&quot;content&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch267.png" alt="image-20220805144355111"></p>
<h6 id="解析器分析"><a href="#解析器分析" class="headerlink" title="解析器分析"></a>解析器分析</h6><blockquote>
<p>我们还可以使用ElasticSearch的解析器对文本进行分析，我们先来分析下<code>ik_smart</code>的分词效果</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;普通高中生平均年龄15-18岁&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现这个这个分词没有分出来<code>普通高中生</code></p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch268.png" alt="image-20220805145121339"></p>
<blockquote>
<p>下面我们使用<code>ik_max_word</code>来进行分词</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;普通高中生平均年龄15-18岁&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现这个分词效果符合我们的预期</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch269.png" alt="image-20220805145248504"></p>
<h6 id="配置查询解析"><a href="#配置查询解析" class="headerlink" title="配置查询解析"></a>配置查询解析</h6><blockquote>
<p>对于“普通高中”，<strong>ik_smart</strong>分析器并不会分词，而是当做一个词条</p>
</blockquote>
<p> 当使用“普通高中”去查询时，自然查询失败，此时就可以设置查询的分析器为<strong>ik_max_word</strong>，查询时将“普通高中”分成“普通”和“高中”两个词条，进行精确查询</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">DELETE blog</span><br><span class="line"><span class="comment"># 添加索引并设置title为text类型，并设置IK分词器</span></span><br><span class="line">PUT blog</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;content&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span>,</span><br><span class="line">        <span class="string">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;content&quot;</span>: <span class="string">&quot;普通高中生平均年龄15-18岁&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: <span class="string">&quot;普通高中&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现这种已经有了命中数据了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch270.png" alt="image-20220805145533952"></p>
<h5 id="search-quote-analyzer"><a href="#search-quote-analyzer" class="headerlink" title="search_quote_analyzer"></a>search_quote_analyzer</h5><blockquote>
<p>通过参数search_quote_analyzer设置短语指定分析器，这在处理禁用短语查询的停用词时特别有用</p>
</blockquote>
<h6 id="禁用停用词"><a href="#禁用停用词" class="headerlink" title="禁用停用词"></a>禁用停用词</h6><blockquote>
<p>要禁用短语的停用词，需要使用三个分析器设置字段：</p>
</blockquote>
<ol>
<li>通过参数analyzer指定索引分词，包含停用词参数。分词中包含停用词</li>
<li>通过参数search_analyze指定非短语查询分词器，分词中删除停用词</li>
<li>通过参数search_quote_analyzer指定短语查询分词器，分词中包含停用词</li>
</ol>
<h6 id="添加文档"><a href="#添加文档" class="headerlink" title="添加文档"></a>添加文档</h6><blockquote>
<p>下面我们添加以下文档</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">DELETE blog</span><br><span class="line"><span class="comment"># 定义文档格式</span></span><br><span class="line">PUT blog</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;content&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span>,</span><br><span class="line">        <span class="string">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">        <span class="string">&quot;search_quote_analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;content&quot;</span>: <span class="string">&quot;歌唱美好地祖国&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">PUT blog/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;content&quot;</span>: <span class="string">&quot;歌唱美好的祖国&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="非短语查询"><a href="#非短语查询" class="headerlink" title="非短语查询"></a>非短语查询</h6><blockquote>
<p>下面我们使用非短语方式进行查询</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;content&quot;</span>: <span class="string">&quot;歌唱美好的祖国&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用非短语查询时，<code>search_analyzer</code>使用的<strong>ik_max_word</strong>会删除掉停止词“的”，导致两个文档都匹配，会查询出两条记录</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch271.png" alt="image-20220805151831006"></p>
<h6 id="短语查询"><a href="#短语查询" class="headerlink" title="短语查询"></a>短语查询</h6><blockquote>
<p>下面我们使用<code>query_string</code>进行短语查询</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: <span class="string">&quot;\&quot;歌唱美好的祖国\&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当使用<code>query_string</code>，并将查询短语用引号””引起来时，它被检测为短语查询，因此<code>search_quote_analyzer</code>启动，不会删除掉停用词“的”，只会查询出一条记录。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch272.png" alt="image-20220805152022747"></p>
<h5 id="normalizer"><a href="#normalizer" class="headerlink" title="normalizer"></a>normalizer</h5><blockquote>
<p><code>normalizer</code>作用于<code>keyword</code>字段类型，用于解析前（索引或者查询）的标准化配置。</p>
</blockquote>
<p> 归一化处理，主要针对 keyword 类型，在索引该字段或查询字段之前，可以先对原始数据进行一些简单的处理，然后再将处理后的结果当成一个词根存入倒排索 引中，默认为 null。</p>
<p> 我们知道，<code>keyword</code>字段在索引或者查询时都不会进行分词，如果在索引前没有做好数据清洗，导致大小写不一致，例如 <strong>amby</strong> 和 <strong>Amby</strong>，使用 <strong>amby</strong> 就无法查询到 <strong>Amby</strong> 的文档，实际它们应该是相同的</p>
<h6 id="创建文档"><a href="#创建文档" class="headerlink" title="创建文档"></a>创建文档</h6><blockquote>
<p>此时，我们就可以使用<code>normalizer</code>在索引之前以及查询之前进行文档的标准化。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">DELETE blog</span><br><span class="line"><span class="comment"># 定义文档格式 自定义my_normalizer，并设置为author字段的normalizer参数值</span></span><br><span class="line">PUT blog</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;normalizer&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;my_normalizer&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>:<span class="string">&quot;custom&quot;</span>,</span><br><span class="line">          <span class="string">&quot;filter&quot;</span>:[<span class="string">&quot;lowercase&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;author&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">        <span class="string">&quot;normalizer&quot;</span>:<span class="string">&quot;my_normalizer&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 分别添加amby和Amby文档</span></span><br><span class="line"></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;author&quot;</span>:<span class="string">&quot;amby&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">PUT blog/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;author&quot;</span>:<span class="string">&quot;Amby&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="文档查询"><a href="#文档查询" class="headerlink" title="文档查询"></a>文档查询</h6><blockquote>
<p>接下来不论是使用amby还是Amby，甚至是AMBY，都能查询出两个文档来</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;author&quot;</span>: <span class="string">&quot;AMBY&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch273.png" alt="image-20220805153055421"></p>
<blockquote>
<p>查看author字段的聚合返回归一化值，Amby在索引前已经被转成amby</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;foo_terms&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;author&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch274.png" alt="image-20220805153230732"></p>
<h5 id="coerce"><a href="#coerce" class="headerlink" title="coerce"></a>coerce</h5><blockquote>
<p><code>coerce</code> 参数用来清除脏数据，默认为 true。</p>
</blockquote>
<p> 数据不总是我们想要的，由于在转换 JSON body 为真正 JSON 的时候,整型数 字 5 有可能会被写成字符串”5”或者浮点数 5.0，这个参数可以将数值不合法的部分去除。</p>
<blockquote>
<p>例如一个整数，在 JSON 中，用户可能输入了错误的类型：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;age&quot;</span>: <span class="string">&quot;99&quot;</span>&#125; <span class="comment"># 字符串类型</span></span><br><span class="line">&#123;<span class="string">&quot;age&quot;</span>: 99.0&#125; <span class="comment"># 浮点类型</span></span><br></pre></td></tr></table></figure>

<h6 id="使用场景-2"><a href="#使用场景-2" class="headerlink" title="使用场景"></a>使用场景</h6><blockquote>
<p>例如一个整数，在 JSON 中，用户可能输入了错误的类型：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;age&quot;</span>: <span class="string">&quot;99&quot;</span>&#125; <span class="comment"># 字符串类型</span></span><br><span class="line">&#123;<span class="string">&quot;age&quot;</span>: 99.0&#125; <span class="comment"># 浮点类型</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>这些都不是正确的数字格式，但是经过 <code>coerce</code> 之后，都能正确的存储为整数类型</p>
</blockquote>
<h6 id="不进行过滤"><a href="#不进行过滤" class="headerlink" title="不进行过滤"></a>不进行过滤</h6><blockquote>
<p>默认情况下<code>coerce</code>为rue，不对插入文档进行过滤</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">DELETE blog</span><br><span class="line"><span class="comment"># 设置age为整数类型</span></span><br><span class="line">PUT blog</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 无论是整数，还是字符串或浮点类型，都能正确的存储</span></span><br><span class="line">POST blog/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;age&quot;</span>: 99</span><br><span class="line">&#125;</span><br><span class="line">POST blog/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;age&quot;</span>: <span class="string">&quot;99&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">POST blog/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;age&quot;</span>: 99.0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="过滤文档"><a href="#过滤文档" class="headerlink" title="过滤文档"></a>过滤文档</h6><blockquote>
<p>可以修改 <code>coerce</code> 为 false ，修改之后，只有正确输入整数类型，才能存储，否则报错</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">DELETE blog</span><br><span class="line"><span class="comment"># 设置age为整数类型</span></span><br><span class="line">PUT blog</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span>,</span><br><span class="line">        <span class="string">&quot;coerce&quot;</span>: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只有整数才能够被存储</span></span><br><span class="line">POST blog/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;age&quot;</span>: 99</span><br><span class="line">&#125;</span><br><span class="line">POST blog/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;age&quot;</span>: <span class="string">&quot;99&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">POST blog/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;age&quot;</span>: 99.0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch275.png" alt="image-20220805155326783"></p>
<h5 id="to"><a href="#to" class="headerlink" title="_to"></a>_to</h5><blockquote>
<p>_to 参数允许您创建自定义的<code>_all</code> 字段，这个参数可以将多个字段的值，复制到同一个字段中。</p>
</blockquote>
<h6 id="创建文档-1"><a href="#创建文档-1" class="headerlink" title="创建文档"></a>创建文档</h6><blockquote>
<p>我们创建一个文档</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">DELETE blog</span><br><span class="line"><span class="comment"># 该索引会将type和content内容复制到full_content中</span></span><br><span class="line">PUT blog</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_to&quot;</span>: <span class="string">&quot;full_content&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;content&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_to&quot;</span>: <span class="string">&quot;full_content&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;full_content&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 添加文档</span></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>:<span class="string">&quot;news &quot;</span>,</span><br><span class="line">  <span class="string">&quot;content&quot;</span>:<span class="string">&quot;东部战区导弹全部精准命中目标&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="查询文档-4"><a href="#查询文档-4" class="headerlink" title="查询文档"></a>查询文档</h6><blockquote>
<p>我们根据生成的<code>full_content</code>字段进行查询</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;full_content&quot;</span>: <span class="string">&quot;news&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;full_content&quot;</span>: <span class="string">&quot;东&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现上面两个搜索都能够搜索到字段</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch276.png" alt="image-20220805163331945"></p>
<h5 id="doc-values-和-fielddata"><a href="#doc-values-和-fielddata" class="headerlink" title="doc_values 和 fielddata"></a>doc_values 和 fielddata</h5><blockquote>
<p>es 中的搜索主要是用到倒排索引，<code>doc_values</code> 参数是为了加快排序、聚合操作而生的，当建立倒排索引的时候，会额外增加列式存储映射，以空间换时间，</p>
</blockquote>
<p><code>doc_values</code> 默认是开启的，如果确定某个字段不需要排序或者不需要聚合，那么可以关闭 doc_values，大部分的字段在索引时都会生成 <code>doc_values</code>，除了 text，text 字段在查询时会生成一个 <code>fielddata</code> 的数据结构，<code>fieldata</code> 在字段首次被聚合、排序的时候生成。</p>
<h6 id="两者区别-1"><a href="#两者区别-1" class="headerlink" title="两者区别"></a>两者区别</h6><blockquote>
<p>下面简单对比一下两者的区别：</p>
</blockquote>
<table>
<thead>
<tr>
<th>doc_values</th>
<th>fieldata</th>
</tr>
</thead>
<tbody><tr>
<td>默认开启</td>
<td>默认关闭</td>
</tr>
<tr>
<td>索引时创建</td>
<td>使用时动态创建</td>
</tr>
<tr>
<td>磁盘</td>
<td>内存</td>
</tr>
<tr>
<td>不占用内存</td>
<td>不占用磁盘</td>
</tr>
<tr>
<td>索引速度降低一点</td>
<td>文档很多时，动态创建慢，占内存</td>
</tr>
</tbody></table>
<blockquote>
<p><code>fieldata</code> 参数使用场景很少，因为text字段一般都不用与排序和聚合，所以如果真的需要用到这个参数，一定要想清楚为什么，是否还有可替代方法。</p>
</blockquote>
<h6 id="排序效果"><a href="#排序效果" class="headerlink" title="排序效果"></a>排序效果</h6><blockquote>
<p>下面用<code>doc_values</code> 演示排序效果：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT users</span><br><span class="line"></span><br><span class="line">PUT users/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;age&quot;</span>:100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT users/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;age&quot;</span>:99</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT users/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;age&quot;</span>:98</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT users/_doc/4</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;age&quot;</span>:101</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>:[</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>下面就是排序后的效果</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch277.png" alt="image-20220805163845982"></p>
<h5 id="enabled"><a href="#enabled" class="headerlink" title="enabled"></a>enabled</h5><blockquote>
<p>是否建立索引，默认情况下为 true</p>
</blockquote>
<p> es 默认会索引所有的字段，但有时候某些类型的字段，无需建立索引，只是用来存储数据即可，例如图片url地址，此时可以通过 <code>enabled</code> 字段来控制，设置为 false 之后，就不能再通过该字段进行搜索了</p>
<h6 id="创建文档-2"><a href="#创建文档-2" class="headerlink" title="创建文档"></a>创建文档</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">DELETE blog</span><br><span class="line"><span class="comment"># 创建问题并设置title不建立索引</span></span><br><span class="line">PUT blog</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 创建文档</span></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>:<span class="string">&quot;东部战区导弹全部精准命中目标&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="文档搜索"><a href="#文档搜索" class="headerlink" title="文档搜索"></a>文档搜索</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: <span class="string">&quot;东部战区导弹全部精准命中目标&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现是无法进行索引查询的</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch278.png" alt="image-20220805165035659"></p>
<h5 id="format"><a href="#format" class="headerlink" title="format"></a>format</h5><blockquote>
<p>format用来对文档的日期类型进行识别以及格式化，如果格式不符合就会报错</p>
</blockquote>
<p> 在 JSON 文档中，日期表示为字符串，Elasticsearch 使用一组预先配置的格式来识别和解析这些字符串，并将其解析为 long 类型的数值(毫秒)，支持自定义格式，一次可以定义多个 <code>format</code>，多个日期格式之间，使用 || 符号连接，注意没有空格，如果没有指定<code>format</code>，日期类型默认的格式是：<code>strict_date_optional_time||epoch_millis</code></p>
<h6 id="创建文档-3"><a href="#创建文档-3" class="headerlink" title="创建文档"></a>创建文档</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">DELETE users</span><br><span class="line"><span class="comment"># 创建索引文件，类型是date指定格式化方式</span></span><br><span class="line">PUT users</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;birthday&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">        <span class="string">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd||yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 添加文档</span></span><br><span class="line">PUT users/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;birthday&quot;</span>:<span class="string">&quot;2020-11-11&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT users/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;birthday&quot;</span>:<span class="string">&quot;2020-11-11 11:11:11&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 如果日期格式不是定义的格式就会插入错误</span></span><br><span class="line">PUT users/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;birthday&quot;</span>:<span class="string">&quot;2020-11-25T00:00:00&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch279.png" alt="image-20220805165843606"></p>
<h5 id="ignore-above"><a href="#ignore-above" class="headerlink" title="ignore_above"></a>ignore_above</h5><blockquote>
<p>在ElasticSearch中keyword类型字段可以设置ignore_above属性(默认是10) ，表示最大的字段值长度，超出这个长度的字段将不会被索引，但是会存储，这个字段只适用于 keyword 类型。</p>
</blockquote>
<h6 id="创建文档-4"><a href="#创建文档-4" class="headerlink" title="创建文档"></a>创建文档</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">DELETE blog</span><br><span class="line"><span class="comment"># 创建索引文件，设置title长度为10</span></span><br><span class="line">PUT blog</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ignore_above&quot;</span>: 10</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 添加文档</span></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>:<span class="string">&quot;东部战区&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT blog/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>:<span class="string">&quot;东部战区导弹全部精准命中目标&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="查询文档-5"><a href="#查询文档-5" class="headerlink" title="查询文档"></a>查询文档</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 能够查询出来数据</span></span><br><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: <span class="string">&quot;东部战区&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 查询不出来数据</span></span><br><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: <span class="string">&quot;东部战区导弹全部精准命中目标&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 发现数据已经被存储了</span></span><br><span class="line">GET blog/_doc/2</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch280.png" alt="image-20220805171137642"></p>
<h5 id="ignore-malformed"><a href="#ignore-malformed" class="headerlink" title="ignore_malformed"></a>ignore_malformed</h5><blockquote>
<p><code>ignore_malformed</code> 参数可以忽略不规则的数据，该参数默认为 false</p>
</blockquote>
<p> 对于age字段，有人可能填写的是Integer类型，也有人填写的是字符串格式，给一个字段索引不合适的数据类型发生异常，导致整个文档索引失败，如果ignore_malformed参数设为true，异常会被忽略，出异常的字段不会被索引，其它字段正常索引。</p>
<h6 id="创建文档-5"><a href="#创建文档-5" class="headerlink" title="创建文档"></a>创建文档</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">DELETE users</span><br><span class="line"><span class="comment"># 创建索引文件</span></span><br><span class="line">PUT users</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ignore_malformed&quot;</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT users/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;age&quot;</span>:99</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT users/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;age&quot;</span>:<span class="string">&quot;abc&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT users/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;age&quot;</span>:<span class="string">&quot;abc&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="index"><a href="#index" class="headerlink" title="index"></a>index</h5><blockquote>
<p><code>index</code> 参数用于指定一个字段是否被索引，为 true 表示字段被索引，false 表示字段不被索引</p>
</blockquote>
<p>注意，如果字段不能被索引，也就不能通过该字段进行搜索。</p>
<h6 id="创建文档-6"><a href="#创建文档-6" class="headerlink" title="创建文档"></a>创建文档</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">DELETE users</span><br><span class="line"></span><br><span class="line">PUT users</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span>,</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT users/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;age&quot;</span>:99</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>: 99</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch281.png" alt="image-20220805180713436"></p>
<h5 id="null-value"><a href="#null-value" class="headerlink" title="null_value"></a>null_value</h5><blockquote>
<p>值为<code>null</code>的字段不索引也不可以被搜索，<code>null_value</code> 可以让值为 <code>null</code>的字段显式的可索引、可搜索</p>
</blockquote>
<h6 id="创建文档-7"><a href="#创建文档-7" class="headerlink" title="创建文档"></a>创建文档</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">DELETE users</span><br><span class="line"><span class="comment"># 创建索引设置name如果为null，设置值为null_value</span></span><br><span class="line">PUT users</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">        <span class="string">&quot;null_value&quot;</span>: <span class="string">&quot;null_value&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加文档</span></span><br><span class="line">PUT users/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>:null,</span><br><span class="line">  <span class="string">&quot;age&quot;</span>:99</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="搜索文档"><a href="#搜索文档" class="headerlink" title="搜索文档"></a>搜索文档</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;null_value&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch282.png" alt="image-20220805181406083"></p>
<h5 id="position-increment-gap"><a href="#position-increment-gap" class="headerlink" title="position_increment_gap"></a>position_increment_gap</h5><blockquote>
<p>被解析的 text 字段会将 term 的位置考虑进去，目的是为了支持近似查询和短语查询</p>
</blockquote>
<p> 我们去索引一个含有多个值的 text 字段时，会在各个值之间添加一个假想的空间，将值隔开，这样就可以有效避免一些无意义的短语匹配，间隙大小通过 <code>position_increment_gap</code> 参数来控制，默认是 100</p>
<h6 id="默认方式进行查询"><a href="#默认方式进行查询" class="headerlink" title="默认方式进行查询"></a>默认方式进行查询</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">DELETE users</span><br><span class="line"><span class="comment"># 创建索引</span></span><br><span class="line">PUT users</span><br><span class="line"><span class="comment"># 添加一个数组</span></span><br><span class="line">PUT users/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>:[<span class="string">&quot;zhang san&quot;</span>,<span class="string">&quot;li si&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 当我们使用“zhang san”或“li si”，可以查询到。如果使用“san li”则查询不了，因为数组中两个值之间间隔了100的空隙，需要指定空隙大小进行查询。</span></span><br><span class="line">GET users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;san li&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 查询时通过slop指定</span></span><br><span class="line">GET users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;san li&quot;</span>,</span><br><span class="line">        <span class="string">&quot;slop&quot;</span>: 100</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="position-increment-gap查询"><a href="#position-increment-gap查询" class="headerlink" title="position_increment_gap查询"></a>position_increment_gap查询</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">DELETE users</span><br><span class="line"><span class="comment"># 创建索引</span></span><br><span class="line">PUT users</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;position_increment_gap&quot;</span>: 0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 添加一个数组</span></span><br><span class="line">PUT users/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>:[<span class="string">&quot;zhang san&quot;</span>,<span class="string">&quot;li si&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 当我们使用“zhang san”或“li si”，可以查询到。如果使用“san li”则查询不了，因为数组中两个值之间间隔了100的空隙，需要指定空隙大小进行查询。</span></span><br><span class="line">GET users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;san li&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch283.png" alt="image-20220805182421486"></p>
<h5 id="properties"><a href="#properties" class="headerlink" title="properties"></a>properties</h5><blockquote>
<p><code>properties</code> 是最常用的参数之一，可以作用于 <code>mappings</code>、<code>object</code> 字段、 <code>nested</code> 字段中，进行属性的添加，这些属性可以是任意字段类型，包括 <code>object</code> 和 <code>nested</code> 。可以通过以下三种方式添加属性：</p>
</blockquote>
<h6 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h6><blockquote>
<p>可以通过以下三种方式添加属性：</p>
</blockquote>
<ul>
<li>创建索引时定义。</li>
<li>使用PUT mapping 添加或更新字段类型时定义。</li>
<li>索引包含新字段的文档时，通过动态映射定义。</li>
</ul>
<h6 id="创建文档-8"><a href="#创建文档-8" class="headerlink" title="创建文档"></a>创建文档</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT people</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123; </span><br><span class="line">      &quot;manager&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123; </span><br><span class="line">          &quot;age&quot;:  &#123; &quot;type&quot;: &quot;integer&quot; &#125;,</span><br><span class="line">          &quot;name&quot;: &#123; &quot;type&quot;: &quot;text&quot;  &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;employees&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;nested&quot;,</span><br><span class="line">        &quot;properties&quot;: &#123; </span><br><span class="line">          &quot;age&quot;:  &#123; &quot;type&quot;: &quot;integer&quot; &#125;,</span><br><span class="line">          &quot;name&quot;: &#123; &quot;type&quot;: &quot;text&quot;  &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT people/_doc/1 </span><br><span class="line">&#123;</span><br><span class="line">  &quot;manager&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;Alice White&quot;,</span><br><span class="line">    &quot;age&quot;: 30</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;employees&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;John Smith&quot;,</span><br><span class="line">      &quot;age&quot;: 34</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;Peter Brown&quot;,</span><br><span class="line">      &quot;age&quot;: 26</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="fields"><a href="#fields" class="headerlink" title="fields"></a>fields</h5><blockquote>
<p><code>fields</code> 参数可以让同一字段有多种不同的索引方式，比如一个 String 类型的字段， 可以使用 text 类型做全文检索，使用 keyword 类型做聚合和排序</p>
</blockquote>
<h6 id="创建文档-9"><a href="#创建文档-9" class="headerlink" title="创建文档"></a>创建文档</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">DELETE blog</span><br><span class="line"></span><br><span class="line">PUT blog</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;raw&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>:<span class="string">&quot;keyword&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 添加数据</span></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>:<span class="string">&quot;百度地图被搜崩了&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="全文检索"><a href="#全文检索" class="headerlink" title="全文检索"></a>全文检索</h6><blockquote>
<p>title字段用于全文检索</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: <span class="string">&quot;百度&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="关键字查询"><a href="#关键字查询" class="headerlink" title="关键字查询"></a>关键字查询</h6><blockquote>
<p>title.raw用于关键字查询</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title.raw&quot;</span>: <span class="string">&quot;百度地图被搜崩了&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch284.png" alt="image-20220805184230858"></p>
<h5 id="更多字段"><a href="#更多字段" class="headerlink" title="更多字段"></a>更多字段</h5><blockquote>
<p>还有更多字段，可以在这里进行查询</p>
</blockquote>
<h6 id="index-options"><a href="#index-options" class="headerlink" title="index_options"></a>index_options</h6><blockquote>
<p><code>index_options</code> 参数用于控制索引时哪些信息被存储到倒排索引中，仅作用在 text 字段，有四种取值：</p>
</blockquote>
<ul>
<li>docs：只存储文档编号。</li>
<li>freqs：在docs基础上，存储词项频率。</li>
<li>positions <strong>（默认）</strong>：在freqs基础上，存储词项偏移位置。</li>
<li>offsets：在positions基础上，存储词项开始和结束的字符位置。</li>
</ul>
<h6 id="norms"><a href="#norms" class="headerlink" title="norms"></a>norms</h6><blockquote>
<p><code>norms</code> 对字段评分有用，text 类型会默认开启，如果不是特别需要，不要开启 <code>norms</code>。</p>
</blockquote>
<h6 id="similarity"><a href="#similarity" class="headerlink" title="similarity"></a>similarity</h6><blockquote>
<p><code>similarity</code> 参数用于指定文档的评分模型，使用到的情况不多，默认有三种：</p>
</blockquote>
<ul>
<li>BM25：es 和 Lucene 默认的评分模型。</li>
<li>classic：TF/IDF 评分。</li>
<li>boolean：boolean 评分模型。</li>
</ul>
<h6 id="store"><a href="#store" class="headerlink" title="store"></a>store</h6><p> 默认情况下，字段会被索引，也可以搜索，但是不会存储，虽然不会被存储的，但是 _source 中有一个字段的备份。如果想将字段存储下来，可以通过配置 <code>store</code> 参数来实现。</p>
<h6 id="term-vectors"><a href="#term-vectors" class="headerlink" title="term_vectors"></a>term_vectors</h6><blockquote>
<p><code>term_vectors</code> 是通过分词器产生的词项信息，包括：</p>
</blockquote>
<ul>
<li>一组 terms</li>
<li>每个 term 的位置</li>
<li>term 的首字符 / 尾字符与原始字符串原点的偏移量</li>
</ul>
<table>
<thead>
<tr>
<th>term_vectors取值</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>no</td>
<td>不存储信息</td>
</tr>
<tr>
<td>yes</td>
<td>存储 term 信息</td>
</tr>
<tr>
<td>with_positions</td>
<td>存储 term 信息和位置信息</td>
</tr>
<tr>
<td>with_offset</td>
<td>存储 term 信息和偏移信息</td>
</tr>
<tr>
<td>with_positions_offset</td>
<td>存储 term 信息、位置信息和偏移信息</td>
</tr>
</tbody></table>
<h2 id="ElasticSearch-分词器"><a href="#ElasticSearch-分词器" class="headerlink" title="ElasticSearch 分词器"></a>ElasticSearch 分词器</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch001.png" alt="img"></p>
<h3 id="概述-5"><a href="#概述-5" class="headerlink" title="概述"></a>概述</h3><blockquote>
<p>分词器的主要作用将用户输入的一段文本，按照一定逻辑，分析成多个词语的一种工具</p>
</blockquote>
<h4 id="什么是分词器-1"><a href="#什么是分词器-1" class="headerlink" title="什么是分词器"></a>什么是分词器</h4><blockquote>
<p>顾名思义，文本分析就是<strong>把全文本转换成一系列单词（term/token）的过程</strong>，也叫<strong>分词</strong>。在 ES 中，Analysis 是通过<strong>分词器（Analyzer）</strong> 来实现的，可使用 ES 内置的分析器或者按需定制化分析器。</p>
</blockquote>
<p> 举一个分词简单的例子：比如你输入 <code>Mastering Elasticsearch</code>，会自动帮你分成两个单词，一个是 <code>mastering</code>，另一个是 <code>elasticsearch</code>，可以看出单词也被转化成了小写的。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch232.png" alt="图片"></p>
<h4 id="分词器的构成"><a href="#分词器的构成" class="headerlink" title="分词器的构成"></a>分词器的构成</h4><blockquote>
<p>分词器是专门处理分词的组件，分词器由以下三部分组成：</p>
</blockquote>
<h5 id="组成部分"><a href="#组成部分" class="headerlink" title="组成部分"></a>组成部分</h5><h6 id="character-filter-1"><a href="#character-filter-1" class="headerlink" title="character filter"></a>character filter</h6><blockquote>
<p>接收原字符流，通过添加、删除或者替换操作改变原字符流</p>
</blockquote>
<p> 例如：去除文本中的html标签，或者将罗马数字转换成阿拉伯数字等。一个字符过滤器可以有<code>零个或者多个</code></p>
<h6 id="tokenizer-1"><a href="#tokenizer-1" class="headerlink" title="tokenizer"></a>tokenizer</h6><blockquote>
<p>简单的说就是将一整段文本拆分成一个个的词。</p>
</blockquote>
<p> 例如拆分英文，通过空格能将句子拆分成一个个的词，但是对于中文来说，无法使用这种方式来实现。在一个分词器中,<code>有且只有一个</code>tokenizeer</p>
<h6 id="token-filters-1"><a href="#token-filters-1" class="headerlink" title="token filters"></a>token filters</h6><blockquote>
<p>将切分的单词添加、删除或者改变</p>
</blockquote>
<p> 例如将所有英文单词小写，或者将英文中的停词<code>a</code>删除等，在<code>token filters</code>中，不允许将<code>token(分出的词)</code>的<code>position</code>或者<code>offset</code>改变。同时，在一个分词器中，可以有零个或者多个<code>token filters</code>.</p>
<h5 id="分词顺序-1"><a href="#分词顺序-1" class="headerlink" title="分词顺序"></a>分词顺序</h5><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch233.png" alt="图片"></p>
<p> 同时 Analyzer 三个部分也是有顺序的，从图中可以看出，从上到下依次经过 <code>Character Filters</code>，<code>Tokenizer</code> 以及 <code>Token Filters</code>，这个顺序比较好理解，一个文本进来肯定要先对文本数据进行处理，再去分词，最后对分词的结果进行过滤。</p>
<h5 id="索引和搜索分词"><a href="#索引和搜索分词" class="headerlink" title="索引和搜索分词"></a>索引和搜索分词</h5><blockquote>
<p>文本分词会发生在两个地方：</p>
</blockquote>
<ul>
<li><code>创建索引</code>：当索引文档字符类型为<code>text</code>时，在建立索引时将会对该字段进行分词。</li>
<li><code>搜索</code>：当对一个<code>text</code>类型的字段进行全文检索时，会对用户输入的文本进行分词。</li>
</ul>
<h5 id="配置分词器"><a href="#配置分词器" class="headerlink" title="配置分词器"></a>配置分词器</h5><blockquote>
<p>默认ES使用<code>standard analyzer</code>，如果默认的分词器无法符合你的要求，可以自己配置</p>
</blockquote>
<h5 id="分词器测试"><a href="#分词器测试" class="headerlink" title="分词器测试"></a>分词器测试</h5><blockquote>
<p>可以通过<code>_analyzer</code>API来测试分词的效果。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 过滤html 标签</span></span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;tokenizer&quot;</span>:<span class="string">&quot;keyword&quot;</span>, <span class="comment">#原样输出</span></span><br><span class="line">	<span class="string">&quot;char_filter&quot;</span>:[<span class="string">&quot;html_strip&quot;</span>], <span class="comment"># 过滤html标签</span></span><br><span class="line">	<span class="string">&quot;text&quot;</span>:<span class="string">&quot;&lt;b&gt;hello world&lt;b&gt;&quot;</span>  <span class="comment"># 输入的文本</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch234.png" alt="image-20220808135231869"></p>
<h4 id="指定分词器"><a href="#指定分词器" class="headerlink" title="指定分词器"></a>指定分词器</h4><h5 id="使用地方"><a href="#使用地方" class="headerlink" title="使用地方"></a>使用地方</h5><blockquote>
<p>分词器的使用地方有两个：</p>
</blockquote>
<ul>
<li>创建索引时</li>
<li>进行搜索时</li>
</ul>
<h5 id="创建索引时指定分词器-1"><a href="#创建索引时指定分词器-1" class="headerlink" title="创建索引时指定分词器"></a>创建索引时指定分词器</h5><blockquote>
<p>如果设置手动设置了分词器，ES将按照下面顺序来确定使用哪个分词器：</p>
</blockquote>
<ul>
<li>先判断字段是否有设置分词器，如果有，则使用字段属性上的分词器设置</li>
<li>如果设置了<code>analysis.analyzer.default</code>，则使用该设置的分词器</li>
<li>如果上面两个都未设置，则使用默认的<code>standard</code>分词器</li>
</ul>
<h6 id="字段指定分词器-1"><a href="#字段指定分词器-1" class="headerlink" title="字段指定分词器"></a>字段指定分词器</h6><blockquote>
<p>为title属性指定分词器</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>:<span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;whitespace&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="设置默认分词器-1"><a href="#设置默认分词器-1" class="headerlink" title="设置默认分词器"></a>设置默认分词器</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;analyzer&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;default&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>:<span class="string">&quot;simple&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="搜索时如何确定分词器"><a href="#搜索时如何确定分词器" class="headerlink" title="搜索时如何确定分词器"></a>搜索时如何确定分词器</h5><blockquote>
<p>在搜索时，通过下面参数依次检查搜索时使用的分词器：</p>
</blockquote>
<ul>
<li>搜索时指定<code>analyzer</code>参数</li>
<li>创建mapping时指定字段的<code>search_analyzer</code>属性</li>
<li>创建索引时指定<code>setting</code>的<code>analysis.analyzer.default_search</code></li>
<li>查看创建索引时字段指定的<code>analyzer</code>属性</li>
<li>如果上面几种都未设置，则使用默认的<code>standard</code>分词器。</li>
</ul>
<h6 id="指定analyzer-1"><a href="#指定analyzer-1" class="headerlink" title="指定analyzer"></a>指定analyzer</h6><blockquote>
<p>搜索时指定analyzer查询参数</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;message&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;Quick foxes&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;stop&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="指定字段analyzer-1"><a href="#指定字段analyzer-1" class="headerlink" title="指定字段analyzer"></a>指定字段analyzer</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>:<span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;whitespace&quot;</span>,</span><br><span class="line">        <span class="string">&quot;search_analyzer&quot;</span>: <span class="string">&quot;simple&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="指定默认default-seach-1"><a href="#指定默认default-seach-1" class="headerlink" title="指定默认default_seach"></a>指定默认default_seach</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;analyzer&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;default&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>:<span class="string">&quot;simple&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;default_seach&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>:<span class="string">&quot;whitespace&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="内置分词器-1"><a href="#内置分词器-1" class="headerlink" title="内置分词器"></a>内置分词器</h4><blockquote>
<p>es在索引文档时，会通过各种类型 <code>Analyzer</code> 对text类型字段做分析，</p>
</blockquote>
<p> 不同的 <code>Analyzer</code> 会有不同的分词结果，内置的分词器有以下几种，基本上内置的 <code>Analyzer</code> 包括 <code>Language Analyzers</code> 在内，对中文的分词都不够友好，中文分词需要安装其它 <code>Analyzer</code></p>
<table>
<thead>
<tr>
<th>分析器</th>
<th>描述</th>
<th>分词对象</th>
<th>结果</th>
</tr>
</thead>
<tbody><tr>
<td>standard</td>
<td>标准分析器是默认的分析器，如果没有指定，则使用该分析器。它提供了基于文法的标记化(基于 Unicode 文本分割算法，如 Unicode 标准附件 # 29所规定) ，并且对大多数语言都有效。</td>
<td>The 2 QUICK Brown-Foxes jumped over the lazy dog’s bone.</td>
<td>[ the, 2, quick, brown, foxes, jumped, over, the, lazy, dog’s, bone ]</td>
</tr>
<tr>
<td>simple</td>
<td>简单分析器将文本分解为任何非字母字符的标记，如数字、空格、连字符和撇号、放弃非字母字符，并将大写字母更改为小写字母。</td>
<td>The 2 QUICK Brown-Foxes jumped over the lazy dog’s bone.</td>
<td>[ the, quick, brown, foxes, jumped, over, the, lazy, dog, s, bone ]</td>
</tr>
<tr>
<td>whitespace</td>
<td>空格分析器在遇到空白字符时将文本分解为术语</td>
<td>The 2 QUICK Brown-Foxes jumped over the lazy dog’s bone.</td>
<td>[ The, 2, QUICK, Brown-Foxes, jumped, over, the, lazy, dog’s, bone. ]</td>
</tr>
<tr>
<td>stop</td>
<td>停止分析器与简单分析器相同，但增加了删除停止字的支持。默认使用的是 <code>_english_</code> 停止词。</td>
<td>The 2 QUICK Brown-Foxes jumped over the lazy dog’s bone.</td>
<td>[ quick, brown, foxes, jumped, over, lazy, dog, s, bone ]</td>
</tr>
<tr>
<td>keyword</td>
<td>不分词，把整个字段当做一个整体返回</td>
<td>The 2 QUICK Brown-Foxes jumped over the lazy dog’s bone.</td>
<td>[The 2 QUICK Brown-Foxes jumped over the lazy dog’s bone.]</td>
</tr>
<tr>
<td>pattern</td>
<td>模式分析器使用正则表达式将文本拆分为术语。正则表达式应该匹配令牌分隔符，而不是令牌本身。正则表达式默认为 <code>w+</code> (或所有非单词字符)。</td>
<td>The 2 QUICK Brown-Foxes jumped over the lazy dog’s bone.</td>
<td>[ the, 2, quick, brown, foxes, jumped, over, the, lazy, dog, s, bone ]</td>
</tr>
<tr>
<td>多种西语系 arabic, armenian, basque, bengali, brazilian, bulgarian, catalan, cjk, czech, danish, dutch, english等等</td>
<td>一组旨在分析特定语言文本的分析程序。</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="中文扩展分析器"><a href="#中文扩展分析器" class="headerlink" title="中文扩展分析器"></a>中文扩展分析器</h4><blockquote>
<p>中文分词器最简单的是ik分词器，还有jieba分词，哈工大分词器等</p>
</blockquote>
<table>
<thead>
<tr>
<th>分词器</th>
<th>描述</th>
<th>分词对象</th>
<th>结果</th>
</tr>
</thead>
<tbody><tr>
<td>ik_smart</td>
<td>ik分词器中的简单分词器，支持自定义字典，远程字典</td>
<td>学如逆水行舟，不进则退</td>
<td>[学如逆水行舟,不进则退]</td>
</tr>
<tr>
<td>ik_max_word</td>
<td>ik_分词器的全量分词器，支持自定义字典，远程字典</td>
<td>学如逆水行舟，不进则退</td>
<td>[学如逆水行舟,学如逆水,逆水行舟,逆水,行舟,不进则退,不进,则,退]</td>
</tr>
</tbody></table>
<h3 id="词语分词"><a href="#词语分词" class="headerlink" title="词语分词"></a>词语分词</h3><h4 id="标准分词器（Standard-Tokenizer）"><a href="#标准分词器（Standard-Tokenizer）" class="headerlink" title="标准分词器（Standard Tokenizer）"></a>标准分词器（Standard Tokenizer）</h4><blockquote>
<p>根据standardUnicode文本分段算法的定义，将文本划分为多个单词边界的上的术语</p>
</blockquote>
<p> 它是 ES <strong>默认的分词器</strong>，它会对输入的文本<strong>按词的方式进行切分</strong>，切分好以后会进行<strong>转小写</strong>处理，<strong>默认的 stopwords 是关闭的</strong>。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch235.png" alt="图片"></p>
<h5 id="使用案例-8"><a href="#使用案例-8" class="headerlink" title="使用案例"></a>使用案例</h5><blockquote>
<p>下面使用 Kibana 看一下它是怎么样进行工作的</p>
</blockquote>
<h6 id="原始内容-2"><a href="#原始内容-2" class="headerlink" title="原始内容"></a><strong>原始内容</strong></h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">In 2020, Java is the best language in the world.</span><br></pre></td></tr></table></figure>

<h6 id="测试分词-7"><a href="#测试分词-7" class="headerlink" title="测试分词"></a>测试分词</h6><blockquote>
<p>在 Kibana 的开发工具（Dev Tools）中指定 Analyzer 为 <code>standard</code>，并输入文本 <code>In 2020, Java is the best language in the world.</code>，然后我们运行一下：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>:<span class="string">&quot;In 2020, Java is the best language in the world.&quot;</span>,</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;standard&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch236.png" alt="image-20220808105014779"></p>
<p> 可以看出是按照空格、非字母的方式对输入的文本进行了转换，比如对 <code>Java</code> 做了转小写，对一些停用词也没有去掉，比如 <code>in</code>，其中 <code>token</code> 为分词结果；<code>start_offset</code> 为起始偏移；<code>end_offset</code> 为结束偏移；<code>position</code> 为分词位置。</p>
<h5 id="可配置项"><a href="#可配置项" class="headerlink" title="可配置项"></a>可配置项</h5><table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>max_token_length</td>
<td>最大令牌长度。如果看到令牌超过此长度，则将其max_token_length间隔分割。默认为255。</td>
</tr>
<tr>
<td>stopwords</td>
<td>预定义的停用词列表，例如english或包含停用词列表的数组。默认为none。</td>
</tr>
<tr>
<td>stopwords_path</td>
<td>包含停用词的文件的路径。</td>
</tr>
</tbody></table>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;analyzer&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;my_english_analyzer&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;max_token_length&quot;</span>: 5,</span><br><span class="line">                    <span class="string">&quot;stopwords&quot;</span>: <span class="string">&quot;_english_&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="简单分词器（Letter-Tokenizer）"><a href="#简单分词器（Letter-Tokenizer）" class="headerlink" title="简单分词器（Letter Tokenizer）"></a>简单分词器（Letter Tokenizer）</h4><blockquote>
<p>当simple分析器遇到非字母的字符时，它会将文本划分为多个术语，它小写所有术语，对于中文和亚洲很多国家的语言来说是无用的</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch237.png" alt="图片"></p>
<p> 它只包括了 <code>Lower Case</code> 的 <code>Tokenizer</code>，它会按照<strong>非字母切分</strong>，<strong>非字母的会被去除</strong>，最后对切分好的做<strong>转小写</strong>处理，然后接着用刚才的输入文本，分词器换成 <code>simple</code> 来进行分词，运行结果如下：</p>
<h5 id="使用案例-9"><a href="#使用案例-9" class="headerlink" title="使用案例"></a>使用案例</h5><h6 id="原始内容-3"><a href="#原始内容-3" class="headerlink" title="原始内容"></a>原始内容</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">In 2020, Java is the best language in the world.</span><br></pre></td></tr></table></figure>

<h6 id="测试分词-8"><a href="#测试分词-8" class="headerlink" title="测试分词"></a>测试分词</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>:<span class="string">&quot;In 2020, Java is the best language in the world.&quot;</span>,</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;simple&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch238.png" alt="image-20220808105857762"></p>
<h4 id="空白分词器（Whitespace-Tokenizer）"><a href="#空白分词器（Whitespace-Tokenizer）" class="headerlink" title="空白分词器（Whitespace Tokenizer）"></a>空白分词器（Whitespace Tokenizer）</h4><blockquote>
<p>它非常简单，根据名称也可以看出是<strong>按照空格进行切分</strong>的</p>
</blockquote>
<p> 该whitespace分析仪将文本分为方面每当遇到任何空白字符，和上面的分词器不同，空白分词器默认并不会将内容转换为小写。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch239.png" alt="图片"></p>
<h5 id="使用案例-10"><a href="#使用案例-10" class="headerlink" title="使用案例"></a>使用案例</h5><h6 id="原始内容-4"><a href="#原始内容-4" class="headerlink" title="原始内容"></a>原始内容</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">In 2020, Java is the best language <span class="keyword">in</span> the world.</span><br></pre></td></tr></table></figure>

<h6 id="测试分词-9"><a href="#测试分词-9" class="headerlink" title="测试分词"></a>测试分词</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>:<span class="string">&quot;In 2020, Java is the best language in the world.&quot;</span>,</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;whitespace&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch240.png" alt="image-20220808110235685"></p>
<h4 id="电子邮件分词器（UAX-URL-Email-Tokenizer）"><a href="#电子邮件分词器（UAX-URL-Email-Tokenizer）" class="headerlink" title="电子邮件分词器（UAX URL Email Tokenizer）"></a>电子邮件分词器（UAX URL Email Tokenizer）</h4><blockquote>
<p>此分词器主要是针对email和url地址进行关键内容的标记。</p>
</blockquote>
<h5 id="使用案例-11"><a href="#使用案例-11" class="headerlink" title="使用案例"></a>使用案例</h5><h6 id="原始内容-5"><a href="#原始内容-5" class="headerlink" title="原始内容"></a>原始内容</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;Email me at john.smith@global-international.com&quot;</span><br></pre></td></tr></table></figure>

<h6 id="测试分词-10"><a href="#测试分词-10" class="headerlink" title="测试分词"></a>测试分词</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>:<span class="string">&quot;Email me at john.smith@global-international.com&quot;</span>,</span><br><span class="line">  <span class="string">&quot;tokenizer&quot;</span>: <span class="string">&quot;uax_url_email&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="可配置项-1"><a href="#可配置项-1" class="headerlink" title="可配置项"></a>可配置项</h5><blockquote>
<p><code>max_token_length</code>最大令牌长度。如果看到令牌超过此长度，则将其max_token_length间隔分割。默认为255</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;analyzer&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;my_english_analyzer&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;max_token_length&quot;</span>: 5</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="经典分词器（Classic-Tokenizer）"><a href="#经典分词器（Classic-Tokenizer）" class="headerlink" title="经典分词器（Classic Tokenizer）"></a>经典分词器（Classic Tokenizer）</h4><blockquote>
<p>可对首字母缩写词，公司名称，电子邮件地址和互联网主机名进行特殊处理，但是，这些规则并不总是有效，并且此关键词生成器不适用于英语以外的大多数其他语言</p>
</blockquote>
<h5 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h5><ul>
<li>它最多将标点符号拆分为单词，删除标点符号，但是，不带空格的点被认为是查询关键词的一部分</li>
<li>此分词器可以将邮件地址和URL地址识别为查询的term（词条）</li>
</ul>
<h5 id="使用案例-12"><a href="#使用案例-12" class="headerlink" title="使用案例"></a>使用案例</h5><h6 id="原始内容-6"><a href="#原始内容-6" class="headerlink" title="原始内容"></a>原始内容</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;The 2 QUICK Brown-Foxes jumped over the lazy dog&#x27;s bone.&quot;</span><br></pre></td></tr></table></figure>

<h6 id="测试分词-11"><a href="#测试分词-11" class="headerlink" title="测试分词"></a>测试分词</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>:<span class="string">&quot;The 2 QUICK Brown-Foxes jumped over the lazy dog&#x27;s bone.&quot;</span>,</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;classic&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch241.png" alt="image-20220808111755030"></p>
<h5 id="可配置项-2"><a href="#可配置项-2" class="headerlink" title="可配置项"></a>可配置项</h5><blockquote>
<p><code>max_token_length</code>最大令牌长度。如果看到令牌超过此长度，则将其max_token_length间隔分割。默认为255。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;analyzer&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;my_analyzer&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;tokenizer&quot;</span>: <span class="string">&quot;my_tokenizer&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;tokenizer&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;my_tokenizer&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;classic&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;max_token_length&quot;</span>: 5</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="结构化文本分词"><a href="#结构化文本分词" class="headerlink" title="结构化文本分词"></a>结构化文本分词</h3><h4 id="关键词分词器（Keyword-Tokenizer）"><a href="#关键词分词器（Keyword-Tokenizer）" class="headerlink" title="关键词分词器（Keyword Tokenizer）"></a>关键词分词器（Keyword Tokenizer）</h4><blockquote>
<p>它其实不做分词处理，只是将输入作为 Term 输出</p>
</blockquote>
<p> 关键词分词器其实是执行了一个空操作的分析，它将任何输入的文本作为一个单一的关键词输出。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch242.png" alt="图片"></p>
<h5 id="使用案例-13"><a href="#使用案例-13" class="headerlink" title="使用案例"></a>使用案例</h5><h6 id="原始内容-7"><a href="#原始内容-7" class="headerlink" title="原始内容"></a>原始内容</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;In 2020, Java is the best language in the world.&quot;</span><br></pre></td></tr></table></figure>

<h6 id="测试分词-12"><a href="#测试分词-12" class="headerlink" title="测试分词"></a>测试分词</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;:&quot;In 2020, Java is the best language in the world.&quot;,</span><br><span class="line">  &quot;analyzer&quot;: &quot;keyword&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>会发现前后内容根本没有发生改变，这也是这个分词器的作用，有些时候我们针对一个需要分词查询的字段进行查询的时候，可能并不希望查询条件被分词，这个时候就可以使用这个分词器，整个查询条件作为一个关键词使用</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch243.png" alt="image-20220808112235674"></p>
<h4 id="正则分词器（Pattern-Tokenizer）"><a href="#正则分词器（Pattern-Tokenizer）" class="headerlink" title="正则分词器（Pattern Tokenizer）"></a>正则分词器（Pattern Tokenizer）</h4><blockquote>
<p>模式标记器使用 Java正则表达式。使用JAVA的正则表达式进行词语的拆分。</p>
</blockquote>
<p> 它可以通过<strong>正则表达式的方式进行分词</strong>，默认是用 <code>\W+</code> 进行分割的，也就是非字母的符合进行切分的。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch244.png" alt="图片"></p>
<h5 id="使用案例-14"><a href="#使用案例-14" class="headerlink" title="使用案例"></a>使用案例</h5><h6 id="原始内容-8"><a href="#原始内容-8" class="headerlink" title="原始内容"></a>原始内容</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;In 2020, Java is the best language in the world.&quot;</span><br></pre></td></tr></table></figure>

<h6 id="测试分词-13"><a href="#测试分词-13" class="headerlink" title="测试分词"></a>测试分词</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>:<span class="string">&quot;In 2020, Java is the best language in the world.&quot;</span>,</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;patter&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch245.png" alt="image-20220808112737629"></p>
<h5 id="可配置项-3"><a href="#可配置项-3" class="headerlink" title="可配置项"></a>可配置项</h5><blockquote>
<p>正则分词器有以下的选项</p>
</blockquote>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>pattern</td>
<td>正则表达式</td>
</tr>
<tr>
<td>flags</td>
<td>正则表达式标识</td>
</tr>
<tr>
<td>lowercase</td>
<td>是否使用小写词汇</td>
</tr>
<tr>
<td>stopwords</td>
<td>停止词的列表。</td>
</tr>
<tr>
<td>stopwords_path</td>
<td>定义停止词文件的路径。</td>
</tr>
</tbody></table>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;analyzer&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;my_email_analyzer&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;pattern&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;pattern&quot;</span>: <span class="string">&quot;\\W|_&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;lowercase&quot;</span>: <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="路径分词器（Path-Tokenizer）"><a href="#路径分词器（Path-Tokenizer）" class="headerlink" title="路径分词器（Path Tokenizer）"></a>路径分词器（Path Tokenizer）</h4><blockquote>
<p>可以对文件系统的路径样式的请求进行拆分，返回被拆分各个层级内容。</p>
</blockquote>
<h5 id="使用案例-15"><a href="#使用案例-15" class="headerlink" title="使用案例"></a>使用案例</h5><h6 id="原始内容-9"><a href="#原始内容-9" class="headerlink" title="原始内容"></a>原始内容</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;/one/two/three&quot;</span><br></pre></td></tr></table></figure>

<h6 id="测试分词-14"><a href="#测试分词-14" class="headerlink" title="测试分词"></a>测试分词</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>:<span class="string">&quot;/one/two/three&quot;</span>,</span><br><span class="line">  <span class="string">&quot;tokenizer&quot;</span>:<span class="string">&quot;path_hierarchy&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch246.png" alt="image-20220808113500717"></p>
<h5 id="可配置项-4"><a href="#可配置项-4" class="headerlink" title="可配置项"></a>可配置项</h5><table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>delimiter</td>
<td>用作路径分隔符的字符</td>
</tr>
<tr>
<td>replacement</td>
<td>用于定界符的可选替换字符</td>
</tr>
<tr>
<td>buffer_size</td>
<td>单次读取到术语缓冲区中的字符数。默认为1024。术语缓冲区将以该大小增长，直到所有文本都被消耗完为止。建议不要更改此设置。</td>
</tr>
<tr>
<td>reverse</td>
<td>正向还是反向获取关键词</td>
</tr>
<tr>
<td>skip</td>
<td>要忽略的内容</td>
</tr>
</tbody></table>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;analyzer&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;my_analyzer&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;tokenizer&quot;</span>: <span class="string">&quot;my_tokenizer&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;tokenizer&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;my_tokenizer&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;path_hierarchy&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;delimiter&quot;</span>: <span class="string">&quot;-&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;replacement&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;skip&quot;</span>: 2</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="语言分词（Language-Analyzer）"><a href="#语言分词（Language-Analyzer）" class="headerlink" title="语言分词（Language Analyzer）"></a>语言分词（Language Analyzer）</h4><blockquote>
<p>ES 为不同国家语言的输入提供了 <code>Language Analyzer</code> 分词器，在里面可以指定不同的语言</p>
</blockquote>
<h4 id="支持语种"><a href="#支持语种" class="headerlink" title="支持语种"></a>支持语种</h4><blockquote>
<p>支持如下语种：</p>
</blockquote>
<table>
<thead>
<tr>
<th>关键字</th>
<th>语种</th>
</tr>
</thead>
<tbody><tr>
<td>arabic</td>
<td>美 /ˈærəbɪk/ 阿拉伯语</td>
</tr>
<tr>
<td>armenian</td>
<td>美 /ɑːrˈmiːniən/ 亚美尼亚语</td>
</tr>
<tr>
<td>basque</td>
<td>美 /bæsk,bɑːsk/ 巴斯克语</td>
</tr>
<tr>
<td>bengali</td>
<td>美 /beŋˈɡɑːli/ 孟加拉语</td>
</tr>
<tr>
<td>brazilian</td>
<td>美 /brəˈzɪliən/ 巴西语</td>
</tr>
<tr>
<td>bulgarian</td>
<td>美 /bʌlˈɡeriən/ 保加利亚语</td>
</tr>
<tr>
<td>catalan</td>
<td>美 /ˈkætəlæn/ 加泰罗尼亚语</td>
</tr>
<tr>
<td>cjk</td>
<td>中日韩统一表意文字</td>
</tr>
<tr>
<td>czech</td>
<td>美 /tʃek/ 捷克语</td>
</tr>
<tr>
<td>danish</td>
<td>美 /ˈdeɪnɪʃ/ 丹麦语</td>
</tr>
<tr>
<td>dutch</td>
<td>美 /dʌtʃ/ 荷兰语</td>
</tr>
<tr>
<td>english</td>
<td>美 /ˈɪŋɡlɪʃ/ 英语</td>
</tr>
<tr>
<td>estonian</td>
<td>美 /eˈstoʊniən/ 爱沙尼亚语</td>
</tr>
<tr>
<td>finnish</td>
<td>美 /ˈfɪnɪʃ/ 芬兰语</td>
</tr>
<tr>
<td>french</td>
<td>美 /frentʃ/ 法语</td>
</tr>
<tr>
<td>galician</td>
<td>美 /ɡəˈlɪʃn/ 加里西亚语</td>
</tr>
<tr>
<td>german</td>
<td>美 /ˈdʒɜːrmən/ 德语</td>
</tr>
<tr>
<td>greek</td>
<td>美 /ɡriːk/ 希腊语</td>
</tr>
<tr>
<td>hindi</td>
<td>美 /ˈhɪndi/ 北印度语</td>
</tr>
<tr>
<td>hungarian</td>
<td>美 /hʌŋˈɡeriən/ 匈牙利语</td>
</tr>
<tr>
<td>indonesian</td>
<td>美 /ˌɪndəˈniːʒn/ 印度尼西亚语</td>
</tr>
<tr>
<td>irish</td>
<td>美 /ˈaɪrɪʃ/ 爱尔兰语</td>
</tr>
<tr>
<td>italian</td>
<td>美 /ɪˈtæliən/ 意大利语</td>
</tr>
<tr>
<td>latvian</td>
<td>美 /ˈlætviən/ 拉脱维亚语</td>
</tr>
<tr>
<td>lithuanian</td>
<td>美 /ˌlɪθuˈeɪniən/ 立陶宛语</td>
</tr>
<tr>
<td>norwegian</td>
<td>美 /nɔːrˈwiːdʒən/ 挪威语</td>
</tr>
<tr>
<td>persian</td>
<td>/‘pɜːrʒən/ 波斯语</td>
</tr>
<tr>
<td>portuguese</td>
<td>美 /ˌpɔːrtʃʊˈɡiːz/ 葡萄牙语</td>
</tr>
<tr>
<td>romanian</td>
<td>美 /ro’menɪən/ 罗马尼亚语</td>
</tr>
<tr>
<td>russian</td>
<td>美 /ˈrʌʃn/ 俄语</td>
</tr>
<tr>
<td>sorani</td>
<td>索拉尼语</td>
</tr>
<tr>
<td>spanish</td>
<td>美 /ˈspænɪʃ/ 西班牙语</td>
</tr>
<tr>
<td>swedish</td>
<td>美 /ˈswiːdɪʃ/ 瑞典语</td>
</tr>
<tr>
<td>turkish</td>
<td>美 /ˈtɜːrkɪʃ/ 土耳其语</td>
</tr>
<tr>
<td>thai</td>
<td>美 /taɪ/ 泰语</td>
</tr>
</tbody></table>
<h5 id="使用案例-16"><a href="#使用案例-16" class="headerlink" title="使用案例"></a>使用案例</h5><blockquote>
<p>下面我们使用英语进行分析</p>
</blockquote>
<h6 id="原始内容-10"><a href="#原始内容-10" class="headerlink" title="原始内容"></a>原始内容</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;In 2020, Java is the best language in the world.&quot;</span><br></pre></td></tr></table></figure>

<h6 id="测试分词-15"><a href="#测试分词-15" class="headerlink" title="测试分词"></a>测试分词</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>:<span class="string">&quot;In 2020, Java is the best language in the world.&quot;</span>,</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>:<span class="string">&quot;english&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch247.png" alt="image-20220808114216744"></p>
<h4 id="自定义分词器"><a href="#自定义分词器" class="headerlink" title="自定义分词器"></a>自定义分词器</h4><blockquote>
<p>当内置的分词器无法满足需求时，可以创建<code>custom</code>类型的分词器。</p>
</blockquote>
<h5 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h5><table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>tokenizer</td>
<td>内置或定制的tokenizer.(必须)</td>
</tr>
<tr>
<td>char_filter</td>
<td>内置或定制的char_filter(非必须)</td>
</tr>
<tr>
<td>filter</td>
<td>内置或定制的token filter(非必须)</td>
</tr>
<tr>
<td>position_increment_gap</td>
<td>当值为文本数组时，设置改值会在文本的中间插入假空隙。设置该属性，对与后面的查询会有影响。默认该值为100.</td>
</tr>
</tbody></table>
<h5 id="创建索引-2"><a href="#创建索引-2" class="headerlink" title="创建索引"></a>创建索引</h5><blockquote>
<p>上面的示例中定义了一个名为<code>my_custom_analyzer</code>的分词器</p>
</blockquote>
<p> 该分词器的<code>type</code>为<code>custom</code>，<code>tokenizer</code>为<code>standard</code>，<code>char_filter</code>为<code>hmtl_strip</code>,<code>filter</code>定义了两个分别为：<code>lowercase</code>和<code>asciifolding</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;analyzer&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;my_custom_analyzer&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>:<span class="string">&quot;custom&quot;</span>,</span><br><span class="line">          <span class="string">&quot;tokenizer&quot;</span>:<span class="string">&quot;standard&quot;</span>,</span><br><span class="line">          <span class="string">&quot;char_filter&quot;</span>:[<span class="string">&quot;html_strip&quot;</span>],</span><br><span class="line">          <span class="string">&quot;filter&quot;</span>:[<span class="string">&quot;lowercase&quot;</span>,<span class="string">&quot;asciifolding&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="使用案例-17"><a href="#使用案例-17" class="headerlink" title="使用案例"></a>使用案例</h5><h6 id="原始内容-11"><a href="#原始内容-11" class="headerlink" title="原始内容"></a>原始内容</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Is this &lt;b&gt;déjà vu&lt;/b&gt;?</span><br></pre></td></tr></table></figure>

<h6 id="测试分词-16"><a href="#测试分词-16" class="headerlink" title="测试分词"></a>测试分词</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">POST my_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;Is this &lt;b&gt;déjà vu&lt;/b&gt;?&quot;</span>,</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;my_custom_analyzer&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch248.png" alt="image-20220808140137712"></p>
<h3 id="中文分词器-2"><a href="#中文分词器-2" class="headerlink" title="中文分词器"></a>中文分词器</h3><h4 id="IKAnalyzer-3"><a href="#IKAnalyzer-3" class="headerlink" title="IKAnalyzer"></a>IKAnalyzer</h4><blockquote>
<p>IKAnalyzer是一个开源的，基于java的语言开发的轻量级的中文分词工具包</p>
</blockquote>
<p> 从2006年12月推出1.0版开始，IKAnalyzer已经推出了3个大版本，在 2012 版本中，IK 实现了简单的分词歧义排除算法，标志着 IK 分词器从单纯的词典分词向模拟语义分词衍化</p>
<h4 id="使用IK分词器-3"><a href="#使用IK分词器-3" class="headerlink" title="使用IK分词器"></a>使用IK分词器</h4><blockquote>
<p>IK提供了两个分词算法:</p>
</blockquote>
<ul>
<li>ik_smart：最少切分。</li>
<li>ik_max_word：最细粒度划分。</li>
</ul>
<h4 id="ik-smart-3"><a href="#ik-smart-3" class="headerlink" title="ik_smart"></a>ik_smart</h4><h5 id="使用案例-18"><a href="#使用案例-18" class="headerlink" title="使用案例"></a>使用案例</h5><h6 id="原始内容-12"><a href="#原始内容-12" class="headerlink" title="原始内容"></a>原始内容</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">传智教育的教学质量是杠杠的</span><br></pre></td></tr></table></figure>

<h6 id="测试分词-17"><a href="#测试分词-17" class="headerlink" title="测试分词"></a>测试分词</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;传智教育的教学质量是杠杠的&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch249.png" alt="image-20220808115450647"></p>
<h4 id="ik-max-word-3"><a href="#ik-max-word-3" class="headerlink" title="ik_max_word"></a>ik_max_word</h4><h5 id="使用案例-19"><a href="#使用案例-19" class="headerlink" title="使用案例"></a>使用案例</h5><h6 id="原始内容-13"><a href="#原始内容-13" class="headerlink" title="原始内容"></a>原始内容</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">传智教育的教学质量是杠杠的</span><br></pre></td></tr></table></figure>

<h6 id="测试分词-18"><a href="#测试分词-18" class="headerlink" title="测试分词"></a>测试分词</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;传智教育的教学质量是杠杠的&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch250.png" alt="image-20220808115513668"></p>
<h4 id="自定义词库-2"><a href="#自定义词库-2" class="headerlink" title="自定义词库"></a>自定义词库</h4><blockquote>
<p>我们在使用IK分词器时会发现其实有时候分词的效果也并不是我们所期待的</p>
</blockquote>
<h5 id="问题描述-2"><a href="#问题描述-2" class="headerlink" title="问题描述"></a>问题描述</h5><p> 例如我们输入“传智教育的教学质量是杠杠的”，但是分词器会把“传智教育”进行拆开，分为了“传”，“智”，“教育”，但我们希望的是<strong>“传智教育”可以不被拆开</strong>。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch251.png" alt="image-20220808115543696"></p>
<h5 id="解决方案-3"><a href="#解决方案-3" class="headerlink" title="解决方案"></a>解决方案</h5><blockquote>
<p>对于以上的问题，我们只需要将自己要保留的词，加到我们的分词器的字典中即可</p>
</blockquote>
<h6 id="编辑字典内容-2"><a href="#编辑字典内容-2" class="headerlink" title="编辑字典内容"></a>编辑字典内容</h6><blockquote>
<p>进入elasticsearch目录<code>plugins/ik/config</code>中，创建我们自己的字典文件<code>yixin.dic</code>，并添加内容：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> plugins/ik/config</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;传智教育&quot;</span> &gt; custom.dic</span><br></pre></td></tr></table></figure>

<h6 id="扩展字典-2"><a href="#扩展字典-2" class="headerlink" title="扩展字典"></a>扩展字典</h6><blockquote>
<p>进入我们的elasticsearch目录 ：<code>plugins/ik/config</code>，打开<code>IKAnalyzer.cfg.xml</code>文件，进行如下配置：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vi IKAnalyzer.cfg.xml</span><br><span class="line"><span class="comment">#增加如下内容</span></span><br><span class="line">&lt;entry key=<span class="string">&quot;ext_dict&quot;</span>&gt;custom.dic&lt;/entry&gt;</span><br></pre></td></tr></table></figure>

<h6 id="再次测试-2"><a href="#再次测试-2" class="headerlink" title="再次测试"></a>再次测试</h6><blockquote>
<p>重启ElasticSearch，再次使用kibana测试</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;传智教育的教学质量是杠杠的&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以发现，现在我们的词汇”传智教育”就不会被拆开了，达到我们想要的效果了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch252.png" alt="image-20220808134046401"></p>
<h2 id="ElasticSearch-分布式文档"><a href="#ElasticSearch-分布式文档" class="headerlink" title="ElasticSearch 分布式文档"></a>ElasticSearch 分布式文档</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch001.png" alt="img"></p>
<h3 id="分布式文档原理"><a href="#分布式文档原理" class="headerlink" title="分布式文档原理"></a>分布式文档原理</h3><blockquote>
<p>下面我们讲解下文档搜索的原理</p>
</blockquote>
<h4 id="索引的路由计算"><a href="#索引的路由计算" class="headerlink" title="索引的路由计算"></a>索引的路由计算</h4><blockquote>
<p>当索引一个文档的时候，文档会被存储到一个主分片中， Elasticsearch如何知道一个文档应该存放到哪个分片中呢？</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch055.png" alt="image-20220818141552988"></p>
<p> 首先这肯定不会是随机的，<strong>否则将来要获取文档的时候我们就不知道从何处寻找了</strong>，实际上，这个过程是根据下面这个算法决定的：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">shard = hash(routing) % number_of_primary_shards</span><br></pre></td></tr></table></figure>

<ul>
<li>routing值是一个任意字符串，它默认是<code>_id</code>，但也可以自定义。</li>
<li>这个routing字符串通过哈希函数生成一个数字，然后除以主切片的数量得到一个余数(remainder)，余数的范围永远是0到<code>number_of_primary_shards - 1</code>，这个数字就是特定文档所在的分片。</li>
</ul>
<h5 id="注意事项-2"><a href="#注意事项-2" class="headerlink" title="注意事项"></a>注意事项</h5><blockquote>
<p>通过上面的公式，我们理解并且也需要记住一个重要的规律</p>
</blockquote>
<p> 创建索引的时候就确定好主分片的数量，并且永远不会改变这个数量，数量的改变将导致上述公式的结果变化，最终会导致我们的数据无法被找到。</p>
<h4 id="文档的写操作"><a href="#文档的写操作" class="headerlink" title="文档的写操作"></a>文档的写操作</h4><blockquote>
<p>新建、索引和删除请求都是写(write)操作，它们必须在主分片上成功完成才能复制到相关的复制分片上</p>
</blockquote>
<p> 下图是数据写入<code>P0</code>主分片的过程，master在这里起到一个协调节点的作用</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch056.png" alt="image-20220815140547535"></p>
<h5 id="详细步骤"><a href="#详细步骤" class="headerlink" title="详细步骤"></a>详细步骤</h5><blockquote>
<p>下面我们罗列在主分片和复制分片上成功新建、索引或删除一个文档必要的顺序步骤：</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch145.png" alt="image-20210723225436084"></p>
<ol>
<li>客户端给 Node 1 发送新建、索引或删除请求。</li>
<li>节点使用文档的<code>_id</code>确定文档属于分片0，它转发请求到 Node 3 ，分片0位于这个节点上。</li>
<li>Node 3 在主分片上执行请求</li>
<li>Node 3保存文档，将数据保存到主分片</li>
<li>保存成功后，它转发请求到相应的位于 Node 1 和 Node 2 的复制节点上</li>
<li>当所有的复制节点报告成功， Node 3 报告成功到请求的节点</li>
<li>请求的节点再报告给客户端，客户端接收到成功响应的时候，文档的修改已经被应用于主分片和所有的复制分片</li>
</ol>
<h5 id="注意事项-3"><a href="#注意事项-3" class="headerlink" title="注意事项"></a>注意事项</h5><p> 把文档存储写入到<code>primary shard</code>，如果设置了<code>index.write.wait_for_active_shards=1</code>，那么写完主节点，直接返回客户端，如果 <code>index.write.wait_for_active_shards=all</code>，那么必须要把所有的副本写入完成才返回客户端</p>
<h6 id="实验验证"><a href="#实验验证" class="headerlink" title="实验验证"></a>实验验证</h6><blockquote>
<p>创建一个customer的索引</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT /customer</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;number_of_shards&quot;</span>: 1,</span><br><span class="line">      <span class="string">&quot;number_of_replicas&quot;</span>: 2,</span><br><span class="line">      <span class="string">&quot;write.wait_for_active_shards&quot;</span>: <span class="string">&quot;all&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>写入一条数据</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">POST customer/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>:<span class="string">&quot;张三&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>暂时node2节点</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker pause node-2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>再尝试写入，发现写入阻塞，一直等到我们恢复node2节点</p>
</blockquote>
<h4 id="搜索文档-单个"><a href="#搜索文档-单个" class="headerlink" title="搜索文档(单个)"></a>搜索文档(单个)</h4><blockquote>
<p>我们根据文档ID查询的时候ES是如何搜索到我们的文档的呢？</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch057.png" alt="image-20220815140547535"></p>
<h5 id="详细步骤-1"><a href="#详细步骤-1" class="headerlink" title="详细步骤"></a>详细步骤</h5><blockquote>
<p>下面我们罗列在主分片或复制分片上检索一个文档必要的顺序步骤：</p>
</blockquote>
<ol>
<li>客户端给 Node 1 发送get请求。</li>
<li>节点使用文档的<code> _id</code>确定文档属于分片0，对应的复制分片在三个节点上都有，此时它转发请求到Node2</li>
<li>Node 2 返回文档(document)给 Node 1 然后返回给客户端</li>
</ol>
<h5 id="注意事项-4"><a href="#注意事项-4" class="headerlink" title="注意事项"></a>注意事项</h5><blockquote>
<p>对于读请求，为了平衡负载，请求节点会为每个请求选择不同的分片——它会循环所有分片副本</p>
</blockquote>
<p> 一个被索引的文档已经存在于主分片上却还没来得及同步到副本分片上，这时副本分片会报告文档未找到，如果查询主分片则会成功返回文档，这种情况下会产生读写不一致的情况</p>
<p> 由于可能存在primary shard的数据还没同步到 replica shard上的情况，所以客户端可能查询到旧的数据，我们可以做相应的调整，保证读取到最新的数据。</p>
<h4 id="更新文档-单个"><a href="#更新文档-单个" class="headerlink" title="更新文档(单个)"></a>更新文档(单个)</h4><blockquote>
<p>更新文档，必须先定位到主分片，修改文档后，再次同步到其他副本中才算完成</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch058.png" alt="image-20220815140547535"></p>
<h5 id="详细步骤-2"><a href="#详细步骤-2" class="headerlink" title="详细步骤"></a>详细步骤</h5><blockquote>
<p>以下是部分更新一个文档的步骤：</p>
</blockquote>
<ol>
<li>客户端向 <code>Node 1</code> 发送更新请求，发现主分片在<code>Node 3</code></li>
<li>它将请求转发到主分片所在的 <code>Node 3</code></li>
<li><code>Node 3</code> 从主分片检索文档，修改 <code>_source</code> 字段中的 JSON ，并且尝试重新索引主分片的文档， 如果文档已经被另一个进程修改，它会重试步骤 3 ，超过 <code>retry_on_conflict</code> 次后放弃。</li>
<li>如果 <code>Node 3</code> 成功地更新文档，它将新版本的文档并行转发到 <code>Node 1</code> 和 <code>Node 2</code> 上的副本分片，重新建立索引， 一旦所有副本分片都返回成功， <code>Node 3</code> 向协调节点也返回成功，协调节点向客户端返回成功。</li>
</ol>
<h6 id="文档复制"><a href="#文档复制" class="headerlink" title="文档复制"></a>文档复制</h6><blockquote>
<p>当主分片把更改转发到副本分片时， 它不会转发更新请求，相反，它转发完整文档的新版本</p>
</blockquote>
<p> 注意，这些更改将会异步转发到副本分片，并且不能保证它们以发送它们相同的顺序到达，如果Elasticsearch仅转发更改请求，则可能导致更新顺序错误，导致文档更新结果错误。</p>
<h4 id="全文搜索-1"><a href="#全文搜索-1" class="headerlink" title="全文搜索"></a>全文搜索</h4><blockquote>
<p>对于全文搜索而言，文档可能分散在各个节点上，那么在分布式的情况下，如何搜索文档呢？<br>搜索，分为2个阶段，搜索（query）+取回（fetch）</p>
</blockquote>
<h5 id="搜索（query）"><a href="#搜索（query）" class="headerlink" title="搜索（query）"></a>搜索（query）</h5><blockquote>
<p>在初始 <code>查询阶段</code> 时， 查询会广播到索引中每一个分片拷贝（主分片或者副本分片）, 每个分片在本地执行搜索并构建一个匹配文档的 优先队列。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch059.png" alt="image-20220815140547535"></p>
<h6 id="详细步骤-3"><a href="#详细步骤-3" class="headerlink" title="详细步骤"></a>详细步骤</h6><blockquote>
<p>查询阶段包含以下三步：</p>
</blockquote>
<ul>
<li>客户端发送一个 search（搜索） 请求发送给 <code>Node 3</code> , 他会创建了一个长度为<code> from+size</code> 的空优先级队</li>
<li><code>Node 3</code> 转发这个搜索请求到索引中每个分片的主分片或副本分片，每个分片在本地执行这个该查询并且结果将结果存储到一个大小为<code>from+size</code>的本地有序优先队列里去。</li>
<li>每个分片返回<code>document</code>的<code>ID</code>和该节点优先队列里的所有<code>document</code>的排序值给协调节点 <code>Node 3</code>，而<code>Node 3</code> 会把这些值合并到自己的优先队列里产生全局排序结果。</li>
</ul>
<h6 id="什么是优先级队列"><a href="#什么是优先级队列" class="headerlink" title="什么是优先级队列"></a>什么是优先级队列</h6><blockquote>
<p>一个 <code>优先队列</code> 仅仅是一个存有 <code>top-n</code> 匹配文档的有序列表，优先队列的大小取决于分页参数 <code>from</code> 和 <code>size</code>，如下搜索请求将需要足够大的优先队列来放入100条文档</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;from&quot;</span>: 90,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="注意事项-5"><a href="#注意事项-5" class="headerlink" title="注意事项"></a>注意事项</h6><blockquote>
<p>当一个搜索请求被发送到某个节点时，这个节点就变成了协调节点</p>
</blockquote>
<p> 这个节点的任务是广播查询请求到所有相关分片并将它们的响应整合成全局排序后的结果集合，这个结果集合会返回给客户端。</p>
<p> 第一步是广播请求到索引中每一个节点的分片拷贝， 查询请求可以被某个主分片或某个副本分片处理，这就是为什么更多的副本（当结合更多的硬件）能够增加搜索吞吐率， 协调节点将在之后的请求中轮询所有的分片来分摊负载。</p>
<p> 每个分片在本地执行查询请求并且创建一个长度为 <code>from + size</code> 的本地优先队列，也就是说，每个分片创建的结果集足够大，均可以满足全局的搜索请求，分片返回一个轻量级的结果列表到协调节点，它仅包含文档 ID 集合以及任何排序需要用到的值，例如 <code>_score</code></p>
<p> 协调节点将这些分片级的结果合并到自己的有序优先队列里，它代表了全局排序结果集合，至此查询过程结束。</p>
<h5 id="取回（fetch）"><a href="#取回（fetch）" class="headerlink" title="取回（fetch）"></a>取回（fetch）</h5><blockquote>
<p>查询阶段标识哪些文档满足搜索请求，但是我们仍然需要取回这些文档</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch060.png" alt="image-20220815140547535"></p>
<h6 id="详细步骤-4"><a href="#详细步骤-4" class="headerlink" title="详细步骤"></a>详细步骤</h6><blockquote>
<p>分发阶段由以下步骤构成：</p>
</blockquote>
<ol>
<li>协调节点辨别出哪个<code>document</code>需要取回，并且向相关分片发出 <code>GET</code> 请求。</li>
<li>每个分片加载<code>document</code>并且根据需要丰富它们，然后再将<code>document</code>返回协调节点。</li>
<li>一旦所有的<code>document</code>都被取回，协调节点会将结果返回给客户端。</li>
</ol>
<h6 id="注意事项-6"><a href="#注意事项-6" class="headerlink" title="注意事项"></a>注意事项</h6><blockquote>
<p>协调节点首先决定哪些文档<code>确实</code>需要被取回。</p>
</blockquote>
<p> 例如，如果我们的查询指定了 <code>&#123; &quot;from&quot;: 90, &quot;size&quot;: 10 &#125;</code> ，最初的90个结果会被丢弃，只有从第91个开始的10个结果需要被取回，这些文档可能来自和最初搜索请求有关的一个或者多个甚至全部分片。</p>
<p> 协调节点给持有相关文档的每个分片创建一个 <code>multi-get request</code> ，并发送请求给同样处理查询阶段的分片副本</p>
<h3 id="路由机制"><a href="#路由机制" class="headerlink" title="路由机制"></a>路由机制</h3><blockquote>
<p>假设你有一个100个分片的索引，当一个请求在集群上执行时会发生什么呢？</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch061.png" alt="image-20220818142448861"></p>
<ol>
<li>这个搜索的请求会被发送到一个节点</li>
<li>接收到这个请求的节点，将这个查询广播到这个索引的每个分片上（可能是主分片，也可能是复本分片）</li>
<li>每个分片执行这个搜索查询并返回结果</li>
<li>结果在通道节点上合并、排序并返回给用户</li>
</ol>
<h4 id="为什么使用路由"><a href="#为什么使用路由" class="headerlink" title="为什么使用路由"></a>为什么使用路由</h4><p> 因为默认情况下，Elasticsearch使用文档的ID（类似于关系数据库中的自增ID），如果插入数据量比较大，文档会平均的分布于所有的分片上，如果不按照分片键进行搜索会导致了Elasticsearch不能确定文档的位置，<strong>所以它必须将这个请求广播到所有的N个分片上去执行</strong> 这种操作会给集群带来负担，增大了网络的开销。</p>
<p> 如果你根本就不使用路由，Elasticsearch将确保你的文档以均衡的方式分布在所有不同的分片中，那么为什么还需要使用路由？定制路由允许你将同一个路由值得多篇文档归集到某一个分片中，而一旦这些文档放入到同一索引中，就可以路由某些查询，让它们可以在索引分片得子集中执行（简而言之：根据指定的散列值决定相关文档放在哪些分片上），类似于分库分表的路由键的概念。</p>
<h4 id="路由查询"><a href="#路由查询" class="headerlink" title="路由查询"></a>路由查询</h4><blockquote>
<p>下面我们演示以下路由的使用</p>
</blockquote>
<h5 id="普通查询"><a href="#普通查询" class="headerlink" title="普通查询"></a>普通查询</h5><blockquote>
<p>下面我们介绍下不加路由的查询方式</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET logstash-village-2022.08.22/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;龙苑居住区&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现查询的时候扫描了三个分片</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch062.png" alt="image-20220823170512394"></p>
<h5 id="路由查询-1"><a href="#路由查询-1" class="headerlink" title="路由查询"></a>路由查询</h5><blockquote>
<p>下面我们通过路由的方式进行查询试试，路由查询只需要在请求后面加上路由key即可</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET logstash-village-2022.08.22/_search?routing=routingKey</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;龙苑居住区&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这个路由key可以随意写，默认查询的路由key是<code>_id</code>，现在我们就换成了<code>routingKey</code></p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch063.png" alt="image-20220823173008373"></p>
<blockquote>
<p>这样我们发现，查询只查询了一个分片，这样查询效率会更高，但是我们写入的时候是通过<code>_id</code>写入的，查询的时候通过指定路由键，有些数据会查询不出来的，比如</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET logstash-village-2022.08.22/_search?routing=key</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;龙苑居住区&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样直接搜索是查不到数据的，根据<code>key</code>路由键定位的分片是没有数据的，如何解决呢，就需要写和读都是用相同的路由键，再写入的时候也指定路由键即可</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch064.png" alt="image-20220823173334342"></p>
<h4 id="自定义路由-拓展"><a href="#自定义路由-拓展" class="headerlink" title="自定义路由(拓展)"></a>自定义路由(拓展)</h4><blockquote>
<p>自定义路由的方式非常简单，只需要在插入数据的时候指定路由的key即可，虽然使用简单，但有许多的细节需要注意</p>
</blockquote>
<h5 id="创建索引-3"><a href="#创建索引-3" class="headerlink" title="创建索引"></a>创建索引</h5><blockquote>
<p>先创建一个名为route_test的索引，该索引有3个shard，0个副本</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT route_test/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;number_of_shards&quot;</span>: 3,</span><br><span class="line">    <span class="string">&quot;number_of_replicas&quot;</span>: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch212.png" alt="image-20220818143104755"></p>
<h5 id="查看分片"><a href="#查看分片" class="headerlink" title="查看分片"></a>查看分片</h5><blockquote>
<p>我们接下来查看以下分片信息</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET _cat/shards/route_test?v</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch213.png" alt="image-20220818143323039"></p>
<h5 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h5><blockquote>
<p>接下来我们就需要插入数据</p>
</blockquote>
<h6 id="插入第一条数据"><a href="#插入第一条数据" class="headerlink" title="插入第一条数据"></a>插入第一条数据</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT route_test/_doc/a?refresh</span><br><span class="line">&#123;</span><br><span class="line">  &quot;data&quot;: &quot;A&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch214.png" alt="image-20220818143555965"></p>
<h6 id="查看分片-1"><a href="#查看分片-1" class="headerlink" title="查看分片"></a>查看分片</h6><blockquote>
<p>我们插入数据后再次来查看分片信息</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET _cat/shards/route_test?v</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现我们插入的数据加入了0分片</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch215.png" alt="image-20220818143738070"></p>
<h6 id="插入第二条数据"><a href="#插入第二条数据" class="headerlink" title="插入第二条数据"></a>插入第二条数据</h6><blockquote>
<p>接下来我们插入第二条数据</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT route_test/_doc/b?refresh</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;data&quot;</span>: <span class="string">&quot;B&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch216.png" alt="image-20220818143858893"></p>
<h6 id="查看分片-2"><a href="#查看分片-2" class="headerlink" title="查看分片"></a>查看分片</h6><blockquote>
<p>我们插入数据后再次来查看分片信息</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET _cat/shards/route_test?v</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现我们插入的数据加入了2分片</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch217.png" alt="image-20220818143927397"></p>
<h5 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h5><blockquote>
<p>接下来我们查询数据</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET route_test/_search</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch218.png" alt="image-20220818144055485"></p>
<p> 上面这个例子比较简单，先创建了一个拥有3个shard，0个副本（为了方便观察）的索引<code> route_test</code> ，创建完之后查看两个shard的信息，此时shard为空，里面没有任何文档（<code>docs</code> 列为0）。</p>
<p> 接着我们插入了两条数据，每次插完之后，都检查shard的变化，通过对比可以发现 docid=a 的第一条数据写入了0号shard，docid=b 的第二条数据写入了2号 shard。</p>
<p> 需要注意的是这里的<code>doc_id</code>我选用的是字母”a”和”b”，而非数字，原因是连续的数字很容易路由到一个shard中去，以上的过程就是不指定routing时候的默认行为。</p>
<h5 id="指定路由"><a href="#指定路由" class="headerlink" title="指定路由"></a>指定路由</h5><blockquote>
<p>接着，我们指定routing，看看会发生什么</p>
</blockquote>
<h6 id="插入第三条数据"><a href="#插入第三条数据" class="headerlink" title="插入第三条数据"></a>插入第三条数据</h6><blockquote>
<p>接下来我们插入第三条数据，但是这条数据我们加上一个路由键</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT route_test/_doc/c?routing=key1&amp;refresh</span><br><span class="line">&#123;</span><br><span class="line">  &quot;data&quot;: &quot;C&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch219.png" alt="image-20220818144434570"></p>
<h6 id="查看分片-3"><a href="#查看分片-3" class="headerlink" title="查看分片"></a>查看分片</h6><blockquote>
<p>我们插入数据后再次来查看分片信息</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET _cat/shards/route_test?v</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现我们插入的数据加入了0分片</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch220.png" alt="image-20220818144523326"></p>
<h6 id="查询索引数据"><a href="#查询索引数据" class="headerlink" title="查询索引数据"></a>查询索引数据</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET route_test/_search</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch221.png" alt="image-20220818144817822"></p>
<p> 我们又插入了1条 <code>docid=c</code> 的新数据，但这次我们指定了路由，路由的值是一个字符串”key1”，通过查看shard信息，能看出这条数据路由到了0号shard，也就是说用”key1”做路由时，文档会写入到0号shard。</p>
<h5 id="指定路由插入"><a href="#指定路由插入" class="headerlink" title="指定路由插入"></a>指定路由插入</h5><blockquote>
<p>接着我们使用该路由再插入两条数据，但这两条数据的 docid 分别为之前使用过的 “a”和”b”</p>
</blockquote>
<h6 id="再次插入数据"><a href="#再次插入数据" class="headerlink" title="再次插入数据"></a>再次插入数据</h6><blockquote>
<p>插入 docid=a 的数据，并指定 routing=key1</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT route_test/_doc/a?routing=key1&amp;refresh</span><br><span class="line">&#123;</span><br><span class="line">  &quot;data&quot;: &quot;A with routing key1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意返回的状态为updated，之前的三次插入返回都为created</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch222.png" alt="image-20220818145125688"></p>
<h6 id="查看分片-4"><a href="#查看分片-4" class="headerlink" title="查看分片"></a>查看分片</h6><blockquote>
<p>我们插入数据后再次来查看分片信息</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET _cat/shards/route_test?v</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现分片的数据没有变化</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch223.png" alt="image-20220818145239022"></p>
<h6 id="查询数据-1"><a href="#查询数据-1" class="headerlink" title="查询数据"></a>查询数据</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET route_test/_search</span><br></pre></td></tr></table></figure>

<blockquote>
<p>之前 docid=a 的数据就在0号shard中，这次依旧写入到0号shard中了，因为docid重复，所以文档被更新了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch224.png" alt="image-20220818145327406"></p>
<h6 id="再次插入数据-1"><a href="#再次插入数据-1" class="headerlink" title="再次插入数据"></a>再次插入数据</h6><blockquote>
<p>这次插入 docid=b的数据，使用key1作为路由字段的值</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT route_test/_doc/b?routing=key1&amp;refresh</span><br><span class="line">&#123;</span><br><span class="line">  &quot;data&quot;: &quot;B with routing key1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现这次变成创建了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch225.png" alt="image-20220818153304182"></p>
<h6 id="查看分片信息"><a href="#查看分片信息" class="headerlink" title="查看分片信息"></a>查看分片信息</h6><blockquote>
<p>我们再次查看分片信息</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET _cat/shards/route_test?v</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现数据存储到了0分片中</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch226.png" alt="image-20220818153357325"></p>
<h6 id="查询数据-2"><a href="#查询数据-2" class="headerlink" title="查询数据"></a>查询数据</h6><blockquote>
<p>我们再次来查询数据</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET route_test/_search</span><br></pre></td></tr></table></figure>

<blockquote>
<p>和上面插入<code>docid=a</code> 的那条数据相比，这次这个有些不同，我们来分析一下</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch227.png" alt="image-20220818153547641"></p>
<h5 id="路由带来的问题"><a href="#路由带来的问题" class="headerlink" title="路由带来的问题"></a>路由带来的问题</h5><blockquote>
<p>这个就是我们自定义routing后会导致的一个问题：<strong>docid不再全局唯一</strong></p>
</blockquote>
<p> ES shard的实质是Lucene的索引，所以其实每个shard都是一个功能完善的倒排索引，ES能保证docid全局唯一是采用docid作为了路由，所以同样的docid肯定会路由到同一个shard上面，如果出现docid重复，就会update或者抛异常，从而保证了集群内docid唯一标识一个doc。</p>
<p> 但如果我们换用其它值做routing，那这个就保证不了了，如果用户还需要docid的全局唯一性，那只能自己保证了，因为docid不再全局唯一，所以doc的增删改查API就可能产生问题</p>
<h3 id="索引别名"><a href="#索引别名" class="headerlink" title="索引别名"></a>索引别名</h3><blockquote>
<p>别名，有点类似数据库的视图，别名一般都会和一些过滤条件相结合，可以做到即使是同一个索引上，让不同人看到不同的数据</p>
</blockquote>
<h4 id="别名的作用"><a href="#别名的作用" class="headerlink" title="别名的作用"></a>别名的作用</h4><blockquote>
<p>在开发中，一般随着业务需求的迭代，较老的业务逻辑就要面临更新甚至是重构，对于es来说为了适应新的业务逻辑，就要对原有的索引做一些修改，比如对某些字段做调整</p>
</blockquote>
<p> 而做这些操作的时候，可能会对业务造成影响，甚至是停机调整等问题，因为es提供了索引的别名来解决这个问题，索引的别名就像一个快捷方式或者是软连接，可以指向一个或者多个索引，也可以给任意一个需要索引名的API来使用</p>
<h4 id="别名操作"><a href="#别名操作" class="headerlink" title="别名操作"></a>别名操作</h4><blockquote>
<p>下面我们看下别名的基本操作</p>
</blockquote>
<h5 id="查询别名"><a href="#查询别名" class="headerlink" title="查询别名"></a>查询别名</h5><blockquote>
<p>直接调用<code>_alias</code>API的GET方法可以看到索引的别名</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET logstash-village-2022.08.22/_alias</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们看到现在可以看到当前的索引有一个别名<code>logstash-village</code></p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch065.png" alt="image-20220823174135574"></p>
<h5 id="别名查询"><a href="#别名查询" class="headerlink" title="别名查询"></a>别名查询</h5><blockquote>
<p>我们查询的时候可以指定别名进行查询</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET logstash-village/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;龙苑居住区&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样我们可以通过别名查询出来数据的</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch066.png" alt="image-20220823174353902"></p>
<h5 id="创建别名"><a href="#创建别名" class="headerlink" title="创建别名"></a>创建别名</h5><blockquote>
<p>我们还可以在建立一个别名，别名和索引的关系是多对多的关系，一个索引可以有多个别名，同样一个别名也可以有多个索引</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;actions&quot;</span>: [&#123;</span><br><span class="line">		<span class="string">&quot;add&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;index&quot;</span>: <span class="string">&quot;logstash-village-2022.08.22&quot;</span>,</span><br><span class="line">			<span class="string">&quot;alias&quot;</span>: <span class="string">&quot;logstash-village-1.0&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样我们就创建了一个别名<code>logstash-village-1.0</code></p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch067.png" alt="image-20220823175032009"></p>
<blockquote>
<p>接下来我们直接进行别名查询就好</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET logstash-village-1.0/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;龙苑居住区&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样就检索出来数据了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch068.png" alt="image-20220823175139500"></p>
<h5 id="别名修改"><a href="#别名修改" class="headerlink" title="别名修改"></a>别名修改</h5><blockquote>
<p>有时候还需要修改别名，特别是涉及到索引迁移的时候，修改操作我们可以实现运行中的es集群无缝切换索引，我们可以将索引指向一个新准备的别名中，也可以为别名关联新的索引</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;actions&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;remove&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;logstash-village-2022.08.22&quot;</span>,</span><br><span class="line">        <span class="string">&quot;alias&quot;</span>: <span class="string">&quot;logstash-village-1.0&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;add&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;logstash-village-2022.08.22&quot;</span>,</span><br><span class="line">        <span class="string">&quot;alias&quot;</span>: <span class="string">&quot;logstash-village-2.0&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样我们就可以做到无缝的索引别名修改了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch069.png" alt="image-20220823175759221"></p>
<blockquote>
<p>我们再来查询试试</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET logstash-village-2.0/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;龙苑居住区&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="过滤器别名"><a href="#过滤器别名" class="headerlink" title="过滤器别名"></a>过滤器别名</h4><blockquote>
<p>我们可以创建一个带过滤器的别名，这样别人通过这个别名查询的时候，数据都是筛选过后的数据，起到一个数据权限的作用</p>
</blockquote>
<h5 id="创建别名-1"><a href="#创建别名-1" class="headerlink" title="创建别名"></a>创建别名</h5><blockquote>
<p>下面我们创建一个只能查询河南省房产信息的别名</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;actions&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;add&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;logstash-village-2022.08.22&quot;</span>,</span><br><span class="line">        <span class="string">&quot;alias&quot;</span>: <span class="string">&quot;logstash-village-hn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;province&quot;</span>: <span class="string">&quot;河南省&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样我们就创建了一个只能查询到河南省房产信息的别名<code>logstash-village-hn</code></p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch070.png" alt="image-20220823180303365"></p>
<h5 id="数据查询"><a href="#数据查询" class="headerlink" title="数据查询"></a>数据查询</h5><blockquote>
<p>下面我们通过这个别名查询北京<code>沁春家园</code>的小区信息</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET logstash-village-hn/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;沁春家园&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现根本就查询不出来</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch071.png" alt="image-20220823180840099"></p>
<blockquote>
<p>但是我们查询<code>龙苑居住区</code>却可以查询出来</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch072.png" alt="image-20220823180917355"></p>
<h4 id="路由别名"><a href="#路由别名" class="headerlink" title="路由别名"></a>路由别名</h4><blockquote>
<p>我们上面介绍了路由的使用，但是有一个问题，我们查询的时候都需要携带路由参数，很麻烦，我们可以将我们的路由参数写进别名中，这样查询起来会更加方便</p>
</blockquote>
<h5 id="创建别名-2"><a href="#创建别名-2" class="headerlink" title="创建别名"></a>创建别名</h5><blockquote>
<p>下面我们就创建一个以<code>key</code>为路由键</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;actions&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;add&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;logstash-village-2022.08.22&quot;</span>,</span><br><span class="line">        <span class="string">&quot;alias&quot;</span>: <span class="string">&quot;logstash-village-route_key&quot;</span>,</span><br><span class="line">        <span class="string">&quot;routing&quot;</span>: <span class="string">&quot;key&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样我们就以<code>key</code>为路由键创建了一个索引</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch073.png" alt="image-20220823181302627"></p>
<h5 id="数据查询-1"><a href="#数据查询-1" class="headerlink" title="数据查询"></a>数据查询</h5><blockquote>
<p>下面我们就对索引进行一些查询</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET logstash-village-route_key/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;沁春家园&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们看到查询<code>沁春家园</code>是可以查询出来数据的，但是查询<code>龙苑居住区</code>是查询不出来数据的</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch074.png" alt="image-20220823181922199"></p>
<h4 id="删除别名"><a href="#删除别名" class="headerlink" title="删除别名"></a>删除别名</h4><blockquote>
<p>创建了很多的别名，有时候别名不用了，需要定期删除以下</p>
</blockquote>
<h5 id="查看所有别名"><a href="#查看所有别名" class="headerlink" title="查看所有别名"></a>查看所有别名</h5><blockquote>
<p>现在我们查询以下当前索引下的别名有哪些</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET logstash-village-2022.08.22/_alias</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当前有这么多的别名，我们准备删除一些</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch075.png" alt="image-20220823182128274"></p>
<h5 id="删除别名-1"><a href="#删除别名-1" class="headerlink" title="删除别名"></a>删除别名</h5><blockquote>
<p>删除的时候直接指定别名就可以的</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DELETE logstash-village-2022.08.22/_alias/logstash-village-route_key</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样我们就把当前这个别名删除了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch076.png" alt="image-20220823182544298"></p>
<h4 id="重建索引"><a href="#重建索引" class="headerlink" title="重建索引"></a>重建索引</h4><blockquote>
<p>Elasticsearch使用时间长了后，到了后期可能有各种原因重建索引</p>
</blockquote>
<p> ES是不支持索引字段类型变更的，不可变的原因是一个字段的类型进行修改之后，ES会重新建立对这个字段的索引信息，影响到ES对该字段分词方式，相关度，TF/IDF倒排索引创建等。</p>
<h5 id="索引重建的步骤"><a href="#索引重建的步骤" class="headerlink" title="索引重建的步骤"></a>索引重建的步骤</h5><ol>
<li>创建旧索引</li>
<li>给索引创建别名</li>
<li>向oldindex中插入数据</li>
<li>创建新的索引newindex</li>
<li>重建索引</li>
<li>实现不重启服务索引的切换</li>
</ol>
<h5 id="创建旧索引"><a href="#创建旧索引" class="headerlink" title="创建旧索引"></a>创建旧索引</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT oldindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;double&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch253.png" alt="image-20220913155731290"></p>
<h5 id="添加数据-1"><a href="#添加数据-1" class="headerlink" title="添加数据"></a>添加数据</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">POST oldindex/_doc/_bulk</span><br><span class="line">&#123;<span class="string">&quot;create&quot;</span>:&#123;<span class="string">&quot;_id&quot;</span>:1&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;name 01&quot;</span>,<span class="string">&quot;price&quot;</span>:1&#125;</span><br><span class="line">&#123;<span class="string">&quot;create&quot;</span>:&#123;<span class="string">&quot;_id&quot;</span>:2&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;name 02&quot;</span>,<span class="string">&quot;price&quot;</span>:2&#125;</span><br><span class="line">&#123;<span class="string">&quot;create&quot;</span>:&#123;<span class="string">&quot;_id&quot;</span>:3&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;name 03&quot;</span>,<span class="string">&quot;price&quot;</span>:3&#125;</span><br><span class="line">&#123;<span class="string">&quot;create&quot;</span>:&#123;<span class="string">&quot;_id&quot;</span>:4&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;name 04&quot;</span>,<span class="string">&quot;price&quot;</span>:4&#125;</span><br><span class="line">&#123;<span class="string">&quot;create&quot;</span>:&#123;<span class="string">&quot;_id&quot;</span>:5&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;name 05&quot;</span>,<span class="string">&quot;price&quot;</span>:5&#125;</span><br><span class="line">&#123;<span class="string">&quot;create&quot;</span>:&#123;<span class="string">&quot;_id&quot;</span>:6&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;name 06&quot;</span>,<span class="string">&quot;price&quot;</span>:6&#125;</span><br><span class="line">&#123;<span class="string">&quot;create&quot;</span>:&#123;<span class="string">&quot;_id&quot;</span>:7&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;name 07&quot;</span>,<span class="string">&quot;price&quot;</span>:7&#125;</span><br><span class="line">&#123;<span class="string">&quot;create&quot;</span>:&#123;<span class="string">&quot;_id&quot;</span>:8&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;name 08&quot;</span>,<span class="string">&quot;price&quot;</span>:8&#125;</span><br><span class="line">&#123;<span class="string">&quot;create&quot;</span>:&#123;<span class="string">&quot;_id&quot;</span>:9&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;name 09&quot;</span>,<span class="string">&quot;price&quot;</span>:9&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch254.png" alt="image-20220913161418526"></p>
<h6 id="查询数据-3"><a href="#查询数据-3" class="headerlink" title="查询数据"></a>查询数据</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET oldindex/_search</span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch255.png" alt="image-20220913161458379"></p>
<h5 id="创建别名-3"><a href="#创建别名-3" class="headerlink" title="创建别名"></a>创建别名</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;actions&quot;</span>: [&#123;</span><br><span class="line">		<span class="string">&quot;add&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;index&quot;</span>: <span class="string">&quot;oldindex&quot;</span>,</span><br><span class="line">			<span class="string">&quot;alias&quot;</span>: <span class="string">&quot;search_index&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch256.png" alt="image-20220913160102734"></p>
<h6 id="查询数据-4"><a href="#查询数据-4" class="headerlink" title="查询数据"></a>查询数据</h6><blockquote>
<p>我们使用别名查询数据</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET search_index/_search</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch257.png" alt="image-20220921151059986"></p>
<h5 id="创建新索引"><a href="#创建新索引" class="headerlink" title="创建新索引"></a>创建新索引</h5><blockquote>
<p>根据需求我们创建一个新的索引，价格字段改为integer类型</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT newindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch258.png" alt="image-20220913161714452"></p>
<h5 id="重建索引-1"><a href="#重建索引-1" class="headerlink" title="重建索引"></a>重建索引</h5><blockquote>
<p>数据量大的话可以异步执⾏，如果 reindex 时间过长，建议加上 <code>wait_for_completion=false</code> 的参数条件，这样<code>reindex</code> 将直接返回<code>taskId</code></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">POST _reindex?wait_for_completion=<span class="literal">false</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;conflicts&quot;</span>: <span class="string">&quot;proceed&quot;</span>, // 如果新的索引中数据冲突，程序继续往下执行，删除则会导致程序会终止</span><br><span class="line">  <span class="string">&quot;source&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>: <span class="string">&quot;oldindex&quot;</span>  // 表示从oldindex中同步数据</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;dest&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>: <span class="string">&quot;newindex&quot;</span>,  // 表示数据插入新索引newindex中</span><br><span class="line">    <span class="string">&quot;op_type&quot;</span>: <span class="string">&quot;create&quot;</span> // 数据插入的类型为创建，如果存在就会版本冲突</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="更多参数"><a href="#更多参数" class="headerlink" title="更多参数"></a>更多参数</h6><blockquote>
<p>更高级的用法可以参考下下面的例子</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">POST _reindex?wait_for_completion=<span class="literal">false</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 5, // 表示只获取5条数据插入到新的索引中</span><br><span class="line">  <span class="string">&quot;conflicts&quot;</span>: <span class="string">&quot;proceed&quot;</span>, // 如果新的索引中数据冲突，程序继续往下执行，删除则会导致程序会终止</span><br><span class="line">  <span class="string">&quot;source&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 2, // 默认情况下，_reindex使用1000进行批量操作，调整批量插入2条</span><br><span class="line">    <span class="string">&quot;index&quot;</span>: <span class="string">&quot;oldindex&quot;</span>, // 表示从oldindex,类型product中查询出price字段的值</span><br><span class="line">    <span class="string">&quot;_source&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;price&quot;</span> //只需要同步price字段</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;gte&quot;</span>: 2,</span><br><span class="line">          <span class="string">&quot;lte&quot;</span>: 8</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;dest&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>: <span class="string">&quot;newindex&quot;</span>,  // 表示数据插入新索引newindex中</span><br><span class="line">    <span class="string">&quot;op_type&quot;</span>: <span class="string">&quot;create&quot;</span> // 数据插入的类型为创建，如果存在就会版本冲突</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch259.png" alt="image-20220913162354222"></p>
<h6 id="查看任务"><a href="#查看任务" class="headerlink" title="查看任务"></a>查看任务</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET _tasks/0f73ybYqQTOc96OmN_PSEw:72228</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch260.png" alt="image-20220913162726180"></p>
<h6 id="取消任务"><a href="#取消任务" class="headerlink" title="取消任务"></a>取消任务</h6><blockquote>
<p>如果任务还没有完成，需要取消任务可以使用如下的命令</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST _tasks/0f73ybYqQTOc96OmN_PSEw:72228/_cancel</span><br></pre></td></tr></table></figure>

<h5 id="别名切换"><a href="#别名切换" class="headerlink" title="别名切换"></a>别名切换</h5><blockquote>
<p>我们需要将别名切换到另刚刚重建的索引上，切换索引可以实现不重启服务索引的切换</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">   <span class="string">&quot;actions&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;remove&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;oldindex&quot;</span>,</span><br><span class="line">        <span class="string">&quot;alias&quot;</span>: <span class="string">&quot;search_index&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;add&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;newindex&quot;</span>,</span><br><span class="line">        <span class="string">&quot;alias&quot;</span>: <span class="string">&quot;search_index&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样就实现了快速索引切换</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch261.png" alt="image-20220913165025568"></p>
<h5 id="删除旧的索引"><a href="#删除旧的索引" class="headerlink" title="删除旧的索引"></a>删除旧的索引</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DELETE oldindex</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch262.png" alt="image-20220913165135993"></p>
<h6 id="查询数据-5"><a href="#查询数据-5" class="headerlink" title="查询数据"></a>查询数据</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET search_index/_search</span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch263.png" alt="image-20220913165215813"></p>
<h2 id="ElasticSearch-集群管理"><a href="#ElasticSearch-集群管理" class="headerlink" title="ElasticSearch 集群管理"></a>ElasticSearch 集群管理</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch001.png" alt="img"></p>
<h3 id="集群模式"><a href="#集群模式" class="headerlink" title="集群模式"></a>集群模式</h3><blockquote>
<p>Elasticsearch节点设计支持多种角色，这个是实现集群最重要的前提，节点角色各司其职，也可以任意组合，职责重合。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch314.png" alt="img"></p>
<h4 id="节点角色说明"><a href="#节点角色说明" class="headerlink" title="节点角色说明"></a>节点角色说明</h4><ul>
<li>Master，集群管理</li>
<li>Voting，投票选举节点</li>
<li>Data，数据节点Ingest，数据编辑节点</li>
<li>Coordinate，协调节点</li>
<li>Machine Learning，集群学习节点</li>
</ul>
<h4 id="单节点"><a href="#单节点" class="headerlink" title="单节点"></a>单节点</h4><blockquote>
<p>单节点模式默认开启所有节点特性，具备一个集群所有节点角色，可以认为是一个进程内部的集群</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch315.png" alt="img"></p>
<p> Elasticsearch在默认情况下，不用任何牌配置也可以运行，这也是它设计的精妙之处，相比其它很多数据产品集群配置，如Mongodb，简化了很多，起步入门容易。</p>
<h4 id="基本高可用"><a href="#基本高可用" class="headerlink" title="基本高可用"></a>基本高可用</h4><blockquote>
<p>elasticsearch集群要达到基本高可用，一般要至少启动3个节点，3个节点互相连接，单个节点包括所有角色，其中任意节点停机集群依然可用，为什么要至少3个节点？因为集群选举算法奇数法则。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch316.png" alt="img"></p>
<h4 id="数据与管理分离"><a href="#数据与管理分离" class="headerlink" title="数据与管理分离"></a>数据与管理分离</h4><blockquote>
<p>Elasticserach管理节点职责是管理集群元数据、索引信息、节点信息等，自身不设计数据存储与查询，资源消耗低；相反数据节点是集群存储与查询的执行节点</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch317.png" alt="img"></p>
<p> 管理节点与数据节点分离，各司其职，任意数据节点故障或者全部数据节点故障，集群仍可用；管理节点一般至少启动3个，任意节点停机，集群仍正常运行。</p>
<h4 id="数据与协调分离"><a href="#数据与协调分离" class="headerlink" title="数据与协调分离"></a>数据与协调分离</h4><blockquote>
<p>Elasticsearch内部执行查询或者更新操作时，需要路由，默认所有节点都具备此职能，特别是大的查询时，协调节点需要分发查询命令到各个数据节点，查询后的数据需要在协调节点合并排序，这样原有数据节点代价很大，所以分离职责</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch318.png" alt="img"></p>
<h4 id="协调读写分离"><a href="#协调读写分离" class="headerlink" title="协调读写分离"></a>协调读写分离</h4><blockquote>
<p>Elasticsearch设置读写分离指的是在协调节点上，不是数据节点上，集群大量的查询需要消耗协调节点很大的内存与CPU合并结果，同时集群大量的数据写入会阻塞协调节点，所以在协调节点上做读写分离很少必要，也很简单，由集群设计搭建时规划好即可。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch319.png" alt="img"></p>
<h4 id="数据节点标签"><a href="#数据节点标签" class="headerlink" title="数据节点标签"></a>数据节点标签</h4><p> Elasticsearch给数据节点标签，目的是分离索引数据的分布，在一个集群规模中等以上，索引数据用途多种多样，对于数据节点的资源需求不一样，数据节点的配置可以差异化，有的数据节点配置高做实时数据查询，有的数据节点配置低做历史数据查询，有的数据节点做专门做索引重建。</p>
<p> Elasticsearch集群部署时需要考虑基础硬件条件，集群规模越来越大，需要多个数据中心，多个网络服务、多个服务器机架，多个交换机等组成，索引数据的分布与这些基础硬件条件都密切相关</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch320.png" alt="img"></p>
<h4 id="主副分片分离"><a href="#主副分片分离" class="headerlink" title="主副分片分离"></a>主副分片分离</h4><blockquote>
<p>Elasticsearch集群规模大了之后得考虑集群容灾，若某个机房出现故障，则可以迅速切换到另外的容灾机房</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch321.png" alt="img"></p>
<h4 id="跨集群操作"><a href="#跨集群操作" class="headerlink" title="跨集群操作"></a>跨集群操作</h4><p> Elasticsearch单个集群规模不能无限增长，理论上可以，实际很危险，通过创建多个分集群分解，集群直接建立直接连接，客户端可以通过一个代理集群访问任意集群，包括代理集群本身数据。</p>
<p> Elasticsearch集群支持异地容灾，采用的是跨集群复制的机制，与同一集群主分片副本分片分离是不同的概念，2个集群完全是独立部署运行，仅数据同步复制。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch322.png" alt="img"></p>
<h4 id="跨集群版本操作"><a href="#跨集群版本操作" class="headerlink" title="跨集群版本操作"></a>跨集群版本操作</h4><p> elasticsearch版本更新很快，已知问题修复很快，新特性新功能推出很快，一日不学，如隔三秋。有的集群数据重要性很高，稳定第一，不能随意升级，有的业务场景刚好需要最新版本新功能新特性支持。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch323.png" alt="img"></p>
<h3 id="集群管理"><a href="#集群管理" class="headerlink" title="集群管理"></a>集群管理</h3><h4 id="集群健康检查"><a href="#集群健康检查" class="headerlink" title="集群健康检查"></a>集群健康检查</h4><blockquote>
<p>Elasticsearch 的集群监控信息中包含了许多的统计数据，其中最为重要的一项就是集群健康 ， 它在 <code>status</code> 字段中展示为 <code>green</code> 、 <code>yellow</code> 或者 <code>red</code></p>
</blockquote>
<h5 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h5><blockquote>
<p>可以通过如下的命令查看集群的状态</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /_cluster/health</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch031.png" alt="image-20220815102706307"></p>
<h6 id="集群状态"><a href="#集群状态" class="headerlink" title="集群状态"></a>集群状态</h6><blockquote>
<p><code>status</code> 字段是我们最关心的，<code>status</code> 字段指示着当前集群在总体上是否工作正常，它的三种颜色含义如下</p>
</blockquote>
<ul>
<li>**<code>green</code>**：所有的主分片和副本分片都正常运行</li>
<li>**<code>yellow</code>**：所有数据可用，但有些副本尚未分配(集群功能完全)</li>
<li>**<code>red</code>**：有主分片没能正常运行。</li>
</ul>
<blockquote>
<p><strong>注意</strong>: 当集群处于红色状态时，正常的分片将继续提供搜索服务，但你可能要尽快修复它。</p>
</blockquote>
<h4 id="分片和副本"><a href="#分片和副本" class="headerlink" title="分片和副本"></a>分片和副本</h4><h5 id="什么是分片"><a href="#什么是分片" class="headerlink" title="什么是分片"></a>什么是分片</h5><blockquote>
<p>因为ES是个分布式的搜索引擎, 所以索引通常都会分解成不同部分, 而这些分布在不同节点的数据就是分片</p>
</blockquote>
<p> 当有大量的文档时，由于内存的限制、磁盘处理能力不足、无法足够快的响应客户端的请求等，一个节点可能不够。这种情况下，数据可以分为较小的分片，每个分片放到不同的服务器上。<br>​ 当你查询的索引分布在多个分片上时，ES会把查询发送给每个相关的分片，并将结果组合在一起，而应用程序并不知道分片的存在，即：这个过程对用户来说是透明的<br>​ ES自动管理和组织分片, 并在必要的时候对分片数据进行再平衡分配, 所以用户基本上不用担心分片的处理细节，一个分片默认最大文档数量是20亿。</p>
<h6 id="分片的意义"><a href="#分片的意义" class="headerlink" title="分片的意义"></a>分片的意义</h6><blockquote>
<p>分片存在的重要原因有以下两个：</p>
</blockquote>
<ul>
<li>允许水平分扩展容量。</li>
<li>允许在分片之上进行分布式的，并行的操作，从而提高其吞吐量。</li>
</ul>
<h6 id="分片的本质"><a href="#分片的本质" class="headerlink" title="分片的本质"></a>分片的本质</h6><blockquote>
<p>分片质上是一个lucene的索引，一个分片就是一个lucene索引</p>
</blockquote>
<p> 一个elasticsearch索引就是一个lucene索引的集合，当进行查询时，会将查询请求发送到每一个属于当前elasticsearch索引的分片上，然后将每个分片得到的结果进行合并返回。</p>
<h5 id="什么是副本"><a href="#什么是副本" class="headerlink" title="什么是副本"></a>什么是副本</h5><blockquote>
<p>为提高查询吞吐量或实现高可用性，可以使用分片副本。</p>
</blockquote>
<p> 副本是一个分片的精确复制，每个分片可以有零个或多个副本。ES中可以有许多相同的分片，其中之一被选择更改索引操作，这种特殊的分片称为主分片，当主分片丢失时，如：该分片所在的数据不可用时，集群将副本提升为新的主分片。</p>
<p> ES默认为一个索引创建5个主分片，并分别为其创建一个副本分片， 也就是说每个索引都由5个主分片成本，而每个主分片都相应的有一个</p>
<p> 在一个网络 / 云的环境里，失败随时都可能发生，在某个分片/节点不知怎么的就处于离线状态，或者由于任何原因消失了，这种情况下，有一个故障转移机制是非常有用并且是强烈推荐的。为此目的，Elasticsearch 允许你创建分片的一份或多份拷贝，这些拷贝叫做复制分片(副本)。</p>
<h6 id="副本的意义"><a href="#副本的意义" class="headerlink" title="副本的意义"></a>副本的意义</h6><blockquote>
<p>副本存在的两个重要原因：</p>
</blockquote>
<ul>
<li>提高可用性：注意的是副本不能与主/原分片位于同一节点。</li>
<li>提高吞吐量：搜索操作可以在所有的副本上并行运行。</li>
</ul>
<h5 id="分片和副本的区别"><a href="#分片和副本的区别" class="headerlink" title="分片和副本的区别"></a>分片和副本的区别</h5><blockquote>
<p>分片与副本的区别在于：</p>
</blockquote>
<h6 id="分片"><a href="#分片" class="headerlink" title="分片"></a>分片</h6><p> 当你<strong>分片</strong>设置为5，数据量为30G时，es会自动帮我们把数据均衡地<strong>分配</strong>到5个分片上，即每个分片大概有6G数据，当你查询数据时，ES会把查询发送给每个相关的分片，并将结果组合在一起。</p>
<h6 id="副本"><a href="#副本" class="headerlink" title="副本"></a>副本</h6><p> <strong>而副本</strong>，就是对分布在5个分片的数据进行复制,因为<strong>分片</strong>是把数据进行分割而已，数据依然只有一份，这样的目的是<strong>保障查询的高效性</strong>，<strong>副本</strong>则是多复制几份分片的数据，这样的目的是<strong>保障数据的高可靠性，防止数据丢失</strong>。</p>
<h4 id="分片验证"><a href="#分片验证" class="headerlink" title="分片验证"></a>分片验证</h4><blockquote>
<p>下面我们验证以下分片的使用</p>
</blockquote>
<h5 id="验证一个分片"><a href="#验证一个分片" class="headerlink" title="验证一个分片"></a>验证一个分片</h5><blockquote>
<p>首先我们通过建立索引的方式来看下什么是分片，会产生哪些变化。</p>
</blockquote>
<h6 id="创建索引-4"><a href="#创建索引-4" class="headerlink" title="创建索引"></a>创建索引</h6><blockquote>
<p>我们首先创建一个名为<code>test</code>的索引，让它有一个分片，我们看看结果，在<code>kibana</code>执行以下命令</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT <span class="built_in">test</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;number_of_shards&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;number_of_replicas&quot;</span> : <span class="string">&quot;0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样我们就创建了一个分片</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch032.png" alt="image-20220815110858508"></p>
<h6 id="查看分片-5"><a href="#查看分片-5" class="headerlink" title="查看分片"></a>查看分片</h6><blockquote>
<p>我们在<code>cerebro</code>中查看结果，我们看到<code>test</code>只在<code>node-2</code>节点上：</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch033.png" alt="image-20220815111124833"></p>
<h5 id="验证两个分片"><a href="#验证两个分片" class="headerlink" title="验证两个分片"></a>验证两个分片</h5><blockquote>
<p>我们再来创建两个分片看看会发生上面</p>
</blockquote>
<h6 id="创建索引-5"><a href="#创建索引-5" class="headerlink" title="创建索引"></a>创建索引</h6><blockquote>
<p>我们再次创建两个分片的test1</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT test1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;number_of_shards&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">      <span class="string">&quot;number_of_replicas&quot;</span> : <span class="string">&quot;0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样我们就创建了一个索引</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch034.png" alt="image-20220815111452214"></p>
<h6 id="查看分片-6"><a href="#查看分片-6" class="headerlink" title="查看分片"></a>查看分片</h6><blockquote>
<p>我们在<code>cerebro</code>中查看结果，我们看到<code>test1</code>在<code>node-1</code>和<code>node-3</code>上面</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch035.png" alt="image-20220815111613706"></p>
<blockquote>
<p>如上图看到分片分别分布在两个节点上，不用想，如果是3个那么肯定均匀分布在三个节点上</p>
</blockquote>
<h5 id="验证四个分片"><a href="#验证四个分片" class="headerlink" title="验证四个分片"></a>验证四个分片</h5><blockquote>
<p>如果我们创建四个分片，多于节点数会发生什么呢</p>
</blockquote>
<h6 id="创建索引-6"><a href="#创建索引-6" class="headerlink" title="创建索引"></a>创建索引</h6><blockquote>
<p>我们创建四个分片的索引</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT test2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;number_of_shards&quot;</span> : <span class="string">&quot;4&quot;</span>,</span><br><span class="line">      <span class="string">&quot;number_of_replicas&quot;</span> : <span class="string">&quot;0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样我们就创建了一个索引</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch036.png" alt="image-20220815111828553"></p>
<h6 id="查看分片-7"><a href="#查看分片-7" class="headerlink" title="查看分片"></a>查看分片</h6><blockquote>
<p>我们发现有两个分片在<code>node-2</code>的节点上</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch037.png" alt="image-20220815112009953"></p>
<h4 id="验证副本"><a href="#验证副本" class="headerlink" title="验证副本"></a>验证副本</h4><blockquote>
<p>下面我们对副本进行验证</p>
</blockquote>
<h5 id="验证两副本分片"><a href="#验证两副本分片" class="headerlink" title="验证两副本分片"></a>验证两副本分片</h5><h6 id="创建索引-7"><a href="#创建索引-7" class="headerlink" title="创建索引"></a>创建索引</h6><blockquote>
<p>创建一个含有一个分片，两个副本的test3：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT test3</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;number_of_shards&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;number_of_replicas&quot;</span> : <span class="string">&quot;2&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样我们就创建出来了一个分片带两个分片的索引</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch038.png" alt="image-20220815113453334"></p>
<h6 id="查看索引-2"><a href="#查看索引-2" class="headerlink" title="查看索引"></a>查看索引</h6><blockquote>
<p>如下图所示，我们看到了3个绿色的0，其中在<code>node-1</code>节点的边框是粗体的，这个表示分片，而另外两个节点的0的边框是虚线的，这两个就是分片的副本。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch039.png" alt="image-20220815113556248"></p>
<p>通常我们三个节点建立两个副本就可以了，三份数据均匀得到分布在三个节点</p>
<h5 id="验证三副本分片"><a href="#验证三副本分片" class="headerlink" title="验证三副本分片"></a>验证三副本分片</h5><blockquote>
<p>如果建立三个副本会怎么样呢？</p>
</blockquote>
<h6 id="创建索引-8"><a href="#创建索引-8" class="headerlink" title="创建索引"></a>创建索引</h6><blockquote>
<p>创建一个分片三个副本的索引</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT test4</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;number_of_shards&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;number_of_replicas&quot;</span> : <span class="string">&quot;3&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch040.png" alt="image-20220815113859360"></p>
<h6 id="查看索引-3"><a href="#查看索引-3" class="headerlink" title="查看索引"></a>查看索引</h6><blockquote>
<p>如下所示我们看到多出一个Unassigned的副本，这个副本其实是多余的了，因为每个节点已经包含了分片的本身和其副本，多于这个没有意义！</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch041.png" alt="image-20220815114015125"></p>
<blockquote>
<p>并且因为多出来了一个副本无法分配，整个集群都变成了<code>yellow</code>的状态</p>
</blockquote>
<h4 id="分片与副本的组合"><a href="#分片与副本的组合" class="headerlink" title="分片与副本的组合"></a>分片与副本的组合</h4><h5 id="默认组合"><a href="#默认组合" class="headerlink" title="默认组合"></a>默认组合</h5><blockquote>
<p>如果不指定分片和副本会怎么样呢</p>
</blockquote>
<h6 id="创建索引-9"><a href="#创建索引-9" class="headerlink" title="创建索引"></a>创建索引</h6><blockquote>
<p>创建一个索引不指定副本和索引数量</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT test5</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>:&#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch042.png" alt="image-20220815114309027"></p>
<h6 id="查看索引-4"><a href="#查看索引-4" class="headerlink" title="查看索引"></a>查看索引</h6><blockquote>
<p>如下图所示看到默认是有一个分片和一个副本的。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch043.png" alt="image-20220815114404974"></p>
<h5 id="两副本两分片"><a href="#两副本两分片" class="headerlink" title="两副本两分片"></a>两副本两分片</h5><blockquote>
<p>下面我们试验一下两副本两分片，看看会发生什么</p>
</blockquote>
<h6 id="创建索引-10"><a href="#创建索引-10" class="headerlink" title="创建索引"></a>创建索引</h6><blockquote>
<p>下面我们创建两个分片和两个副本</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT test6</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;number_of_shards&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">      <span class="string">&quot;number_of_replicas&quot;</span> : <span class="string">&quot;2&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch044.png" alt="image-20220815114601421"></p>
<h6 id="查看索引-5"><a href="#查看索引-5" class="headerlink" title="查看索引"></a>查看索引</h6><blockquote>
<p>我们看到下面就是两副本两分片的情况，每一个分片都有两个副本，如果再多一个副本就会无法再分配了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch045.png" alt="image-20220815114641375"></p>
<h5 id="三分片两副本"><a href="#三分片两副本" class="headerlink" title="三分片两副本"></a>三分片两副本</h5><blockquote>
<p>下面我们验证以下三分片两副本的情况</p>
</blockquote>
<h6 id="创建索引-11"><a href="#创建索引-11" class="headerlink" title="创建索引"></a>创建索引</h6><blockquote>
<p>我们创建一个三个分片两个副本的索引</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT test7</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;number_of_shards&quot;</span> : <span class="string">&quot;3&quot;</span>,</span><br><span class="line">      <span class="string">&quot;number_of_replicas&quot;</span> : <span class="string">&quot;2&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch046.png" alt="image-20220815115034950"></p>
<h6 id="查看索引-6"><a href="#查看索引-6" class="headerlink" title="查看索引"></a>查看索引</h6><blockquote>
<p>如下所示看到分片和副本都均匀的分布在每个节点上。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch047.png" alt="image-20220815115249762"></p>
<h3 id="故障与恢复"><a href="#故障与恢复" class="headerlink" title="故障与恢复"></a>故障与恢复</h3><h4 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h4><blockquote>
<p>集群的master节点会监控集群中的节点状态，如果发现有节点宕机，会立即将宕机节点的分片数据迁移到其它节点，确保数据安全，这个叫做故障转移。</p>
</blockquote>
<h5 id="正常集群状态"><a href="#正常集群状态" class="headerlink" title="正常集群状态"></a>正常集群状态</h5><blockquote>
<p>下图是正常集群的状态，node1是主节点，其它两个节点是从节点</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch146.png" alt="image-20210723225945963"></p>
<h5 id="节点故障"><a href="#节点故障" class="headerlink" title="节点故障"></a>节点故障</h5><blockquote>
<p>突然，node1发生了故障</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch147.png" alt="image-20210723230020574"></p>
<blockquote>
<p>宕机后的第一件事，需要重新选主，例如选中了node2</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch148.png" alt="image-20210723230055974"></p>
<h5 id="数据迁移"><a href="#数据迁移" class="headerlink" title="数据迁移"></a>数据迁移</h5><blockquote>
<p>node2成为主节点后，会检测集群监控状态，发现：shard-1、shard-0没有副本节点，因此需要将node1上的数据迁移到node2、node3</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch149.png" alt="image-20210723230216642"></p>
<h4 id="节点故障-1"><a href="#节点故障-1" class="headerlink" title="节点故障"></a>节点故障</h4><blockquote>
<p>我们观察下如果三个节点有一个节点宕机了，上文的<code>test7</code>的分片和副本会有哪些变化</p>
</blockquote>
<h5 id="关闭node2节点"><a href="#关闭node2节点" class="headerlink" title="关闭node2节点"></a>关闭node2节点</h5><blockquote>
<p>我们关闭<code>node-2</code>节点</p>
</blockquote>
<h6 id="执行关闭命令"><a href="#执行关闭命令" class="headerlink" title="执行关闭命令"></a>执行关闭命令</h6><blockquote>
<p>我们暂停<code>node-2</code>节点</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker pause node-2</span><br></pre></td></tr></table></figure>

<h6 id="查看索引-7"><a href="#查看索引-7" class="headerlink" title="查看索引"></a>查看索引</h6><blockquote>
<p>如下所示，原本的node-2节点变成了Unassigned</p>
</blockquote>
<p> 注意我标注的三个红框内的分片，这三个分片已经随着节点的宕机消息了，这就造成了数据的丢失，反观后面几个，虽然node2宕机了，但是由于我们做了分片与备份，索引仍然可以正常的工作，</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch048.png" alt="image-20220815134724326"></p>
<blockquote>
<p>原本在node-2的2号分片移动到了node-1节点，在使用es集群的过程中，一定要注意分片和副本的使用，保证我们整个集群的高可用性</p>
</blockquote>
<h5 id="关闭node3节点"><a href="#关闭node3节点" class="headerlink" title="关闭node3节点"></a>关闭node3节点</h5><blockquote>
<p>我们关闭以下node-3节点看下情况</p>
</blockquote>
<h6 id="执行关闭命令-1"><a href="#执行关闭命令-1" class="headerlink" title="执行关闭命令"></a>执行关闭命令</h6><blockquote>
<p>执行如下命令暂停node-3</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker pause node-3</span><br></pre></td></tr></table></figure>

<h6 id="查看集群状态-1"><a href="#查看集群状态-1" class="headerlink" title="查看集群状态"></a>查看集群状态</h6><blockquote>
<p>通过<code>Cerebro</code>我们发现整个集群已经无法进行访问了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch049.png" alt="image-20220815135556926"></p>
<blockquote>
<p>当集群中的节点数少于半数，将导致整个集群不可用</p>
</blockquote>
<h4 id="节点恢复"><a href="#节点恢复" class="headerlink" title="节点恢复"></a>节点恢复</h4><blockquote>
<p>经过上面的宕机试验后，我们现在要对宕机的服务进行启动</p>
</blockquote>
<h5 id="启动node2节点"><a href="#启动node2节点" class="headerlink" title="启动node2节点"></a>启动node2节点</h5><blockquote>
<p>我们先启动node2节点</p>
</blockquote>
<h6 id="执行启动命令"><a href="#执行启动命令" class="headerlink" title="执行启动命令"></a>执行启动命令</h6><blockquote>
<p>执行下面的命令恢复node-2节点</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker unpause node-2</span><br></pre></td></tr></table></figure>

<h6 id="查看集群状态-2"><a href="#查看集群状态-2" class="headerlink" title="查看集群状态"></a>查看集群状态</h6><blockquote>
<p>如上发现集群已经能够恢复访问了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch050.png" alt="image-20220815140033413"></p>
<h6 id="创建索引-12"><a href="#创建索引-12" class="headerlink" title="创建索引"></a>创建索引</h6><blockquote>
<p>此时我们在两个几点可用的情况下创建一个有三分片，两个副本的索引</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT test8</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;number_of_shards&quot;</span> : <span class="string">&quot;3&quot;</span>,</span><br><span class="line">      <span class="string">&quot;number_of_replicas&quot;</span> : <span class="string">&quot;2&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch051.png" alt="image-20220815140156620"></p>
<h6 id="查看索引状态"><a href="#查看索引状态" class="headerlink" title="查看索引状态"></a>查看索引状态</h6><blockquote>
<p>如下所示，分片与副本的分布没有问题，有三个副本未分配</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch052.png" alt="image-20220815140347882"></p>
<h5 id="启动node3节点"><a href="#启动node3节点" class="headerlink" title="启动node3节点"></a>启动node3节点</h5><blockquote>
<p>下面我们就启动node3节点</p>
</blockquote>
<h6 id="执行启动命令-1"><a href="#执行启动命令-1" class="headerlink" title="执行启动命令"></a>执行启动命令</h6><blockquote>
<p>执行下面的命令恢复node-2节点</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker unpause node-3</span><br></pre></td></tr></table></figure>

<h6 id="查看索引-8"><a href="#查看索引-8" class="headerlink" title="查看索引"></a>查看索引</h6><blockquote>
<p>所有的未分配副本移动到了node-3节点，并没有将分片移动到node-2上</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch053.png" alt="image-20220815140547535"></p>
<h3 id="扩缩容"><a href="#扩缩容" class="headerlink" title="扩缩容"></a>扩缩容</h3><h4 id="服务布局-3"><a href="#服务布局-3" class="headerlink" title="服务布局"></a>服务布局</h4><blockquote>
<p>我们整体采用Docker方式进行布局，以下是我们需要部署的服务，标红色的我们需要新增的节点</p>
</blockquote>
<table>
<thead>
<tr>
<th>服务名称</th>
<th>服务名称</th>
<th>开放端口</th>
<th>内存限制</th>
</tr>
</thead>
<tbody><tr>
<td>ES-node1</td>
<td>node-1</td>
<td>9200</td>
<td>1G</td>
</tr>
<tr>
<td>ES-node2</td>
<td>node-2</td>
<td>9201</td>
<td>1G</td>
</tr>
<tr>
<td>ES-node3</td>
<td>node-3</td>
<td>9202</td>
<td>1G</td>
</tr>
<tr>
<td>ES-node4</td>
<td>node-4</td>
<td>9203</td>
<td>1G</td>
</tr>
<tr>
<td>ES-cerebro</td>
<td>cerebro</td>
<td>9000</td>
<td>不限</td>
</tr>
<tr>
<td>kibana</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="扩容节点"><a href="#扩容节点" class="headerlink" title="扩容节点"></a>扩容节点</h4><h5 id="创建节点目录"><a href="#创建节点目录" class="headerlink" title="创建节点目录"></a>创建节点目录</h5><blockquote>
<p>创建ES的节点目录</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkdir -p /tmp/data/elasticsearch/node-4/&#123;config,plugins,data,<span class="built_in">log</span>&#125;</span><br><span class="line"><span class="comment">#进行授权</span></span><br><span class="line">chmod 777 /tmp/data/elasticsearch/node-4/&#123;config,plugins,data,<span class="built_in">log</span>&#125;</span><br></pre></td></tr></table></figure>

<h5 id="添加IK分词器-4"><a href="#添加IK分词器-4" class="headerlink" title="添加IK分词器"></a>添加IK分词器</h5><blockquote>
<p>只要将其他节点的IK分词器复制过来就可</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">cp -R ik/ /tmp/data/elasticsearch/node-4/plugins/</span><br></pre></td></tr></table></figure>

<h5 id="编写配置文件-2"><a href="#编写配置文件-2" class="headerlink" title="编写配置文件"></a>编写配置文件</h5><blockquote>
<p>我们边界node4节点的配置文件</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vi /tmp/data/elasticsearch/node-4/config/elasticsearch.yml</span><br><span class="line"><span class="comment">#集群名称</span></span><br><span class="line">cluster.name: elastic</span><br><span class="line"><span class="comment">#当前该节点的名称</span></span><br><span class="line">node.name: node-4</span><br><span class="line"><span class="comment">#是不是有资格竞选主节点</span></span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line"><span class="comment">#是否存储数据</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line"><span class="comment">#最大集群节点数</span></span><br><span class="line">node.max_local_storage_nodes: 3</span><br><span class="line"><span class="comment">#给当前节点自定义属性（可以省略）</span></span><br><span class="line"><span class="comment">#node.attr.rack: r1</span></span><br><span class="line"><span class="comment">#数据存档位置</span></span><br><span class="line">path.data: /usr/share/elasticsearch/data</span><br><span class="line"><span class="comment">#日志存放位置</span></span><br><span class="line">path.logs: /usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line"><span class="comment">#是否开启时锁定内存（默认为是）</span></span><br><span class="line"><span class="comment">#bootstrap.memory_lock: true</span></span><br><span class="line"><span class="comment">#设置网关地址，我是被这个坑死了，这个地址我原先填写了自己的实际物理IP地址，</span></span><br><span class="line"><span class="comment">#然后启动一直报无效的IP地址，无法注入9300端口，这里只需要填写0.0.0.0</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="comment">#设置映射端口</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="comment">#内部节点之间沟通端口</span></span><br><span class="line">transport.tcp.port: 9300</span><br><span class="line"><span class="comment">#集群发现默认值为127.0.0.1:9300,如果要在其他主机上形成包含节点的群集,如果搭建集群则需要填写</span></span><br><span class="line"><span class="comment">#es7.x 之后新增的配置，写入候选主节点的设备地址，在开启服务后可以被选为主节点，也就是说把所有的节点都写上</span></span><br><span class="line">discovery.seed_hosts: [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"><span class="comment">#当你在搭建集群的时候，选出合格的节点集群，有些人说的太官方了，</span></span><br><span class="line"><span class="comment">#其实就是，让你选择比较好的几个节点，在你节点启动时，在这些节点中选一个做领导者，</span></span><br><span class="line"><span class="comment">#如果你不设置呢，elasticsearch就会自己选举，这里我们把三个节点都写上</span></span><br><span class="line">cluster.initial_master_nodes: [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"><span class="comment">#在群集完全重新启动后阻止初始恢复，直到启动N个节点</span></span><br><span class="line"><span class="comment">#简单点说在集群启动后，至少复活多少个节点以上，那么这个服务才可以被使用，否则不可以被使用，</span></span><br><span class="line">gateway.recover_after_nodes: 2</span><br><span class="line"><span class="comment">#删除索引是是否需要显示其名称，默认为显示</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true</span></span><br><span class="line"><span class="comment"># 禁用安全配置，否则查询的时候会提示警告</span></span><br><span class="line">xpack.security.enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h5 id="编写部署文档-3"><a href="#编写部署文档-3" class="headerlink" title="编写部署文档"></a>编写部署文档</h5><blockquote>
<p>我们在部署脚本增加node-4节点</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vi docker-compose.yml</span><br><span class="line">version: <span class="string">&quot;3&quot;</span></span><br><span class="line">services:</span><br><span class="line">  node-1:</span><br><span class="line">    image: elasticsearch:7.17.5</span><br><span class="line">    container_name: node-1</span><br><span class="line">    environment:</span><br><span class="line">      - <span class="string">&quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;</span></span><br><span class="line">      - <span class="string">&quot;TZ=Asia/Shanghai&quot;</span></span><br><span class="line">    ulimits:</span><br><span class="line">      memlock:</span><br><span class="line">        soft: -1</span><br><span class="line">        hard: -1</span><br><span class="line">      nofile:</span><br><span class="line">        soft: 65536</span><br><span class="line">        hard: 65536</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9200:9200&quot;</span></span><br><span class="line">    logging:</span><br><span class="line">      driver: <span class="string">&quot;json-file&quot;</span></span><br><span class="line">      options:</span><br><span class="line">        max-size: <span class="string">&quot;50m&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /tmp/data/elasticsearch/node-1/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span><br><span class="line">      - /tmp/data/elasticsearch/node-1/plugins:/usr/share/elasticsearch/plugins</span><br><span class="line">      - /tmp/data/elasticsearch/node-1/data:/usr/share/elasticsearch/data</span><br><span class="line">      - /tmp/data/elasticsearch/node-1/<span class="built_in">log</span>:/usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">  node-2:</span><br><span class="line">    image: elasticsearch:7.17.5</span><br><span class="line">    container_name: node-2</span><br><span class="line">    environment:</span><br><span class="line">      - <span class="string">&quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;</span></span><br><span class="line">      - <span class="string">&quot;TZ=Asia/Shanghai&quot;</span></span><br><span class="line">    ulimits:</span><br><span class="line">      memlock:</span><br><span class="line">        soft: -1</span><br><span class="line">        hard: -1</span><br><span class="line">      nofile:</span><br><span class="line">        soft: 65536</span><br><span class="line">        hard: 65536</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9201:9200&quot;</span></span><br><span class="line">    logging:</span><br><span class="line">      driver: <span class="string">&quot;json-file&quot;</span></span><br><span class="line">      options:</span><br><span class="line">        max-size: <span class="string">&quot;50m&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /tmp/data/elasticsearch/node-2/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span><br><span class="line">      - /tmp/data/elasticsearch/node-2/plugins:/usr/share/elasticsearch/plugins</span><br><span class="line">      - /tmp/data/elasticsearch/node-2/data:/usr/share/elasticsearch/data</span><br><span class="line">      - /tmp/data/elasticsearch/node-2/<span class="built_in">log</span>:/usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">  node-3:</span><br><span class="line">    image: elasticsearch:7.17.5</span><br><span class="line">    container_name: node-3</span><br><span class="line">    environment:</span><br><span class="line">      - <span class="string">&quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;</span></span><br><span class="line">      - <span class="string">&quot;TZ=Asia/Shanghai&quot;</span></span><br><span class="line">    ulimits:</span><br><span class="line">      memlock:</span><br><span class="line">        soft: -1</span><br><span class="line">        hard: -1</span><br><span class="line">      nofile:</span><br><span class="line">        soft: 65536</span><br><span class="line">        hard: 65536</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9202:9200&quot;</span></span><br><span class="line">    logging:</span><br><span class="line">      driver: <span class="string">&quot;json-file&quot;</span></span><br><span class="line">      options:</span><br><span class="line">        max-size: <span class="string">&quot;50m&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /tmp/data/elasticsearch/node-3/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span><br><span class="line">      - /tmp/data/elasticsearch/node-3/plugins:/usr/share/elasticsearch/plugins</span><br><span class="line">      - /tmp/data/elasticsearch/node-3/data:/usr/share/elasticsearch/data</span><br><span class="line">      - /tmp/data/elasticsearch/node-3/<span class="built_in">log</span>:/usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">  node-4:</span><br><span class="line">    image: elasticsearch:7.17.5</span><br><span class="line">    container_name: node-4</span><br><span class="line">    environment:</span><br><span class="line">      - <span class="string">&quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;</span></span><br><span class="line">      - <span class="string">&quot;TZ=Asia/Shanghai&quot;</span></span><br><span class="line">    ulimits:</span><br><span class="line">      memlock:</span><br><span class="line">        soft: -1</span><br><span class="line">        hard: -1</span><br><span class="line">      nofile:</span><br><span class="line">        soft: 65536</span><br><span class="line">        hard: 65536</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9203:9200&quot;</span></span><br><span class="line">    logging:</span><br><span class="line">      driver: <span class="string">&quot;json-file&quot;</span></span><br><span class="line">      options:</span><br><span class="line">        max-size: <span class="string">&quot;50m&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /tmp/data/elasticsearch/node-4/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span><br><span class="line">      - /tmp/data/elasticsearch/node-4/plugins:/usr/share/elasticsearch/plugins</span><br><span class="line">      - /tmp/data/elasticsearch/node-4/data:/usr/share/elasticsearch/data</span><br><span class="line">      - /tmp/data/elasticsearch/node-4/<span class="built_in">log</span>:/usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">  kibana:</span><br><span class="line">    container_name: kibana</span><br><span class="line">    image: kibana:7.17.5</span><br><span class="line">    volumes:</span><br><span class="line">      - /tmp/data/kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml</span><br><span class="line">    ports:</span><br><span class="line">      - 5601:5601</span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">  cerebro:</span><br><span class="line">      image: lmenezes/cerebro:0.9.4</span><br><span class="line">      container_name: cerebro</span><br><span class="line">      environment:</span><br><span class="line">        TZ: <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line">      ports:</span><br><span class="line">        - <span class="string">&#x27;9000:9000&#x27;</span></span><br><span class="line">      networks:</span><br><span class="line">        - elastic</span><br><span class="line">networks:</span><br><span class="line">  elastic:</span><br><span class="line">    driver: bridge</span><br></pre></td></tr></table></figure>

<h5 id="启动服务-3"><a href="#启动服务-3" class="headerlink" title="启动服务"></a>启动服务</h5><blockquote>
<p>我们完成配置后就可以启动服务了</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<h5 id="查看节点信息"><a href="#查看节点信息" class="headerlink" title="查看节点信息"></a>查看节点信息</h5><blockquote>
<p>我们可以在监控界面看到节点的信息，我们发现节点4已经加入进来了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch207.png" alt="image-20220920112324300"></p>
<h4 id="节点缩容"><a href="#节点缩容" class="headerlink" title="节点缩容"></a>节点缩容</h4><blockquote>
<p>接下来我们要将node4节点去掉完成缩容操作</p>
</blockquote>
<h5 id="禁止数据分配"><a href="#禁止数据分配" class="headerlink" title="禁止数据分配"></a>禁止数据分配</h5><blockquote>
<p>我们先排除node-4节点，禁止数据在该节点分配数据，然后才能停止节点，如果想正常缩容，这里填上所有要缩容的节点名称就可以了</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT /_cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;persistent&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;cluster.routing.allocation.exclude._name&quot;</span>: <span class="string">&quot;node-4&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch208.png" alt="image-20220920113249782"></p>
<h5 id="检查数据分配"><a href="#检查数据分配" class="headerlink" title="检查数据分配"></a>检查数据分配</h5><blockquote>
<p>接下来检查一下缩容节点的数据迁移情况，我们发现数据已经全部迁移完成了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch209.png" alt="image-20220920113342936"></p>
<h5 id="关闭节点"><a href="#关闭节点" class="headerlink" title="关闭节点"></a>关闭节点</h5><blockquote>
<p>等到数据全部迁移完成后就可以进行缩容节点了</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker-compose stop node-4</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch210.png" alt="image-20220920113536524"></p>
<h5 id="查看集群情况"><a href="#查看集群情况" class="headerlink" title="查看集群情况"></a>查看集群情况</h5><blockquote>
<p>接下来看一下集群的情况，我们发现已经缩容成功了，并且没有出现主分片丢失的情况</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch211.png" alt="image-20220920113615163"></p>
<h2 id="ElasticSearch-深度分页"><a href="#ElasticSearch-深度分页" class="headerlink" title="ElasticSearch 深度分页"></a>ElasticSearch 深度分页</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch001.png" alt="img"></p>
<h3 id="深度分页问题"><a href="#深度分页问题" class="headerlink" title="深度分页问题"></a>深度分页问题</h3><blockquote>
<p>我们使用mysql的时候经常遇到分页查询的场景，在mysql中使用<code>limit</code>关键字来实现分页，比如下面的示例</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select * from orders_history where type=8 limit 100,100;</span><br><span class="line">select * from orders_history where type=8 limit 1000,100;</span><br><span class="line">select * from orders_history where type=8 limit 10000,100;</span><br></pre></td></tr></table></figure>

<p> 在ElasticsSearch（以下简称ES）同样也有很多分页查询的场景，比如在数据量比较大的情况下，并且查询条件比较复杂，在mysql中无法命中索引，我们往往会选择使用ES的分页查询。</p>
<h4 id="分页方式"><a href="#分页方式" class="headerlink" title="分页方式"></a>分页方式</h4><blockquote>
<p>在Elasticsearch中支持的三种分页查询方式</p>
</blockquote>
<ul>
<li>From + Size 查询</li>
<li>Scroll 查询</li>
<li>Search After 查询</li>
</ul>
<h4 id="from-size"><a href="#from-size" class="headerlink" title="from/size"></a>from/size</h4><blockquote>
<p>from+size的分页查询称为”浅”分页，它的原理很简单，就是查询前20条数据，然后截断前10条，只返回10-20的数据，这样其实白白浪费了前10条的查询</p>
</blockquote>
<p> 在深度分页的情况下，这种使用方式效率是非常低的，比如from = 50000, size=10， es 需要在各个分片上匹配排序并得到50010条数据，协调节点拿到这些数据再进行全局排序处理，然后结果集中取最后10条数据返回。</p>
<h5 id="使用方式-1"><a href="#使用方式-1" class="headerlink" title="使用方式"></a>使用方式</h5><blockquote>
<p>这是ES分页最常用的一种方案，跟mysql类似</p>
</blockquote>
<ul>
<li>from：未指定，默认值是 0，注意不是1，代表当前页返回数据的起始值。</li>
<li>size：未指定，默认值是 10，代表当前页返回数据的条数</li>
</ul>
<h6 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h6><blockquote>
<p>查询小区数据中<code>0-10</code>页的数据</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET logstash-village-2022.08.22/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 10,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="优缺点-1"><a href="#优缺点-1" class="headerlink" title="优缺点"></a>优缺点</h5><h6 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h6><ul>
<li>支持随机翻页</li>
</ul>
<h6 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h6><ul>
<li>受制于 max_result_window 设置，不能无限制翻页。</li>
<li>存在深度翻页问题，越往后翻页越慢。</li>
</ul>
<h5 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h5><ul>
<li>非常适合小型数据集或者大数据集返回 Top N（N &lt;= 10000）结果集的业务场景</li>
<li>类似主流 PC 搜索引擎（谷歌、bing、百度、360、sogou等）支持随机跳转分页的业务场景</li>
</ul>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch127.png" alt="image-20220909174219521"></p>
<h5 id="深度分页问题-1"><a href="#深度分页问题-1" class="headerlink" title="深度分页问题"></a>深度分页问题</h5><blockquote>
<p>Elasticsearch 在深度分页的情况下会限制最大分页数，避免大数据量的查询导致性能低下</p>
</blockquote>
<h6 id="深度分页限制"><a href="#深度分页限制" class="headerlink" title="深度分页限制"></a>深度分页限制</h6><blockquote>
<p>ES的<code>max_result_window</code>默认值是10000，也就意味着：如果每页有 10 条数据，会最大翻页至1000页</p>
</blockquote>
<p> 实际主流搜索引擎都翻不了那么多页，举例：百度搜索“上海”，翻到第 76 页，就无法再往下翻页了，提示信息如下截图所示：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch128.png" alt="image-20220909174523443"></p>
<h6 id="尝试深度分页"><a href="#尝试深度分页" class="headerlink" title="尝试深度分页"></a>尝试深度分页</h6><blockquote>
<p>我们将上面的查询改造下，查询<code>9999</code>页之后的十条数据</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET logstash-village-2022.08.22/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: 9999,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 10,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现查询后直接报错了，Result window is too large</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch129.png" alt="image-20220909174704206"></p>
<h5 id="为什么限制深度分页"><a href="#为什么限制深度分页" class="headerlink" title="为什么限制深度分页"></a>为什么限制深度分页</h5><blockquote>
<p>为了性能，es限制了我们分页的深度，es目前支持的最大的 max_result_window = 10000；</p>
</blockquote>
<p> 也就是说我们不能获取10000个以上的文档 ， 当ES 分页查询超过一定的值（10000）后，会报错，如果数据量非常大的情况下进行查询可能会产生OOM</p>
<blockquote>
<p>不推荐使用 from + size 做深度分页查询的核心原因：</p>
</blockquote>
<ul>
<li>搜索请求通常跨越多个分片，每个分片必须将其请求的命中内容以及任何先前页面的命中内容加载到内存中。</li>
<li>对于翻页较深的页面或大量结果，这些操作会显著增加内存和 CPU 使用率，从而导致性能下降或节点故障</li>
</ul>
<h6 id="分页查询步骤"><a href="#分页查询步骤" class="headerlink" title="分页查询步骤"></a>分页查询步骤</h6><ul>
<li>协调节点或者客户端节点，需要将请求发送到所有的分片</li>
<li>每个分片把from + size个结果，返回给协调节点或者客户端节点</li>
<li>协调节点或者客户端节点进行结果合并，如果有n个分片，则查询数据是 n * (from+size) ， 如果from很大的话，会造成oom或者网络资源的浪费。</li>
</ul>
<h6 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h6><blockquote>
<p>我么有三个shard（分片），每个分片有10w条数据如果要查询9999-10009的数据</p>
</blockquote>
<p> 查询的时候协调节点就会分别从每个分片中获取10009条数据，一共30027条数据，然后进行排序获取出10条数据，所以深度分页会给系统带来很大的压力</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch130.png" alt="在这里插入图片描述"></p>
<h5 id="解决方案-4"><a href="#解决方案-4" class="headerlink" title="解决方案"></a>解决方案</h5><h6 id="限制分页数"><a href="#限制分页数" class="headerlink" title="限制分页数"></a>限制分页数</h6><blockquote>
<p>我们可以限制分页的数量，而规避深度分页带来的性能影响，例如天猫会限制在80页</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch131.png" alt="在这里插入图片描述"></p>
<h6 id="修改max-result-window初始值"><a href="#修改max-result-window初始值" class="headerlink" title="修改max_result_window初始值"></a>修改max_result_window初始值</h6><blockquote>
<p>怎么解决这个问题，首先能想到的就是调大这个window</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT logstash-village/_settings</span><br><span class="line">&#123; </span><br><span class="line">    <span class="string">&quot;index&quot;</span> : &#123; </span><br><span class="line">        <span class="string">&quot;max_result_window&quot;</span> : 20000</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 但这种方法只是暂时解决问题，当数据量越来越大，分页也越来越深，而且越会出OOM问题的，所以当索引非常非常大(千万或亿)，是无法使用from + size 做深分页的，分页越深则越容易OOM，即便不OOM，也很消耗CPU和内存资源</p>
<h4 id="Scroll-遍历查询"><a href="#Scroll-遍历查询" class="headerlink" title="Scroll 遍历查询"></a>Scroll 遍历查询</h4><blockquote>
<p>ES为了避免深分页，不允许使用分页(from&amp;size)查询10000条以后的数据，因此如果要查询第10000条以后的数据，要使用ES提供的 scroll(游标) 来查询</p>
</blockquote>
<p> <code>scroll</code> 查询可以用来对 Elasticsearch 有效地执行大批量的文档查询，而又不用付出深度分页那种代价，游标查询允许我们先做查询初始化，然后再批量地拉取结果，这有点儿像传统数据库中的 <code>cursor</code> 。</p>
<p> 如果把 From + size 和 search_after 两种请求看做近实时的请求处理方式，那么 scroll 滚动遍历查询显然是非实时的，数据量大的时候，响应时间可能会比较长。</p>
<h5 id="使用方式-2"><a href="#使用方式-2" class="headerlink" title="使用方式"></a>使用方式</h5><blockquote>
<p>scroll 核心执行步骤如下</p>
</blockquote>
<h6 id="生成scroll-id"><a href="#生成scroll-id" class="headerlink" title="生成scroll_id"></a>生成scroll_id</h6><blockquote>
<p>指定检索语句同时设置 scroll 上下文保留时间，如果文档不需要特定排序，可以指定按照文档创建的时间返回会使迭代更高效。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET logstash-village-2022.08.22/_search?scroll=1m  <span class="comment"># 保持游标查询窗口一分钟</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123; <span class="string">&quot;match_all&quot;</span>: &#123;&#125;&#125;,</span><br><span class="line">    <span class="string">&quot;sort&quot;</span> : [<span class="string">&quot;_doc&quot;</span>],  <span class="comment">#按照文件的创建顺序进行排序</span></span><br><span class="line">    <span class="string">&quot;size&quot;</span>:  10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>从 Scroll 请求返回的结果反映了发出初始搜索请求时索引的状态，类似在那一个时刻做了快照，随后对文档的更改（写入、更新或删除）只会影响以后的搜索请求。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch132.png" alt="image-20220909180023511"></p>
<p> scroll就是把一次的查询结果缓存一定的时间，如scroll=1m则把查询结果在下一次请求上来时暂存1分钟，response比传统的返回多了一个scroll_id，下次带上这个scroll_id即可找回这个缓存的结果。</p>
<h6 id="分页查询-1"><a href="#分页查询-1" class="headerlink" title="分页查询"></a>分页查询</h6><blockquote>
<p>后续翻页， 通过上一次查询返回的scroll_id 来不断的取下一页，请求指定的<code>scroll_id</code>时就不需要索引条件等信息了，直到没有要返回的结果为止</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET /_search/scroll</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;scroll&quot;</span>: <span class="string">&quot;1m&quot;</span>,</span><br><span class="line"><span class="string">&quot;scroll_id&quot;</span>:<span class="string">&quot;FGluY2x1ZGVfY29udGV4dF91dWlkDnF1ZXJ5VGhlbkZldGNoAxZneDlZTkR5LVFtaU8zR3pWalVRR0ZRAAAAAAAAFK0WSk9zQ2VQR0xTR09TZ2RmcWdEa05NdxY4Tmh5anlxNFNicV94Yzcwc0c4MXB3AAAAAAAABYYWRHhTSEQ3R2ZRVC1rX2JURHdnU2d3ZxZBWjFydl9ZMVRNUzdYREIzV0MyaDJBAAAAAAAAFeEWMGY3M3liWXFRVE9jOTZPbU5fUFNFdw==&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果srcoll_id 的生存期很长，那么每次返回的 scroll_id 都是一样的，直到该 scroll_id 过期，才会返回一个新的 scroll_id</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch133.png" alt="image-20220909180405774"></p>
<p> 每读取一页都会重新设置 scroll_id 的生存时间，所以这个时间只需要满足读取当前页就可以，不需要满足读取所有的数据的时间，1 分钟足以。</p>
<h6 id="注意事项-7"><a href="#注意事项-7" class="headerlink" title="注意事项"></a>注意事项</h6><blockquote>
<p>使用初始化返回的<code>_scroll_id</code>来进行请求，每一次请求都会继续返回初始化中未读完数据，并且会返回一个<code>_scroll_id</code>，这个<code>_scroll_id</code>可能会改变，因此每一次请求应该带上上一次请求返回的_scroll_id</p>
</blockquote>
<p> 每次发送scroll请求时，都要再重新刷新这个scroll的开启时间，以防不小心超时导致数据取得不完整，如果没有数据了，就会回传空的hits，可以用这个判断是否遍历完成了数据</p>
<h5 id="优缺点-2"><a href="#优缺点-2" class="headerlink" title="优缺点"></a>优缺点</h5><h6 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h6><ul>
<li>支持全量遍历（单次遍历的 size 值也不能超过 max_result_window 大小）</li>
</ul>
<h6 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h6><ul>
<li>响应时间非实时。</li>
<li>保留上下文需要足够的堆内存空间。</li>
</ul>
<h5 id="适用场景-1"><a href="#适用场景-1" class="headerlink" title="适用场景"></a>适用场景</h5><ul>
<li>全量或数据量很大时遍历结果数据，而非分页查询。</li>
<li>官方文档强调：不再建议使用scroll API进行深度分页，如果要分页检索超过 Top 10,000+ 结果时，推荐使用：PIT + search_after。</li>
</ul>
<h5 id="scroll-分页原理"><a href="#scroll-分页原理" class="headerlink" title="scroll 分页原理"></a>scroll 分页原理</h5><blockquote>
<p>游标查询会取某个时间点的快照数据，查询初始化之后索引上的任何变化会被它忽略，它通过保存旧的数据文件来实现这个特性，结果就像保留初始化时的索引视图一样。</p>
</blockquote>
<p> 深度分页的代价根源是结果集全局排序，如果去掉全局排序的特性的话查询结果的成本就会很低， 游标查询用字段 <code>_doc</code> 来排序，这个指令让 Elasticsearch 仅仅从还有结果的分片返回下一批结果。</p>
<p> 启用游标查询可以通过在查询的时候设置参数 <code>scroll</code> 的值为我们期望的游标查询的过期时间， 游标查询的过期时间会在每次做查询的时候刷新，所以这个时间只需要足够处理当前批的结果就可以了，而不是处理查询结果的所有文档的所需时间。</p>
<p> 这个过期时间的参数很重要，因为保持这个游标查询窗口需要消耗资源，所以我们期望如果不再需要维护这种资源就该早点儿释放掉，设置这个超时能够让 Elasticsearch 在稍后空闲的时候自动释放这部分资源。</p>
<h6 id="滚动游标原理"><a href="#滚动游标原理" class="headerlink" title="滚动游标原理"></a>滚动游标原理</h6><blockquote>
<p>对一次查询生成一个游标 scroll_id ， 后续的查询只需要根据这个游标scroll_id 去取数据，直到结果集中返回的 hits 字段为空，就表示遍历结束。</p>
</blockquote>
<p> scroll_id 的生成可以理解为建立了一个临时的历史快照，或者可以理解为一个保存doc快照的临时的结果文件，快照文件形成之后，原doc的增删改查等操作不会影响到这个快照的结果。</p>
<h6 id="Scroll-的理解"><a href="#Scroll-的理解" class="headerlink" title="Scroll 的理解"></a>Scroll 的理解</h6><ul>
<li>使用scroll就是一次把要用的数据都排完了，缓存起来</li>
<li>在遍历时，从这个快照里取数据，分批取出</li>
<li>因此，游标可以增加性能的原因，Scroll 使用from+size还好</li>
<li>是因为如果做深分页，from+size 每次搜索都必须重新排序，非常浪费资源，而且容易OOM</li>
</ul>
<h5 id="scroll的清理"><a href="#scroll的清理" class="headerlink" title="scroll的清理"></a>scroll的清理</h5><blockquote>
<p>srcoll_id 的存在会耗费大量的资源来保存一份当前查询结果集映像，并且会占用文件描述符</p>
</blockquote>
<p> 为了防止因打开太多scroll而导致的问题，不允许用户打开滚动超过某个限制，默认情况下，打开的滚动的最大数量为500，可以使用<code>search.max_open_scroll_context</code>群集设置更新此限制，虽然es 会有自动清理机制，但是，尽量保障所有文档获取完毕之后，手动清理掉 <code>scroll_id</code></p>
<h6 id="根据scroll-id清理"><a href="#根据scroll-id清理" class="headerlink" title="根据scroll_id清理"></a>根据scroll_id清理</h6><blockquote>
<p>使用 es 提供的 CLEAR_API 来删除指定的 scroll_id</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">DELETE /_search/scroll/FGluY2x1ZGVfY29udGV4dF91dWlkDnF1ZXJ5VGhlbkZldGNoAxZvdlVSblJQdFFLaWx5RjJDaGpSakxnAAAAAAAALkAWMGY3M3liWXFRVE9jOTZPbU5fUFNFdxZOc0dSOFl5WVRPZTExdUNrZnJrRmp3AAAAAAAALyEWSk9zQ2VQR0xTR09TZ2RmcWdEa05NdxZIaFBUWWVlTFRpeS1IajI5cjBGWEh3AAAAAAAAABkWRHhTSEQ3R2ZRVC1rX2JURHdnU2d3Zw==</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch135.png" alt="image-20220817173031568"></p>
<h6 id="清理所有的scroll"><a href="#清理所有的scroll" class="headerlink" title="清理所有的scroll"></a>清理所有的scroll</h6><blockquote>
<p>根据ID清理会比较麻烦，我们完全可以全部清除掉</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DELETE /_search/scroll/_all</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch136.png" alt="image-20220909181106844"></p>
<h4 id="search-after-查询"><a href="#search-after-查询" class="headerlink" title="search_after 查询"></a>search_after 查询</h4><blockquote>
<p>scroll 的方式，官方的建议不用于实时的请求（一般用于数据导出），因为每一个<code>scroll_id</code>不仅会占用大量的资源，而且会生成历史快照，对于数据的变更不会反映到快照上。</p>
</blockquote>
<p> search_after 查询本质：使用前一页中的一组排序值来检索匹配的下一页，search_after 分页的方式是根据上一页的最后一条数据来确定下一页的位置，同时在分页请求的过程中，如果有索引数据的增删改查，这些变更也会实时的反映到游标上。</p>
<p> 但是需要注意，因为每一页的数据依赖于上一页最后一条数据，所以无法跳页请求，无法指定页数，只能实现“下一页”这种需求。</p>
<p> 为了找到每一页最后一条数据，每个文档必须有一个全局唯一值，官方推荐使用 _uid 作为全局唯一值，其实使用业务层的 id 也可以。</p>
<p> 前置条件：使用 search_after 要求后续的多个请求返回与第一次查询相同的排序结果序列，也就是说，即便在后续翻页的过程中，可能会有新数据写入等操作，但这些操作不会对原有结果集构成影响。</p>
<h5 id="使用方式-3"><a href="#使用方式-3" class="headerlink" title="使用方式"></a>使用方式</h5><blockquote>
<p>search_after 分页查询可以简单概括为如下几个步骤</p>
</blockquote>
<h6 id="创建-PIT-视图"><a href="#创建-PIT-视图" class="headerlink" title="创建 PIT 视图"></a>创建 PIT 视图</h6><blockquote>
<p>创建 PIT 视图，这是前置条件不能省</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST logstash-village-2022.08.22/_pit?keep_alive=5m</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>keep_alive=5m</code>，类似scroll的参数，代表视图保留时间是 5 分钟，超过 5 分钟执行会报错</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch137.png" alt="image-20220909183830447"></p>
<h6 id="创建基础查询"><a href="#创建基础查询" class="headerlink" title="创建基础查询"></a>创建基础查询</h6><blockquote>
<p>创建基础查询语句，这里要设置翻页的条件</p>
</blockquote>
<ul>
<li>设置了PIT，检索时候就不需要再指定索引。</li>
<li>id 是基于步骤1 返回的 id 值。</li>
<li>排序 sort 指的是：按照哪个关键字排序。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 10,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;province&quot;</span>: <span class="string">&quot;河南省&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;pit&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;p9S1AwMbbG9nc3Rhc2gtdmlsbGFnZS0yMDIyLjA4LjIyFlZpT0RxQzZvUV82bnRBZXYzcHZxNXcBFkR4U0hEN0dmUVQta19iVER3Z1Nnd2cAAAAAAAAABswWOE5oeWp5cTRTYnFfeGM3MHNHODFwdwAbbG9nc3Rhc2gtdmlsbGFnZS0yMDIyLjA4LjIyFlZpT0RxQzZvUV82bnRBZXYzcHZxNXcAFkpPc0NlUEdMU0dPU2dkZnFnRGtOTXcAAAAAAAAAGHwWZ3g5WU5EeS1RbWlPM0d6VmpVUUdGUQAbbG9nc3Rhc2gtdmlsbGFnZS0yMDIyLjA4LjIyFlZpT0RxQzZvUV82bnRBZXYzcHZxNXcCFjBmNzN5YllxUVRPYzk2T21OX1BTRXcAAAAAAAAAGncWQVoxcnZfWTFUTVM3WERCM1dDMmgyQQABFlZpT0RxQzZvUV82bnRBZXYzcHZxNXcAAA==&quot;</span>,</span><br><span class="line">    <span class="string">&quot;keep_alive&quot;</span>: <span class="string">&quot;1m&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;greening&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在每个返回文档的最后，会有两个结果值，如下所示</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch138.png" alt="image-20220909184930165"></p>
<blockquote>
<p>其中，<code>60</code>就是我们指定的排序方式：基于<code>&#123;&quot;greening&quot;: &#123;&quot;order&quot;: &quot;desc&quot; &#125;&#125;</code>降序排列</p>
</blockquote>
<p>官方文档把这种隐含的字段叫做：tiebreaker （决胜字段），tiebreaker 等价于_shard_doc。</p>
<p>tiebreaker 本质含义：每个文档的唯一值，确保分页不会丢失或者分页结果数据出现重复（相同页重复或跨页重复）。</p>
<h6 id="后续翻页"><a href="#后续翻页" class="headerlink" title="后续翻页"></a>后续翻页</h6><blockquote>
<p>后续翻页都需要借助 search_after 指定前一页的最后一个文档的 sort 字段值，search_after 查询仅支持向后翻页</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 10,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;province&quot;</span>: <span class="string">&quot;河南省&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;pit&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;p9S1AwMbbG9nc3Rhc2gtdmlsbGFnZS0yMDIyLjA4LjIyFlZpT0RxQzZvUV82bnRBZXYzcHZxNXcBFjBmNzN5YllxUVRPYzk2T21OX1BTRXcAAAAAAAAAG58WQVoxcnZfWTFUTVM3WERCM1dDMmgyQQAbbG9nc3Rhc2gtdmlsbGFnZS0yMDIyLjA4LjIyFlZpT0RxQzZvUV82bnRBZXYzcHZxNXcAFkR4U0hEN0dmUVQta19iVER3Z1Nnd2cAAAAAAAAABwoWOE5oeWp5cTRTYnFfeGM3MHNHODFwdwAbbG9nc3Rhc2gtdmlsbGFnZS0yMDIyLjA4LjIyFlZpT0RxQzZvUV82bnRBZXYzcHZxNXcCFkpPc0NlUEdMU0dPU2dkZnFnRGtOTXcAAAAAAAAAGTIWZ3g5WU5EeS1RbWlPM0d6VmpVUUdGUQABFlZpT0RxQzZvUV82bnRBZXYzcHZxNXcAAA==&quot;</span>,</span><br><span class="line">    <span class="string">&quot;keep_alive&quot;</span>: <span class="string">&quot;1m&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;greening&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;search_after&quot;</span>: [</span><br><span class="line">    60,</span><br><span class="line">    8589970292</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch139.png" alt="image-20220909185449896"></p>
<h5 id="优缺点-3"><a href="#优缺点-3" class="headerlink" title="优缺点"></a>优缺点</h5><h6 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h6><ul>
<li>不严格受制于 max_result_window，可以无限制往后翻页（不严格含义：单次请求值不能超过 max_result_window；但总翻页结果集可以超过）</li>
</ul>
<h6 id="缺点-3"><a href="#缺点-3" class="headerlink" title="缺点"></a>缺点</h6><ul>
<li>只支持向后翻页，不支持随机翻页。</li>
</ul>
<h5 id="适用场景-2"><a href="#适用场景-2" class="headerlink" title="适用场景"></a>适用场景</h5><p> 不支持随机翻页，更适合手机端应用的场景</p>
<h5 id="分页原理"><a href="#分页原理" class="headerlink" title="分页原理"></a>分页原理</h5><blockquote>
<p>search_after 查询本质：使用前一页中的一组排序值来检索匹配的下一页</p>
</blockquote>
<p> 可以创建一个时间点 Point In Time（PIT）保障搜索过程中保留特定事件点的索引状态，Point In Time（PIT）是 Elasticsearch 7.10 版本之后才有的新特性，PIT的本质是存储索引数据状态的轻量级视图。</p>
<h6 id="PIT视图"><a href="#PIT视图" class="headerlink" title="PIT视图"></a>PIT视图</h6><blockquote>
<p>如下示例能很好的解读 PIT 视图的内涵。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建 PIT</span></span><br><span class="line">POST customer/_pit?keep_alive=1m</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 获取数据量 2</span></span><br><span class="line">GET customer/_count</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 新增一条数据</span></span><br><span class="line">POST customer/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;user&quot;</span> : <span class="string">&quot;王五&quot;</span>,</span><br><span class="line">    <span class="string">&quot;post_date&quot;</span> : <span class="string">&quot;2022-08-15T14:12:12&quot;</span>,</span><br><span class="line">    <span class="string">&quot;message&quot;</span> : <span class="string">&quot;王五插入一条数据&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 数据总量为 3</span></span><br><span class="line">POST customer/_count</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 查询PIT，数据依然是2，说明走的是之前时间点的视图的统计。</span></span><br><span class="line">POST /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;track_total_hits&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;, </span><br><span class="line">   <span class="string">&quot;pit&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;p9S1AwEIY3VzdG9tZXIWeU8zclhvM09UQzJ2dTZRaGlpZE5ndwAWSk9zQ2VQR0xTR09TZ2RmcWdEa05NdwAAAAAAAAAXVhZneDlZTkR5LVFtaU8zR3pWalVRR0ZRAAEWeU8zclhvM09UQzJ2dTZRaGlpZE5ndwAA&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch140.png" alt="image-20220909183246287"></p>
<p>有了 PIT，search_after 的后续查询都是基于 PIT 视图进行，能有效保障数据的一致性</p>
<h4 id="三种分页方式对比"><a href="#三种分页方式对比" class="headerlink" title="三种分页方式对比"></a>三种分页方式对比</h4><h5 id="性能对比"><a href="#性能对比" class="headerlink" title="性能对比"></a>性能对比</h5><table>
<thead>
<tr>
<th><strong>页方式</strong></th>
<th><strong>1～10</strong></th>
<th><strong>49000～49010</strong></th>
<th><strong>99000～99010</strong></th>
</tr>
</thead>
<tbody><tr>
<td>form+size</td>
<td>8ms</td>
<td>30ms</td>
<td>117ms</td>
</tr>
<tr>
<td>scroll</td>
<td>7ms</td>
<td>66ms</td>
<td>36ms</td>
</tr>
<tr>
<td>search_after</td>
<td>5ms</td>
<td>8ms</td>
<td>7ms</td>
</tr>
</tbody></table>
<h5 id="优缺点对比"><a href="#优缺点对比" class="headerlink" title="优缺点对比"></a>优缺点对比</h5><table>
<thead>
<tr>
<th>分页方式</th>
<th>性能</th>
<th>优点</th>
<th>缺点</th>
<th>场景</th>
</tr>
</thead>
<tbody><tr>
<td>from + size</td>
<td>低</td>
<td>灵活性好，实现简单</td>
<td>深度分页问题</td>
<td>数据量比较小，能容忍深度分页问题</td>
</tr>
<tr>
<td>scroll</td>
<td>中</td>
<td>解决了深度分页问题</td>
<td>无法反应数据的实时性（快照版本）</td>
<td>维护成本高，需要维护一个 scroll_id</td>
</tr>
<tr>
<td>search_after</td>
<td>高</td>
<td>性能最好不存在深度分页问题能够反映数据的实时变更</td>
<td>实现复杂，需要有一个全局唯一的字段连续分页的实现会比较复杂，因为每一次查询都需要上次查询的结果</td>
<td>海量数据的分页</td>
</tr>
</tbody></table>
<h2 id="ElasticSearch-数据存储"><a href="#ElasticSearch-数据存储" class="headerlink" title="ElasticSearch 数据存储"></a>ElasticSearch 数据存储</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch001.png" alt="img"></p>
<h3 id="数据写入"><a href="#数据写入" class="headerlink" title="数据写入"></a>数据写入</h3><p> Elasticsearch采用多Shard方式，通过配置<code>routing</code>规则将数据分成多个数据子集，每个数据子集提供独立的索引和搜索功能，当写入文档的时候，根据routing规则，将文档发送给特定Shard中建立索引，这样就能实现分布式了，此外，Elasticsearch整体架构上采用了一主多副的方式：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch229.png" alt="img"></p>
<p>每个Index由多个Shard组成(默认是1个)，每个Shard有一个主节点和多个副本节点，副本个数可配。</p>
<h4 id="写入过程"><a href="#写入过程" class="headerlink" title="写入过程"></a>写入过程</h4><p> 但每次写入的时候，写入请求会先根据<code>_routing</code>规则选择发给哪个Shard，Index Request中可以设置使用哪个Filed的值作为路由参数，如果没有设置，则使用Mapping中的配置，如果mapping中也没有配置，则使用_id作为路由参数，然后通过_routing的Hash值选择出Shard（在OperationRouting类中），最后从集群的Meta中找出该Shard的Primary节点。</p>
<p> 请求接着会发送给Primary Shard，在Primary Shard上执行成功后，再从Primary Shard上将请求同时发送给多个Replica Shard，请求在多个Replica Shard上执行成功并返回给Primary Shard后，写入请求执行成功，返回结果给客户端。</p>
<p> 在写入时，我们可以在Request自己指定_routing，也可以在Mapping指定文档中的Field值作为_routing，如果没有指定_routing，则会把_id作为_routing进行计算。</p>
<p> 由于写入时，具有相同_routing的文档一定会分配在同一个分片上，所以如果是自定义的_routing，在查询时，一定要指定_routing进行查询，否则是查询不到文档的，这并不是局限性，恰恰相反，指定_routing的查询，性能上会好很多，因为指定_routing意味着直接去存储数据的shard上搜索，而不会搜索所有shard。</p>
<h4 id="写入原理"><a href="#写入原理" class="headerlink" title="写入原理"></a>写入原理</h4><p> 我们可以采用多个副本后，避免了单机或磁盘故障发生时，但是Elasticsearch里为了减少磁盘IO保证读写性能，一般是每隔一段时间（比如30分钟）才会把Lucene的Segment写入磁盘持久化，对于写入内存，但还未Flush到磁盘的Lucene数据，如果发生机器宕机或者掉电，那么内存中的数据也会丢失，这时候如何保证？ES这里采用了预写日志的机制，在ES中预写日志是translog</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch230.png" alt="img"></p>
<h5 id="什么是translog"><a href="#什么是translog" class="headerlink" title="什么是translog"></a>什么是translog</h5><blockquote>
<p>仔细分析下上面ES的refresh和flush，就会发现如果在数据还没有被flush之前，机器宕掉了，那上次flush之后到宕机前的数据就丢了</p>
</blockquote>
<p> 当ES异常恢复时会丢掉最后一次flush之后的数据（如果有的话），这对于绝大多数业务是不能接受的，所以ES引入了translog来解决这个问题,其实也不算什么新技术，就是类似于传统DB里面的预写日志（WAL），不过在ES里面叫事务日志（transaction log），简称translog。</p>
<p> 这样ES的写入的时候，先在内存buffer中进行<code>Lucene documents</code>的写入，写入成功后再写translog，内存buffer中的<code>Lucene documents</code>经过refresh会形成<code>file system cache</code>中的segment，此时内容就可以被搜索到了，然后经过flush，持久化到磁盘上面。</p>
<h5 id="写入过程-1"><a href="#写入过程-1" class="headerlink" title="写入过程"></a>写入过程</h5><blockquote>
<p>在每一个Shard中，写入流程分为两部分，先写入Lucene，再写入TransLog</p>
</blockquote>
<p> 写入请求到达Shard后，先写Lucene文件，创建好索引，此时索引还在内存里面，接着去写TransLog，写完TransLog后，刷新TransLog数据到磁盘上，写磁盘成功后，请求返回给用户，这里有几个关键点：</p>
<p> 和数据库不同，数据库是先写redo log，然后再写内存，而Elasticsearch是先写内存，最后才写TransLog，一种可能的原因是Lucene的内存写入会有很复杂的逻辑，很容易失败，比如分词，字段长度超过限制等，比较重，为了避免TransLog中有大量无效记录，减少recover的复杂度和提高速度，所以就把写Lucene放在了最前面。</p>
<p> 写Lucene内存后，并不是可被搜索的，需要通过Refresh把内存的对象转成完整的Segment后，然后再次reopen后才能被搜索，一般这个时间设置为1秒钟，导致写入Elasticsearch的文档，最快要1秒钟才可被从搜索到，所以Elasticsearch在搜索方面是NRT（Near Real Time）近实时的系统。</p>
<p> 当Elasticsearch作为NoSQL数据库时，查询方式是GetById，这种查询可以直接从TransLog中查询，这时候就成了RT（Real Time）实时系统。</p>
<p> 每隔一段比较长的时间，比如30分钟后，Lucene会把内存中生成的新Segment刷新到磁盘上，刷新后索引文件已经持久化了，历史的TransLog就没用了，会清空掉旧的TransLog。</p>
<p> Lucene缓存中的数据默认1秒之后才生成segment文件，即使是生成了segment文件，这个segment是写到页面缓存中的，并不是实时的写到磁盘，只有达到一定时间或者达到一定的量才会强制flush磁盘。</p>
<p> 如果这期间机器宕掉，内存中的数据就丢了，如果发生这种情况，内存中的数据是可以从TransLog中进行恢复的，TransLog默认是每5秒都会刷新一次磁盘，但这依然不能保证数据安全，因为仍然有可能最多丢失TransLog中5秒的数据。</p>
<p> 这里可以通过配置增加TransLog刷磁盘的频率来增加数据可靠性，最小可配置100ms，但不建议这么做，因为这会对性能有非常大的影响，一般情况下，Elasticsearch是通过副本机制来解决这一问题的。</p>
<h5 id="写入过程分析"><a href="#写入过程分析" class="headerlink" title="写入过程分析"></a>写入过程分析</h5><h6 id="追加事务日志"><a href="#追加事务日志" class="headerlink" title="追加事务日志"></a>追加事务日志</h6><blockquote>
<p>当一个文档被索引，它被加入到内存缓存，同时加到事务日志，不断有新的文档被写入到内存，同时也都会记录到事务日志中，这时新数据还不能被检索和查询。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch113.png" alt="img"></p>
<h6 id="刷新缓存"><a href="#刷新缓存" class="headerlink" title="刷新缓存"></a>刷新缓存</h6><blockquote>
<p>当达到默认的刷新时间或内存中的数据达到一定量后，会触发一次 refresh：</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch114.png" alt="img"></p>
<ol>
<li>这些在内存缓冲区的文档被写入到一个新的段中，且没有进行fsync操作。</li>
<li>这个段被打开，使其可被搜索。</li>
<li>内存缓冲区被清空。</li>
</ol>
<h6 id="继续追加事务日志"><a href="#继续追加事务日志" class="headerlink" title="继续追加事务日志"></a>继续追加事务日志</h6><blockquote>
<p>这个进程继续工作，更多的文档被添加到内存缓冲区和追加到事务日志。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch115.png" alt="img"></p>
<h6 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h6><blockquote>
<p>随着新文档索引不断被写入，当日志数据大小超过 512M 或者时间超过 30 分钟时，会进行一次全提交：</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch116.png" alt="img"></p>
<ol>
<li>内存缓存区的所有文档会写入到新段中，同时清除缓存；</li>
<li>文件系统缓存通过<code>fsync</code>操作<code>flush</code>到硬盘，生成提交点；</li>
<li>事务日志文件被删除，创建一个空的新日志。</li>
</ol>
<h5 id="副本可靠性"><a href="#副本可靠性" class="headerlink" title="副本可靠性"></a>副本可靠性</h5><blockquote>
<p>即使主分片所在节点宕机，丢失了5秒数据，依然是可以通过副本来进行恢复的。</p>
</blockquote>
<p> 引入translog之后，解决了进程突然挂掉或者机器突然宕机导致还处于内存，没有被持久化到磁盘的数据丢失的问题，但数据仅落到磁盘还是无法完全保证数据的安全，比如磁盘损坏等</p>
<p> 分布式领域解决这个问题最直观和最简单的方式就是采用副本机制，比如HDFS、Kafka等都是此类代表，ES也使用了副本的机制，一个索引由一个primary和n（n≥0）个replica组成，replica的个数支持可以通过接口动态调整，为了可靠，primary和replica的shard不能在同一台机器上面。</p>
<p> 在数据写入的时候，数据会先写primary，写成功之后，同时分发给多个replica，待所有replica都返回成功之后，再返回给客户端，所以一个写请求的耗时可以粗略认为是写primary的时间+耗时最长的那个replica的时间。</p>
<h5 id="读写一致性"><a href="#读写一致性" class="headerlink" title="读写一致性"></a>读写一致性</h5><h6 id="数据写入-1"><a href="#数据写入-1" class="headerlink" title="数据写入"></a>数据写入</h6><ol>
<li>ES会将文档发送给协调节点，根据document数据路由到指定的节点，该节点包含该<code>primary shard</code></li>
<li>把文档存储写入到<code>primary shard</code>，如果设置了<code>index.write.wait_for_active_shards=1</code>，那么写完主节点，直接返回客户端，如果 <code>index.write.wait_for_active_shards=all</code>，那么必须要把所有的副本写入完成才返回客户端</li>
<li>如果<code>index.write.wait_for_active_shards=1</code>，那么es会异步的把主分片的数据同步到副本分片上去。(在此期间，可能会出现读请求可能读取不到最新数据的情况)</li>
</ol>
<h6 id="数据读取"><a href="#数据读取" class="headerlink" title="数据读取"></a>数据读取</h6><ol>
<li>客户端发送请求发送到<strong>任意</strong>一个节点，该节点成为协调节点</li>
<li>协调节点根据请求的查询的条件找到文档对应的主分片和副本节点的地址</li>
<li>随机选择一个节点，一般是轮询，可能查询主节点，也可能查询的是副本节点,然后将数据返回给协调节点</li>
<li>协调节点将数据返回给客户端</li>
<li>由于可能存在primary shard的数据还没同步到 replica shard上的情况，所以客户端可能查询到旧的数据，我们可以做相应的调整，保证读取到最新的数据。</li>
</ol>
<h3 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h3><blockquote>
<p>分片是 Elasticsearch 最小的工作单元，一个分片其实就是一个lucene索引，众多的分片组合在一起是一个完整的elasticsearch索引</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch152.png" alt="img"></p>
<h4 id="数据存储原理"><a href="#数据存储原理" class="headerlink" title="数据存储原理"></a>数据存储原理</h4><h5 id="倒排索引不可变"><a href="#倒排索引不可变" class="headerlink" title="倒排索引不可变"></a>倒排索引不可变</h5><blockquote>
<p>倒排索引被写入磁盘后是<code>不可改变</code>的：它永远不会修改。</p>
</blockquote>
<h6 id="不可变优点"><a href="#不可变优点" class="headerlink" title="不可变优点"></a>不可变优点</h6><blockquote>
<p>写入磁盘的倒排索引是不可变的，优势主要表现在</p>
</blockquote>
<ul>
<li>不需要锁，因为如果从来不需要更新一个索引，就不必担心多个程序同时尝试修改，也就不需要锁。</li>
<li>一旦索引被读入内核的文件系统缓存，便会留在哪里，由于其不变性，只要文件系统缓存中还有足够的空间，那么大部分读请求会直接请求内存，而不会命中磁盘，这提供了很大的性能提升。</li>
<li>写入单个大的倒排索引，可以压缩数据，只需要较少磁盘 IO 和缓存索引的内存即可。</li>
</ul>
<h6 id="不可变缺点"><a href="#不可变缺点" class="headerlink" title="不可变缺点"></a>不可变缺点</h6><blockquote>
<p>当然，不可变的索引有它的缺点：</p>
</blockquote>
<ul>
<li>当对旧数据进行删除时，旧数据不会马上被删除，而是在 <code>.del</code>文件中被标记为删除，而旧数据只能等到段更新时才能被移除，这样会造成大量的空间浪费。</li>
<li>若有一条数据频繁的更新，每次更新都是新增新的标记旧的，则会有大量的空间浪费。</li>
<li>每次新增数据时都需要新增一个段来存储数据，当段的数量太多时，对服务器的资源例如文件句柄的消耗会非常大。</li>
<li>在查询的结果中包含所有的结果集，需要排除被标记删除的旧数据，这增加了查询的负担。</li>
</ul>
<h5 id="段的引入"><a href="#段的引入" class="headerlink" title="段的引入"></a>段的引入</h5><blockquote>
<p>在全文检索的早些时候，会为整个文档集合建立一个大索引，并且写入磁盘，只有新的索引准备好了，它就会替代旧的索引，最近的修改才可以被检索，这无疑是低效的，因为上面种种原因，引入了段</p>
</blockquote>
<ul>
<li>新的文档首先写入内存区的索引缓存，这时不可检索。</li>
<li>时不时（默认 1s 一次），内存区的索引缓存被 refresh 到文件系统缓存（该过程比直接到磁盘代价低很多），成为一个新的段（segment）并被打开，这时可以被检索。</li>
<li>新的段提交，写入磁盘，提交后，新的段加入提交点，缓存被清除，等待接收新的文档。</li>
</ul>
<h6 id="什么是段"><a href="#什么是段" class="headerlink" title="什么是段"></a>什么是段</h6><blockquote>
<p>分片下的索引文件被拆分为多个子文件，每个子文件叫作<strong>段</strong>， 每一个段本身都是一个倒排索引，并且段具有不变性，一旦索引的数据被写入硬盘，就不可再修改。</p>
</blockquote>
<p> 段被<strong>写入到磁盘</strong>后会生成一个<strong>提交点</strong>，提交点是一个用来记录所有提交后段信息的文件，一个段一旦拥有了提交点，就说明这个段只有读的权限，失去了写的权限，相反当段在内存中时，就只有写的权限，而不具备读数据的权限，意味着不能被检索。</p>
<h6 id="为什么段不可变"><a href="#为什么段不可变" class="headerlink" title="为什么段不可变"></a>为什么段不可变</h6><blockquote>
<p>在 lucene 中，为了实现高索引速度，故使用了segment 分段架构存储</p>
</blockquote>
<p> 一批写入数据保存在一个段中，其中每个段是磁盘中的单个文件，由于两次写入之间的文件操作非常繁重，因此将一个段设为不可变的，以便所有后续写入都转到新的段。</p>
<h5 id="段的合并"><a href="#段的合并" class="headerlink" title="段的合并"></a>段的合并</h5><blockquote>
<p>由于自动刷新流程每秒会创建一个新的段 ，这样会导致短时间内的段数量暴增</p>
</blockquote>
<h6 id="什么是段合并"><a href="#什么是段合并" class="headerlink" title="什么是段合并"></a>什么是段合并</h6><p> 而段数目太多会带来较大的麻烦，每一个段都会消耗文件句柄、内存和 cpu 运行周期，更重要的是，每个搜索请求都必须轮流检查每个段；所以段越多，搜索也就越慢。</p>
<p> Elasticsearch 通过在后台进行段合并来解决这个问题，小的段被合并到大的段，然后这些大的段再被合并到更大的段。</p>
<p> 段合并的时候会将那些旧的已删除文档从文件系统中清除，被删除的文档（或被更新文档的旧版本）不会被拷贝到新的大段中。</p>
<h6 id="段合并流程"><a href="#段合并流程" class="headerlink" title="段合并流程"></a>段合并流程</h6><blockquote>
<p>启动段合并不需要你做任何事，进行索引和搜索时会自动进行。</p>
</blockquote>
<ol>
<li>当索引的时候，刷新（refresh）操作会创建新的段并将段打开以供搜索使用。</li>
<li>合并进程选择一小部分大小相似的段，并且在后台将它们合并到更大的段中，这并不会中断索引和搜索。</li>
</ol>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch118.png" alt="在这里插入图片描述"></p>
<blockquote>
<p>一旦合并结束，老的段被删除</p>
</blockquote>
<ol>
<li>新的段被刷新（flush）到了磁盘，写入一个包含新段且排除旧的和较小的段的新提交点。</li>
<li>新的段被打开用来搜索。</li>
<li>老的段被删除。</li>
</ol>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch119.png" alt="在这里插入图片描述"></p>
<p> 合并大的段需要消耗大量的 I/O 和 CPU 资源，如果任其发展会影响搜索性能，Elasticsearch在默认情况下会对合并流程进行资源限制，所以搜索仍然 有足够的资源很好地执行。</p>
<p> 默认情况下，归并线程的限速配置 indices.store.throttle.max_bytes_per_sec 是 20MB，对于写入量较大，磁盘转速较高，甚至使用 SSD 盘的服务器来说，这个限速是明显过低的。</p>
<h4 id="索引更新"><a href="#索引更新" class="headerlink" title="索引更新"></a>索引更新</h4><h5 id="如何更新索引"><a href="#如何更新索引" class="headerlink" title="如何更新索引"></a>如何更新索引</h5><blockquote>
<p>因为索引的不可变性带来的好处，那如何在保持不可变同时更新倒排索引？</p>
</blockquote>
<p> 答案是，使用多个索引，<strong>不是重写整个倒排索引，而是增加额外的索引反映最近的变化，</strong>每个倒排索引都可以按顺序查询，从最老的开始，最后把结果聚合。</p>
<h6 id="更新细节"><a href="#更新细节" class="headerlink" title="更新细节"></a>更新细节</h6><blockquote>
<p><strong>索引文件分段存储并且不可修改</strong>，那么新增、更新和删除如何处理呢？</p>
</blockquote>
<ul>
<li>新增，新增很好处理，由于数据是新的，所以只需要对当前文档新增一个段就可以了。</li>
<li>删除，由于不可修改，所以对于删除操作，不会把文档从旧的段中移除，而是通过新增一个 <code>.del</code>文件（每一个提交点都有一个 .del 文件），包含了段上已经被删除的文档。当一个文档被删除，它实际上只是在.del文件中被标记为删除，依然可以匹配查询，但是最终返回之前会被从结果中删除。</li>
<li>更新，不能修改旧的段来进行反映文档的更新，其实更新相当于是删除和新增这两个动作组成，会将旧的文档在 <code>.del</code>文件中标记删除，然后文档的新版本被索引到一个新的段中，可能两个版本的文档都会被一个查询匹配到，但被删除的那个旧版本文档在结果集返回前就会被移除。</li>
</ul>
<h6 id="如何查询"><a href="#如何查询" class="headerlink" title="如何查询"></a>如何查询</h6><blockquote>
<p>当一个查询触发时，所有已知的段按顺序被查询。</p>
</blockquote>
<p> 词项统计会对所有段的结果进行聚合，以保证每个词和每个文档的关联都被准确计算，这种方式可以用相对较低的成本将新文档添加到索引。</p>
<p> 段是不可改变的，所以既不能从把文档从旧的段中移除，也不能修改旧的段来进行反映文档的更新。 取而代之的是，每个提交点会包含一个 .del 文件，文件中会列出这些被删除文档的段信息。</p>
<p> 当一个文档被 “删除” 时，它实际上只是在 .del 文件中被标记删除，一个被标记删除的文档仍然可以被查询匹配到， 但它会在最终结果被返回前从结果集中移除。</p>
<p> 文档更新也是类似的操作方式：当一个文档被更新时，旧版本文档被标记删除，文档的新版本被索引到一个新的段中，可能两个版本的文档都会被一个查询匹配到，但被删除的那个旧版本文档在结果集返回前就已经被移除。</p>
<h3 id="近实时搜索原理"><a href="#近实时搜索原理" class="headerlink" title="近实时搜索原理"></a>近实时搜索原理</h3><blockquote>
<p>随着按段（per-segment）搜索的发展，一个新的文档从索引到可被搜索的延迟显著降低了</p>
</blockquote>
<h4 id="直接写入存在的问题"><a href="#直接写入存在的问题" class="headerlink" title="直接写入存在的问题"></a>直接写入存在的问题</h4><blockquote>
<p>提交一个新的段到磁盘需要<code>fsync</code>操作，确保段被物理地写入磁盘，即时电源失效也不会丢失数据</p>
</blockquote>
<p> 但是<code>fsync</code>是昂贵的，严重影响性能，当写数据量大的时候会造成 ES 停顿卡死，查询也无法做到快速响应,新文档在几分钟之内即可被检索，但这样还是不够快，<strong>磁盘在这里成为了瓶颈</strong>，提交（Commiting）一个新的段到磁盘需要一个<strong>fsync</strong>来确保段被物理性地写入磁盘，这样在断电的时候就不会丢失数据， 但是 fsync <strong>操作代价很大</strong>; 如果每次索引一个文档都去执行一次的话会<strong>造成很大的性能问题</strong>。</p>
<h4 id="延时写策略"><a href="#延时写策略" class="headerlink" title="延时写策略"></a>延时写策略</h4><blockquote>
<p>所以<code>fsync</code>不能在每个文档被索引的时就触发，需要一种更轻量级的方式使新的文档可以被搜索，这意味移除<code>fsync</code>，为了提升写的性能，ES没有每新增一条数据就增加一个段到磁盘上，而是采用<strong>延迟写</strong>的策略。</p>
</blockquote>
<p> 每当有新增的数据时，就将其先写入到内存中，在内存和磁盘之间是文件系统缓存，当达到默认的时间（1秒钟）或者内存的数据达到一定量时，会触发一次刷新（Refresh），将内存中的数据生成到一个新的段上并缓存到文件缓存系统上，稍后再被刷新到磁盘中并生成提交点。</p>
<h4 id="如何实现近实时搜索"><a href="#如何实现近实时搜索" class="headerlink" title="如何实现近实时搜索"></a>如何实现近实时搜索</h4><blockquote>
<p>这里的内存使用的是ES的JVM内存，而文件缓存系统使用的是操作系统文件缓冲区，也就是操作系统内存</p>
</blockquote>
<p> 新的数据会继续的被写入内存，但内存中的数据并不是以段的形式存储的，因此不能提供检索功能，由内存刷新到文件缓存系统的时候会生成了新的段，并将段打开以供搜索使用，而不需要等到被刷新到磁盘。</p>
<p> 在 Elasticsearch 中，这种写入和打开一个新段的轻量的过程叫做 refresh （即内存刷新到文件缓存系统）默认情况下每个分片会每秒自动刷新一次，<strong>这就是为什么说 Elasticsearch 是近实时的搜索了：文档的改动不会立即被搜索，但是会在一秒内可见。</strong></p>
<p> 这些行为可能会对新用户造成困惑: 他们索引了一个文档然后尝试搜索它，但却没有搜到，这个问题的解决办法是用 refresh API 执行一次手动刷新: <strong>/users/_refresh</strong>。</p>
<h4 id="近实时写入测试"><a href="#近实时写入测试" class="headerlink" title="近实时写入测试"></a>近实时写入测试</h4><h5 id="准备工作-4"><a href="#准备工作-4" class="headerlink" title="准备工作"></a>准备工作</h5><blockquote>
<p>下面我们先创建一个索引</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT customer?pretty</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch120.png" alt="image-20220803151216388"></p>
<h5 id="使用默认设置"><a href="#使用默认设置" class="headerlink" title="使用默认设置"></a>使用默认设置</h5><h6 id="写入数据"><a href="#写入数据" class="headerlink" title="写入数据"></a>写入数据</h6><blockquote>
<p>下面我们以正常的方式进行写入</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">POST customer/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;user&quot;</span> : <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="string">&quot;post_date&quot;</span> : <span class="string">&quot;2022-08-15T14:12:12&quot;</span>,</span><br><span class="line">    <span class="string">&quot;message&quot;</span> : <span class="string">&quot;正常模式下写入ES数据&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch121.png" alt="image-20220909152037864"></p>
<h6 id="查询数据-6"><a href="#查询数据-6" class="headerlink" title="查询数据"></a>查询数据</h6><blockquote>
<p>接下来我们马上进行数据的查询</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET customer/_search</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现数据马上就被查询出来了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch122.png" alt="image-20220909154407147"></p>
<h5 id="关闭自动刷新"><a href="#关闭自动刷新" class="headerlink" title="关闭自动刷新"></a>关闭自动刷新</h5><blockquote>
<p>下面我们将自动刷新给关闭掉在进行测试</p>
</blockquote>
<h6 id="关闭自动刷新-1"><a href="#关闭自动刷新-1" class="headerlink" title="关闭自动刷新"></a>关闭自动刷新</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 关闭自动刷新</span><br><span class="line">PUT customer/_settings</span><br><span class="line">&#123; &quot;refresh_interval&quot;: -1 &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>下面我们已经关闭了自动刷新，这个时候数据不会被刷新进段中了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch123.png" alt="image-20220909152344567"></p>
<h6 id="写入数据-1"><a href="#写入数据-1" class="headerlink" title="写入数据"></a>写入数据</h6><blockquote>
<p>下面我们我们在关闭自动刷新的情况下写入数据</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">post customer/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">    &quot;user&quot; : &quot;李四&quot;,</span><br><span class="line">    &quot;post_date&quot; : &quot;2022-08-15T14:12:12&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;关闭自动刷新模式下写入ES数据&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>文档已经被创建成功了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch124.png" alt="image-20220909152521902"></p>
<h6 id="查询数据-7"><a href="#查询数据-7" class="headerlink" title="查询数据"></a>查询数据</h6><blockquote>
<p>接下来我们马上进行数据的查询</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET customer/_search</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现数据还是只有张三而没有李四，说明数据还没有被刷新过来</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch125.png" alt="image-20220909154514772"></p>
<h6 id="开启自动刷新"><a href="#开启自动刷新" class="headerlink" title="开启自动刷新"></a>开启自动刷新</h6><blockquote>
<p>我们开启自动刷新后在进行查询</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 正常模式每一秒刷新一次</span></span><br><span class="line">PUT customer/_settings</span><br><span class="line">&#123; <span class="string">&quot;refresh_interval&quot;</span>: <span class="string">&quot;1s&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#接下来在进行正常的查询来查看效果</span></span><br><span class="line">GET customer/_search</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现李四的数据已经被查询出来了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch126.png" alt="image-20220909154716922"></p>
<h3 id="ES可靠性"><a href="#ES可靠性" class="headerlink" title="ES可靠性"></a>ES可靠性</h3><h4 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h4><blockquote>
<p>ES作为全文检索兼存储系统，数据可靠性至关重要，本文讨论ES是如何实现数据可靠性的，ES底层基于Lucene，所以有必要先搞清楚一些相关的概念。</p>
</blockquote>
<h5 id="refresh-amp-amp-flush-amp-amp-commit"><a href="#refresh-amp-amp-flush-amp-amp-commit" class="headerlink" title="refresh &amp;&amp; flush &amp;&amp; commit"></a>refresh &amp;&amp; flush &amp;&amp; commit</h5><blockquote>
<p>Lucene中，有flush和commit的概念</p>
</blockquote>
<p> 所谓flush，就是定期将内存Buffer里面的数据刷新到Directory这样一个抽象的文件存储层，其实就是生成segment，需要注意的是，<strong>因为操作系统file cache的原因，这里的刷新未必会真的落盘，一般只是从内存buffer刷到了file cache而已，实质还是在内存中，所以是一个相对比较高效和轻量级的操作</strong>，flush方法的java doc是这样描述的：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Moves all in-memory segments to the Directory, but does not commit (fsync) them (call commit() <span class="keyword">for</span> that).</span><br></pre></td></tr></table></figure>

<p> 形成segment以后，数据就可以被搜索了，但因为Lucene flush一般比较频繁（ES里面执行频率默认是1秒），所以会产生很多小的segment文件，一方面太多的文件会占用太多的文件描述符；</p>
<p> 另一方面，搜索时文件太多也会影响搜索效率，所以Lucene有专门的Merge线程定期将小的segment文件merge为大文件。</p>
<p> Lucene的commit上面的Java doc已经提到了，它会调用fsync，commit方法的java doc如下</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Commits all pending changes (added and deleted documents, segment merges, added indexes, etc.) to the index, and syncs all referenced index files, such that a reader will see the changes and the index updates will survive an OS or machine crash or power loss.</span><br></pre></td></tr></table></figure>

<p> 因为会调用fsync，所以commit之后，文件肯定会被持久化到磁盘上，所以这是一个重操作，一方面是磁盘的性能比较差，另一方面是commit的时候会执行更新索引等操作，commit一般是当我们认为系统到达一个稳定点的时候，commit一次，类似于流式系统里面的checkpoint，当系统出现故障的时候，Lucene会从最近的一次commit point进行恢复，而不是最近的一次flush。</p>
<p> 总结一下，flush会生成segment，之后数据就能被搜索了，是一个轻量级操作，但此时并不保证数据被持久化了。commit是一个比较重的落盘操作，用于持久化，不能被频繁执行。</p>
<h5 id="ES-概念"><a href="#ES-概念" class="headerlink" title="ES 概念"></a>ES 概念</h5><p> ES中有refresh和flush的概念，其实是和Lucene一一对应的，不过换了个名字，<strong>ES里面的refresh就是Lucene里面的flush；ES里面的flush就是Lucene里面的commit。</strong>所以，ES里面的refresh默认1秒执行一次，也就是数据写入ES之后最快1秒之后可以被搜索到，这也就是ES提供的近实时搜索NRT（Near Realtime）。而flush的执行时机有两个点：一个是ES会根据内存使用情况启发式的执行flush，另外一个时机是当translog达到512MB（默认值）时执行一次flush。网上很多文章（一般都比较早了）都提到每30分钟也会执行一次，但我在6.6版本的代码及文档里面没有找到这部分说明。</p>
<h4 id="translog"><a href="#translog" class="headerlink" title="translog"></a>translog</h4><p> 仔细想一下上面介绍的Lucene的flush和commit，就会发现如果在数据还没有被commit之前，机器宕掉了，那上次commit之后到宕机前的数据就丢了。实际上，Lucene也是这么做的，异常恢复时会丢掉最后一次commit之后的数据（如果有的话）。这对于绝大多数业务是不能接受的，所以ES引入了translog来解决这个问题。其实也不算什么新技术，就是类似于传统DB里面的预写日志（WAL），不过在ES里面叫事务日志（transaction log），简称translog。</p>
<p> 这样ES的写入的时候，先在内存buffer中进行Lucene documents的写入，写入成功后再写translog。内存buffer中的Lucene documents经过refresh会形成file system cache中的segment，此时，内容就可以被搜索到了。然后经过flush，持久化到磁盘上面。</p>
<h5 id="重要问题"><a href="#重要问题" class="headerlink" title="重要问题"></a>重要问题</h5><ol>
<li>为了保证数据完全的可靠，一般的写入流程都是先写WAL，再写内存，但ES是先写内存buffer，然后再写translog。这个顺序目前没有找到官方的说明，网上大部分说的是写的过程比较复杂，容易出错，先写内存可以降低处理的复杂性。不过这个顺序个人认为对于用户而言其实不是很关键，因为不管先写谁，最终两者都写成功才会返回给客户端。</li>
<li>translog的落盘（即图中的fsync过程）有两种策略，分别对应不同的可靠程度，第一种是每次请求（一个index、update、delete或者bulk操作）都会执行fsync，fsync成功后，才会给客户端返回成功，也就是请求同步刷盘，这种可靠性最高，只要返回成功，那数据一定已经落盘了，这也是默认的方式。第二种是异步的，按照定时达量的方式，默认每5秒或者512MB的时候就fsync一次。异步一般可以获得更高的吞吐量，但弊端是存在数据丢失的风险。</li>
<li>ES的flush（或者Lucene的commit）也是落盘，为什么不直接用，而加一个translog？translog或者所有的WAL的一大特性就是他们都是追加写，这样大多数时候都可以实现顺序读写，读和写可以完全并发，所以性能一般都是非常好的。有一些测试表明，磁盘的顺序写甚至比内存的随机写更快，见<a target="_blank" rel="noopener" href="https://queue.acm.org/detail.cfm?id=1563874">The Pathologies of Big Data</a>的Figure 3。</li>
<li>translog不是全局的，而是每个shard（也就是Lucene的index）一个，且每个shard的所有translog中同一时刻只会有一个translog文件是可写的，其它都是只读的（如果有的话）。具体细节可查看<code>Translog</code>类的Java doc说明。</li>
<li>translog的老化机制在6.0之前是segment flush到磁盘后，就删掉了。6.0之后是按定时达量的策略进行删除，默认是512MB或者12小时。</li>
</ol>
<h4 id="副本-1"><a href="#副本-1" class="headerlink" title="副本"></a>副本</h4><p> 引入translog之后，解决了进程突然挂掉或者机器突然宕机导致还处于内存，没有被持久化到磁盘的数据丢失的问题，但数据仅落到磁盘还是无法完全保证数据的安全，比如磁盘损坏等。分布式领域解决这个问题最直观和最简单的方式就是采用副本机制，比如HDFS、Kafka等都是此类代表，ES也使用了副本的机制。一个索引由一个primary和n（n≥0）个replica组成，replica的个数支持可以通过接口动态调整。为了可靠，primary和replica的shard不能在同一台机器上面。</p>
<p> 这里要注意区分一下replica和shard的关系：比如创建一个索引的时候指定了5个shard，那么此时primary分片就有5个shard，每个replica也会有5个shard。我们可以通过接口随意修改replica的个数，但不能修改每个primary/replica包含5个shard这个事实。 当然，shard的个数也可以通过shrink接口进行调整，但这是一个很重的操作，而且有诸多限制，比如shard个数只能减少，且新个数是原来的因子，比如原来是8个shard，那只能选择调整为4、2或1个；如果原来是5个，那就只能调整为1个了。所以实际中，shard的个数一般要预先计划好（经验值是保证一个shard的大小在30~50GB之间），而replica的个数可以根据实际情况后面再做调整。</p>
<p> 在数据写入的时候，数据会先写primary，写成功之后，同时分发给多个replica，待所有replica都返回成功之后，再返回给客户端。所以一个写请求的耗时可以粗略认为是写primary的时间+耗时最长的那个replica的时间。</p>
<h4 id="写入优化"><a href="#写入优化" class="headerlink" title="写入优化"></a>写入优化</h4><blockquote>
<p>总体来说，ES的写入能力不算太好，所以经常需要对写入性能做优化，除了保证良好的硬件配置外，还可以从ES自身进行机制进行优化，结合上面的介绍，可以很容易得出下面的一些优化手段：</p>
</blockquote>
<ol>
<li>如果对于搜索的实时性要求不高，可以适当增加refresh的时间，比如从默认的1秒改为30秒或者1min，甚至更长。如果是离线导入再搜索的场景，可以直接设置为”-1”，即关闭自动的refresh，等导入完成后，通过接口手动refresh。其提高性能的原理是增加refresh的时间可以减少大量小的segment文件，这样在可以提高flush的效率，减小merge的压力。</li>
<li>如果对于数据可靠性要求不是特别高，可以将translog的落盘机制由默认的请求同步落盘，改为定时达量的异步落盘，提高落盘的效率。</li>
<li>如果对于数据可靠性要求不是特别高，可以在写入高峰期先不设置副本，待过了高峰之后再通过接口增加副本。这个可以通过ES的ILM策略，实现自动化。</li>
</ol>
<h2 id="ElasticSearch-性能调优"><a href="#ElasticSearch-性能调优" class="headerlink" title="ElasticSearch 性能调优"></a>ElasticSearch 性能调优</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch001.png" alt="img"></p>
<h3 id="概述-6"><a href="#概述-6" class="headerlink" title="概述"></a>概述</h3><p> 性能优化是个涉及面非常广的问题，不同的环境，不同的业务场景可能会存在不同的优化方案，本文只对一些相关的知识点做简单的总结，具体方案可以根据场景自行尝试。</p>
<h3 id="配置文件调优"><a href="#配置文件调优" class="headerlink" title="配置文件调优"></a>配置文件调优</h3><blockquote>
<p>通过<code>elasticsearch.yml</code>配置文件调优</p>
</blockquote>
<h4 id="内存锁定"><a href="#内存锁定" class="headerlink" title="内存锁定"></a>内存锁定</h4><blockquote>
<p>允许 JVM 锁住内存，禁止操作系统交换出去</p>
</blockquote>
<p> 由于JVM发生swap交换会导致极大降低ES的性能，为了防止ES发生内存交换，我们可以通过锁定内存来实现，这将极大提高查询性能，但同时可能造成OOM，需要对应做好资源监控，必要的时候进行干预。</p>
<h5 id="修改ES配置"><a href="#修改ES配置" class="headerlink" title="修改ES配置"></a>修改ES配置</h5><blockquote>
<p>修改ES的配置文件elasticsearch.yml，设置bootstrap.memory_lock为true</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#集群名称</span></span><br><span class="line">cluster.name: elastic</span><br><span class="line"><span class="comment">#当前该节点的名称</span></span><br><span class="line">node.name: node-3</span><br><span class="line"><span class="comment">#是不是有资格竞选主节点</span></span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line"><span class="comment">#是否存储数据</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line"><span class="comment">#最大集群节点数</span></span><br><span class="line">node.max_local_storage_nodes: 3</span><br><span class="line"><span class="comment">#给当前节点自定义属性（可以省略）</span></span><br><span class="line"><span class="comment">#node.attr.rack: r1</span></span><br><span class="line"><span class="comment">#数据存档位置</span></span><br><span class="line">path.data: /usr/share/elasticsearch/data</span><br><span class="line"><span class="comment">#日志存放位置</span></span><br><span class="line">path.logs: /usr/share/elasticsearch/<span class="built_in">log</span></span><br><span class="line"><span class="comment">#是否开启时锁定内存（默认为是）</span></span><br><span class="line"><span class="comment">#bootstrap.memory_lock: true</span></span><br><span class="line"><span class="comment">#设置网关地址，我是被这个坑死了，这个地址我原先填写了自己的实际物理IP地址，</span></span><br><span class="line"><span class="comment">#然后启动一直报无效的IP地址，无法注入9300端口，这里只需要填写0.0.0.0</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"><span class="comment">#设置映射端口</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="comment">#内部节点之间沟通端口</span></span><br><span class="line">transport.tcp.port: 9300</span><br><span class="line"><span class="comment">#集群发现默认值为127.0.0.1:9300,如果要在其他主机上形成包含节点的群集,如果搭建集群则需要填写</span></span><br><span class="line"><span class="comment">#es7.x 之后新增的配置，写入候选主节点的设备地址，在开启服务后可以被选为主节点，也就是说把所有的节点都写上</span></span><br><span class="line">discovery.seed_hosts: [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"><span class="comment">#当你在搭建集群的时候，选出合格的节点集群，有些人说的太官方了，</span></span><br><span class="line"><span class="comment">#其实就是，让你选择比较好的几个节点，在你节点启动时，在这些节点中选一个做领导者，</span></span><br><span class="line"><span class="comment">#如果你不设置呢，elasticsearch就会自己选举，这里我们把三个节点都写上</span></span><br><span class="line">cluster.initial_master_nodes: [<span class="string">&quot;node-1&quot;</span>,<span class="string">&quot;node-2&quot;</span>,<span class="string">&quot;node-3&quot;</span>]</span><br><span class="line"><span class="comment">#在群集完全重新启动后阻止初始恢复，直到启动N个节点</span></span><br><span class="line"><span class="comment">#简单点说在集群启动后，至少复活多少个节点以上，那么这个服务才可以被使用，否则不可以被使用，</span></span><br><span class="line">gateway.recover_after_nodes: 2</span><br><span class="line"><span class="comment">#删除索引是是否需要显示其名称，默认为显示</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true</span></span><br><span class="line"><span class="comment"># 允许内存锁定，提高ES性能</span></span><br><span class="line">bootstrap.memory_lock: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h5 id="修改JVM配置"><a href="#修改JVM配置" class="headerlink" title="修改JVM配置"></a>修改JVM配置</h5><blockquote>
<p>修改jvm.options，通常设置-Xms和-Xmx的的值为“物理内存大小的一半和32G的较小值”</p>
</blockquote>
<p> 这是因为，es内核使用lucene，lucene本身是单独占用内存的，并且占用的还不少，<strong>官方建议设置es内存，大小为物理内存的一半，剩下的一半留给lucene</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-Xms2g</span><br><span class="line">-Xmx2g</span><br></pre></td></tr></table></figure>

<h5 id="关闭操作系统的swap"><a href="#关闭操作系统的swap" class="headerlink" title="关闭操作系统的swap"></a>关闭操作系统的swap</h5><h6 id="临时关闭-3"><a href="#临时关闭-3" class="headerlink" title="临时关闭"></a>临时关闭</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo swapoff -a </span><br></pre></td></tr></table></figure>

<h6 id="永久关闭-3"><a href="#永久关闭-3" class="headerlink" title="永久关闭"></a>永久关闭</h6><blockquote>
<p>注释掉或删除所有swap相关的内容</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi /etc/fstab</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch285.png" alt="image-20220818104148323"></p>
<h5 id="修改文件描述符"><a href="#修改文件描述符" class="headerlink" title="修改文件描述符"></a>修改文件描述符</h5><blockquote>
<p>修改/etc/security/limits.conf,设置memlock为unlimited</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">elk hard memlock unlimited</span><br><span class="line">elk soft memlock unlimited</span><br></pre></td></tr></table></figure>

<h5 id="修改系统配置"><a href="#修改系统配置" class="headerlink" title="修改系统配置"></a>修改系统配置</h5><h6 id="设置虚拟内存"><a href="#设置虚拟内存" class="headerlink" title="设置虚拟内存"></a>设置虚拟内存</h6><blockquote>
<p>修改<code>/etc/systemd/system.conf</code>，设置<code>vm.max_map_count</code>为一个较大的值</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vm.max_map_count=10240000</span><br></pre></td></tr></table></figure>

<h6 id="修改文件上限"><a href="#修改文件上限" class="headerlink" title="修改文件上限"></a>修改文件上限</h6><blockquote>
<p>修改<code>/etc/systemd/system.conf</code>，设置DefaultLimitNOFILE，DefaultLimitNPROC，DefaultLimitMEMLOCK为一个较大值，或者不限定</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DefaultLimitNOFILE=100000</span><br><span class="line">DefaultLimitNPROC=100000</span><br><span class="line">DefaultLimitMEMLOCK=infinity</span><br></pre></td></tr></table></figure>

<h5 id="重启ES"><a href="#重启ES" class="headerlink" title="重启ES"></a>重启ES</h5><h4 id="服务发现优化"><a href="#服务发现优化" class="headerlink" title="服务发现优化"></a>服务发现优化</h4><blockquote>
<p>Elasticsearch 默认被配置为使用单播发现，以防止节点无意中加入集群</p>
</blockquote>
<p> 组播发现应该永远不被使用在生产环境了，否则你得到的结果就是一个节点意外的加入到了你的生产环境，仅仅是因为他们收到了一个错误的组播信号，ES是一个P2P类型的分布式系统，使用gossip协议，集群的任意请求都可以发送到集群的任一节点，然后es内部会找到需要转发的节点，并且与之进行通信，在es1.x的版本，es默认是开启组播，启动es之后，可以快速将局域网内集群名称，默认端口的相同实例加入到一个大的集群，后续再es2.x之后，都调整成了单播，避免安全问题和网络风暴；</p>
<p> 单播<code>discovery.zen.ping.unicast.hosts</code>，建议写入集群内所有的节点及端口，如果新实例加入集群，新实例只需要写入当前集群的实例，即可自动加入到当前集群，之后再处理原实例的配置即可，新实例加入集群，不需要重启原有实例；</p>
<p> 节点zen相关配置：<code>discovery.zen.ping_timeout</code>：判断master选举过程中，发现其他node存活的超时设置，主要影响选举的耗时，参数仅在加入或者选举 master 主节点的时候才起作用<code>discovery.zen.join_timeout</code>：节点确定加入到集群中，向主节点发送加入请求的超时时间，默认为3<code>sdiscovery.zen.minimum_master_nodes</code>：参与master选举的最小节点数，当集群能够被选为master的节点数量小于最小数量时，集群将无法正常选举。</p>
<h4 id="故障检测（-fault-detection-）"><a href="#故障检测（-fault-detection-）" class="headerlink" title="故障检测（ fault detection ）"></a>故障检测（ fault detection ）</h4><h5 id="故障检测情况"><a href="#故障检测情况" class="headerlink" title="故障检测情况"></a>故障检测情况</h5><blockquote>
<p>以下两种情况下回进行故障检测</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">* 第一种是由master向集群的所有其他节点发起ping，验证节点是否处于活动状态</span><br><span class="line">* 第二种是：集群每个节点向master发起ping，判断master是否存活，是否需要发起选举</span><br></pre></td></tr></table></figure>

<h5 id="配置方式"><a href="#配置方式" class="headerlink" title="配置方式"></a>配置方式</h5><blockquote>
<p>故障检测需要配置以下设置使用</p>
</blockquote>
<ul>
<li><code>discovery.zen.fd.ping_interval</code> ：节点被ping的频率，默认为1s。</li>
<li><code>discovery.zen.fd.ping_timeout</code> 等待ping响应的时间，默认为 30s，运行的集群中，master 检测所有节点，以及节点检测 master 是否正常。</li>
<li><code>discovery.zen.fd.ping_retries</code> ping失败/超时多少导致节点被视为失败，默认为3。</li>
</ul>
<h4 id="队列数量优化"><a href="#队列数量优化" class="headerlink" title="队列数量优化"></a>队列数量优化</h4><blockquote>
<p>不建议盲目加大es的队列数量，要根据实际情况来进行调整</p>
</blockquote>
<p> 如果是偶发的因为数据突增，导致队列阻塞，加大队列size可以使用内存来缓存数据，如果是持续性的数据阻塞在队列，加大队列size除了加大内存占用，并不能有效提高数据写入速率，反而可能加大es宕机时候，在内存中可能丢失的上数据量。</p>
<h5 id="查看线程池情况"><a href="#查看线程池情况" class="headerlink" title="查看线程池情况"></a>查看线程池情况</h5><blockquote>
<p>通过以下可以查看线程池的情况，哪些情况下，加大队列size呢？</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /_cat/thread_pool</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch286.png" alt="image-20220818111407007"></p>
<p>观察api中返回的queue和rejected，如果确实存在队列拒绝或者是持续的queue，可以酌情调整队列size。</p>
<h4 id="内存使用"><a href="#内存使用" class="headerlink" title="内存使用"></a>内存使用</h4><h5 id="配置熔断限额"><a href="#配置熔断限额" class="headerlink" title="配置熔断限额"></a>配置熔断限额</h5><blockquote>
<p>设置indices的内存熔断相关参数，根据实际情况进行调整，防止写入或查询压力过高导致OOM</p>
</blockquote>
<ul>
<li><code>indices.breaker.total.limit</code>: 50%，集群级别的断路器，默认为jvm堆的70%</li>
<li><code>indices.breaker.request.limit</code>: 10%，单个request的断路器限制，默认为jvm堆的60%</li>
<li><code>indices.breaker.fielddata.limit</code>: 10%，fielddata breaker限制，默认为jvm堆的60%。</li>
</ul>
<h5 id="配置缓存"><a href="#配置缓存" class="headerlink" title="配置缓存"></a>配置缓存</h5><blockquote>
<p>根据实际情况调整查询占用cache，避免查询cache占用过多的jvm内存，参数为静态的，需要在每个数据节点配置</p>
</blockquote>
<ul>
<li><code>indices.queries.cache.size</code>: 5%，控制过滤器缓存的内存大小，默认为10%，接受百分比值，5%或者精确值，例如512mb。</li>
</ul>
<h4 id="创建分片优化"><a href="#创建分片优化" class="headerlink" title="创建分片优化"></a>创建分片优化</h4><blockquote>
<p>如果集群规模较大，可以阻止新建shard时扫描集群内全部shard的元数据，提升shard分配速度</p>
</blockquote>
<ul>
<li><code>cluster.routing.allocation.disk.include_relocations: false</code>，默认为true</li>
</ul>
<h3 id="系统层面调优"><a href="#系统层面调优" class="headerlink" title="系统层面调优"></a>系统层面调优</h3><h4 id="jdk版本"><a href="#jdk版本" class="headerlink" title="jdk版本"></a>jdk版本</h4><blockquote>
<p>选用当前版本ES推荐使用的ES，或者使用ES自带的JDK</p>
</blockquote>
<h4 id="jdk内存配置"><a href="#jdk内存配置" class="headerlink" title="jdk内存配置"></a>jdk内存配置</h4><p> 首先，-Xms和-Xmx设置为相同的值，避免在运行过程中再进行内存分配，同时，如果系统内存小于64G，建议设置略小于机器内存的一半，剩余留给系统使用，同时，jvm heap建议不要超过32G（不同jdk版本具体的值会略有不同），否则jvm会因为内存指针压缩导致内存浪费</p>
<h4 id="关闭交换分区"><a href="#关闭交换分区" class="headerlink" title="关闭交换分区"></a>关闭交换分区</h4><blockquote>
<p>关闭交换分区，防止内存发生交换导致性能下降（部分情况下，宁死勿慢） <code>swapoff -a</code></p>
</blockquote>
<h4 id="文件句柄"><a href="#文件句柄" class="headerlink" title="文件句柄"></a>文件句柄</h4><p> Lucene 使用了 大量的 文件，同时，Elasticsearch 在节点和 HTTP 客户端之间进行通信也使用了大量的套接字，所有这一切都需要足够的文件描述符，默认情况下，linux默认运行单个进程打开1024个文件句柄，这显然是不够的，故需要加大文件句柄数 ulimit -n 65536</p>
<h4 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h4><blockquote>
<p>Elasticsearch 对各种文件混合使用了 NioFs（ 注：非阻塞文件系统）和 MMapFs （ 注：内存映射文件系统）。</p>
</blockquote>
<p> 请确保你配置的最大映射数量，以便有足够的虚拟内存可用于 mmapped 文件。这可以暂时设置：sysctl -w <code>vm.max_map_count=262144</code> 或者你可以在 <code>/etc/sysctl.conf</code> 通过修改 <code>vm.max_map_count</code> 永久设置它。</p>
<h4 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h4><blockquote>
<p>如果你正在使用 SSDs，确保你的系统 I/O 调度程序是配置正确的</p>
</blockquote>
<p> 当你向硬盘写数据，I/O 调度程序决定何时把数据实际发送到硬盘，大多数默认linux 发行版下的调度程序都叫做 cfq（完全公平队列），但它是为旋转介质优化的：机械硬盘的固有特性意味着它写入数据到基于物理布局的硬盘会更高效。</p>
<p> 这对 SSD 来说是低效的，尽管这里没有涉及到机械硬盘，但是，deadline 或者 noop 应该被使用，deadline 调度程序基于写入等待时间进行优化， noop 只是一个简单的 FIFO 队列。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo noop &gt; /sys/block/sd/queue/scheduler</span><br></pre></td></tr></table></figure>

<h4 id="磁盘挂载"><a href="#磁盘挂载" class="headerlink" title="磁盘挂载"></a>磁盘挂载</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mount -o noatime,data=writeback,barrier=0,nobh /dev/sd* /esdata*</span><br></pre></td></tr></table></figure>

<p> 其中，noatime，禁止记录访问时间戳；data=writeback，不记录journal；barrier=0，因为关闭了journal，所以同步关闭barrier；nobh，关闭buffer_head，防止内核影响数据IO</p>
<h4 id="磁盘其他注意事项"><a href="#磁盘其他注意事项" class="headerlink" title="磁盘其他注意事项"></a>磁盘其他注意事项</h4><p> 使用 RAID 0，条带化 RAID 会提高磁盘I/O，代价显然就是当一块硬盘故障时整个就故障了，不要使用镜像或者奇偶校验 RAID 因为副本已经提供了这个功能。</p>
<p> 另外，使用多块硬盘，并允许 Elasticsearch 通过多个 path.data 目录配置把数据条带化分配到它们上面，不要使用远程挂载的存储，比如 NFS 或者 SMB/CIFS。这个引入的延迟对性能来说完全是背道而驰的。</p>
<h3 id="使用方式调优"><a href="#使用方式调优" class="headerlink" title="使用方式调优"></a>使用方式调优</h3><blockquote>
<p>当elasticsearch本身的配置没有明显的问题之后，发现es使用还是非常慢，这个时候，就需要我们去定位es本身的问题了，首先祭出定位问题的第一个命令：</p>
</blockquote>
<h4 id="Index-写-调优"><a href="#Index-写-调优" class="headerlink" title="Index(写)调优"></a>Index(写)调优</h4><h5 id="副本数置0"><a href="#副本数置0" class="headerlink" title="副本数置0"></a>副本数置0</h5><blockquote>
<p>如果是集群首次灌入数据,可以将副本数设置为0，写入完毕再调整回去，这样副本分片只需要拷贝，节省了索引过程</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT /my_temp_index/_settings</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;number_of_replicas&quot;</span>: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="自动生成doc-ID"><a href="#自动生成doc-ID" class="headerlink" title="自动生成doc ID"></a>自动生成doc ID</h5><p> 通过Elasticsearch写入流程可以看出，如果写入doc时如果外部指定了id，则Elasticsearch会先尝试读取原来doc的版本号，以判断是否需要更新，这会涉及一次读取磁盘的操作，通过自动生成doc ID可以避免这个环节</p>
<h5 id="合理设置mappings"><a href="#合理设置mappings" class="headerlink" title="合理设置mappings"></a>合理设置mappings</h5><blockquote>
<p>将不需要建立索引的字段index属性设置为not_analyzed或no。</p>
</blockquote>
<ul>
<li>对字段不分词，或者不索引，可以减少很多运算操作，降低CPU占用，尤其是binary类型，默认情况下占用CPU非常高，而这种类型进行分词通常没有什么意义。</li>
<li>减少字段内容长度，如果原始数据的大段内容无须全部建立 索引，则可以尽量减少不必要的内容。</li>
<li>使用不同的分析器（analyzer），不同的分析器在索引过程中 运算复杂度也有较大的差异。</li>
</ul>
<h5 id="调整-source字段"><a href="#调整-source字段" class="headerlink" title="调整_source字段"></a>调整_source字段</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">_source` 字段用于存储 doc 原始数据，对于部分不需要存储的字段，可以通过 includes excludes过滤，或者将`_source`禁用，一般用于索引和数据分离，这样可以降低 I/O 的压力，不过实际场景中大多不会禁用`_source</span><br></pre></td></tr></table></figure>

<h5 id="对analyzed的字段禁用norms"><a href="#对analyzed的字段禁用norms" class="headerlink" title="对analyzed的字段禁用norms"></a>对analyzed的字段禁用norms</h5><blockquote>
<p>Norms用于在搜索时计算doc的评分，如果不需要评分，则可以将其禁用</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">title<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">&quot;</span><span class="built_in">type</span><span class="string">&quot;: &quot;</span>string<span class="string">&quot;,</span></span><br><span class="line"><span class="string">&quot;</span>norms<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">&quot;</span>enabled<span class="string">&quot;: false</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="调整索引的刷新间隔"><a href="#调整索引的刷新间隔" class="headerlink" title="调整索引的刷新间隔"></a>调整索引的刷新间隔</h5><blockquote>
<p>该参数缺省是1s，强制ES每秒创建一个新segment，从而保证新写入的数据近实时的可见、可被搜索到，比如该参数被调整为30s，降低了刷新的次数，把刷新操作消耗的系统资源释放出来给index操作使用</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT /my_index/_settings</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;index&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;refresh_interval&quot;</span>: <span class="string">&quot;30s&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方案以牺牲可见性的方式，提高了index操作的性能。</p>
<h5 id="批处理"><a href="#批处理" class="headerlink" title="批处理"></a>批处理</h5><blockquote>
<p>批处理把多个index操作请求合并到一个batch中去处理，和mysql的jdbc的bacth有类似之处</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch287.png" alt="在这里插入图片描述"></p>
<p> 比如每批1000个documents是一个性能比较好的size，每批中多少document条数合适，受很多因素影响而不同，如单个document的大小等，ES官网建议通过在单个node、单个shard做性能基准测试来确定这个参数的最优值</p>
<h5 id="Document的路由处理"><a href="#Document的路由处理" class="headerlink" title="Document的路由处理"></a>Document的路由处理</h5><blockquote>
<p>当对一批中的documents进行index操作时，该批index操作所需的线程的个数由要写入的目的shard的个数决定</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch288.png" alt="在这里插入图片描述"></p>
<p> 有2批documents写入ES, 每批都需要写入4个shard，所以总共需要8个线程，如果能减少shard的个数，那么耗费的线程个数也会减少，例如下图，两批中每批的shard个数都只有2个，总共线程消耗个数4个，减少一半。</p>
<p> 默认的routing就是id，也可以在发送请求的时候，手动指定一个routing value，比如说put/index/doc/id?routing=user_id</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch289.png" alt="在这里插入图片描述"></p>
<p> 值得注意的是线程数虽然降低了，但是单批的处理耗时可能增加了。和提高刷新间隔方法类似，这有可能会延长数据不见的时间</p>
<h4 id="Search-读-调优"><a href="#Search-读-调优" class="headerlink" title="Search(读)调优"></a>Search(读)调优</h4><blockquote>
<p>在存储的Document条数超过10亿条后，我们如何进行搜索调优</p>
</blockquote>
<h5 id="数据分组"><a href="#数据分组" class="headerlink" title="数据分组"></a>数据分组</h5><p> 很多人拿ES用来存储日志，日志的索引管理方式一般基于日期的，基于天、周、月、年建索引，如下图，基于天建索引</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch290.png" alt="在这里插入图片描述"></p>
<p> 当搜索单天的数据，只需要查询一个索引的shards就可以，当需要查询多天的数据时，需要查询多个索引的shards，这种方案其实和数据库的分表、分库、分区查询方案相比，思路类似，小数据范围查询而不是大海捞针。</p>
<p> 开始的方案是建一个index，当数据量增大的时候，就扩容增加index的shard的个数，当shards增大时，要搜索的shards个数也随之显著上升，基于数据分组的思路，可以基于client进行数据分组，每一个client只需依赖自己的index的数据shards进行搜索，而不是所有的数据shards，大大提高了搜索的性能，如下图:</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch291.png" alt="在这里插入图片描述"></p>
<h5 id="使用Filter替代Query"><a href="#使用Filter替代Query" class="headerlink" title="使用Filter替代Query"></a>使用Filter替代Query</h5><blockquote>
<p>在搜索时候使用Query，需要为Document的相关度打分，使用Filter，没有打分环节处理，做的事情更少，而且filter理论上更快一些。</p>
</blockquote>
<p> 如果搜索不需要打分，可以直接使用filter查询，如果部分搜索需要打分，建议使用’bool’查询，这种方式可以把打分的查询和不打分的查询组合在一起使用，如</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;must&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;user&quot;</span>: <span class="string">&quot;kimchy&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line"><span class="string">&quot;tag&quot;</span>: <span class="string">&quot;tech&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ID字段定义为keyword"><a href="#ID字段定义为keyword" class="headerlink" title="ID字段定义为keyword"></a>ID字段定义为keyword</h5><p> 一般情况，如果ID字段不会被用作Range 类型搜索字段，都可以定义成keyword类型，这是因为keyword会被优化，以便进行terms查询，Integers等数字类的mapping类型，会被优化来进行range类型搜索，将integers改成keyword类型之后，搜索性能大约能提升30%</p>
<h4 id="hot-threads"><a href="#hot-threads" class="headerlink" title="hot_threads"></a>hot_threads</h4><blockquote>
<p>可以使用以下命令，抓取30s区间内的节点上占用资源的热线程，并通过排查占用资源最多的TOP线程来判断对应的资源消耗是否正常</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /_nodes/hot_threads&amp;interval=30s</span><br></pre></td></tr></table></figure>

<p> 一般情况下，bulk，search类的线程占用资源都可能是业务造成的，但是如果是merge线程占用了大量的资源，就应该考虑是不是创建index或者刷磁盘间隔太小，批量写入size太小造成的。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch292.png" alt="image-20220818113055536"></p>
<h4 id="pending-tasks"><a href="#pending-tasks" class="headerlink" title="pending_tasks"></a>pending_tasks</h4><blockquote>
<p>有一些任务只能由主节点去处理，比如创建一个新的索引或者在集群中移动分片，由于一个集群中只能有一个主节点，所以只有这一master节点可以处理集群级别的元数据变动</p>
</blockquote>
<p> 在99.9999%的时间里，这不会有什么问题，元数据变动的队列基本上保持为零，在一些罕见的集群里，元数据变动的次数比主节点能处理的还快，这会导致等待中的操作会累积成队列，这个时候可以通过pending_tasks api分析当前什么操作阻塞了es的队列，比如，集群异常时，会有大量的shard在recovery，如果集群在大量创建新字段，会出现大量的put_mappings的操作，所以正常情况下，需要禁用动态mapping。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /_cluster/pending_tasks</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch293.png" alt="image-20220818113227223"></p>
<h4 id="字段存储"><a href="#字段存储" class="headerlink" title="字段存储"></a>字段存储</h4><blockquote>
<p>当前es主要有doc_values，fielddata，storefield三种类型，大部分情况下，并不需要三种类型都存储，可根据实际场景进行调整：</p>
</blockquote>
<p> 当前用得最多的就是doc_values，列存储，对于不需要进行分词的字段，都可以开启doc_values来进行存储（且只保留keyword字段），节约内存，当然，开启doc_values会对查询性能有一定的影响，但是，这个性能损耗是比较小的，而且是值得的；</p>
<p> fielddata构建和管理 100% 在内存中，常驻于 JVM 内存堆，所以可用于快速查询，但是这也意味着它本质上是不可扩展的，有很多边缘情况下要提防，如果对于字段没有分析需求，可以关闭fielddata；</p>
<p> storefield主要用于<code>_source</code>字段，默认情况下，数据在写入es的时候，es会将doc数据存储为<code>_source</code>字段，查询时可以通过<code>_source</code>字段快速获取doc的原始结构，如果没有update，reindex等需求，可以将_source字段disable；</p>
<p> <code>_all</code>，ES在6.x以前的版本，默认将写入的字段拼接成一个大的字符串，并对该字段进行分词，用于支持整个doc的全文检索，在知道doc字段名称的情况下，建议关闭掉该字段，节约存储空间，也避免不带字段key的全文检索；</p>
<p> norms：搜索时进行评分，日志场景一般不需要评分，建议关闭；</p>
<h4 id="事务日志"><a href="#事务日志" class="headerlink" title="事务日志"></a>事务日志</h4><blockquote>
<p>Elasticsearch 2.0之后为了保证不丢数据，每次 index、bulk、delete、update 完成的时候，一定会触发同步刷新 translog 到磁盘上，才给请求返回 200 OK</p>
</blockquote>
<h5 id="异步刷新"><a href="#异步刷新" class="headerlink" title="异步刷新"></a>异步刷新</h5><p> 采用异步刷新，这个改变在提高数据安全性的同时当然也降低了一点性能，如果你不在意这点可能性，还是希望性能优先，可以在 index template 里设置如下参数</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;index.translog.durability&quot;</span>: <span class="string">&quot;async&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="其他参数"><a href="#其他参数" class="headerlink" title="其他参数"></a>其他参数</h5><h6 id="index-translog-sync-interval"><a href="#index-translog-sync-interval" class="headerlink" title="index.translog.sync_interval"></a>index.translog.sync_interval</h6><p> 对于一些大容量的偶尔丢失几秒数据问题也并不严重的集群，使用异步的 fsync 还是比较有益的，比如，写入的数据被缓存到内存中，再每5秒执行一次 fsync ，默认为5s，小于的值100ms是不允许的。</p>
<h6 id="index-translog-flush-threshold-size"><a href="#index-translog-flush-threshold-size" class="headerlink" title="index.translog.flush_threshold_size"></a>index.translog.flush_threshold_size</h6><p> translog存储尚未安全保存在Lucene中的所有操作，虽然这些操作可用于读取，但如果要关闭并且必须恢复，则需要重新编制索引，此设置控制这些操作的最大总大小，以防止恢复时间过长，达到设置的最大size后，将发生刷新，生成新的Lucene提交点，默认为512mb。</p>
<h4 id="refresh-interval"><a href="#refresh-interval" class="headerlink" title="refresh_interval"></a>refresh_interval</h4><p> 执行刷新操作的频率，这会使索引的最近更改对搜索可见，默认为1s，可以设置-1为禁用刷新，对于写入速率要求较高的场景，可以适当的加大对应的时长，减小磁盘io和segment的生成；</p>
<h4 id="禁止动态mapping"><a href="#禁止动态mapping" class="headerlink" title="禁止动态mapping"></a>禁止动态mapping</h4><h5 id="动态mapping的缺点"><a href="#动态mapping的缺点" class="headerlink" title="动态mapping的缺点"></a>动态mapping的缺点</h5><ol>
<li>造成集群元数据一直变更，导致 不稳定；</li>
<li>可能造成数据类型与实际类型不一致；</li>
<li>对于一些异常字段或者是扫描类的字段，也会频繁的修改mapping，导致业务不可控。</li>
</ol>
<h5 id="映射配置-1"><a href="#映射配置-1" class="headerlink" title="映射配置"></a>映射配置</h5><blockquote>
<p>动态mapping配置的可选值及含义如下</p>
</blockquote>
<ul>
<li>true：支持动态扩展，新增数据有新的字段属性时，自动添加对于的mapping，数据写入成功</li>
<li>false：不支持动态扩展，新增数据有新的字段属性时，直接忽略，数据写入成功</li>
<li>strict：不支持动态扩展，新增数据有新的字段时，报错，数据写入失败</li>
</ul>
<h4 id="批量写入"><a href="#批量写入" class="headerlink" title="批量写入"></a>批量写入</h4><blockquote>
<p>批量请求显然会大大提升写入速率，且这个速率是可以量化的，官方建议每次批量的数据物理字节数5-15MB是一个比较不错的起点，注意这里说的是物理字节数大小。</p>
</blockquote>
<p> 文档计数对批量大小来说不是一个好指标，比如说，如果你每次批量索引 1000 个文档，记住下面的事实：1000 个 1 KB 大小的文档加起来是 1 MB 大，1000 个 100 KB 大小的文档加起来是 100 MB 大。</p>
<p> 这可是完完全全不一样的批量大小了，批量请求需要在协调节点上加载进内存，所以批量请求的物理大小比文档计数重要得多，从 5–15 MB 开始测试批量请求大小，缓慢增加这个数字，直到你看不到性能提升为止。</p>
<p> 然后开始增加你的批量写入的并发度（多线程等等办法），用iostat 、 top 和 ps 等工具监控你的节点，观察资源什么时候达到瓶颈。如果你开始收到 EsRejectedExecutionException ，你的集群没办法再继续了：至少有一种资源到瓶颈了，或者减少并发数，或者提供更多的受限资源（比如从机械磁盘换成 SSD），或者添加更多节点。</p>
<h4 id="索引和shard"><a href="#索引和shard" class="headerlink" title="索引和shard"></a>索引和shard</h4><blockquote>
<p>es的索引，shard都会有对应的元数据，</p>
</blockquote>
<p> 因为es的元数据都是保存在master节点，且元数据的更新是要hold住集群向所有节点同步的，当es的新建字段或者新建索引的时候，都会要获取集群元数据，并对元数据进行变更及同步，此时会影响集群的响应，所以需要关注集群的index和shard数量，</p>
<h5 id="使用建议"><a href="#使用建议" class="headerlink" title="使用建议"></a>使用建议</h5><blockquote>
<p>建议如下</p>
</blockquote>
<ol>
<li>使用shrink和rollover api，相对生成合适的数据shard数；</li>
<li>根据数据量级及对应的性能需求，选择创建index的名称，形如：按月生成索引：test-YYYYMM，按天生成索引：test-YYYYMMDD；</li>
<li>控制单个shard的size，正常情况下，日志场景，建议单个shard不大于50GB，线上业务场景，建议单个shard不超过20GB；</li>
</ol>
<h4 id="段合并"><a href="#段合并" class="headerlink" title="段合并"></a>段合并</h4><blockquote>
<p>段合并的计算量庞大， 而且还要吃掉大量磁盘 I/O</p>
</blockquote>
<p> 合并在后台定期操作，因为他们可能要很长时间才能完成，尤其是比较大的段，这个通常来说都没问题，因为大规模段合并的概率是很小的。</p>
<p> 如果发现merge占用了大量的资源，可以设置：<code>index.merge.scheduler.max_thread_count: 1</code> 特别是机械磁盘在并发 I/O 支持方面比较差，所以我们需要降低每个索引并发访问磁盘的线程数，这个设置允许 max_thread_count + 2 个线程同时进行磁盘操作，也就是设置为 1 允许三个线程，对于 SSD，你可以忽略这个设置，默认是 Math.min(3, Runtime.getRuntime().availableProcessors() / 2) ，对 SSD 来说运行的很好。</p>
<p> 业务低峰期通过force_merge强制合并segment，降低segment的数量，减小内存消耗；关闭冷索引，业务需要的时候再进行开启，如果一直不使用的索引，可以定期删除，或者备份到hadoop集群；</p>
<h4 id="自动生成-id"><a href="#自动生成-id" class="headerlink" title="自动生成_id"></a>自动生成_id</h4><p> 当写入端使用特定的id将数据写入es时，es会去检查对应的index下是否存在相同的id，这个操作会随着文档数量的增加而消耗越来越大，所以如果业务上没有强需求，建议使用es自动生成的id，加快写入速率。</p>
<h4 id="routing"><a href="#routing" class="headerlink" title="routing"></a>routing</h4><p> 对于数据量较大的业务查询场景，es侧一般会创建多个shard，并将shard分配到集群中的多个实例来分摊压力，正常情况下，一个查询会遍历查询所有的shard，然后将查询到的结果进行merge之后，再返回给查询端。</p>
<p> 此时，写入的时候设置routing，可以避免每次查询都遍历全量shard，而是查询的时候也指定对应的routingkey，这种情况下，es会只去查询对应的shard，可以大幅度降低合并数据和调度全量shard的开销。</p>
<h4 id="使用alias"><a href="#使用alias" class="headerlink" title="使用alias"></a>使用alias</h4><p> 生产提供服务的索引，切记使用别名提供服务，而不是直接暴露索引名称，避免后续因为业务变更或者索引数据需要reindex等情况造成业务中断。</p>
<h4 id="避免宽表"><a href="#避免宽表" class="headerlink" title="避免宽表"></a>避免宽表</h4><p> 在索引中定义太多字段是一种可能导致映射爆炸的情况，这可能导致内存不足错误和难以恢复的情况，这个问题可能比预期更常见，<code>index.mapping.total_fields.limit</code> ，默认值是1000</p>
<h4 id="避免稀疏索引"><a href="#避免稀疏索引" class="headerlink" title="避免稀疏索引"></a>避免稀疏索引</h4><p> 因为索引稀疏之后，对应的相邻文档id的delta值会很大，lucene基于文档id做delta编码压缩导致压缩率降低，从而导致索引文件增大，同时，es的keyword，数组类型采用doc_values结构，每个文档都会占用一定的空间，即使字段是空值，所以稀疏索引会造成磁盘size增大，导致查询和写入效率降低。</p>
<h2 id="ElasticSearch-基础查询"><a href="#ElasticSearch-基础查询" class="headerlink" title="ElasticSearch 基础查询"></a>ElasticSearch 基础查询</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch001.png" alt="img"></p>
<h3 id="概述-7"><a href="#概述-7" class="headerlink" title="概述"></a>概述</h3><blockquote>
<p>查询是 ElasticSearch 核心功能，也是最为丰富有趣的功能，接下来我们开始学习全文查询、词项查询、复合查询、嵌套查询、位置查询、特殊查询等查询功能</p>
</blockquote>
<h4 id="正排索引-1"><a href="#正排索引-1" class="headerlink" title="正排索引"></a>正排索引</h4><blockquote>
<p>在关系型数据库中用到的索引，就是“正排索引”，假如有一张博客表：</p>
</blockquote>
<table>
<thead>
<tr>
<th>id</th>
<th>作者</th>
<th>标题</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>张三</td>
<td>博客标题1</td>
<td>查询是 ElasticSearch 核心功能</td>
</tr>
<tr>
<td>2</td>
<td>李四</td>
<td>博客标题2</td>
<td>也是最为丰富有趣的功能</td>
</tr>
</tbody></table>
<h5 id="索引描述"><a href="#索引描述" class="headerlink" title="索引描述"></a>索引描述</h5><blockquote>
<p>针对这个表建立 id 和标题字段的索引（正排索引）：</p>
</blockquote>
<table>
<thead>
<tr>
<th>索引</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>查询是 ElasticSearch 核心功能</td>
</tr>
<tr>
<td>2</td>
<td>也是最为丰富有趣的功能</td>
</tr>
<tr>
<td>博客标题1</td>
<td>查询是 ElasticSearch 核心功能</td>
</tr>
<tr>
<td>博客标题2</td>
<td>也是最为丰富有趣的功能</td>
</tr>
</tbody></table>
<p> 当我们通过 id 或者标题去查询文章内容时，就可以快速找到。</p>
<p> 但如果我们通过文章内容的关键字去查询，就只能去内容中做字符匹配了，查询效率相当慢！为了提高查询效率，就要考虑使用倒排索引。</p>
<h4 id="倒排索引-1"><a href="#倒排索引-1" class="headerlink" title="倒排索引"></a>倒排索引</h4><blockquote>
<p>倒排索引就是以文章内容的关键字建立索引，通过索引找到文档id，进而找到整个文档：</p>
</blockquote>
<table>
<thead>
<tr>
<th>索引</th>
<th>文档id=1</th>
<th>文档id=2</th>
</tr>
</thead>
<tbody><tr>
<td>查询</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td>是</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>丰富有趣</td>
<td></td>
<td>√</td>
</tr>
<tr>
<td>功能</td>
<td>√</td>
<td>√</td>
</tr>
</tbody></table>
<h5 id="组成部分-1"><a href="#组成部分-1" class="headerlink" title="组成部分"></a>组成部分</h5><blockquote>
<p>一般来说，倒排索引分为两个部分：</p>
</blockquote>
<ol>
<li>词项词典：记录所有的文档词项，以及词项与倒排列表的关联关系。</li>
<li>倒排列表：记录词项与文章内容的关联关系，由一系列倒排索引项组成，倒排索引项包括文档 id、词频（词项在文档中出现的次数，评分时使用）、位置（词项在文档中分词的位置）、偏移（记录词项开始和结束的位置）</li>
</ol>
<h5 id="查询过程"><a href="#查询过程" class="headerlink" title="查询过程"></a>查询过程</h5><blockquote>
<p>ElasticSearch 的查询分为两个过程</p>
</blockquote>
<h6 id="创建索引-13"><a href="#创建索引-13" class="headerlink" title="创建索引"></a>创建索引</h6><p> 当向索引中保存文档时，默认情况下，ElasticSearch 会保存两份内容，一份是 <code>_source</code> 中的数据，另一份则是通过分词、排序等一系列过程生成的倒排索引文件，倒排索引中保存了词项和文档之间的对应关系</p>
<h6 id="查询-1"><a href="#查询-1" class="headerlink" title="查询"></a>查询</h6><p> 当 es 接收到用户的查询请求之后，就会去倒排索引中查询，通过的倒排索引中维护的倒排记录表找到关键词对应的文档集合，然后对文档进行评分、排序、高亮等处理，处理完成后返回文档。</p>
<h4 id="导入数据-1"><a href="#导入数据-1" class="headerlink" title="导入数据"></a>导入数据</h4><blockquote>
<p>因为需要查询，我们先导入一些数据</p>
</blockquote>
<h5 id="创建索引-14"><a href="#创建索引-14" class="headerlink" title="创建索引"></a>创建索引</h5><blockquote>
<p>创建一个书籍管理的索引</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT books</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;publish&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;type&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;author&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;info&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;price&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;double&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="导入脚本"><a href="#导入脚本" class="headerlink" title="导入脚本"></a>导入脚本</h5><blockquote>
<p>执行命令导入数据脚本</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -XPOST <span class="string">&quot;http://192.168.245.151:9200/books/_bulk?pretty&quot;</span> -H <span class="string">&quot;content-type:application/json&quot;</span> --data-binary @bookdata.json</span><br></pre></td></tr></table></figure>

<h3 id="基本查询"><a href="#基本查询" class="headerlink" title="基本查询"></a>基本查询</h3><h4 id="简单查询"><a href="#简单查询" class="headerlink" title="简单查询"></a>简单查询</h4><blockquote>
<p>我们查询所有文档</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">get books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 可以简写为以下形式</span></span><br><span class="line">get books/_search</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch295.png" alt="image-20220808152359145"></p>
<p><code>hits</code> 中是查询结果，<code>total</code> 是符合查询条件的文档数，简单查询默认查询 10 条记录。</p>
<h4 id="词项查询"><a href="#词项查询" class="headerlink" title="词项查询"></a>词项查询</h4><blockquote>
<p>词项查询即 <code>term</code> 查询，根据分词查询，查询指定字段中包含给定单词的文档</p>
</blockquote>
<p><code>term</code> 查询不被解析，只有查询的词和文档中的词精确匹配，才会返回文档，应用场景如：人名、地名等等</p>
<blockquote>
<p>查询 name 字段中包含“计算机”的文档</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">get books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;计算机&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分页查询-2"><a href="#分页查询-2" class="headerlink" title="分页查询"></a>分页查询</h4><blockquote>
<p>查询默认返回前 10 条数据</p>
</blockquote>
<p> ElasticSearch中也可以像关系型数据库一样，设置分页参数，<code>size</code> 设置查询多少条数据， <code>from</code> 设置查询开始的位置</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">get books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;计算机&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 20,</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="过滤返回字段"><a href="#过滤返回字段" class="headerlink" title="过滤返回字段"></a>过滤返回字段</h4><blockquote>
<p>如果返回的字段比较多，又不需要这么多字段，可以通过 <code>_source</code> 指定返回的字段</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">get books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;计算机&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;_source&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;name&quot;</span>,</span><br><span class="line">    <span class="string">&quot;author&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 20,</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="过滤最低评分"><a href="#过滤最低评分" class="headerlink" title="过滤最低评分"></a>过滤最低评分</h4><blockquote>
<p>有的文档得分特别低，说明这个文档和我们查询的关键字相关度很低，可以通过 <code>min_score</code> 设置一个最低分，只有得分超过最低分的文档才会被返回</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">get books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;计算机&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;_source&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;name&quot;</span>,</span><br><span class="line">    <span class="string">&quot;author&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;min_score&quot;</span>: 2.75,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 20,</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="高亮显示"><a href="#高亮显示" class="headerlink" title="高亮显示"></a>高亮显示</h4><blockquote>
<p>通过 <code>highlight</code> 设置查询关键字高亮，这样可以更好的显示搜索的关键字</p>
</blockquote>
<p> Highlight就是我们所谓的高亮，即允许对一个或者对个字段在搜索结果中高亮显示，比如字体加粗或者字体呈现和其他文本普通颜色等。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;计算机&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;_source&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;name&quot;</span>,</span><br><span class="line">    <span class="string">&quot;author&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;min_score&quot;</span>: 2.75,</span><br><span class="line">  <span class="string">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 20,</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="全文查询"><a href="#全文查询" class="headerlink" title="全文查询"></a>全文查询</h3><h4 id="match"><a href="#match" class="headerlink" title="match"></a>match</h4><blockquote>
<p><code>match</code> 会对查询语句进行分词，分词后，如果查询语句中的任何一个词项被匹配，则文档就会被索引到。</p>
</blockquote>
<h5 id="不相关查询"><a href="#不相关查询" class="headerlink" title="不相关查询"></a>不相关查询</h5><blockquote>
<p>查询两个不相关的关键字</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;美术&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;计算机&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch296.png" alt="image-20220808161823937"></p>
<blockquote>
<p>单独查询<strong>美术</strong>和<strong>计算机</strong>时，查询到符合条件的文档数分别是 9 和 46 条。</p>
</blockquote>
<h5 id="合并查询"><a href="#合并查询" class="headerlink" title="合并查询"></a>合并查询</h5><blockquote>
<p>我们在进行合并查询</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;美术计算机&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>合并查询时会对<strong>美术计算机</strong>进行分词，分词之后再去查询，只要文档中包含任意一个分词，就回返回文档，最后查询到符合条件的文档树正好是55条。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch297.png" alt="image-20220808161914839"></p>
<blockquote>
<p>可以看到，分词后词项之间是 OR 的关系，如果想要修改，也可以通过 <code>operator</code> 改为 AND</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;十一五计算机&quot;</span>,</span><br><span class="line">        <span class="string">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="match-phrase"><a href="#match-phrase" class="headerlink" title="match_phrase"></a>match_phrase</h4><blockquote>
<p><code>match_phrase</code> 就是短语查询，也会对查询的关键字进行分词，但是它分词后有两个特点：</p>
</blockquote>
<ul>
<li>分词后的词项顺序必须和文档中词项的顺序一致</li>
<li>所有的词都必须出现在文档中</li>
</ul>
<p> phrase match，就是要去将多个term作为一个短语，一起去搜索，只有包含这个短语的doc才会作为结果返回，match是只在包含其中任何一个分词就返回</p>
<h5 id="什么是近似匹配"><a href="#什么是近似匹配" class="headerlink" title="什么是近似匹配"></a>什么是近似匹配</h5><blockquote>
<p>现假设有两个句子</p>
</blockquote>
<p>１. 普通高等教育“十一五”国家级规划教材：大学计算机基础</p>
<p>２. 普通高等教育“十一五”国家级规划教材：计算机控制系统（第2版）（配光盘）</p>
<h6 id="进行查询"><a href="#进行查询" class="headerlink" title="进行查询"></a>进行查询</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;十一五计算机&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>match query进行搜索，只能搜索到包含<code>十一五</code>或<code>计算机</code>的document，包含<code>十一五</code>或<code>计算机</code>的doc都会被返回回来</p>
</blockquote>
<h6 id="增加需求"><a href="#增加需求" class="headerlink" title="增加需求"></a>增加需求</h6><blockquote>
<p>假如要增加如下需求</p>
</blockquote>
<ol>
<li><code>十一五计算机</code>，就靠在一起，中间不能插入任何其他字符，就要搜索出来这种doc</li>
<li>但是要求，<code>十一五</code>和<code>计算机</code>两个单词靠的越近，doc的分数越高，排名越靠前</li>
<li>我们搜索时，文档中必须包含`十一五计算机这两个文档，且他们之间的距离不能超过５</li>
</ol>
<p> 要实现上述三个需求，用match做全文检索，是搞不定的，必须得用proximity match（近似匹配），proximity match分两种，短语匹配（phrase match）和近似匹配（proximity match）</p>
<h6 id="DSL分析"><a href="#DSL分析" class="headerlink" title="DSL分析"></a>DSL分析</h6><ol>
<li>检索词“十一五计算机”被分词为<strong>两个Token【十一五，Position=0】【计算机，Position=1】</strong></li>
<li>倒排索引检索时，等价于sql：【where Token = 十一五 and <strong>十一五_Position=0</strong> and Token = 计算机 and <strong>计算机_Position=1</strong>】；</li>
</ol>
<p> 如果我们不要求这两个单词相邻，希望放松一点条件，可以添加slop参数，slop代表两个token之间相隔的最多的距离（最多需要移动多少次才能相邻）</p>
<h5 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h5><blockquote>
<p>这里直接使用前面<strong>十一五计算机</strong>短语，并不能查询到文档，因为分词之后，关键字之间还间隔这<strong>国家级规划教材：大学</strong>这些内容</p>
</blockquote>
<p> 这种情况可以使用 <code>slop</code> 参数来指定关键字之间的距离，注意这个距离，不是指关键字之间间隔的字数，而是指它们之间的 position 位置的间隔。</p>
<h6 id="什么是-position"><a href="#什么是-position" class="headerlink" title="什么是 position"></a>什么是 position</h6><blockquote>
<p>每份文档中的字段被分词器解析之后，解析出来的词项都包含一个 position 字段表示词项的位置，每份文档的 position 都从 0 开始，每个词项递增 1</p>
</blockquote>
<h6 id="分词测试"><a href="#分词测试" class="headerlink" title="分词测试"></a>分词测试</h6><blockquote>
<p>因为我们使用的分词器是<code>ik_max_word</code>，这里我们就是用<code>ik_max_word</code>测试分词</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;普通高等教育“十一五”国家级规划教材：大学计算机基础&quot;</span>,</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>下面是分词的结果</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;tokens&quot;</span> : [</span><br><span class="line">   ...</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;token&quot;</span> : <span class="string">&quot;十一五&quot;</span>,</span><br><span class="line">      <span class="string">&quot;start_offset&quot;</span> : 7,</span><br><span class="line">      <span class="string">&quot;end_offset&quot;</span> : 10,</span><br><span class="line">      <span class="string">&quot;type&quot;</span> : <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="string">&quot;position&quot;</span> : 4</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;token&quot;</span> : <span class="string">&quot;十一&quot;</span>,</span><br><span class="line">      <span class="string">&quot;start_offset&quot;</span> : 7,</span><br><span class="line">      <span class="string">&quot;end_offset&quot;</span> : 9,</span><br><span class="line">      <span class="string">&quot;type&quot;</span> : <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="string">&quot;position&quot;</span> : 5</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;token&quot;</span> : <span class="string">&quot;五&quot;</span>,</span><br><span class="line">      <span class="string">&quot;start_offset&quot;</span> : 9,</span><br><span class="line">      <span class="string">&quot;end_offset&quot;</span> : 10,</span><br><span class="line">      <span class="string">&quot;type&quot;</span> : <span class="string">&quot;CN_CHAR&quot;</span>,</span><br><span class="line">      <span class="string">&quot;position&quot;</span> : 6</span><br><span class="line">    &#125;,</span><br><span class="line">   ...</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;token&quot;</span> : <span class="string">&quot;计算机&quot;</span>,</span><br><span class="line">      <span class="string">&quot;start_offset&quot;</span> : 21,</span><br><span class="line">      <span class="string">&quot;end_offset&quot;</span> : 24,</span><br><span class="line">      <span class="string">&quot;type&quot;</span> : <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="string">&quot;position&quot;</span> : 13</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>分词后 <strong>十一五</strong> 最后出现的 position = 6 ，而 <strong>计算机</strong> 第一次出现的 position = 13，中间间隔了 6 个位置，所以只需要设置 <code>slop</code> 为 6 即可查询到文档</p>
</blockquote>
<h5 id="查询-2"><a href="#查询-2" class="headerlink" title="查询"></a>查询</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;十一五计算机&quot;</span>,</span><br><span class="line">        <span class="string">&quot;slop&quot;</span>: 6</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="match-phrase-prefix"><a href="#match-phrase-prefix" class="headerlink" title="match_phrase_prefix"></a>match_phrase_prefix</h4><blockquote>
<p>类似于 <code>match_phrase</code> 查询，只不过这里多了一个通配符，<code>match_phrase_prefix</code> 将最后一个词项作为前缀去查询匹配，但是这种匹配方式效率较低，了解即可，不推荐使用</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_phrase_prefix&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;计&quot;</span>,</span><br><span class="line">        <span class="string">&quot;max_expansions&quot;</span>: 1</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 这个查询过程，会自动进行词项匹配，会自动查找以 <strong>计</strong> 开始的词项，默认是 10 个，我们可以通过 <code>max_expansions</code> 控制值匹配的词项个数。例如以 <strong>计</strong> 开始的词项控制匹配个数为 1 、2 、3 时，匹配到的词项分别为 <strong>计分、计划、计算</strong> 。</p>
<h5 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h5><blockquote>
<p>match_phrase_prefix` 是针对分片级别的查询，每个分片匹配的词项可能不一致。我们现在练习创建的索引分片数为 1 ，所以使用起来并不会有什么问题。但是如果分片数大于 1 时，查询结果就可能有问题。</p>
</blockquote>
<p> 以 <code>match_phrase_prefix</code> 为 1 ，分片数为 3 举例，可能会查询出 3 个匹配词项对应的文档：</p>
<table>
<thead>
<tr>
<th>分片数</th>
<th>匹配词项</th>
<th>文档数</th>
</tr>
</thead>
<tbody><tr>
<td>分片1</td>
<td>计分</td>
<td>2</td>
</tr>
<tr>
<td>分片2</td>
<td>计划</td>
<td>1</td>
</tr>
<tr>
<td>分片3</td>
<td>计算</td>
<td>46</td>
</tr>
</tbody></table>
<h4 id="multi-match"><a href="#multi-match" class="headerlink" title="multi_match"></a>multi_match</h4><blockquote>
<p>multi_match查询提供了一个简便的方法用来对多个字段执行相同的查询</p>
</blockquote>
<h5 id="查询-3"><a href="#查询-3" class="headerlink" title="查询"></a>查询</h5><blockquote>
<p>同时查询<code>name</code>以及<code>info</code>字段包含<code>java</code>的文档</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: <span class="string">&quot;java&quot;</span>,</span><br><span class="line">      <span class="string">&quot;fields&quot;</span>: [<span class="string">&quot;name&quot;</span>,<span class="string">&quot;info&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h6><ul>
<li><strong>query</strong>： 来自用户输入的查询短语</li>
</ul>
<p><strong>fields</strong>： 数组，默认支持最大长度1024，可以单独为任意字段设置相关度权重，支持通配符；fields可以为空，为空时会取mapping阶段配置的所有支持term查询的filed组合在一起进行查询</p>
<h4 id="query-string"><a href="#query-string" class="headerlink" title="query_string"></a>query_string</h4><blockquote>
<p>query_string 是 ES DSL 查询中最为强大的查询语句，支持非常复杂的语法，适合用来做自己的搜索引擎</p>
</blockquote>
<h5 id="基本查询-1"><a href="#基本查询-1" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>查询<code>name</code>字段包含<code>十一五</code>和<code>计算机</code>的文档</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;default_field&quot;: &quot;name&quot;,</span><br><span class="line">      &quot;query&quot;: &quot;(十一五) AND (计算机)&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="更多待补充"><a href="#更多待补充" class="headerlink" title="更多待补充"></a>更多待补充</h6><h4 id="simple-query-string"><a href="#simple-query-string" class="headerlink" title="simple_query_string"></a>simple_query_string</h4><blockquote>
<p>这个是 <code>query_string</code> 的升级，可以直接使用 +、|、- 代替 AND、OR、NOT 等</p>
</blockquote>
<p> <code>simple_query_string</code> 使用 fields 来指定查询的字段，即使只指定一个字段，值也必须为数组类型</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;simple_query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;fields&quot;</span>: [<span class="string">&quot;name&quot;</span>],</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: <span class="string">&quot;(十一五) + (计算机)&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="词项查询-1"><a href="#词项查询-1" class="headerlink" title="词项查询"></a>词项查询</h3><blockquote>
<p>词项查询，也就是 <code>term</code> 查询，以及以 <code>term</code> 延伸的词项查询</p>
</blockquote>
<p> 我们已经多次涉及到这个技能点，但是没有细讲，今天我们就来从头理一下 <code>term</code> 查询</p>
<h4 id="term"><a href="#term" class="headerlink" title="term"></a>term</h4><blockquote>
<p><code>term</code> 不会对查询字符进行分词，直接拿查询字符去倒排索引中比对</p>
</blockquote>
<h5 id="基本查询-2"><a href="#基本查询-2" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>下面我们查询以下<code>计算机</code>为关键字进行查询</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;计算机&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现是可以查询出来数据的</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch298.png" alt="image-20220808173157577"></p>
<h5 id="语句查询"><a href="#语句查询" class="headerlink" title="语句查询"></a>语句查询</h5><blockquote>
<p>下面我们找一个未分词的<code>计算机应用</code>进行查询</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;计算机应用&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>因为直接到倒排词库查询，所以是查询不出来结果的</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch299.png" alt="image-20220808173331437"></p>
<h4 id="terms"><a href="#terms" class="headerlink" title="terms"></a>terms</h4><blockquote>
<p>使用多个关键字进行查询，参数为数组类型，关键字之间的关系为 OR 。</p>
</blockquote>
<h5 id="基本查询-3"><a href="#基本查询-3" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>只要<code>name</code>任意包含下面的任意一个就可以查询出来</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: [<span class="string">&quot;计算机&quot;</span>,<span class="string">&quot;应用&quot;</span>,<span class="string">&quot;科学&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch300.png" alt="image-20220808173741222"></p>
<h5 id="Terms-lookup"><a href="#Terms-lookup" class="headerlink" title="Terms lookup"></a>Terms lookup</h5><blockquote>
<p><code>terms</code> 中除了简单的多个关键字查询，还支持 <strong>Terms lookup</strong> 查询</p>
</blockquote>
<p> 先查询获取已知文档的字段值，然后再将这些值用作关键字查询其他文档，有点类似于关系型数据库中的子查询，支持跨字段或者跨索引。</p>
<h6 id="参数介绍"><a href="#参数介绍" class="headerlink" title="参数介绍"></a>参数介绍</h6><blockquote>
<p>首先介绍一下 <strong>Terms lookup</strong> 的参数：</p>
</blockquote>
<table>
<thead>
<tr>
<th>字段</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>index</td>
<td>必填，已知文档所在的索引。</td>
</tr>
<tr>
<td>id</td>
<td>必填，已知文档的ID。</td>
</tr>
<tr>
<td>path</td>
<td>必填，需要获取的文档字段值。</td>
</tr>
<tr>
<td>routing</td>
<td>选填，文档的路由值，如果在为文档建立索引时提供了自定义路由值，则此参数是必需的。</td>
</tr>
</tbody></table>
<h6 id="准备数据"><a href="#准备数据" class="headerlink" title="准备数据"></a>准备数据</h6><blockquote>
<p>新建索引，添加一个文档，name 字段包含三个作者的名字</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT author/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: [&quot;吴尧&quot;, &quot;朱家雄&quot;, &quot;朱彦鹏，罗晓辉，周勇&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="查询数据-8"><a href="#查询数据-8" class="headerlink" title="查询数据"></a>查询数据</h6><blockquote>
<p>使用 author 索引中 id 为 1 的 name 字段值作为查询关键字</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;author&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;author&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>: <span class="string">&quot;name&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch301.png" alt="image-20220808174150128"></p>
<h6 id="注意事项-8"><a href="#注意事项-8" class="headerlink" title="注意事项"></a>注意事项</h6><p> 默认情况下，Elasticsearch 将 <code>terms</code> 查询限制为最多65536个关键字，包括 <strong>Terms lookup</strong> 查询出来的关键字，可以通过 <code>index.max_terms_count</code>修改限制</p>
<h4 id="range"><a href="#range" class="headerlink" title="range"></a>range</h4><blockquote>
<p><code>range</code> 可以进行范围查询，按照日期范围、数字范围等查询。</p>
</blockquote>
<h5 id="参数介绍-1"><a href="#参数介绍-1" class="headerlink" title="参数介绍"></a>参数介绍</h5><blockquote>
<p><code>range</code> 中的主要参数：</p>
</blockquote>
<table>
<thead>
<tr>
<th>字段</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>gt</td>
<td>大于</td>
</tr>
<tr>
<td>gte</td>
<td>大于或等于。</td>
</tr>
<tr>
<td>lt</td>
<td>小于。</td>
</tr>
<tr>
<td>lte</td>
<td>小于或等于。</td>
</tr>
<tr>
<td>format</td>
<td>日期格式，如果不指定将使用 mapping 中定义日期格式。</td>
</tr>
<tr>
<td>relation</td>
<td>指定范围查询如何匹配 <code>range</code> 字段的值，可选值为： - INTERSECTS <strong>（默认值）</strong>：将文档的范围字段值与查询范围相交。 - CONTAINS：使用范围字段值完全包含查询范围的文档进行匹配。 - WITHIN：使用范围字段值完全在查询范围内的文档进行匹配。</td>
</tr>
</tbody></table>
<h5 id="基本查询-4"><a href="#基本查询-4" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>查询价格范围是10-20之间的书籍，并且对价格进行倒序排序</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;gte&quot;</span>: 10,</span><br><span class="line">        <span class="string">&quot;lte&quot;</span>: 20</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;_source&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;name&quot;</span>,</span><br><span class="line">    <span class="string">&quot;price&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch302.png" alt="image-20220808174759168"></p>
<h4 id="exists"><a href="#exists" class="headerlink" title="exists"></a>exists</h4><blockquote>
<p><code>exists</code> 可以判断字段是否为空，可以指定多个字段，只返回指定字段中至少有一个非空值的文档</p>
</blockquote>
<h5 id="基本查询-5"><a href="#基本查询-5" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>books 中不存在 amby 字段的书籍</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;exists&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;field&quot;</span>: <span class="string">&quot;amby&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> 空字符串也是有值，null 才是空值。</p>
<h4 id="prefix"><a href="#prefix" class="headerlink" title="prefix"></a>prefix</h4><blockquote>
<p><code>prefix</code> 用于前缀查询，效率略低，除非必要，一般不推荐使用。</p>
</blockquote>
<h5 id="基本查询-6"><a href="#基本查询-6" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>查找书籍中以大学开头的文档</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;prefix&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;大学&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch303.png" alt="image-20220808175059491"></p>
<h4 id="wildcard"><a href="#wildcard" class="headerlink" title="wildcard"></a>wildcard</h4><blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wildcard` 即通配符查询，支持单字符 `?` 和多字符 `*</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="基本查询-7"><a href="#基本查询-7" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>查询所有姓张的作者的书</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查询所有姓张的作者的书</span></span><br><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;wildcard&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;author&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;张*&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 查询所有姓张并且名字只有两个字的作者的书</span></span><br><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;wildcard&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;author&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;张?&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="regexp"><a href="#regexp" class="headerlink" title="regexp"></a>regexp</h4><blockquote>
<p>正则表达式查询</p>
</blockquote>
<h5 id="基本查询-8"><a href="#基本查询-8" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>查询所有姓张并且名字只有两个字的作者的书</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;regexp&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;author&quot;</span>: <span class="string">&quot;张.&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="fuzzy"><a href="#fuzzy" class="headerlink" title="fuzzy"></a>fuzzy</h4><blockquote>
<p>在实际搜索中，有时我们可能会打错字，从而导致搜索不到，在 <code>match</code> 全文查询中，可以通过 <code>fuzziness</code> 属性实现模糊查询，而在词项查询中，就可以使用<code>fuzzy</code> 查询与搜索关键字相似的文档。</p>
</blockquote>
<h5 id="什么是相似度"><a href="#什么是相似度" class="headerlink" title="什么是相似度"></a>什么是相似度</h5><blockquote>
<p>怎么样就算相似？以 LevenShtein 编辑距离为准，编辑距离是指将一个字符变为另一个字符所需要更改字符的次数，更改主要包括四种：</p>
</blockquote>
<ul>
<li>更改字符 （ javb &gt;&gt; java ）</li>
<li>删除字符 （ javva &gt;&gt; java ）</li>
<li>插入字符 （ jaa &gt;&gt; java ）</li>
<li>转置字符 （ jaav &gt;&gt; java ）</li>
</ul>
<p>为了找到相似的词，模糊查询会在指定的编辑距离中创建搜索关键词的所有可能变化或者扩展的集合，然后进行搜索匹配。</p>
<h5 id="基本查询-9"><a href="#基本查询-9" class="headerlink" title="基本查询"></a>基本查询</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;fuzzy&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;javba&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现输入错误的字符可以搜索出来正确的文档</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch304.png" alt="image-20220808175932916"></p>
<h4 id="ids"><a href="#ids" class="headerlink" title="ids"></a>ids</h4><blockquote>
<p>根据ID进行查询</p>
</blockquote>
<h5 id="基本查询-10"><a href="#基本查询-10" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>查询ID是1、2、3的文档</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;ids&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;values&quot;</span>:  [1,2,3]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="复合查询"><a href="#复合查询" class="headerlink" title="复合查询"></a>复合查询</h3><h4 id="constant-score"><a href="#constant-score" class="headerlink" title="constant_score"></a>constant_score</h4><blockquote>
<p>当我们使用全文查询或词项查询时，ElasticSearch 默认会根据词频（TF）对查询结果进行评分，再根据评分排序后返回查询结果。</p>
</blockquote>
<p> 如果我们不关心检索词频（TF）对搜索结果排序的影响时，可以使用 <code>constant_score</code> 将查询语句或者过滤语句包裹起来。</p>
<h5 id="基本查询-11"><a href="#基本查询-11" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>查询关键字是java的文档</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="忽略评分"><a href="#忽略评分" class="headerlink" title="忽略评分"></a>忽略评分</h5><blockquote>
<p>这样查询我们就可以忽略评分，忽略评分后默认显示评分是<code>1.0</code>分，boost设置显示评分未<code>1.5</code></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;constant_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;name&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;boost&quot;</span>: 1.5</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="bool"><a href="#bool" class="headerlink" title="bool"></a>bool</h4><blockquote>
<p><code>bool</code> 底层使用的是 Lucene 的 <code>BooleanQuery</code> ，可以将任意多个简单查询组装在一起</p>
</blockquote>
<h5 id="关键参数"><a href="#关键参数" class="headerlink" title="关键参数"></a>关键参数</h5><blockquote>
<p>有四个关键字可供选择，四个关键字所描述的条件可以有一个或者多个</p>
</blockquote>
<table>
<thead>
<tr>
<th>字段</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>must</td>
<td>文档必须匹配 must 选项下的查询条件。</td>
</tr>
<tr>
<td>should</td>
<td>文档可以匹配 should 下的查询条件，也可以不匹配。</td>
</tr>
<tr>
<td>must_not</td>
<td>文档必须不满足 must_not 选项下的查询条件。</td>
</tr>
<tr>
<td>filter</td>
<td>类似于 must，但是 filter 不评分，只是过滤数据。</td>
</tr>
</tbody></table>
<h5 id="基本查询-12"><a href="#基本查询-12" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>查询 name 字段中必须包含 “计算”，同时书价不在 [0,30] 区间内，info 字段可以包含 “程序设计” 也可以不包含</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;计算&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;must_not&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;gte&quot;</span>: 1,</span><br><span class="line">              <span class="string">&quot;lte&quot;</span>: 30</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;should&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;info&quot;</span>: <span class="string">&quot;程序设计&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 40</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="minmum-should-match"><a href="#minmum-should-match" class="headerlink" title="minmum_should_match"></a>minmum_should_match</h5><blockquote>
<p><code>bool</code> 查询还涉及到一个关键字 <code>minmum_should_match</code> 参数，在 ElasticSearch 官网上称作 “最小匹配度”</p>
</blockquote>
<p> 在之前学习的 <code>match</code> 或者这里的 <code>should</code> 查询中，都可以设置 <code>minmum_should_match</code> 参数</p>
<h6 id="查询分析"><a href="#查询分析" class="headerlink" title="查询分析"></a>查询分析</h6><blockquote>
<p>查询 name 中包含 “程序设计” 关键字的文档</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;程序设计&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="关键字分词"><a href="#关键字分词" class="headerlink" title="关键字分词"></a>关键字分词</h6><blockquote>
<p>例如上面的查询，查询的时候首先会对查询的关键字进行分词</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;程序设计&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>分词的结果是：[“程序设计”,”程序”,”设计”]，然后使用 <code>should</code> 将分词后的每一个词项查询 <code>term</code> 子句组合构成一个 <code>bool</code> 查询，换句话说，上面的查询和下面的查询等价：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;should&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;程序设计&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;程序&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;设计&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 在这两个查询语句中，都是文档只需要包含词项中的任意一项即可，文档就回被返回，在 <code>match</code> 查询中，可以通过 <code>operator</code> 参数设置文档必须匹配所有词项。</p>
<h6 id="部分匹配"><a href="#部分匹配" class="headerlink" title="部分匹配"></a>部分匹配</h6><blockquote>
<p>但如果只想匹配一部分词项，就要使用 <code>minmum_should_match</code>，指定至少匹配的词项，可以指定个数或者百分比，以下三个查询等价：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;程序设计&quot;</span>,</span><br><span class="line">        <span class="string">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定个数</span></span><br><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;程序设计&quot;</span>,</span><br><span class="line">        <span class="string">&quot;minimum_should_match&quot;</span>: 3</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 指定百分比</span></span><br><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;should&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;程序设计&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;程序&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;设计&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;minimum_should_match&quot;</span>: <span class="string">&quot;100%&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="dis-max"><a href="#dis-max" class="headerlink" title="dis_max"></a>dis_max</h4><blockquote>
<p>返回与一个或多个包装查询（称为查询子句或子句）匹配的文档</p>
</blockquote>
<p> 如果返回的文档与多个查询子句匹配，则该dis_max查询会为该文档分配来自所有匹配子句的最高相关性得分，再加上所有其他匹配子查询的平局打破增量</p>
<h5 id="准备数据-1"><a href="#准备数据-1" class="headerlink" title="准备数据"></a>准备数据</h5><blockquote>
<p>为了更好的演示dis_max，我们加入一些数据</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;content&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST blog/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>:<span class="string">&quot;如何通过Java代码调用Redis&quot;</span>,</span><br><span class="line">  <span class="string">&quot;content&quot;</span>:<span class="string">&quot;真实一偏很好的针对于Redis缓存的解决方案&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST blog/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>:<span class="string">&quot;初识 MongoDB&quot;</span>,</span><br><span class="line">  <span class="string">&quot;content&quot;</span>:<span class="string">&quot;简单介绍一下 MongoDB，以及如何通过 Java 调用 MongoDB，MongoDB 是一个不错 NoSQL 解决方案&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="基本查询-13"><a href="#基本查询-13" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>现在搜索 “<strong>Java解决方案</strong>” 关键字，但是不确定关键字是在 title 还是在 content，所以两者都搜索</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;should&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Java解决方案&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: <span class="string">&quot;Java解决方案&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>按照我们理解，第二篇文档中的content同时包含了 “<strong>Java</strong>” 和 “<strong>解决方案</strong>” ，应该评分更高，但是实际搜索并非这样，第一篇文档的评分反而比较高：</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch305.png" alt="image-20220808183801659"></p>
<h5 id="should评分策略"><a href="#should评分策略" class="headerlink" title="should评分策略"></a>should评分策略</h5><blockquote>
<p>要理解为什么会这样，我们需要看一下 <code>should</code> 查询的评分策略：</p>
</blockquote>
<ol>
<li>首先执行 <code>should</code> 中的所有查询</li>
<li>对所有查询结果的评分求和</li>
<li>对求和结果 <code>*</code>有查询结果的子句数量</li>
<li>再将上一步结果 <code>/</code> 所有查询子句数量</li>
</ol>
<h6 id="第一篇"><a href="#第一篇" class="headerlink" title="第一篇"></a>第一篇</h6><ol>
<li>title 中 包含 <strong>Java</strong>，假设评分是 1.1</li>
<li>content 中包含 <strong>解决方案</strong>，假设评分是 1.2</li>
<li>有查询结果的子句数量为 2</li>
<li>所有查询子句数量也是 2</li>
<li>最终结果：<code>（1.1 + 1.2）* 2 / 2 = 2.3</code></li>
</ol>
<h6 id="第二篇"><a href="#第二篇" class="headerlink" title="第二篇"></a>第二篇</h6><ol>
<li>title 中 不包含查询关键字，没有得分</li>
<li>content 中包含 <strong>Java</strong> 和 <strong>解决方案</strong>，假设评分时 2</li>
<li>有查询结果的子句数量为 1</li>
<li>所有查询子句数量也是 2</li>
<li>最终结果：<code>2 * 1 / 2 = 1</code></li>
</ol>
<h5 id="如何解决"><a href="#如何解决" class="headerlink" title="如何解决"></a>如何解决</h5><blockquote>
<p>在 <code>should</code> 查询中，title 和 content 相当于是相互竞争的关系。</p>
</blockquote>
<p> 为了解决这一问题，就需要用到 <code>dis_max</code> （disjunction max query，分离最大化查询）：匹配的文档依然返回，但是只将最佳匹配的子句评分作为查询的评分。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;dis_max&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;queries&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Java解决方案&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: <span class="string">&quot;Java解决方案&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="查询过程-1"><a href="#查询过程-1" class="headerlink" title="查询过程"></a>查询过程</h5><h6 id="第一篇-1"><a href="#第一篇-1" class="headerlink" title="第一篇"></a>第一篇</h6><ol>
<li>title 中 包含 <strong>Java</strong>，假设评分是 1.1</li>
<li>content 中包含 <strong>解决方案</strong>，假设评分是 1.2</li>
<li>最后取两个子句中的最高分作为文档的最后得分，即 1.2</li>
</ol>
<h6 id="第二篇-1"><a href="#第二篇-1" class="headerlink" title="第二篇"></a>第二篇</h6><ol>
<li>title 中 不包含查询关键字，没有得分</li>
<li>content 中包含 <strong>Java</strong> 和 <strong>解决方案</strong>，假设评分时 2</li>
<li>最后取两个子句中的最高分作为文档的最后得分，即 2</li>
<li>所以最后第二篇的得分高于第一篇，符合我们的需求。</li>
</ol>
<h5 id="其他参数-1"><a href="#其他参数-1" class="headerlink" title="其他参数"></a>其他参数</h5><h6 id="tie-breaker"><a href="#tie-breaker" class="headerlink" title="tie_breaker"></a>tie_breaker</h6><p> 在 <code>dis_max</code> 查询中，只考虑最佳匹配子句的评分，完全不考虑其他子句的评分。但是，有的时候，我们又不得不考虑一下其他 query 的分数，此时，可以通过 <code>tie_breaker</code> 参数来优化。</p>
<h6 id="tie-breaker-1"><a href="#tie-breaker-1" class="headerlink" title="tie_breaker"></a>tie_breaker</h6><p> 参数取值范围：0 ~ 1，默认取值为 0，会将其他查询子句的评分，乘以 <code>tie_breaker</code> 参数，然后再和最佳匹配的子句进行综合计算</p>
<h4 id="function-score"><a href="#function-score" class="headerlink" title="function_score"></a>function_score</h4><blockquote>
<p>例如想要搜索附近的肯德基，搜索的关键字是肯德基，我希望能够将评分较高的肯德基餐厅优先展示出来。</p>
</blockquote>
<p> 但是默认的评分策略是没有办法考虑到餐厅评分的，他只是考虑相关性，这个时候可以通过 <code>function_score query</code> 来实现。</p>
<h5 id="准备数据-2"><a href="#准备数据-2" class="headerlink" title="准备数据"></a>准备数据</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;votes&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>:<span class="string">&quot;Java集合详解&quot;</span>,</span><br><span class="line">  <span class="string">&quot;votes&quot;</span>:100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT blog/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>:<span class="string">&quot;Java多线程详解，Java锁详解&quot;</span>,</span><br><span class="line">  <span class="string">&quot;votes&quot;</span>:10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="基本查询-14"><a href="#基本查询-14" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>查询标题中包含 <strong>java</strong> 关键字的文档：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>因为第二篇文档的 title 中有两个 java，所有得分会比较高</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch306.png" alt="image-20220808193834790"></p>
<h5 id="考虑votes评分"><a href="#考虑votes评分" class="headerlink" title="考虑votes评分"></a>考虑votes评分</h5><blockquote>
<p>如果希望能够考虑 votes 字段，将 votes 高的文档优先展示，就可以通过 <code>function_score</code> 来实现。</p>
</blockquote>
<p> 具体的思路，就是在旧的得分基础上，根据 votes 的数值进行综合运算，重新得出一个新的评分，具体的计算方式有以下几种：</p>
<ul>
<li><code>weight</code></li>
<li><code>random_score</code></li>
<li><code>script_score</code></li>
<li><code>field_value_factor</code></li>
</ul>
<h5 id="weight"><a href="#weight" class="headerlink" title="weight"></a>weight</h5><blockquote>
<p><code>weight</code> 可以对评分设置权重，在旧的评分基础上乘以 <code>weight</code>，他其实无法解决我们上面所说的问题</p>
</blockquote>
<h6 id="基本查询-15"><a href="#基本查询-15" class="headerlink" title="基本查询"></a>基本查询</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;function_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;title&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;functions&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;weight&quot;</span>: 10</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch307.png" alt="image-20220808194100268"></p>
<h5 id="random-score"><a href="#random-score" class="headerlink" title="random_score"></a>random_score</h5><blockquote>
<p><code>random_score</code> 会根据 uid 字段进行 hash 运算，生成随机分数，使用 <code>random_score</code> 时可以配置一个种子，如果不配置，默认使用当前时间</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;function_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;title&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;functions&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;random_score&quot;</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>其他也无法解决问题，只是分值随机了</p>
</blockquote>
<h5 id="script-score"><a href="#script-score" class="headerlink" title="script_score"></a>script_score</h5><blockquote>
<p><code>script_score</code> 是自定义评分脚本</p>
</blockquote>
<h6 id="基本查询-16"><a href="#基本查询-16" class="headerlink" title="基本查询"></a>基本查询</h6><blockquote>
<p>假设每个文档的最终得分是旧的分数加上 votes，查询方式如下</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;function_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;title&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;functions&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;script_score&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;script&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;lang&quot;</span>: <span class="string">&quot;painless&quot;</span>,</span><br><span class="line">              <span class="string">&quot;source&quot;</span>: <span class="string">&quot;_score + doc[&#x27;votes&#x27;].value&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这种方式符合我们的预期</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch308.png" alt="image-20220808194407618"></p>
<h5 id="field-value-factor"><a href="#field-value-factor" class="headerlink" title="field_value_factor"></a>field_value_factor</h5><blockquote>
<p><code>field_value_factor</code> 类似于 <code>script_score</code>，但是不用自己写脚本，而是使用影响因子和内置函数进行计算</p>
</blockquote>
<h6 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h6><table>
<thead>
<tr>
<th>字段</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>field</td>
<td>需要进行计算的文档字段。</td>
</tr>
<tr>
<td>factor</td>
<td>计算时与字段值相乘的影响因子，默认为 1。</td>
</tr>
<tr>
<td>modifier</td>
<td>可选择 ElasticSearch 内置函数，默认不使用</td>
</tr>
</tbody></table>
<h6 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h6><blockquote>
<p>下面演示一个稍复杂查询，将 votes 字段值乘以影响因子 1.6，结果再取平方根，最后忽略 <code>query</code> 查询的分数 <code>sqrt(1.6 * doc[&#39;votes&#39;].value)</code>：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;function_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;title&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;functions&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;field_value_factor&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;votes&quot;</span>,</span><br><span class="line">            <span class="string">&quot;factor&quot;</span>: 1.6, </span><br><span class="line">            <span class="string">&quot;modifier&quot;</span>: <span class="string">&quot;sqrt&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;boost_mode&quot;</span>: <span class="string">&quot;replace&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch309.png" alt="image-20220808194647714"></p>
<h6 id="modifier参数"><a href="#modifier参数" class="headerlink" title="modifier参数"></a>modifier参数</h6><blockquote>
<p><code>modifier</code> 其他的内置函数还有：</p>
</blockquote>
<table>
<thead>
<tr>
<th>字段</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>none</td>
<td>不进行任何计算 (默认)</td>
</tr>
<tr>
<td>log</td>
<td>字段值取常用对数。如果字段值为0到1之间，将导致错误，可以考虑使用下面的 log1p 函数</td>
</tr>
<tr>
<td>log1p</td>
<td>字段值加1后，取常用对数</td>
</tr>
<tr>
<td>log2p</td>
<td>字段值加2后，取常用对数</td>
</tr>
<tr>
<td>ln</td>
<td>字段值取自然对数。如果字段值为0到1之间，将导致错误，可以考虑使用下面的 ln1p 函数</td>
</tr>
<tr>
<td>ln1p</td>
<td>字段值加1后，取自然对数</td>
</tr>
<tr>
<td>ln2p</td>
<td>字段值加2后，取自然对数</td>
</tr>
<tr>
<td>square</td>
<td>字段值的平方</td>
</tr>
<tr>
<td>sqrt</td>
<td>字段值求平方根</td>
</tr>
<tr>
<td>reciprocal</td>
<td>字段值取倒数</td>
</tr>
</tbody></table>
<h6 id="score-mode参数"><a href="#score-mode参数" class="headerlink" title="score_mode参数"></a>score_mode参数</h6><blockquote>
<p><code>score_mode</code> 参数表示 <code>functions</code> 模块中不同计算方法之间的得分计算方式</p>
</blockquote>
<table>
<thead>
<tr>
<th>字段</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>multiply</td>
<td>得分相乘 (默认)</td>
</tr>
<tr>
<td>sum</td>
<td>得分相加</td>
</tr>
<tr>
<td>avg</td>
<td>得分取平均值</td>
</tr>
<tr>
<td>first</td>
<td>取第一个有效的方法得分</td>
</tr>
<tr>
<td>max</td>
<td>最大的得分</td>
</tr>
<tr>
<td>min</td>
<td>最小的得分</td>
</tr>
</tbody></table>
<blockquote>
<p>使用案例如下</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;function_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;title&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;functions&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;field_value_factor&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;votes&quot;</span>,</span><br><span class="line">            <span class="string">&quot;factor&quot;</span>: 1.6, </span><br><span class="line">            <span class="string">&quot;modifier&quot;</span>: <span class="string">&quot;sqrt&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;script_score&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;script&quot;</span>: <span class="string">&quot;_score + doc[&#x27;votes&#x27;].value&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;boost_mode&quot;</span>: <span class="string">&quot;replace&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>max_boost</code> 参数表示 <code>functions</code> 模块中得分上限</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;function_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;title&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;functions&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;field_value_factor&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;votes&quot;</span>,</span><br><span class="line">            <span class="string">&quot;factor&quot;</span>: 1.6, </span><br><span class="line">            <span class="string">&quot;modifier&quot;</span>: <span class="string">&quot;sqrt&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;boost_mode&quot;</span>: <span class="string">&quot;replace&quot;</span>,</span><br><span class="line">      <span class="string">&quot;max_boost&quot;</span>: 10</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="boosting"><a href="#boosting" class="headerlink" title="boosting"></a>boosting</h4><blockquote>
<p>可以对有些评分进行降低</p>
</blockquote>
<h5 id="参数-1"><a href="#参数-1" class="headerlink" title="参数"></a>参数</h5><table>
<thead>
<tr>
<th>字段</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>positive</td>
<td>得分不变</td>
</tr>
<tr>
<td>nagetive</td>
<td>降低得分</td>
</tr>
<tr>
<td>nagetive_boost</td>
<td>降低得分的权重，取值范围 [0 ~1]</td>
</tr>
</tbody></table>
<h5 id="基本查询-17"><a href="#基本查询-17" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>下面进行以下正常的查询</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="降低评分"><a href="#降低评分" class="headerlink" title="降低评分"></a>降低评分</h5><blockquote>
<p>使用 nagetive 和 nagetive_boost 降低字段值中包含 “2008” 的文档得分</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;boosting&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;positive&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;name&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;negative&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;name&quot;</span>: <span class="string">&quot;2008&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;negative_boost&quot;</span>: 0.5</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="地理位置查询"><a href="#地理位置查询" class="headerlink" title="地理位置查询"></a>地理位置查询</h3><h4 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h4><blockquote>
<p>地理位置查询需要准备一些位置信息，我们插入一些数据</p>
</blockquote>
<h5 id="创建索引-15"><a href="#创建索引-15" class="headerlink" title="创建索引"></a>创建索引</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT geo</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;location&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;geo_point&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-1"><a href="#插入数据-1" class="headerlink" title="插入数据"></a>插入数据</h5><blockquote>
<p>准备一个geo.json 文件，贴上如下文件内容，注意最后一行要留空</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;geo&quot;</span>,<span class="string">&quot;_id&quot;</span>:1&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;西安&quot;</span>,<span class="string">&quot;location&quot;</span>:<span class="string">&quot;34.288991865037524,108.9404296875&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;geo&quot;</span>,<span class="string">&quot;_id&quot;</span>:2&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;北京&quot;</span>,<span class="string">&quot;location&quot;</span>:<span class="string">&quot;39.926588421909436,116.43310546875&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;geo&quot;</span>,<span class="string">&quot;_id&quot;</span>:3&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;上海&quot;</span>,<span class="string">&quot;location&quot;</span>:<span class="string">&quot;31.240985378021307,121.53076171875&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;geo&quot;</span>,<span class="string">&quot;_id&quot;</span>:4&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;天津&quot;</span>,<span class="string">&quot;location&quot;</span>:<span class="string">&quot;39.13006024213511,117.20214843749999&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;geo&quot;</span>,<span class="string">&quot;_id&quot;</span>:5&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;杭州&quot;</span>,<span class="string">&quot;location&quot;</span>:<span class="string">&quot;30.259067203213018,120.21240234375001&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;geo&quot;</span>,<span class="string">&quot;_id&quot;</span>:6&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;武汉&quot;</span>,<span class="string">&quot;location&quot;</span>:<span class="string">&quot;30.581179257386985,114.3017578125&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;geo&quot;</span>,<span class="string">&quot;_id&quot;</span>:7&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;合肥&quot;</span>,<span class="string">&quot;location&quot;</span>:<span class="string">&quot;31.840232667909365,117.20214843749999&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_index&quot;</span>:<span class="string">&quot;geo&quot;</span>,<span class="string">&quot;_id&quot;</span>:8&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;重庆&quot;</span>,<span class="string">&quot;location&quot;</span>:<span class="string">&quot;29.592565403314087,106.5673828125&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h5 id="批量插入"><a href="#批量插入" class="headerlink" title="批量插入"></a>批量插入</h5><blockquote>
<p>执行下面的命令批量插入数据</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -XPOST <span class="string">&quot;http://192.168.245.151:9200/geo/_bulk?pretty&quot;</span> -H <span class="string">&quot;content-type:application/json&quot;</span> --data-binary @geo.json</span><br></pre></td></tr></table></figure>

<h4 id="geo-distance"><a href="#geo-distance" class="headerlink" title="geo_distance"></a>geo_distance</h4><blockquote>
<p>给出一个中心点和距离，查询以该中心点为圆心，以距离为半径范围内的文档</p>
</blockquote>
<h5 id="基本查询-18"><a href="#基本查询-18" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>查询以圆心为中心，600KM范围内的文档</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET geo/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;geo_distance&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;distance&quot;</span>: <span class="string">&quot;600km&quot;</span>,</span><br><span class="line">            <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;lat&quot;</span>: 34.288991865037524,</span><br><span class="line">              <span class="string">&quot;lon&quot;</span>: 108.9404296875</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch310.png" alt="image-20220810101456006"></p>
<h4 id="geo-bounding-box"><a href="#geo-bounding-box" class="headerlink" title="geo_bounding_box"></a>geo_bounding_box</h4><blockquote>
<p><code>geo_bounding</code> 分别制定左上和右下两个点，查询两个点组成的矩形内所有文档</p>
</blockquote>
<h5 id="基本查询-19"><a href="#基本查询-19" class="headerlink" title="基本查询"></a>基本查询</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET geo/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;geo_bounding_box&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;top_left&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;lat&quot;</span>: 32.0639555946604,</span><br><span class="line">                <span class="string">&quot;lon&quot;</span>: 118.78967285156249</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="string">&quot;bottom_right&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;lat&quot;</span>: 29.98824461550903,</span><br><span class="line">                <span class="string">&quot;lon&quot;</span>: 122.20642089843749</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch311.png" alt="image-20220810101558160"></p>
<h4 id="geo-polygon"><a href="#geo-polygon" class="headerlink" title="geo_polygon"></a>geo_polygon</h4><blockquote>
<p><code>geo_polygon</code> 最少制定三个点，查询组成的多边形范围内所有文档</p>
</blockquote>
<h5 id="基本查询-20"><a href="#基本查询-20" class="headerlink" title="基本查询"></a>基本查询</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET geo/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;geo_polygon&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;points&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="string">&quot;lat&quot;</span>: 31.793755581217674,</span><br><span class="line">                  <span class="string">&quot;lon&quot;</span>: 113.8238525390625</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="string">&quot;lat&quot;</span>: 30.007273923504556,</span><br><span class="line">                  <span class="string">&quot;lon&quot;</span>:114.224853515625</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="string">&quot;lat&quot;</span>: 30.007273923504556,</span><br><span class="line">                  <span class="string">&quot;lon&quot;</span>:114.8345947265625</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch312.png" alt="image-20220810101709007"></p>
<h4 id="geo-shape-1"><a href="#geo-shape-1" class="headerlink" title="geo_shape"></a>geo_shape</h4><blockquote>
<p><code>geo_shape</code> 用来查询图形，针对 <code>geo_shape</code> 字段类型，两个图形之间的关系有：相交、包含、不相交</p>
</blockquote>
<h5 id="准备数据-3"><a href="#准备数据-3" class="headerlink" title="准备数据"></a>准备数据</h5><h6 id="新建索引"><a href="#新建索引" class="headerlink" title="新建索引"></a>新建索引</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT geo_shape</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;geo_shape&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="插入数据-2"><a href="#插入数据-2" class="headerlink" title="插入数据"></a>插入数据</h6><blockquote>
<p>添加一条线</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT geo_shape/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;西安-郑州&quot;</span>,</span><br><span class="line">  <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;linestring&quot;</span>,</span><br><span class="line">    <span class="string">&quot;coordinates&quot;</span>: [</span><br><span class="line">      [108.9404296875, 34.279914398549934],</span><br><span class="line">      [113.66455078125, 34.768691457552706]</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="基本查询-21"><a href="#基本查询-21" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>接下来查询某一个图形中是否包含该线：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET geo_shape/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;geo_shape&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;shape&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;envelope&quot;</span>,</span><br><span class="line">                <span class="string">&quot;coordinates&quot;</span>: [</span><br><span class="line">                  [</span><br><span class="line">                    106.5234375,</span><br><span class="line">                    36.80928470205937</span><br><span class="line">                  ],</span><br><span class="line">                  [</span><br><span class="line">                    115.33447265625,</span><br><span class="line">                    32.24997445586331</span><br><span class="line">                  ]</span><br><span class="line">                ]</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="string">&quot;relation&quot;</span>: <span class="string">&quot;within&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch313.png" alt="image-20220810102031490"></p>
<h5 id="关键参数-1"><a href="#关键参数-1" class="headerlink" title="关键参数"></a>关键参数</h5><blockquote>
<p><code>relation</code> 属性表示两个图形的关系：</p>
</blockquote>
<ul>
<li><code>within</code> 包含</li>
<li><code>intersects</code> 相交</li>
<li><code>disjoint</code> 不相交</li>
</ul>
<h2 id="ElasticSearch-聚合查询"><a href="#ElasticSearch-聚合查询" class="headerlink" title="ElasticSearch 聚合查询"></a>ElasticSearch 聚合查询</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch001.png" alt="img"></p>
<h3 id="指标聚合"><a href="#指标聚合" class="headerlink" title="指标聚合"></a>指标聚合</h3><blockquote>
<p>指标聚合比较简单，大多数都是对查询返回的数据进行简单的数值处理</p>
</blockquote>
<h4 id="Max"><a href="#Max" class="headerlink" title="Max"></a>Max</h4><blockquote>
<p><code>Max</code> 聚合可以统计最大值，类似 MySQL 数据库中的 max 函数</p>
</blockquote>
<h5 id="基本查询-22"><a href="#基本查询-22" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>例如查询价格最高的书籍</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max_price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;max&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>聚合结果在最下面，我们发现数据最大的值是<code>269</code></p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch324.png" alt="image-20220810102629720"></p>
<h5 id="设置默认值"><a href="#设置默认值" class="headerlink" title="设置默认值"></a>设置默认值</h5><blockquote>
<p>有些文档没有<code>price</code>字段，还可以使用 <code>missing</code> 来设置默认值</p>
</blockquote>
<h6 id="插入文档"><a href="#插入文档" class="headerlink" title="插入文档"></a>插入文档</h6><blockquote>
<p>插入的字段没有<code>price</code></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">POST books/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;测试数据&quot;</span>,</span><br><span class="line">  <span class="string">&quot;publish&quot;</span> :<span class="string">&quot;高等教育出版社&quot;</span>,</span><br><span class="line">  <span class="string">&quot;type&quot;</span> :<span class="string">&quot;大学教材&quot;</span>,</span><br><span class="line">  <span class="string">&quot;author&quot;</span> :<span class="string">&quot;大方哥&quot;</span>,</span><br><span class="line">  <span class="string">&quot;info&quot;</span>: <span class="string">&quot;高等教育出版社高等教育出版社高等教育出版社高等教育出版社高等教育出版社&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="基本查询-23"><a href="#基本查询-23" class="headerlink" title="基本查询"></a>基本查询</h6><blockquote>
<p>我们下面就进行查询，使用 missing 参数，设置 price 空字段值为 1000</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max_price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;max&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>,</span><br><span class="line">        <span class="string">&quot;missing&quot;</span>: 1000</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="忽略问题文档"><a href="#忽略问题文档" class="headerlink" title="忽略问题文档"></a>忽略问题文档</h5><blockquote>
<p>有时候我们需要排除不存在<code>price</code>字段的数据，我们可以使用<code>script</code>进行处理，</p>
</blockquote>
<h6 id="基本查询-24"><a href="#基本查询-24" class="headerlink" title="基本查询"></a>基本查询</h6><blockquote>
<p>可以先通过 <code>doc[&#39;price&#39;].size()!=0</code> 去判断文档是否有对应的属性</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max_price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;max&quot;</span>: &#123;</span><br><span class="line">       <span class="string">&quot;script&quot;</span>: &#123;</span><br><span class="line">         <span class="string">&quot;source&quot;</span>: <span class="string">&quot;if (doc[&#x27;price&#x27;].size()!=0)&#123;doc.price.value&#125;&quot;</span></span><br><span class="line">       &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch325.png" alt="image-20220810103403652"></p>
<h4 id="Min"><a href="#Min" class="headerlink" title="Min"></a>Min</h4><blockquote>
<p>统计最小值，用法和 <code>Max</code> 基本一致：</p>
</blockquote>
<h5 id="基本查询-25"><a href="#基本查询-25" class="headerlink" title="基本查询"></a>基本查询</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;min_price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;min&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>,</span><br><span class="line">        <span class="string">&quot;missing&quot;</span>: 1000</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="忽略问题文档-1"><a href="#忽略问题文档-1" class="headerlink" title="忽略问题文档"></a>忽略问题文档</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;min_price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;min&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;script&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;source&quot;</span>: <span class="string">&quot;if (doc[&#x27;price&#x27;].size()!=0)&#123;doc.price.value&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Avg"><a href="#Avg" class="headerlink" title="Avg"></a>Avg</h4><p>统计平均值</p>
<h5 id="基本查询-26"><a href="#基本查询-26" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>我们统计数据价格的平均值</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>书籍的平均价格是29.4元</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch326.png" alt="image-20220810103712500"></p>
<h5 id="忽略问题文档-2"><a href="#忽略问题文档-2" class="headerlink" title="忽略问题文档"></a>忽略问题文档</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;script&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;source&quot;</span>: <span class="string">&quot;if(doc[&#x27;price&#x27;].size()!=0)&#123;doc.price.value&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Sum"><a href="#Sum" class="headerlink" title="Sum"></a>Sum</h4><blockquote>
<p>对字段求合</p>
</blockquote>
<h5 id="基本查询-27"><a href="#基本查询-27" class="headerlink" title="基本查询"></a>基本查询</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;sum_price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;sum&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="忽略问题文档-3"><a href="#忽略问题文档-3" class="headerlink" title="忽略问题文档"></a>忽略问题文档</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;sum_price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;sum&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;script&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;source&quot;</span>: <span class="string">&quot;if(doc[&#x27;price&#x27;].size()!=0)&#123;doc.price.value&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Cardinality"><a href="#Cardinality" class="headerlink" title="Cardinality"></a>Cardinality</h4><blockquote>
<p><code>Cardinality</code> 聚合用于基数统计，类似于 MySQL 中的 distinct count(0)，去重后再计数。</p>
</blockquote>
<h5 id="注意事项-9"><a href="#注意事项-9" class="headerlink" title="注意事项"></a>注意事项</h5><blockquote>
<p>ElasticSearch 中 <code>text</code> 字段类型是分析型，默认不允许进行聚合操作，如果有聚合操作的需求，可以考虑以下两种方式：</p>
</blockquote>
<ul>
<li>设置 <code>text</code> 字段类型的 fielddata 属性为 true。</li>
<li>将字段类型或者字段的子域在设置成 <code>keyword</code> 。</li>
</ul>
<h5 id="设置fielddata"><a href="#设置fielddata" class="headerlink" title="设置fielddata"></a>设置fielddata</h5><blockquote>
<p>设置 <code>text</code> 字段类型的 fielddata 属性为 true</p>
</blockquote>
<h6 id="重置索引"><a href="#重置索引" class="headerlink" title="重置索引"></a>重置索引</h6><blockquote>
<p>因为 books 索引已经存在，我们要先删除，再新建索引设置 fielddata，导入数据后再进行 <code>Cardinality</code> 统计</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">DELETE books</span><br><span class="line"></span><br><span class="line">PUT books</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;publish&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">        <span class="string">&quot;fielddata&quot;</span>: <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;type&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;author&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;info&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;price&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;double&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="重新导入数据"><a href="#重新导入数据" class="headerlink" title="重新导入数据"></a>重新导入数据</h6><blockquote>
<p>到 bookdata.json 文件目录下，用 cmd 命令行工具，重新导入数据：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -XPOST <span class="string">&quot;http://192.168.245.151:9200/books/_bulk?pretty&quot;</span> -H <span class="string">&quot;content-type:application/json&quot;</span> --data-binary @bookdata.json</span><br></pre></td></tr></table></figure>

<h6 id="基础查询"><a href="#基础查询" class="headerlink" title="基础查询"></a>基础查询</h6><blockquote>
<p>现在就可以使用 <code>cardinality</code> 查询出版社的总数量</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;publish_count&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;cardinality&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;publish&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查询出来的数据是43</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch327.png" alt="image-20220810105619561"></p>
<h6 id="主要事项"><a href="#主要事项" class="headerlink" title="主要事项"></a>主要事项</h6><blockquote>
<p>这种方式虽然可以进行聚合操作，但是无法满足精准聚合，因为 <code>text</code> 类型会进行分词。</p>
</blockquote>
<p> 而且 fielddata 是动态创建到内存中，如果文档很多时，可能有动态创建慢，占内存等问题，所以推荐使用下面第二种方式</p>
<h5 id="设置keyword"><a href="#设置keyword" class="headerlink" title="设置keyword"></a>设置keyword</h5><blockquote>
<p>将字段类型或者字段的子域设置成 <code>keyword</code></p>
</blockquote>
<h6 id="重置索引-1"><a href="#重置索引-1" class="headerlink" title="重置索引"></a>重置索引</h6><blockquote>
<p>同样需要删除索引再新建，这次将 publish 字段子域设置成 <code>keyword</code></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">DELETE books</span><br><span class="line"></span><br><span class="line">PUT books</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;publish&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">        <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;size&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;type&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;author&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;info&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;price&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;double&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="重新导入数据-1"><a href="#重新导入数据-1" class="headerlink" title="重新导入数据"></a>重新导入数据</h6><blockquote>
<p>到 bookdata.json 文件目录下，用 cmd 命令行工具，重新导入数据：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -XPOST <span class="string">&quot;http://192.168.245.151:9200/books/_bulk?pretty&quot;</span> -H <span class="string">&quot;content-type:application/json&quot;</span> --data-binary @bookdata.json</span><br></pre></td></tr></table></figure>

<h6 id="基础查询-1"><a href="#基础查询-1" class="headerlink" title="基础查询"></a>基础查询</h6><blockquote>
<p>再次使用 <code>cardinality</code> 查询出版社的总数量</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;publish_count&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;cardinality&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;publish&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Stats"><a href="#Stats" class="headerlink" title="Stats"></a>Stats</h4><blockquote>
<p><code>stats</code> 表示基本统计聚合，可以同时返回 <code>min</code>、<code>max</code>、<code>sum</code>、<code>count</code>、<code>avg</code> 结果</p>
</blockquote>
<h5 id="基本查询-28"><a href="#基本查询-28" class="headerlink" title="基本查询"></a>基本查询</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;stats_agg&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;stats&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch328.png" alt="image-20220810110521000"></p>
<h4 id="Extends-Stats"><a href="#Extends-Stats" class="headerlink" title="Extends Stats"></a>Extends Stats</h4><blockquote>
<p><code>Extends Stats</code> 表示高级统计聚合，比 <code>stats</code> 聚合返回更多的内容</p>
</blockquote>
<h5 id="基本查询-29"><a href="#基本查询-29" class="headerlink" title="基本查询"></a>基本查询</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;extended_stats_agg&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;extended_stats&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch329.png" alt="image-20220810110621523"></p>
<h4 id="Percentiles"><a href="#Percentiles" class="headerlink" title="Percentiles"></a>Percentiles</h4><blockquote>
<p><code>Percentiles</code> 是百分位数值统计，运用于统计学中：将一组数据从小到大排序，并计算相应的累计百分位，则某一百分位所对应数据的值就称为这一百分位的百分位数。</p>
</blockquote>
<h5 id="基本查询-30"><a href="#基本查询-30" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>文字解释看起来比较难理解，还是拿书籍价格举例，分别看一下 25%、50%、75%、100% 这四个百分位上的书籍价格：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;percentiles_agg&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;percentiles&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>,</span><br><span class="line">        <span class="string">&quot;percents&quot;</span>: [</span><br><span class="line">          1,</span><br><span class="line">          5,</span><br><span class="line">          10,</span><br><span class="line">          15,</span><br><span class="line">          25,</span><br><span class="line">          50,</span><br><span class="line">          75,</span><br><span class="line">          95,</span><br><span class="line">          100</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以看到，中位数 50% 的书籍价格是 28 元，也就是说有一半的书籍价格比 28 元低，另一半比 28 元高，对应的 25%、75%、100% 也是类似。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch330.png" alt="image-20220810110840655"></p>
<h4 id="Value-count"><a href="#Value-count" class="headerlink" title="Value count"></a>Value count</h4><blockquote>
<p><code>Value count</code> 可以按照字段统计文档数量，该字段值为空 <strong>null</strong> 的文档会被丢弃</p>
</blockquote>
<h5 id="基本查询-31"><a href="#基本查询-31" class="headerlink" title="基本查询"></a>基本查询</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;count&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;value_count&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch331.png" alt="image-20220810111009909"></p>
<h3 id="桶聚合"><a href="#桶聚合" class="headerlink" title="桶聚合"></a>桶聚合</h3><h4 id="Terms"><a href="#Terms" class="headerlink" title="Terms"></a>Terms</h4><blockquote>
<p><code>Terms</code> 用于分组聚合，例如，统计各个出版社出版的图书总数量</p>
</blockquote>
<h5 id="基本查询-32"><a href="#基本查询-32" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>统计各出版社图书总数量，并列出前五个</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bucket_terms&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;publish.size&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 5</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>terms</code> 分组聚合不能作用于 text 类型，这里我们用的是 keyword 类型的子域 publish.size</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch332.png" alt="image-20220810111650692"></p>
<h5 id="价格统计"><a href="#价格统计" class="headerlink" title="价格统计"></a>价格统计</h5><blockquote>
<p>在 <code>terms</code> 分组聚合的基础上，还可以对每个桶进行指标聚合，统计不同出版社所出版的图书平均价格：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bucket_terms&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;publish.size&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 5</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch333.png" alt="image-20220810112008989"></p>
<h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><blockquote>
<p><code>Filter</code> 是过滤器聚合，可以将符合过滤器中条件的文档分到一个桶中，然后可以求其平均值</p>
</blockquote>
<h5 id="基本查询-33"><a href="#基本查询-33" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>例如查询书名中包含 java 的图书的平均价格</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bucket_filter&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;name&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch334.png" alt="image-20220810112300923"></p>
<h4 id="Filters"><a href="#Filters" class="headerlink" title="Filters"></a>Filters</h4><blockquote>
<p>多过滤器聚合，过滤条件可以有多个</p>
</blockquote>
<h5 id="基本查询-34"><a href="#基本查询-34" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>例如查询书名中包含 java 或者 office 的图书的平均价格：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bucket_filter&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;filters&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;filters&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;name&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;name&quot;</span>: <span class="string">&quot;office&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch335.png" alt="image-20220810112650273"></p>
<h4 id="Range"><a href="#Range" class="headerlink" title="Range"></a>Range</h4><blockquote>
<p>按照范围聚合，在某一个范围内的文档数统计</p>
</blockquote>
<h5 id="基本查询-35"><a href="#基本查询-35" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>例如统计图书价格在 0-50、50-100、100-150、150以上的图书数量：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bucket_range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: 50</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: 50,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: 100</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: 100,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: 150</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: 150</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch336.png" alt="image-20220810112947053"></p>
<h5 id="出版社统计"><a href="#出版社统计" class="headerlink" title="出版社统计"></a>出版社统计</h5><blockquote>
<p>基于上面的架构聚集结果，在统计出来每一个分桶中出版社的数量</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bucket_range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: 50</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: 50,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: 100</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: 100,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: 150</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: 150</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;publish_size&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;cardinality&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;publish.size&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch337.png" alt="image-20220810113304386"></p>
<h4 id="Date-Range"><a href="#Date-Range" class="headerlink" title="Date Range"></a>Date Range</h4><blockquote>
<p><code>ange</code> 聚合和 <code>Date Range</code> 聚合都可以可以统计日期，后者的优势在于可以使用日期表达式</p>
</blockquote>
<h5 id="插入数据-3"><a href="#插入数据-3" class="headerlink" title="插入数据"></a>插入数据</h5><blockquote>
<p>首先造一些测试数据：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>:<span class="string">&quot;java&quot;</span>,</span><br><span class="line">  <span class="string">&quot;date&quot;</span>:<span class="string">&quot;2018-12-30&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">PUT blog/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>:<span class="string">&quot;java&quot;</span>,</span><br><span class="line">  <span class="string">&quot;date&quot;</span>:<span class="string">&quot;2020-12-30&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">PUT blog/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>:<span class="string">&quot;java&quot;</span>,</span><br><span class="line">  <span class="string">&quot;date&quot;</span>:<span class="string">&quot;2022-10-30&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="基本查询-36"><a href="#基本查询-36" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>统计一年前到一年后的微博数量</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bucket_date_range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;date_range&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: <span class="string">&quot;now-10M/M&quot;</span>,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: <span class="string">&quot;now+1y/y&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch338.png" alt="image-20220810114008893"></p>
<h4 id="Date-Histogram"><a href="#Date-Histogram" class="headerlink" title="Date Histogram"></a>Date Histogram</h4><blockquote>
<p>时间直方图聚</p>
</blockquote>
<h5 id="基本查询-37"><a href="#基本查询-37" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>例如统计各个月份的博客数量</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bucket_date_his&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;date_histogram&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">        <span class="string">&quot;calendar_interval&quot;</span>: <span class="string">&quot;month&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch339.png" alt="image-20220810114139539"></p>
<h4 id="Missing"><a href="#Missing" class="headerlink" title="Missing"></a>Missing</h4><blockquote>
<p>空值聚合</p>
</blockquote>
<h5 id="基本查询-38"><a href="#基本查询-38" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>统计所有没有 price 字段的文档：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bucket_missing&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;missing&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch340.png" alt="image-20220810114247411"></p>
<h4 id="Children"><a href="#Children" class="headerlink" title="Children"></a>Children</h4><blockquote>
<p>可以根据父子文档关系进行分桶</p>
</blockquote>
<h5 id="基本查询-39"><a href="#基本查询-39" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>查询子类型为 student 的文档数量</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET stu_class/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bucket_children&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;children&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;student&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Geo-Distance"><a href="#Geo-Distance" class="headerlink" title="Geo Distance"></a>Geo Distance</h4><blockquote>
<p>对地理位置数据做统计</p>
</blockquote>
<h5 id="基本查询-40"><a href="#基本查询-40" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>例如分别统计 (34.288991865037524,108.9404296875) 坐标方圆 600KM 和 超过 600KM 的城市数量</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET geo/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bucket_geo&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;geo_distance&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;location&quot;</span>,</span><br><span class="line">        <span class="string">&quot;origin&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;lat&quot;</span>: 34.288991865037524,</span><br><span class="line">          <span class="string">&quot;lon&quot;</span>: 108.9404296875</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;unit&quot;</span>: <span class="string">&quot;km&quot;</span>, </span><br><span class="line">        <span class="string">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: 600</span><br><span class="line">          &#125;,&#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: 600</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch341.png" alt="image-20220810114436154"></p>
<h4 id="IP-Range"><a href="#IP-Range" class="headerlink" title="IP Range"></a>IP Range</h4><blockquote>
<p>IP 地址范围聚合</p>
</blockquote>
<h5 id="准备数据-4"><a href="#准备数据-4" class="headerlink" title="准备数据"></a>准备数据</h5><blockquote>
<p>之前的 blog 索引没有设置 ip 字段，删掉重新设置一下</p>
</blockquote>
<h6 id="重置索引-2"><a href="#重置索引-2" class="headerlink" title="重置索引"></a>重置索引</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">DELETE blog</span><br><span class="line"></span><br><span class="line">PUT blog</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;ip&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;ip&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="插入数据-4"><a href="#插入数据-4" class="headerlink" title="插入数据"></a>插入数据</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>:<span class="string">&quot;java&quot;</span>,</span><br><span class="line">  <span class="string">&quot;date&quot;</span>:<span class="string">&quot;2018-12-30&quot;</span>,</span><br><span class="line">  <span class="string">&quot;ip&quot;</span>:<span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">PUT blog/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>:<span class="string">&quot;java&quot;</span>,</span><br><span class="line">  <span class="string">&quot;date&quot;</span>:<span class="string">&quot;2020-12-30&quot;</span>,</span><br><span class="line">  <span class="string">&quot;ip&quot;</span>:<span class="string">&quot;127.0.0.5&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">PUT blog/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>:<span class="string">&quot;java&quot;</span>,</span><br><span class="line">  <span class="string">&quot;date&quot;</span>:<span class="string">&quot;2022-10-30&quot;</span>,</span><br><span class="line">  <span class="string">&quot;ip&quot;</span>:<span class="string">&quot;127.0.0.10&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="基本查询-41"><a href="#基本查询-41" class="headerlink" title="基本查询"></a>基本查询</h4><blockquote>
<p>例如查询指定 IP 地址的博客数量</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bucket_ip_range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;ip_range&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;ip&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: <span class="string">&quot;127.0.0.5&quot;</span>,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: <span class="string">&quot;127.0.0.11&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch342.png" alt="image-20220810114748374"></p>
<h3 id="管道聚合"><a href="#管道聚合" class="headerlink" title="管道聚合"></a>管道聚合</h3><blockquote>
<p>管道聚合相当于在之前聚合的基础上，进行再次聚合</p>
</blockquote>
<h4 id="Avg-Bucket"><a href="#Avg-Bucket" class="headerlink" title="Avg Bucket"></a>Avg Bucket</h4><blockquote>
<p>计算聚合平均值</p>
</blockquote>
<h5 id="基本查询-42"><a href="#基本查询-42" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>统计每个出版社所出版图书的平均值，然后再统计所有出版社的平均值</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;book_count&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;publish.size&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 3</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;book_avg&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;avg_book&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;avg_bucket&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;buckets_path&quot;</span>: <span class="string">&quot;book_count&gt;book_avg&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch343.png" alt="image-20220810115100513"></p>
<h4 id="Max-Bucket"><a href="#Max-Bucket" class="headerlink" title="Max Bucket"></a>Max Bucket</h4><blockquote>
<p>计算聚合最大值</p>
</blockquote>
<h5 id="基本查询-43"><a href="#基本查询-43" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>统计每个出版社所出版图书的平均值，然后再统计平均值中的最大值</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;book_count&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;publish.size&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 3</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;book_avg&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;max_book&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;max_bucket&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;buckets_path&quot;</span>: <span class="string">&quot;book_count&gt;book_avg&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch344.png" alt="image-20220810135344523"></p>
<h4 id="Min-Bucket"><a href="#Min-Bucket" class="headerlink" title="Min Bucket"></a>Min Bucket</h4><blockquote>
<p>计算聚合最小值</p>
</blockquote>
<h5 id="基本查询-44"><a href="#基本查询-44" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>统计每个出版社所出版图书的平均值，然后再统计平均值中的最小值：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;book_count&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;publish.size&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 3</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;book_avg&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;min_book&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;min_bucket&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;buckets_path&quot;</span>: <span class="string">&quot;book_count&gt;book_avg&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch345.png" alt="image-20220810135500544"></p>
<h4 id="Sum-Bucket"><a href="#Sum-Bucket" class="headerlink" title="Sum Bucket"></a>Sum Bucket</h4><blockquote>
<p>计算聚合累加</p>
</blockquote>
<h5 id="基本查询-45"><a href="#基本查询-45" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>统计每个出版社所出版图书的平均值，然后再统计平均值之和</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;book_count&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;publish.size&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 3</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;book_avg&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;sum_book&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;sum_bucket&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;buckets_path&quot;</span>: <span class="string">&quot;book_count&gt;book_avg&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch346.png" alt="image-20220810135615811"></p>
<h4 id="Stats-Bucket"><a href="#Stats-Bucket" class="headerlink" title="Stats Bucket"></a>Stats Bucket</h4><h5 id="基本查询-46"><a href="#基本查询-46" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>统计每个出版社所出版图书的平均值，然后再统计平均值的各种数据：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;book_count&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;publish.size&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 3</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;book_avg&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;stats_book&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;stats_bucket&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;buckets_path&quot;</span>: <span class="string">&quot;book_count&gt;book_avg&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch347.png" alt="image-20220810135709961"></p>
<h4 id="Extended-Stats-Bucket"><a href="#Extended-Stats-Bucket" class="headerlink" title="Extended Stats Bucket"></a>Extended Stats Bucket</h4><h5 id="基本查询-47"><a href="#基本查询-47" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>统计每个出版社所出版图书的平均值，然后再统计平均值的各种数据，比 <code>Stats Bucket</code> 统计多了一些方差之类的数据：</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;book_count&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;publish.size&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 3</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;book_avg&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;extended_book&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;extended_stats_bucket&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;buckets_path&quot;</span>: <span class="string">&quot;book_count&gt;book_avg&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch348.png" alt="image-20220810135816944"></p>
<h4 id="Percentiles-Bucket"><a href="#Percentiles-Bucket" class="headerlink" title="Percentiles Bucket"></a>Percentiles Bucket</h4><h5 id="基本查询-48"><a href="#基本查询-48" class="headerlink" title="基本查询"></a>基本查询</h5><blockquote>
<p>统计每个出版社所出版图书的平均值，然后再统计平均值的百分位数据</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;book_count&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;publish.size&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 3</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;book_avg&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;percentiles_book&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;percentiles_bucket&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;buckets_path&quot;</span>: <span class="string">&quot;book_count&gt;book_avg&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch349.png" alt="image-20220810135913523"></p>
<h2 id="ElasticSearch-相关查询"><a href="#ElasticSearch-相关查询" class="headerlink" title="ElasticSearch 相关查询"></a>ElasticSearch 相关查询</h2><p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch001.png" alt="img"></p>
<h3 id="相关性查询概述"><a href="#相关性查询概述" class="headerlink" title="相关性查询概述"></a>相关性查询概述</h3><blockquote>
<p>相关性算分描述了一个文档和查询语句匹配的程度，es会对每个匹配查询条件的结果进行算分打分的本质是排序，将相关性高的文档排在最前面</p>
</blockquote>
<p> 在全文检索]中，检索结果与查询条件的相关性是一个极为重要的问题，优秀的全文检索引擎应该将那些与查询条件相关性高的文档排在最前面。想象一下，如果满足查询条件的文档成千上万，让用户在这些文档中再找出自己最满意的那一条，这无异于再做一次人工检索，用户一般很少会有耐心在检索结果中翻到第3页，所以处理好检索结果的相关性对于检索引擎来说至关重要。</p>
<p> Google公司就是因为发明了<code>Page Rank</code>算法，巧妙地解决了网页检索结果的相关性问题，才在众多搜索公司中迅速崛起。</p>
<p> <strong>相关性问题有两方面问题要解决，一是如何评价单个查询条件的相关性，二是如何将多个查询条件的相关性组合起来。</strong></p>
<h4 id="什么是相关性评分"><a href="#什么是相关性评分" class="headerlink" title="什么是相关性评分"></a>什么是相关性评分</h4><blockquote>
<p>全文检索与数据库查询的一个显著区别，就是它并不一定会根据查询条件做完全精确的匹配。</p>
</blockquote>
<p> 除了模糊查询以外，全文检索还会根据查询条件给文档的相关性打分并排序，将那些与查询条件相关性高的文档排在最前面，相关性( Relevance)或相似性(Similarity)是指两个事物间相互关联的程度，在检索领特指检索请求与检索结果之间的相关程度。</p>
<p> 在 Elaticsearch返回的每条结果中都会包含一个<code>_score</code>字段，这个字段的值就是当前文档匹配检索请求的相关性评分，我们也可以称为相关度。</p>
<p> 解决相关性问题的核心是计算相关度的算法和模型，相关度算法和模型是全文检索文章最重要的技术之一。相关度算法和相关度模型并非完全相同的概念，相关度模型可以认为是具有相同理论基础的算法集合，所以在实际应用时都是指定到具体的相关度算法，相关度模型则是从理论层面对相关度算法的归类。</p>
<h3 id="相关度模型"><a href="#相关度模型" class="headerlink" title="相关度模型"></a>相关度模型</h3><blockquote>
<p>Elasticsearch支持多种相关度算法，它们通过类型名称来标识，包括boolean、BM25、DFR等等很多，这些算法分别归属于几种不同的理论模型，它们是布尔模型、向量空间模型、概率模型、语言模型等。</p>
</blockquote>
<h4 id="布尔模型"><a href="#布尔模型" class="headerlink" title="布尔模型"></a>布尔模型</h4><blockquote>
<p>布尔模型( Boolean Model)是最简单的相关度模型，最终的相关度只有1或0两种</p>
</blockquote>
<p> 如果检索中包含多个查询条件，则查询条件之间的相关度组合方式取决它们之间的逻辑运算符，即以逻辑运算中的与、或、非组合评分，文档的最终评分为1时会被添加到检索结果中，而评分为0时则不会出现在检索结果中，这与使用SQL语句查询数据库有些类似，完全根据查询条件决定结果，非此即彼，在Elasticearch支持的相关度算法中，boolean算法即采用布尔模型，有些地方也部分地采用了布尔模型。</p>
<h4 id="向量空间模型"><a href="#向量空间模型" class="headerlink" title="向量空间模型"></a>向量空间模型</h4><blockquote>
<p>向量空间模型(Vector Space Mode)组合多个相关度时采用的是基于向量的算法</p>
</blockquote>
<p> 在向量空间模型中，多个查询条件的相关度以向量的形式表示，向量实际上就是包含多个数的一维数组，例如[1,2, 3,4, 5, 6]就是一个6维向量，其中每个数字都代表一个查询条件的相关度。</p>
<p> 文档对于n个查询条件会形成一个n维的向量空间，如果定义1个查询条件最佳匹配的n维向量，那么与这个向量越接近则相关度越高，从向量的角度来看，就是两个向量之间的夹角越小相关度越高，所以n个相关度的组合就转换为向量之间夹角的计算。</p>
<p> 简单理解，可以只考虑一个二维向量，也就是查询条件只有两个，这样就可以将两个相关度映射到二维坐标图的X轴和Y轴上，假设两个查询条件权重相同，那么最佳匹配值就可以设置为[1, 1]，如果某文档匹配了第一个条件，部分地匹配了第二个条件，则该文档的向量值为[1, 0.2]，将这两个向量绘制在二维坐标图中，就得到了它们的夹角。</p>
<blockquote>
<p>对于多维向量来说，线性代数提供了余弦近似度算法，专门用于计算两个多维向量的夹角。</p>
</blockquote>
<p> 余弦相似性通过测量两个向量的夹角的余弦值来度量它们之间的相似性，0度角的余弦值是1，而其他任何角度的余弦值都不大于1；并且其最小值是-1。从而两个向量之间的角度的余弦值确定两个向量是否大致指向相同的方向。两个向量有相同的指向时，余弦相似度的值为1；两个向量夹角为90°时，余弦相似度的值为0；两个向量指向完全相反的方向时，余弦相似度的值为-1。这结果是与向量的长度无关的，仅仅与向量的指向方向相关。余弦相似度通常用于正空间，因此给出的值为-1到1之间。</p>
<p> 注意这上下界对任何维度的向量空间中都适用，而且余弦相似性最常用于高维正空间，例如在信息检索中，每个词项被赋予不同的维度，而一个维度由一个向量表示，其各个维度上的值对应于该词项在文档中出现的频率。余弦相似度因此可以给出两篇文档在其主题方面的相似度。</p>
<h4 id="概率模型"><a href="#概率模型" class="headerlink" title="概率模型"></a>概率模型</h4><blockquote>
<p>概率模型是基于概率论构建的模型，BM25、DFR、DFI都属于概率模型中的一种实现算法，背后有着非常严谨的概率理论依据。</p>
</blockquote>
<p> 以其中最为流行的BM25为例，它背后的概率理论是<strong>贝叶斯定理</strong>，而这个定理在许多领城中都有广泛的应用，BM25法将检索出来的文档(D)分为相关文档(R)和不相关文档(NR)两类，使用P(R|D)代表文档属于相关文档的概率，而使用P(NR|D)表示文档属于不相关文档的概率，则当P(R|D)&gt;P(NR|D)时认为这个文档与用户查询相关。根据贝叶斯公式将P(R|D)&gt;P(NR|D)转换为对某个比值的计算。在此基础上再进行一此转换，就可以得到不同的相关度算法。</p>
<h4 id="语言模型"><a href="#语言模型" class="headerlink" title="语言模型"></a>语言模型</h4><blockquote>
<p>语言模型最早并不是应用于全文检索领域，而是应用于语音识别、机器翻译、拼写检查等领域。</p>
</blockquote>
<p> 在全文检索中，语言模型为每个文档建立不同的计算模型，用以判断由文档生成某一查询条件的概率是多少，而这个概率的值就可以认为是相关度。可见，语言模型与其他检索模型正好相反，其他检索模型都是从查询条件查找满足条件的文档，而语言模型则是根据文档推断可能的查询条件。</p>
<h3 id="相关度算法"><a href="#相关度算法" class="headerlink" title="相关度算法"></a>相关度算法</h3><blockquote>
<p>下面我们看一下常见的几种相关度算法</p>
</blockquote>
<h4 id="TF-IDF"><a href="#TF-IDF" class="headerlink" title="TF/IDF"></a>TF/IDF</h4><blockquote>
<p>对于一篇几百字几千字的文章，如何生成足以准确表示该文章的特征向量呢？</p>
</blockquote>
<p> 就像论文一样，摘要、关键词毫无疑问就是全篇最核心的内容，因此，我们要设法提取一篇文档的关键词，并对每个关键词计算其对应的特征权值，从而形成特征向量，这里涉及一个非常简单但又相当强大的算法，即TF-IDF算法。</p>
<p> TF/IDF实际上两个影响相关度的因素，即TF和IDF，其中TF是<strong>词项频率简称词频</strong>，指一个词项在当前文档中出现的次数，而IDF则是<strong>逆向文档频率</strong>，指词项在所有文档中出现的次数。</p>
<p> Elasticsearch提供的几种算法中都或多或少有TF/IDF的思想，例如BM25算法虽然是通过概率论推导而来，但最终的计算公式与TF/IDF在本质上也是一致的。</p>
<h5 id="词频-TF"><a href="#词频-TF" class="headerlink" title="词频 - TF"></a>词频 - TF</h5><blockquote>
<p>词频，英文缩写为TF，英文全写为Term Frequency，词频用于描述<code>检索词</code>在一篇文档中出现的频率，即：检索词出现的次数除以文档的总字数。</p>
</blockquote>
<p> 衡量一条查询语句和结果文档相关性的简单方法：简单地将搜索语句中的每一个词的TF进行相加。</p>
<p> 例如，<code>我的苹果</code>，即为：TF(我) + TF(的) + TF(苹果)。</p>
<p> 停用词，英文名为<code>Stop Word</code>，例如<code>我的苹果</code>中的<code>的</code>在文档中可能出现很多次，但贡献的相关度却几乎没有用处，因此不应该考虑他们的词频。</p>
<h5 id="逆文档频率-IDF"><a href="#逆文档频率-IDF" class="headerlink" title="逆文档频率 - IDF"></a>逆文档频率 - IDF</h5><blockquote>
<p>相对于逆文档频率，我们先来说说文档频率。</p>
</blockquote>
<p> 文档频率，英文缩写为DF，英文全写为Document Frequency，用于检索词在所有文档中出现的频率。</p>
<ul>
<li><code>苹果</code> 在相对较少的文档中出现</li>
<li><code>我</code> 在相对较多的文档中出现</li>
<li><code>的</code> 在大量的文档中出现</li>
</ul>
<blockquote>
<p>逆文档频率，英文全写为：Inverse Document Frequency，简单说也就是：<code>log(全部文档数 / 检索词出现过的文档总数)</code></p>
</blockquote>
<h5 id="TF-IDF-1"><a href="#TF-IDF-1" class="headerlink" title="TF-IDF"></a>TF-IDF</h5><blockquote>
<p>TF-IDF的本质就是将<code>TF求和</code>变成了<code>加权求和</code>，<code>TF(我)*IDF(我)+TF(的)*IDF(的)+TF(苹果)*IDF(苹果)</code></p>
</blockquote>
<table>
<thead>
<tr>
<th></th>
<th>出现的文档数</th>
<th>总文档数</th>
<th>IDF</th>
</tr>
</thead>
<tbody><tr>
<td>我</td>
<td>5亿</td>
<td>10亿</td>
<td>log(2) = 1</td>
</tr>
<tr>
<td>的</td>
<td>10亿</td>
<td>10亿</td>
<td>log(1) = 0</td>
</tr>
<tr>
<td>苹果</td>
<td>200万</td>
<td>10亿</td>
<td>log(500) = 8.96</td>
</tr>
</tbody></table>
<p> 可见，在使用TF/IDF计算评分时必须要用到词项在文档中出现的频率，即词频，默认情况下文档text类型字段在编入索引时都会记录词频，Elasticsearch中的classic算法实际上是使用Lucene的实用评分函数(Practical Scoring Function)，这个评分函数结合了布尔模型、TF/IDF和向量空间模型来共同计算分值，该算法是早期Elasticsearch运算相关度的算法，现在已经改为BM25了。</p>
<h4 id="BM25"><a href="#BM25" class="headerlink" title="BM25"></a>BM25</h4><blockquote>
<p>BM25是Best Match25的简写，由于最早应用于一个名为Okapi的系统中，所以很多文献中也称之为 Okapi BM25</p>
</blockquote>
<p> BM25算法被认为是当今最先进的相关度算法之一，Elasticsearch文档字段的默认相关度算法就是采用BM25，它属于概率模型，依据贝叶斯公式，经过一系列的严格推导以后，得出了一个关于IDF的公式</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch350.png" alt="img"></p>
<p>同时在这个基础上，最终的公式上加入了对TF、当前文档的长度、词频饱和度、长度归一化等因素的考虑：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch351.png" alt="img"></p>
<h5 id="词频饱和度"><a href="#词频饱和度" class="headerlink" title="词频饱和度"></a>词频饱和度</h5><blockquote>
<p>所谓词频饱和度指的是当词频超过一定数量之后，它对相关度的影响将趋于饱和</p>
</blockquote>
<p> 换句话说，词频10次的相关度比词频1次的分值要大很多，但100次10次之间差距就不会那么明显了。在BM25算法中，控制词频饱和度的参数是k1，默认值为1.2，参数k1的值越小词频对相关度的影响就会越快趋于饱和，而值越大词频饱和度变化越慢。</p>
<p> 举例来说，如果将k1设置为1，词频达到10时就会趋于饱和；而当k1设置为100时词频在100时才会趋于饱和，一般来说k1的取值范围为[1.2, 2.0]。</p>
<h5 id="长度归一化"><a href="#长度归一化" class="headerlink" title="长度归一化"></a>长度归一化</h5><blockquote>
<p>一般来说， 查询条件中的词项出现在较短的文本中，比出现在较长的文本中对结果的相关性影响更大。</p>
</blockquote>
<p> 举例来说，如果一篇文章的标题中包含elasticsearch，那么这篇文章是专门介绍elasticsearch的可能性比只在文章内容中出现elasticsearch的可能要高很多，但这种比较其实是建立在两个不同的字段上，而在实际检索时往往是针对相同的字段做比较。</p>
<blockquote>
<p>比如在两篇文章的标题中都出现了elasticsearch，那么哪一篇文章的相关度更高呢?</p>
</blockquote>
<p> BM25针对这种情况对文本长度做了所谓的归一化处理，即考虑当前文档字段的文本长度与所有文档的字段平均长度的比值，而这个比值就是长度归一化因素。</p>
<p> 为了控制长度归一化对相关度的影响，在长度归一化中加了一个控制参数b，这个值的取值范围为[0.0, 1.0]，取值0.0时会禁用归一化，而取值1.0则会完全启用归一化，默认值为0. 75。</p>
<h5 id="和TF-IDF"><a href="#和TF-IDF" class="headerlink" title="和TF/IDF"></a>和TF/IDF</h5><blockquote>
<p>下面我们看看BM25和TF/IDF的区别</p>
</blockquote>
<ol>
<li>从Elasticsearch5.0开始，默认算法由TF-IDF改为BM25</li>
<li>和经典的TF-IDF相比，当TF无限增加时，BM25计算的相关性分数会趋于一个固定数值。</li>
</ol>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch352.png" alt="img"></p>
<h3 id="相关性查询"><a href="#相关性查询" class="headerlink" title="相关性查询"></a>相关性查询</h3><h4 id="查看TF-IDF"><a href="#查看TF-IDF" class="headerlink" title="查看TF-IDF"></a>查看TF-IDF</h4><blockquote>
<p>在查询语句时，我们可通过explain查看TF-IDF</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET logstash-village/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;explain&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;addr&quot;</span>: <span class="string">&quot;龙苑小区&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查询后可以看到TF-IDF的相关性评分</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch353.png" alt="image-20220831111954100"></p>
<h4 id="Boosting"><a href="#Boosting" class="headerlink" title="Boosting"></a>Boosting</h4><blockquote>
<p>Boosting是控制相关度的一种手段。</p>
</blockquote>
<h5 id="可选参数"><a href="#可选参数" class="headerlink" title="可选参数"></a>可选参数</h5><blockquote>
<p>返回匹配positive查询的文档，并降低匹配negative查询的文档相似度分</p>
</blockquote>
<ul>
<li>当boost &gt; 1时，打分的权重相对性提升</li>
<li>当0 &lt; boost &lt;1时，打分的权重相对性降低</li>
<li>当boost &lt;0时，贡献负分</li>
</ul>
<p>这样就可以在不排除某些文档的前提下对文档进行查询，搜索结果中存在只不过相似度分数相比正常匹配的要低</p>
<h5 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h5><blockquote>
<p>希望包含了某项内容的结果不是不出现，而是排序靠后</p>
</blockquote>
<h5 id="正常查询"><a href="#正常查询" class="headerlink" title="正常查询"></a>正常查询</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET logstash-village/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;addr&quot;</span>: <span class="string">&quot;龙苑小区&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>正常查询的时候我们发现内蒙古排在第一位</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch354.png" alt="image-20220831112936085"></p>
<h5 id="降低评分-1"><a href="#降低评分-1" class="headerlink" title="降低评分"></a>降低评分</h5><blockquote>
<p>我们不需要不太关注于内蒙古地区的数据，我们可以将内蒙古相关评分降低</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET logstash-village/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;boosting&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;positive&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;addr&quot;</span>: <span class="string">&quot;龙苑小区&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;negative&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;province&quot;</span>: <span class="string">&quot;内蒙古自治区&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;negative_boost&quot;</span>: 0.9</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们设置<code>&quot;negative_boost&quot;: 0.9</code>，这样相关性评分就会降低，我们发现数据已经变了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch355.png" alt="image-20220831113128393"></p>
<h4 id="布尔查询"><a href="#布尔查询" class="headerlink" title="布尔查询"></a>布尔查询</h4><blockquote>
<p>一个bool查询,是一个或者多个查询子句的组合，总共包括4种子句，其中2种会影响算分，2种不影响算分</p>
</blockquote>
<h5 id="相关查询"><a href="#相关查询" class="headerlink" title="相关查询"></a>相关查询</h5><ul>
<li>must: 相当于<code>&amp;&amp;</code> ，必须匹配，贡献算分</li>
<li>should: 相当于<code>|| </code>，选择性匹配，贡献算分</li>
<li>must_not: 相当于<code>! </code>，必须不能匹配，不贡献算分</li>
<li>filter: 必须匹配，不贡献算法</li>
</ul>
<h5 id="查询方式-1"><a href="#查询方式-1" class="headerlink" title="查询方式"></a>查询方式</h5><blockquote>
<p>在Elasticsearch中，有Query和 Filter两种不同的查询方式</p>
</blockquote>
<ul>
<li>Query : 相关性算分</li>
<li>Filter : 不需要算分 ,可以利用Cache，获得更好的性能</li>
</ul>
<p>相关性并不只是全文本检索的专利，也适用于yes | no 的子句，匹配的子句越多，相关性评分越高，如果多条查询子句被合并为一条复合查询语句，比如 bool查询，则每个查询子句计算得出的评分会被合并到总的相关性评分中</p>
<h5 id="bool查询"><a href="#bool查询" class="headerlink" title="bool查询"></a>bool查询</h5><blockquote>
<p>子查询可以任意顺序出现，可以嵌套多个查询，如果你的bool查询中，没有must条件,should中必须至少满足一条查询</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GET logstash-village/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;addr&quot;</span>: <span class="string">&quot;龙源小区&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;greening&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;gte&quot;</span>: 30</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;must_not&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;property_type&quot;</span>: <span class="string">&quot;公寓&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;should&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;province&quot;</span>: <span class="string">&quot;河南省&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;province&quot;</span>: <span class="string">&quot;安徽省&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;built_year&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;gte&quot;</span>: 2010,</span><br><span class="line">              <span class="string">&quot;lte&quot;</span>: 2020</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过bool查询查询地址包含<code>龙苑小区</code>，并且绿化率大于<code>30%</code>非公寓住宅，并且在省份在河南省或者安徽省，并且建造年份在2010-2020的小区住房</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/elasticsearch356.png" alt="image-20220831143032862"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">小肥龙吃大冰淇淋</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lvxueyangtiger.github.io/post/7a4.html">https://lvxueyangtiger.github.io/post/7a4.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lvxueyangtiger.github.io" target="_blank">小肥龙吃大冰淇淋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/">搜索引擎</a><a class="post-meta__tags" href="/tags/Elasticsearch/">Elasticsearch</a></div><div class="post_share"><div class="social-share" data-image="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212055.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/7a41cdc3.html"><img class="prev-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082010.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">ElasticSearch之企业级高可用分布式集群</div></div></a></div><div class="next-post pull-right"><a href="/post/51a6cf8f.html"><img class="next-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082137.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Dubbo基础知识点</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/36a0436b.html" title="ElasticSearch之入门使用"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082249.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">ElasticSearch之入门使用</div></div></a></div><div><a href="/post/7a41cdc3.html" title="ElasticSearch之企业级高可用分布式集群"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082010.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">ElasticSearch之企业级高可用分布式集群</div></div></a></div><div><a href="/post/844c8e8e.html" title="ElasticSearch之数据模型构建"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082319.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">ElasticSearch之数据模型构建</div></div></a></div><div><a href="/post/b0f534d5.html" title="ElasticSearch基础"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212050.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">ElasticSearch基础</div></div></a></div><div><a href="/post/5a1f6e0b.html" title="ElasticSearch之深度应用及原理剖析"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082110.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">ElasticSearch之深度应用及原理剖析</div></div></a></div><div><a href="/post/24cc40e3.html" title="ElasticSearch之搜索实战"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082137.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">ElasticSearch之搜索实战</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">ElasticSearch 概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Elasticsearch-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.1.</span> <span class="toc-text">Elasticsearch 是什么</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ElasticSearch%E7%89%B9%E7%82%B9"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">ElasticSearch特点</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.1.2.</span> <span class="toc-text">使用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E5%92%8C%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">记录和日志分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%90%9C%E9%9B%86%E5%92%8C%E5%90%88%E5%B9%B6%E5%85%AC%E5%85%B1%E6%95%B0%E6%8D%AE"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">搜集和合并公共数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">全文搜索</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E6%95%B0%E6%8D%AE%E5%92%8C%E6%8C%87%E6%A0%87"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">事件数据和指标</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E6%95%B0%E6%8D%AE"><span class="toc-number">1.1.2.5.</span> <span class="toc-text">可视化数据</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.3.</span> <span class="toc-text">能做什么</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BE%9B%E5%BF%AB%E9%80%9F%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">提供快速查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A1%AE%E4%BF%9D%E7%BB%93%E6%9E%9C%E7%9A%84%E7%9B%B8%E5%85%B3%E6%80%A7"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">确保结果的相关性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E9%94%99%E8%AF%AF%E7%9A%84%E6%8B%BC%E5%86%99"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">处理错误的拼写</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%99%E4%BA%88%E8%87%AA%E5%8A%A8%E6%8F%90%E7%A4%BA"><span class="toc-number">1.1.3.4.</span> <span class="toc-text">给予自动提示</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF"><span class="toc-number">1.1.3.5.</span> <span class="toc-text">使用统计信息</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ElasticSearch%E7%9A%84%E5%8F%91%E5%B1%95"><span class="toc-number">1.1.4.</span> <span class="toc-text">ElasticSearch的发展</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B5%B7%E6%BA%90Lucene"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">起源Lucene</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9"><span class="toc-number">1.1.4.1.1.</span> <span class="toc-text">缺点</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%9E%E7%94%9F"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">诞生</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%91%E5%B1%95"><span class="toc-number">1.1.4.3.</span> <span class="toc-text">发展</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ElasticSearch%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.</span> <span class="toc-text">ElasticSearch基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">索引类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A3%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">正排索引</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AD%A3%E6%8E%92%E7%B4%A2%E5%BC%95%E8%AF%B4%E6%98%8E"><span class="toc-number">1.2.1.1.1.</span> <span class="toc-text">正排索引说明</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.2.1.1.2.</span> <span class="toc-text">索引查询</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%A8%E8%A1%A8%E6%89%AB%E6%8F%8F"><span class="toc-number">1.2.1.1.3.</span> <span class="toc-text">全表扫描</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E7%B4%A2%E5%BC%95"><span class="toc-number">1.2.1.1.4.</span> <span class="toc-text">全文索引</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">倒排索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%A4%E7%A7%8D%E7%B4%A2%E5%BC%95%E6%9F%A5%E6%89%BE%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">两种索引查找顺序</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.2.</span> <span class="toc-text">逻辑概念</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%EF%BC%88Index%EF%BC%89"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">索引（Index）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%EF%BC%88Type%EF%BC%89"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">类型（Type）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%8F%98%E5%8C%96"><span class="toc-number">1.2.2.2.1.</span> <span class="toc-text">类型的变化</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%EF%BC%88Document%EF%BC%89"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">文档（Document）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%EF%BC%88Field%EF%BC%89"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">字段（Field）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%98%A0%E5%B0%84%EF%BC%88Mapping%EF%BC%89"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">映射（Mapping）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%A9%E7%90%86%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.3.</span> <span class="toc-text">物理概念</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4-%EF%BC%88cluster%EF%BC%89"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">集群 （cluster）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%EF%BC%88node%EF%BC%89"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">节点（node）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E7%89%87%EF%BC%88Shards%EF%BC%89"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">分片（Shards）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%EF%BC%88Replicas%EF%BC%89"><span class="toc-number">1.2.3.4.</span> <span class="toc-text">副本（Replicas）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AE%B5%EF%BC%88segment%EF%BC%89"><span class="toc-number">1.2.3.5.</span> <span class="toc-text">段（segment）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E7%9A%84%E8%A7%92%E8%89%B2"><span class="toc-number">1.2.3.6.</span> <span class="toc-text">节点的角色</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#master%E8%A7%92%E8%89%B2"><span class="toc-number">1.2.3.6.1.</span> <span class="toc-text">master角色</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#voting-only-%E4%BB%85%E6%8A%95%E7%A5%A8%E8%8A%82%E7%82%B9"><span class="toc-number">1.2.3.6.2.</span> <span class="toc-text">voting_only 仅投票节点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#data-%E6%95%B0%E6%8D%AE%E8%8A%82%E7%82%B9"><span class="toc-number">1.2.3.6.3.</span> <span class="toc-text">data 数据节点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#ingest-%E6%91%84%E5%8F%96%E8%8A%82%E7%82%B9"><span class="toc-number">1.2.3.6.4.</span> <span class="toc-text">ingest 摄取节点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#coordinating-%E4%BB%85%E5%8D%8F%E8%B0%83%E8%8A%82%E7%82%B9"><span class="toc-number">1.2.3.6.5.</span> <span class="toc-text">coordinating 仅协调节点</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.3.7.</span> <span class="toc-text">配置节点类型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ElasticSearch%E9%9B%86%E7%BE%A4%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.</span> <span class="toc-text">ElasticSearch集群概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2"><span class="toc-number">1.3.1.</span> <span class="toc-text">集群角色</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Master%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">Master节点</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E8%81%8C%E8%B4%A3"><span class="toc-number">1.3.1.1.1.</span> <span class="toc-text">主要职责</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%A7%92%E8%89%B2%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.3.1.1.2.</span> <span class="toc-text">角色介绍</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%85%E6%8A%95%E7%A5%A8%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">仅投票节点</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E8%81%8C%E8%B4%A3-1"><span class="toc-number">1.3.1.2.1.</span> <span class="toc-text">主要职责</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%A7%92%E8%89%B2%E4%BB%8B%E7%BB%8D-1"><span class="toc-number">1.3.1.2.2.</span> <span class="toc-text">角色介绍</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">数据节点</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E8%81%8C%E8%B4%A3-2"><span class="toc-number">1.3.1.3.1.</span> <span class="toc-text">主要职责</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%A7%92%E8%89%B2%E4%BB%8B%E7%BB%8D-2"><span class="toc-number">1.3.1.3.2.</span> <span class="toc-text">角色介绍</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A2%84%E5%A4%84%E7%90%86%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">预处理节点</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E8%81%8C%E8%B4%A3-3"><span class="toc-number">1.3.1.4.1.</span> <span class="toc-text">主要职责</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%A7%92%E8%89%B2%E4%BB%8B%E7%BB%8D-3"><span class="toc-number">1.3.1.4.2.</span> <span class="toc-text">角色介绍</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%85%E5%8D%8F%E8%B0%83%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.1.5.</span> <span class="toc-text">仅协调节点</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8F%AA%E8%A6%81%E8%81%8C%E8%B4%A3"><span class="toc-number">1.3.1.5.1.</span> <span class="toc-text">只要职责</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%A7%92%E8%89%B2%E4%BB%8B%E7%BB%8D-4"><span class="toc-number">1.3.1.5.2.</span> <span class="toc-text">角色介绍</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.1.6.</span> <span class="toc-text">节点配置方式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%84%91%E8%A3%82%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.2.</span> <span class="toc-text">集群脑裂问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%84%91%E8%A3%82%E5%88%86%E6%9E%90"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">脑裂分析</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E9%80%89%E4%B8%BB"><span class="toc-number">1.3.2.1.1.</span> <span class="toc-text">重新选主</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%87%BA%E7%8E%B0%E8%84%91%E8%A3%82"><span class="toc-number">1.3.2.1.2.</span> <span class="toc-text">出现脑裂</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">解决方案</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch-%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2"><span class="toc-number">2.</span> <span class="toc-text">ElasticSearch 单机部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2"><span class="toc-number">2.1.</span> <span class="toc-text">单机部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD-Elasticsearch"><span class="toc-number">2.1.1.</span> <span class="toc-text">下载 Elasticsearch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Elasticsearch"><span class="toc-number">2.1.2.</span> <span class="toc-text">配置 Elasticsearch</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">关闭防火墙</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEelasticsearch-yml"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">配置elasticsearch.yml</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9Linux%E5%8F%A5%E6%9F%84%E6%95%B0"><span class="toc-number">2.1.3.</span> <span class="toc-text">修改Linux句柄数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E6%9C%80%E5%A4%A7%E5%8F%A5%E6%9F%84%E6%95%B0"><span class="toc-number">2.1.3.1.</span> <span class="toc-text">查看当前最大句柄数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%8F%A5%E6%9F%84%E6%95%B0"><span class="toc-number">2.1.3.2.</span> <span class="toc-text">修改句柄数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%9F%E6%95%88%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.3.3.</span> <span class="toc-text">生效配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%ADswap"><span class="toc-number">2.1.4.</span> <span class="toc-text">关闭swap</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%B4%E6%97%B6%E5%85%B3%E9%97%AD"><span class="toc-number">2.1.4.1.</span> <span class="toc-text">临时关闭</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B0%B8%E4%B9%85%E5%85%B3%E9%97%AD"><span class="toc-number">2.1.4.2.</span> <span class="toc-text">永久关闭</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%9C%80%E5%A4%A7%E7%BA%BF%E7%A8%8B%E6%95%B0"><span class="toc-number">2.1.5.</span> <span class="toc-text">修改最大线程数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BF%AE%E6%94%B9"><span class="toc-number">2.1.5.1.</span> <span class="toc-text">配置修改</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E5%90%AF%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.1.5.2.</span> <span class="toc-text">重启服务</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAES%E7%94%A8%E6%88%B7"><span class="toc-number">2.1.6.</span> <span class="toc-text">创建ES用户</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7"><span class="toc-number">2.1.6.1.</span> <span class="toc-text">添加用户</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E7%AE%A1%E7%90%86%E5%91%98%E6%9D%83%E9%99%90"><span class="toc-number">2.1.6.2.</span> <span class="toc-text">增加管理员权限</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9Elasticsearch%E6%9D%83%E9%99%90"><span class="toc-number">2.1.6.3.</span> <span class="toc-text">修改Elasticsearch权限</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JVM%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.7.</span> <span class="toc-text">JVM配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0IK%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">2.1.8.</span> <span class="toc-text">添加IK分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE"><span class="toc-number">2.1.8.1.</span> <span class="toc-text">查找</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%8E%8B"><span class="toc-number">2.1.8.2.</span> <span class="toc-text">解压</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8ElasticSearch"><span class="toc-number">2.1.9.</span> <span class="toc-text">启动ElasticSearch</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E7%94%A8%E6%88%B7"><span class="toc-number">2.1.9.1.</span> <span class="toc-text">切换用户</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">2.1.9.2.</span> <span class="toc-text">启动命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95"><span class="toc-number">2.1.9.3.</span> <span class="toc-text">访问测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E5%90%AFElasticSearch"><span class="toc-number">2.1.9.4.</span> <span class="toc-text">重启ElasticSearch</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E8%BF%9B%E7%A8%8B"><span class="toc-number">2.1.9.4.1.</span> <span class="toc-text">查找进程</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9D%80%E6%AD%BB%E8%BF%9B%E7%A8%8B"><span class="toc-number">2.1.9.5.</span> <span class="toc-text">杀死进程</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8ElasticSearch-1"><span class="toc-number">2.1.9.5.1.</span> <span class="toc-text">启动ElasticSearch</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kibana%E5%AE%89%E8%A3%85"><span class="toc-number">2.1.10.</span> <span class="toc-text">kibana安装</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85-Kibana"><span class="toc-number">2.1.10.1.</span> <span class="toc-text">下载安装 Kibana</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Kibana"><span class="toc-number">2.1.10.2.</span> <span class="toc-text">配置 Kibana</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-Kibana"><span class="toc-number">2.1.10.3.</span> <span class="toc-text">启动 Kibana</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E7%94%A8%E6%88%B7-1"><span class="toc-number">2.1.10.3.1.</span> <span class="toc-text">切换用户</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8kibaba"><span class="toc-number">2.1.10.3.2.</span> <span class="toc-text">启动kibaba</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95-1"><span class="toc-number">2.1.10.3.3.</span> <span class="toc-text">访问测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ES%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">2.2.</span> <span class="toc-text">ES快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="toc-number">2.2.1.</span> <span class="toc-text">索引管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%97%E5%87%BA%E7%B4%A2%E5%BC%95"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">列出索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">查看索引</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E8%AF%B4%E6%98%8E"><span class="toc-number">2.2.1.3.1.</span> <span class="toc-text">结果说明</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-number">2.2.1.4.</span> <span class="toc-text">索引是否存在</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E7%B4%A2%E5%BC%95"><span class="toc-number">2.2.1.5.</span> <span class="toc-text">关闭索引</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95%E5%88%97%E8%A1%A8"><span class="toc-number">2.2.1.5.1.</span> <span class="toc-text">查看索引列表</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%85%B3%E9%97%AD%E7%B4%A2%E5%BC%95"><span class="toc-number">2.2.1.5.2.</span> <span class="toc-text">为什么关闭索引</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%93%E5%BC%80%E7%B4%A2%E5%BC%95"><span class="toc-number">2.2.1.6.</span> <span class="toc-text">打开索引</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95%E5%88%97%E8%A1%A8-1"><span class="toc-number">2.2.1.6.1.</span> <span class="toc-text">查看索引列表</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="toc-number">2.2.1.7.</span> <span class="toc-text">删除索引</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%A0%E5%B0%84%E7%AE%A1%E7%90%86"><span class="toc-number">2.2.2.</span> <span class="toc-text">映射管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">创建映射</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%98%A0%E5%B0%84"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">查看映射</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E7%AE%A1%E7%90%86"><span class="toc-number">2.2.3.</span> <span class="toc-text">文档管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3-%E4%B8%9A%E5%8A%A1ID"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">创建文档(业务ID)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E8%AF%B4%E6%98%8E"><span class="toc-number">2.2.3.1.1.</span> <span class="toc-text">操作说明</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.2.3.1.2.</span> <span class="toc-text">使用示例</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E8%AF%B4%E6%98%8E"><span class="toc-number">2.2.3.1.3.</span> <span class="toc-text">返回结果说明</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3-%E8%87%AA%E5%8A%A8ID"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">创建文档(自动ID)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">更新文档</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%A8%E9%87%8F%E6%9B%B4%E6%96%B0"><span class="toc-number">2.2.3.3.1.</span> <span class="toc-text">全量更新</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A2%9E%E9%87%8F%E6%9B%B4%E6%96%B0"><span class="toc-number">2.2.3.3.2.</span> <span class="toc-text">增量更新</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-number">2.2.3.4.</span> <span class="toc-text">查询文档</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-number">2.2.3.4.1.</span> <span class="toc-text">验证是否存在</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3-1"><span class="toc-number">2.2.3.4.2.</span> <span class="toc-text">查询文档</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%8D%E8%BF%94%E5%9B%9Esource"><span class="toc-number">2.2.3.4.3.</span> <span class="toc-text">不返回source</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89"><span class="toc-number">2.2.3.4.4.</span> <span class="toc-text">查询所有</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="toc-number">2.2.3.5.</span> <span class="toc-text">删除文档</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E6%96%87%E6%A1%A3ID%E5%88%A0%E9%99%A4"><span class="toc-number">2.2.3.5.1.</span> <span class="toc-text">根据文档ID删除</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E6%9D%A1%E4%BB%B6%E5%88%A0%E9%99%A4"><span class="toc-number">2.2.3.5.2.</span> <span class="toc-text">根据条件删除</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">2.2.4.</span> <span class="toc-text">中文分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#IKAnalyzer"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">IKAnalyzer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8IK%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">2.2.4.2.</span> <span class="toc-text">使用IK分词器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ik-smart"><span class="toc-number">2.2.4.3.</span> <span class="toc-text">ik_smart</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">2.2.4.3.1.</span> <span class="toc-text">使用案例</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D"><span class="toc-number">2.2.4.3.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ik-max-word"><span class="toc-number">2.2.4.4.</span> <span class="toc-text">ik_max_word</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-1"><span class="toc-number">2.2.4.4.1.</span> <span class="toc-text">使用案例</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-1"><span class="toc-number">2.2.4.4.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AF%8D%E5%BA%93"><span class="toc-number">2.2.4.5.</span> <span class="toc-text">自定义词库</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="toc-number">2.2.4.5.1.</span> <span class="toc-text">问题描述</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1"><span class="toc-number">2.2.4.6.</span> <span class="toc-text">解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%96%E8%BE%91%E5%AD%97%E5%85%B8%E5%86%85%E5%AE%B9"><span class="toc-number">2.2.4.6.1.</span> <span class="toc-text">编辑字典内容</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E5%AD%97%E5%85%B8"><span class="toc-number">2.2.4.6.2.</span> <span class="toc-text">扩展字典</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E6%B5%8B%E8%AF%95"><span class="toc-number">2.2.4.6.3.</span> <span class="toc-text">再次测试</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="toc-number">3.</span> <span class="toc-text">ElasticSearch 集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-1"><span class="toc-number">3.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%B8%83%E5%B1%80"><span class="toc-number">3.1.1.</span> <span class="toc-text">服务布局</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">3.1.2.</span> <span class="toc-text">准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%8C%82%E8%BD%BD%E7%9B%AE%E5%BD%95"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">创建挂载目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E6%8E%88%E6%9D%83"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">目录授权</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9Linux%E5%8F%A5%E6%9F%84%E6%95%B0-1"><span class="toc-number">3.1.2.3.</span> <span class="toc-text">修改Linux句柄数</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E6%9C%80%E5%A4%A7%E5%8F%A5%E6%9F%84%E6%95%B0-1"><span class="toc-number">3.1.2.3.1.</span> <span class="toc-text">查看当前最大句柄数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%8F%A5%E6%9F%84%E6%95%B0-1"><span class="toc-number">3.1.2.3.2.</span> <span class="toc-text">修改句柄数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%9F%E6%95%88%E9%85%8D%E7%BD%AE-1"><span class="toc-number">3.1.2.3.3.</span> <span class="toc-text">生效配置</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%8F%A5%E6%9F%84%E6%95%B0%E5%92%8C%E6%9C%80%E5%A4%A7%E7%BA%BF%E7%A8%8B%E6%95%B0"><span class="toc-number">3.1.2.4.</span> <span class="toc-text">修改句柄数和最大线程数</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BF%AE%E6%94%B9-1"><span class="toc-number">3.1.2.4.1.</span> <span class="toc-text">配置修改</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8D%E5%90%AF%E6%9C%8D%E5%8A%A1-1"><span class="toc-number">3.1.2.4.2.</span> <span class="toc-text">重启服务</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0IK%E5%88%86%E8%AF%8D%E5%99%A8-1"><span class="toc-number">3.1.2.5.</span> <span class="toc-text">添加IK分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE-1"><span class="toc-number">3.1.2.5.1.</span> <span class="toc-text">查找</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%A7%A3%E5%8E%8B-1"><span class="toc-number">3.1.2.5.2.</span> <span class="toc-text">解压</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">3.1.2.5.3.</span> <span class="toc-text">安装</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.1.3.</span> <span class="toc-text">编写配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#node-1"><span class="toc-number">3.1.3.1.</span> <span class="toc-text">node-1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#node-2"><span class="toc-number">3.1.3.2.</span> <span class="toc-text">node-2</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#node-3"><span class="toc-number">3.1.3.3.</span> <span class="toc-text">node-3</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#kibana"><span class="toc-number">3.1.3.4.</span> <span class="toc-text">kibana</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E9%83%A8%E7%BD%B2%E6%96%87%E6%A1%A3"><span class="toc-number">3.1.4.</span> <span class="toc-text">编写部署文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.1.5.</span> <span class="toc-text">启动服务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ELK%E5%BC%82%E6%9E%84%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">4.</span> <span class="toc-text">ELK异构数据同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-2"><span class="toc-number">4.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFELK"><span class="toc-number">4.1.1.</span> <span class="toc-text">什么是ELK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ELK%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88"><span class="toc-number">4.1.2.</span> <span class="toc-text">ELK能做什么</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">日志收集</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%82%E6%9E%84%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">4.1.2.2.</span> <span class="toc-text">异构数据同步</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.1.3.</span> <span class="toc-text">常用组件介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#MySQL%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">MySQL服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Canal"><span class="toc-number">4.1.3.2.</span> <span class="toc-text">Canal</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#canal-%E5%8E%9F%E7%90%86"><span class="toc-number">4.1.3.2.1.</span> <span class="toc-text">canal 原理</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RabbitMQ"><span class="toc-number">4.1.3.3.</span> <span class="toc-text">RabbitMQ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Logstash"><span class="toc-number">4.1.3.4.</span> <span class="toc-text">Logstash</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ElasticSearch"><span class="toc-number">4.1.3.5.</span> <span class="toc-text">ElasticSearch</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#kibana-1"><span class="toc-number">4.1.3.6.</span> <span class="toc-text">kibana</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ES%E7%89%A9%E7%90%86%E9%83%A8%E7%BD%B2"><span class="toc-number">4.2.</span> <span class="toc-text">ES物理部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ES%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2"><span class="toc-number">4.2.1.</span> <span class="toc-text">ES单机部署</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD-Elasticsearch-1"><span class="toc-number">4.2.1.1.</span> <span class="toc-text">下载 Elasticsearch</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Elasticsearch-1"><span class="toc-number">4.2.1.2.</span> <span class="toc-text">配置 Elasticsearch</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99-1"><span class="toc-number">4.2.1.2.1.</span> <span class="toc-text">关闭防火墙</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEelasticsearch-yml-1"><span class="toc-number">4.2.1.2.2.</span> <span class="toc-text">配置elasticsearch.yml</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9Linux%E5%8F%A5%E6%9F%84%E6%95%B0-2"><span class="toc-number">4.2.1.3.</span> <span class="toc-text">修改Linux句柄数</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E6%9C%80%E5%A4%A7%E5%8F%A5%E6%9F%84%E6%95%B0-2"><span class="toc-number">4.2.1.3.1.</span> <span class="toc-text">查看当前最大句柄数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%8F%A5%E6%9F%84%E6%95%B0-2"><span class="toc-number">4.2.1.3.2.</span> <span class="toc-text">修改句柄数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%9F%E6%95%88%E9%85%8D%E7%BD%AE-2"><span class="toc-number">4.2.1.3.3.</span> <span class="toc-text">生效配置</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%97%ADswap-1"><span class="toc-number">4.2.1.4.</span> <span class="toc-text">关闭swap</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%B4%E6%97%B6%E5%85%B3%E9%97%AD-1"><span class="toc-number">4.2.1.4.1.</span> <span class="toc-text">临时关闭</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B0%B8%E4%B9%85%E5%85%B3%E9%97%AD-1"><span class="toc-number">4.2.1.4.2.</span> <span class="toc-text">永久关闭</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%9C%80%E5%A4%A7%E7%BA%BF%E7%A8%8B%E6%95%B0-1"><span class="toc-number">4.2.1.5.</span> <span class="toc-text">修改最大线程数</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BF%AE%E6%94%B9-2"><span class="toc-number">4.2.1.5.1.</span> <span class="toc-text">配置修改</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8D%E5%90%AF%E6%9C%8D%E5%8A%A1-2"><span class="toc-number">4.2.1.5.2.</span> <span class="toc-text">重启服务</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAES%E7%94%A8%E6%88%B7-1"><span class="toc-number">4.2.1.6.</span> <span class="toc-text">创建ES用户</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7-1"><span class="toc-number">4.2.1.6.1.</span> <span class="toc-text">添加用户</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E7%AE%A1%E7%90%86%E5%91%98%E6%9D%83%E9%99%90-1"><span class="toc-number">4.2.1.6.2.</span> <span class="toc-text">增加管理员权限</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9Elasticsearch%E6%9D%83%E9%99%90-1"><span class="toc-number">4.2.1.6.3.</span> <span class="toc-text">修改Elasticsearch权限</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JVM%E9%85%8D%E7%BD%AE-1"><span class="toc-number">4.2.2.</span> <span class="toc-text">JVM配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0IK%E5%88%86%E8%AF%8D%E5%99%A8-2"><span class="toc-number">4.2.3.</span> <span class="toc-text">添加IK分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE-2"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">查找</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%8E%8B-2"><span class="toc-number">4.2.3.2.</span> <span class="toc-text">解压</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8ElasticSearch-2"><span class="toc-number">4.2.4.</span> <span class="toc-text">启动ElasticSearch</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E7%94%A8%E6%88%B7-2"><span class="toc-number">4.2.4.1.</span> <span class="toc-text">切换用户</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4-1"><span class="toc-number">4.2.4.2.</span> <span class="toc-text">启动命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95-2"><span class="toc-number">4.2.4.3.</span> <span class="toc-text">访问测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E5%90%AFElasticSearch-1"><span class="toc-number">4.2.4.4.</span> <span class="toc-text">重启ElasticSearch</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E8%BF%9B%E7%A8%8B-1"><span class="toc-number">4.2.4.4.1.</span> <span class="toc-text">查找进程</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9D%80%E6%AD%BB%E8%BF%9B%E7%A8%8B-1"><span class="toc-number">4.2.4.5.</span> <span class="toc-text">杀死进程</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8ElasticSearch-3"><span class="toc-number">4.2.4.5.1.</span> <span class="toc-text">启动ElasticSearch</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kibana%E5%AE%89%E8%A3%85-1"><span class="toc-number">4.2.5.</span> <span class="toc-text">kibana安装</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85-Kibana-1"><span class="toc-number">4.2.5.1.</span> <span class="toc-text">下载安装 Kibana</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Kibana-1"><span class="toc-number">4.2.5.2.</span> <span class="toc-text">配置 Kibana</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-Kibana-1"><span class="toc-number">4.2.5.3.</span> <span class="toc-text">启动 Kibana</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E7%94%A8%E6%88%B7-3"><span class="toc-number">4.2.5.3.1.</span> <span class="toc-text">切换用户</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8kibaba-1"><span class="toc-number">4.2.5.3.2.</span> <span class="toc-text">启动kibaba</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95-3"><span class="toc-number">4.2.5.3.3.</span> <span class="toc-text">访问测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ES%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8-1"><span class="toc-number">4.3.</span> <span class="toc-text">ES快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86-1"><span class="toc-number">4.3.1.</span> <span class="toc-text">索引管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%97%E5%87%BA%E7%B4%A2%E5%BC%95-1"><span class="toc-number">4.3.1.1.</span> <span class="toc-text">列出索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95-1"><span class="toc-number">4.3.1.2.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95-1"><span class="toc-number">4.3.1.3.</span> <span class="toc-text">查看索引</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E8%AF%B4%E6%98%8E-1"><span class="toc-number">4.3.1.3.1.</span> <span class="toc-text">结果说明</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8-1"><span class="toc-number">4.3.1.4.</span> <span class="toc-text">索引是否存在</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E7%B4%A2%E5%BC%95-1"><span class="toc-number">4.3.1.5.</span> <span class="toc-text">关闭索引</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95%E5%88%97%E8%A1%A8-2"><span class="toc-number">4.3.1.5.1.</span> <span class="toc-text">查看索引列表</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%85%B3%E9%97%AD%E7%B4%A2%E5%BC%95-1"><span class="toc-number">4.3.1.5.2.</span> <span class="toc-text">为什么关闭索引</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%93%E5%BC%80%E7%B4%A2%E5%BC%95-1"><span class="toc-number">4.3.1.6.</span> <span class="toc-text">打开索引</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95%E5%88%97%E8%A1%A8-3"><span class="toc-number">4.3.1.6.1.</span> <span class="toc-text">查看索引列表</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95-1"><span class="toc-number">4.3.1.7.</span> <span class="toc-text">删除索引</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%A0%E5%B0%84%E7%AE%A1%E7%90%86-1"><span class="toc-number">4.3.2.</span> <span class="toc-text">映射管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84-1"><span class="toc-number">4.3.2.1.</span> <span class="toc-text">创建映射</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%98%A0%E5%B0%84-1"><span class="toc-number">4.3.2.2.</span> <span class="toc-text">查看映射</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E7%AE%A1%E7%90%86-1"><span class="toc-number">4.3.3.</span> <span class="toc-text">文档管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3-%E4%B8%9A%E5%8A%A1ID-1"><span class="toc-number">4.3.3.1.</span> <span class="toc-text">创建文档(业务ID)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E8%AF%B4%E6%98%8E-1"><span class="toc-number">4.3.3.1.1.</span> <span class="toc-text">操作说明</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">4.3.3.1.2.</span> <span class="toc-text">使用示例</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E8%AF%B4%E6%98%8E-1"><span class="toc-number">4.3.3.1.3.</span> <span class="toc-text">返回结果说明</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3-%E8%87%AA%E5%8A%A8ID-1"><span class="toc-number">4.3.3.2.</span> <span class="toc-text">创建文档(自动ID)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3-1"><span class="toc-number">4.3.3.3.</span> <span class="toc-text">更新文档</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%A8%E9%87%8F%E6%9B%B4%E6%96%B0-1"><span class="toc-number">4.3.3.3.1.</span> <span class="toc-text">全量更新</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A2%9E%E9%87%8F%E6%9B%B4%E6%96%B0-1"><span class="toc-number">4.3.3.3.2.</span> <span class="toc-text">增量更新</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3-2"><span class="toc-number">4.3.3.4.</span> <span class="toc-text">查询文档</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8-1"><span class="toc-number">4.3.3.4.1.</span> <span class="toc-text">验证是否存在</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3-3"><span class="toc-number">4.3.3.4.2.</span> <span class="toc-text">查询文档</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%8D%E8%BF%94%E5%9B%9Esource-1"><span class="toc-number">4.3.3.4.3.</span> <span class="toc-text">不返回source</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89-1"><span class="toc-number">4.3.3.4.4.</span> <span class="toc-text">查询所有</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3-1"><span class="toc-number">4.3.3.5.</span> <span class="toc-text">删除文档</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E6%96%87%E6%A1%A3ID%E5%88%A0%E9%99%A4-1"><span class="toc-number">4.3.3.5.1.</span> <span class="toc-text">根据文档ID删除</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E6%9D%A1%E4%BB%B6%E5%88%A0%E9%99%A4-1"><span class="toc-number">4.3.3.5.2.</span> <span class="toc-text">根据条件删除</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8-1"><span class="toc-number">4.3.4.</span> <span class="toc-text">中文分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#IKAnalyzer-1"><span class="toc-number">4.3.4.1.</span> <span class="toc-text">IKAnalyzer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8IK%E5%88%86%E8%AF%8D%E5%99%A8-1"><span class="toc-number">4.3.4.2.</span> <span class="toc-text">使用IK分词器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ik-smart-1"><span class="toc-number">4.3.4.3.</span> <span class="toc-text">ik_smart</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-2"><span class="toc-number">4.3.4.3.1.</span> <span class="toc-text">使用案例</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-2"><span class="toc-number">4.3.4.3.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ik-max-word-1"><span class="toc-number">4.3.4.4.</span> <span class="toc-text">ik_max_word</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-3"><span class="toc-number">4.3.4.4.1.</span> <span class="toc-text">使用案例</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-3"><span class="toc-number">4.3.4.4.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AF%8D%E5%BA%93-1"><span class="toc-number">4.3.4.5.</span> <span class="toc-text">自定义词库</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0-1"><span class="toc-number">4.3.4.5.1.</span> <span class="toc-text">问题描述</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2"><span class="toc-number">4.3.4.6.</span> <span class="toc-text">解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%96%E8%BE%91%E5%AD%97%E5%85%B8%E5%86%85%E5%AE%B9-1"><span class="toc-number">4.3.4.6.1.</span> <span class="toc-text">编辑字典内容</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E5%AD%97%E5%85%B8-1"><span class="toc-number">4.3.4.6.2.</span> <span class="toc-text">扩展字典</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E6%B5%8B%E8%AF%95-1"><span class="toc-number">4.3.4.6.3.</span> <span class="toc-text">再次测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ES%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="toc-number">4.4.</span> <span class="toc-text">ES服务集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%B8%83%E5%B1%80-1"><span class="toc-number">4.4.1.</span> <span class="toc-text">服务布局</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C-1"><span class="toc-number">4.4.2.</span> <span class="toc-text">准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%8C%82%E8%BD%BD%E7%9B%AE%E5%BD%95-1"><span class="toc-number">4.4.2.1.</span> <span class="toc-text">创建挂载目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E6%8E%88%E6%9D%83-1"><span class="toc-number">4.4.2.2.</span> <span class="toc-text">目录授权</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9Linux%E5%8F%A5%E6%9F%84%E6%95%B0-3"><span class="toc-number">4.4.2.3.</span> <span class="toc-text">修改Linux句柄数</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E6%9C%80%E5%A4%A7%E5%8F%A5%E6%9F%84%E6%95%B0-3"><span class="toc-number">4.4.2.3.1.</span> <span class="toc-text">查看当前最大句柄数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%8F%A5%E6%9F%84%E6%95%B0-3"><span class="toc-number">4.4.2.3.2.</span> <span class="toc-text">修改句柄数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%9F%E6%95%88%E9%85%8D%E7%BD%AE-3"><span class="toc-number">4.4.2.3.3.</span> <span class="toc-text">生效配置</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%97%ADswap-2"><span class="toc-number">4.4.2.4.</span> <span class="toc-text">关闭swap</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%B4%E6%97%B6%E5%85%B3%E9%97%AD-2"><span class="toc-number">4.4.2.4.1.</span> <span class="toc-text">临时关闭</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B0%B8%E4%B9%85%E5%85%B3%E9%97%AD-2"><span class="toc-number">4.4.2.4.2.</span> <span class="toc-text">永久关闭</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%9C%80%E5%A4%A7%E7%BA%BF%E7%A8%8B%E6%95%B0-2"><span class="toc-number">4.4.2.5.</span> <span class="toc-text">修改最大线程数</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BF%AE%E6%94%B9-3"><span class="toc-number">4.4.2.5.1.</span> <span class="toc-text">配置修改</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8D%E5%90%AF%E6%9C%8D%E5%8A%A1-3"><span class="toc-number">4.4.2.5.2.</span> <span class="toc-text">重启服务</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0IK%E5%88%86%E8%AF%8D%E5%99%A8-3"><span class="toc-number">4.4.2.6.</span> <span class="toc-text">添加IK分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE-3"><span class="toc-number">4.4.2.6.1.</span> <span class="toc-text">查找</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%A7%A3%E5%8E%8B-3"><span class="toc-number">4.4.2.6.2.</span> <span class="toc-text">解压</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-1"><span class="toc-number">4.4.2.6.3.</span> <span class="toc-text">安装</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="toc-number">4.4.3.</span> <span class="toc-text">编写配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#node-1-1"><span class="toc-number">4.4.3.1.</span> <span class="toc-text">node-1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#node-2-1"><span class="toc-number">4.4.3.2.</span> <span class="toc-text">node-2</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#node-3-1"><span class="toc-number">4.4.3.3.</span> <span class="toc-text">node-3</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#kibana-2"><span class="toc-number">4.4.3.4.</span> <span class="toc-text">kibana</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E9%83%A8%E7%BD%B2%E6%96%87%E6%A1%A3-1"><span class="toc-number">4.4.4.</span> <span class="toc-text">编写部署文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-1"><span class="toc-number">4.4.5.</span> <span class="toc-text">启动服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2"><span class="toc-number">4.5.</span> <span class="toc-text">同步服务部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%B8%83%E5%B1%80-2"><span class="toc-number">4.5.1.</span> <span class="toc-text">服务布局</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C-2"><span class="toc-number">4.5.2.</span> <span class="toc-text">准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%8C%82%E8%BD%BD%E7%9B%AE%E5%BD%95-2"><span class="toc-number">4.5.2.1.</span> <span class="toc-text">创建挂载目录</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.5.3.</span> <span class="toc-text">创建配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#MySQL%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.5.3.1.</span> <span class="toc-text">MySQL配置文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Canan%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.5.3.2.</span> <span class="toc-text">Canan配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEcanal-properties"><span class="toc-number">4.5.3.2.1.</span> <span class="toc-text">配置canal.properties</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-instance-properties"><span class="toc-number">4.5.3.2.2.</span> <span class="toc-text">配置 instance.properties</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Logstash%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.5.3.3.</span> <span class="toc-text">Logstash配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-logstash-yml"><span class="toc-number">4.5.3.3.1.</span> <span class="toc-text">创建 logstash.yml</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAvillage-conf"><span class="toc-number">4.5.3.3.2.</span> <span class="toc-text">创建village.conf</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E9%83%A8%E7%BD%B2%E6%96%87%E6%A1%A3-2"><span class="toc-number">4.5.4.</span> <span class="toc-text">编写部署文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-2"><span class="toc-number">4.5.5.</span> <span class="toc-text">启动服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.6.</span> <span class="toc-text">初始化服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">4.6.1.</span> <span class="toc-text">初始化数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">4.6.1.1.</span> <span class="toc-text">检查数据库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">4.6.1.2.</span> <span class="toc-text">创建数据库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">4.6.1.3.</span> <span class="toc-text">导入数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BACanal%E7%94%A8%E6%88%B7"><span class="toc-number">4.6.1.4.</span> <span class="toc-text">创建Canal用户</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96RabbitMQ"><span class="toc-number">4.6.2.</span> <span class="toc-text">初始化RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E4%BA%A4%E6%8D%A2%E5%99%A8"><span class="toc-number">4.6.2.1.</span> <span class="toc-text">新增交换器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E7%BB%91%E5%AE%9A%E5%85%B3%E7%B3%BB"><span class="toc-number">4.6.2.2.</span> <span class="toc-text">建立绑定关系</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%98%9F%E5%88%97%E6%83%85%E5%86%B5"><span class="toc-number">4.6.2.2.1.</span> <span class="toc-text">查看队列情况</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ElasticSearch%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">4.6.3.</span> <span class="toc-text">ElasticSearch初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E6%A8%A1%E6%9D%BF"><span class="toc-number">4.6.3.1.</span> <span class="toc-text">创建索引模板</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E5%90%8C%E6%AD%A5"><span class="toc-number">4.6.4.</span> <span class="toc-text">导入数据进行同步</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KIBANA%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90"><span class="toc-number">4.7.</span> <span class="toc-text">KIBANA数据分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E7%B4%A2%E5%BC%95"><span class="toc-number">4.7.1.</span> <span class="toc-text">管理索引</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.7.1.1.</span> <span class="toc-text">创建索引模式</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%BF%9B%E5%85%A5%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="toc-number">4.7.1.1.1.</span> <span class="toc-text">进入索引管理</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E7%B4%A2%E5%BC%95"><span class="toc-number">4.7.1.1.2.</span> <span class="toc-text">查看当前索引</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E6%A8%A1%E5%BC%8F-1"><span class="toc-number">4.7.1.1.3.</span> <span class="toc-text">创建索引模式</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE"><span class="toc-number">4.7.1.2.</span> <span class="toc-text">查看索引数据</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90"><span class="toc-number">4.7.2.</span> <span class="toc-text">数据分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%B1%E7%8A%B6%E5%9B%BE%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.7.2.1.</span> <span class="toc-text">柱状图示例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%93%E5%BC%80%E4%BB%AA%E8%A1%A8%E7%9B%98"><span class="toc-number">4.7.2.1.1.</span> <span class="toc-text">打开仪表盘</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%9F%B1%E7%8A%B6%E5%9B%BE"><span class="toc-number">4.7.2.1.2.</span> <span class="toc-text">创建柱状图</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B0%B4%E5%B9%B3%E8%BD%B4%E6%95%B0%E6%8D%AE%E9%85%8D%E7%BD%AE"><span class="toc-number">4.7.2.1.3.</span> <span class="toc-text">水平轴数据配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9E%82%E7%9B%B4%E8%BD%B4%E6%95%B0%E6%8D%AE%E9%85%8D%E7%BD%AE"><span class="toc-number">4.7.2.1.4.</span> <span class="toc-text">垂直轴数据配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE"><span class="toc-number">4.7.2.1.5.</span> <span class="toc-text">查看数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AD%9B%E9%80%89%E6%95%B0%E6%8D%AE"><span class="toc-number">4.7.2.1.6.</span> <span class="toc-text">筛选数据</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%98%E7%BA%BF%E5%9B%BE%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.7.2.2.</span> <span class="toc-text">折线图示例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%8A%98%E7%BA%BF%E5%9B%BE"><span class="toc-number">4.7.2.2.1.</span> <span class="toc-text">创建折线图</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B0%B4%E5%B9%B3%E8%BD%B4%E6%95%B0%E6%8D%AE%E9%85%8D%E7%BD%AE-1"><span class="toc-number">4.7.2.2.2.</span> <span class="toc-text">水平轴数据配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9E%82%E7%9B%B4%E8%BD%B4%E6%95%B0%E6%8D%AE%E9%85%8D%E7%BD%AE-1"><span class="toc-number">4.7.2.2.3.</span> <span class="toc-text">垂直轴数据配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90-1"><span class="toc-number">4.7.2.2.4.</span> <span class="toc-text">数据分析</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%91%E7%8A%B6%E5%9B%BE%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.7.2.3.</span> <span class="toc-text">树状图示例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%A0%91%E7%8A%B6%E5%9B%BE"><span class="toc-number">4.7.2.3.1.</span> <span class="toc-text">创建树状图</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%88%86%E7%BB%84%E4%BE%9D%E6%8D%AE"><span class="toc-number">4.7.2.3.2.</span> <span class="toc-text">配置分组依据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%A4%A7%E5%B0%8F%E4%BE%9D%E6%8D%AE"><span class="toc-number">4.7.2.3.3.</span> <span class="toc-text">配置大小依据</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%9C%B0%E5%9B%BE%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.7.2.4.</span> <span class="toc-text">创建地图示例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%9C%B0%E5%9B%BE"><span class="toc-number">4.7.2.4.1.</span> <span class="toc-text">创建一个地图</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%9B%BE%E5%B1%82"><span class="toc-number">4.7.2.4.2.</span> <span class="toc-text">添加图层</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE"><span class="toc-number">4.7.2.4.3.</span> <span class="toc-text">选择文档数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%A9%E6%94%BE%E6%98%BE%E7%A4%BA%E6%95%B0%E6%8D%AE"><span class="toc-number">4.7.2.4.4.</span> <span class="toc-text">缩放显示数据</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch-%E7%B4%A2%E5%BC%95%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.</span> <span class="toc-text">ElasticSearch 索引设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-3"><span class="toc-number">5.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E8%AE%BE%E8%AE%A1%E7%9A%84%E9%87%8D%E8%A6%81%E6%80%A7"><span class="toc-number">5.1.1.</span> <span class="toc-text">索引设计的重要性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%97%B6%E9%97%B4%E7%9A%84Index%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.1.2.</span> <span class="toc-text">基于时间的Index设计</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%99%E6%A0%B7%E8%AE%BE%E8%AE%A1%E7%9A%84%E7%9B%AE%E7%9A%84"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">这样设计的目的</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E9%97%B4%E9%9A%94"><span class="toc-number">5.1.2.2.</span> <span class="toc-text">时间间隔</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%88%86%E5%89%B2"><span class="toc-number">5.1.2.3.</span> <span class="toc-text">如何实现分割</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%89%87%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.1.3.</span> <span class="toc-text">分片设计</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E5%88%86%E7%89%87%E5%A4%A7%E5%B0%8F"><span class="toc-number">5.1.3.1.</span> <span class="toc-text">限制分片大小</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%84%E4%BC%B0%E5%88%86%E7%89%87%E6%95%B0%E9%87%8F"><span class="toc-number">5.1.3.2.</span> <span class="toc-text">评估分片数量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B0%8F%E7%B4%A2%E5%BC%95%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.1.3.3.</span> <span class="toc-text">小索引设计</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%E6%A8%A1%E6%9D%BF"><span class="toc-number">5.1.4.</span> <span class="toc-text">使用索引模板</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%A8%A1%E6%9D%BF%E7%9A%84%E7%94%A8%E9%80%94"><span class="toc-number">5.1.4.1.</span> <span class="toc-text">索引模板的用途</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E6%A8%A1%E6%9D%BF-1"><span class="toc-number">5.1.4.2.</span> <span class="toc-text">创建索引模板</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E5%8F%82%E6%95%B0"><span class="toc-number">5.1.4.3.</span> <span class="toc-text">模板参数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%A0%E5%B0%84%E9%85%8D%E7%BD%AE"><span class="toc-number">5.2.</span> <span class="toc-text">映射配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%98%A0%E5%B0%84"><span class="toc-number">5.2.1.</span> <span class="toc-text">什么是映射</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A2%AB%E5%8A%A8%E5%88%9B%E5%BB%BA%EF%BC%88%E5%8A%A8%E6%80%81%E6%98%A0%E5%B0%84%EF%BC%89"><span class="toc-number">5.2.2.</span> <span class="toc-text">被动创建（动态映射）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%98%A0%E5%B0%84%E8%A7%84%E5%88%99"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">动态映射规则</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A6%81%E6%AD%A2%E5%8A%A8%E6%80%81%E6%98%A0%E5%B0%84"><span class="toc-number">5.2.2.2.</span> <span class="toc-text">禁止动态映射</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E5%8A%A8%E5%88%9B%E5%BB%BA%EF%BC%88%E6%98%BE%E7%A4%BA%E6%98%A0%E5%B0%84%EF%BC%89"><span class="toc-number">5.2.3.</span> <span class="toc-text">主动创建（显示映射）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%A0%E5%B0%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.3.</span> <span class="toc-text">映射类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C-3"><span class="toc-number">5.3.1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.3.2.</span> <span class="toc-text">字符串类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#text"><span class="toc-number">5.3.2.1.</span> <span class="toc-text">text</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#keyword"><span class="toc-number">5.3.2.2.</span> <span class="toc-text">keyword</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%A4%E8%80%85%E5%8C%BA%E5%88%AB"><span class="toc-number">5.3.2.3.</span> <span class="toc-text">两者区别</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-4"><span class="toc-number">5.3.2.4.</span> <span class="toc-text">使用案例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E5%AD%97%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.3.3.</span> <span class="toc-text">数字类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">5.3.3.1.</span> <span class="toc-text">注意事项</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E6%9C%9F%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.3.4.</span> <span class="toc-text">日期类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#JSON%E8%A1%A8%E7%A4%BA%E6%97%A5%E6%9C%9F"><span class="toc-number">5.3.4.1.</span> <span class="toc-text">JSON表示日期</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ES%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E6%97%A5%E6%9C%9F"><span class="toc-number">5.3.4.2.</span> <span class="toc-text">ES如何处理日期</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F"><span class="toc-number">5.3.4.3.</span> <span class="toc-text">默认日期格式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.3.4.4.</span> <span class="toc-text">日期格式示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%A5%E6%9C%9F%E7%B1%BB%E5%9E%8B%E5%8F%82%E6%95%B0"><span class="toc-number">5.3.4.5.</span> <span class="toc-text">日期类型参数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.3.5.</span> <span class="toc-text">布尔类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8C%83%E5%9B%B4%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.3.6.</span> <span class="toc-text">范围类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E8%8C%83%E5%9B%B4"><span class="toc-number">5.3.6.1.</span> <span class="toc-text">类型范围</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B"><span class="toc-number">5.3.6.2.</span> <span class="toc-text">使用实例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">5.4.</span> <span class="toc-text">分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">5.4.1.</span> <span class="toc-text">什么是分词器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E8%AF%8D%E5%99%A8%E6%9E%84%E6%88%90"><span class="toc-number">5.4.2.</span> <span class="toc-text">分词器构成</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#character-filter"><span class="toc-number">5.4.2.1.</span> <span class="toc-text">character filter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#tokenizer"><span class="toc-number">5.4.2.2.</span> <span class="toc-text">tokenizer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#token-filters"><span class="toc-number">5.4.2.3.</span> <span class="toc-text">token filters</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E8%AF%8D%E9%A1%BA%E5%BA%8F"><span class="toc-number">5.4.3.</span> <span class="toc-text">分词顺序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-4"><span class="toc-number">5.4.4.</span> <span class="toc-text">测试分词</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E5%88%86%E8%AF%8D"><span class="toc-number">5.4.5.</span> <span class="toc-text">什么时候分词</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E6%97%B6%E6%8C%87%E5%AE%9A%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">5.4.6.</span> <span class="toc-text">创建索引时指定分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E6%8C%87%E5%AE%9A%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">5.4.6.1.</span> <span class="toc-text">字段指定分词器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">5.4.6.2.</span> <span class="toc-text">设置默认分词器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E6%97%B6%E6%8C%87%E5%AE%9A%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">5.4.7.</span> <span class="toc-text">搜索时指定分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%87%E5%AE%9Aanalyzer"><span class="toc-number">5.4.7.1.</span> <span class="toc-text">指定analyzer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%AD%97%E6%AE%B5analyzer"><span class="toc-number">5.4.7.2.</span> <span class="toc-text">指定字段analyzer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E9%BB%98%E8%AE%A4default-seach"><span class="toc-number">5.4.7.3.</span> <span class="toc-text">指定默认default_seach</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">5.4.8.</span> <span class="toc-text">内置分词器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IK%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">5.5.</span> <span class="toc-text">IK中文分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IKAnalyzer-2"><span class="toc-number">5.5.1.</span> <span class="toc-text">IKAnalyzer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8%E7%AE%97%E6%B3%95"><span class="toc-number">5.5.2.</span> <span class="toc-text">中文分词器算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ik-smart-2"><span class="toc-number">5.5.3.</span> <span class="toc-text">ik_smart</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E5%86%85%E5%AE%B9"><span class="toc-number">5.5.3.1.</span> <span class="toc-text">原始内容</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-5"><span class="toc-number">5.5.3.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ik-max-word-2"><span class="toc-number">5.5.4.</span> <span class="toc-text">ik_max_word</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E5%86%85%E5%AE%B9-1"><span class="toc-number">5.5.4.1.</span> <span class="toc-text">原始内容</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-6"><span class="toc-number">5.5.4.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch-%E5%AD%97%E6%AE%B5%E6%98%A0%E5%B0%84"><span class="toc-number">6.</span> <span class="toc-text">ElasticSearch 字段映射</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-4"><span class="toc-number">6.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%98%A0%E5%B0%84-1"><span class="toc-number">6.1.1.</span> <span class="toc-text">什么是映射</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%98%A0%E5%B0%84%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">6.1.1.1.</span> <span class="toc-text">映射的作用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%A0%E5%B0%84%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">6.2.</span> <span class="toc-text">映射的创建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A2%AB%E5%8A%A8%E5%88%9B%E5%BB%BA%EF%BC%88%E5%8A%A8%E6%80%81%E6%98%A0%E5%B0%84%EF%BC%89-1"><span class="toc-number">6.2.1.</span> <span class="toc-text">被动创建（动态映射）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%98%A0%E5%B0%84%E8%A7%84%E5%88%99-1"><span class="toc-number">6.2.1.1.</span> <span class="toc-text">动态映射规则</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E5%8A%A8%E5%88%9B%E5%BB%BA%EF%BC%88%E6%98%BE%E7%A4%BA%E6%98%A0%E5%B0%84%EF%BC%89-1"><span class="toc-number">6.2.2.</span> <span class="toc-text">主动创建（显示映射）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%98%A0%E5%B0%84%E9%99%90%E5%88%B6"><span class="toc-number">6.2.2.1.</span> <span class="toc-text">映射限制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%A0%E5%B0%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.3.</span> <span class="toc-text">映射数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.3.1.</span> <span class="toc-text">核心类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B-1"><span class="toc-number">6.3.1.1.</span> <span class="toc-text">字符串类型</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#string"><span class="toc-number">6.3.1.1.1.</span> <span class="toc-text">string</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#text-1"><span class="toc-number">6.3.1.1.2.</span> <span class="toc-text">text</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#keyword-1"><span class="toc-number">6.3.1.1.3.</span> <span class="toc-text">keyword</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E5%AD%97%E7%B1%BB%E5%9E%8B-1"><span class="toc-number">6.3.1.2.</span> <span class="toc-text">数字类型</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9-1"><span class="toc-number">6.3.1.2.1.</span> <span class="toc-text">注意事项</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%A5%E6%9C%9F%E7%B1%BB%E5%9E%8B-1"><span class="toc-number">6.3.1.3.</span> <span class="toc-text">日期类型</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">6.3.1.3.1.</span> <span class="toc-text">日期格式示例</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F"><span class="toc-number">6.3.1.3.2.</span> <span class="toc-text">日期格式</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E7%B1%BB%E5%9E%8B-1"><span class="toc-number">6.3.1.4.</span> <span class="toc-text">布尔类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.3.1.5.</span> <span class="toc-text">二进制类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8C%83%E5%9B%B4%E7%B1%BB%E5%9E%8B-1"><span class="toc-number">6.3.1.6.</span> <span class="toc-text">范围类型</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E8%8C%83%E5%9B%B4-1"><span class="toc-number">6.3.1.6.1.</span> <span class="toc-text">类型范围</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-5"><span class="toc-number">6.3.1.6.2.</span> <span class="toc-text">使用案例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E5%90%88%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.3.2.</span> <span class="toc-text">复合类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.3.2.1.</span> <span class="toc-text">数组类型</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-2"><span class="toc-number">6.3.2.1.1.</span> <span class="toc-text">使用示例</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B%EF%BC%88object%EF%BC%89"><span class="toc-number">6.3.2.2.</span> <span class="toc-text">对象类型（object）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-6"><span class="toc-number">6.3.2.2.1.</span> <span class="toc-text">使用案例</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B5%8C%E5%A5%97%E7%B1%BB%E5%9E%8B%EF%BC%88nested%EF%BC%89"><span class="toc-number">6.3.2.3.</span> <span class="toc-text">嵌套类型（nested）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-3"><span class="toc-number">6.3.2.3.1.</span> <span class="toc-text">使用示例</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">6.3.2.3.2.</span> <span class="toc-text">优缺点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%B0%E7%90%86%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.3.3.</span> <span class="toc-text">地理类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#geo-point"><span class="toc-number">6.3.3.1.</span> <span class="toc-text">geo_point</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-1"><span class="toc-number">6.3.3.1.1.</span> <span class="toc-text">使用场景</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.3.3.1.2.</span> <span class="toc-text">定义类型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-7"><span class="toc-number">6.3.3.1.3.</span> <span class="toc-text">使用案例</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%B9%E5%BC%8F"><span class="toc-number">6.3.3.1.4.</span> <span class="toc-text">查询方式</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E5%8F%82%E6%95%B0"><span class="toc-number">6.3.3.1.5.</span> <span class="toc-text">字段参数</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#geo-shape"><span class="toc-number">6.3.3.2.</span> <span class="toc-text">geo_shape</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#GeoJson%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">6.3.3.2.1.</span> <span class="toc-text">GeoJson是什么</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B-1"><span class="toc-number">6.3.3.2.2.</span> <span class="toc-text">定义类型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%95%B0%E6%8D%AE"><span class="toc-number">6.3.3.2.3.</span> <span class="toc-text">添加数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.3.4.</span> <span class="toc-text">特殊类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ip%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.3.4.1.</span> <span class="toc-text">ip类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#token-count"><span class="toc-number">6.3.4.2.</span> <span class="toc-text">token_count</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%A0%E5%B0%84%E7%9A%84%E5%85%83%E4%BF%A1%E6%81%AF"><span class="toc-number">6.4.</span> <span class="toc-text">映射的元信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E7%89%B9%E5%BE%81%E5%85%83%E4%BF%A1%E6%81%AF"><span class="toc-number">6.4.1.</span> <span class="toc-text">文档特征元信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E6%BA%90%E5%85%83%E4%BF%A1%E6%81%AF"><span class="toc-number">6.4.2.</span> <span class="toc-text">文档数据源元信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%8E%9F%E4%BF%A1%E6%81%AF"><span class="toc-number">6.4.3.</span> <span class="toc-text">索引原信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%8E%9F%E4%BF%A1%E6%81%AF"><span class="toc-number">6.4.4.</span> <span class="toc-text">路由原信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%83%E4%BF%A1%E6%81%AF"><span class="toc-number">6.4.5.</span> <span class="toc-text">自定义元信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%A0%E5%B0%84%E5%8F%82%E6%95%B0"><span class="toc-number">6.5.</span> <span class="toc-text">映射参数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#analyzer"><span class="toc-number">6.5.0.1.</span> <span class="toc-text">analyzer</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%8B%B1%E6%96%87%E5%88%86%E8%AF%8D"><span class="toc-number">6.5.0.1.1.</span> <span class="toc-text">英文分词</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D"><span class="toc-number">6.5.0.1.2.</span> <span class="toc-text">中文分词</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8IK%E5%88%86%E8%AF%8D%E5%99%A8-2"><span class="toc-number">6.5.0.1.3.</span> <span class="toc-text">使用IK分词器</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#search-analyzer"><span class="toc-number">6.5.0.2.</span> <span class="toc-text">search_analyzer</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%9C%BA%E6%99%AF"><span class="toc-number">6.5.0.2.1.</span> <span class="toc-text">查询场景</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%A4%B1%E8%B4%A5%E5%8E%9F%E5%9B%A0"><span class="toc-number">6.5.0.2.2.</span> <span class="toc-text">查询失败原因</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%99%A8%E5%88%86%E6%9E%90"><span class="toc-number">6.5.0.2.3.</span> <span class="toc-text">解析器分析</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%9F%A5%E8%AF%A2%E8%A7%A3%E6%9E%90"><span class="toc-number">6.5.0.2.4.</span> <span class="toc-text">配置查询解析</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#search-quote-analyzer"><span class="toc-number">6.5.0.3.</span> <span class="toc-text">search_quote_analyzer</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%A6%81%E7%94%A8%E5%81%9C%E7%94%A8%E8%AF%8D"><span class="toc-number">6.5.0.3.1.</span> <span class="toc-text">禁用停用词</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%96%87%E6%A1%A3"><span class="toc-number">6.5.0.3.2.</span> <span class="toc-text">添加文档</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%9D%9E%E7%9F%AD%E8%AF%AD%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.5.0.3.3.</span> <span class="toc-text">非短语查询</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%9F%AD%E8%AF%AD%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.5.0.3.4.</span> <span class="toc-text">短语查询</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#normalizer"><span class="toc-number">6.5.0.4.</span> <span class="toc-text">normalizer</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3"><span class="toc-number">6.5.0.4.1.</span> <span class="toc-text">创建文档</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.5.0.4.2.</span> <span class="toc-text">文档查询</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#coerce"><span class="toc-number">6.5.0.5.</span> <span class="toc-text">coerce</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-2"><span class="toc-number">6.5.0.5.1.</span> <span class="toc-text">使用场景</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%8D%E8%BF%9B%E8%A1%8C%E8%BF%87%E6%BB%A4"><span class="toc-number">6.5.0.5.2.</span> <span class="toc-text">不进行过滤</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E6%96%87%E6%A1%A3"><span class="toc-number">6.5.0.5.3.</span> <span class="toc-text">过滤文档</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#to"><span class="toc-number">6.5.0.6.</span> <span class="toc-text">_to</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3-1"><span class="toc-number">6.5.0.6.1.</span> <span class="toc-text">创建文档</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3-4"><span class="toc-number">6.5.0.6.2.</span> <span class="toc-text">查询文档</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#doc-values-%E5%92%8C-fielddata"><span class="toc-number">6.5.0.7.</span> <span class="toc-text">doc_values 和 fielddata</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%A4%E8%80%85%E5%8C%BA%E5%88%AB-1"><span class="toc-number">6.5.0.7.1.</span> <span class="toc-text">两者区别</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F%E6%95%88%E6%9E%9C"><span class="toc-number">6.5.0.7.2.</span> <span class="toc-text">排序效果</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#enabled"><span class="toc-number">6.5.0.8.</span> <span class="toc-text">enabled</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3-2"><span class="toc-number">6.5.0.8.1.</span> <span class="toc-text">创建文档</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E6%90%9C%E7%B4%A2"><span class="toc-number">6.5.0.8.2.</span> <span class="toc-text">文档搜索</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#format"><span class="toc-number">6.5.0.9.</span> <span class="toc-text">format</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3-3"><span class="toc-number">6.5.0.9.1.</span> <span class="toc-text">创建文档</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ignore-above"><span class="toc-number">6.5.0.10.</span> <span class="toc-text">ignore_above</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3-4"><span class="toc-number">6.5.0.10.1.</span> <span class="toc-text">创建文档</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3-5"><span class="toc-number">6.5.0.10.2.</span> <span class="toc-text">查询文档</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ignore-malformed"><span class="toc-number">6.5.0.11.</span> <span class="toc-text">ignore_malformed</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3-5"><span class="toc-number">6.5.0.11.1.</span> <span class="toc-text">创建文档</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#index"><span class="toc-number">6.5.0.12.</span> <span class="toc-text">index</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3-6"><span class="toc-number">6.5.0.12.1.</span> <span class="toc-text">创建文档</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.5.0.12.2.</span> <span class="toc-text">查询</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#null-value"><span class="toc-number">6.5.0.13.</span> <span class="toc-text">null_value</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3-7"><span class="toc-number">6.5.0.13.1.</span> <span class="toc-text">创建文档</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E6%96%87%E6%A1%A3"><span class="toc-number">6.5.0.13.2.</span> <span class="toc-text">搜索文档</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#position-increment-gap"><span class="toc-number">6.5.0.14.</span> <span class="toc-text">position_increment_gap</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E6%96%B9%E5%BC%8F%E8%BF%9B%E8%A1%8C%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.5.0.14.1.</span> <span class="toc-text">默认方式进行查询</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#position-increment-gap%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.5.0.14.2.</span> <span class="toc-text">position_increment_gap查询</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#properties"><span class="toc-number">6.5.0.15.</span> <span class="toc-text">properties</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">6.5.0.15.1.</span> <span class="toc-text">使用方式</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3-8"><span class="toc-number">6.5.0.15.2.</span> <span class="toc-text">创建文档</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#fields"><span class="toc-number">6.5.0.16.</span> <span class="toc-text">fields</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3-9"><span class="toc-number">6.5.0.16.1.</span> <span class="toc-text">创建文档</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="toc-number">6.5.0.16.2.</span> <span class="toc-text">全文检索</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E5%AD%97%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.5.0.16.3.</span> <span class="toc-text">关键字查询</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9B%B4%E5%A4%9A%E5%AD%97%E6%AE%B5"><span class="toc-number">6.5.0.17.</span> <span class="toc-text">更多字段</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#index-options"><span class="toc-number">6.5.0.17.1.</span> <span class="toc-text">index_options</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#norms"><span class="toc-number">6.5.0.17.2.</span> <span class="toc-text">norms</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#similarity"><span class="toc-number">6.5.0.17.3.</span> <span class="toc-text">similarity</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#store"><span class="toc-number">6.5.0.17.4.</span> <span class="toc-text">store</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#term-vectors"><span class="toc-number">6.5.0.17.5.</span> <span class="toc-text">term_vectors</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch-%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">7.</span> <span class="toc-text">ElasticSearch 分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-5"><span class="toc-number">7.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E8%AF%8D%E5%99%A8-1"><span class="toc-number">7.1.1.</span> <span class="toc-text">什么是分词器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E8%AF%8D%E5%99%A8%E7%9A%84%E6%9E%84%E6%88%90"><span class="toc-number">7.1.2.</span> <span class="toc-text">分词器的构成</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%84%E6%88%90%E9%83%A8%E5%88%86"><span class="toc-number">7.1.2.1.</span> <span class="toc-text">组成部分</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#character-filter-1"><span class="toc-number">7.1.2.1.1.</span> <span class="toc-text">character filter</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#tokenizer-1"><span class="toc-number">7.1.2.1.2.</span> <span class="toc-text">tokenizer</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#token-filters-1"><span class="toc-number">7.1.2.1.3.</span> <span class="toc-text">token filters</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E8%AF%8D%E9%A1%BA%E5%BA%8F-1"><span class="toc-number">7.1.2.2.</span> <span class="toc-text">分词顺序</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%92%8C%E6%90%9C%E7%B4%A2%E5%88%86%E8%AF%8D"><span class="toc-number">7.1.2.3.</span> <span class="toc-text">索引和搜索分词</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">7.1.2.4.</span> <span class="toc-text">配置分词器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E8%AF%8D%E5%99%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">7.1.2.5.</span> <span class="toc-text">分词器测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">7.1.3.</span> <span class="toc-text">指定分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%B0%E6%96%B9"><span class="toc-number">7.1.3.1.</span> <span class="toc-text">使用地方</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E6%97%B6%E6%8C%87%E5%AE%9A%E5%88%86%E8%AF%8D%E5%99%A8-1"><span class="toc-number">7.1.3.2.</span> <span class="toc-text">创建索引时指定分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E6%8C%87%E5%AE%9A%E5%88%86%E8%AF%8D%E5%99%A8-1"><span class="toc-number">7.1.3.2.1.</span> <span class="toc-text">字段指定分词器</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E5%88%86%E8%AF%8D%E5%99%A8-1"><span class="toc-number">7.1.3.2.2.</span> <span class="toc-text">设置默认分词器</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E6%97%B6%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9A%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">7.1.3.3.</span> <span class="toc-text">搜索时如何确定分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8C%87%E5%AE%9Aanalyzer-1"><span class="toc-number">7.1.3.3.1.</span> <span class="toc-text">指定analyzer</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%AD%97%E6%AE%B5analyzer-1"><span class="toc-number">7.1.3.3.2.</span> <span class="toc-text">指定字段analyzer</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E9%BB%98%E8%AE%A4default-seach-1"><span class="toc-number">7.1.3.3.3.</span> <span class="toc-text">指定默认default_seach</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E5%88%86%E8%AF%8D%E5%99%A8-1"><span class="toc-number">7.1.4.</span> <span class="toc-text">内置分词器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E6%96%87%E6%89%A9%E5%B1%95%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">7.1.5.</span> <span class="toc-text">中文扩展分析器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%8D%E8%AF%AD%E5%88%86%E8%AF%8D"><span class="toc-number">7.2.</span> <span class="toc-text">词语分词</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%87%E5%87%86%E5%88%86%E8%AF%8D%E5%99%A8%EF%BC%88Standard-Tokenizer%EF%BC%89"><span class="toc-number">7.2.1.</span> <span class="toc-text">标准分词器（Standard Tokenizer）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-8"><span class="toc-number">7.2.1.1.</span> <span class="toc-text">使用案例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E5%86%85%E5%AE%B9-2"><span class="toc-number">7.2.1.1.1.</span> <span class="toc-text">原始内容</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-7"><span class="toc-number">7.2.1.1.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E9%85%8D%E7%BD%AE%E9%A1%B9"><span class="toc-number">7.2.1.2.</span> <span class="toc-text">可配置项</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%88%86%E8%AF%8D%E5%99%A8%EF%BC%88Letter-Tokenizer%EF%BC%89"><span class="toc-number">7.2.2.</span> <span class="toc-text">简单分词器（Letter Tokenizer）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-9"><span class="toc-number">7.2.2.1.</span> <span class="toc-text">使用案例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E5%86%85%E5%AE%B9-3"><span class="toc-number">7.2.2.1.1.</span> <span class="toc-text">原始内容</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-8"><span class="toc-number">7.2.2.1.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A9%BA%E7%99%BD%E5%88%86%E8%AF%8D%E5%99%A8%EF%BC%88Whitespace-Tokenizer%EF%BC%89"><span class="toc-number">7.2.3.</span> <span class="toc-text">空白分词器（Whitespace Tokenizer）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-10"><span class="toc-number">7.2.3.1.</span> <span class="toc-text">使用案例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E5%86%85%E5%AE%B9-4"><span class="toc-number">7.2.3.1.1.</span> <span class="toc-text">原始内容</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-9"><span class="toc-number">7.2.3.1.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%B5%E5%AD%90%E9%82%AE%E4%BB%B6%E5%88%86%E8%AF%8D%E5%99%A8%EF%BC%88UAX-URL-Email-Tokenizer%EF%BC%89"><span class="toc-number">7.2.4.</span> <span class="toc-text">电子邮件分词器（UAX URL Email Tokenizer）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-11"><span class="toc-number">7.2.4.1.</span> <span class="toc-text">使用案例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E5%86%85%E5%AE%B9-5"><span class="toc-number">7.2.4.1.1.</span> <span class="toc-text">原始内容</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-10"><span class="toc-number">7.2.4.1.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E9%85%8D%E7%BD%AE%E9%A1%B9-1"><span class="toc-number">7.2.4.2.</span> <span class="toc-text">可配置项</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%8F%E5%85%B8%E5%88%86%E8%AF%8D%E5%99%A8%EF%BC%88Classic-Tokenizer%EF%BC%89"><span class="toc-number">7.2.5.</span> <span class="toc-text">经典分词器（Classic Tokenizer）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-number">7.2.5.1.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-12"><span class="toc-number">7.2.5.2.</span> <span class="toc-text">使用案例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E5%86%85%E5%AE%B9-6"><span class="toc-number">7.2.5.2.1.</span> <span class="toc-text">原始内容</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-11"><span class="toc-number">7.2.5.2.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E9%85%8D%E7%BD%AE%E9%A1%B9-2"><span class="toc-number">7.2.5.3.</span> <span class="toc-text">可配置项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%8C%96%E6%96%87%E6%9C%AC%E5%88%86%E8%AF%8D"><span class="toc-number">7.3.</span> <span class="toc-text">结构化文本分词</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E8%AF%8D%E5%88%86%E8%AF%8D%E5%99%A8%EF%BC%88Keyword-Tokenizer%EF%BC%89"><span class="toc-number">7.3.1.</span> <span class="toc-text">关键词分词器（Keyword Tokenizer）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-13"><span class="toc-number">7.3.1.1.</span> <span class="toc-text">使用案例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E5%86%85%E5%AE%B9-7"><span class="toc-number">7.3.1.1.1.</span> <span class="toc-text">原始内容</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-12"><span class="toc-number">7.3.1.1.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A3%E5%88%99%E5%88%86%E8%AF%8D%E5%99%A8%EF%BC%88Pattern-Tokenizer%EF%BC%89"><span class="toc-number">7.3.2.</span> <span class="toc-text">正则分词器（Pattern Tokenizer）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-14"><span class="toc-number">7.3.2.1.</span> <span class="toc-text">使用案例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E5%86%85%E5%AE%B9-8"><span class="toc-number">7.3.2.1.1.</span> <span class="toc-text">原始内容</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-13"><span class="toc-number">7.3.2.1.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E9%85%8D%E7%BD%AE%E9%A1%B9-3"><span class="toc-number">7.3.2.2.</span> <span class="toc-text">可配置项</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E5%BE%84%E5%88%86%E8%AF%8D%E5%99%A8%EF%BC%88Path-Tokenizer%EF%BC%89"><span class="toc-number">7.3.3.</span> <span class="toc-text">路径分词器（Path Tokenizer）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-15"><span class="toc-number">7.3.3.1.</span> <span class="toc-text">使用案例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E5%86%85%E5%AE%B9-9"><span class="toc-number">7.3.3.1.1.</span> <span class="toc-text">原始内容</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-14"><span class="toc-number">7.3.3.1.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E9%85%8D%E7%BD%AE%E9%A1%B9-4"><span class="toc-number">7.3.3.2.</span> <span class="toc-text">可配置项</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%AD%E8%A8%80%E5%88%86%E8%AF%8D%EF%BC%88Language-Analyzer%EF%BC%89"><span class="toc-number">7.3.4.</span> <span class="toc-text">语言分词（Language Analyzer）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%AF%E6%8C%81%E8%AF%AD%E7%A7%8D"><span class="toc-number">7.3.5.</span> <span class="toc-text">支持语种</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-16"><span class="toc-number">7.3.5.1.</span> <span class="toc-text">使用案例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E5%86%85%E5%AE%B9-10"><span class="toc-number">7.3.5.1.1.</span> <span class="toc-text">原始内容</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-15"><span class="toc-number">7.3.5.1.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">7.3.6.</span> <span class="toc-text">自定义分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="toc-number">7.3.6.1.</span> <span class="toc-text">配置参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95-2"><span class="toc-number">7.3.6.2.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-17"><span class="toc-number">7.3.6.3.</span> <span class="toc-text">使用案例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E5%86%85%E5%AE%B9-11"><span class="toc-number">7.3.6.3.1.</span> <span class="toc-text">原始内容</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-16"><span class="toc-number">7.3.6.3.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8-2"><span class="toc-number">7.4.</span> <span class="toc-text">中文分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IKAnalyzer-3"><span class="toc-number">7.4.1.</span> <span class="toc-text">IKAnalyzer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8IK%E5%88%86%E8%AF%8D%E5%99%A8-3"><span class="toc-number">7.4.2.</span> <span class="toc-text">使用IK分词器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ik-smart-3"><span class="toc-number">7.4.3.</span> <span class="toc-text">ik_smart</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-18"><span class="toc-number">7.4.3.1.</span> <span class="toc-text">使用案例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E5%86%85%E5%AE%B9-12"><span class="toc-number">7.4.3.1.1.</span> <span class="toc-text">原始内容</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-17"><span class="toc-number">7.4.3.1.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ik-max-word-3"><span class="toc-number">7.4.4.</span> <span class="toc-text">ik_max_word</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B-19"><span class="toc-number">7.4.4.1.</span> <span class="toc-text">使用案例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E5%86%85%E5%AE%B9-13"><span class="toc-number">7.4.4.1.1.</span> <span class="toc-text">原始内容</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D-18"><span class="toc-number">7.4.4.1.2.</span> <span class="toc-text">测试分词</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AF%8D%E5%BA%93-2"><span class="toc-number">7.4.5.</span> <span class="toc-text">自定义词库</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0-2"><span class="toc-number">7.4.5.1.</span> <span class="toc-text">问题描述</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-3"><span class="toc-number">7.4.5.2.</span> <span class="toc-text">解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%96%E8%BE%91%E5%AD%97%E5%85%B8%E5%86%85%E5%AE%B9-2"><span class="toc-number">7.4.5.2.1.</span> <span class="toc-text">编辑字典内容</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E5%AD%97%E5%85%B8-2"><span class="toc-number">7.4.5.2.2.</span> <span class="toc-text">扩展字典</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E6%B5%8B%E8%AF%95-2"><span class="toc-number">7.4.5.2.3.</span> <span class="toc-text">再次测试</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch-%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E6%A1%A3"><span class="toc-number">8.</span> <span class="toc-text">ElasticSearch 分布式文档</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E6%A1%A3%E5%8E%9F%E7%90%86"><span class="toc-number">8.1.</span> <span class="toc-text">分布式文档原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E8%B7%AF%E7%94%B1%E8%AE%A1%E7%AE%97"><span class="toc-number">8.1.1.</span> <span class="toc-text">索引的路由计算</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9-2"><span class="toc-number">8.1.1.1.</span> <span class="toc-text">注意事项</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E7%9A%84%E5%86%99%E6%93%8D%E4%BD%9C"><span class="toc-number">8.1.2.</span> <span class="toc-text">文档的写操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4"><span class="toc-number">8.1.2.1.</span> <span class="toc-text">详细步骤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9-3"><span class="toc-number">8.1.2.2.</span> <span class="toc-text">注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E9%AA%8C%E8%AF%81"><span class="toc-number">8.1.2.2.1.</span> <span class="toc-text">实验验证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E6%96%87%E6%A1%A3-%E5%8D%95%E4%B8%AA"><span class="toc-number">8.1.3.</span> <span class="toc-text">搜索文档(单个)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4-1"><span class="toc-number">8.1.3.1.</span> <span class="toc-text">详细步骤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9-4"><span class="toc-number">8.1.3.2.</span> <span class="toc-text">注意事项</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3-%E5%8D%95%E4%B8%AA"><span class="toc-number">8.1.4.</span> <span class="toc-text">更新文档(单个)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4-2"><span class="toc-number">8.1.4.1.</span> <span class="toc-text">详细步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E5%A4%8D%E5%88%B6"><span class="toc-number">8.1.4.1.1.</span> <span class="toc-text">文档复制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2-1"><span class="toc-number">8.1.5.</span> <span class="toc-text">全文搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%EF%BC%88query%EF%BC%89"><span class="toc-number">8.1.5.1.</span> <span class="toc-text">搜索（query）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4-3"><span class="toc-number">8.1.5.1.1.</span> <span class="toc-text">详细步骤</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E4%BC%98%E5%85%88%E7%BA%A7%E9%98%9F%E5%88%97"><span class="toc-number">8.1.5.1.2.</span> <span class="toc-text">什么是优先级队列</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9-5"><span class="toc-number">8.1.5.1.3.</span> <span class="toc-text">注意事项</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%96%E5%9B%9E%EF%BC%88fetch%EF%BC%89"><span class="toc-number">8.1.5.2.</span> <span class="toc-text">取回（fetch）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4-4"><span class="toc-number">8.1.5.2.1.</span> <span class="toc-text">详细步骤</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9-6"><span class="toc-number">8.1.5.2.2.</span> <span class="toc-text">注意事项</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E6%9C%BA%E5%88%B6"><span class="toc-number">8.2.</span> <span class="toc-text">路由机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E8%B7%AF%E7%94%B1"><span class="toc-number">8.2.1.</span> <span class="toc-text">为什么使用路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.2.2.</span> <span class="toc-text">路由查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.2.2.1.</span> <span class="toc-text">普通查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E6%9F%A5%E8%AF%A2-1"><span class="toc-number">8.2.2.2.</span> <span class="toc-text">路由查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B7%AF%E7%94%B1-%E6%8B%93%E5%B1%95"><span class="toc-number">8.2.3.</span> <span class="toc-text">自定义路由(拓展)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95-3"><span class="toc-number">8.2.3.1.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87"><span class="toc-number">8.2.3.2.</span> <span class="toc-text">查看分片</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">8.2.3.3.</span> <span class="toc-text">插入数据</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E7%AC%AC%E4%B8%80%E6%9D%A1%E6%95%B0%E6%8D%AE"><span class="toc-number">8.2.3.3.1.</span> <span class="toc-text">插入第一条数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87-1"><span class="toc-number">8.2.3.3.2.</span> <span class="toc-text">查看分片</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E7%AC%AC%E4%BA%8C%E6%9D%A1%E6%95%B0%E6%8D%AE"><span class="toc-number">8.2.3.3.3.</span> <span class="toc-text">插入第二条数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87-2"><span class="toc-number">8.2.3.3.4.</span> <span class="toc-text">查看分片</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE"><span class="toc-number">8.2.3.4.</span> <span class="toc-text">查询数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E8%B7%AF%E7%94%B1"><span class="toc-number">8.2.3.5.</span> <span class="toc-text">指定路由</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E7%AC%AC%E4%B8%89%E6%9D%A1%E6%95%B0%E6%8D%AE"><span class="toc-number">8.2.3.5.1.</span> <span class="toc-text">插入第三条数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87-3"><span class="toc-number">8.2.3.5.2.</span> <span class="toc-text">查看分片</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE"><span class="toc-number">8.2.3.5.3.</span> <span class="toc-text">查询索引数据</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E8%B7%AF%E7%94%B1%E6%8F%92%E5%85%A5"><span class="toc-number">8.2.3.6.</span> <span class="toc-text">指定路由插入</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">8.2.3.6.1.</span> <span class="toc-text">再次插入数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87-4"><span class="toc-number">8.2.3.6.2.</span> <span class="toc-text">查看分片</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-1"><span class="toc-number">8.2.3.6.3.</span> <span class="toc-text">查询数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE-1"><span class="toc-number">8.2.3.6.4.</span> <span class="toc-text">再次插入数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87%E4%BF%A1%E6%81%AF"><span class="toc-number">8.2.3.6.5.</span> <span class="toc-text">查看分片信息</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-2"><span class="toc-number">8.2.3.6.6.</span> <span class="toc-text">查询数据</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">8.2.3.7.</span> <span class="toc-text">路由带来的问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%88%AB%E5%90%8D"><span class="toc-number">8.3.</span> <span class="toc-text">索引别名</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%AB%E5%90%8D%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">8.3.1.</span> <span class="toc-text">别名的作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%AB%E5%90%8D%E6%93%8D%E4%BD%9C"><span class="toc-number">8.3.2.</span> <span class="toc-text">别名操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%88%AB%E5%90%8D"><span class="toc-number">8.3.2.1.</span> <span class="toc-text">查询别名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%AB%E5%90%8D%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.3.2.2.</span> <span class="toc-text">别名查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%88%AB%E5%90%8D"><span class="toc-number">8.3.2.3.</span> <span class="toc-text">创建别名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%AB%E5%90%8D%E4%BF%AE%E6%94%B9"><span class="toc-number">8.3.2.4.</span> <span class="toc-text">别名修改</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8%E5%88%AB%E5%90%8D"><span class="toc-number">8.3.3.</span> <span class="toc-text">过滤器别名</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%88%AB%E5%90%8D-1"><span class="toc-number">8.3.3.1.</span> <span class="toc-text">创建别名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2"><span class="toc-number">8.3.3.2.</span> <span class="toc-text">数据查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%88%AB%E5%90%8D"><span class="toc-number">8.3.4.</span> <span class="toc-text">路由别名</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%88%AB%E5%90%8D-2"><span class="toc-number">8.3.4.1.</span> <span class="toc-text">创建别名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2-1"><span class="toc-number">8.3.4.2.</span> <span class="toc-text">数据查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%88%AB%E5%90%8D"><span class="toc-number">8.3.5.</span> <span class="toc-text">删除别名</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E5%88%AB%E5%90%8D"><span class="toc-number">8.3.5.1.</span> <span class="toc-text">查看所有别名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%88%AB%E5%90%8D-1"><span class="toc-number">8.3.5.2.</span> <span class="toc-text">删除别名</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-number">8.3.6.</span> <span class="toc-text">重建索引</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E9%87%8D%E5%BB%BA%E7%9A%84%E6%AD%A5%E9%AA%A4"><span class="toc-number">8.3.6.1.</span> <span class="toc-text">索引重建的步骤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%97%A7%E7%B4%A2%E5%BC%95"><span class="toc-number">8.3.6.2.</span> <span class="toc-text">创建旧索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%95%B0%E6%8D%AE-1"><span class="toc-number">8.3.6.3.</span> <span class="toc-text">添加数据</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-3"><span class="toc-number">8.3.6.3.1.</span> <span class="toc-text">查询数据</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%88%AB%E5%90%8D-3"><span class="toc-number">8.3.6.4.</span> <span class="toc-text">创建别名</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-4"><span class="toc-number">8.3.6.4.1.</span> <span class="toc-text">查询数据</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%B0%E7%B4%A2%E5%BC%95"><span class="toc-number">8.3.6.5.</span> <span class="toc-text">创建新索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E5%BB%BA%E7%B4%A2%E5%BC%95-1"><span class="toc-number">8.3.6.6.</span> <span class="toc-text">重建索引</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9B%B4%E5%A4%9A%E5%8F%82%E6%95%B0"><span class="toc-number">8.3.6.6.1.</span> <span class="toc-text">更多参数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E4%BB%BB%E5%8A%A1"><span class="toc-number">8.3.6.6.2.</span> <span class="toc-text">查看任务</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8F%96%E6%B6%88%E4%BB%BB%E5%8A%A1"><span class="toc-number">8.3.6.6.3.</span> <span class="toc-text">取消任务</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%AB%E5%90%8D%E5%88%87%E6%8D%A2"><span class="toc-number">8.3.6.7.</span> <span class="toc-text">别名切换</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%97%A7%E7%9A%84%E7%B4%A2%E5%BC%95"><span class="toc-number">8.3.6.8.</span> <span class="toc-text">删除旧的索引</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-5"><span class="toc-number">8.3.6.8.1.</span> <span class="toc-text">查询数据</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86"><span class="toc-number">9.</span> <span class="toc-text">ElasticSearch 集群管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F"><span class="toc-number">9.1.</span> <span class="toc-text">集群模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E8%A7%92%E8%89%B2%E8%AF%B4%E6%98%8E"><span class="toc-number">9.1.1.</span> <span class="toc-text">节点角色说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E8%8A%82%E7%82%B9"><span class="toc-number">9.1.2.</span> <span class="toc-text">单节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">9.1.3.</span> <span class="toc-text">基本高可用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%AE%A1%E7%90%86%E5%88%86%E7%A6%BB"><span class="toc-number">9.1.4.</span> <span class="toc-text">数据与管理分离</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%B8%8E%E5%8D%8F%E8%B0%83%E5%88%86%E7%A6%BB"><span class="toc-number">9.1.5.</span> <span class="toc-text">数据与协调分离</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%8F%E8%B0%83%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">9.1.6.</span> <span class="toc-text">协调读写分离</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%8A%82%E7%82%B9%E6%A0%87%E7%AD%BE"><span class="toc-number">9.1.7.</span> <span class="toc-text">数据节点标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E5%89%AF%E5%88%86%E7%89%87%E5%88%86%E7%A6%BB"><span class="toc-number">9.1.8.</span> <span class="toc-text">主副分片分离</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%A8%E9%9B%86%E7%BE%A4%E6%93%8D%E4%BD%9C"><span class="toc-number">9.1.9.</span> <span class="toc-text">跨集群操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%A8%E9%9B%86%E7%BE%A4%E7%89%88%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">9.1.10.</span> <span class="toc-text">跨集群版本操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86"><span class="toc-number">9.2.</span> <span class="toc-text">集群管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">9.2.1.</span> <span class="toc-text">集群健康检查</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-number">9.2.1.1.</span> <span class="toc-text">查看集群状态</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-number">9.2.1.1.1.</span> <span class="toc-text">集群状态</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%89%87%E5%92%8C%E5%89%AF%E6%9C%AC"><span class="toc-number">9.2.2.</span> <span class="toc-text">分片和副本</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E7%89%87"><span class="toc-number">9.2.2.1.</span> <span class="toc-text">什么是分片</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%86%E7%89%87%E7%9A%84%E6%84%8F%E4%B9%89"><span class="toc-number">9.2.2.1.1.</span> <span class="toc-text">分片的意义</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%86%E7%89%87%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="toc-number">9.2.2.1.2.</span> <span class="toc-text">分片的本质</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%89%AF%E6%9C%AC"><span class="toc-number">9.2.2.2.</span> <span class="toc-text">什么是副本</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E7%9A%84%E6%84%8F%E4%B9%89"><span class="toc-number">9.2.2.2.1.</span> <span class="toc-text">副本的意义</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E7%89%87%E5%92%8C%E5%89%AF%E6%9C%AC%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">9.2.2.3.</span> <span class="toc-text">分片和副本的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%86%E7%89%87"><span class="toc-number">9.2.2.3.1.</span> <span class="toc-text">分片</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC"><span class="toc-number">9.2.2.3.2.</span> <span class="toc-text">副本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%89%87%E9%AA%8C%E8%AF%81"><span class="toc-number">9.2.3.</span> <span class="toc-text">分片验证</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E4%B8%80%E4%B8%AA%E5%88%86%E7%89%87"><span class="toc-number">9.2.3.1.</span> <span class="toc-text">验证一个分片</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95-4"><span class="toc-number">9.2.3.1.1.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87-5"><span class="toc-number">9.2.3.1.2.</span> <span class="toc-text">查看分片</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E4%B8%A4%E4%B8%AA%E5%88%86%E7%89%87"><span class="toc-number">9.2.3.2.</span> <span class="toc-text">验证两个分片</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95-5"><span class="toc-number">9.2.3.2.1.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87-6"><span class="toc-number">9.2.3.2.2.</span> <span class="toc-text">查看分片</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%9B%9B%E4%B8%AA%E5%88%86%E7%89%87"><span class="toc-number">9.2.3.3.</span> <span class="toc-text">验证四个分片</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95-6"><span class="toc-number">9.2.3.3.1.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87-7"><span class="toc-number">9.2.3.3.2.</span> <span class="toc-text">查看分片</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%89%AF%E6%9C%AC"><span class="toc-number">9.2.4.</span> <span class="toc-text">验证副本</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E4%B8%A4%E5%89%AF%E6%9C%AC%E5%88%86%E7%89%87"><span class="toc-number">9.2.4.1.</span> <span class="toc-text">验证两副本分片</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95-7"><span class="toc-number">9.2.4.1.1.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95-2"><span class="toc-number">9.2.4.1.2.</span> <span class="toc-text">查看索引</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E4%B8%89%E5%89%AF%E6%9C%AC%E5%88%86%E7%89%87"><span class="toc-number">9.2.4.2.</span> <span class="toc-text">验证三副本分片</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95-8"><span class="toc-number">9.2.4.2.1.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95-3"><span class="toc-number">9.2.4.2.2.</span> <span class="toc-text">查看索引</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%89%87%E4%B8%8E%E5%89%AF%E6%9C%AC%E7%9A%84%E7%BB%84%E5%90%88"><span class="toc-number">9.2.5.</span> <span class="toc-text">分片与副本的组合</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E7%BB%84%E5%90%88"><span class="toc-number">9.2.5.1.</span> <span class="toc-text">默认组合</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95-9"><span class="toc-number">9.2.5.1.1.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95-4"><span class="toc-number">9.2.5.1.2.</span> <span class="toc-text">查看索引</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%A4%E5%89%AF%E6%9C%AC%E4%B8%A4%E5%88%86%E7%89%87"><span class="toc-number">9.2.5.2.</span> <span class="toc-text">两副本两分片</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95-10"><span class="toc-number">9.2.5.2.1.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95-5"><span class="toc-number">9.2.5.2.2.</span> <span class="toc-text">查看索引</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%89%E5%88%86%E7%89%87%E4%B8%A4%E5%89%AF%E6%9C%AC"><span class="toc-number">9.2.5.3.</span> <span class="toc-text">三分片两副本</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95-11"><span class="toc-number">9.2.5.3.1.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95-6"><span class="toc-number">9.2.5.3.2.</span> <span class="toc-text">查看索引</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E4%B8%8E%E6%81%A2%E5%A4%8D"><span class="toc-number">9.3.</span> <span class="toc-text">故障与恢复</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">9.3.1.</span> <span class="toc-text">故障转移</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A3%E5%B8%B8%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-number">9.3.1.1.</span> <span class="toc-text">正常集群状态</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C"><span class="toc-number">9.3.1.2.</span> <span class="toc-text">节点故障</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB"><span class="toc-number">9.3.1.3.</span> <span class="toc-text">数据迁移</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C-1"><span class="toc-number">9.3.2.</span> <span class="toc-text">节点故障</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%97%ADnode2%E8%8A%82%E7%82%B9"><span class="toc-number">9.3.2.1.</span> <span class="toc-text">关闭node2节点</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%85%B3%E9%97%AD%E5%91%BD%E4%BB%A4"><span class="toc-number">9.3.2.1.1.</span> <span class="toc-text">执行关闭命令</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95-7"><span class="toc-number">9.3.2.1.2.</span> <span class="toc-text">查看索引</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%97%ADnode3%E8%8A%82%E7%82%B9"><span class="toc-number">9.3.2.2.</span> <span class="toc-text">关闭node3节点</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%85%B3%E9%97%AD%E5%91%BD%E4%BB%A4-1"><span class="toc-number">9.3.2.2.1.</span> <span class="toc-text">执行关闭命令</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81-1"><span class="toc-number">9.3.2.2.2.</span> <span class="toc-text">查看集群状态</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E6%81%A2%E5%A4%8D"><span class="toc-number">9.3.3.</span> <span class="toc-text">节点恢复</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8node2%E8%8A%82%E7%82%B9"><span class="toc-number">9.3.3.1.</span> <span class="toc-text">启动node2节点</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">9.3.3.1.1.</span> <span class="toc-text">执行启动命令</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81-2"><span class="toc-number">9.3.3.1.2.</span> <span class="toc-text">查看集群状态</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95-12"><span class="toc-number">9.3.3.1.3.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95%E7%8A%B6%E6%80%81"><span class="toc-number">9.3.3.1.4.</span> <span class="toc-text">查看索引状态</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8node3%E8%8A%82%E7%82%B9"><span class="toc-number">9.3.3.2.</span> <span class="toc-text">启动node3节点</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4-1"><span class="toc-number">9.3.3.2.1.</span> <span class="toc-text">执行启动命令</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95-8"><span class="toc-number">9.3.3.2.2.</span> <span class="toc-text">查看索引</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E7%BC%A9%E5%AE%B9"><span class="toc-number">9.4.</span> <span class="toc-text">扩缩容</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%B8%83%E5%B1%80-3"><span class="toc-number">9.4.1.</span> <span class="toc-text">服务布局</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9%E8%8A%82%E7%82%B9"><span class="toc-number">9.4.2.</span> <span class="toc-text">扩容节点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%8A%82%E7%82%B9%E7%9B%AE%E5%BD%95"><span class="toc-number">9.4.2.1.</span> <span class="toc-text">创建节点目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0IK%E5%88%86%E8%AF%8D%E5%99%A8-4"><span class="toc-number">9.4.2.2.</span> <span class="toc-text">添加IK分词器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-2"><span class="toc-number">9.4.2.3.</span> <span class="toc-text">编写配置文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E9%83%A8%E7%BD%B2%E6%96%87%E6%A1%A3-3"><span class="toc-number">9.4.2.4.</span> <span class="toc-text">编写部署文档</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-3"><span class="toc-number">9.4.2.5.</span> <span class="toc-text">启动服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%8A%82%E7%82%B9%E4%BF%A1%E6%81%AF"><span class="toc-number">9.4.2.6.</span> <span class="toc-text">查看节点信息</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E7%BC%A9%E5%AE%B9"><span class="toc-number">9.4.3.</span> <span class="toc-text">节点缩容</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A6%81%E6%AD%A2%E6%95%B0%E6%8D%AE%E5%88%86%E9%85%8D"><span class="toc-number">9.4.3.1.</span> <span class="toc-text">禁止数据分配</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E6%95%B0%E6%8D%AE%E5%88%86%E9%85%8D"><span class="toc-number">9.4.3.2.</span> <span class="toc-text">检查数据分配</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E8%8A%82%E7%82%B9"><span class="toc-number">9.4.3.3.</span> <span class="toc-text">关闭节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E6%83%85%E5%86%B5"><span class="toc-number">9.4.3.4.</span> <span class="toc-text">查看集群情况</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch-%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5"><span class="toc-number">10.</span> <span class="toc-text">ElasticSearch 深度分页</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5%E9%97%AE%E9%A2%98"><span class="toc-number">10.1.</span> <span class="toc-text">深度分页问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E6%96%B9%E5%BC%8F"><span class="toc-number">10.1.1.</span> <span class="toc-text">分页方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#from-size"><span class="toc-number">10.1.2.</span> <span class="toc-text">from&#x2F;size</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F-1"><span class="toc-number">10.1.2.1.</span> <span class="toc-text">使用方式</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="toc-number">10.1.2.1.1.</span> <span class="toc-text">分页查询</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-1"><span class="toc-number">10.1.2.2.</span> <span class="toc-text">优缺点</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BC%98%E7%82%B9"><span class="toc-number">10.1.2.2.1.</span> <span class="toc-text">优点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9-1"><span class="toc-number">10.1.2.2.2.</span> <span class="toc-text">缺点</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">10.1.2.3.</span> <span class="toc-text">适用场景</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5%E9%97%AE%E9%A2%98-1"><span class="toc-number">10.1.2.4.</span> <span class="toc-text">深度分页问题</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5%E9%99%90%E5%88%B6"><span class="toc-number">10.1.2.4.1.</span> <span class="toc-text">深度分页限制</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5"><span class="toc-number">10.1.2.4.2.</span> <span class="toc-text">尝试深度分页</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%99%90%E5%88%B6%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5"><span class="toc-number">10.1.2.5.</span> <span class="toc-text">为什么限制深度分页</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E6%AD%A5%E9%AA%A4"><span class="toc-number">10.1.2.5.1.</span> <span class="toc-text">分页查询步骤</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">10.1.2.5.2.</span> <span class="toc-text">问题分析</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-4"><span class="toc-number">10.1.2.6.</span> <span class="toc-text">解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E5%88%86%E9%A1%B5%E6%95%B0"><span class="toc-number">10.1.2.6.1.</span> <span class="toc-text">限制分页数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9max-result-window%E5%88%9D%E5%A7%8B%E5%80%BC"><span class="toc-number">10.1.2.6.2.</span> <span class="toc-text">修改max_result_window初始值</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Scroll-%E9%81%8D%E5%8E%86%E6%9F%A5%E8%AF%A2"><span class="toc-number">10.1.3.</span> <span class="toc-text">Scroll 遍历查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F-2"><span class="toc-number">10.1.3.1.</span> <span class="toc-text">使用方式</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%9F%E6%88%90scroll-id"><span class="toc-number">10.1.3.1.1.</span> <span class="toc-text">生成scroll_id</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2-1"><span class="toc-number">10.1.3.1.2.</span> <span class="toc-text">分页查询</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9-7"><span class="toc-number">10.1.3.1.3.</span> <span class="toc-text">注意事项</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-2"><span class="toc-number">10.1.3.2.</span> <span class="toc-text">优缺点</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BC%98%E7%82%B9-1"><span class="toc-number">10.1.3.2.1.</span> <span class="toc-text">优点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9-2"><span class="toc-number">10.1.3.2.2.</span> <span class="toc-text">缺点</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF-1"><span class="toc-number">10.1.3.3.</span> <span class="toc-text">适用场景</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#scroll-%E5%88%86%E9%A1%B5%E5%8E%9F%E7%90%86"><span class="toc-number">10.1.3.4.</span> <span class="toc-text">scroll 分页原理</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%BB%9A%E5%8A%A8%E6%B8%B8%E6%A0%87%E5%8E%9F%E7%90%86"><span class="toc-number">10.1.3.4.1.</span> <span class="toc-text">滚动游标原理</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Scroll-%E7%9A%84%E7%90%86%E8%A7%A3"><span class="toc-number">10.1.3.4.2.</span> <span class="toc-text">Scroll 的理解</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#scroll%E7%9A%84%E6%B8%85%E7%90%86"><span class="toc-number">10.1.3.5.</span> <span class="toc-text">scroll的清理</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AEscroll-id%E6%B8%85%E7%90%86"><span class="toc-number">10.1.3.5.1.</span> <span class="toc-text">根据scroll_id清理</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B8%85%E7%90%86%E6%89%80%E6%9C%89%E7%9A%84scroll"><span class="toc-number">10.1.3.5.2.</span> <span class="toc-text">清理所有的scroll</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#search-after-%E6%9F%A5%E8%AF%A2"><span class="toc-number">10.1.4.</span> <span class="toc-text">search_after 查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F-3"><span class="toc-number">10.1.4.1.</span> <span class="toc-text">使用方式</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-PIT-%E8%A7%86%E5%9B%BE"><span class="toc-number">10.1.4.1.1.</span> <span class="toc-text">创建 PIT 视图</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%9F%BA%E7%A1%80%E6%9F%A5%E8%AF%A2"><span class="toc-number">10.1.4.1.2.</span> <span class="toc-text">创建基础查询</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%90%8E%E7%BB%AD%E7%BF%BB%E9%A1%B5"><span class="toc-number">10.1.4.1.3.</span> <span class="toc-text">后续翻页</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-3"><span class="toc-number">10.1.4.2.</span> <span class="toc-text">优缺点</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BC%98%E7%82%B9-2"><span class="toc-number">10.1.4.2.1.</span> <span class="toc-text">优点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9-3"><span class="toc-number">10.1.4.2.2.</span> <span class="toc-text">缺点</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF-2"><span class="toc-number">10.1.4.3.</span> <span class="toc-text">适用场景</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E5%8E%9F%E7%90%86"><span class="toc-number">10.1.4.4.</span> <span class="toc-text">分页原理</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#PIT%E8%A7%86%E5%9B%BE"><span class="toc-number">10.1.4.4.1.</span> <span class="toc-text">PIT视图</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E5%88%86%E9%A1%B5%E6%96%B9%E5%BC%8F%E5%AF%B9%E6%AF%94"><span class="toc-number">10.1.5.</span> <span class="toc-text">三种分页方式对比</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94"><span class="toc-number">10.1.5.1.</span> <span class="toc-text">性能对比</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9%E5%AF%B9%E6%AF%94"><span class="toc-number">10.1.5.2.</span> <span class="toc-text">优缺点对比</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch-%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="toc-number">11.</span> <span class="toc-text">ElasticSearch 数据存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5"><span class="toc-number">11.1.</span> <span class="toc-text">数据写入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E8%BF%87%E7%A8%8B"><span class="toc-number">11.1.1.</span> <span class="toc-text">写入过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E5%8E%9F%E7%90%86"><span class="toc-number">11.1.2.</span> <span class="toc-text">写入原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFtranslog"><span class="toc-number">11.1.2.1.</span> <span class="toc-text">什么是translog</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E8%BF%87%E7%A8%8B-1"><span class="toc-number">11.1.2.2.</span> <span class="toc-text">写入过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">11.1.2.3.</span> <span class="toc-text">写入过程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%BF%BD%E5%8A%A0%E4%BA%8B%E5%8A%A1%E6%97%A5%E5%BF%97"><span class="toc-number">11.1.2.3.1.</span> <span class="toc-text">追加事务日志</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%B7%E6%96%B0%E7%BC%93%E5%AD%98"><span class="toc-number">11.1.2.3.2.</span> <span class="toc-text">刷新缓存</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BB%A7%E7%BB%AD%E8%BF%BD%E5%8A%A0%E4%BA%8B%E5%8A%A1%E6%97%A5%E5%BF%97"><span class="toc-number">11.1.2.3.3.</span> <span class="toc-text">继续追加事务日志</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">11.1.2.3.4.</span> <span class="toc-text">持久化</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-number">11.1.2.4.</span> <span class="toc-text">副本可靠性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">11.1.2.5.</span> <span class="toc-text">读写一致性</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5-1"><span class="toc-number">11.1.2.5.1.</span> <span class="toc-text">数据写入</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96"><span class="toc-number">11.1.2.5.2.</span> <span class="toc-text">数据读取</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="toc-number">11.2.</span> <span class="toc-text">数据存储</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E5%8E%9F%E7%90%86"><span class="toc-number">11.2.1.</span> <span class="toc-text">数据存储原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E4%B8%8D%E5%8F%AF%E5%8F%98"><span class="toc-number">11.2.1.1.</span> <span class="toc-text">倒排索引不可变</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E5%8F%98%E4%BC%98%E7%82%B9"><span class="toc-number">11.2.1.1.1.</span> <span class="toc-text">不可变优点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E5%8F%98%E7%BC%BA%E7%82%B9"><span class="toc-number">11.2.1.1.2.</span> <span class="toc-text">不可变缺点</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AE%B5%E7%9A%84%E5%BC%95%E5%85%A5"><span class="toc-number">11.2.1.2.</span> <span class="toc-text">段的引入</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%AE%B5"><span class="toc-number">11.2.1.2.1.</span> <span class="toc-text">什么是段</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%AE%B5%E4%B8%8D%E5%8F%AF%E5%8F%98"><span class="toc-number">11.2.1.2.2.</span> <span class="toc-text">为什么段不可变</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AE%B5%E7%9A%84%E5%90%88%E5%B9%B6"><span class="toc-number">11.2.1.3.</span> <span class="toc-text">段的合并</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%AE%B5%E5%90%88%E5%B9%B6"><span class="toc-number">11.2.1.3.1.</span> <span class="toc-text">什么是段合并</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AE%B5%E5%90%88%E5%B9%B6%E6%B5%81%E7%A8%8B"><span class="toc-number">11.2.1.3.2.</span> <span class="toc-text">段合并流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%9B%B4%E6%96%B0"><span class="toc-number">11.2.2.</span> <span class="toc-text">索引更新</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%9B%B4%E6%96%B0%E7%B4%A2%E5%BC%95"><span class="toc-number">11.2.2.1.</span> <span class="toc-text">如何更新索引</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E7%BB%86%E8%8A%82"><span class="toc-number">11.2.2.1.1.</span> <span class="toc-text">更新细节</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%9F%A5%E8%AF%A2"><span class="toc-number">11.2.2.1.2.</span> <span class="toc-text">如何查询</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%91%E5%AE%9E%E6%97%B6%E6%90%9C%E7%B4%A2%E5%8E%9F%E7%90%86"><span class="toc-number">11.3.</span> <span class="toc-text">近实时搜索原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E5%86%99%E5%85%A5%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">11.3.1.</span> <span class="toc-text">直接写入存在的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%B6%E6%97%B6%E5%86%99%E7%AD%96%E7%95%A5"><span class="toc-number">11.3.2.</span> <span class="toc-text">延时写策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%BF%91%E5%AE%9E%E6%97%B6%E6%90%9C%E7%B4%A2"><span class="toc-number">11.3.3.</span> <span class="toc-text">如何实现近实时搜索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%91%E5%AE%9E%E6%97%B6%E5%86%99%E5%85%A5%E6%B5%8B%E8%AF%95"><span class="toc-number">11.3.4.</span> <span class="toc-text">近实时写入测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C-4"><span class="toc-number">11.3.4.1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4%E8%AE%BE%E7%BD%AE"><span class="toc-number">11.3.4.2.</span> <span class="toc-text">使用默认设置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">11.3.4.2.1.</span> <span class="toc-text">写入数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-6"><span class="toc-number">11.3.4.2.2.</span> <span class="toc-text">查询数据</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E8%87%AA%E5%8A%A8%E5%88%B7%E6%96%B0"><span class="toc-number">11.3.4.3.</span> <span class="toc-text">关闭自动刷新</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E8%87%AA%E5%8A%A8%E5%88%B7%E6%96%B0-1"><span class="toc-number">11.3.4.3.1.</span> <span class="toc-text">关闭自动刷新</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE-1"><span class="toc-number">11.3.4.3.2.</span> <span class="toc-text">写入数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-7"><span class="toc-number">11.3.4.3.3.</span> <span class="toc-text">查询数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E8%87%AA%E5%8A%A8%E5%88%B7%E6%96%B0"><span class="toc-number">11.3.4.3.4.</span> <span class="toc-text">开启自动刷新</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ES%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-number">11.4.</span> <span class="toc-text">ES可靠性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">11.4.1.</span> <span class="toc-text">相关概念</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#refresh-amp-amp-flush-amp-amp-commit"><span class="toc-number">11.4.1.1.</span> <span class="toc-text">refresh &amp;&amp; flush &amp;&amp; commit</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ES-%E6%A6%82%E5%BF%B5"><span class="toc-number">11.4.1.2.</span> <span class="toc-text">ES 概念</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#translog"><span class="toc-number">11.4.2.</span> <span class="toc-text">translog</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E9%97%AE%E9%A2%98"><span class="toc-number">11.4.2.1.</span> <span class="toc-text">重要问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC-1"><span class="toc-number">11.4.3.</span> <span class="toc-text">副本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E4%BC%98%E5%8C%96"><span class="toc-number">11.4.4.</span> <span class="toc-text">写入优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98"><span class="toc-number">12.</span> <span class="toc-text">ElasticSearch 性能调优</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-6"><span class="toc-number">12.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%B0%83%E4%BC%98"><span class="toc-number">12.2.</span> <span class="toc-text">配置文件调优</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%94%81%E5%AE%9A"><span class="toc-number">12.2.1.</span> <span class="toc-text">内存锁定</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9ES%E9%85%8D%E7%BD%AE"><span class="toc-number">12.2.1.1.</span> <span class="toc-text">修改ES配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9JVM%E9%85%8D%E7%BD%AE"><span class="toc-number">12.2.1.2.</span> <span class="toc-text">修改JVM配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84swap"><span class="toc-number">12.2.1.3.</span> <span class="toc-text">关闭操作系统的swap</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%B4%E6%97%B6%E5%85%B3%E9%97%AD-3"><span class="toc-number">12.2.1.3.1.</span> <span class="toc-text">临时关闭</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B0%B8%E4%B9%85%E5%85%B3%E9%97%AD-3"><span class="toc-number">12.2.1.3.2.</span> <span class="toc-text">永久关闭</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-number">12.2.1.4.</span> <span class="toc-text">修改文件描述符</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE"><span class="toc-number">12.2.1.5.</span> <span class="toc-text">修改系统配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98"><span class="toc-number">12.2.1.5.1.</span> <span class="toc-text">设置虚拟内存</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E4%B8%8A%E9%99%90"><span class="toc-number">12.2.1.5.2.</span> <span class="toc-text">修改文件上限</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E5%90%AFES"><span class="toc-number">12.2.1.6.</span> <span class="toc-text">重启ES</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%BC%98%E5%8C%96"><span class="toc-number">12.2.2.</span> <span class="toc-text">服务发现优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%A3%80%E6%B5%8B%EF%BC%88-fault-detection-%EF%BC%89"><span class="toc-number">12.2.3.</span> <span class="toc-text">故障检测（ fault detection ）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%A3%80%E6%B5%8B%E6%83%85%E5%86%B5"><span class="toc-number">12.2.3.1.</span> <span class="toc-text">故障检测情况</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc-number">12.2.3.2.</span> <span class="toc-text">配置方式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%9F%E5%88%97%E6%95%B0%E9%87%8F%E4%BC%98%E5%8C%96"><span class="toc-number">12.2.4.</span> <span class="toc-text">队列数量优化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%83%85%E5%86%B5"><span class="toc-number">12.2.4.1.</span> <span class="toc-text">查看线程池情况</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8"><span class="toc-number">12.2.5.</span> <span class="toc-text">内存使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%86%94%E6%96%AD%E9%99%90%E9%A2%9D"><span class="toc-number">12.2.5.1.</span> <span class="toc-text">配置熔断限额</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%BC%93%E5%AD%98"><span class="toc-number">12.2.5.2.</span> <span class="toc-text">配置缓存</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%88%86%E7%89%87%E4%BC%98%E5%8C%96"><span class="toc-number">12.2.6.</span> <span class="toc-text">创建分片优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%B1%82%E9%9D%A2%E8%B0%83%E4%BC%98"><span class="toc-number">12.3.</span> <span class="toc-text">系统层面调优</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jdk%E7%89%88%E6%9C%AC"><span class="toc-number">12.3.1.</span> <span class="toc-text">jdk版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jdk%E5%86%85%E5%AD%98%E9%85%8D%E7%BD%AE"><span class="toc-number">12.3.2.</span> <span class="toc-text">jdk内存配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E4%BA%A4%E6%8D%A2%E5%88%86%E5%8C%BA"><span class="toc-number">12.3.3.</span> <span class="toc-text">关闭交换分区</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%8F%A5%E6%9F%84"><span class="toc-number">12.3.4.</span> <span class="toc-text">文件句柄</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mmap"><span class="toc-number">12.3.5.</span> <span class="toc-text">mmap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A3%81%E7%9B%98"><span class="toc-number">12.3.6.</span> <span class="toc-text">磁盘</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E6%8C%82%E8%BD%BD"><span class="toc-number">12.3.7.</span> <span class="toc-text">磁盘挂载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E5%85%B6%E4%BB%96%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">12.3.8.</span> <span class="toc-text">磁盘其他注意事项</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%E8%B0%83%E4%BC%98"><span class="toc-number">12.4.</span> <span class="toc-text">使用方式调优</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Index-%E5%86%99-%E8%B0%83%E4%BC%98"><span class="toc-number">12.4.1.</span> <span class="toc-text">Index(写)调优</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E6%95%B0%E7%BD%AE0"><span class="toc-number">12.4.1.1.</span> <span class="toc-text">副本数置0</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90doc-ID"><span class="toc-number">12.4.1.2.</span> <span class="toc-text">自动生成doc ID</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%88%E7%90%86%E8%AE%BE%E7%BD%AEmappings"><span class="toc-number">12.4.1.3.</span> <span class="toc-text">合理设置mappings</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E6%95%B4-source%E5%AD%97%E6%AE%B5"><span class="toc-number">12.4.1.4.</span> <span class="toc-text">调整_source字段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%B9analyzed%E7%9A%84%E5%AD%97%E6%AE%B5%E7%A6%81%E7%94%A8norms"><span class="toc-number">12.4.1.5.</span> <span class="toc-text">对analyzed的字段禁用norms</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E7%B4%A2%E5%BC%95%E7%9A%84%E5%88%B7%E6%96%B0%E9%97%B4%E9%9A%94"><span class="toc-number">12.4.1.6.</span> <span class="toc-text">调整索引的刷新间隔</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%B9%E5%A4%84%E7%90%86"><span class="toc-number">12.4.1.7.</span> <span class="toc-text">批处理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Document%E7%9A%84%E8%B7%AF%E7%94%B1%E5%A4%84%E7%90%86"><span class="toc-number">12.4.1.8.</span> <span class="toc-text">Document的路由处理</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Search-%E8%AF%BB-%E8%B0%83%E4%BC%98"><span class="toc-number">12.4.2.</span> <span class="toc-text">Search(读)调优</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%88%86%E7%BB%84"><span class="toc-number">12.4.2.1.</span> <span class="toc-text">数据分组</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Filter%E6%9B%BF%E4%BB%A3Query"><span class="toc-number">12.4.2.2.</span> <span class="toc-text">使用Filter替代Query</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ID%E5%AD%97%E6%AE%B5%E5%AE%9A%E4%B9%89%E4%B8%BAkeyword"><span class="toc-number">12.4.2.3.</span> <span class="toc-text">ID字段定义为keyword</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hot-threads"><span class="toc-number">12.4.3.</span> <span class="toc-text">hot_threads</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pending-tasks"><span class="toc-number">12.4.4.</span> <span class="toc-text">pending_tasks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E5%AD%98%E5%82%A8"><span class="toc-number">12.4.5.</span> <span class="toc-text">字段存储</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%97%A5%E5%BF%97"><span class="toc-number">12.4.6.</span> <span class="toc-text">事务日志</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%88%B7%E6%96%B0"><span class="toc-number">12.4.6.1.</span> <span class="toc-text">异步刷新</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%8F%82%E6%95%B0"><span class="toc-number">12.4.6.2.</span> <span class="toc-text">其他参数</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#index-translog-sync-interval"><span class="toc-number">12.4.6.2.1.</span> <span class="toc-text">index.translog.sync_interval</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#index-translog-flush-threshold-size"><span class="toc-number">12.4.6.2.2.</span> <span class="toc-text">index.translog.flush_threshold_size</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#refresh-interval"><span class="toc-number">12.4.7.</span> <span class="toc-text">refresh_interval</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A6%81%E6%AD%A2%E5%8A%A8%E6%80%81mapping"><span class="toc-number">12.4.8.</span> <span class="toc-text">禁止动态mapping</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A8%E6%80%81mapping%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="toc-number">12.4.8.1.</span> <span class="toc-text">动态mapping的缺点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%98%A0%E5%B0%84%E9%85%8D%E7%BD%AE-1"><span class="toc-number">12.4.8.2.</span> <span class="toc-text">映射配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E5%86%99%E5%85%A5"><span class="toc-number">12.4.9.</span> <span class="toc-text">批量写入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%92%8Cshard"><span class="toc-number">12.4.10.</span> <span class="toc-text">索引和shard</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%BB%BA%E8%AE%AE"><span class="toc-number">12.4.10.1.</span> <span class="toc-text">使用建议</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AE%B5%E5%90%88%E5%B9%B6"><span class="toc-number">12.4.11.</span> <span class="toc-text">段合并</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90-id"><span class="toc-number">12.4.12.</span> <span class="toc-text">自动生成_id</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#routing"><span class="toc-number">12.4.13.</span> <span class="toc-text">routing</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8alias"><span class="toc-number">12.4.14.</span> <span class="toc-text">使用alias</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E5%AE%BD%E8%A1%A8"><span class="toc-number">12.4.15.</span> <span class="toc-text">避免宽表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E7%A8%80%E7%96%8F%E7%B4%A2%E5%BC%95"><span class="toc-number">12.4.16.</span> <span class="toc-text">避免稀疏索引</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch-%E5%9F%BA%E7%A1%80%E6%9F%A5%E8%AF%A2"><span class="toc-number">13.</span> <span class="toc-text">ElasticSearch 基础查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-7"><span class="toc-number">13.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A3%E6%8E%92%E7%B4%A2%E5%BC%95-1"><span class="toc-number">13.1.1.</span> <span class="toc-text">正排索引</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%8F%8F%E8%BF%B0"><span class="toc-number">13.1.1.1.</span> <span class="toc-text">索引描述</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95-1"><span class="toc-number">13.1.2.</span> <span class="toc-text">倒排索引</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%84%E6%88%90%E9%83%A8%E5%88%86-1"><span class="toc-number">13.1.2.1.</span> <span class="toc-text">组成部分</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%BF%87%E7%A8%8B"><span class="toc-number">13.1.2.2.</span> <span class="toc-text">查询过程</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95-13"><span class="toc-number">13.1.2.2.1.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2-1"><span class="toc-number">13.1.2.2.2.</span> <span class="toc-text">查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE-1"><span class="toc-number">13.1.3.</span> <span class="toc-text">导入数据</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95-14"><span class="toc-number">13.1.3.1.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E8%84%9A%E6%9C%AC"><span class="toc-number">13.1.3.2.</span> <span class="toc-text">导入脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2"><span class="toc-number">13.2.</span> <span class="toc-text">基本查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%9F%A5%E8%AF%A2"><span class="toc-number">13.2.1.</span> <span class="toc-text">简单查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%8D%E9%A1%B9%E6%9F%A5%E8%AF%A2"><span class="toc-number">13.2.2.</span> <span class="toc-text">词项查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2-2"><span class="toc-number">13.2.3.</span> <span class="toc-text">分页查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E8%BF%94%E5%9B%9E%E5%AD%97%E6%AE%B5"><span class="toc-number">13.2.4.</span> <span class="toc-text">过滤返回字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E6%9C%80%E4%BD%8E%E8%AF%84%E5%88%86"><span class="toc-number">13.2.5.</span> <span class="toc-text">过滤最低评分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E4%BA%AE%E6%98%BE%E7%A4%BA"><span class="toc-number">13.2.6.</span> <span class="toc-text">高亮显示</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%9F%A5%E8%AF%A2"><span class="toc-number">13.3.</span> <span class="toc-text">全文查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#match"><span class="toc-number">13.3.1.</span> <span class="toc-text">match</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8D%E7%9B%B8%E5%85%B3%E6%9F%A5%E8%AF%A2"><span class="toc-number">13.3.1.1.</span> <span class="toc-text">不相关查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%88%E5%B9%B6%E6%9F%A5%E8%AF%A2"><span class="toc-number">13.3.1.2.</span> <span class="toc-text">合并查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#match-phrase"><span class="toc-number">13.3.2.</span> <span class="toc-text">match_phrase</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%BF%91%E4%BC%BC%E5%8C%B9%E9%85%8D"><span class="toc-number">13.3.2.1.</span> <span class="toc-text">什么是近似匹配</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%BF%9B%E8%A1%8C%E6%9F%A5%E8%AF%A2"><span class="toc-number">13.3.2.1.1.</span> <span class="toc-text">进行查询</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E9%9C%80%E6%B1%82"><span class="toc-number">13.3.2.1.2.</span> <span class="toc-text">增加需求</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#DSL%E5%88%86%E6%9E%90"><span class="toc-number">13.3.2.1.3.</span> <span class="toc-text">DSL分析</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">13.3.2.2.</span> <span class="toc-text">需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-position"><span class="toc-number">13.3.2.2.1.</span> <span class="toc-text">什么是 position</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%86%E8%AF%8D%E6%B5%8B%E8%AF%95"><span class="toc-number">13.3.2.2.2.</span> <span class="toc-text">分词测试</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2-2"><span class="toc-number">13.3.2.3.</span> <span class="toc-text">查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#match-phrase-prefix"><span class="toc-number">13.3.3.</span> <span class="toc-text">match_phrase_prefix</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F"><span class="toc-number">13.3.3.1.</span> <span class="toc-text">注意</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#multi-match"><span class="toc-number">13.3.4.</span> <span class="toc-text">multi_match</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2-3"><span class="toc-number">13.3.4.1.</span> <span class="toc-text">查询</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8F%82%E6%95%B0"><span class="toc-number">13.3.4.1.1.</span> <span class="toc-text">参数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#query-string"><span class="toc-number">13.3.5.</span> <span class="toc-text">query_string</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-1"><span class="toc-number">13.3.5.1.</span> <span class="toc-text">基本查询</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9B%B4%E5%A4%9A%E5%BE%85%E8%A1%A5%E5%85%85"><span class="toc-number">13.3.5.1.1.</span> <span class="toc-text">更多待补充</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#simple-query-string"><span class="toc-number">13.3.6.</span> <span class="toc-text">simple_query_string</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%8D%E9%A1%B9%E6%9F%A5%E8%AF%A2-1"><span class="toc-number">13.4.</span> <span class="toc-text">词项查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#term"><span class="toc-number">13.4.1.</span> <span class="toc-text">term</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-2"><span class="toc-number">13.4.1.1.</span> <span class="toc-text">基本查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%AD%E5%8F%A5%E6%9F%A5%E8%AF%A2"><span class="toc-number">13.4.1.2.</span> <span class="toc-text">语句查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#terms"><span class="toc-number">13.4.2.</span> <span class="toc-text">terms</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-3"><span class="toc-number">13.4.2.1.</span> <span class="toc-text">基本查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Terms-lookup"><span class="toc-number">13.4.2.2.</span> <span class="toc-text">Terms lookup</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E4%BB%8B%E7%BB%8D"><span class="toc-number">13.4.2.2.1.</span> <span class="toc-text">参数介绍</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE"><span class="toc-number">13.4.2.2.2.</span> <span class="toc-text">准备数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-8"><span class="toc-number">13.4.2.2.3.</span> <span class="toc-text">查询数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9-8"><span class="toc-number">13.4.2.2.4.</span> <span class="toc-text">注意事项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#range"><span class="toc-number">13.4.3.</span> <span class="toc-text">range</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E4%BB%8B%E7%BB%8D-1"><span class="toc-number">13.4.3.1.</span> <span class="toc-text">参数介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-4"><span class="toc-number">13.4.3.2.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exists"><span class="toc-number">13.4.4.</span> <span class="toc-text">exists</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-5"><span class="toc-number">13.4.4.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#prefix"><span class="toc-number">13.4.5.</span> <span class="toc-text">prefix</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-6"><span class="toc-number">13.4.5.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wildcard"><span class="toc-number">13.4.6.</span> <span class="toc-text">wildcard</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-7"><span class="toc-number">13.4.6.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#regexp"><span class="toc-number">13.4.7.</span> <span class="toc-text">regexp</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-8"><span class="toc-number">13.4.7.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fuzzy"><span class="toc-number">13.4.8.</span> <span class="toc-text">fuzzy</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%9B%B8%E4%BC%BC%E5%BA%A6"><span class="toc-number">13.4.8.1.</span> <span class="toc-text">什么是相似度</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-9"><span class="toc-number">13.4.8.2.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ids"><span class="toc-number">13.4.9.</span> <span class="toc-text">ids</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-10"><span class="toc-number">13.4.9.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">13.5.</span> <span class="toc-text">复合查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#constant-score"><span class="toc-number">13.5.1.</span> <span class="toc-text">constant_score</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-11"><span class="toc-number">13.5.1.1.</span> <span class="toc-text">基本查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BF%BD%E7%95%A5%E8%AF%84%E5%88%86"><span class="toc-number">13.5.1.2.</span> <span class="toc-text">忽略评分</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bool"><span class="toc-number">13.5.2.</span> <span class="toc-text">bool</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E5%8F%82%E6%95%B0"><span class="toc-number">13.5.2.1.</span> <span class="toc-text">关键参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-12"><span class="toc-number">13.5.2.2.</span> <span class="toc-text">基本查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#minmum-should-match"><span class="toc-number">13.5.2.3.</span> <span class="toc-text">minmum_should_match</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%88%86%E6%9E%90"><span class="toc-number">13.5.2.3.1.</span> <span class="toc-text">查询分析</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E5%AD%97%E5%88%86%E8%AF%8D"><span class="toc-number">13.5.2.3.2.</span> <span class="toc-text">关键字分词</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E5%8C%B9%E9%85%8D"><span class="toc-number">13.5.2.3.3.</span> <span class="toc-text">部分匹配</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dis-max"><span class="toc-number">13.5.3.</span> <span class="toc-text">dis_max</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE-1"><span class="toc-number">13.5.3.1.</span> <span class="toc-text">准备数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-13"><span class="toc-number">13.5.3.2.</span> <span class="toc-text">基本查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#should%E8%AF%84%E5%88%86%E7%AD%96%E7%95%A5"><span class="toc-number">13.5.3.3.</span> <span class="toc-text">should评分策略</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AF%87"><span class="toc-number">13.5.3.3.1.</span> <span class="toc-text">第一篇</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AF%87"><span class="toc-number">13.5.3.3.2.</span> <span class="toc-text">第二篇</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3"><span class="toc-number">13.5.3.4.</span> <span class="toc-text">如何解决</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%BF%87%E7%A8%8B-1"><span class="toc-number">13.5.3.5.</span> <span class="toc-text">查询过程</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AF%87-1"><span class="toc-number">13.5.3.5.1.</span> <span class="toc-text">第一篇</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AF%87-1"><span class="toc-number">13.5.3.5.2.</span> <span class="toc-text">第二篇</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%8F%82%E6%95%B0-1"><span class="toc-number">13.5.3.6.</span> <span class="toc-text">其他参数</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#tie-breaker"><span class="toc-number">13.5.3.6.1.</span> <span class="toc-text">tie_breaker</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#tie-breaker-1"><span class="toc-number">13.5.3.6.2.</span> <span class="toc-text">tie_breaker</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#function-score"><span class="toc-number">13.5.4.</span> <span class="toc-text">function_score</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE-2"><span class="toc-number">13.5.4.1.</span> <span class="toc-text">准备数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-14"><span class="toc-number">13.5.4.2.</span> <span class="toc-text">基本查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%80%83%E8%99%91votes%E8%AF%84%E5%88%86"><span class="toc-number">13.5.4.3.</span> <span class="toc-text">考虑votes评分</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#weight"><span class="toc-number">13.5.4.4.</span> <span class="toc-text">weight</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-15"><span class="toc-number">13.5.4.4.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#random-score"><span class="toc-number">13.5.4.5.</span> <span class="toc-text">random_score</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#script-score"><span class="toc-number">13.5.4.6.</span> <span class="toc-text">script_score</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-16"><span class="toc-number">13.5.4.6.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#field-value-factor"><span class="toc-number">13.5.4.7.</span> <span class="toc-text">field_value_factor</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="toc-number">13.5.4.7.1.</span> <span class="toc-text">参数说明</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">13.5.4.7.2.</span> <span class="toc-text">基本使用</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#modifier%E5%8F%82%E6%95%B0"><span class="toc-number">13.5.4.7.3.</span> <span class="toc-text">modifier参数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#score-mode%E5%8F%82%E6%95%B0"><span class="toc-number">13.5.4.7.4.</span> <span class="toc-text">score_mode参数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#boosting"><span class="toc-number">13.5.5.</span> <span class="toc-text">boosting</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%82%E6%95%B0-1"><span class="toc-number">13.5.5.1.</span> <span class="toc-text">参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-17"><span class="toc-number">13.5.5.2.</span> <span class="toc-text">基本查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%99%8D%E4%BD%8E%E8%AF%84%E5%88%86"><span class="toc-number">13.5.5.3.</span> <span class="toc-text">降低评分</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE%E6%9F%A5%E8%AF%A2"><span class="toc-number">13.6.</span> <span class="toc-text">地理位置查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="toc-number">13.6.1.</span> <span class="toc-text">数据准备</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95-15"><span class="toc-number">13.6.1.1.</span> <span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE-1"><span class="toc-number">13.6.1.2.</span> <span class="toc-text">插入数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5"><span class="toc-number">13.6.1.3.</span> <span class="toc-text">批量插入</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#geo-distance"><span class="toc-number">13.6.2.</span> <span class="toc-text">geo_distance</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-18"><span class="toc-number">13.6.2.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#geo-bounding-box"><span class="toc-number">13.6.3.</span> <span class="toc-text">geo_bounding_box</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-19"><span class="toc-number">13.6.3.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#geo-polygon"><span class="toc-number">13.6.4.</span> <span class="toc-text">geo_polygon</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-20"><span class="toc-number">13.6.4.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#geo-shape-1"><span class="toc-number">13.6.5.</span> <span class="toc-text">geo_shape</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE-3"><span class="toc-number">13.6.5.1.</span> <span class="toc-text">准备数据</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-number">13.6.5.1.1.</span> <span class="toc-text">新建索引</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE-2"><span class="toc-number">13.6.5.1.2.</span> <span class="toc-text">插入数据</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-21"><span class="toc-number">13.6.5.2.</span> <span class="toc-text">基本查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E5%8F%82%E6%95%B0-1"><span class="toc-number">13.6.5.3.</span> <span class="toc-text">关键参数</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch-%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">14.</span> <span class="toc-text">ElasticSearch 聚合查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E6%A0%87%E8%81%9A%E5%90%88"><span class="toc-number">14.1.</span> <span class="toc-text">指标聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Max"><span class="toc-number">14.1.1.</span> <span class="toc-text">Max</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-22"><span class="toc-number">14.1.1.1.</span> <span class="toc-text">基本查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="toc-number">14.1.1.2.</span> <span class="toc-text">设置默认值</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E6%96%87%E6%A1%A3"><span class="toc-number">14.1.1.2.1.</span> <span class="toc-text">插入文档</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-23"><span class="toc-number">14.1.1.2.2.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BF%BD%E7%95%A5%E9%97%AE%E9%A2%98%E6%96%87%E6%A1%A3"><span class="toc-number">14.1.1.3.</span> <span class="toc-text">忽略问题文档</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-24"><span class="toc-number">14.1.1.3.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Min"><span class="toc-number">14.1.2.</span> <span class="toc-text">Min</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-25"><span class="toc-number">14.1.2.1.</span> <span class="toc-text">基本查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BF%BD%E7%95%A5%E9%97%AE%E9%A2%98%E6%96%87%E6%A1%A3-1"><span class="toc-number">14.1.2.2.</span> <span class="toc-text">忽略问题文档</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Avg"><span class="toc-number">14.1.3.</span> <span class="toc-text">Avg</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-26"><span class="toc-number">14.1.3.1.</span> <span class="toc-text">基本查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BF%BD%E7%95%A5%E9%97%AE%E9%A2%98%E6%96%87%E6%A1%A3-2"><span class="toc-number">14.1.3.2.</span> <span class="toc-text">忽略问题文档</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Sum"><span class="toc-number">14.1.4.</span> <span class="toc-text">Sum</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-27"><span class="toc-number">14.1.4.1.</span> <span class="toc-text">基本查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BF%BD%E7%95%A5%E9%97%AE%E9%A2%98%E6%96%87%E6%A1%A3-3"><span class="toc-number">14.1.4.2.</span> <span class="toc-text">忽略问题文档</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Cardinality"><span class="toc-number">14.1.5.</span> <span class="toc-text">Cardinality</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9-9"><span class="toc-number">14.1.5.1.</span> <span class="toc-text">注意事项</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEfielddata"><span class="toc-number">14.1.5.2.</span> <span class="toc-text">设置fielddata</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8D%E7%BD%AE%E7%B4%A2%E5%BC%95"><span class="toc-number">14.1.5.2.1.</span> <span class="toc-text">重置索引</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">14.1.5.2.2.</span> <span class="toc-text">重新导入数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%9F%A5%E8%AF%A2"><span class="toc-number">14.1.5.2.3.</span> <span class="toc-text">基础查询</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E4%BA%8B%E9%A1%B9"><span class="toc-number">14.1.5.2.4.</span> <span class="toc-text">主要事项</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEkeyword"><span class="toc-number">14.1.5.3.</span> <span class="toc-text">设置keyword</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8D%E7%BD%AE%E7%B4%A2%E5%BC%95-1"><span class="toc-number">14.1.5.3.1.</span> <span class="toc-text">重置索引</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE-1"><span class="toc-number">14.1.5.3.2.</span> <span class="toc-text">重新导入数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%9F%A5%E8%AF%A2-1"><span class="toc-number">14.1.5.3.3.</span> <span class="toc-text">基础查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stats"><span class="toc-number">14.1.6.</span> <span class="toc-text">Stats</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-28"><span class="toc-number">14.1.6.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Extends-Stats"><span class="toc-number">14.1.7.</span> <span class="toc-text">Extends Stats</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-29"><span class="toc-number">14.1.7.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Percentiles"><span class="toc-number">14.1.8.</span> <span class="toc-text">Percentiles</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-30"><span class="toc-number">14.1.8.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Value-count"><span class="toc-number">14.1.9.</span> <span class="toc-text">Value count</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-31"><span class="toc-number">14.1.9.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%B6%E8%81%9A%E5%90%88"><span class="toc-number">14.2.</span> <span class="toc-text">桶聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Terms"><span class="toc-number">14.2.1.</span> <span class="toc-text">Terms</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-32"><span class="toc-number">14.2.1.1.</span> <span class="toc-text">基本查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%B7%E6%A0%BC%E7%BB%9F%E8%AE%A1"><span class="toc-number">14.2.1.2.</span> <span class="toc-text">价格统计</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Filter"><span class="toc-number">14.2.2.</span> <span class="toc-text">Filter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-33"><span class="toc-number">14.2.2.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Filters"><span class="toc-number">14.2.3.</span> <span class="toc-text">Filters</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-34"><span class="toc-number">14.2.3.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Range"><span class="toc-number">14.2.4.</span> <span class="toc-text">Range</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-35"><span class="toc-number">14.2.4.1.</span> <span class="toc-text">基本查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%BA%E7%89%88%E7%A4%BE%E7%BB%9F%E8%AE%A1"><span class="toc-number">14.2.4.2.</span> <span class="toc-text">出版社统计</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Date-Range"><span class="toc-number">14.2.5.</span> <span class="toc-text">Date Range</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE-3"><span class="toc-number">14.2.5.1.</span> <span class="toc-text">插入数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-36"><span class="toc-number">14.2.5.2.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Date-Histogram"><span class="toc-number">14.2.6.</span> <span class="toc-text">Date Histogram</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-37"><span class="toc-number">14.2.6.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Missing"><span class="toc-number">14.2.7.</span> <span class="toc-text">Missing</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-38"><span class="toc-number">14.2.7.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Children"><span class="toc-number">14.2.8.</span> <span class="toc-text">Children</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-39"><span class="toc-number">14.2.8.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Geo-Distance"><span class="toc-number">14.2.9.</span> <span class="toc-text">Geo Distance</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-40"><span class="toc-number">14.2.9.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IP-Range"><span class="toc-number">14.2.10.</span> <span class="toc-text">IP Range</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE-4"><span class="toc-number">14.2.10.1.</span> <span class="toc-text">准备数据</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8D%E7%BD%AE%E7%B4%A2%E5%BC%95-2"><span class="toc-number">14.2.10.1.1.</span> <span class="toc-text">重置索引</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE-4"><span class="toc-number">14.2.10.1.2.</span> <span class="toc-text">插入数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-41"><span class="toc-number">14.2.11.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E9%81%93%E8%81%9A%E5%90%88"><span class="toc-number">14.3.</span> <span class="toc-text">管道聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Avg-Bucket"><span class="toc-number">14.3.1.</span> <span class="toc-text">Avg Bucket</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-42"><span class="toc-number">14.3.1.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Max-Bucket"><span class="toc-number">14.3.2.</span> <span class="toc-text">Max Bucket</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-43"><span class="toc-number">14.3.2.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Min-Bucket"><span class="toc-number">14.3.3.</span> <span class="toc-text">Min Bucket</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-44"><span class="toc-number">14.3.3.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Sum-Bucket"><span class="toc-number">14.3.4.</span> <span class="toc-text">Sum Bucket</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-45"><span class="toc-number">14.3.4.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stats-Bucket"><span class="toc-number">14.3.5.</span> <span class="toc-text">Stats Bucket</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-46"><span class="toc-number">14.3.5.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Extended-Stats-Bucket"><span class="toc-number">14.3.6.</span> <span class="toc-text">Extended Stats Bucket</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-47"><span class="toc-number">14.3.6.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Percentiles-Bucket"><span class="toc-number">14.3.7.</span> <span class="toc-text">Percentiles Bucket</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2-48"><span class="toc-number">14.3.7.1.</span> <span class="toc-text">基本查询</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch-%E7%9B%B8%E5%85%B3%E6%9F%A5%E8%AF%A2"><span class="toc-number">15.</span> <span class="toc-text">ElasticSearch 相关查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%80%A7%E6%9F%A5%E8%AF%A2%E6%A6%82%E8%BF%B0"><span class="toc-number">15.1.</span> <span class="toc-text">相关性查询概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%9B%B8%E5%85%B3%E6%80%A7%E8%AF%84%E5%88%86"><span class="toc-number">15.1.1.</span> <span class="toc-text">什么是相关性评分</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%BA%A6%E6%A8%A1%E5%9E%8B"><span class="toc-number">15.2.</span> <span class="toc-text">相关度模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E6%A8%A1%E5%9E%8B"><span class="toc-number">15.2.1.</span> <span class="toc-text">布尔模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%91%E9%87%8F%E7%A9%BA%E9%97%B4%E6%A8%A1%E5%9E%8B"><span class="toc-number">15.2.2.</span> <span class="toc-text">向量空间模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E7%8E%87%E6%A8%A1%E5%9E%8B"><span class="toc-number">15.2.3.</span> <span class="toc-text">概率模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B"><span class="toc-number">15.2.4.</span> <span class="toc-text">语言模型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%BA%A6%E7%AE%97%E6%B3%95"><span class="toc-number">15.3.</span> <span class="toc-text">相关度算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TF-IDF"><span class="toc-number">15.3.1.</span> <span class="toc-text">TF&#x2F;IDF</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%8D%E9%A2%91-TF"><span class="toc-number">15.3.1.1.</span> <span class="toc-text">词频 - TF</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%86%E6%96%87%E6%A1%A3%E9%A2%91%E7%8E%87-IDF"><span class="toc-number">15.3.1.2.</span> <span class="toc-text">逆文档频率 - IDF</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#TF-IDF-1"><span class="toc-number">15.3.1.3.</span> <span class="toc-text">TF-IDF</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BM25"><span class="toc-number">15.3.2.</span> <span class="toc-text">BM25</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%8D%E9%A2%91%E9%A5%B1%E5%92%8C%E5%BA%A6"><span class="toc-number">15.3.2.1.</span> <span class="toc-text">词频饱和度</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%95%BF%E5%BA%A6%E5%BD%92%E4%B8%80%E5%8C%96"><span class="toc-number">15.3.2.2.</span> <span class="toc-text">长度归一化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%92%8CTF-IDF"><span class="toc-number">15.3.2.3.</span> <span class="toc-text">和TF&#x2F;IDF</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%80%A7%E6%9F%A5%E8%AF%A2"><span class="toc-number">15.4.</span> <span class="toc-text">相关性查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8BTF-IDF"><span class="toc-number">15.4.1.</span> <span class="toc-text">查看TF-IDF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Boosting"><span class="toc-number">15.4.2.</span> <span class="toc-text">Boosting</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E9%80%89%E5%8F%82%E6%95%B0"><span class="toc-number">15.4.2.1.</span> <span class="toc-text">可选参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">15.4.2.2.</span> <span class="toc-text">应用场景</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A3%E5%B8%B8%E6%9F%A5%E8%AF%A2"><span class="toc-number">15.4.2.3.</span> <span class="toc-text">正常查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%99%8D%E4%BD%8E%E8%AF%84%E5%88%86-1"><span class="toc-number">15.4.2.4.</span> <span class="toc-text">降低评分</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E6%9F%A5%E8%AF%A2"><span class="toc-number">15.4.3.</span> <span class="toc-text">布尔查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%9F%A5%E8%AF%A2"><span class="toc-number">15.4.3.1.</span> <span class="toc-text">相关查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%B9%E5%BC%8F-1"><span class="toc-number">15.4.3.2.</span> <span class="toc-text">查询方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#bool%E6%9F%A5%E8%AF%A2"><span class="toc-number">15.4.3.3.</span> <span class="toc-text">bool查询</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 小肥龙吃大冰淇淋</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="framework-info"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202301132049386.png"/><span> </span><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/">晋ICP备2022012091号-1</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'pinglun-9gh2lmcnd8587831',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'pinglun-9gh2lmcnd8587831',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/hexo-theme-volantis@latest/source/js/issues.min.js"></script><script src="//code.tidio.co/smwivpnwumemac2wohardi3d3gpud1ag.js" async="async"></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>