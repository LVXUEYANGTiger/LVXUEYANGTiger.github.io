<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Mycat-学习总结 | 小肥龙吃大冰淇淋</title><meta name="keywords" content="mysql,mycat"><meta name="author" content="小肥龙吃大冰淇淋"><meta name="copyright" content="小肥龙吃大冰淇淋"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Mycat 简介Mycat 是一个实现了 MySQL 协议的 Server，前端用户可以把它看作是一个数据库代理，用 MySQL 客户端工具和命令行访问，而其后端可以用 MySQL 原生协议或JDBC 协议与多个 MySQL 服务器通信，其核心功能是分库分表和读写分离，即将一个大表水平分割为 N 个小表，存储在后端 MySQL 服务器里或者其他数据库里。   对于 DBA 来说，可以这么理解 My">
<meta property="og:type" content="article">
<meta property="og:title" content="Mycat-学习总结">
<meta property="og:url" content="https://lvxueyangtiger.github.io/post/19a14fd9.html">
<meta property="og:site_name" content="小肥龙吃大冰淇淋">
<meta property="og:description" content="Mycat 简介Mycat 是一个实现了 MySQL 协议的 Server，前端用户可以把它看作是一个数据库代理，用 MySQL 客户端工具和命令行访问，而其后端可以用 MySQL 原生协议或JDBC 协议与多个 MySQL 服务器通信，其核心功能是分库分表和读写分离，即将一个大表水平分割为 N 个小表，存储在后端 MySQL 服务器里或者其他数据库里。   对于 DBA 来说，可以这么理解 My">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082055.jpg">
<meta property="article:published_time" content="2021-08-06T10:05:00.000Z">
<meta property="article:modified_time" content="2022-11-27T09:16:37.709Z">
<meta property="article:author" content="小肥龙吃大冰淇淋">
<meta property="article:tag" content="mysql">
<meta property="article:tag" content="mycat">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082055.jpg"><link rel="shortcut icon" href="https://lvxueyangboke.oss-cn-beijing.aliyuncs.com/images/20210805191028.png"><link rel="canonical" href="https://lvxueyangtiger.github.io/post/19a14fd9"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Mycat-学习总结',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-27 17:16:37'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/ali_icon.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mogai.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="小肥龙吃大冰淇淋" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">303</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">108</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">73</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082055.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">小肥龙吃大冰淇淋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Mycat-学习总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-08-06T10:05:00.000Z" title="发表于 2021-08-06 18:05:00">2021-08-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-27T09:16:37.709Z" title="更新于 2022-11-27 17:16:37">2022-11-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/mysql/">mysql</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/mysql/mycat/">mycat</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>24分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Mycat-学习总结"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="Mycat-简介"><a href="#Mycat-简介" class="headerlink" title="Mycat 简介"></a>Mycat 简介</h2><p>Mycat 是一个实现了 MySQL 协议的 Server，前端用户可以把它看作是一个数据库代理，用 MySQL 客<br>户端工具和命令行访问，而其后端可以用 MySQL 原生协议或JDBC 协议与多个 MySQL 服务器通信，<br>其核心功能是分库分表和读写分离，即将一个大表水平分割为 N 个小表，存储在后端 MySQL 服务器里<br>或者其他数据库里。 </p>
<ul>
<li><p>对于 DBA 来说，可以这么理解 Mycat<br>  Mycat 就是 MySQL Server，但是Mycat 本身并不存储数据，数据是在后端的 MySQL 上存储的，<br>  因此数据可靠性以及事务等都是 MySQL 保证的。简单的说，Mycat 就是 MySQL 最佳伴侣。</p>
</li>
<li><p>对于软件工程师来说，可以这么理解 Mycat<br>  Mycat 就是一个近似等于 MySQL 的数据库服务器，你可以用连接 MySQL 的方式去连接<br>  Mycat（除了端 口不同，默认的 Mycat 端口是 8066 而非 MySQL 的 3306，因此需要在连接字符<br>  串上增加端口信息），大多数 情况下，可以用你熟悉的对象映射框架使用 Mycat，但建议对于分<br>  片表，尽量使用基础的 SQL 语句，因为这样能 达到最佳性能，特别是几千万甚至几百亿条记录的<br>  情况下。</p>
</li>
<li><p>对于架构师来说，可以这么理解 Mycat<br>  Mycat 是一个强大的数据库中间件，不仅仅可以用作读写分离、以及分表分库、容灾备份，而且<br>  可以用于多 用户应用开发、云平台基础设施、让你的架构具备很强的适应性和灵活性，借助于即<br>  将发布的 Mycat 智能优化模块，系统的数据访问瓶颈和热点一目了然，根据这些统计分析数据，<br>  你可以自动或手工调整后端存储，将不同的 表映射到不同存储引擎上，而整个应用的代码一行也<br>  不用改变。 </p>
</li>
</ul>
<h2 id="Mycat-核心概念"><a href="#Mycat-核心概念" class="headerlink" title="Mycat 核心概念"></a>Mycat 核心概念</h2><h3 id="逻辑库"><a href="#逻辑库" class="headerlink" title="逻辑库"></a>逻辑库</h3><p>对数据进行分片处理之后，从原有的一个库，被切分为多个分片数据库，所有的分片数据库集群构成了<br>整个完整的数据库存储。Mycat在操作时，使用逻辑库来代表这个完整的数据库集群，便于对整个集群<br>操作。 </p>
<h3 id="逻辑表"><a href="#逻辑表" class="headerlink" title="逻辑表"></a>逻辑表</h3><p>既然有逻辑库，那么就会有逻辑表，分布式数据库中，对应用来说，读写数据的表就是逻辑表。 </p>
<h3 id="分片表"><a href="#分片表" class="headerlink" title="分片表"></a>分片表</h3><p>分片表，是指那些原有的很大数据的表，需要切分到多个数据库的表，这样，每个分片都有一部分数<br>据，所 有分片构成了完整的数据。例如在 mycat 配置中的 t_node 就属于分片表，数据按照规则被分<br>到 dn1,dn2 两个分片节点上。 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;table name=&quot;t_node&quot; primaryKey=&quot;vid&quot; autoIncrement=&quot;true&quot; dataNode=&quot;dn1,dn2&quot;</span><br><span class="line">rule=&quot;rule1&quot; /&gt;</span><br></pre></td></tr></table></figure>

<h3 id="非分片表"><a href="#非分片表" class="headerlink" title="非分片表"></a>非分片表</h3><p>一个数据库中并不是所有的表都很大，某些表是可以不用进行切分的，非分片是相对分片表来说的，就<br>是那些不需要进行数据切分的表。如下配置中 t_node，只存在于分片节点dn1上。<br> <code>&lt;table name=&quot;t_node&quot; primaryKey=&quot;vid&quot; autoIncrement=&quot;true&quot; dataNode=&quot;dn1&quot; /&gt; </code></p>
<h3 id="ER表"><a href="#ER表" class="headerlink" title="ER表"></a>ER表</h3><p>Mycat提出了基于 E-R 关系的数据分片策略，子表的记录与所关联的父表记录存放在同一个数据分片<br>上，即子表依赖于父表，通过表分组(Table Group)保证数据 join 不会跨库操作。表分组(Table Group)<br>是解决跨分片数据 join 的一种很好的思路，也是数据切分规划的重要一条规则。 </p>
<h3 id="全局表"><a href="#全局表" class="headerlink" title="全局表"></a>全局表</h3><p>一个真实的业务系统中，往往存在大量的类似字典表的表，这些表基本上很少变动，字典表具有以下几<br>个特性: </p>
<ul>
<li><p>变动不频繁;</p>
</li>
<li><p>数据量总体变化不大;</p>
</li>
<li><p>数据规模不大，很少有超过数十万条记录。 </p>
</li>
</ul>
<p>对于这类的表，在分片的情况下，当业务表因为规模而进行分片以后，业务表与这些附属的字典表之间<br>的关联，就成了比较棘手的问题，所以 Mycat 中通过数据冗余来解决这类表的 join，即所有的分片都有<br>一份数据的拷贝，所有将字典表或者符合字典表特性的一些表定义为全局表。数据冗余是解决跨分片数<br>据 join 的一种很好的思路，也是数据切分规划的另外一条重要规则。 </p>
<h3 id="分片节点"><a href="#分片节点" class="headerlink" title="分片节点"></a>分片节点</h3><p>数据切分后，一个大表被分到不同的分片数据库上面，每个表分片所在的数据库就是分片节点<br>dataNode。 </p>
<h3 id="节点主机"><a href="#节点主机" class="headerlink" title="节点主机"></a>节点主机</h3><p>数据切分后，每个分片节点不一定都会独占一台机器，同一机器上面可以有多个分片数据库， 这样一个<br>或多个分片节点所在的机器就是节点主机，为了规避单节点主机并发数限制， 尽量将读写压力高的分片<br>节点均衡的放在不同的节点主机dataHost。 </p>
<h3 id="分片规则"><a href="#分片规则" class="headerlink" title="分片规则"></a>分片规则</h3><p>前面讲了数据切分，一个大表被分成若干个分片表，就需要一定的规则rule，这样按照某种业务规则把<br>数据分到 某个分片的规则就是分片规则，数据切分选择合适的分片规则非常重要，将极大的避免后续数<br>据处理的难度。 </p>
<h2 id="server-xml配置"><a href="#server-xml配置" class="headerlink" title="server.xml配置"></a>server.xml配置</h2><p>server.xml几乎保存了所有 mycat 需要的系统配置信息。 </p>
<h3 id="user标签"><a href="#user标签" class="headerlink" title="user标签"></a>user标签</h3><p>这个标签主要用于定义登录 mycat 的用户和权限。例如下面的例子中，我们定义了一个用户，用户名<br>为 user、密码也为 user，可访问的 schema为lg_edu_order。 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;user name=&quot;user&quot;&gt;</span><br><span class="line">  &lt;property name=&quot;password&quot;&gt;user&lt;/property&gt;</span><br><span class="line">  &lt;property name=&quot;schemas&quot;&gt;lg_edu_order&lt;/property&gt;</span><br><span class="line">  &lt;property name=&quot;readOnly&quot;&gt;true&lt;/property&gt;</span><br><span class="line">  &lt;property name=&quot;defaultSchema&quot;&gt;lg_edu_order&lt;/property&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure>

<h3 id="firewall标签"><a href="#firewall标签" class="headerlink" title="firewall标签"></a>firewall标签</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;firewall&gt;</span><br><span class="line">  &lt;!-- ip白名单 用户对应的可以访问的 ip 地址 --&gt;</span><br><span class="line">  &lt;whitehost&gt;</span><br><span class="line">    &lt;host host=&quot;127.0.0.*&quot; user=&quot;root&quot;/&gt;</span><br><span class="line">    &lt;host host=&quot;127.0.*&quot; user=&quot;root&quot;/&gt;</span><br><span class="line">    &lt;host host=&quot;127.*&quot; user=&quot;root&quot;/&gt;</span><br><span class="line">    &lt;host host=&quot;1*7.*&quot; user=&quot;root&quot;/&gt;</span><br><span class="line">  &lt;/whitehost&gt;</span><br><span class="line">&lt;!-- 黑名单允许的 权限 后面为默认 --&gt;</span><br><span class="line">&lt;blacklist check=&quot;true&quot;&gt;</span><br><span class="line">  &lt;property name=&quot;selelctAllow&quot;&gt;false&lt;/property&gt;</span><br><span class="line">  &lt;property name=&quot;selelctIntoAllow&quot;&gt;false&lt;/property&gt;</span><br><span class="line">  &lt;property name=&quot;updateAllow&quot;&gt;false&lt;/property&gt;</span><br><span class="line">  &lt;property name=&quot;insertAllow&quot;&gt;false&lt;/property&gt;</span><br><span class="line">  &lt;property name=&quot;deletetAllow&quot;&gt;false&lt;/property&gt;</span><br><span class="line">  &lt;property name=&quot;dropAllow&quot;&gt;false&lt;/property&gt;</span><br><span class="line">&lt;/blacklist&gt;</span><br><span class="line">&lt;/firewall&gt;</span><br></pre></td></tr></table></figure>

<h3 id="全局序列号"><a href="#全局序列号" class="headerlink" title="全局序列号"></a>全局序列号</h3><p>在实现分库分表的情况下，数据库自增主键已无法保证自增主键的全局唯一。为此，Mycat 提供了全局<br>sequence，并且提供了包含本地配置和数据库配置等多种实现方式。 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;system&gt;</span><br><span class="line">    &lt;property name=&quot;sequnceHandlerType&quot;&gt;0&lt;/property&gt;</span><br><span class="line">&lt;/system&gt;</span><br></pre></td></tr></table></figure>

<p>0表示使用本地文件方式；1表示使用数据库方式生成；2表示使用本地时间戳方式；3表示基于ZK与本<br>地配置的分布式ID生成器；4表示使用zookeeper递增方式生成</p>
<h4 id="本地文件"><a href="#本地文件" class="headerlink" title="本地文件"></a>本地文件</h4><p>此方式 Mycat 将 sequence 配置到文件中，当使用到 sequence 中的配置后，Mycat 会更下 classpath<br>中的 sequence_conf.properties 文件中 sequence 当前的值。 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#default global sequence</span><br><span class="line">GLOBAL.HISIDS=</span><br><span class="line">GLOBAL.MINID=10001</span><br><span class="line">GLOBAL.MAXID=20000</span><br><span class="line">GLOBAL.CURID=10000</span><br><span class="line"># self define sequence</span><br><span class="line">COMPANY.HISIDS=</span><br><span class="line">COMPANY.MINID=1001</span><br><span class="line">COMPANY.MAXID=2000</span><br><span class="line">COMPANY.CURID=1000</span><br><span class="line">ORDER.HISIDS=</span><br><span class="line">ORDER.MINID=1001</span><br><span class="line">ORDER.MAXID=2000</span><br><span class="line">ORDER.CURID=1000</span><br></pre></td></tr></table></figure>

<h4 id="数据库方式"><a href="#数据库方式" class="headerlink" title="数据库方式"></a>数据库方式</h4><p>在数据库中建立一张表，存放 sequence 名称（name），sequence 当前值（current_value），步长<br>（increment） 等信息。 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE MYCAT_SEQUENCE</span><br><span class="line">(</span><br><span class="line">  name VARCHAR(64) NOT NULL,</span><br><span class="line">  current_value BIGINT(20) NOT NULL,</span><br><span class="line">  increment INT NOT NULL DEFAULT 1,</span><br><span class="line">  PRIMARY KEY (name)</span><br><span class="line">) ENGINE = InnoDB;</span><br></pre></td></tr></table></figure>

<h4 id="本地时间戳方式"><a href="#本地时间戳方式" class="headerlink" title="本地时间戳方式"></a>本地时间戳方式</h4><p>ID为64 位二进制 ，42（毫秒）+5（机器 ID）+5（业务编码）+12（重复累加）<br>换算成十进制为 18 位数的 long 类型，每毫秒可以并发 12 位二进制的累加。<br>在 Mycat 下配置sequence_time_conf.properties文件 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WORKID=0-31 任意整数</span><br><span class="line">DATAACENTERID=0-31 任意整数</span><br></pre></td></tr></table></figure>

<p>每个Mycat 配置的 WORKID、DATAACENTERID 不同，组成唯一标识，总共支持32*32=1024 种组合。 </p>
<h4 id="分布式-ZK-ID-生成器"><a href="#分布式-ZK-ID-生成器" class="headerlink" title="分布式 ZK ID 生成器"></a>分布式 ZK ID 生成器</h4><p>Zk 的连接信息统一在 myid.properties 的 zkURL 属性中配置。基于 ZK 与本地配置的分布式 ID 生成<br>器，InstanceID可以通过ZK自动获取，也可以通过配置文件配置。在<br>sequence_distributed_conf.properties，只要配置INSTANCEID=ZK就表示从 ZK 上获取 InstanceID。<br>ID 最大为63位二进制，可以承受单机房单机器单线程 1000*(2^6)=640000 的并发。结构如下 </p>
<ul>
<li><p>current time millis（微秒时间戳 38 位，可以使用 17 年）</p>
</li>
<li><p>clusterId（机房或者 ZKid，通过配置文件配置，5 位）</p>
</li>
<li><p>instanceId（实例 ID，可以通过 ZK 或者配置文件获取，5 位）</p>
</li>
<li><p>threadId（线程 ID，9 位）</p>
</li>
<li><p>increment（自增，6 位） </p>
</li>
</ul>
<h4 id="ZK-递增方式"><a href="#ZK-递增方式" class="headerlink" title="ZK 递增方式"></a>ZK 递增方式</h4><p>Zk 的连接信息统一在 myid.properties 的 zkURL 属性中配置。需要配置sequence_conf.properties文<br>件</p>
<ul>
<li><p>TABLE.MINID 某线程当前区间内最小值</p>
</li>
<li><p>TABLE.MAXID 某线程当前区间内最大值</p>
</li>
<li><p>TABLE.CURID 某线程当前区间内当前值  </p>
</li>
</ul>
<h2 id="schema-xml配置"><a href="#schema-xml配置" class="headerlink" title="schema.xml配置"></a>schema.xml配置</h2><p>schema.xml 作为 Mycat 中重要的配置文件之一，管理着 Mycat 的逻辑库、表、分片节点、主机等信<br>息。 </p>
<h3 id="schema标签"><a href="#schema标签" class="headerlink" title="schema标签"></a>schema标签</h3><p>schema 标签用于定义 Mycat 实例中的逻辑库，Mycat 可以有多个逻辑库，每个逻辑库都有自己的相关<br>配 置。可以使用 schema 标签来划分这些不同的逻辑库。 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- 逻辑库 --&gt;</span><br><span class="line">&lt;schema name=&quot;lg_edu_order&quot; checkSQLschema=&quot;true&quot; sqlMaxLimit=&quot;100&quot;</span><br><span class="line">dataNode=&quot;dn1&quot;&gt;&lt;/schema&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>属性名</th>
<th>值</th>
<th>数量限制</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>dataNode</td>
<td>任意String</td>
<td>(0..1)</td>
<td>分片节点</td>
</tr>
<tr>
<td>sqlMaxLimit</td>
<td>Integer</td>
<td>(1)</td>
<td>查询返回的记录数限制limit</td>
</tr>
<tr>
<td>checkSQLschema</td>
<td>Boolean</td>
<td>(1)</td>
<td>是否去表库名</td>
</tr>
</tbody></table>
<h3 id="table标签"><a href="#table标签" class="headerlink" title="table标签"></a>table标签</h3><p>table标签定义了 Mycat 中的逻辑表，所有需要拆分的表都需要在这个标签中定义 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;table name=&quot;b_order&quot; dataNode=&quot;dn1,dn2&quot; rule=&quot;b_order_rule&quot; primaryKey=&quot;ID&quot;</span><br><span class="line">autoIncrement=&quot;true&quot;/&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>属性</th>
<th>值</th>
<th>数量限制</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>String</td>
<td>(1)</td>
<td>逻辑表名</td>
</tr>
<tr>
<td>dataNode</td>
<td>String</td>
<td>(1..*)</td>
<td>分片节点</td>
</tr>
<tr>
<td>rule</td>
<td>String</td>
<td>(0..1)</td>
<td>分片规则</td>
</tr>
<tr>
<td>ruleRequired</td>
<td>Boolean</td>
<td>(0..1)</td>
<td>是否强制绑定分片规则</td>
</tr>
<tr>
<td>primaryKey</td>
<td>String</td>
<td>(1)</td>
<td>主键</td>
</tr>
<tr>
<td>type</td>
<td>String</td>
<td>(0..1)</td>
<td>逻辑表类型，全局表、普通表</td>
</tr>
<tr>
<td>autoIncrement</td>
<td>Boolean</td>
<td>(0..1)</td>
<td>自增长主键</td>
</tr>
<tr>
<td>subTables</td>
<td>String</td>
<td>(1)</td>
<td>分表</td>
</tr>
<tr>
<td>needAddLimit</td>
<td>Boolean</td>
<td>(0..1)</td>
<td>是否为查询SQL自动加limit限制</td>
</tr>
</tbody></table>
<h3 id="dataNode标签"><a href="#dataNode标签" class="headerlink" title="dataNode标签"></a>dataNode标签</h3><p>dataNode标签定义了 MyCat 中的分片节点，也就是我们通常说所的数据分片。 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- 数据节点 --&gt;</span><br><span class="line">&lt;dataNode name=&quot;dn1&quot; dataHost=&quot;lg_edu_order_1&quot; database=&quot;lg_edu_order_1&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>name： 定义数据节点的名字，这个名字需要是唯一的，我们需要在 table 标签上应用这个名字，来建<br>立表与分片对应的关系。<br>dataHost : 用于定义该分片属于哪个分片主机，属性值是引用 dataHost 标签上定义的 name 属性。<br>database： 用于定义该分片节点属于哪个具体的库。 </p>
<h3 id="dataHost标签"><a href="#dataHost标签" class="headerlink" title="dataHost标签"></a>dataHost标签</h3><p>dataHost标签在 Mycat 逻辑库中也是作为最底层的标签存在，直接定义了具体的数据库实例、读写分<br>离配置和心跳语句 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dataHost name=&quot;lg_edu_order_1&quot; maxCon=&quot;100&quot; minCon=&quot;10&quot; balance=&quot;0&quot;</span><br><span class="line">writeType=&quot;0&quot; dbType=&quot;mysql&quot; dbDriver=&quot;native&quot; switchType=&quot;1&quot;</span><br><span class="line">slaveThreshold=&quot;100&quot;&gt;</span><br><span class="line">&lt;/dataHost&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>属性</th>
<th>值</th>
<th>数量限制</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>String</td>
<td>(1)</td>
<td>节点主机名</td>
</tr>
<tr>
<td>maxCon</td>
<td>Integer</td>
<td>(1)</td>
<td>最大连接数</td>
</tr>
<tr>
<td>minCon</td>
<td>Integer</td>
<td>(1)</td>
<td>最小连接数</td>
</tr>
<tr>
<td>balance</td>
<td>Integer</td>
<td>(1)</td>
<td>读操作负载均衡类型</td>
</tr>
<tr>
<td>writeType</td>
<td>Integer</td>
<td>(1)</td>
<td>写操作负载均衡类型</td>
</tr>
<tr>
<td>dbType</td>
<td>String</td>
<td>(1)</td>
<td>数据库类型</td>
</tr>
<tr>
<td>dbDriver</td>
<td>String</td>
<td>(1)</td>
<td>数据库驱动</td>
</tr>
<tr>
<td>switchType</td>
<td>String</td>
<td>(1)</td>
<td>主从切换类型</td>
</tr>
</tbody></table>
<h3 id="heartbeat标签"><a href="#heartbeat标签" class="headerlink" title="heartbeat标签"></a>heartbeat标签</h3><p>heartbeat标签内指明用于和后端数据库进行心跳检查的语句。例如：MySQL 可以使用 select user()、<br>Oracle 可以 使用 select 1 from dual 等 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dataHost&gt;</span><br><span class="line">  &lt;heartbeat&gt;select user()&lt;/heartbeat&gt;</span><br><span class="line">&lt;/dataHost&gt;</span><br></pre></td></tr></table></figure>

<h3 id="writeHost和readHost标签"><a href="#writeHost和readHost标签" class="headerlink" title="writeHost和readHost标签"></a>writeHost和readHost标签</h3><p>writeHost和readHost标签都指定后端数据库的相关配置给 mycat，用于实例化后端连接池。唯一不同<br>的是，writeHost 指定写实例、readHost 指定读实例。在一个 dataHost 内可以定义多个 writeHost 和<br>readHost。但是，如果 writeHost 指定的后端数据库宕机， 那么这个 writeHost 绑定的所有 readHost<br>都将不可用。另一方面，由于这个 writeHost 宕机系统会自动的检测 到，并切换到备用的 writeHost<br>上去。 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dataHost name=&quot;lg_edu_order_2&quot; maxCon=&quot;100&quot; minCon=&quot;10&quot; balance=&quot;0&quot;</span><br><span class="line">  writeType=&quot;0&quot; dbType=&quot;mysql&quot; dbDriver=&quot;native&quot; switchType=&quot;1&quot;</span><br><span class="line">  slaveThreshold=&quot;100&quot;&gt;</span><br><span class="line">  &lt;heartbeat&gt;select user()&lt;/heartbeat&gt;</span><br><span class="line">  &lt;writeHost host=&quot;M1&quot; url=&quot;192.168.95.133:3306&quot; user=&quot;root&quot; password=&quot;1234&quot;&gt;</span><br><span class="line">  &lt;/writeHost&gt;</span><br><span class="line">&lt;/dataHost&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>属性</th>
<th>值</th>
<th>数量限制</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>host</td>
<td>String</td>
<td>(1)</td>
<td>主机名</td>
</tr>
<tr>
<td>url</td>
<td>String</td>
<td>(1)</td>
<td>连接字符串</td>
</tr>
<tr>
<td>password</td>
<td>String</td>
<td>(1)</td>
<td>密码</td>
</tr>
<tr>
<td>user</td>
<td>String</td>
<td>(1)</td>
<td>用户名</td>
</tr>
<tr>
<td>weight</td>
<td>String</td>
<td>(1)</td>
<td>权重</td>
</tr>
<tr>
<td>usingDecrypt</td>
<td>String</td>
<td>(1)</td>
<td>是否对密码加密，默认0</td>
</tr>
</tbody></table>
<h2 id="rule-xml配置"><a href="#rule-xml配置" class="headerlink" title="rule.xml配置"></a>rule.xml配置</h2><p>rule.xml用于定义Mycat的分片规则 </p>
<h3 id="tableRule标签"><a href="#tableRule标签" class="headerlink" title="tableRule标签"></a>tableRule标签</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;tableRule name=&quot;c_order_rule&quot;&gt;</span><br><span class="line">  &lt;rule&gt;</span><br><span class="line">  &lt;columns&gt;user_id&lt;/columns&gt;</span><br><span class="line">  &lt;algorithm&gt;partitionByOrderFunc&lt;/algorithm&gt;</span><br><span class="line">  &lt;/rule&gt;</span><br><span class="line">&lt;/tableRule&gt;</span><br></pre></td></tr></table></figure>

<p>name：指定唯一的名字，用于标识不同的表规则。<br>columns：指定要拆分的列名字。<br>algorithm：使用 function 标签中的 name 属性，连接表规则和具体路由算法。 </p>
<h3 id="function标签"><a href="#function标签" class="headerlink" title="function标签"></a>function标签</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;function name=&quot;partitionByOrderFunc&quot;</span><br><span class="line">class=&quot;io.mycat.route.function.PartitionByMod&quot;&gt;</span><br><span class="line">&lt;property name=&quot;count&quot;&gt;2&lt;/property&gt;</span><br><span class="line">&lt;/function&gt;</span><br></pre></td></tr></table></figure>

<p>name：指定算法的名字。<br>class：制定路由算法具体的类名字。<br>property： 为具体算法需要用到的一些属性。 </p>
<h2 id="Mycat实战"><a href="#Mycat实战" class="headerlink" title="Mycat实战"></a>Mycat实战</h2><h3 id="Mycat安装"><a href="#Mycat安装" class="headerlink" title="Mycat安装"></a>Mycat安装</h3><p>提示：需要先安装jdk </p>
<ul>
<li><p>下载Mycat-server工具包</p>
</li>
<li><p>解压Mycat工具包<br>   <code>tar -zxvf Mycat-server-1.6.7.5-release-20200410174409-linux.tar.gz </code></p>
</li>
<li><p>进入mycat/bin，启动Mycat </p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">启动命令：./mycat start</span><br><span class="line">停止命令：./mycat stop</span><br><span class="line">重启命令：./mycat restart</span><br><span class="line">查看状态：./mycat status</span><br></pre></td></tr></table></figure>

<ul>
<li>访问Mycat<br>   <code>mysql -uroot -proot -h127.0.0.1 -P8066 </code></li>
</ul>
<h3 id="分库分表"><a href="#分库分表" class="headerlink" title="分库分表"></a>分库分表</h3><p>在rule.xml配置Mycat分库分表。 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;mycat:rule xmlns:mycat=&quot;http://io.mycat/&quot;&gt;</span><br><span class="line">&lt;tableRule name=&quot;b_order_rule&quot;&gt;</span><br><span class="line">&lt;rule&gt;</span><br><span class="line">&lt;columns&gt;company_id&lt;/columns&gt;</span><br><span class="line">&lt;algorithm&gt;partitionByOrderFunc&lt;/algorithm&gt;</span><br><span class="line">&lt;/rule&gt;</span><br><span class="line">&lt;/tableRule&gt;</span><br><span class="line">&lt;!-- 路由函数定义 --&gt;</span><br><span class="line">&lt;function name=&quot;partitionByOrderFunc&quot;</span><br><span class="line">class=&quot;io.mycat.route.function.PartitionByMod&quot;&gt;</span><br><span class="line">&lt;property name=&quot;count&quot;&gt;2&lt;/property&gt;</span><br><span class="line">&lt;/function&gt;</span><br><span class="line">&lt;/mycat:rule&gt;</span><br></pre></td></tr></table></figure>

<p>Mycat常用分片规则如下： </p>
<ul>
<li><p>时间类：按天分片、自然月分片、单月小时分片</p>
</li>
<li><p>哈希类：Hash固定分片、日期范围Hash分片、截取数字Hash求模范围分片、截取数字Hash分<br>  片、一致性Hash分片</p>
</li>
<li><p>取模类：取模分片、取模范围分片、范围求模分片</p>
</li>
<li><p>其他类：枚举分片、范围约定分片、应用指定分片、冷热数据分片</p>
</li>
</ul>
<p>Mycat常用分片配置示例：</p>
<ul>
<li>自动分片 </li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;tableRule name=&quot;auto-sharding-long&quot;&gt;</span><br><span class="line">&lt;rule&gt;</span><br><span class="line">&lt;columns&gt;id&lt;/columns&gt;</span><br><span class="line">&lt;algorithm&gt;rang-long&lt;/algorithm&gt;</span><br><span class="line">&lt;/rule&gt;</span><br><span class="line">&lt;/tableRule&gt;</span><br><span class="line">&lt;function name=&quot;rang-long&quot;</span><br><span class="line">class=&quot;io.mycat.route.function.AutoPartitionByLong&quot;&gt;</span><br><span class="line">&lt;property name=&quot;mapFile&quot;&gt;autopartition-long.txt&lt;/property&gt;</span><br><span class="line">&lt;/function&gt;</span><br></pre></td></tr></table></figure>

<p>autopartition-long.txt文件内容如下： </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># range start-end ,data node index</span><br><span class="line"># K=1000,M=10000.</span><br><span class="line">0-500M=0</span><br><span class="line">500M-1000M=1</span><br><span class="line">1000M-1500M=2</span><br></pre></td></tr></table></figure>

<p>枚举分片<br>把数据分类存储。 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;tableRule name=&quot;sharding-by-intfile&quot;&gt;</span><br><span class="line">&lt;rule&gt;</span><br><span class="line">&lt;columns&gt;sharding_id&lt;/columns&gt;</span><br><span class="line">&lt;algorithm&gt;hash-int&lt;/algorithm&gt;</span><br><span class="line">&lt;/rule&gt;</span><br><span class="line">&lt;/tableRule&gt;</span><br><span class="line">&lt;function name=&quot;hash-int&quot;</span><br><span class="line">class=&quot;io.mycat.route.function.PartitionByFileMap&quot;&gt;</span><br><span class="line">&lt;property name=&quot;mapFile&quot;&gt;partition-hash-int.txt&lt;/property&gt;</span><br><span class="line">&lt;!-- 找不到分片时设置容错规则，把数据插入到默认分片0里面 --&gt;</span><br><span class="line">&lt;property name=&quot;defaultNode&quot;&gt;0&lt;/property&gt;</span><br><span class="line">&lt;/function&gt;</span><br></pre></td></tr></table></figure>

<p>partition-hash-int.txt文件内容如下： </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">10000=0</span><br><span class="line">10010=1</span><br></pre></td></tr></table></figure>

<p>取模分片<br>根据分片字段值 % 分片数 。 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;tableRule name=&quot;mod-long&quot;&gt;</span><br><span class="line">&lt;rule&gt;</span><br><span class="line">&lt;columns&gt;id&lt;/columns&gt;</span><br><span class="line">&lt;algorithm&gt;mod-long&lt;/algorithm&gt;</span><br><span class="line">&lt;/rule&gt;</span><br><span class="line">&lt;/tableRule&gt;</span><br><span class="line">&lt;function name=&quot;mod-long&quot; class=&quot;io.mycat.route.function.PartitionByMod&quot;&gt;</span><br><span class="line">&lt;!--分片数 --&gt;</span><br><span class="line">&lt;property name=&quot;count&quot;&gt;3&lt;/property&gt;</span><br><span class="line">&lt;/function&gt;</span><br></pre></td></tr></table></figure>

<p>冷热数据分片<br>根据日期查询日志数据冷热数据分布 ，最近 n 个月的到实时交易库查询，超过 n 个月的按照 m 天<br>分片。 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;tableRule name=&quot;sharding-by-date&quot;&gt;</span><br><span class="line">&lt;rule&gt;</span><br><span class="line">&lt;columns&gt;create_time&lt;/columns&gt;</span><br><span class="line">&lt;algorithm&gt;sharding-by-hotdate&lt;/algorithm&gt;</span><br><span class="line">&lt;/rule&gt;</span><br><span class="line">&lt;/tableRule&gt;</span><br><span class="line">&lt;function name=&quot;sharding-by-hotdate&quot;</span><br><span class="line">class=&quot;org.opencloudb.route.function.PartitionByHotDate&quot;&gt;</span><br><span class="line">&lt;!-- 定义日期格式 --&gt;</span><br><span class="line">&lt;property name=&quot;dateFormat&quot;&gt;yyyy-MM-dd&lt;/property&gt;</span><br><span class="line">&lt;!-- 热库存储多少天数据 --&gt;</span><br><span class="line">&lt;property name=&quot;sLastDay&quot;&gt;30&lt;/property&gt;</span><br><span class="line">&lt;!-- 超过热库期限的数据按照多少天来分片 --&gt;</span><br><span class="line">&lt;property name=&quot;sPartionDay&quot;&gt;30&lt;/property&gt;</span><br><span class="line">&lt;/function&gt;</span><br></pre></td></tr></table></figure>

<p>一致性哈希分片 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;tableRule name=&quot;sharding-by-murmur&quot;&gt;</span><br><span class="line">&lt;rule&gt;</span><br><span class="line">&lt;columns&gt;id&lt;/columns&gt;</span><br><span class="line">&lt;algorithm&gt;murmur&lt;/algorithm&gt;</span><br><span class="line">&lt;/rule&gt;</span><br><span class="line">&lt;/tableRule&gt;</span><br><span class="line">&lt;function name=&quot;murmur&quot;</span><br><span class="line">class=&quot;io.mycat.route.function.PartitionByMurmurHash&quot;&gt;</span><br><span class="line">&lt;property name=&quot;seed&quot;&gt;0&lt;/property&gt;&lt;!-- 默认是0 --&gt;</span><br><span class="line">&lt;property name=&quot;count&quot;&gt;2&lt;/property&gt;&lt;!-- 要分片的数据库节点数量，必须指定，否</span><br><span class="line">则没法分片 --&gt;</span><br><span class="line">&lt;property name=&quot;virtualBucketTimes&quot;&gt;160&lt;/property&gt;&lt;!-- 一个实际的数据库节点</span><br><span class="line">被映射为这么多虚拟节点，默认是160倍，也就是虚拟节点数是物理节点数的160倍 --&gt;</span><br><span class="line">&lt;!-- &lt;property name=&quot;weightMapFile&quot;&gt;weightMapFile&lt;/property&gt; 节点的权重，</span><br><span class="line">没有指定权重的节点默认是1。以properties文件的格式填写，以从0开始到count-1的整数值也就</span><br><span class="line">是节点索引为key，以节点权重值为值。所有权重值必须是正整数，否则以1代替 --&gt;</span><br><span class="line">&lt;!-- &lt;property name=&quot;bucketMapPath&quot;&gt;/etc/mycat/bucketMapPath&lt;/property&gt;</span><br><span class="line">用于测试时观察各物理节点与虚拟节点的分布情况，如果指定了这个属性，会把虚拟节点的</span><br><span class="line">murmur hash值与物理节点的映射按行输出到这个文件，没有默认值，如果不指定，就不会输出任何</span><br><span class="line">东西 --&gt;</span><br><span class="line">&lt;/function&gt;</span><br></pre></td></tr></table></figure>

<h3 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h3><p>在schema.xml文件中配置Mycat读写分离。使用前需要搭建MySQL主从架构，并实现主从复制，<br>Mycat不负数据同步问题。 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dataHost name=&quot;localhost1&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;1&quot; writeType=&quot;0&quot;</span><br><span class="line">dbType=&quot;mysql&quot; dbDriver=&quot;native&quot;&gt;</span><br><span class="line">&lt;heartbeat&gt;select user()&lt;/heartbeat&gt;</span><br><span class="line">&lt;!-- can have multi write hosts --&gt;</span><br><span class="line">&lt;writeHost host=&quot;M1&quot; url=&quot;localhost:3306&quot; user=&quot;root&quot; password=&quot;123456&quot;&gt;</span><br><span class="line">&lt;readHost host=&quot;S1&quot; url=&quot;localhost:3307&quot; user=&quot;root&quot; password=&quot;123456&quot;</span><br><span class="line">weight=&quot;1&quot; /&gt;</span><br><span class="line">&lt;/writeHost&gt;</span><br><span class="line">&lt;/dataHost&gt;</span><br></pre></td></tr></table></figure>

<p>balance参数：<br>0 ： 所有读操作都发送到当前可用的writeHost<br>1 ：所有读操作都随机发送到readHost和stand by writeHost<br>2 ：所有读操作都随机发送到writeHost和readHost<br>3 ：所有读操作都随机发送到writeHost对应的readHost上，但是writeHost不负担读压力<br>writeType参数：<br>0 ： 所有写操作都发送到可用的writeHost<br>1 ：所有写操作都随机发送到readHost<br>2 ：所有写操作都随机发送到writeHost，readHost<br> 或者 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dataHost name=&quot;localhost1&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;1&quot; writeType=&quot;0&quot;</span><br><span class="line">dbType=&quot;mysql&quot; dbDriver=&quot;native&quot;&gt;</span><br><span class="line">&lt;heartbeat&gt;select user()&lt;/heartbeat&gt;</span><br><span class="line">&lt;!-- can have multi write hosts --&gt;</span><br><span class="line">&lt;writeHost host=&quot;M1&quot; url=&quot;localhost:3306&quot; user=&quot;root&quot; password=&quot;123456&quot;&gt;</span><br><span class="line">&lt;/writeHost&gt;</span><br><span class="line">&lt;writeHost host=&quot;S1&quot; url=&quot;localhost:3307&quot; user=&quot;root&quot; password=&quot;123456&quot;&gt;</span><br><span class="line">&lt;/writeHost&gt;</span><br><span class="line">&lt;/dataHost&gt;</span><br></pre></td></tr></table></figure>

<p>以上两种取模第一种当写挂了读不可用，第二种可以继续使用，事务内部的一切操作都会走写节点，所<br>以读操作不要加事务，如果读延时较大，使用根据主从延时切换的读写分离，或者强制走写节点 </p>
<h3 id="强制路由"><a href="#强制路由" class="headerlink" title="强制路由"></a>强制路由</h3><p>一个查询 SQL 语句以/* !mycat * /注解来确定其是走读节点还是写节点。<br>/<em>! <em>/<br>/</em># <em>/<br>/</em></em> */ </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">强制走从:</span><br><span class="line">/*!mycat:db_type=slave*/ select * from travelrecord //有效</span><br><span class="line">/*#mycat:db_type=slave*/ select * from travelrecord</span><br><span class="line">强制走写:</span><br><span class="line">/*!mycat:db_type=master*/ select * from travelrecord //有效</span><br><span class="line">/*#mycat:db_type=slave*/ select * from travelrecord</span><br></pre></td></tr></table></figure>

<p>1.6 以后Mycat除了支持db_type注解以外，还有其他注解，如下： </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/*!mycat:sql=sql */ 指定真正执行的SQL</span><br><span class="line">/*!mycat:schema=schema1 */ 指定走那个schema</span><br><span class="line">/*!mycat:datanode=dn1 */ 指定sql要运行的节点</span><br><span class="line">/*!mycat:catlet=io.mycat.catlets.ShareJoin */ 通过catlet支持跨分片复杂SQL实现以及存</span><br><span class="line">储过程支持等</span><br></pre></td></tr></table></figure>

<h3 id="主从延时切换"><a href="#主从延时切换" class="headerlink" title="主从延时切换"></a>主从延时切换</h3><p>switchType参数：<br> -1： 表示不自动切换<br>1 ：表示自动切换<br>2 ：基于MySQL主从同步状态决定是否切换 </p>
<p>3 ：基于MySQL cluster集群切换机制<br> 1.4 开始支持 MySQL 主从复制状态绑定的读写分离机制，让读更加安全可靠，配置如下:<br>MyCAT 心跳检查语句配置为 show slave status ，dataHost 上定义两个新属性: switchType=”2” 与<br>slaveThreshold=”100”，此时意味着开启 MySQL 主从复制状态绑定的读写分离与切换机制，Mycat 心<br>跳机 制通过检测 show slave status 中的 “Seconds_Behind_Master”, “Slave_IO_Running”,<br>“Slave_SQL_Running” 三个字段来确定当前主从同步的状态以及 Seconds_Behind_Master 主从复制时<br>延， 当 Seconds_Behind_Master &gt; slaveThreshold 时，读写分离筛选器会过滤掉此 Slave 机器，防止<br>读到很久之 前的旧数据，而当主节点宕机后，切换逻辑会检查 Slave 上的 Seconds_Behind_Master 是<br>否为 0，为 0 时则 表示主从同步，可以安全切换，否则不会切换。 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dataHost name=&quot;localhost1&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;0&quot; writeType=&quot;0&quot;</span><br><span class="line">dbType=&quot;mysql&quot; dbDriver=&quot;native&quot; switchType=&quot;2&quot; slaveThreshold=&quot;100&quot;&gt;</span><br><span class="line">&lt;heartbeat&gt;show slave status &lt;/heartbeat&gt;</span><br><span class="line">&lt;!-- can have multi write hosts --&gt;</span><br><span class="line">&lt;writeHost host=&quot;M1&quot; url=&quot;localhost:3306&quot; user=&quot;root&quot; password=&quot;123456&quot;&gt;</span><br><span class="line">&lt;/writeHost&gt;</span><br><span class="line">&lt;writeHost host=&quot;S1&quot; url=&quot;localhost:3316&quot; user=&quot;root&quot;</span><br><span class="line">&lt;/dataHost&gt;</span><br></pre></td></tr></table></figure>

<p>1.4.1 开始支持 MySQL 集群模式，让读更加安全可靠，配置如下: MyCAT 心跳检查语句配置为 show<br>status like ‘wsrep%’ ，dataHost 上定义两个新属性: switchType=”3”<br>此时意味着开启 MySQL 集群复制状态状态绑定的读写分离与切换机制，Mycat 心跳机制通过检测集群<br>复制时延时，如果延时过大或者集群出现节点问题不会负载改节点。 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dataHost name=&quot;localhost1&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;0&quot; writeType=&quot;0&quot;</span><br><span class="line">dbType=&quot;mysql&quot; dbDriver=&quot;native&quot; switchType=&quot;3&quot; &gt;</span><br><span class="line">&lt;heartbeat&gt; show status like ‘wsrep%’&lt;/heartbeat&gt;</span><br><span class="line">&lt;writeHost host=&quot;M1&quot; url=&quot;localhost:3306&quot; user=&quot;root&quot;password=&quot;123456&quot;&gt;</span><br><span class="line">&lt;/writeHost&gt;</span><br><span class="line">&lt;writeHost host=&quot;S1&quot;url=&quot;localhost:3316&quot;user=&quot;root&quot;password=&quot;123456&quot; &gt;</span><br><span class="line">&lt;/writeHost&gt;</span><br><span class="line">&lt;/dataHost&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Mycat事务"><a href="#Mycat事务" class="headerlink" title="Mycat事务"></a>Mycat事务</h2><h3 id="Mycat-数据库事务"><a href="#Mycat-数据库事务" class="headerlink" title="Mycat 数据库事务"></a>Mycat 数据库事务</h3><p>Mycat 目前没有出来跨分片的事务强一致性支持，单库内部可以保证事务的完整性，如果跨库事务，<br>在执行的时候任何分片出错，可以保证所有分片回滚，但是一旦应用发起 commit 指令，无法保证所有<br>分片都成功，考虑到某个分片挂的可能性不大所以称为弱 XA。 </p>
<h3 id="XA-事务使用"><a href="#XA-事务使用" class="headerlink" title="XA 事务使用"></a>XA 事务使用</h3><p>Mycat 从 1.6.5 版本开始支持标准 XA 分布式事务，考虑到 MySQL 5.7 之前版本XA有bug，所以推荐最<br>佳搭配 XA 功能使用 MySQL 5.7 版本。<br>Mycat 实现 XA 标准分布式事务，Mycat 作为XA 事务协调者角色，即使事务过程中 Mycat 宕机挂掉，<br>由于 Mycat 会记录事务日志，所以 Mycat 恢复后会进行事务的恢复善后处理工作。考虑到分布式事务<br>的性能开销比较大，所以只推荐在全局表的事务以及其他一些对一致性要 求比较高的场景。<br>使用示例:<br>XA 操作说明 </p>
<ul>
<li>XA 事务需要设置手动提交 </li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set autocommit=0; </span><br></pre></td></tr></table></figure>

<ul>
<li><p>使用该命令开启 XA 事务<br>   <code>set xa=on; </code></p>
</li>
<li><p>执行相应的 SQL 语句部分<br>  <code>insert into city(id,name,province) values(200,&#39;chengdu&#39;,&#39;sichuan&#39;);update position set salary=&#39;300000&#39; where id&lt;5; </code></p>
</li>
<li><p>提交或回滚事务 </p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">commit；</span><br><span class="line">rollback;</span><br></pre></td></tr></table></figure>

<h3 id="保证Repeatable-Read"><a href="#保证Repeatable-Read" class="headerlink" title="保证Repeatable Read"></a>保证Repeatable Read</h3><p>mycat 有一个特性，就是开事务之后，如果不运行 update/delete/select for update 等更新类语句<br>SQL 的话，不会将当前连接与当前 session 绑定。如下图所示:<br> <img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210713110422.png" alt="img"></p>
<p>这样做的好处是可以保证连接可以最大限度的复用，提升性能。<br>但是,这就会导致两次 select 中如果有其它的在提交的话，会出现两次同样的 select 不一 致的现象,即不<br>能 Repeatable Read，这会让人直连 MySQL 的人很困惑,可能会在依赖 Repeatable Read 的场景出现<br>问题。所以做了一个开关,当 server.xml 的 system 配置了 strictTxIsolation=true 的时候，会关掉这个<br>特性，以保证 repeatable read,加了开关 后如下图所示: </p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210713110436.png" alt="image-20210713110436490"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">小肥龙吃大冰淇淋</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lvxueyangtiger.github.io/post/19a14fd9.html">https://lvxueyangtiger.github.io/post/19a14fd9.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lvxueyangtiger.github.io" target="_blank">小肥龙吃大冰淇淋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/mysql/">mysql</a><a class="post-meta__tags" href="/tags/mycat/">mycat</a></div><div class="post_share"><div class="social-share" data-image="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082055.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/4d69c88c.html"><img class="prev-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082231.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MySQL-运维和第三方工具</div></div></a></div><div class="next-post pull-right"><a href="/post/718ce14b.html"><img class="next-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20210806165214.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">分库分表以及ShardingSphere实战</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/263da724.html" title="MySQL-基础"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082319.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-06</div><div class="title">MySQL-基础</div></div></a></div><div><a href="/post/5e688f23.html" title="MySQL事务和锁"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212110.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-06</div><div class="title">MySQL事务和锁</div></div></a></div><div><a href="/post/4d69c88c.html" title="MySQL-运维和第三方工具"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082231.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-06</div><div class="title">MySQL-运维和第三方工具</div></div></a></div><div><a href="/post/2e4d969f.html" title="MySQL8其它新特性"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082219.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-06</div><div class="title">MySQL8其它新特性</div></div></a></div><div><a href="/post/a5cc1cf3.html" title="MySQL单行函数"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082231.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-06</div><div class="title">MySQL单行函数</div></div></a></div><div><a href="/post/18d8d4e.html" title="MySQL性能优化"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082302.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-06</div><div class="title">MySQL性能优化</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Mycat-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">Mycat 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mycat-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">2.</span> <span class="toc-text">Mycat 核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E5%BA%93"><span class="toc-number">2.1.</span> <span class="toc-text">逻辑库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E8%A1%A8"><span class="toc-number">2.2.</span> <span class="toc-text">逻辑表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E8%A1%A8"><span class="toc-number">2.3.</span> <span class="toc-text">分片表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E5%88%86%E7%89%87%E8%A1%A8"><span class="toc-number">2.4.</span> <span class="toc-text">非分片表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ER%E8%A1%A8"><span class="toc-number">2.5.</span> <span class="toc-text">ER表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E8%A1%A8"><span class="toc-number">2.6.</span> <span class="toc-text">全局表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E8%8A%82%E7%82%B9"><span class="toc-number">2.7.</span> <span class="toc-text">分片节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E4%B8%BB%E6%9C%BA"><span class="toc-number">2.8.</span> <span class="toc-text">节点主机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E8%A7%84%E5%88%99"><span class="toc-number">2.9.</span> <span class="toc-text">分片规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#server-xml%E9%85%8D%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text">server.xml配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#user%E6%A0%87%E7%AD%BE"><span class="toc-number">3.1.</span> <span class="toc-text">user标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#firewall%E6%A0%87%E7%AD%BE"><span class="toc-number">3.2.</span> <span class="toc-text">firewall标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%BA%8F%E5%88%97%E5%8F%B7"><span class="toc-number">3.3.</span> <span class="toc-text">全局序列号</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6"><span class="toc-number">3.3.1.</span> <span class="toc-text">本地文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%96%B9%E5%BC%8F"><span class="toc-number">3.3.2.</span> <span class="toc-text">数据库方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%97%B6%E9%97%B4%E6%88%B3%E6%96%B9%E5%BC%8F"><span class="toc-number">3.3.3.</span> <span class="toc-text">本地时间戳方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F-ZK-ID-%E7%94%9F%E6%88%90%E5%99%A8"><span class="toc-number">3.3.4.</span> <span class="toc-text">分布式 ZK ID 生成器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ZK-%E9%80%92%E5%A2%9E%E6%96%B9%E5%BC%8F"><span class="toc-number">3.3.5.</span> <span class="toc-text">ZK 递增方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#schema-xml%E9%85%8D%E7%BD%AE"><span class="toc-number">4.</span> <span class="toc-text">schema.xml配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#schema%E6%A0%87%E7%AD%BE"><span class="toc-number">4.1.</span> <span class="toc-text">schema标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#table%E6%A0%87%E7%AD%BE"><span class="toc-number">4.2.</span> <span class="toc-text">table标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dataNode%E6%A0%87%E7%AD%BE"><span class="toc-number">4.3.</span> <span class="toc-text">dataNode标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dataHost%E6%A0%87%E7%AD%BE"><span class="toc-number">4.4.</span> <span class="toc-text">dataHost标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#heartbeat%E6%A0%87%E7%AD%BE"><span class="toc-number">4.5.</span> <span class="toc-text">heartbeat标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#writeHost%E5%92%8CreadHost%E6%A0%87%E7%AD%BE"><span class="toc-number">4.6.</span> <span class="toc-text">writeHost和readHost标签</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rule-xml%E9%85%8D%E7%BD%AE"><span class="toc-number">5.</span> <span class="toc-text">rule.xml配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tableRule%E6%A0%87%E7%AD%BE"><span class="toc-number">5.1.</span> <span class="toc-text">tableRule标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#function%E6%A0%87%E7%AD%BE"><span class="toc-number">5.2.</span> <span class="toc-text">function标签</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mycat%E5%AE%9E%E6%88%98"><span class="toc-number">6.</span> <span class="toc-text">Mycat实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Mycat%E5%AE%89%E8%A3%85"><span class="toc-number">6.1.</span> <span class="toc-text">Mycat安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-number">6.2.</span> <span class="toc-text">分库分表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">6.3.</span> <span class="toc-text">读写分离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%BA%E5%88%B6%E8%B7%AF%E7%94%B1"><span class="toc-number">6.4.</span> <span class="toc-text">强制路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%BB%B6%E6%97%B6%E5%88%87%E6%8D%A2"><span class="toc-number">6.5.</span> <span class="toc-text">主从延时切换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mycat%E4%BA%8B%E5%8A%A1"><span class="toc-number">7.</span> <span class="toc-text">Mycat事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Mycat-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1"><span class="toc-number">7.1.</span> <span class="toc-text">Mycat 数据库事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XA-%E4%BA%8B%E5%8A%A1%E4%BD%BF%E7%94%A8"><span class="toc-number">7.2.</span> <span class="toc-text">XA 事务使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E8%AF%81Repeatable-Read"><span class="toc-number">7.3.</span> <span class="toc-text">保证Repeatable Read</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 小肥龙吃大冰淇淋</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="framework-info"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202301132049386.png"/><span> </span><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/">晋ICP备2022012091号-1</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'pinglun-9gh2lmcnd8587831',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'pinglun-9gh2lmcnd8587831',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/hexo-theme-volantis@latest/source/js/issues.min.js"></script><script src="//code.tidio.co/smwivpnwumemac2wohardi3d3gpud1ag.js" async="async"></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>