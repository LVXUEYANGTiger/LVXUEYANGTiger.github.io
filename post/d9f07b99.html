<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Docker-Swarm | 小肥龙吃大冰淇淋</title><meta name="keywords" content="Docker"><meta name="author" content="小肥龙吃大冰淇淋"><meta name="copyright" content="小肥龙吃大冰淇淋"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="什么是Swarm Swarm是Docker公司自研发的容器集群管理系统，Swarm在早期是作为一个独立服务存在，在Docker Engine v1.12中集成了Swarm的集群管理，和编排功能。可以通过初始化Swarm或加入现有Swarm来启用Docker引擎的Swarm模式。  Docker Engine CLI和API包括了管理Swarm节点命令，比如添加、删除节点，以及在Swarm中部署和编">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker-Swarm">
<meta property="og:url" content="http://lvxueyang.vip/post/d9f07b99.html">
<meta property="og:site_name" content="小肥龙吃大冰淇淋">
<meta property="og:description" content="什么是Swarm Swarm是Docker公司自研发的容器集群管理系统，Swarm在早期是作为一个独立服务存在，在Docker Engine v1.12中集成了Swarm的集群管理，和编排功能。可以通过初始化Swarm或加入现有Swarm来启用Docker引擎的Swarm模式。  Docker Engine CLI和API包括了管理Swarm节点命令，比如添加、删除节点，以及在Swarm中部署和编">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg">
<meta property="article:published_time" content="2024-05-30T01:10:36.193Z">
<meta property="article:modified_time" content="2022-11-27T09:16:30.742Z">
<meta property="article:author" content="小肥龙吃大冰淇淋">
<meta property="article:tag" content="Docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg"><link rel="shortcut icon" href="https://lvxueyangboke.oss-cn-beijing.aliyuncs.com/images/20210805191028.png"><link rel="canonical" href="http://lvxueyang.vip/post/d9f07b99"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Docker-Swarm',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-27 17:16:30'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/ali_icon.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mogai.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="小肥龙吃大冰淇淋" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">303</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">108</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">73</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">小肥龙吃大冰淇淋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Docker-Swarm</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-30T01:10:36.193Z" title="发表于 2024-05-30 09:10:36">2024-05-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-27T09:16:30.742Z" title="更新于 2022-11-27 17:16:30">2022-11-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java%E5%AD%A6%E4%B9%A0/">java学习</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java%E5%AD%A6%E4%B9%A0/Docker/">Docker</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>24分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Docker-Swarm"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="什么是Swarm"><a href="#什么是Swarm" class="headerlink" title="什么是Swarm"></a>什么是Swarm</h3><p> Swarm是Docker公司自研发的容器集群管理系统，Swarm在早期是作为一个独立服务存在，在Docker Engine v1.12中集成了Swarm的集群管理，和编排功能。可以通过初始化Swarm或加入现有Swarm来启用Docker引擎的Swarm模式。</p>
<p> Docker Engine CLI和API包括了管理Swarm节点命令，比如添加、删除节点，以及在Swarm中部署和编排服务，也增加了服务栈（Stack）、服务（Service）、任务（Task）概念</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928204.png" alt="img"></p>
<h4 id="Swarm能干什么"><a href="#Swarm能干什么" class="headerlink" title="Swarm能干什么"></a>Swarm能干什么</h4><p> Swarm是Docker 引擎内置（原生）的集群管理和编排工具。Docker Swarm是 Docker 官方三剑客项目之一，swarm是基于docker平台实现的集群技术，他可以通过几条简单的指令快速的创建一个docker集群，接着在集群的共享网络上部署应用，最终实现分布式的服务。</p>
<h4 id="swarm节点"><a href="#swarm节点" class="headerlink" title="swarm节点"></a>swarm节点</h4><blockquote>
<p>swarm是一系列节点的集合，而节点可以是一台裸机或者一台虚拟机。一个节点能扮演一个或者两个角色，manager或者worker。</p>
</blockquote>
<h5 id="manager节点"><a href="#manager节点" class="headerlink" title="manager节点"></a>manager节点</h5><blockquote>
<p>Docker Swarm集群需要至少一个manager节点，节点之间使用**<code>Raft consensus protocol</code>**进行协同工作。</p>
</blockquote>
<p> 通常，第一个启用docker swarm的节点将成为leader，后来加入的都是follower。当前的leader如果挂掉，剩余的节点将重新选举出一个新的leader。</p>
<p> 每一个manager都有一个完整的当前集群状态的副本，可以保证manager的高可用。</p>
<h5 id="worker节点"><a href="#worker节点" class="headerlink" title="worker节点"></a>worker节点</h5><p> worker节点是运行实际应用服务的容器所在的地方。理论上，一个manager节点也能同时成为worker节点，但在生产环境中，我们不建议这样做。</p>
<p> worker节点之间，通过<code>control plane</code>进行通信，这种通信使用<code>gossip</code>协议，并且是异步的。</p>
<h3 id="运行机制"><a href="#运行机制" class="headerlink" title="运行机制"></a>运行机制</h3><h4 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h4><blockquote>
<p>集群中经常谈到的stacks, services, tasks，他们之间的关系。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928091.png" alt="img"></p>
<blockquote>
<p>下面简单解释一下这三者的含义：</p>
</blockquote>
<h5 id="services"><a href="#services" class="headerlink" title="services"></a>services</h5><p> swarm service是一个抽象的概念，它只是一个对运行在swarm集群上的应用服务，所期望状态的描述。它就像一个描述了下面物品的清单列表一样：</p>
<ul>
<li>服务名称</li>
<li>使用哪个镜像来创建容器</li>
<li>要运行多少个副本</li>
<li>服务的容器要连接到哪个网络上</li>
<li>应该映射哪些端口</li>
</ul>
<h5 id="task"><a href="#task" class="headerlink" title="task"></a>task</h5><p> 在Docker Swarm中，task是一个部署的最小单元，task与容器是一对一的关系。</p>
<h5 id="stack"><a href="#stack" class="headerlink" title="stack"></a>stack</h5><p> stack是描述一系列相关services的集合。我们通过在一个YAML文件中来定义一个stack。</p>
<h4 id="如何工作的"><a href="#如何工作的" class="headerlink" title="如何工作的"></a>如何工作的</h4><p> 要在集群中部署镜像，创建一个服务。在一些更大的应用上下文中，服务通常称之为微服务。服务可能是一个HTTP服务器、数据库、或者分布式环境中运行的任何其他可执行的程序。</p>
<blockquote>
<p>在创建服务时，可以指定要使用的容器镜像以及容器中要运行的命令。服务还可以定义下面选项：</p>
</blockquote>
<ul>
<li>集群要对外服务的端口</li>
<li>在集群中用于服务之间相连的overlay网络</li>
<li>滚动更新策略</li>
<li>集群总运行的副本数量</li>
</ul>
<h5 id="服务、任务和容器"><a href="#服务、任务和容器" class="headerlink" title="服务、任务和容器"></a>服务、任务和容器</h5><p> 当将服务部署到集群时，管理者将服务定义视为服务所需状态。然后将服务调度为一个或多个副本任务。这些任务在集群的节点上彼此独立运行。</p>
<blockquote>
<p>例如下图有三个副本的HTTP服务，每个服务实例就是一个任务。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291931168.png" alt="docker"></p>
<p> 容器是一个独立的进程。在swarm模型中，每个任务调用一个容器。任务类似于插槽，调度器将容器放入其中。一旦容器运行，调度器认为该任务处于运行状态。如果容器出现健康监测失败或者终止，那么任务也终止。</p>
<h5 id="任务和调度"><a href="#任务和调度" class="headerlink" title="任务和调度"></a>任务和调度</h5><blockquote>
<p>任务是集群内调度的原子单位。当创建或者更新服务声明所需的服务状态时，协调者通过调度任务来实现这些所需的状态。</p>
</blockquote>
<p> 任务是一个单向机制，通过这些状态单独进行：分配、准备、运行等等。如果任务失败，协调者将删除任务以及容器，然后根据服务指定的所需状态创建一个新的任务来代替它。</p>
<p> Docker swarm模式的基础逻辑是通用调度器和编排器。</p>
<blockquote>
<p>下图显示集群如何接受服务创建请求并将任务调度到工作节点上。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928711.png" alt="docker"></p>
<h5 id="待处理的服务"><a href="#待处理的服务" class="headerlink" title="待处理的服务"></a>待处理的服务</h5><blockquote>
<p>一个服务可以这样配置，使得当前集群中的节点不能运行其任务。在这种情况下，服务仍处于待处理状态。</p>
<p>以下是服务可能保留在待处理状态的示例：</p>
</blockquote>
<ul>
<li><p>如果所有节点被暂停或Drain，并且你创建一个服务，将被挂起，知道节点可用。实际上，第一个可用的节点将会获得所有的任务，这在生产环境中不是件好事。</p>
</li>
<li><p>可以为服务预留特定数量的内存。如果集群中没有节点满足所需的内存量，则服务将处于待处理状态，知道可用的节点运行其任务。如果指定了非常大的值，则任务将永久挂起，除非确实有一个满足该条件的节点。</p>
</li>
<li><p>可以对服务施加放置约束，并且可能无法在给定时间履行约束。</p>
<p>  此行为说明您的任务的要求和配置与当前的群组状态并不紧密。作为集群管理员，你可以声明集群所需状态，并且管理者可以使用集群中的节点来创建该状态。在集群中你不需要微管理任务。</p>
<p>  如果你唯一的目的是阻止部署服务，请将服务扩展为0，而不是尝试将其配置成保持待处理状态。</p>
</li>
</ul>
<h5 id="副本和全局服务"><a href="#副本和全局服务" class="headerlink" title="副本和全局服务"></a>副本和全局服务</h5><blockquote>
<p>有两种类型的服务部署：副本和全局。</p>
</blockquote>
<p> 对于副本服务，指定要运行的相同任务的数量，每个副本都是相同的内容。</p>
<p> 全局服务是在每个节点上运行一个任务的服务。不需要预先指定任务数量。每当将一个节点添加到集群中，协调者将创建一个任务，并且调度器将任务分配给该新加入的节点。全局服务最好是监控代理、反病毒扫描程序等等想要在集群中每个节点上运行的容器。</p>
<blockquote>
<p>下图显示三个副本服务(黄色)和全局服务(灰色)：</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291932449.png" alt="docker"></p>
<h5 id="在swarm模式下运行Docker-Engine"><a href="#在swarm模式下运行Docker-Engine" class="headerlink" title="在swarm模式下运行Docker Engine"></a>在swarm模式下运行Docker Engine</h5><blockquote>
<p>当首次安装并使用Docker Engine时，默认情况下swarm模式是禁用的。当启用swarm模式时，可以使用docker service 服务管理命令。</p>
<p>有两种方式在swarm模式下运行引擎：</p>
</blockquote>
<ul>
<li><p>创建一个新的集群</p>
</li>
<li><p>加入现有集群</p>
<p>  在生成环境中，集群模式提供具有集群管理功能的容错平台，以保证服务的可靠运行。</p>
</li>
</ul>
<h3 id="功能特点"><a href="#功能特点" class="headerlink" title="功能特点"></a>功能特点</h3><h4 id="集成的集群管理"><a href="#集成的集群管理" class="headerlink" title="集成的集群管理"></a>集成的集群管理</h4><p> 使用Docker Engine CLI创建一组Docker引擎，您可以在其中部署应用程序服务。您不需要其他编排软件来创建或管理群集。</p>
<h4 id="节点分散式设计"><a href="#节点分散式设计" class="headerlink" title="节点分散式设计"></a>节点分散式设计</h4><p> Docker Engine不是在部署时处理节点角色之间的差异，而是在运行时处理角色变化。您可以使用Docker Engine部署两种类型的节点，管理节点和工作节点。这意味着您可以从单个服务器构建整个群集。</p>
<h4 id="声明性服务模型"><a href="#声明性服务模型" class="headerlink" title="声明性服务模型"></a>声明性服务模型</h4><p> Docker Engine使用声明性方法来定义应用程序堆栈中各种服务的所需状态。例如，您可以描述由具有消息队列服务和数据库后端的Web前端服务组成的应用程序。</p>
<h4 id="可扩容与缩放容器"><a href="#可扩容与缩放容器" class="headerlink" title="可扩容与缩放容器"></a>可扩容与缩放容器</h4><p> 对于每个服务，您可以声明要运行的任务数。当您向上或向下缩放时，swarm管理器通过添加或删除任务来自动适应，以保持所需的任务数量来保证集群的可靠状态。</p>
<h4 id="容器容错状态协调"><a href="#容器容错状态协调" class="headerlink" title="容器容错状态协调"></a>容器容错状态协调</h4><p> 群集管理器节点不断监视群集状态，并协调您表示的期望状态的实际状态之间的任何差异。</p>
<p> 例如，如果设置一个服务以运行容器的10个副本，并且托管其中两个副本的工作程序计算机崩溃，则管理器将创建两个新副本以替换崩溃的副本。 swarm管理器将新副本分配给正在运行和可用的worker节点上。</p>
<h4 id="多主机网络"><a href="#多主机网络" class="headerlink" title="多主机网络"></a>多主机网络</h4><p> 您可以为服务指定覆盖网络。当swarm管理器初始化或更新应用程序时，它会自动为覆盖网络上的容器分配地址。</p>
<h4 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h4><p> Swarm管理器节点为swarm中的每个服务分配唯一的DNS名称，并负载平衡运行的容器。您可以通过嵌入在swarm中的DNS服务器查询在群中运行的每个容器。</p>
<h4 id="负载平衡"><a href="#负载平衡" class="headerlink" title="负载平衡"></a>负载平衡</h4><p> 您可以将服务的端口公开给外部负载平衡器。在内部，swarm允许您指定如何在节点之间分发服务容器。</p>
<h4 id="缺省安全"><a href="#缺省安全" class="headerlink" title="缺省安全"></a>缺省安全</h4><p> 群中的每个节点强制执行TLS相互验证和加密，以保护其自身与所有其他节点之间的通信。您可以选择使用自签名根证书或来自自定义根CA的证书。</p>
<h4 id="滚动更新"><a href="#滚动更新" class="headerlink" title="滚动更新"></a>滚动更新</h4><p> 在已经运行期间，您可以增量地应用服务更新到节点。 swarm管理器允许您控制将服务部署到不同节点集之间的延迟。如果出现任何问题，您可以将任务回滚到服务的先前版本。</p>
<h3 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h3><h4 id="服务器准备"><a href="#服务器准备" class="headerlink" title="服务器准备"></a>服务器准备</h4><blockquote>
<p>我的三台测试机</p>
</blockquote>
<table>
<thead>
<tr>
<th>IP地址</th>
<th>角色</th>
<th>主机名</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.64.153</td>
<td>manager</td>
<td>node1</td>
</tr>
<tr>
<td>192.168.64.154</td>
<td>worker</td>
<td>node2</td>
</tr>
<tr>
<td>192.168.64.155</td>
<td>worker</td>
<td>node3</td>
</tr>
</tbody></table>
<h4 id="服务器端口开放"><a href="#服务器端口开放" class="headerlink" title="服务器端口开放"></a>服务器端口开放</h4><blockquote>
<p>在创建集群前，如果开启了防火墙，请确认三台主机的防火墙能让swarm需求的端口开放，需要打开主机之间的端口，以下端口必须可用。在某些系统上，这些端口默认为打开。</p>
</blockquote>
<ul>
<li>2377：TCP端口2377用于集群管理通信</li>
<li>7946：TCP和UDP端口7946用于节点之间的通信</li>
<li>4789：TCP和UDP端口4789用于覆盖网络流量</li>
</ul>
<blockquote>
<p>可以直接禁用系统防火墙来让这些端口通信不受限制，一般测试环境我们都会禁用防火墙</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemctl stop firewalld（立即生效）</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld（重启生效）</span><br></pre></td></tr></table></figure>

<h4 id="添加节点标签"><a href="#添加节点标签" class="headerlink" title="添加节点标签"></a>添加节点标签</h4><blockquote>
<p>因为我们用到了节点约束，所有启动服务之前需要添加节点标签</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加标签</span></span><br><span class="line">docker node update --label-add role=data node1</span><br><span class="line"><span class="comment">#查看节点标签信息</span></span><br><span class="line">docker node inspect node1|grep role</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928580.png" alt="image-20210330112822635"></p>
<h3 id="搭建Swarm集群"><a href="#搭建Swarm集群" class="headerlink" title="搭建Swarm集群"></a>搭建Swarm集群</h3><blockquote>
<p>下面我们就来搭建一个<code>swarm</code>集群</p>
</blockquote>
<h4 id="初始化集群"><a href="#初始化集群" class="headerlink" title="初始化集群"></a>初始化集群</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker swarm init --advertise-addr 192.168.64.153(本机地址)</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291937286.png" alt="image-20210326174328960"></p>
<h4 id="生成口令"><a href="#生成口令" class="headerlink" title="生成口令"></a>生成口令</h4><h5 id="生成管理节点口令"><a href="#生成管理节点口令" class="headerlink" title="生成管理节点口令"></a>生成管理节点口令</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker swarm join-token manager</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291937247.png" alt="image-20210326174833542"></p>
<h5 id="生成执行节点口令"><a href="#生成执行节点口令" class="headerlink" title="生成执行节点口令"></a>生成执行节点口令</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker swarm join-token worker</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928774.png" alt="image-20210326174918929"></p>
<h4 id="其他节点加入集群"><a href="#其他节点加入集群" class="headerlink" title="其他节点加入集群"></a>其他节点加入集群</h4><blockquote>
<p>在第一个从节点执行加入 work的指令</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker swarm join --token SWMTKN-1-53p5t2rt9ud5j0owkl14boj2z8im6r60ddlzotgc4a8y93u1c2-8f6crxgyc9umayhxva1jv9t1w 192.168.64.153:2377</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928573.png" alt="image-20210326175248229"></p>
<blockquote>
<p>第二个节点执行加入work的命令</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker swarm join --token SWMTKN-1-53p5t2rt9ud5j0owkl14boj2z8im6r60ddlzotgc4a8y93u1c2-8f6crxgyc9umayhxva1jv9t1w 192.168.64.153:2377</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928729.png" alt="image-20210326175435072"></p>
<h4 id="查看swarm的节点"><a href="#查看swarm的节点" class="headerlink" title="查看swarm的节点"></a>查看swarm的节点</h4><blockquote>
<p>执行<code>docker node ls</code> 查看swarm节点信息</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker node ls</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928735.png" alt="image-20210326175557636"></p>
<h5 id="AVAILABILITY状态说明"><a href="#AVAILABILITY状态说明" class="headerlink" title="AVAILABILITY状态说明"></a>AVAILABILITY状态说明</h5><ul>
<li>Active 意味着调度程序可以将任务分配给节点。</li>
<li>Pause 意味着调度程序不会将新任务分配给节点，但现有任务仍在运行。</li>
<li>Drain 意味着调度程序不会向节点分配新任务。调度程序关闭所有现有任务并在可用节点上调度它们。</li>
</ul>
<h5 id="MANAGER-STATUS状态说明"><a href="#MANAGER-STATUS状态说明" class="headerlink" title="MANAGER STATUS状态说明"></a>MANAGER STATUS状态说明</h5><blockquote>
<p>显示节点是属于manager或者worker</p>
</blockquote>
<ul>
<li><strong>没有值</strong> ：表示不参与群管理的工作节点。</li>
<li><strong>Leader</strong> ：意味着该节点是使得群的所有群管理和编排决策的主要管理器节点。</li>
<li><strong>Reachable</strong>： 意味着节点是管理者节点正在参与Raft共识。如果领导节点不可用，则该节点有资格被选为新领导者。</li>
<li><strong>Unavailable</strong> ：意味着节点是不能与其他管理器通信的管理器。如果管理器节点不可用，您应该将新的管理器节点加入群集，或者将工作器节点升级为管理器。</li>
</ul>
<h4 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h4><blockquote>
<p>默认<code>centos</code>的主机名是<code>localhost</code>，我们看上面，节点的主机名都是<code>localhost</code>,我们修改以下</p>
</blockquote>
<h5 id="查看主机名"><a href="#查看主机名" class="headerlink" title="查看主机名"></a>查看主机名</h5><blockquote>
<p><code>hostnamectl status</code>可以查看主机名</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">hostnamectl status</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928875.png" alt="image-20210329145236427"></p>
<h5 id="修改主机名-1"><a href="#修改主机名-1" class="headerlink" title="修改主机名"></a>修改主机名</h5><blockquote>
<p>修改主机名使用<code>hostnamectl set-hostname NAME</code>命令可以进行修改，我们使用 node1,node2…方式命名我们的节点</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#修改主机名</span></span><br><span class="line">hostnamectl set-hostname node1</span><br><span class="line"><span class="comment"># 查看主机名</span></span><br><span class="line">hostnamectl status</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928779.png" alt="image-20210329145627793"></p>
<blockquote>
<p>其他节点依次操作就可以</p>
</blockquote>
<h5 id="再次查看节点"><a href="#再次查看节点" class="headerlink" title="再次查看节点"></a>再次查看节点</h5><blockquote>
<p>再次查看swarm节点信息</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker node ls</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928334.png" alt="image-20210329145824774"></p>
<h3 id="管理节点"><a href="#管理节点" class="headerlink" title="管理节点"></a>管理节点</h3><h4 id="升降级节点"><a href="#升降级节点" class="headerlink" title="升降级节点"></a>升降级节点</h4><blockquote>
<p>无论您升级或降级节点，您应该始终在群中维护奇数个管理器节点，</p>
</blockquote>
<p> 升降级节点角色只能在管理节点上运行，应先升级工作节点为被选举者，再降级领导者为工作节点，然后被选举者成为领导者完成替换；</p>
<p> 您可以将工作程序节点提升为manager角色。这在管理器节点不可用或者您希望使管理器脱机以进行维护时很有用。 类似地，您可以将管理器节点降级为worker角色。</p>
<h4 id="升级节点"><a href="#升级节点" class="headerlink" title="升级节点"></a>升级节点</h4><blockquote>
<p>要降级一个节点或一组节点，请从管理器节点运行</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker node promote 节点名称</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker node promote pbui0rdry85e25i3bvhzmqw8h</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291936765.png" alt="image-20210329092650179"></p>
<blockquote>
<p>升级节点后不会马上生效，会进入<code>Reachable</code>状态，如果leader节点关掉，当前节点会参与主节点竞争</p>
</blockquote>
<h4 id="降级节点"><a href="#降级节点" class="headerlink" title="降级节点"></a>降级节点</h4><blockquote>
<p>要升级一个节点或一组节点，请从管理器节点运行</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker node demote 节点名称</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker node demote r7cv7prw1h2to9h1cpwxs9jhl</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291936157.png" alt="image-20210329092535306"></p>
<blockquote>
<p>swam将节点降级后，再次查看节点命令不生效，需要到管理节点查看</p>
</blockquote>
<h4 id="节点退出swarm集群"><a href="#节点退出swarm集群" class="headerlink" title="节点退出swarm集群"></a>节点退出swarm集群</h4><p> docker swarm leave 命令可在所有节点上运行，值得注意的是，工作节点退出swarm集群后，在管理节点上依然保存着工作节点的节点信息，状态为down，要删除节点信息，可使用docker node rm 命令，当所有的节点都退出并且被删除时，在管理节点上使用docker swarm leave，然后退出整个集群；</p>
<h5 id="工作节点"><a href="#工作节点" class="headerlink" title="工作节点"></a>工作节点</h5><blockquote>
<p>在工作节点执行以下命令可以退出<code>swarm</code>节点</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker swarm leave</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928738.png" alt="image-20210329094027211"></p>
<h5 id="管理节点-1"><a href="#管理节点-1" class="headerlink" title="管理节点"></a>管理节点</h5><blockquote>
<p>在管理节点查看节信息</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker node ls</span><br></pre></td></tr></table></figure>

<blockquote>
<p>根据退出节点前后查看节点信息，可以发现退出的节点是down的状态，并没有删除节点</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928814.png" alt="image-20210329094149756"></p>
<h4 id="删除节点信息"><a href="#删除节点信息" class="headerlink" title="删除节点信息"></a>删除节点信息</h4><blockquote>
<p>在管理节点执行删除命令<code>docker node rm 节点ID</code></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker node rm r7cv7prw1h2to9h1cpwxs9jhl</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928707.png" alt="image-20210329094447598"></p>
<h3 id="管理集群服务"><a href="#管理集群服务" class="headerlink" title="管理集群服务"></a>管理集群服务</h3><blockquote>
<p>管理集群服必须在manager角色的主机上</p>
</blockquote>
<h4 id="创建overlay网络"><a href="#创建overlay网络" class="headerlink" title="创建overlay网络"></a>创建overlay网络</h4><blockquote>
<p>我们需要载多个服务器中运行Docker容器集群，需要使用overlay网络，overlay网络用于连接不同机器上的docker容器，允许不同机器上的容器相互通信，同时支持对消息进行加密</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker network create --driver overlay learn-docker-overlay-network</span><br></pre></td></tr></table></figure>

<h4 id="创建服务"><a href="#创建服务" class="headerlink" title="创建服务"></a>创建服务</h4><blockquote>
<p>使用<code>docker service create</code>命令来创建服务</p>
</blockquote>
<h5 id="创建MySQL服务"><a href="#创建MySQL服务" class="headerlink" title="创建MySQL服务"></a>创建MySQL服务</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker service create \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=root \</span><br><span class="line">--mount <span class="built_in">type</span>=<span class="built_in">bind</span>,<span class="built_in">source</span>=/tmp/etc/mysql,destination=/etc/mysql/mysql.conf.d/ \</span><br><span class="line">--mount <span class="built_in">type</span>=<span class="built_in">bind</span>,<span class="built_in">source</span>=/tmp/data/mysql,destination=/var/lib/mysql \</span><br><span class="line">--replicas 1 \</span><br><span class="line">--constraint <span class="string">&#x27;node.labels.role == data&#x27;</span> \</span><br><span class="line">--name mysql \</span><br><span class="line">--network learn-docker-overlay-network \</span><br><span class="line">mysql:5.7.33</span><br></pre></td></tr></table></figure>

<blockquote>
<p>–replicas 1 表示在集群中创建1个服务</p>
<p><code>node.labels.role == data</code>表示节点需要创建在标签是<code>data</code>的节点上</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928129.png" alt="image-20210401104650608"></p>
<blockquote>
<p>可以查看swarm的进程</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker service ls</span><br><span class="line"></span><br><span class="line">docker service ps mysql</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928572.png" alt="image-20210401104938973"></p>
<h5 id="创建nacos服务"><a href="#创建nacos服务" class="headerlink" title="创建nacos服务"></a>创建nacos服务</h5><blockquote>
<p>nacos也是需要创建一个，但是节点是可以漂移的，不需要固定在某一台机器</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker service create \</span><br><span class="line">-e MODE=standalone \</span><br><span class="line">--replicas 1 \</span><br><span class="line">--name nacos \</span><br><span class="line">--network learn-docker-overlay-network \</span><br><span class="line">nacos/nacos-server</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928342.png" alt="image-20210401105627349"></p>
<blockquote>
<p>可以查看swarm的进程</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker service ls</span><br><span class="line"></span><br><span class="line">docker service ps nacos</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291929552.png" alt="image-20210401111550209"></p>
<blockquote>
<p>我们发现nacos运行在了 node3节点上</p>
</blockquote>
<h5 id="创建learn-docker-storage服务"><a href="#创建learn-docker-storage服务" class="headerlink" title="创建learn-docker-storage服务"></a>创建learn-docker-storage服务</h5><blockquote>
<p>我们创建learn-docker-storage服务，我们将该服务部署两个节点</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker service create \</span><br><span class="line">--name learn-docker-storage \</span><br><span class="line">--replicas 2 \</span><br><span class="line">--network learn-docker-overlay-network \</span><br><span class="line">manager-hongbaoyu-java.itheima.net:8443/library/learn-docker-storage:1.0-SNAPSHOT</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928475.png" alt="image-20210401113027690"></p>
<blockquote>
<p>可以查看swarm的进程</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker service ls</span><br><span class="line"></span><br><span class="line">docker service ps nacos</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们发现我们的存储服务运行在两个节点上</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291935979.png" alt="image-20210401113248763"></p>
<h5 id="创建learn-docker-web服务"><a href="#创建learn-docker-web服务" class="headerlink" title="创建learn-docker-web服务"></a>创建learn-docker-web服务</h5><blockquote>
<p>我们创建learn-docker-web服务，我们将该服务同样部署两个节点</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker service create \</span><br><span class="line">--name learn-docker-web \</span><br><span class="line">--replicas 2 \</span><br><span class="line">--network learn-docker-overlay-network \</span><br><span class="line">manager-hongbaoyu-java.itheima.net:8443/library/learn-docker-web:1.0-SNAPSHOT</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928690.png" alt="image-20210401114221850"></p>
<blockquote>
<p>可以查看swarm的进程</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker service ls</span><br><span class="line"></span><br><span class="line">docker service ps nacos</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291929121.png" alt="image-20210401114316047"></p>
<h5 id="创建learn-docker-gateway服务"><a href="#创建learn-docker-gateway服务" class="headerlink" title="创建learn-docker-gateway服务"></a>创建learn-docker-gateway服务</h5><blockquote>
<p>我们创建learn-docker-gateway服务，因为是网关服务，我们只创建一个节点,因为需要对外暴漏端口，需要开放8888端口</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker service create \</span><br><span class="line">-p 8888:8888 \</span><br><span class="line">--name learn-docker-gateway \</span><br><span class="line">--replicas 1 \</span><br><span class="line">--network learn-docker-overlay-network \</span><br><span class="line">manager-hongbaoyu-java.itheima.net:8443/library/learn-docker-gateway:1.0-SNAPSHOT</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291928027.png" alt="image-20210401114529568"></p>
<blockquote>
<p>可以查看swarm的进程</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker service ls</span><br><span class="line"></span><br><span class="line">docker service ps nacos</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291929356.png" alt="image-20210401114603522"></p>
<h5 id="测试访问微服务"><a href="#测试访问微服务" class="headerlink" title="测试访问微服务"></a>测试访问微服务</h5><blockquote>
<p>因为在<code>node2</code>节点上，<code>node2</code>节点IP是<code>192.168.64.154</code> 我们可以请求URL访问</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl http://192.168.64.154:8888/employeapi/find/10001| python -m json.tool</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291935929.png" alt="image-20210401114910478"></p>
<h4 id="查看某个服务日志"><a href="#查看某个服务日志" class="headerlink" title="查看某个服务日志"></a>查看某个服务日志</h4><blockquote>
<p>通过<code>docker service logs 服务命</code>可以看到当前服务的日志，但是这个服务有两个容器在运行，所有能同时看到两个容器的日志</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker service learn-docker-storage</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291935233.png" alt="image-20210401140005045"></p>
<h4 id="扩缩容服务"><a href="#扩缩容服务" class="headerlink" title="扩缩容服务"></a>扩缩容服务</h4><blockquote>
<p>可以通过集群操作对集群进行扩缩容</p>
</blockquote>
<h5 id="扩容操作"><a href="#扩容操作" class="headerlink" title="扩容操作"></a>扩容操作</h5><blockquote>
<p>我们将<code>learn-docker-storage</code>由两个容器变为三个容器</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker service scale learn-docker-storage=3</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291929829.png" alt="image-20210401140506810"></p>
<blockquote>
<p>这样我们就把存储服务变成了三台服务</p>
</blockquote>
<h5 id="扩容操作-1"><a href="#扩容操作-1" class="headerlink" title="扩容操作"></a>扩容操作</h5><blockquote>
<p>同样，使用该命令对<code>learn-docker-storage</code>进行缩容</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker service scale learn-docker-storage=2</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291929269.png" alt="image-20210401140733804"></p>
<h4 id="删除服务"><a href="#删除服务" class="headerlink" title="删除服务"></a>删除服务</h4><blockquote>
<p>我们可以尝试把<code>learn-docker-gateway</code>删除掉，删除操作将会把整个服务的所有容器删除</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker service rm learn-docker-gateway</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291929234.png" alt="image-20210401142343761"></p>
<h3 id="Docker-Stack管理服务"><a href="#Docker-Stack管理服务" class="headerlink" title="Docker Stack管理服务"></a>Docker Stack管理服务</h3><blockquote>
<p>我们上面使用<code>swarm</code>部署服务，单个服务还好，如果很多个服务怎么来解决呢，这里就用到了<code>Docker Stack</code>管理服务。</p>
</blockquote>
<p> 在上面我们学会了如何配置一个swarm集群，并且知道如何在swarm集群上部署应用，现在，我们开始了解Docker层级关系中的最高一个层级——<strong>stack</strong>。一个stack就是一组有关联的服务的组合，可以编排在一起，一起管理。</p>
<p> 单机模式下，我们可以使用 <strong>Docker-Compose</strong>来编排多个服务，而 <strong>Docker Swarm</strong> 只能实现对单个服务的简单部署。于是就引出了本文的主角 <strong>Docker Stack</strong> ，通过 <strong>Docker Stack</strong> 我们只需对已有的 <strong>docker-compose.yml</strong> 配置文件稍加改造就可以完成 <strong>Docker</strong> 集群环境下的多服务编排。</p>
<h4 id="集群搭建案例"><a href="#集群搭建案例" class="headerlink" title="集群搭建案例"></a>集群搭建案例</h4><h5 id="应用部署情况"><a href="#应用部署情况" class="headerlink" title="应用部署情况"></a>应用部署情况</h5><table>
<thead>
<tr>
<th>服务名称</th>
<th>数量</th>
</tr>
</thead>
<tbody><tr>
<td>mysql</td>
<td>1</td>
</tr>
<tr>
<td>nacos</td>
<td>1</td>
</tr>
<tr>
<td>learn-docker-gateway</td>
<td>1</td>
</tr>
<tr>
<td>learn-docker-web</td>
<td>2</td>
</tr>
<tr>
<td>learn-docker-storage</td>
<td>2</td>
</tr>
</tbody></table>
<h5 id="创建docker-compose-yml"><a href="#创建docker-compose-yml" class="headerlink" title="创建docker-compose.yml"></a>创建docker-compose.yml</h5><blockquote>
<p>首先创建一个 <strong>docker-compose.yml</strong> 文件，使用 <a target="_blank" rel="noopener" href="https://docs.docker.com/compose/compose-file/#deploy">Docker Compose v3</a> 语法</p>
<p>我们把我们原来单机版的<code>docker-compose.yml</code>改造以下</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">version: <span class="string">&#x27;3.9&#x27;</span>   </span><br><span class="line">services:</span><br><span class="line">    mysql:</span><br><span class="line">        image: mysql:5.7.33</span><br><span class="line">        networks:</span><br><span class="line">            - learn-docker-network</span><br><span class="line">        volumes:</span><br><span class="line">            - <span class="string">&quot;/tmp/etc/mysql:/etc/mysql/mysql.conf.d/&quot;</span></span><br><span class="line">            - <span class="string">&quot;/tmp/data/mysql:/var/lib/mysql&quot;</span></span><br><span class="line">        environment:</span><br><span class="line">            MYSQL_ROOT_PASSWORD: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">        deploy:</span><br><span class="line">            mode: replicated</span><br><span class="line">            replicas: 1</span><br><span class="line">            placement:</span><br><span class="line">                constraints:</span><br><span class="line">                    - <span class="string">&#x27;node.labels.role == data&#x27;</span></span><br><span class="line">            restart_policy:</span><br><span class="line">                condition: on-failure</span><br><span class="line">                delay: 5s</span><br><span class="line">                </span><br><span class="line">    nacos:</span><br><span class="line">        image: nacos/nacos-server</span><br><span class="line">        ports:</span><br><span class="line">            - <span class="string">&quot;8848:8848&quot;</span></span><br><span class="line">        networks:</span><br><span class="line">            - learn-docker-network</span><br><span class="line">        environment:</span><br><span class="line">            MODE: <span class="string">&#x27;standalone&#x27;</span></span><br><span class="line">            JVM_XMS: <span class="string">&#x27;128m&#x27;</span></span><br><span class="line">            JVM_XMX: <span class="string">&#x27;128m&#x27;</span></span><br><span class="line">        deploy:</span><br><span class="line">            mode: replicated</span><br><span class="line">            replicas: 1</span><br><span class="line">            restart_policy:</span><br><span class="line">                condition: on-failure</span><br><span class="line">                delay: 5s</span><br><span class="line">    </span><br><span class="line">    learn-docker-web:</span><br><span class="line">        image: manager-hongbaoyu-java.itheima.net:8443/library/learn-docker-web:1.0-SNAPSHOT</span><br><span class="line">        networks:</span><br><span class="line">            - learn-docker-network</span><br><span class="line">        depends_on:</span><br><span class="line">            - nacos</span><br><span class="line">            - mysql</span><br><span class="line">        deploy:</span><br><span class="line">            mode: replicated</span><br><span class="line">            replicas: 2</span><br><span class="line">            restart_policy:</span><br><span class="line">                condition: on-failure</span><br><span class="line">                delay: 5s</span><br><span class="line">                </span><br><span class="line">            </span><br><span class="line">    learn-docker-storage:</span><br><span class="line">        image: manager-hongbaoyu-java.itheima.net:8443/library/learn-docker-storage:1.0-SNAPSHOT</span><br><span class="line">        networks:</span><br><span class="line">            - learn-docker-network</span><br><span class="line">        depends_on:</span><br><span class="line">            - nacos</span><br><span class="line">            - mysql</span><br><span class="line">        deploy:</span><br><span class="line">            mode: replicated</span><br><span class="line">            replicas: 2</span><br><span class="line">            restart_policy:</span><br><span class="line">                condition: on-failure</span><br><span class="line">                delay: 5s</span><br><span class="line">    learn-docker-gateway:</span><br><span class="line">        image: manager-hongbaoyu-java.itheima.net:8443/library/learn-docker-gateway:1.0-SNAPSHOT</span><br><span class="line">        ports:</span><br><span class="line">            - <span class="string">&quot;8888:8888&quot;</span></span><br><span class="line">        networks:</span><br><span class="line">            - learn-docker-network</span><br><span class="line">        depends_on:</span><br><span class="line">            - nacos</span><br><span class="line">            - mysql</span><br><span class="line">        deploy:</span><br><span class="line">            mode: replicated</span><br><span class="line">            replicas: 1</span><br><span class="line">            restart_policy:</span><br><span class="line">                condition: on-failure</span><br><span class="line">                delay: 5s</span><br><span class="line">                </span><br><span class="line">    visualizer:</span><br><span class="line">        image: dockersamples/visualizer</span><br><span class="line">        ports:</span><br><span class="line">            - <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">        volumes:</span><br><span class="line">            - <span class="string">&quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span></span><br><span class="line">        deploy:</span><br><span class="line">            mode: replicated</span><br><span class="line">            replicas: 1</span><br><span class="line">            restart_policy:</span><br><span class="line">                condition: on-failure</span><br><span class="line">                delay: 5s</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">    learn-docker-network:</span><br><span class="line">        driver: overlay</span><br></pre></td></tr></table></figure>

<p>配置介绍</p>
<p> Stack文件就是Docker Compose文件。唯一的要求就是version:一项需要是3.0或者更高的值。在Docker根据某个Stack文件部署应用的时候，首先会检查并创建networks：关键字对应网络。如果网络不存在，Docker会进行创建。下面我们详细看下这几个模块。</p>
<h6 id="overlay网络"><a href="#overlay网络" class="headerlink" title="overlay网络"></a>overlay网络</h6><p> 这里定义了1个网络，默认情况下网络都是使用overlay驱动，新建对应的覆盖类型的网络。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">networks:</span><br><span class="line">    learn-docker-network:</span><br><span class="line">        driver: overlay</span><br></pre></td></tr></table></figure>

<h6 id="部署节点副本数"><a href="#部署节点副本数" class="headerlink" title="部署节点副本数"></a>部署节点副本数</h6><blockquote>
<p>接下来我们进一步了解deploy关键字新增的内容</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line">    mode: replicated</span><br><span class="line">    replicas: 2</span><br><span class="line">    restart_policy:</span><br><span class="line">        condition: on-failure</span><br><span class="line">        delay: 5s</span><br></pre></td></tr></table></figure>

<ul>
<li>replicas: 2 设置了期望服务的副本数量为2，默认为1.如果服务正在运行，需要调整副本数。可以调整stack文件中的 replicas 的数值，然后重新部署stack。重新部署stack并不会影响那些没有改动的服务。</li>
<li>restart_policy: 定义了Swarm针对容器异常退出的重启策略。当前服务的重启策略是：如果某个副本以非0返回值退出，会立即重启当前副本。重启最多尝试3次，每次都是等待之多120s来检测是否成功。每次重启的间隔是5s。</li>
</ul>
<h6 id="节点约束"><a href="#节点约束" class="headerlink" title="节点约束"></a>节点约束</h6><blockquote>
<p>因为我们的数据库节点只能部署在数据节点，因为需要挂载本地的数据文件以及数据库文件，所有需要使用标签进行节点约束</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mysql:</span><br><span class="line">    image: mysql:5.7.33</span><br><span class="line">    networks:</span><br><span class="line">        - learn-docker-network</span><br><span class="line">    volumes:</span><br><span class="line">        - <span class="string">&quot;/tmp/etc/mysql:/etc/mysql/mysql.conf.d/&quot;</span></span><br><span class="line">        - <span class="string">&quot;/tmp/data/mysql:/var/lib/mysql&quot;</span></span><br><span class="line">    environment:</span><br><span class="line">        MYSQL_ROOT_PASSWORD: <span class="string">&#x27;root&#x27;</span></span><br><span class="line">    deploy:</span><br><span class="line">        mode: replicated</span><br><span class="line">        replicas: 1</span><br><span class="line">        placement:</span><br><span class="line">            constraints:</span><br><span class="line">                - <span class="string">&#x27;node.labels.role == data&#x27;</span></span><br><span class="line">        restart_policy:</span><br><span class="line">            condition: on-failure</span><br><span class="line">            delay: 5s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里的 <code>&#39;node.labels.role == data</code>含义就是将当前mysql节点约束在标签名字是role，并且值是data的数据节点，更多操作请参考下文</p>
</blockquote>
<h5 id="部署服务"><a href="#部署服务" class="headerlink" title="部署服务"></a>部署服务</h5><h6 id="部署应用"><a href="#部署应用" class="headerlink" title="部署应用"></a>部署应用</h6><blockquote>
<p>使用docker stack deploy 命令部署</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker stack deploy -c docker-compose.yml learn-docker-test</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里我们指定了docker-compose文件，并把stack命名为 learn-docker-test。</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291929919.png" alt="image-20210330114330830"></p>
<h6 id="查看部署情况"><a href="#查看部署情况" class="headerlink" title="查看部署情况"></a>查看部署情况</h6><blockquote>
<p>可以通过<code>docker stack ls</code>命令查看集群部署情况，会列出 Swarm 集群中的全部 Stack，包括每个 Stack 拥有多少服务</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291929467.png" alt="image-20210330140704607"></p>
<h5 id="服务部署情况"><a href="#服务部署情况" class="headerlink" title="服务部署情况"></a>服务部署情况</h5><h6 id="查看nacos节点信息"><a href="#查看nacos节点信息" class="headerlink" title="查看nacos节点信息"></a>查看nacos节点信息</h6><blockquote>
<p>访问nacos服务，发现我们的服务都已经注册</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291934187.png" alt="image-20210330134830060"></p>
<h6 id="测试访问服务"><a href="#测试访问服务" class="headerlink" title="测试访问服务"></a>测试访问服务</h6><blockquote>
<p>访问服务接口测试</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl http://192.168.64.153:8888/employeapi/find/10001| python -m json.tool</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291929349.png" alt="image-20210330135429755"></p>
<h4 id="集群管理"><a href="#集群管理" class="headerlink" title="集群管理"></a>集群管理</h4><h5 id="更新服务"><a href="#更新服务" class="headerlink" title="更新服务"></a>更新服务</h5><blockquote>
<p><code>docker service upadte</code>可以对swarm服务进行升级</p>
</blockquote>
<h6 id="参数详解"><a href="#参数详解" class="headerlink" title="参数详解"></a>参数详解</h6><ul>
<li>–force 强制更新重启服务，无论是否配置或镜像改变都更新</li>
<li>–image <a href="image:tag">image:tag</a> 制定更新的镜像</li>
<li>–with-registry-auth 向 Swarm 代理发送 Registry 认证详细信息，私有仓库需要携带该参数</li>
</ul>
<h6 id="更新镜像"><a href="#更新镜像" class="headerlink" title="更新镜像"></a>更新镜像</h6><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看服务详情</span></span><br><span class="line">docker service ls</span><br><span class="line"><span class="comment"># 更新服务</span></span><br><span class="line">docker service update --image manager-hongbaoyu-java.itheima.net:8443/library/learn-docker-storage:1.0-SNAPSHOT learn-docker-test_learn-docker-storage</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291929780.png" alt="image-20210330135928983"></p>
<h5 id="删除应用"><a href="#删除应用" class="headerlink" title="删除应用"></a>删除应用</h5><h6 id="查看部署集群"><a href="#查看部署集群" class="headerlink" title="查看部署集群"></a>查看部署集群</h6><blockquote>
<p><code>docker stack ls</code>可以查看部署的服务列表</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291929308.png" alt="image-20210330140526628"></p>
<h6 id="执行删除"><a href="#执行删除" class="headerlink" title="执行删除"></a>执行删除</h6><blockquote>
<p><code>docker stack rm stack名称</code>命令会删除整个stack集群，注意移除操作执行前并不会进行二次确认。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker stack rm learn-docker-test</span><br></pre></td></tr></table></figure>

<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291934932.png" alt="image-20210330141754719"></p>
<h5 id="相关命令"><a href="#相关命令" class="headerlink" title="相关命令"></a>相关命令</h5><h6 id="docker-stack-常用命令"><a href="#docker-stack-常用命令" class="headerlink" title="docker stack 常用命令"></a>docker stack 常用命令</h6><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>docker stack deploy</td>
<td>部署新的堆栈或更新现有堆栈</td>
</tr>
<tr>
<td>docker stack ls</td>
<td>列出现有堆栈</td>
</tr>
<tr>
<td>docker stack ps</td>
<td>列出堆栈中的任务</td>
</tr>
<tr>
<td>docker stack rm</td>
<td>删除堆栈</td>
</tr>
<tr>
<td>docker stack services</td>
<td>列出堆栈中的服务</td>
</tr>
<tr>
<td>docker stack down</td>
<td>移除某个堆栈（不会删除数据）</td>
</tr>
</tbody></table>
<h6 id="docker-service-常用命令"><a href="#docker-service-常用命令" class="headerlink" title="docker service 常用命令"></a>docker service 常用命令</h6><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>docker service create</td>
<td>部署服务</td>
</tr>
<tr>
<td>docker service inspect</td>
<td>查看服务详情</td>
</tr>
<tr>
<td>docker service logs</td>
<td>产看某个服务日志</td>
</tr>
<tr>
<td>docker service ls</td>
<td>查看所有服务详情</td>
</tr>
<tr>
<td>docker service rm</td>
<td>删除某个服务（<code>-f</code>强制删除）</td>
</tr>
<tr>
<td>docker service scale</td>
<td>设置某个服务个数</td>
</tr>
<tr>
<td>docker service update</td>
<td>更新某个服务</td>
</tr>
</tbody></table>
<h6 id="docker-node-常用命令"><a href="#docker-node-常用命令" class="headerlink" title="docker node 常用命令"></a>docker node 常用命令</h6><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>docker node ls</td>
<td>查看所有集群节点</td>
</tr>
<tr>
<td>docker node rm</td>
<td>删除某个节点（<code>-f</code>强制删除）</td>
</tr>
<tr>
<td>docker node inspect</td>
<td>查看节点详情</td>
</tr>
<tr>
<td>docker node demote</td>
<td>节点降级，由管理节点降级为工作节点</td>
</tr>
<tr>
<td>docker node promote</td>
<td>节点升级，由工作节点升级为管理节点</td>
</tr>
<tr>
<td>docker node update</td>
<td>更新节点</td>
</tr>
<tr>
<td>docker node ps</td>
<td>查看节点中的 Task 任务</td>
</tr>
</tbody></table>
<h6 id="docker-swarm-常用命令"><a href="#docker-swarm-常用命令" class="headerlink" title="docker swarm 常用命令"></a>docker swarm 常用命令</h6><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>docker swarm init</td>
<td>初始化集群</td>
</tr>
<tr>
<td>docker swarm join-token worker</td>
<td>查看工作节点的 token</td>
</tr>
<tr>
<td>docker swarm join-token manager</td>
<td>查看管理节点的 token</td>
</tr>
<tr>
<td>docker swarm join</td>
<td>加入集群中</td>
</tr>
</tbody></table>
<h3 id="portainer集群管理"><a href="#portainer集群管理" class="headerlink" title="portainer集群管理"></a>portainer集群管理</h3><h4 id="Portainer介绍"><a href="#Portainer介绍" class="headerlink" title="Portainer介绍"></a>Portainer介绍</h4><blockquote>
<p>Portainer是一个可视化的容器镜像的图形管理工具，利用Portainer可以轻松构建，管理和维护Docker环境。 而且完全免费，基于容器化的安装方式，方便高效部署。</p>
</blockquote>
<p> Portainer 的目的是部署和使用一样简单。它由一个可以在任何 Docker 引擎上运行的单一容器组成（可以部署为Linux容器或Windows本地容器，也支持其他平台）。Portainer允许你管理所有的Docker资源（容器、镜像、卷、网络等等）。它与独立的Docker引擎和Docker Swarm模式兼容。</p>
<h4 id="swarm集群安装Portainer"><a href="#swarm集群安装Portainer" class="headerlink" title="swarm集群安装Portainer"></a>swarm集群安装Portainer</h4><blockquote>
<p>使用swarm集群安装Portainer，用Portainer来管理swarm集群</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载部署配置文件</span></span><br><span class="line">curl -L https://downloads.portainer.io/portainer-agent-stack.yml -o portainer-agent-stack.yml </span><br><span class="line"><span class="comment"># 部署节点</span></span><br><span class="line">docker stack deploy -c portainer-agent-stack.yml portainer</span><br></pre></td></tr></table></figure>

<p>注意：此方法将自动部署Portainer服务器的单个实例，并将Portainer代理作为全局服务部署到集群中的每个节点上。</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291934152.png" alt="image-20210330143857202"></p>
<h4 id="portainer使用"><a href="#portainer使用" class="headerlink" title="portainer使用"></a>portainer使用</h4><h5 id="注册用户"><a href="#注册用户" class="headerlink" title="注册用户"></a>注册用户</h5><blockquote>
<p>默认访问接口是9000端口，可以通过浏览器进行访问，首次登陆需要注册用户，给admin用户设置密码</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291934297.png" alt="image-20210330144227205"></p>
<h5 id="查看管理服务"><a href="#查看管理服务" class="headerlink" title="查看管理服务"></a>查看管理服务</h5><blockquote>
<p>点击home节点，当前这个节点就是我们的swarm集群</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291934697.png" alt="image-20210330152349400"></p>
<blockquote>
<p>点进去就可以看到我们能操作的菜单了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291933616.png" alt="image-20210330152442761"></p>
<h5 id="查看swarm节点"><a href="#查看swarm节点" class="headerlink" title="查看swarm节点"></a>查看swarm节点</h5><blockquote>
<p>点击swarm菜单就可以看到swarm节点了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291933593.png" alt="image-20210330152625455"></p>
<h4 id="管理微服务"><a href="#管理微服务" class="headerlink" title="管理微服务"></a>管理微服务</h4><h5 id="服务部署情况-1"><a href="#服务部署情况-1" class="headerlink" title="服务部署情况"></a>服务部署情况</h5><blockquote>
<p>我们要将我们的服务交给portainer管理</p>
</blockquote>
<table>
<thead>
<tr>
<th>服务名称</th>
<th>数量</th>
</tr>
</thead>
<tbody><tr>
<td>mysql</td>
<td>1</td>
</tr>
<tr>
<td>nacos</td>
<td>1</td>
</tr>
<tr>
<td>learn-docker-gateway</td>
<td>1</td>
</tr>
<tr>
<td>learn-docker-web</td>
<td>2</td>
</tr>
<tr>
<td>learn-docker-storage</td>
<td>2</td>
</tr>
</tbody></table>
<h5 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h5><h6 id="管理节点标签"><a href="#管理节点标签" class="headerlink" title="管理节点标签"></a>管理节点标签</h6><blockquote>
<p>我们MySQL需要部署在数据节点，我们添加节点标签</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291933086.png" alt="image-20210330153057353"></p>
<blockquote>
<p>在swarm管理节点，点击节点信息进入下面详情页面进行配置标签</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291933065.png" alt="image-20210330153043640"></p>
<h6 id="添加网络信息"><a href="#添加网络信息" class="headerlink" title="添加网络信息"></a>添加网络信息</h6><blockquote>
<p>因为我们的节点需要一个共有的<code>overlay</code>网络，我们需要配置下，在network节点点击添加</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291933302.png" alt="image-20210330153306081"></p>
<blockquote>
<p>在添加页面选择<code>overlay</code>网络类型，名字叫做<code>learn-docker-network</code></p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291933778.png" alt="image-20210330153426280"></p>
<blockquote>
<p>然后点击创建就可以</p>
</blockquote>
<h6 id="创建仓库配置"><a href="#创建仓库配置" class="headerlink" title="创建仓库配置"></a>创建仓库配置</h6><blockquote>
<p>因为我们的微服务需要从我们自己的harbor镜像仓库拉取，需要将我们的仓库配置</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291933931.png" alt="image-20210330153550479"></p>
<blockquote>
<p>在仓库节点填写我们的镜像地址就可以<code>https://manager-hongbaoyu-java.itheima.net:8443</code></p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291933948.png" alt="image-20210330153647638"></p>
<h5 id="创建stack任务"><a href="#创建stack任务" class="headerlink" title="创建stack任务"></a>创建stack任务</h5><blockquote>
<p>在stack界面点击stack菜单进行添加stck任务</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291933906.png" alt="image-20210330153905166"></p>
<blockquote>
<p>在stack管理界面将我们的<code>docker-compose.yml</code>复制进我们的stack界面</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291933377.png" alt="image-20210330154051212"></p>
<blockquote>
<p>点击创建节点信息就可以，等待部署就可以</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291933675.png" alt="image-20210330154143443"></p>
<blockquote>
<p>稍等下节点就部署完成了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291933764.png" alt="image-20210330154314049"></p>
<blockquote>
<p>点击进去就可以单到节点详情了</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291933512.png" alt="image-20210330154412956"></p>
<h5 id="查看节点部署情况"><a href="#查看节点部署情况" class="headerlink" title="查看节点部署情况"></a>查看节点部署情况</h5><blockquote>
<p>进入swarm管理界面</p>
</blockquote>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202201291933807.png" alt="image-20210330155004931"></p>
<blockquote>
<p>点击<code>Go to cluster visualizer</code>查看服务部署情况</p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">小肥龙吃大冰淇淋</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://lvxueyang.vip/post/d9f07b99.html">http://lvxueyang.vip/post/d9f07b99.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://lvxueyang.vip" target="_blank">小肥龙吃大冰淇淋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Docker/">Docker</a></div><div class="post_share"><div class="social-share" data-image="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/f61655ea.html"><img class="prev-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">DockerFile</div></div></a></div><div class="next-post pull-right"><a href="/post/33d07388.html"><img class="next-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Docker-MySQL</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/f61655ea.html" title="DockerFile"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">DockerFile</div></div></a></div><div><a href="/post/fb6100d6.html" title="Docker-Compose"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">Docker-Compose</div></div></a></div><div><a href="/post/33d07388.html" title="Docker-MySQL"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">Docker-MySQL</div></div></a></div><div><a href="/post/f5f9fa9b.html" title="Docker"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-08</div><div class="title">Docker</div></div></a></div><div><a href="/post/4789f17e.html" title="Docker容器操作"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">Docker容器操作</div></div></a></div><div><a href="/post/11b45f95.html" title="Docker仓库"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">Docker仓库</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFSwarm"><span class="toc-number">1.</span> <span class="toc-text">什么是Swarm</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Swarm%E8%83%BD%E5%B9%B2%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.</span> <span class="toc-text">Swarm能干什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#swarm%E8%8A%82%E7%82%B9"><span class="toc-number">1.2.</span> <span class="toc-text">swarm节点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#manager%E8%8A%82%E7%82%B9"><span class="toc-number">1.2.1.</span> <span class="toc-text">manager节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#worker%E8%8A%82%E7%82%B9"><span class="toc-number">1.2.2.</span> <span class="toc-text">worker节点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6"><span class="toc-number">2.</span> <span class="toc-text">运行机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="toc-number">2.1.</span> <span class="toc-text">名词解释</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#services"><span class="toc-number">2.1.1.</span> <span class="toc-text">services</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#task"><span class="toc-number">2.1.2.</span> <span class="toc-text">task</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#stack"><span class="toc-number">2.1.3.</span> <span class="toc-text">stack</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84"><span class="toc-number">2.2.</span> <span class="toc-text">如何工作的</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E3%80%81%E4%BB%BB%E5%8A%A1%E5%92%8C%E5%AE%B9%E5%99%A8"><span class="toc-number">2.2.1.</span> <span class="toc-text">服务、任务和容器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E5%92%8C%E8%B0%83%E5%BA%A6"><span class="toc-number">2.2.2.</span> <span class="toc-text">任务和调度</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BE%85%E5%A4%84%E7%90%86%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.2.3.</span> <span class="toc-text">待处理的服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E5%92%8C%E5%85%A8%E5%B1%80%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.2.4.</span> <span class="toc-text">副本和全局服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8swarm%E6%A8%A1%E5%BC%8F%E4%B8%8B%E8%BF%90%E8%A1%8CDocker-Engine"><span class="toc-number">2.2.5.</span> <span class="toc-text">在swarm模式下运行Docker Engine</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E7%89%B9%E7%82%B9"><span class="toc-number">3.</span> <span class="toc-text">功能特点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E7%9A%84%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86"><span class="toc-number">3.1.</span> <span class="toc-text">集成的集群管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E5%88%86%E6%95%A3%E5%BC%8F%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.2.</span> <span class="toc-text">节点分散式设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E6%80%A7%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.3.</span> <span class="toc-text">声明性服务模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E6%89%A9%E5%AE%B9%E4%B8%8E%E7%BC%A9%E6%94%BE%E5%AE%B9%E5%99%A8"><span class="toc-number">3.4.</span> <span class="toc-text">可扩容与缩放容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%AE%B9%E9%94%99%E7%8A%B6%E6%80%81%E5%8D%8F%E8%B0%83"><span class="toc-number">3.5.</span> <span class="toc-text">容器容错状态协调</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E4%B8%BB%E6%9C%BA%E7%BD%91%E7%BB%9C"><span class="toc-number">3.6.</span> <span class="toc-text">多主机网络</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">3.7.</span> <span class="toc-text">服务发现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%B9%B3%E8%A1%A1"><span class="toc-number">3.8.</span> <span class="toc-text">负载平衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E7%9C%81%E5%AE%89%E5%85%A8"><span class="toc-number">3.9.</span> <span class="toc-text">缺省安全</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0"><span class="toc-number">3.10.</span> <span class="toc-text">滚动更新</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="toc-number">4.</span> <span class="toc-text">准备环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%87%86%E5%A4%87"><span class="toc-number">4.1.</span> <span class="toc-text">服务器准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E5%8F%A3%E5%BC%80%E6%94%BE"><span class="toc-number">4.2.</span> <span class="toc-text">服务器端口开放</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%8A%82%E7%82%B9%E6%A0%87%E7%AD%BE"><span class="toc-number">4.3.</span> <span class="toc-text">添加节点标签</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BASwarm%E9%9B%86%E7%BE%A4"><span class="toc-number">5.</span> <span class="toc-text">搭建Swarm集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4"><span class="toc-number">5.1.</span> <span class="toc-text">初始化集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%8F%A3%E4%BB%A4"><span class="toc-number">5.2.</span> <span class="toc-text">生成口令</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9%E5%8F%A3%E4%BB%A4"><span class="toc-number">5.2.1.</span> <span class="toc-text">生成管理节点口令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%89%A7%E8%A1%8C%E8%8A%82%E7%82%B9%E5%8F%A3%E4%BB%A4"><span class="toc-number">5.2.2.</span> <span class="toc-text">生成执行节点口令</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="toc-number">5.3.</span> <span class="toc-text">其他节点加入集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bswarm%E7%9A%84%E8%8A%82%E7%82%B9"><span class="toc-number">5.4.</span> <span class="toc-text">查看swarm的节点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#AVAILABILITY%E7%8A%B6%E6%80%81%E8%AF%B4%E6%98%8E"><span class="toc-number">5.4.1.</span> <span class="toc-text">AVAILABILITY状态说明</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MANAGER-STATUS%E7%8A%B6%E6%80%81%E8%AF%B4%E6%98%8E"><span class="toc-number">5.4.2.</span> <span class="toc-text">MANAGER STATUS状态说明</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%BB%E6%9C%BA%E5%90%8D"><span class="toc-number">5.5.</span> <span class="toc-text">修改主机名</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E4%B8%BB%E6%9C%BA%E5%90%8D"><span class="toc-number">5.5.1.</span> <span class="toc-text">查看主机名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%BB%E6%9C%BA%E5%90%8D-1"><span class="toc-number">5.5.2.</span> <span class="toc-text">修改主机名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E6%9F%A5%E7%9C%8B%E8%8A%82%E7%82%B9"><span class="toc-number">5.5.3.</span> <span class="toc-text">再次查看节点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9"><span class="toc-number">6.</span> <span class="toc-text">管理节点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%87%E9%99%8D%E7%BA%A7%E8%8A%82%E7%82%B9"><span class="toc-number">6.1.</span> <span class="toc-text">升降级节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7%E8%8A%82%E7%82%B9"><span class="toc-number">6.2.</span> <span class="toc-text">升级节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%99%8D%E7%BA%A7%E8%8A%82%E7%82%B9"><span class="toc-number">6.3.</span> <span class="toc-text">降级节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E9%80%80%E5%87%BAswarm%E9%9B%86%E7%BE%A4"><span class="toc-number">6.4.</span> <span class="toc-text">节点退出swarm集群</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9"><span class="toc-number">6.4.1.</span> <span class="toc-text">工作节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9-1"><span class="toc-number">6.4.2.</span> <span class="toc-text">管理节点</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E8%8A%82%E7%82%B9%E4%BF%A1%E6%81%AF"><span class="toc-number">6.5.</span> <span class="toc-text">删除节点信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1"><span class="toc-number">7.</span> <span class="toc-text">管理集群服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAoverlay%E7%BD%91%E7%BB%9C"><span class="toc-number">7.1.</span> <span class="toc-text">创建overlay网络</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1"><span class="toc-number">7.2.</span> <span class="toc-text">创建服务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAMySQL%E6%9C%8D%E5%8A%A1"><span class="toc-number">7.2.1.</span> <span class="toc-text">创建MySQL服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAnacos%E6%9C%8D%E5%8A%A1"><span class="toc-number">7.2.2.</span> <span class="toc-text">创建nacos服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAlearn-docker-storage%E6%9C%8D%E5%8A%A1"><span class="toc-number">7.2.3.</span> <span class="toc-text">创建learn-docker-storage服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAlearn-docker-web%E6%9C%8D%E5%8A%A1"><span class="toc-number">7.2.4.</span> <span class="toc-text">创建learn-docker-web服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAlearn-docker-gateway%E6%9C%8D%E5%8A%A1"><span class="toc-number">7.2.5.</span> <span class="toc-text">创建learn-docker-gateway服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">7.2.6.</span> <span class="toc-text">测试访问微服务</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%9F%90%E4%B8%AA%E6%9C%8D%E5%8A%A1%E6%97%A5%E5%BF%97"><span class="toc-number">7.3.</span> <span class="toc-text">查看某个服务日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A9%E7%BC%A9%E5%AE%B9%E6%9C%8D%E5%8A%A1"><span class="toc-number">7.4.</span> <span class="toc-text">扩缩容服务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9%E6%93%8D%E4%BD%9C"><span class="toc-number">7.4.1.</span> <span class="toc-text">扩容操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9%E6%93%8D%E4%BD%9C-1"><span class="toc-number">7.4.2.</span> <span class="toc-text">扩容操作</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%9C%8D%E5%8A%A1"><span class="toc-number">7.5.</span> <span class="toc-text">删除服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-Stack%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1"><span class="toc-number">8.</span> <span class="toc-text">Docker Stack管理服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E6%A1%88%E4%BE%8B"><span class="toc-number">8.1.</span> <span class="toc-text">集群搭建案例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2%E6%83%85%E5%86%B5"><span class="toc-number">8.1.1.</span> <span class="toc-text">应用部署情况</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAdocker-compose-yml"><span class="toc-number">8.1.2.</span> <span class="toc-text">创建docker-compose.yml</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#overlay%E7%BD%91%E7%BB%9C"><span class="toc-number">8.1.2.1.</span> <span class="toc-text">overlay网络</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E8%8A%82%E7%82%B9%E5%89%AF%E6%9C%AC%E6%95%B0"><span class="toc-number">8.1.2.2.</span> <span class="toc-text">部署节点副本数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E7%BA%A6%E6%9D%9F"><span class="toc-number">8.1.2.3.</span> <span class="toc-text">节点约束</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1"><span class="toc-number">8.1.3.</span> <span class="toc-text">部署服务</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8"><span class="toc-number">8.1.3.1.</span> <span class="toc-text">部署应用</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%83%A8%E7%BD%B2%E6%83%85%E5%86%B5"><span class="toc-number">8.1.3.2.</span> <span class="toc-text">查看部署情况</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2%E6%83%85%E5%86%B5"><span class="toc-number">8.1.4.</span> <span class="toc-text">服务部署情况</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bnacos%E8%8A%82%E7%82%B9%E4%BF%A1%E6%81%AF"><span class="toc-number">8.1.4.1.</span> <span class="toc-text">查看nacos节点信息</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">8.1.4.2.</span> <span class="toc-text">测试访问服务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86"><span class="toc-number">8.2.</span> <span class="toc-text">集群管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%9C%8D%E5%8A%A1"><span class="toc-number">8.2.1.</span> <span class="toc-text">更新服务</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-number">8.2.1.1.</span> <span class="toc-text">参数详解</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E9%95%9C%E5%83%8F"><span class="toc-number">8.2.1.2.</span> <span class="toc-text">更新镜像</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%BA%94%E7%94%A8"><span class="toc-number">8.2.2.</span> <span class="toc-text">删除应用</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%83%A8%E7%BD%B2%E9%9B%86%E7%BE%A4"><span class="toc-number">8.2.2.1.</span> <span class="toc-text">查看部署集群</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%88%A0%E9%99%A4"><span class="toc-number">8.2.2.2.</span> <span class="toc-text">执行删除</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="toc-number">8.2.3.</span> <span class="toc-text">相关命令</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#docker-stack-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">8.2.3.1.</span> <span class="toc-text">docker stack 常用命令</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#docker-service-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">8.2.3.2.</span> <span class="toc-text">docker service 常用命令</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#docker-node-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">8.2.3.3.</span> <span class="toc-text">docker node 常用命令</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#docker-swarm-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">8.2.3.4.</span> <span class="toc-text">docker swarm 常用命令</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#portainer%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86"><span class="toc-number">9.</span> <span class="toc-text">portainer集群管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Portainer%E4%BB%8B%E7%BB%8D"><span class="toc-number">9.1.</span> <span class="toc-text">Portainer介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#swarm%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85Portainer"><span class="toc-number">9.2.</span> <span class="toc-text">swarm集群安装Portainer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#portainer%E4%BD%BF%E7%94%A8"><span class="toc-number">9.3.</span> <span class="toc-text">portainer使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E7%94%A8%E6%88%B7"><span class="toc-number">9.3.1.</span> <span class="toc-text">注册用户</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1"><span class="toc-number">9.3.2.</span> <span class="toc-text">查看管理服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bswarm%E8%8A%82%E7%82%B9"><span class="toc-number">9.3.3.</span> <span class="toc-text">查看swarm节点</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">9.4.</span> <span class="toc-text">管理微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2%E6%83%85%E5%86%B5-1"><span class="toc-number">9.4.1.</span> <span class="toc-text">服务部署情况</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">9.4.2.</span> <span class="toc-text">准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9%E6%A0%87%E7%AD%BE"><span class="toc-number">9.4.2.1.</span> <span class="toc-text">管理节点标签</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%BD%91%E7%BB%9C%E4%BF%A1%E6%81%AF"><span class="toc-number">9.4.2.2.</span> <span class="toc-text">添加网络信息</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BB%93%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-number">9.4.2.3.</span> <span class="toc-text">创建仓库配置</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAstack%E4%BB%BB%E5%8A%A1"><span class="toc-number">9.4.3.</span> <span class="toc-text">创建stack任务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2%E6%83%85%E5%86%B5"><span class="toc-number">9.4.4.</span> <span class="toc-text">查看节点部署情况</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 小肥龙吃大冰淇淋</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'pinglun-9gh2lmcnd8587831',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'pinglun-9gh2lmcnd8587831',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/hexo-theme-volantis@latest/source/js/issues.min.js"></script><script src="//code.tidio.co/smwivpnwumemac2wohardi3d3gpud1ag.js" async="async"></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>